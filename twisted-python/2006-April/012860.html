<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: [Twisted-commits] r16582 - Remove util.wait	and all uses.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20%5BTwisted-commits%5D%20r16582%20-%20Remove%20util.wait%0A%09and%20all%20uses.&In-Reply-To=E1FSmy6-0005zK-00%40wolfwood">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012873.html">
   <LINK REL="Next"  HREF="012861.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: [Twisted-commits] r16582 - Remove util.wait	and all uses.</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20%5BTwisted-commits%5D%20r16582%20-%20Remove%20util.wait%0A%09and%20all%20uses.&In-Reply-To=E1FSmy6-0005zK-00%40wolfwood"
       TITLE="[Twisted-Python] Re: [Twisted-commits] r16582 - Remove util.wait	and all uses.">exarkun at divmod.com
       </A><BR>
    <I>Mon Apr 10 01:10:30 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="012873.html">[Twisted-Python] marking 3 problem tests on Windows 'todo'
</A></li>
        <LI>Next message: <A HREF="012861.html">[Twisted-Python] Re: [Twisted-commits] r16582 - Remove util.wait	and all uses.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12860">[ date ]</a>
              <a href="thread.html#12860">[ thread ]</a>
              <a href="subject.html#12860">[ subject ]</a>
              <a href="author.html#12860">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 09 Apr 2006 21:21:34 -0600, Jonathan Lange &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jml at wolfwood.twistedmatrix.com</A>&gt; wrote:
&gt;<i>Author: jml
</I>&gt;<i>Date: Sun Apr  9 21:21:33 2006
</I>&gt;<i>New Revision: 16582
</I>&gt;<i>
</I>&gt;<i>Modified:
</I>&gt;<i>   trunk/twisted/conch/test/test_filetransfer.py
</I>&gt;<i>   trunk/twisted/conch/test/test_telnet.py
</I>&gt;<i>   trunk/twisted/lore/nevowlore.py
</I>&gt;<i>   trunk/twisted/mail/test/test_mail.py
</I>&gt;<i>   trunk/twisted/mail/test/test_pop3client.py
</I>&gt;<i>   trunk/twisted/names/test/test_names.py
</I>&gt;<i>   trunk/twisted/protocols/ftp.py
</I>&gt;<i>   trunk/twisted/test/test_adbapi.py
</I>&gt;<i>   trunk/twisted/test/test_defgen.py
</I>&gt;<i>   trunk/twisted/test/test_ftp.py
</I>&gt;<i>   trunk/twisted/test/test_reflector.py
</I>&gt;<i>   trunk/twisted/trial/runner.py
</I>&gt;<i>   trunk/twisted/trial/test/test_util.py
</I>&gt;<i>   trunk/twisted/trial/unittest.py
</I>&gt;<i>   trunk/twisted/trial/util.py
</I>&gt;<i>   trunk/twisted/web2/test/test_stream.py
</I>&gt;<i>Log:
</I>&gt;<i>Remove util.wait and all uses.
</I>&gt;<i>
</I>&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>Modified: trunk/twisted/protocols/ftp.py
</I>&gt;<i>==============================================================================
</I>&gt;<i>--- trunk/twisted/protocols/ftp.py	(original)
</I>&gt;<i>+++ trunk/twisted/protocols/ftp.py	Sun Apr  9 21:21:33 2006
</I>&gt;<i>@@ -660,7 +660,7 @@
</I>&gt;<i>             if cmd == 'PASS':
</I>&gt;<i>                 return self.ftp_PASS(*params)
</I>&gt;<i>             else:
</I>&gt;<i>-                return BAD_CMD_SEQ
</I>&gt;<i>+                return BAD_CMD_SEQ, &quot;PASS required after USER&quot;
</I>&gt;<i>
</I>&gt;<i>         elif self.state == self.AUTHED:
</I>&gt;<i>             method = getattr(self, &quot;ftp_&quot; + cmd, None)
</I>&gt;<i>@@ -672,7 +672,7 @@
</I>&gt;<i>             if cmd == 'RNTO':
</I>&gt;<i>                 return self.ftp_RNTO(*params)
</I>&gt;<i>             else:
</I>&gt;<i>-                return BAD_CMD_SEQ, &quot;Blah&quot;
</I>&gt;<i>+                return BAD_CMD_SEQ, &quot;RNTO required after RNFR&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     def ftp_USER(self, username):
</I>&gt;<i>
</I>
Hmmm.  I don't see any changes related to wait() in these hunks. ;)

&gt;<i> [snip]
</I>&gt;<i>Modified: trunk/twisted/test/test_ftp.py
</I>&gt;<i>==============================================================================
</I>&gt;<i>--- trunk/twisted/test/test_ftp.py	(original)
</I>&gt;<i>+++ trunk/twisted/test/test_ftp.py	Sun Apr  9 21:21:33 2006
</I>&gt;<i> [snip]
</I>&gt;<i>@@ -86,7 +82,10 @@
</I>&gt;<i>         # Connect a client to it
</I>&gt;<i>         portNum = self.port.getHost().port
</I>&gt;<i>         clientCreator = protocol.ClientCreator(reactor, ftp.FTPClientBasic)
</I>&gt;<i>-        self.client = wait(clientCreator.connectTCP(&quot;127.0.0.1&quot;, portNum))
</I>&gt;<i>+        d = clientCreator.connectTCP(&quot;127.0.0.1&quot;, portNum)
</I>&gt;<i>+        def gotClient(client):
</I>&gt;<i>+            self.client = client
</I>&gt;<i>+        return d.addCallback(gotClient)
</I>&gt;<i>
</I>&gt;<i>     def tearDown(self):
</I>&gt;<i>         # Clean up sockets
</I>
While it doesn't appear that this change *introduced* a new race condition, it does seem as though it has jostled things so as to cause an existing one to start going the wrong way.

This seems to be a pretty common one in the test suite, so everyone pay attention.

Just because one side of a TCP connection has had its connection-established-successfully callback fired (ie, buildProtocol on the Factory) does not mean that both sides of the TCP connection have had this callback fired.  Quite often, in fact, this is not the case (particularly on platforms you forgot to run the unit tests on ;).

This ftp setUp needs to be made to wait for both the server and the client to become connected before proceeding.  The failure to do so can be seen as a new failing test on the reactors buildslave in the Qt step.

(Of course, the Qt step was already red, because a previous branch uncovered still another race condition.)

Please revert the branch or fix the race post-haste.  If someone would take a look at the failing tcp half-close test on that reactor, I would appreciate it, otherwise I'll try to get to it sometime in the next couple days.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012873.html">[Twisted-Python] marking 3 problem tests on Windows 'todo'
</A></li>
	<LI>Next message: <A HREF="012861.html">[Twisted-Python] Re: [Twisted-commits] r16582 - Remove util.wait	and all uses.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12860">[ date ]</a>
              <a href="thread.html#12860">[ thread ]</a>
              <a href="subject.html#12860">[ subject ]</a>
              <a href="author.html#12860">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
