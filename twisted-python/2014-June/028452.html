<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Effects of calling transport.writeSomeData() ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Effects%20of%20calling%20transport.writeSomeData%28%29%20%3F&In-Reply-To=%3C20140621142415.6847.915570379.divmod.xquotient.58%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028448.html">
   <LINK REL="Next"  HREF="028472.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Effects of calling transport.writeSomeData() ?</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Effects%20of%20calling%20transport.writeSomeData%28%29%20%3F&In-Reply-To=%3C20140621142415.6847.915570379.divmod.xquotient.58%40top%3E"
       TITLE="[Twisted-Python] Effects of calling transport.writeSomeData() ?">exarkun at twistedmatrix.com
       </A><BR>
    <I>Sat Jun 21 08:24:15 MDT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="028448.html">[Twisted-Python] Effects of calling transport.writeSomeData() ?
</A></li>
        <LI>Next message: <A HREF="028472.html">[Twisted-Python] Effects of calling transport.writeSomeData() ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28452">[ date ]</a>
              <a href="thread.html#28452">[ thread ]</a>
              <a href="subject.html#28452">[ subject ]</a>
              <a href="author.html#28452">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20 Jun, 10:22 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mark at catseye.org</A> wrote:
&gt;<i>We're writing a Twisted 14.0.0 application (on Python 2.7.7, Mac OS 
</I>&gt;<i>10.9.3) that uses Conch as an SSH client; this is working fine. 
</I>&gt;<i>However, we have the requirement that in an advanced mode of operation 
</I>&gt;<i>for power users that the application take advantage of OpenSSH 
</I>&gt;<i>connection multiplexing over an already-established-by-the-user OpenSSH 
</I>&gt;<i>ControlMaster session (via an OpenSSH ControlPath socket) instead of 
</I>&gt;<i>using Conch.
</I>&gt;<i>
</I>&gt;<i>OpenSSH requires its new session command and forwarded file descriptors 
</I>&gt;<i>to be sent over the socket in a very particular way: the command must 
</I>&gt;<i>be sent first, followed by message with a '\0' byte with each forwarded 
</I>&gt;<i>file descriptor.  OpenSSH ignores the '\0' for each file descriptor, 
</I>&gt;<i>extracting the file descriptors themselves from the message's ancillary 
</I>&gt;<i>data.
</I>&gt;<i>
</I>&gt;<i>The following will not work because none of the calls to write() send 
</I>&gt;<i>their data until control is returned to the reactor, while 
</I>&gt;<i>sendFileDescriptor() queues up the descriptors such that they get sent 
</I>&gt;<i>them with the very next data that is sent -- which wind up being the 
</I>&gt;<i>first three bytes of the command rather than the three '\0' bytes.
</I>&gt;<i>
</I>&gt;<i>class OpenSSHMuxProtocol( protocol.Protocol ):
</I>&gt;<i>     # built via reactor.connectUNIX()
</I>&gt;<i>     def sendCommand( self, command ):
</I>&gt;<i>         # Does not work:
</I>&gt;<i>         self.transport.write( command )
</I>&gt;<i>         self.transport.sendFileDescriptor( sys.stdin.fileno() )
</I>&gt;<i>         self.transport.write( '\0' ) # payload for the stdin file 
</I>&gt;<i>descriptor
</I>&gt;<i>         self.transport.sendFileDescriptor( sys.stdout.fileno() )
</I>&gt;<i>         self.transport.write( '\0' ) # payload for the stdout file 
</I>&gt;<i>descriptor
</I>&gt;<i>         self.transport.sendFileDescriptor( sys.stdout.fileno() )
</I>&gt;<i>         self.transport.write( '\0' ) # payload for the stderr file 
</I>&gt;<i>descriptor
</I>&gt;<i>         # ^^^ Does not work
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>But this next solution /does/ work:
</I>&gt;<i>
</I>&gt;<i>from socket import SOL_SOCKET
</I>&gt;<i>from twisted.python.sendmsg import SCM_RIGHTS, send1msg
</I>&gt;<i>
</I>&gt;<i>class OpenSSHMuxProtocol( protocol.Protocol ):
</I>&gt;<i>     # built via reactor.connectUNIX()
</I>&gt;<i>     def sendCommand( self, command ):
</I>&gt;<i>         self.transport.writeSomeData( command ) # data is sent over the 
</I>&gt;<i>socket immediately
</I>&gt;<i>         send1msg( self.transport.socket.fileno(), &quot;\0&quot;, 0,
</I>&gt;<i>             [ ( SOL_SOCKET, SCM_RIGHTS, pack( 'i', sys.stdin.fileno() ) 
</I>&gt;<i>) ] )
</I>&gt;<i>         send1msg( self.transport.socket.fileno(), &quot;\0&quot;, 0,
</I>&gt;<i>             [ ( SOL_SOCKET, SCM_RIGHTS, pack( 'i', sys.stdout.fileno() 
</I>&gt;<i>) ) ] )
</I>&gt;<i>         send1msg( self.transport.socket.fileno(), &quot;\0&quot;, 0,
</I>&gt;<i>             [ ( SOL_SOCKET, SCM_RIGHTS, pack( 'i', sys.stderr.fileno() 
</I>&gt;<i>) ) ] )
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>My questions are:
</I>&gt;<i>
</I>&gt;<i>Is it bad to bypass the reactor and send data directly/immediately this 
</I>&gt;<i>way using writeSomeData() and send1msg()?  Note that sendCommand() 
</I>&gt;<i>actually gets
</I>
Yes.  `writeSomeData` is not a method on any transport interface.  It is 
an implementation detail of particular transports.
&gt;<i>called in response to a OpenSSHMuxProtocol.dataReceived() event.  If 
</I>&gt;<i>bypassing the reactor this way is bad, how bad is it and what are the 
</I>&gt;<i>consequences or effects?
</I>
This use is untested.  There's no reason to expect it will continue to 
work with future Twisted releases (or, really, that it fully works now; 
since `writeSomeData` bypasses the transport's buffering layer, it seems 
like you're risking an out-of-order or partial send; probably these will 
only arise under load so you may not have observed them in your 
testing).
&gt;<i>Is there a better way to get a working solution?  I think I'd need some 
</I>&gt;<i>way to guarantee that the write of the command was actually sent to the 
</I>&gt;<i>OpenSSH server before the file descriptors are forwarded -- for 
</I>&gt;<i>example, if a Deferred was used whose first callback wrote the command 
</I>&gt;<i>and whose second callback forwarded the descriptors, would a call to 
</I>&gt;<i>the reactor to actually sent the command be guaranteed between the two 
</I>&gt;<i>callbacks?
</I>
The proper way to do this would be for OpenSSH to acknowledge the 
operation.  At this point you would know it's safe to proceed to the 
next operation.  Since you didn't mention anything about 
acknowledgements, I'm guessing there are none.

Since you're already relying on `self.transport.socket.fileno()` and 
`send1msg` (basically, bypassing the transport abstraction and just 
doing socket operations yourself) one improvement you could make would 
be just to rely on that for the whole thing.  Don't use `writeSomeData`. 
Use `socket.send(command)`.  At least this way you're only relying on 
being able to treat a transport like a UNIX socket - not on the 
particulars of the transport's buffering implementation.

A different approach you could take would be to implement this 
connection sharing feature for Conch.  I can pretty much guarantee it's 
possible to implement since an older version of Conch actually did 
implement it. :)  The implementation was removed because it was fragile, 
complicated, and poorly tested.  It would be great to re-introduce the 
functionality with a higher quality implementation.

Jean-Paul

</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028448.html">[Twisted-Python] Effects of calling transport.writeSomeData() ?
</A></li>
	<LI>Next message: <A HREF="028472.html">[Twisted-Python] Effects of calling transport.writeSomeData() ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28452">[ date ]</a>
              <a href="thread.html#28452">[ thread ]</a>
              <a href="subject.html#28452">[ subject ]</a>
              <a href="author.html#28452">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
