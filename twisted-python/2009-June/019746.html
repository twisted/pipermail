<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Guidance on Proxy-type Application
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Guidance%20on%20Proxy-type%20Application&In-Reply-To=20090528225800.12555.827283410.divmod.xquotient.11675%40weber.divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019745.html">
   <LINK REL="Next"  HREF="019747.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Guidance on Proxy-type Application</H1>
    <B>Aaron Bush</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Guidance%20on%20Proxy-type%20Application&In-Reply-To=20090528225800.12555.827283410.divmod.xquotient.11675%40weber.divmod.com"
       TITLE="[Twisted-Python] Guidance on Proxy-type Application">asb.bush at gmail.com
       </A><BR>
    <I>Tue Jun  2 15:20:22 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019745.html">[Twisted-Python] wxreactor and win32eventreactor
</A></li>
        <LI>Next message: <A HREF="019747.html">[Twisted-Python] Twisted book(s)?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19746">[ date ]</a>
              <a href="thread.html#19746">[ thread ]</a>
              <a href="subject.html#19746">[ subject ]</a>
              <a href="author.html#19746">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>glyph,

Sorry for the delayed response.  I wanted to thank you for providing such a
complete example.  This is excellent.  Now I just need to wrap by head
around how it all goes together and works.

The logic of the queue append and pop of a deferred in ProxyClient
forwardLine and lineRecieve are throwing me for a loop.  I'll keep tracing
it and get it down.

Thanks Again!
-ab

On Thu, May 28, 2009 at 6:58 PM, &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> On 01:23 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">asb.bush at gmail.com</A> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I have just started to look at the Twisted framework and would like to put
</I>&gt;&gt;<i> it
</I>&gt;&gt;<i> to use for a new project I am working on.  Not being very familiar with
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> framework and fairly new to Python in general I would like to ask a
</I>&gt;&gt;<i> design/architecture question.  (I have written similar applications in C
</I>&gt;&gt;<i> but
</I>&gt;&gt;<i> would prefer to start this in the right direction and not write Python
</I>&gt;&gt;<i> like
</I>&gt;&gt;<i> C.)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks for asking!
</I>&gt;<i>
</I>&gt;<i> I apologize for the delay in my answer.  I started writing up a simple
</I>&gt;<i> example (attached) but was discouraged to find that it was 100 lines long
</I>&gt;<i> and required too much explaining.
</I>&gt;<i>
</I>&gt;<i> Then I started documenting it and explaining every line but that was a very
</I>&gt;<i> long, tedious message.  So, it doesn't have much in the way of explanation;
</I>&gt;<i> I hope you will find it useful regardless.
</I>&gt;<i>
</I>&gt;&gt;<i> The application has the following model:
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Many clients connect to the Application and prefer to leave the connection
</I>&gt;&gt;<i> open.  They will send messages across this connection.  They will expect
</I>&gt;&gt;<i> to
</I>&gt;&gt;<i> get a message back at some point later, they do not wait for a response
</I>&gt;&gt;<i> (async).  The clients are already coded (legacy) and just need to send
</I>&gt;&gt;<i> their
</I>&gt;&gt;<i> proprietary protocol to the new Application (written using Twisted).
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This is *almost* a FAQ.  At least, you may find this to be a useful answer:
</I>&gt;<i>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="http://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions#HowdoImakeinputononeconnectionresultinoutputonanother">http://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions#HowdoImakeinputononeconnectionresultinoutputonanother</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;&gt;<i> The Twisted application will take the data from the clients and do some
</I>&gt;&gt;<i> transformation on it then send the message on to another server (3rd
</I>&gt;&gt;<i> party).
</I>&gt;&gt;<i> This connection to &quot;another&quot; server must be a single connection, not one
</I>&gt;&gt;<i> connection per client.  This connection should also be persistent and not
</I>&gt;&gt;<i> opened/closed for each client message sent.  Ideally if the 3rd party
</I>&gt;&gt;<i> server
</I>&gt;&gt;<i> is down then I would also not accept client connections as the messages
</I>&gt;&gt;<i> are
</I>&gt;&gt;<i> time sensitive and should not be stored and forwarded.  At some point the
</I>&gt;&gt;<i> 3rd
</I>&gt;&gt;<i> part will send a message back and the Application will route it back to
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> original source.  Basically request/reply pattern.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The example that I've attached does basically this.  Run it and then run
</I>&gt;<i> 'telnet localhost 4322', and type some lines; you will see that they are
</I>&gt;<i> transformed and echoed back to you, both by the proxy and by the protocol
</I>&gt;<i> being proxied.
</I>&gt;<i>
</I>&gt;<i> At a high level, the answer to your question is so simple that it's hard to
</I>&gt;<i> express.  Basically, you just need to have all the relevant objects having
</I>&gt;<i> references to each other, and calling methods to achieve the desired effect.
</I>&gt;<i>  The less magic, the better.
</I>&gt;<i>
</I>&gt;<i> More precisely, you need an object responsible for managing your outgoing
</I>&gt;<i> connections to your legacy server, so that it can handle disconnection and
</I>&gt;<i> reconnection, queueing messages and so on.  Then you need your proxy server
</I>&gt;<i> factory to hold a reference to that object, so that it can create references
</I>&gt;<i> from each proxy server protocol connection object to the connection manager.
</I>&gt;<i>
</I>&gt;<i> This is related to another recent thread - you can see my message in that
</I>&gt;<i> thread here:
</I>&gt;<i>
</I>&gt;<i>   <A HREF="http://thread.gmane.org/gmane.comp.python.twisted/18377/focus=18385">http://thread.gmane.org/gmane.comp.python.twisted/18377/focus=18385</A>
</I>&gt;<i>
</I>&gt;&gt;<i> I have been reading through the archives and the twisted docs and have
</I>&gt;&gt;<i> also
</I>&gt;&gt;<i> looked over the Hex-dump port-forwarding recipe but not found anything
</I>&gt;&gt;<i> that
</I>&gt;&gt;<i> explains how to use twisted for this model.  Hex-dump is close but
</I>&gt;&gt;<i> opens/closes the connection to the server on each client connection.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I'm not sure why hex-dump port-forwarding is particularly relevant to this
</I>&gt;<i> example.  Is it just because this is an application that connects from one
</I>&gt;<i> host to another?
</I>&gt;<i>
</I>&gt;&gt;<i> I am thinking that there will be two Factories [and two protocols: 1) for
</I>&gt;&gt;<i> clients and 2) for 3rd party].  I am not sure how to best establish both
</I>&gt;&gt;<i> the
</I>&gt;&gt;<i> listening factory and the client to 3rd party factory.  Once they are
</I>&gt;&gt;<i> established what is the preferred way in Twisted to pass a message from
</I>&gt;&gt;<i> one
</I>&gt;&gt;<i> protocol to another?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This part of your question is almost exactly the FAQ I mentioned above :).
</I>&gt;<i>  To reiterate that answer, you just need to have references between objects,
</I>&gt;<i> and call methods on the objects you want to do stuff.
</I>&gt;<i>
</I>&gt;<i> If you have a client connection object, just get a reference to that from
</I>&gt;<i> the relevant server connection object and call methods on the client object
</I>&gt;<i> to emit messages on the client protocol, handling any responses
</I>&gt;<i> appropriately.  Deferreds can help with that latter part.
</I>&gt;<i>
</I>&gt;<i> It is always better if you can establish that reference as simply as
</I>&gt;<i> possible; for example, by passing parameters to the __init__ of various
</I>&gt;<i> classes.  Again, for reasons that have nothing to do with Twisted
</I>&gt;<i> specifically, it's a bad idea to try to establish these references by having
</I>&gt;<i> global variables floating around.
</I>&gt;<i>
</I>&gt;<i> Here's a very very simple example of the &quot;good way&quot; to propagate some data
</I>&gt;<i> to protocol instances that need it:
</I>&gt;<i>
</I>&gt;<i>   class MyProtocol(Protocol):
</I>&gt;<i>       def __init__(self, data):
</I>&gt;<i>           self.data = data
</I>&gt;<i>
</I>&gt;<i>   class MyFactory(Factory):
</I>&gt;<i>       def __init__(self, data):
</I>&gt;<i>           self.data = data
</I>&gt;<i>
</I>&gt;<i>       def buildProtocol(self, addr):
</I>&gt;<i>           return MyProtocol(self.data)
</I>&gt;<i>
</I>&gt;<i>   reactor.listenTCP(8765, MyFactory(&quot;some data&quot;))
</I>&gt;<i>
</I>&gt;<i> and here's a simple example of a really bad way (don't do this!):
</I>&gt;<i>
</I>&gt;<i>   class MyProtocol(Protocol):
</I>&gt;<i>       def connectionMade(self):
</I>&gt;<i>           self.bleh = bleh
</I>&gt;<i>
</I>&gt;<i>   bleh = &quot;some data&quot;
</I>&gt;<i>   f = Factory()
</I>&gt;<i>   f.protocol = MyProtocol
</I>&gt;<i>   reactor.listenTCP(9876, f)
</I>&gt;<i>
</I>&gt;<i> Even in C, I'm pretty sure it's better style to pass structures to
</I>&gt;<i> functions than to abuse piles of local variables :).  I only illustrate this
</I>&gt;<i> bad style here because it seems to be a common antipattern.  The Protocol
</I>&gt;<i> class itself doesn't take any parameters to __init__, and Twisted's users
</I>&gt;<i> don't always realize that protocols and factories and so on are just regular
</I>&gt;<i> objects, with no special rules; they just get methods called on them by the
</I>&gt;<i> reactor.
</I>&gt;<i>
</I>&gt;&gt;<i> Any pointers or sample code that you can offer is greatly appreciated. I
</I>&gt;&gt;<i> would really like to cook this in Twisted and not go back to the C way.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Based on what you've said so far, I think you're basically on the right
</I>&gt;<i> track.  Good luck!
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20090602/ef3801aa/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20090602/ef3801aa/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019745.html">[Twisted-Python] wxreactor and win32eventreactor
</A></li>
	<LI>Next message: <A HREF="019747.html">[Twisted-Python] Twisted book(s)?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19746">[ date ]</a>
              <a href="thread.html#19746">[ thread ]</a>
              <a href="subject.html#19746">[ subject ]</a>
              <a href="author.html#19746">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
