<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] adbapi and multiple queries in single
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20adbapi%20and%20multiple%20queries%20in%20single&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019860.html">
   <LINK REL="Next"  HREF="019864.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] adbapi and multiple queries in single</H1>
    <B>Vishal Shetye</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20adbapi%20and%20multiple%20queries%20in%20single&In-Reply-To="
       TITLE="[Twisted-Python] adbapi and multiple queries in single">vishal_shetye at persistent.co.in
       </A><BR>
    <I>Tue Jun 23 12:31:21 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019860.html">[Twisted-Python] adbapi and multiple queries in single	transaction.
</A></li>
        <LI>Next message: <A HREF="019864.html">[Twisted-Python] [ANN] Foolscap-0.4.2 released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19863">[ date ]</a>
              <a href="thread.html#19863">[ thread ]</a>
              <a href="subject.html#19863">[ subject ]</a>
              <a href="author.html#19863">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Phil thanks for the reply. I plan to do something similar.
[sorry for not providing code snippet.]
I have modified your code (please ignore queries and other errors)
However I am not very much convinced with this approach,
As you can see validate of ObjectGateway is a public method which also needs to be called from handleLogin.
So I have to write two methods one public 'validate' and other private '_validate'.
Any comments/suggestions or pointers to any existing applications/architecture documents with similar data access?

class TableGateway(object):
     def _getUserName(self, trans, user_id):
         result = trans.execute('SELECT username FROM user WHERE id =
%s', user_id)
         return result[0][0]

     def _sessionUpdateQuery(self, trans, sid, username):
         trans.execute('UPDATE session SET username = %s WHERE sid =
%s', [username, sid])

     def validateSid(self, txn, sid):
          res = txn.execute('select id from user where id=?', (sid,))
          return True if res else False

class ObjectGateway(object):
     def __init__(self, pool):
         self.pool = pool
         self.tblGw = TableGateway()

     def _validate(self, txn, sid):
          return self.tblGw.validateSid(txn, sid)

     def validate(self, sid):
          return self.pool.runInteraction(self._validate, sid)

     def handleLogin(self, sid, user_id):
         def _loginInteraction(trans):
             if not self._validate(trans, sid):
                 raise &quot;invalid sid&quot;
             u = self.tblGw._getUserName(trans, user_id)
             self.tblGw._sessionUpdateQuery(trans, sid, username)
             return u
         return self.pool.runInteraction(_loginInteraction)

Regards,
vishal

Date: Tue, 23 Jun 2009 10:25:16 -0400
From: Phil Christensen &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">phil at bubblehouse.org</A>&gt;
Subject: Re: [Twisted-Python] adbapi and multiple queries in single
        transaction.
To: Twisted general discussion &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt;
Message-ID: &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">2E70F4C7-5253-44B2-9DB8-79D8817E96F4 at bubblehouse.org</A>&gt;
Content-Type: text/plain; charset=US-ASCII; format=flowed; delsp=yes

On Jun 23, 2009, at 9:45 AM, Vishal Shetye wrote:
&gt;&gt;<i> I initially thought of putting all the queries per operation in a
</I>&gt;&gt;<i> runInteraction. However this results in code-duplication as many
</I>&gt;&gt;<i> queries are shared between different operations.
</I>
&gt;<i>It seems like the easiest way to deal with this would be to make
</I>&gt;<i>'private' methods for all the standard queries; these methods/
</I>&gt;<i>functions would accept a transaction object like you said, but the
</I>&gt;<i>methods themselves would only be called from an interaction, which can
</I>&gt;<i>supply the transaction object.
</I>
&gt;<i>Then in each public ObjectGateway method you can just define an inner
</I>&gt;<i>function to serve as the interaction, calling each private query
</I>&gt;<i>method in turn, using the transaction object provided to that
</I>&gt;<i>interaction.
</I>
&gt;<i>Here's a stupidly trivial example:
</I>
class ObjectGateway(object):
     def __init__(self, pool):
         self.pool = pool

     def _getUserName(self, trans, user_id):
         result = trans.execute('SELECT username FROM user WHERE id =
%s', user_id);
         return result[0][0]

     def _sessionUpdateQuery(self, trans, sid, username):
         trans.execute('UPDATE session SET username = %s WHERE sid =
%s', [username, sid]);

     def handleLogin(self, sid, user_id):
         def _loginInteraction(trans):
             u = self._getUserName(trans, user_id)
             self._sessionUpdateQuery(trans, sid, username)
             return u
         return self.pool.runInteraction(_loginInteraction)

&gt;<i>Other than being careful not to mess around with the instance state
</I>&gt;<i>during those interactions (they are running in a thread, after all),
</I>&gt;<i>this should be pretty straightforward.
</I>
&gt;<i>Hope this helps,
</I>
-phil
DISCLAIMER
==========
This e-mail may contain privileged and confidential information which is the property of Persistent Systems Ltd. It is intended only for the use of the individual or entity to which it is addressed. If you are not the intended recipient, you are not authorized to read, retain, copy, print, distribute or use this message. If you have received this communication in error, please notify the sender and delete all copies of this message. Persistent Systems Ltd. does not accept any liability for virus infected mails.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019860.html">[Twisted-Python] adbapi and multiple queries in single	transaction.
</A></li>
	<LI>Next message: <A HREF="019864.html">[Twisted-Python] [ANN] Foolscap-0.4.2 released
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19863">[ date ]</a>
              <a href="thread.html#19863">[ thread ]</a>
              <a href="subject.html#19863">[ subject ]</a>
              <a href="author.html#19863">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
