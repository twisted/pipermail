<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] modal wxPython, Twisted, xml-rpc; example code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20modal%20wxPython%2C%20Twisted%2C%20xml-rpc%3B%20example%20code&In-Reply-To=5B75B0FC-9587-11D7-B9B9-000393C92466%40dalkescientific.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004361.html">
   <LINK REL="Next"  HREF="004370.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] modal wxPython, Twisted, xml-rpc; example code</H1>
    <B>Andrew Dalke</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20modal%20wxPython%2C%20Twisted%2C%20xml-rpc%3B%20example%20code&In-Reply-To=5B75B0FC-9587-11D7-B9B9-000393C92466%40dalkescientific.com"
       TITLE="[Twisted-Python] modal wxPython, Twisted, xml-rpc; example code">dalke at dalkescientific.com
       </A><BR>
    <I>Tue Jun  3 21:43:57 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="004361.html">[Twisted-Python] modal wxPython, Twisted, xml-rpc; example code
</A></li>
        <LI>Next message: <A HREF="004370.html">[Twisted-Python] modal wxPython, Twisted, xml-rpc; example code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4368">[ date ]</a>
              <a href="thread.html#4368">[ thread ]</a>
              <a href="subject.html#4368">[ subject ]</a>
              <a href="author.html#4368">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Me:
&gt;<i> I've attached some example code which shows how to use
</I>&gt;<i> a modal wxPython dialog and Twisted to produce a responsive
</I>&gt;<i> GUI which uses XML-RPC to query a remote XML-RPC service to
</I>&gt;<i> get a US state name given it's position in a sorted list.
</I>&gt;<i>
</I>&gt;<i> I've also contributed this as an ActiveState recipe.
</I>
However, it fails for some cases of a modal in a modal.

I have a set of error cases in the code, which looks like this (except
the last one, which I added today).

         if TEST_ERRORS:
             i = self.i
             if i == 3:
                 proxy = Proxy(&quot;<A HREF="http://illegal-host_name/&quot;">http://illegal-host_name/&quot;</A>)
             elif i == 6:
                 proxy = Proxy(&quot;<A HREF="http://beatty.userland.com/&quot;">http://beatty.userland.com/&quot;</A>)
             elif i == 8:
                 proxy = 
Proxy(&quot;<A HREF="http://beatty.userland.com/testing_xmlrpc_error_case&quot;">http://beatty.userland.com/testing_xmlrpc_error_case&quot;</A>)
             elif i == 9:
                 proxy = Proxy(&quot;<A HREF="http://beatty.userland.com:9876/&quot;">http://beatty.userland.com:9876/&quot;</A>)

The last one cases an error during making the connection, and so I get
a &quot;unable to connect to remote host&quot; message.  Now, I want to show that 
message
in another modal, which doesn't use Twisted, so I just opened the modal 
window.

This starts up the wxPython event loop again, which triggers another 
timer
event, which calls back to the Twisted reactor to run another iteration.

It appears that my defered is still active, because I then get an 
'AlreadyCalledError'.
Here's the full stack trace.


Traceback (most recent call last):
   File &quot;Progress.py&quot;, line 158, in Bad
     try_again = task.bad(fail)
   File &quot;Progress.py&quot;, line 52, in bad
     wxCANCEL | wxYES_NO | wxICON_QUESTION)
   File &quot;Progress.py&quot;, line 208, in OnTimer
     reactor.doIteration(0)
   File &quot;E:\Python22\Lib\site-packages\twisted\internet\default.py&quot;, 
line 473, in
  doSelect
     _logrun(selectable, _drdw, selectable, method, dict)
--- &lt;exception caught here&gt; ---
   File &quot;E:\Python22\Lib\site-packages\twisted\python\log.py&quot;, line 64, 
in callWithLogger
     callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
   File &quot;E:\Python22\Lib\site-packages\twisted\python\log.py&quot;, line 51, 
in callWithContext
     return context.call({ILogContext: newCtx}, func, *args, **kw)
   File &quot;E:\Python22\Lib\site-packages\twisted\python\context.py&quot;, line 
32, in callWithContext
     return func(*args,**kw)
   File &quot;E:\Python22\Lib\site-packages\twisted\internet\default.py&quot;, 
line 498, in _doReadOrWrite
     selectable.connectionLost(failure.Failure(why))
   File &quot;E:\Python22\Lib\site-packages\twisted\internet\tcp.py&quot;, line 
396, in connectionLost
     self.failIfNotConnected(error.ConnectError())
   File &quot;E:\Python22\Lib\site-packages\twisted\internet\tcp.py&quot;, line 
315, in failIfNotConnected
     self.connector.connectionFailed(failure.Failure(err))
   File &quot;E:\Python22\Lib\site-packages\twisted\internet\base.py&quot;, line 
527, in connectionFailed
     self.factory.clientConnectionFailed(self, reason)
   File &quot;E:\Python22\Lib\site-packages\twisted\web\xmlrpc.py&quot;, line 209, 
in clientConnectionLost
     self.deferred.errback(reason)
   File &quot;E:\Python22\lib\site-packages\twisted\internet\defer.py&quot;, line 
215, in errback
     self._startRunCallbacks(fail, 1)
   File &quot;E:\Python22\lib\site-packages\twisted\internet\defer.py&quot;, line 
244, in _startRunCallbacks
     raise AlreadyCalledError()
twisted.internet.defer.AlreadyCalledError:


I can't figure out what's going on.  The code I could find for the 
reactor is very
careful to take defereds off the pending list before calling, so 
there's no way to
call them twice.

There's a clue in that only the last of these trigger this error 
condition.  This
suggests something with how the connection is established, and not 
after it's
put into place.  What I think is happening is that that
twisted.internet.base.BaseConnector allows the factory to reattempt the 
connection
when the intial connection failed, and there isn't a guard in case the 
connectionFailed
gets called again.

I still haven't grokked how the deep part of Twisted works - tried for 
the last
while to track this bug further - so I'll leave it up to you all.

In the meanwhile, since I don't need Twisted in the new (sub)modal, my 
workaround
is to do

     def OnTimer(self, event):
         if self.recursive:
             return
         self.recursive = 1
         try:
             reactor.runUntilCurrent()
             reactor.doIteration(0)
         finally:
             self.recursive = 0

					Andrew
					<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dalke at dalkescientific.com</A>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004361.html">[Twisted-Python] modal wxPython, Twisted, xml-rpc; example code
</A></li>
	<LI>Next message: <A HREF="004370.html">[Twisted-Python] modal wxPython, Twisted, xml-rpc; example code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4368">[ date ]</a>
              <a href="thread.html#4368">[ thread ]</a>
              <a href="subject.html#4368">[ subject ]</a>
              <a href="author.html#4368">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
