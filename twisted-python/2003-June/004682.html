<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Flow: better synchronous exceptions [patch]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Flow%3A%20better%20synchronous%20exceptions%20%5Bpatch%5D&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004692.html">
   <LINK REL="Next"  HREF="004690.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Flow: better synchronous exceptions [patch]</H1>
    <B>Christopher Armstrong</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Flow%3A%20better%20synchronous%20exceptions%20%5Bpatch%5D&In-Reply-To="
       TITLE="[Twisted-Python] Flow: better synchronous exceptions [patch]">radix at twistedmatrix.com
       </A><BR>
    <I>Mon Jun 23 22:46:21 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="004692.html">[Twisted-Python] Twisted and NT Services
</A></li>
        <LI>Next message: <A HREF="004690.html">[Twisted-Python] Flow: better synchronous exceptions [patch]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4682">[ date ]</a>
              <a href="thread.html#4682">[ thread ]</a>
              <a href="subject.html#4682">[ subject ]</a>
              <a href="author.html#4682">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Here's a patch that changes semantics of Stage.next. Currently,
if a Deferred errbacks with an exception that you haven't 
explicitly trapped, Stage.next will raise the Failure object
(via the failure's trap method). I've changed this so it rather
does `raise type(failure.value), failure.value, failure.tb'.

What this means is that you can write code like this:

    d = flow.wrap(getDeferred())
    yield d
    try:
        result = d.next()
    except ParticularError, e:
        traceback.print_exc()

Two benefits here. One, I can actually say 
&quot;except ParticularError&quot; -- before, the type of the exception
raised would be Failure. Two, the traceback printed by 
traceback.print_exc() will actually be useful and show you the
stack trace of the original code that raised the error, rather
than the traceback starting from the Failure.trap call. 

Of course, the traceback is cleaned once Deferred.runCallbacks
finishes, but this only matters when the Deferred is resolved
synchronously, as far as I can tell. In that case, you will
get a pretty useless traceback, but it won't  be any more 
useless than the tracebacks that used to be reported.

The only drawback I see is that it breaks a flow test. :-)

  FailTest: exceptions.ZeroDivisionError raised instead of Failure

Because the test is expecting a Failure to be raised, not 
the original, and more useful, exception.

  self.assertRaises(flow.Failure, list, flow.Block(badgen()))

Clark, I'll be waiting for confirmation from you to commit this or
trash it.

-- 
 Twisted | Christopher Armstrong: International Man of Twistery
  Radix  |          Release Manager,  Twisted Project
---------+     <A HREF="http://twistedmatrix.com/users/radix.twistd/">http://twistedmatrix.com/users/radix.twistd/</A>
-------------- next part --------------
? better-synchronous-exceptions.diff
? flow.xhtml
Index: flow.py
===================================================================
RCS file: /cvs/Twisted/sandbox/flow.py,v
retrieving revision 1.107
diff -u -r1.107 flow.py
--- flow.py	22 Jun 2003 06:45:12 -0000	1.107
+++ flow.py	24 Jun 2003 02:35:46 -0000
@@ -297,9 +297,19 @@
                 return self.results.pop(0)
         if self.stop:
             raise StopIteration()
+
         if self.failure:
             self.stop = True
-            return self.failure.trap(*self._trap)
+
+            cr = self.failure.check(*self._trap)
+
+            if cr:
+                return cr
+
+            if self.failure.tb:
+                raise self.failure.value.__class__, self.failure.value, self.failure.tb
+            raise self.failure.value
+
         raise NotReadyError(&quot;Must 'yield' this object before calling next()&quot;)
 
     def _yield(self):
@@ -492,11 +502,13 @@
         obj = obj()
 
     typ = type(obj)
+
     if typ is type([]) or typ is type(tuple()):
         return _List(obj)
+
     if typ is type(''):
         return _String(obj)
-     
+
     if isinstance(obj, defer.Deferred):
         return _Deferred(obj, *trap)
 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004692.html">[Twisted-Python] Twisted and NT Services
</A></li>
	<LI>Next message: <A HREF="004690.html">[Twisted-Python] Flow: better synchronous exceptions [patch]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4682">[ date ]</a>
              <a href="thread.html#4682">[ thread ]</a>
              <a href="subject.html#4682">[ subject ]</a>
              <a href="author.html#4682">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
