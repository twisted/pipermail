<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Storing site-wide information and scheduling tasks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Storing%20site-wide%20information%20and%20scheduling%20tasks&In-Reply-To=001301c33bd6%24763f0eb0%243ba8a8c0%40gatsoft.no">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004762.html">
   <LINK REL="Next"  HREF="004765.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Storing site-wide information and scheduling tasks</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Storing%20site-wide%20information%20and%20scheduling%20tasks&In-Reply-To=001301c33bd6%24763f0eb0%243ba8a8c0%40gatsoft.no"
       TITLE="[Twisted-Python] Storing site-wide information and scheduling tasks">andrew-twisted at puzzling.org
       </A><BR>
    <I>Thu Jun 26 08:43:31 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="004762.html">[Twisted-Python] Storing site-wide information and scheduling tasks
</A></li>
        <LI>Next message: <A HREF="004765.html">[Twisted-Python] Storing site-wide information and scheduling tasks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4763">[ date ]</a>
              <a href="thread.html#4763">[ thread ]</a>
              <a href="subject.html#4763">[ subject ]</a>
              <a href="author.html#4763">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Jun 26, 2003 at 01:31:18PM +0200, Thomas Weholt ( PRIVAT ) wrote:
&gt;<i> Andrew wrote:
</I>&gt;<i> &gt; On Thu, Jun 26, 2003 at 09:08:30AM +0200, Thomas Weholt ( PRIVAT ) wrote:
</I>
&gt;<i> &gt; &gt; In the same server I need to start tasks ( ie. run functions ) at
</I>&gt;<i> &gt; &gt; different intervals. These function-calls can take some time ( they
</I>&gt;<i> &gt; &gt; can fetch files from the net, scan the local filesystem etc. ) so I
</I>&gt;<i> &gt; &gt; guess I need threads, deferred or something similar. These
</I>&gt;<i> &gt; &gt; function-calls must return a result and update the persistent object
</I>&gt;<i> &gt; &gt; mentioned above.
</I>[...]
&gt;<i> &gt;
</I>&gt;<i> &gt; For the &quot;fetch files from the net&quot;, you don't need threads.  Just do
</I>&gt;<i> &gt; something like (warning -- untested code):
</I>&gt;<i> &gt;
</I>[..snip code..]
&gt;<i> &gt;
</I>&gt;<i> &gt;     reactor.callLater(refreshInterval, periodicFileFetch, url)
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Can I call reactor.callLater anywhere in my code, inside a running
</I>&gt;<i> Webserver? Actually, I'll have a list of objects, each  having a execute
</I>&gt;<i> method, and iterate thru the list for instance once a minute, call the
</I>&gt;<i> objects-execute method and it will decide if it is configured to start once
</I>&gt;<i> a minute, or once an hour. It's not a specified number of functions I want
</I>&gt;<i> to call. I want users to be able to put a module into a folder, the folder
</I>&gt;<i> will be scanned at startup of the webserver and the classes in that module
</I>&gt;<i> will be created instances of and put in the mentioned list.
</I>
You can call reactor.callLater whenever you like.  It simply schedules a
function to be run by the reactor.  See:
    <A HREF="http://twistedmatrix.com/documents/howto/time">http://twistedmatrix.com/documents/howto/time</A>

&gt;<i> Another question about getPage; I'll probably have a list of urls too. Will
</I>&gt;<i> getPage work asynch or in serial-mode?
</I>
getPage works asynchronously, that's why it returns a Deferred.

If it was &quot;serial&quot;, i.e. blocking, there wouldn't be much point returning a
Deferred -- it could just return the result immediately.

However, if the result of a function might take a while, but the function
wants to be asynchronous (so it doesn't hold up the rest of Twisted from
doing its stuff), it will return a Deferred -- i.e. a result that hasn't
arrived yet (hence the word &quot;deferred&quot; :).  It's really just a placeholder
for a result that's still to come.

&gt;<i> &gt; For scanning the local filesystem, you could treat it like one big
</I>&gt;<i> &gt; blocking operation, or you could break it into small chunks (i.e. one
</I>&gt;<i> &gt; directory at a time), and process each chunk with callLater(0,
</I>&gt;<i> &gt; processNextChunk).  For the sake of discussion, I'm going to choose a
</I>&gt;<i> &gt; thread :)
</I>&gt;<i> 
</I>&gt;<i> Again, I'll have to look into callLater in the docs, but this will also
</I>&gt;<i> just be one of many possible tasks the user has defined.
</I>
Note that like callLater isn't very special.  It simply says to the reactor
&quot;in N seconds time, I want you to run this function&quot;.  The reactor will then
run that function in around N seconds time (possibly a little later, but not
sooner, iirc).  Like other events the reactor processes, like network
traffic, this all happens in the main thread.  So you can think of it as
being the same as if e.g. a dataReceived handler got triggered at the
appropriate time, and it called your function.  Anyway, read that document I
gave an URL to, and it should all become clear :)

Are you intending on pre-defining all the tasks the user might want to use,
or are you expecting users to want to plugin random code?

&gt;<i> &gt;     # WARNING: More completely untested code.
</I>[...]
&gt;<i> &gt;
</I>&gt;<i> &gt; This is actually more-or-less what twisted.internet.threads.deferToThread
</I>&gt;<i> &gt; does (once you dig deep enough), so you probably want to use it rather
</I>&gt;<i> &gt; than my completely untested code.  I've written it out explicitly in the
</I>&gt;<i> &gt; hope that you'll have a better understanding of how it all works.
</I>
(I just want to re-emphasise that using deferToThread rather than my code is
probably a good idea)

&gt;<i> Thanks for the code, and even though I've commented it abit already I'll
</I>&gt;<i> try to get a better look at it and test some things later tonight.
</I>&gt;<i> Hopefully some of my comments has cleared things up too.
</I>&gt;<i> 
</I>&gt;<i> If anybody's interested this is what I'm trying to develop; a webserver
</I>[..snip the usual omni-uber-server-that-will-take-over-the-world thing that
   Twisted does so well ;) ..]
&gt;<i> 
</I>&gt;<i> One of the tasks I have to do is fetch RDF/RSS files for syndication. But
</I>&gt;<i> I want to make a dynamic system where a user can just subclass/implement a
</I>&gt;<i> specified class/interface and put his module into a specified folder and
</I>&gt;<i> it will automatically be imported and run from the server.
</I>
Ok.  A couple of things...

First, Twisted already has a system for dealing with plugins (it's how mktap
works!), so you possibly want to re-use that :)   See twisted.python.plugins

Second, the two snippets of example code I've given you could easily be
adapted into a standard interface:

    from twisted.python.components import Interface

    class IUberServerPlugin(Interface):
        def startPlugin(self):
            &quot;&quot;&quot;Called to start the plugin.

            This will typically be called when the program starts, similarly
            to e.g. twisted.internet.protocols.Factory.startFactory, or
            twisted.internet.app.ApplicationService.startService.
            &quot;&quot;&quot;

        def stopPlugin(self):
            &quot;&quot;&quot;Called to stop the plugin.

            Typically this will be called on shutdown, e.g. like stopFactory
            or stopService.
            &quot;&quot;&quot;

        # ...etc...

So, my earlier code for getting a page could become something like:

    from twisted.web.client import getPage
    from twisted.internet import reactor
    from twisted.python import log

    from uberserver.interfaces import IUberServerPlugin   # ;)

    class PageFetchPlugin:
        __implements__ = (IUberServerPlugin,)
        
        def __init__(self, uberServer, url, refreshInterval=30):
            self.uberServer = uberServer
            self.url = url
            self.refreshInterval = refreshInterval

        def startPlugin(self):
            reactor.callLater(refreshInterval, self.periodicFileFetch)

        def periodicFileFetch(self):
            d = getPage(self.url)

            # Process the page, (e.g. to extract URLs, or something)
            d.addCallback(self.processPage)

            # Update the central uberServer
            d.addCallback(self.uberServer.updateObject)

            # Log any errors in downloading or processing
            d.addErrback(log.err)

            # Reschedule this function
            d.addBoth(reactor.callLater, self.refreshInterval, 
                      self.periodicFileFetch)

        def processPage(self):
            &quot;&quot;&quot;Your code *still* goes here ;)&quot;&quot;&quot;


I hope I've given you some helpful ideas! :)

-Andrew.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004762.html">[Twisted-Python] Storing site-wide information and scheduling tasks
</A></li>
	<LI>Next message: <A HREF="004765.html">[Twisted-Python] Storing site-wide information and scheduling tasks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4763">[ date ]</a>
              <a href="thread.html#4763">[ thread ]</a>
              <a href="subject.html#4763">[ subject ]</a>
              <a href="author.html#4763">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
