<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted-webserver hangs when serving big files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted-webserver%20hangs%20when%20serving%20big%20files&In-Reply-To=005701c32ce4%24ae1b82b0%240401a8c0%40razor">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004474.html">
   <LINK REL="Next"  HREF="004451.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted-webserver hangs when serving big files</H1>
    <B>Moshe Zadka</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted-webserver%20hangs%20when%20serving%20big%20files&In-Reply-To=005701c32ce4%24ae1b82b0%240401a8c0%40razor"
       TITLE="[Twisted-Python] Twisted-webserver hangs when serving big files">m at moshez.org
       </A><BR>
    <I>Sat Jun  7 09:08:56 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="004474.html">[Twisted-Python] Twisted-webserver hangs when serving big files
</A></li>
        <LI>Next message: <A HREF="004451.html">[Twisted-Python] Twisted-webserver hangs when serving big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4441">[ date ]</a>
              <a href="thread.html#4441">[ thread ]</a>
              <a href="subject.html#4441">[ subject ]</a>
              <a href="author.html#4441">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sat, 7 Jun 2003, &quot;Thomas Weholt&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">2002 at weholt.org</A>&gt; wrote:

&gt;<i> I'm trying to create a webserver using code from HEP Message Server, which
</I>&gt;<i> in turn is based on Twisted. I cannot use rpys in this project due to
</I>&gt;<i> limitations on other parts of the system. I need to be able to send huge
</I>&gt;<i> files in a non-blocking manner, preferrably supporting Byte-ranges and
</I>&gt;<i> partial downloads too, but that's secondary to just being able to download
</I>&gt;<i> normally.
</I>...
&gt;<i> My code hangs when the request is for big files.
</I>...
&gt;<i> class RequestHandler(Request):
</I>...

Why in god's name are you overriding the Request object?
Instead of using, say, a root resource which does simple dispatching?
That would allow you to actually *use* the code in Twisted.Web, instead
of hacking up your own stuff, which is buggy :)

&gt;<i>     def sendRequestedFile(self):
</I>...
&gt;<i>         htmlFile = open(pagefilename, 'r+b')
</I>&gt;<i>         self.setHeader(&quot;Content-type&quot;,mimetype)
</I>&gt;<i>         chunk = htmlFile.read(1024)
</I>&gt;<i>         while chunk:
</I>&gt;<i>             self.write(chunk)
</I>&gt;<i>             chunk = htmlFile.read(1024)
</I>&gt;<i>         htmlFile.close()
</I>
Yes, when you write hanging code, it hangs. You are sending the whole file
in one go. Soon, .send() overflows the OS buffers, and then Twisted dutifully
starts to buffer for you. That should give the symptoms you see.

I suggest just substuting it with static.File(pagefilename).render(self)

-- 
Moshe Zadka -- <A HREF="http://moshez.org/">http://moshez.org/</A>
Buffy: I don't like you hanging out with someone that... short.
Riley: Yeah, a lot of young people nowadays are experimenting with shortness.
Agile Programming Language -- <A HREF="http://www.python.org/">http://www.python.org/</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004474.html">[Twisted-Python] Twisted-webserver hangs when serving big files
</A></li>
	<LI>Next message: <A HREF="004451.html">[Twisted-Python] Twisted-webserver hangs when serving big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4441">[ date ]</a>
              <a href="thread.html#4441">[ thread ]</a>
              <a href="subject.html#4441">[ subject ]</a>
              <a href="author.html#4441">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
