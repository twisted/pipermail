<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Hep and Twisted (Was: Twisted-webserver hangs	when serving big files)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Hep%20and%20Twisted%20%28Was%3A%20Twisted-webserver%20hangs%0A%09when%20serving%20big%20files%29&In-Reply-To=%3C1055430931.7748.41.camel%40mingus%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="037026.html">
   <LINK REL="Next"  HREF="036946.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Hep and Twisted (Was: Twisted-webserver hangs	when serving big files)</H1>
    <B>Abe Fettig</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Hep%20and%20Twisted%20%28Was%3A%20Twisted-webserver%20hangs%0A%09when%20serving%20big%20files%29&In-Reply-To=%3C1055430931.7748.41.camel%40mingus%3E"
       TITLE="[Twisted-Python] Hep and Twisted (Was: Twisted-webserver hangs	when serving big files)">abe at fettig.net
       </A><BR>
    <I>Thu Jun 12 09:15:32 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="037026.html">[Twisted-Python] Hep and Twisted (Was: Twisted-webserver hangs when serving big files)
</A></li>
        <LI>Next message (by thread): <A HREF="036946.html">[Twisted-Python] Re: [Twisted-commits] Expand ITCPTransport
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37053">[ date ]</a>
              <a href="thread.html#37053">[ thread ]</a>
              <a href="subject.html#37053">[ subject ]</a>
              <a href="author.html#37053">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 2003-06-11 at 06:27, Jp Calderone wrote:
&gt;<i> On Mon, Jun 09, 2003 at 01:35:56PM -0400, Abe Fettig wrote:
</I>&gt;<i> &gt; [snip]
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; * The SMTP server: Currently going through a rewrite in CVS.  I need to
</I>&gt;<i> &gt; set up code to manage the outgoing message queue, and keep track of
</I>&gt;<i> &gt; which messages have been delivered to which locations.  Is there code in
</I>&gt;<i> &gt; twisted.mail to do this? (Keep in mind some messages are being delivered
</I>&gt;<i> &gt; to blogs and other non-SMTP locations)
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i>   There will be code for this in the relatively near the future -- this is a
</I>&gt;<i> subtask of an item high on my todo list.
</I>&gt;<i> 
</I>&gt;<i> I'll check out your blog and maybe some of the Hep source (if it is
</I>&gt;<i> appropriate to do so?) to get a better idea of your use case, so I can keep
</I>&gt;<i> it in mind.
</I>&gt;<i> 
</I>&gt;<i>   If you want to toss any info my way regarding the details of your use
</I>&gt;<i> case, I'll keep them in mind as I work on the implementation.
</I>
I'd like to be able to inherit from a class that handled all the queue
management bits (keeping track of which messages are in the queue,
calling back with a notification of which messages were and were not
delivered, etc).  Something like this:

Class MyQueue(MessageQueue):

	def deliverMessage(self, message, destinationAddress):
		[ my delivery code ]
                [ return a deferred ]
		

q = MyQueue()
d = q.addMessageToQueue(myMessage, destAddresses)
d.addCallback(allMessagesWereDelivered)
d.addErrback(someMessagesWereNotDelivered)


This doesn't take into account cases where you're delivering the same
message to several users on the same SMTP server (a very common case if
you're simply using an upstream server for all delivery).  In this case
calling deliverMessage() once for each address is bad.  Maybe it would
be better if the inheriting class could specify how different groups of
addresses should be delivered, like this:

def getDeliveryFunctionsForAddresess(self, addresses):
	deliveryFunctions = {
		self.deliverToLocalServer:[], 
		self.deliverToUpstreamServer: []}

	for address in addresses:
		if address.endswith(&quot;@mylocaldomain&quot;)
			deliveryFunctions[self.deliverToLocalServer].append(address)		
		else:
			deliveryFunctions[self.deliverToUpstreamServer].append(address)

	return deliveryFunctions

Another problem is that the queue should be maintained between
sessions.  The server may be shut down while a message is still waiting
to be delivered to one or more destinations.  In that case you may not
be able to rely on getting a callback when a message is delivered (since
the original deferred has probably been lost). Maybe it would be better
to register a function with the queue that gets called each time a
message is delivered, or fails?

q = MyQueue
q.notifierFunction = notifyUserOfDelivery

Anyhow, I'm sure you'll find a better solution than the ones I've listed
here. But hopefully that gives you an idea of what I'd be looking for -
the important thing is that I be able to change the delivery behavior
based on the destination address. If you'd like to take a look at the
code in Hep 0.3.3 you're welcome to - see servers/smtp.py and
agents/deliver.py.  Just keep in mind that this code is 6 months old,
and the architecture of Hep has changed somewhat since then.

Hep can easily convert messages to and from email.Message and/or rfc822
text objects, so I don't have a problem with your code depending on one
of those formats.

Abe



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="037026.html">[Twisted-Python] Hep and Twisted (Was: Twisted-webserver hangs when serving big files)
</A></li>
	<LI>Next message (by thread): <A HREF="036946.html">[Twisted-Python] Re: [Twisted-commits] Expand ITCPTransport
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37053">[ date ]</a>
              <a href="thread.html#37053">[ thread ]</a>
              <a href="subject.html#37053">[ subject ]</a>
              <a href="author.html#37053">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
