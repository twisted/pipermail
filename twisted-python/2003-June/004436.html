<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted-webserver hangs when serving big files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted-webserver%20hangs%20when%20serving%20big%20files&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004434.html">
   <LINK REL="Next"  HREF="004474.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted-webserver hangs when serving big files</H1>
    <B>Thomas Weholt</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted-webserver%20hangs%20when%20serving%20big%20files&In-Reply-To="
       TITLE="[Twisted-Python] Twisted-webserver hangs when serving big files">2002 at weholt.org
       </A><BR>
    <I>Sat Jun  7 07:05:17 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="004434.html">[Twisted-Python] t.web.woven.widgets.Anchor and .Link
</A></li>
        <LI>Next message: <A HREF="004474.html">[Twisted-Python] Twisted-webserver hangs when serving big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4436">[ date ]</a>
              <a href="thread.html#4436">[ thread ]</a>
              <a href="subject.html#4436">[ subject ]</a>
              <a href="author.html#4436">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm trying to create a webserver using code from HEP Message Server, which
in turn is based on Twisted. I cannot use rpys in this project due to
limitations on other parts of the system. I need to be able to send huge
files in a non-blocking manner, preferrably supporting Byte-ranges and
partial downloads too, but that's secondary to just being able to download
normally.

My code hangs when the request is for big files. Smaller ones like JPEGs
etc. is ok, but for a test-file on approx. 33MB it just hangs and starts
chewing up memory. The files are stored in a folder called wwwroot in the
same folder as the source file. I'm using Twisted 1.0.5.

The project is a normal webserver used for serving files from 10-500mb,
while also serving HTML-based content. I need to be able to control the
generated content, ie. a producer generates the core-content and I wrap that
content in a template which holds the overall design for the entire site. I
didn't find a way to do that using rpys so I'm trying this code instead. Ok,
that's not the important part, if somebody could just tell me why this
hangs. I can see that the server sends out the correct content-type, but it
seem to hang when it is suppose to write the binary content to the client.

PS! Any info on Twisted.webs status on Byte-ranges, partial download and
gzipped content in responses are also important.

Best regards,
Thomas Weholt

from twisted.protocols.http import HTTPFactory, HTTPChannel, Request
from twisted.internet import app
import time, os, sys, types, mimetypes, ConfigParser

def getFactory(config):
    f = HTTPFactory()
    f.config = config
    f.protocol = MyChannel
    return f

class MyChannel(HTTPChannel):
    def __init__(self):
        HTTPChannel.__init__(self)
        self.requestFactory = RequestHandler

class RequestHandler(Request):
    def __init__(*args):
        Request.__init__(*args)
        self = args[0]

    def process(self):

        if not self.authenticate():
            self.setResponseCode(401, &quot;Unauthorized&quot;)
            self.setHeader('WWW-Authenticate', 'Basic realm=&quot;Some server&quot;')
            self.write(&quot;Access denied&quot;)
            self.finish()
            return

        requestData = self.uri.split(&quot;?&quot;)
        self.pageName = requestData[0]
        if len(requestData) &gt; 1:
            form = parse_qs(requestData[1])
        else:
            form = {}

        self.pageName = 'somehugefile.dat'
        self.sendRequestedFile()
        self.finish()

    def getLocalFileName(self, pageName):
        filenameParts = ['wwwroot'] + pageName.split(&quot;/&quot;)
        pagefilename = os.path.join(*filenameParts)
        if os.path.isfile(pagefilename):
            return pagefilename

    def sendRequestedFile(self):
        pagefilename = self.getLocalFileName(self.pageName)
        mimeInfo = mimetypes.guess_type(pagefilename)
        if mimeInfo[0]:
            mimetype = mimeInfo[0]
        else:
            mimetype = &quot;text/plain&quot;
        htmlFile = open(pagefilename, 'r+b')
        self.setHeader(&quot;Content-type&quot;,mimetype)
        chunk = htmlFile.read(1024)
        while chunk:
            self.write(chunk)
            chunk = htmlFile.read(1024)
        htmlFile.close()

    def authenticate(self):
        username = self.getUser()
        password = self.getPassword()
        if username and password:
            return username == 'thomas' and password == 'test.pass'

print &quot;Running something ...&quot;,
app = app.Application(&quot;MyApp&quot;)
config = ConfigParser.ConfigParser()
config.readfp(open('config.ini'))
app.listenTCP(6060, getFactory(config))
print &quot;ok&quot;
app.run()
print &quot;Stopped&quot;



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004434.html">[Twisted-Python] t.web.woven.widgets.Anchor and .Link
</A></li>
	<LI>Next message: <A HREF="004474.html">[Twisted-Python] Twisted-webserver hangs when serving big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4436">[ date ]</a>
              <a href="thread.html#4436">[ thread ]</a>
              <a href="subject.html#4436">[ subject ]</a>
              <a href="author.html#4436">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
