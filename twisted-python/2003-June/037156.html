<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> Fwd: [Twisted-Python] New Guard question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20Fwd%3A%20%5BTwisted-Python%5D%20New%20Guard%20question&In-Reply-To=%3C9079C2D3-A43D-11D7-B52C-000393C9700E%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="037155.html">
   <LINK REL="Next"  HREF="037157.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Fwd: [Twisted-Python] New Guard question</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20Fwd%3A%20%5BTwisted-Python%5D%20New%20Guard%20question&In-Reply-To=%3C9079C2D3-A43D-11D7-B52C-000393C9700E%40twistedmatrix.com%3E"
       TITLE="Fwd: [Twisted-Python] New Guard question">glyph at twistedmatrix.com
       </A><BR>
    <I>Sat Jun 21 17:10:35 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="037155.html">[Twisted-Python] Re: [Twisted-commits] explanation of () for anonymity
</A></li>
        <LI>Next message (by thread): <A HREF="037157.html">[Twisted-Python] Weirdness in flow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37156">[ date ]</a>
              <a href="thread.html#37156">[ thread ]</a>
              <a href="subject.html#37156">[ subject ]</a>
              <a href="author.html#37156">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Begin forwarded message:

&gt;<i> From: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adalke at mindspring.com</A>
</I>
&gt;<i> Hi Glyph,
</I>&gt;<i>
</I>&gt;<i>   I'm travelling right now, and can't send from the account I use
</I>&gt;<i> to send mail to Twisted, so I'm sending this via personal email.
</I>&gt;<i> Feel free to CC to Twisted as needed.
</I>
Your wish is my command.

&gt;<i> You gave two examples, a badidea one and a sketch of a new
</I>&gt;<i> one.  I think you are presenting a straw-man badidea.
</I>
They were demonstrations of a coding style which I have actually seen 
several examples of.  I think you're actually agreeing with me, because 
I can't find anything in this message that indicates otherwise.

Let me be clear on the distinction between these styles: what I am 
saying is *good* is keeping the avatar in the resource (which the 
new-cred enabled UsernamePasswordWrapper pretty much requires).

This is good because resources are lightweight and it establishes a 
good encapsulation barrier.  Rather than having a Resource which 
depends on state in the session, or a non-Resource which does 
resource-like things and accept different arguments.  You have a 
resource that can _always_ render itself as long as it is internally 
consistent.

What I am saying is *bad* is retrieving the avatar from the session 
every time in your own application code.  Now, obviously the code-path 
to retrieve the avatar object does have to interact with your session, 
because HTTP sucks, but this is tricky and you should wrap it if you 
can.  Guard does it for you, and I think it does a good job, but if it 
doesn't you should probably contribute fixes or suggestions for how it 
could be better, and not write your own session-masher.

&gt;<i> Were I to write such code, it would look like
</I>&gt;<i>
</I>&gt;<i> import weakref
</I>&gt;<i> request_info = WeakRef.WeakKeyDictionary()
</I>&gt;<i>
</I>&gt;<i> class MyGuardResource(Resource):
</I>&gt;<i>   def __init__(self, guarded_resource, realm):
</I>&gt;<i>     Resource.__init__(self)
</I>&gt;<i>     self.realm = realm
</I>&gt;<i>     self.guarded_resource = guarded_resource
</I>&gt;<i>
</I>&gt;<i>   def getChild(self, name):
</I>&gt;<i>     # Fix as needed if getChild is supposed to return None for no 
</I>&gt;<i> named child
</I>&gt;<i>     return MyGuardResource(self.realm, 
</I>&gt;<i> self.guarded_resource.getChild(name))
</I>&gt;<i>
</I>&gt;<i>   def render(self, request):
</I>&gt;<i>     # negotiate session
</I>&gt;<i>     s = request.getSession()
</I>&gt;<i>     if s is None:
</I>&gt;<i>       return request.setupSession()
</I>&gt;<i>
</I>&gt;<i>     # Logged in?
</I>&gt;<i>     c = s.getComponent(ICredSession)
</I>&gt;<i>     if c is None:
</I>&gt;<i>       request.setHeader('content-type', 'text/plain')
</I>&gt;<i>       return 'it looks like you are anonymous please log in!'
</I>&gt;<i>     avatar = c.getLoggedInForRealm(self.realm)
</I>&gt;<i>     # Either use a weakref like this
</I>&gt;<i>     request_info[request] = {&quot;avatar&quot;: avatar}
</I>&gt;<i>     return self.guarded_resource.render(request)
</I>&gt;<i>     # or change the call API for request, like
</I>&gt;<i>     # return self.guarded_resource.render(request, avatar)
</I>
In this example, self.guarded_resource would not be a Resource, but 
some special GuardedResource subclass which produced output for an 
avatar rather than a request.

&gt;<i> Neither the weakref nor the tweaked parameters are
</I>&gt;<i> particularly satisfying.  I could make it nicer by assuming I
</I>&gt;<i> can call the Resource constructor, as you seem to allow.
</I>
But then, what would you call the Resource constructor with?  Perhaps 
the avatar? :).

&gt;<i> It's hard to compare to your &quot;not so bad&quot; example because
</I>&gt;<i> you don't show how your two resources are added to the
</I>&gt;<i> system.  As written, you don't allow either one to have dynamic
</I>&gt;<i> children, so that being the case, the following would be a
</I>&gt;<i> simpler replacement for your &quot;badidea&quot; code
</I>
The &quot;bad idea&quot; resource is a resource that is statically added on the 
&quot;web&quot; side of things by a putChild or a .rpy or somesuch, and thus can 
only know what realm it is being added for, and must be added in 
parallel with the guard object.

The &quot;not so bad&quot; resource is meant to be instantiated by a Realm.  Most 
likely, adaption to the appropriate interface using the components 
system will be automated by some common Realm base class when we add 
one, but for now it's up to you to figure out to return a Resource.  In 
this case, only the UsernamePasswordWrapper has to know about the 
Portal, and the realm can create an appropriate Resource without 
knowing anything else about the structure of other web code.

Actually the &quot;bad idea&quot; resource can't do dynamic children without 
doing boilerplate, whereas the &quot;not so bad&quot; resource may implement 
getChild in a naive way and it will work properly.

&gt;<i> class MySimpleGuardResource(Resource):
</I>&gt;<i>   def __init__(self, realm, authorized, not_authorized):
</I>&gt;<i>     Resource.__init__(self):
</I>&gt;<i>     self.realm = realm
</I>&gt;<i>      .. same for the other two parameter...
</I>&gt;<i>   def render(self, request):
</I>&gt;<i>     # negotiate session
</I>&gt;<i>      ... getSession() .. if is None ... setupSession
</I>&gt;<i>     c = s.getComponent(ICredSession)
</I>&gt;<i>     if c is None:
</I>&gt;<i>       return self.not_authorized().render(session)
</I>&gt;<i>     return self.authorized(c).render(session)
</I>&gt;<i>
</I>&gt;<i> in which case I can identically use your not-so-bad
</I>&gt;<i> classes.
</I>
Well, yes, that is the whole point of guard.

&gt;<i> So you say:
</I>&gt;&gt;<i> Consider, if you want to use woven.guard's nifty session-negotiation
</I>&gt;&gt;<i> feature, but also keep your user-specific code in a session, your code
</I>&gt;&gt;<i> will look like this:
</I>
Let me clarify:

If you want to use woven.guard's nifty session-negotiation feature, but 
also implement service-specific functionality in the resource and 
retrieve it from the session yourself rather than just creating an 
intelligent stateful resource, your code will look like this:


&gt;<i> but I don't see why the latter follows from the former, given that with
</I>&gt;<i> a simple adapter it appears to allow your code.
</I>
... which is what Guard is doing.  The point is that I am encouraging 
users to use this adapter and have the Realm create an appropriate 
resource by calling its constructor, rather than attempting to have a 
resource initialized dumb and then re-customize itself on each call to 
render().

If you still really think this is a straw-man example of bad style, 
then I applaud your optimism, but it's seriously a very common mistake 
:<i>-).  After all, most web frameworks have the notion of rendering a 
</I>page as pretty basic, and then things that are &quot;dynamic&quot; are 
implemented with do-I-have-a-logged-in-user conditionals, not object 
references.

&gt;<i> Mind you, I'm still trying to understand how to do authentication in 
</I>&gt;<i> Twisted, either cred or mind style.  I know how to do it myself, so 
</I>&gt;<i> that's my starting point.
</I>
&quot;cred or mind style&quot;?  There are only two styles, one of which is 
old-cred (Service/Perspective/Authorizer), which is awful and horrible 
and don't use it please unless you have to interact with code that 
hasn't been ported from it yet, and new-cred 
(Realm/Avatar/CredentialsChecker), which will be available in 1.0.6, 
and all this discussion is about.

&gt;<i> Regarding names, IMHO, &quot;Guard&quot; is a better name than &quot;Portal&quot;,
</I>&gt;<i> and you could use &quot;UsernamePasswordGuard&quot;, etc. rather than
</I>&gt;<i> &quot;...Wrapper&quot;.
</I>
Hmm.  'Guard' is a different thing from 'Portal', but I think that 
you're right about UsernamePasswordGuard rather than 
UsernamePasswordWrapper.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="037155.html">[Twisted-Python] Re: [Twisted-commits] explanation of () for anonymity
</A></li>
	<LI>Next message (by thread): <A HREF="037157.html">[Twisted-Python] Weirdness in flow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37156">[ date ]</a>
              <a href="thread.html#37156">[ thread ]</a>
              <a href="subject.html#37156">[ subject ]</a>
              <a href="author.html#37156">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
