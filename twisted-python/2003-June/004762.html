<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Storing site-wide information and scheduling tasks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Storing%20site-wide%20information%20and%20scheduling%20tasks&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004756.html">
   <LINK REL="Next"  HREF="004763.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Storing site-wide information and scheduling tasks</H1>
    <B>Thomas Weholt ( PRIVAT )</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Storing%20site-wide%20information%20and%20scheduling%20tasks&In-Reply-To="
       TITLE="[Twisted-Python] Storing site-wide information and scheduling tasks">2002 at weholt.org
       </A><BR>
    <I>Thu Jun 26 07:31:18 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="004756.html">[Twisted-Python] Storing site-wide information and scheduling tasks
</A></li>
        <LI>Next message: <A HREF="004763.html">[Twisted-Python] Storing site-wide information and scheduling tasks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4762">[ date ]</a>
              <a href="thread.html#4762">[ thread ]</a>
              <a href="subject.html#4762">[ subject ]</a>
              <a href="author.html#4762">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>----- Original Message -----
From: &quot;Andrew Bennetts&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrew-twisted at puzzling.org</A>&gt;
To: &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt;
Sent: Thursday, June 26, 2003 10:26 AM
Subject: Re: [Twisted-Python] Storing site-wide information and scheduling
tasks


&gt;<i> On Thu, Jun 26, 2003 at 09:08:30AM +0200, Thomas Weholt ( PRIVAT ) wrote:
</I>&gt;<i> &gt; I want to start a webserver which have object ( or whatever ) available
</I>in
&gt;<i> &gt; all Resource-instances running in that server which holds common
</I>information
&gt;<i> &gt; for the entire site. What's the appropriate module to use for this;
</I>&gt;<i> &gt; Application, Factory ??
</I>&gt;<i>
</I>&gt;<i> I'll let someone else answer this, but I think you want a Service.
</I>
I'll look at the API-reference, but I think Service is somewhat missing from
the docs. Or .. ???

&gt;<i>
</I>&gt;<i> &gt; In the same server I need to start tasks ( ie. run functions ) at
</I>different
&gt;<i> &gt; intervals. These function-calls can take some time ( they can fetch
</I>files
&gt;<i> &gt; from the net, scan the local filesystem etc. ) so I guess I need
</I>threads,
&gt;<i> &gt; deferred or something similar. These function-calls must return a result
</I>and
&gt;<i> &gt; update the persistent object mentioned above.
</I>&gt;<i>
</I>&gt;<i> (Btw, you seem to think Deferreds make blocking code magically
</I>non-blocking.
&gt;<i> They don't -- they're actually very straightforward and non-magical.)
</I>&gt;<i>
</I>&gt;<i> For the &quot;fetch files from the net&quot;, you don't need threads.  Just do
</I>&gt;<i> something like (warning -- untested code):
</I>&gt;<i>
</I>&gt;<i>     from twisted.web.client import getPage
</I>&gt;<i>     from twisted.internet import reactor
</I>&gt;<i>     from twisted.python import log
</I>&gt;<i>
</I>&gt;<i>     refreshInterval = 30
</I>&gt;<i>
</I>&gt;<i>     def periodicFileFetch(url):
</I>&gt;<i>         d = getPage(url)
</I>&gt;<i>         # Process the page, and &quot;update the persistent object&quot;
</I>&gt;<i>         d.addCallback(processPage).addCallback(updateObject)
</I>&gt;<i>
</I>&gt;<i>         # Log any errors in downloading or processing
</I>&gt;<i>         d.addErrback(log.err)
</I>&gt;<i>
</I>&gt;<i>         # Reschedule this function
</I>&gt;<i>         d.addBoth(reactor.callLater, refreshInterval, periodicFileFetch,
</I>url)
&gt;<i>
</I>&gt;<i>     def processPage(x):
</I>&gt;<i>         &quot;Your code goes here!&quot;
</I>&gt;<i>     def updateObject(x):
</I>&gt;<i>         &quot;Your code goes here!&quot;
</I>&gt;<i>
</I>&gt;<i>     reactor.callLater(refreshInterval, periodicFileFetch, url)
</I>&gt;<i>
</I>
Can I call reactor.callLater anywhere in my code, inside a running
Webserver? Actually, I'll have a list of objects, each  having a execute
method, and iterate thru the list for instance once a minute, call the
objects-execute method and it will decide if it is configured to start once
a minute, or once an hour. It's not a specified number of functions I want
to call. I want users to be able to put a module into a folder, the folder
will be scanned at startup of the webserver and the classes in that module
will be created instances of and put in the mentioned list.

Another question about getPage; I'll probably have a list of urls too. Will
getPage work asynch or in serial-mode?

&gt;<i> For scanning the local filesystem, you could treat it like one big
</I>blocking
&gt;<i> operation, or you could break it into small chunks (i.e. one directory at
</I>a
&gt;<i> time), and process each chunk with callLater(0, processNextChunk).  For
</I>the
&gt;<i> sake of discussion, I'm going to choose a thread :)
</I>
Again, I'll have to look into callLater in the docs, but this will also just
be one of many possible tasks the user has defined.

&gt;<i>
</I>&gt;<i> The trick with threads is to avoid interacting directly with *any* of your
</I>&gt;<i> existing objects that your main event loop uses.  Disregarding this advice
</I>&gt;<i> will lead to race conditions, and thus horrid, horrid bugs.  So, we scan
</I>for
&gt;<i> files in a thread, but to make it safe we send the instruction to do work
</I>to
&gt;<i> the thread via a Queue.Queue, and make sure it returns the results to the
</I>&gt;<i> deferred via reactor.callFromThread.
</I>&gt;<i>
</I>&gt;<i>     # WARNING: More completely untested code.
</I>&gt;<i>
</I>&gt;<i>     from twisted.python import log, failure
</I>&gt;<i>     from twisted.internet import reactor, defer
</I>&gt;<i>     import Queue, threading
</I>&gt;<i>
</I>&gt;<i>     refreshInterval = 30
</I>&gt;<i>
</I>&gt;<i>     def processEvents(queue):
</I>&gt;<i>         &quot;&quot;&quot;A thread that processes events.
</I>&gt;<i>
</I>&gt;<i>         It receives (deferred, function) 2-tuples from a Queue.Queue, runs
</I>&gt;<i>         the function, and fires the deferred with the result.
</I>&gt;<i>         &quot;&quot;&quot;
</I>&gt;<i>         while 1:
</I>&gt;<i>             try:
</I>&gt;<i>                 deferred, func = queue.get()
</I>&gt;<i>             except:
</I>&gt;<i>                 log.err()
</I>&gt;<i>                 continue
</I>&gt;<i>             try:
</I>&gt;<i>                 reactor.callFromThread(deferred.callback, func())
</I>&gt;<i>             except Exception, e:
</I>&gt;<i>                 reactor.callFromThread(deferred.errback,
</I>failure.Failure(e))
&gt;<i>
</I>&gt;<i>     def periodicFileScanner(queue, path):
</I>&gt;<i>         # Tell the thread it's time to do some work
</I>&gt;<i>         d = defer.Deferred()
</I>&gt;<i>         q.put((d, lambda: scanFiles(path)))
</I>&gt;<i>
</I>&gt;<i>         # Arrange for the result/error to be dealt with
</I>&gt;<i>         d.addCallback(updateObject)
</I>&gt;<i>         d.addErrback(log.err)
</I>&gt;<i>
</I>&gt;<i>         # Schedule this fun merry-go-round to happen again
</I>&gt;<i>         d.addBoth(reactor.callLater, refreshInterval, periodicFileScanner,
</I>&gt;<i>                   queue, path)
</I>&gt;<i>
</I>&gt;<i>     def initFileScanning(path):
</I>&gt;<i>         q = Queue.Queue()
</I>&gt;<i>         t = threading.Thread(target=processEvents, args=(q,))
</I>&gt;<i>         t.start()
</I>&gt;<i>         reactor.callLater(refreshInterval, periodicFileScanner, q, path)
</I>&gt;<i>
</I>&gt;<i>     def scanFiles(path):
</I>&gt;<i>         &quot;Your code goes here!&quot;
</I>&gt;<i>     def updateObject(x):
</I>&gt;<i>         &quot;Your code goes here!&quot;
</I>&gt;<i>
</I>&gt;<i>     initFileScanning('/path')
</I>&gt;<i>
</I>&gt;<i> This is actually more-or-less what twisted.internet.threads.deferToThread
</I>&gt;<i> does (once you dig deep enough), so you probably want to use it rather
</I>than
&gt;<i> my completely untested code.  I've written it out explicitly in the hope
</I>&gt;<i> that you'll have a better understanding of how it all works.
</I>&gt;<i>
</I>&gt;<i> Note also how Deferreds are just messengers -- they don't do any
</I>interesting
&gt;<i> work beyond calling callbacks when they're told to.
</I>&gt;<i>
</I>&gt;<i> &gt; Can anybody show me a very basic example on how to do this?
</I>&gt;<i>
</I>&gt;<i> I hope I've my example code is basic enough that it makes sense for you --
</I>&gt;<i> let us know if you're still uncertain about anything.
</I>
Thanks for the code, and even though I've commented it abit already I'll try
to get a better look at it and test some things later tonight. Hopefully
some of my comments has cleared things up too.

If anybody's interested this is what I'm trying to develop; a webserver for
blogging, image-galleries, messaging ( perhaps with interfaces to IRC and
jabber, hopefully ICQ too), news aggregator/syndication and distributed/p2p
content exchange ( not just filesharing, more like creating a virtual
cluster of webservers and get some communication going between them so they
can discover new nodes and query nodes for information ). It's a crossover
between Radio.Userland/MovableType and Gnutella ( I won't use the
gnutella-protocoll, just let the server use FOAF-files, which can contain
info about other nodes, which can provide a FOAF-file etc. and base
node-discovery on information in FOAF-files. ) HEP Messaging Server is
somewhat similar and has been one source of inspiration so far, both in
concept and code.

One of the tasks I have to do is fetch RDF/RSS files for syndication. But I
want to make a dynamic system where a user can just subclass/implement a
specified class/interface and put his module into a specified folder and it
will automatically be imported and run from the server.

Ok, this was a terrible mess of info, but hopefully it makes some sense. Any
comments, hints, ideas etc. would be very appreciated.

Thomas



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004756.html">[Twisted-Python] Storing site-wide information and scheduling tasks
</A></li>
	<LI>Next message: <A HREF="004763.html">[Twisted-Python] Storing site-wide information and scheduling tasks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4762">[ date ]</a>
              <a href="thread.html#4762">[ thread ]</a>
              <a href="subject.html#4762">[ subject ]</a>
              <a href="author.html#4762">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
