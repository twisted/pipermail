<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to Solve a Problem Like Santa with Stackless and Twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20Solve%20a%20Problem%20Like%20Santa%20with%0A%20Stackless%20and%20Twisted&In-Reply-To=%3C20111213041530.GB11352%40laptop.huang.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="057495.html">
   <LINK REL="Next"  HREF="057498.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to Solve a Problem Like Santa with Stackless and Twisted</H1>
    <B>shhgs</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20Solve%20a%20Problem%20Like%20Santa%20with%0A%20Stackless%20and%20Twisted&In-Reply-To=%3C20111213041530.GB11352%40laptop.huang.net%3E"
       TITLE="[Twisted-Python] How to Solve a Problem Like Santa with Stackless and Twisted">shhgs.efhilt at gmail.com
       </A><BR>
    <I>Mon Dec 12 21:15:30 MST 2011</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="057495.html">[Twisted-Python] How to Solve a Problem Like Santa with Stackless	and Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="057498.html">[Twisted-Python] How to Solve a Problem Like Santa with	Stackless and Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57496">[ date ]</a>
              <a href="thread.html#57496">[ thread ]</a>
              <a href="subject.html#57496">[ subject ]</a>
              <a href="author.html#57496">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>reindeers = dict( rudolf = defer.Deferred()
                , ....
                )
arrivedElvs = []
threeElvsArrived = defer.Deferred()

def onReindeerArrive(who):
    reindeer[who].callback(True)

def onElvArrive(elv):
    global arrivedElvs
    if len(arrivedElvs) &lt;= 1:
        arrivedElvs.append(elv)
    elif len(arrivedElvs) == 2:
        arrivedElvs.append(elv)
        threeElvsArrived.callback(arrivedElvs)
    else:
        pass

defer.DeferredList(reindeers.values()).addCallback(lambda _ : True).addCallback(playWithReindeers)
elvsArrived.addCallback(playWithElvs)

Above is my pseudo code.  It's not clear if Santa will respond to only to one
of these two events. If so, you may block the other when one get fired.  I
think Twisted's approach is pretty elegant.



On Sun, Dec 11, 2011 at 07:05:54PM -0800, Andrew Francis wrote:
&gt;<i> Hi Folks:
</I>&gt;<i>
</I>&gt;<i> I don't know what to file this under but here goes:
</I>&gt;<i>
</I>&gt;<i> Santa repeatedly sleeps until wakened by either all of his nine
</I>&gt;<i> reindeer, back from their holidays, or by a group of three of his ten
</I>&gt;<i> elves. If awakened by the reindeer, he harnesses each of them to his
</I>&gt;<i> sleigh, delivers toys with them and finally unharnesses them (allowing
</I>&gt;<i> them to go off on holiday). If awakened by a group of elves, he shows
</I>&gt;<i> each of the group into his study, consults with them on toy R&amp;D and
</I>&gt;<i> finally shows them each out (allowing them to go back to work). Santa
</I>&gt;<i> should give priority to the reindeer in the case that there is both a
</I>&gt;<i> group of elves and a group of reindeer waiting
</I>&gt;<i>
</I>&gt;<i> I recently modified the stackless.py library to support yet another new concurrency feature: join patterns. Well I think of my version as a sawed-off version of join patterns. Join patterns are a synchronization and message passing construct. The closest thing to a join pattern in Twisted is a deferred list. Stackless has nothing of the sort.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The Santa Claus Problem is a notorious problem in concurrency (<A HREF="http://www.youtube.com/watch?v=pqO6tKN2lc4">http://www.youtube.com/watch?v=pqO6tKN2lc4</A>). I have come up with a relatively short solution.  I think one would be hard pressed to come up with a shorter solution in Python. My desire was to compete with Simon Peyton Jones Haskell version in &quot;Beautiful Code.&quot; The full solution is here: <A HREF="http://andrewfr.wordpress.com/2011/11/30/the-santa-claus-problem-with-join-patterns.">http://andrewfr.wordpress.com/2011/11/30/the-santa-claus-problem-with-join-patterns.</A> The nucleus is: 
</I>&gt;<i> def santa(reindeer, elves):
</I>&gt;<i>     joinObject = stackless.join().addPattern([ch for _, ch, _ in reindeer]).\
</I>&gt;<i>                                   addPattern([ch for _, ch, _ in elves],3)
</I>&gt;<i>
</I>&gt;<i>     reindeerPattern, elfPattern = joinObject.patterns
</I>&gt;<i>
</I>&gt;<i>     while True:
</I>&gt;<i>         pattern = joinObject.join()
</I>&gt;<i>         if reindeerPattern.ready():
</I>&gt;<i>             print &quot;*** REINDEER GET PRIORITY ***&quot;
</I>&gt;<i>             reindeerPattern.join()
</I>&gt;<i>             pattern = reindeerPattern
</I>&gt;<i>         if pattern is reindeerPattern:
</I>&gt;<i>             harness(reindeerPattern)
</I>&gt;<i>             deliveryToys(reindeerPattern)
</I>&gt;<i>             unharness(reindeerPattern)
</I>&gt;<i>         elif pattern is elfPattern:
</I>&gt;<i>             consultWithSanta(elfPattern)
</I>&gt;<i>
</I>&gt;<i>     stopTwisted()
</I>&gt;<i>
</I>&gt;<i> In this solution I use Twisted to control the timer (I use the blockOn technique that Christopher Armstrong first used).
</I>&gt;<i>
</I>&gt;<i> def tick(seconds):
</I>&gt;<i>     tickCh = stackless.channel()
</I>&gt;<i>     reactor.callLater(seconds, tickCh.send, None)
</I>&gt;<i>     tickCh.receive()
</I>&gt;<i>
</I>&gt;<i> However I could just as easily make reindeer and elves web services or RestFull interfaces. I am still working on the  Join Pattern API. Also it has also been a goal of mine to write a stacklessreactor to better integrate Stackless with the Twisted Reactor.
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Andrew
</I>
&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="057495.html">[Twisted-Python] How to Solve a Problem Like Santa with Stackless	and Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="057498.html">[Twisted-Python] How to Solve a Problem Like Santa with	Stackless and Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57496">[ date ]</a>
              <a href="thread.html#57496">[ thread ]</a>
              <a href="subject.html#57496">[ subject ]</a>
              <a href="author.html#57496">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
