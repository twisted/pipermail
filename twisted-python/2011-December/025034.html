<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] deferred generators in inline callbacks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20deferred%20generators%20in%20inline%20callbacks&In-Reply-To=CADGOwRSUR_BKcmGmDUh%2BvFZZOa26oSN48ars-3UrPeo6rf4Frw%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025033.html">
   <LINK REL="Next"  HREF="025035.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] deferred generators in inline callbacks</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20deferred%20generators%20in%20inline%20callbacks&In-Reply-To=CADGOwRSUR_BKcmGmDUh%2BvFZZOa26oSN48ars-3UrPeo6rf4Frw%40mail.gmail.com"
       TITLE="[Twisted-Python] deferred generators in inline callbacks">exarkun at twistedmatrix.com
       </A><BR>
    <I>Tue Dec 20 14:14:10 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="025033.html">[Twisted-Python] deferred generators in inline callbacks
</A></li>
        <LI>Next message: <A HREF="025035.html">[Twisted-Python] [Twisted] #5437: sys.settrace(None) in	process.py raises RuntimeError in debugger
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25034">[ date ]</a>
              <a href="thread.html#25034">[ thread ]</a>
              <a href="subject.html#25034">[ subject ]</a>
              <a href="author.html#25034">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06:24 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alex.kirp at gmail.com</A> wrote:
&gt;<i>Hi.
</I>&gt;<i>
</I>&gt;<i>I have a question about inline callbacks usage.
</I>&gt;<i>
</I>&gt;<i>Let's assume I have an iterator that works synchronously. I want to
</I>&gt;<i>wrap this generator to work asynchronously in threads:
</I>&gt;<i>
</I>&gt;<i>def some_generator():
</I>&gt;<i>    cursor = make_iterator() # cursor's 'next' method uses some nasty
</I>&gt;<i>blocking I/O
</I>&gt;<i>    while 1:
</I>&gt;<i>        yield deferToThread(cursor.next)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Next, I want to asynchronously iterate over this generator in
</I>&gt;<i>inlineCallbacks semantics. I should say:
</I>&gt;<i>
</I>&gt;<i>@inlineCallbacks
</I>&gt;<i>def do_stuff():
</I>&gt;<i>    for item in some_generator():
</I>&gt;<i>        try:
</I>&gt;<i>            real_item = yield item
</I>&gt;<i>            # do stuff with real_item
</I>&gt;<i>        except StopIteration:
</I>&gt;<i>            break
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>It somewhat annoys me that I should always convert item to real_item
</I>&gt;<i>so inlineCallbacks can properly asynchronize my code. I also need to
</I>&gt;<i>implement StopIteration myself :(
</I>&gt;<i>Is there any easier way to do this in Twisted?
</I>
You're basically looking for coroutines - ie, context switching across 
multiple stack frames (from inside some_generator through do_stuff out 
to the implementation of inlineCallbacks).

There are several coroutine libraries for Python.  Greenlets is probably 
the most popular.  You can use it with Twisted, if you want.

Personally, I'd probably go for something more like:

    def worker(item):
        # do stuff with item

    hook_up(some_generator(), worker)

with some kind of hook_up that does the parts of this task that you're 
tired of repeating over and over again (like turning item into 
real_item).

The result doesn't require figuring out how your coroutines are 
affecting control flow and probably gives you something more composable 
too.

Jean-Paul

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025033.html">[Twisted-Python] deferred generators in inline callbacks
</A></li>
	<LI>Next message: <A HREF="025035.html">[Twisted-Python] [Twisted] #5437: sys.settrace(None) in	process.py raises RuntimeError in debugger
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25034">[ date ]</a>
              <a href="thread.html#25034">[ thread ]</a>
              <a href="subject.html#25034">[ subject ]</a>
              <a href="author.html#25034">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
