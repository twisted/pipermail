<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to Solve a Problem Like Santa with	Stackless and Twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20Solve%20a%20Problem%20Like%20Santa%20with%0A%09Stackless%20and%20Twisted&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025019.html">
   <LINK REL="Next"  HREF="025023.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to Solve a Problem Like Santa with	Stackless and Twisted</H1>
    <B>Andrew Francis</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20Solve%20a%20Problem%20Like%20Santa%20with%0A%09Stackless%20and%20Twisted&In-Reply-To="
       TITLE="[Twisted-Python] How to Solve a Problem Like Santa with	Stackless and Twisted">andrewfr_ice at yahoo.com
       </A><BR>
    <I>Tue Dec 13 14:04:09 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="025019.html">[Twisted-Python] How to Solve a Problem Like Santa with Stackless and Twisted
</A></li>
        <LI>Next message: <A HREF="025023.html">[Twisted-Python] How to Solve a Problem Like Santa with	Stackless and Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25021">[ date ]</a>
              <a href="thread.html#25021">[ thread ]</a>
              <a href="subject.html#25021">[ subject ]</a>
              <a href="author.html#25021">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

From: shhgs &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">shhgs.efhilt at gmail.com</A>&gt;
To: Andrew Francis &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrewfr_ice at yahoo.com</A>&gt;; Twisted general discussion &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt; 
Sent: Monday, December 12, 2011 11:15 PM
Subject: Re: [Twisted-Python] How to Solve a Problem Like Santa with Stackless and Twisted

Hi Shhgs:

&gt;<i>defer.DeferredList(reindeers.values()).addCallback(lambda _ : True).addCallback(playWithReindeers)
</I>&gt;<i>elvsArrived.addCallback(playWithElvs)
</I>
&gt;<i>Above is my pseudo code.&#160; It's not clear if Santa will respond to only to one
</I>&gt;<i>of these two events. If so, you may block the other when one get fired.&#160; I
</I>&gt;<i>think Twisted's approach is pretty elegant.
</I>

Cool!

Okay, I understand your approach: you count the elves and then the right number arrive, you wake Santa.

Twisted does have one important ingredient for solving Santa Claus: a join mechanism in the form of a deferred list. Also the non-preemptive nature of the reactor guards against a lot of the problems in another solution. In this regard, I think a Twisted solution may be more efficient than most Python mechanisms out there.

The main problem I see with a pure Twisted solution is that it really can't impose the priority rule. Perhaps the&#160; way the reactor works makes priority somewhat moot.&#160; Let's assume we could put timestamps on elves and reindeer arrival times (or force reindeer and elves to arrival at specific times).

Now at time T, there are eight reindeer and two elves ready. At T+1, an additional&#160; reindeer and elf are ready (their timestamps are the same, timer resolution notwithstanding). However the Twisted reactor will serialise the events and trigger the callback. For argument, let us pretend the elvesArrive callback is activated and that wakes Santa. Santa consults with the elves. The problem is that all nine reindeer were ready and the priority rule is broken. I am not sure, from inside the callback, one could check to see if nine reindeer were indeed ready.

Also I suspect once you actually coded out the solution, the ancillary things (looping, callLater) would make the code more difficult to read. However that is minor compared to aforementioned problem. 

Cheers,
Andrew


________________________________
From: shhgs &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">shhgs.efhilt at gmail.com</A>&gt;
To: Andrew Francis &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrewfr_ice at yahoo.com</A>&gt;; Twisted general discussion &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt; 
Sent: Monday, December 12, 2011 11:15 PM
Subject: Re: [Twisted-Python] How to Solve a Problem Like Santa with Stackless and Twisted

reindeers = dict( rudolf = defer.Deferred()
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; , ....
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; )
arrivedElvs = []
threeElvsArrived = defer.Deferred()

def onReindeerArrive(who):
&#160; &#160; reindeer[who].callback(True)

def onElvArrive(elv):
&#160; &#160; global arrivedElvs
&#160; &#160; if len(arrivedElvs) &lt;= 1:
&#160; &#160; &#160; &#160; arrivedElvs.append(elv)
&#160; &#160; elif len(arrivedElvs) == 2:
&#160; &#160; &#160; &#160; arrivedElvs.append(elv)
&#160; &#160; &#160; &#160; threeElvsArrived.callback(arrivedElvs)
&#160; &#160; else:
&#160; &#160; &#160; &#160; pass

defer.DeferredList(reindeers.values()).addCallback(lambda _ : True).addCallback(playWithReindeers)
elvsArrived.addCallback(playWithElvs)

Above is my pseudo code.&#160; It's not clear if Santa will respond to only to one
of these two events. If
so, you may block the other when one get fired.&#160; I
think Twisted's approach is pretty elegant.



On Sun, Dec 11, 2011 at 07:05:54PM -0800, Andrew Francis wrote:
&gt;<i> Hi Folks:
</I>&gt;<i>
</I>&gt;<i> I don't know what to file this under but here goes:
</I>&gt;<i>
</I>&gt;<i> Santa repeatedly sleeps until wakened by either all of his nine
</I>&gt;<i> reindeer, back from their holidays, or by a group of three of his ten
</I>&gt;<i> elves. If awakened by the reindeer, he harnesses each of them to his
</I>&gt;<i> sleigh, delivers toys with them and finally unharnesses them (allowing
</I>&gt;<i> them to go off on holiday). If awakened by a group of elves, he shows
</I>&gt;<i> each of the group into his study, consults with them on toy R&amp;D and
</I>&gt;<i> finally shows them each out (allowing them to go back to work). Santa
</I>&gt;<i> should give priority to the reindeer in the case that there is both a
</I>&gt;<i> group of elves and a group of reindeer waiting
</I>&gt;<i>
</I>&gt;<i>
</I>I recently modified the stackless.py library to support yet another new concurrency feature: join patterns. Well I think of my version as a sawed-off version of join patterns. Join patterns are a synchronization and message passing construct. The closest thing to a join pattern in Twisted is a deferred list. Stackless has nothing of the sort.
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The Santa Claus Problem is a notorious problem in concurrency (<A HREF="http://www.youtube.com/watch?v=pqO6tKN2lc4">http://www.youtube.com/watch?v=pqO6tKN2lc4</A>). I have come up with a relatively short solution.&#160; I think one would be hard pressed to come up with a shorter solution in Python. My desire was to compete with Simon Peyton Jones Haskell version in &quot;Beautiful Code.&quot; The full solution is here: <A HREF="http://andrewfr.wordpress.com/2011/11/30/the-santa-claus-problem-with-join-patterns.">http://andrewfr.wordpress.com/2011/11/30/the-santa-claus-problem-with-join-patterns.</A> The nucleus is:&#160;
</I>&gt;<i> def santa(reindeer, elves):
</I>&gt;<i> &#160;&#160;&#160; joinObject =
</I>stackless.join().addPattern([ch for _, ch, _ in reindeer]).\
&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; addPattern([ch for _, ch, _ in elves],3)
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; reindeerPattern, elfPattern = joinObject.patterns
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; while True:
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; pattern = joinObject.join()
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; if reindeerPattern.ready():
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; print &quot;*** REINDEER GET PRIORITY ***&quot;
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; reindeerPattern.join()
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; pattern = reindeerPattern
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; if
</I>pattern is reindeerPattern:
&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; harness(reindeerPattern)
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; deliveryToys(reindeerPattern)
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; unharness(reindeerPattern)
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; elif pattern is elfPattern:
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; consultWithSanta(elfPattern)
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; stopTwisted()
</I>&gt;<i>
</I>&gt;<i> In this solution I use Twisted to control the timer (I use the blockOn technique that Christopher Armstrong first used).
</I>&gt;<i>
</I>&gt;<i> def tick(seconds):
</I>&gt;<i> &#160;&#160;&#160; tickCh = stackless.channel()
</I>&gt;<i> &#160;&#160;&#160; reactor.callLater(seconds, tickCh.send, None)
</I>&gt;<i> &#160;&#160;&#160; tickCh.receive()
</I>&gt;<i>
</I>&gt;<i> However I could just as easily make
</I>reindeer and elves web services or RestFull interfaces. I am still working on the&#160; Join Pattern API. Also it has also been a goal of mine to write a stacklessreactor to better integrate Stackless with the Twisted Reactor.
&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Andrew
</I>
&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025019.html">[Twisted-Python] How to Solve a Problem Like Santa with Stackless and Twisted
</A></li>
	<LI>Next message: <A HREF="025023.html">[Twisted-Python] How to Solve a Problem Like Santa with	Stackless and Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25021">[ date ]</a>
              <a href="thread.html#25021">[ thread ]</a>
              <a href="subject.html#25021">[ subject ]</a>
              <a href="author.html#25021">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
