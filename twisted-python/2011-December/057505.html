<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] MemoryError	in	twisted.internet.abstract.FileDescriptor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20MemoryError%0A%09in%09twisted.internet.abstract.FileDescriptor&In-Reply-To=%3C20111214235256.1828.887704569.divmod.xquotient.280%40localhost.localdomain%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="057507.html">
   <LINK REL="Next"  HREF="057489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] MemoryError	in	twisted.internet.abstract.FileDescriptor</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20MemoryError%0A%09in%09twisted.internet.abstract.FileDescriptor&In-Reply-To=%3C20111214235256.1828.887704569.divmod.xquotient.280%40localhost.localdomain%3E"
       TITLE="[Twisted-Python] MemoryError	in	twisted.internet.abstract.FileDescriptor">exarkun at twistedmatrix.com
       </A><BR>
    <I>Wed Dec 14 16:52:56 MST 2011</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="057507.html">[Twisted-Python] MemoryError in	twisted.internet.abstract.FileDescriptor
</A></li>
        <LI>Next message (by thread): <A HREF="057489.html">[Twisted-Python] Twisted-Python Digest, Vol 93, Issue 12
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57505">[ date ]</a>
              <a href="thread.html#57505">[ thread ]</a>
              <a href="subject.html#57505">[ subject ]</a>
              <a href="author.html#57505">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08:34 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">augustocaringi at gmail.com</A> wrote:
&gt;<i>On Sun, Dec 11, 2011 at 5:11 PM,  &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;<i>On 10 Dec, 05:25 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">augustocaringi at gmail.com</A> wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>On Fri, Dec 9, 2011 at 7:31 PM, Itamar Turner-Trauring
</I>&gt;&gt;&gt;<i>&lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>&#160; &#160; What's the best solution? Apply the patch attached on this 
</I>&gt;&gt;&gt;&gt;&gt;<i>ticket,
</I>&gt;&gt;&gt;&gt;&gt;<i>moving to a producer/consumer approach, or any other idea?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>The patch will just delay the problem... you're creating a huge 
</I>&gt;&gt;&gt;&gt;<i>number of
</I>&gt;&gt;&gt;&gt;<i>strings, faster than the transport can write them out. The solution 
</I>&gt;&gt;&gt;&gt;<i>is
</I>&gt;&gt;&gt;&gt;<i>indeed to use the consumer API to pause creation of more data until 
</I>&gt;&gt;&gt;&gt;<i>the
</I>&gt;&gt;&gt;&gt;<i>transport clears its buffers.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Right, I will try with the consumer API.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>But I have one last question:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>In my previous example, the memory usage grows until a MemoryError
</I>&gt;&gt;&gt;<i>exception.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>But other scenario is when my &quot;event send loop&quot; iterates a high 
</I>&gt;&gt;&gt;<i>number
</I>&gt;&gt;&gt;<i>of times (but not enough to raise a exception) and then stops.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>I expected that when the loop ends, all the strings would be flushed
</I>&gt;&gt;&gt;<i>and as a consequence, the memory usage of the process would return to
</I>&gt;&gt;&gt;<i>a normal level. But this does not happen... It's normal?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Data may or may not be put onto the network as you are directing a 
</I>&gt;&gt;<i>transport
</I>&gt;&gt;<i>to write it. &#160;It's up to the particular transport implementation to 
</I>&gt;&gt;<i>decide
</I>&gt;&gt;<i>on buffering logic, including logic about whether data is sent 
</I>&gt;&gt;<i>immediately
</I>&gt;&gt;<i>when a write() call is, or only later after control returns to the 
</I>&gt;&gt;<i>event
</I>&gt;&gt;<i>loop.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>As of Twisted 11.1, the posix-based reactor implementations all buffer 
</I>&gt;&gt;<i>data
</I>&gt;&gt;<i>until control is returned to the event loop. &#160;This has been the case 
</I>&gt;&gt;<i>for
</I>&gt;&gt;<i>some time, but not _all_ time, and it may change in the future.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Jean-Paul
</I>&gt;<i>
</I>&gt;<i>Hi!
</I>&gt;<i>
</I>&gt;<i>I understand...
</I>&gt;<i>
</I>&gt;<i>But I'm not convinced.
</I>&gt;<i>
</I>&gt;<i>I found this post on Stackoverflow:
</I>&gt;<i><A HREF="http://stackoverflow.com/questions/4078084/memory-leak-in-python-">http://stackoverflow.com/questions/4078084/memory-leak-in-python-</A> 
</I>&gt;<i>twisted-where-is-it
</I>&gt;<i>
</I>&gt;<i>The problem that I am facing is the same.
</I>&gt;<i>
</I>&gt;<i>Under heavy load my Twisted based server &quot;leaks memory&quot;. Under normal
</I>&gt;<i>load its all ok.
</I>&gt;<i>
</I>&gt;<i>Explaining better: Under heavy load the memory usage grows, but when
</I>&gt;<i>the load returns to a normal level, the memory usage remains high.
</I>
This is basically typical.  I won't guarantee that your program isn't 
*leaking* memory, but it sounds like you're just observing the &quot;high 
water mark&quot; behavior of the CPython runtime (and to a lesser extend of 
glibc).  Allocate memory is frequently not released to the platform when 
it is no longer in use, because fragmentation has happened that makes 
this impractical.

Can you clarify if this is what you're seeing, or if you do see memory 
usage continue to rise without bound (under a bounded load)?

Jean-Paul
&gt;<i>I forgot to say in the previous emails, but the communication is done 
</I>&gt;<i>over SSL.
</I>&gt;<i>
</I>&gt;<i>I'm not a Python specialist, I am a C engineer... But I'm trying to
</I>&gt;<i>find out where is the problem with tools like Heapy, meliae, etc.
</I>&gt;<i>
</I>&gt;<i>Meliae gave me this report:
</I>&gt;<i>
</I>&gt;<i>Total 62008 objects, 126 types, Total size = 86.2MiB (90437121 bytes)
</I>&gt;<i>Index   Count   %      Size   % Cum     Max Kind
</I>&gt;<i>     0   39061  62  87827505  97  9753120905 str
</I>&gt;<i>     1    1682   2    896912   0  98  393352 dict
</I>&gt;<i>     2   10067  16    382028   0  98     224 tuple
</I>&gt;<i>     3     164   0    246656   0  98    6304 module
</I>&gt;<i>     4     422   0    183992   0  99     436 type
</I>&gt;<i>     5    2504   4    170272   0  99      68 code
</I>&gt;<i>
</I>&gt;<i>As expected... The problem are the strings that are never freed.
</I>&gt;<i>
</I>&gt;<i>So I tried to tracking this strings, and this let me to this:
</I>&gt;&gt;&gt;&gt;<i>om[3082188716]
</I>&gt;<i>TLSConnection(3082188716 548B 35refs 38par)
</I>&gt;&gt;&gt;&gt;<i>om[3082188716].c
</I>&gt;<i>[str(3082713312 39B 8par '_tempDataBuffer'), list(3082225612 112704B
</I>&gt;<i>26680refs 1par), str(3086791008 30B 54par 'fileno'),
</I>&gt;<i>instancemethod(3084243748 36B 3refs 1par), str(3084439680 32B 58par
</I>&gt;<i>'protocol'), Provider(3082216172 552B 23refs 4par), str(3084439648 31B
</I>&gt;<i>100par 'reactor'), SelectReactor(3082464620 548B 43refs 21par),
</I>&gt;<i>str(3082712592 37B 6par '_userWantRead'), bool(40623276 12B 94par
</I>&gt;<i>'True'), str(3082713272 34B 8par 'dataBuffer'), str(2917687304
</I>&gt;<i>53120905B 1par 'ype: Test\nDate: 2011-12-14
</I>&gt;<i>16:45:30.995217\nEvent-Subtype: FooBar\nContent-Type:
</I>&gt;<i>application/json\n\n{\n '), str(3082831376 36B 6par '_tempDataLen'),
</I>&gt;<i>int(165862528 12B 1par 33109881), str(3082714752 35B 6par
</I>&gt;<i>'realAddress'), tuple(3082165324 32B 2refs 1par), str(3084479288 33B
</I>&gt;<i>29par 'connector'), Connector(3082188684 552B 21refs 1par),
</I>&gt;<i>str(3082724352 30B 9par 'logstr'), str(3082181232 39B 1par
</I>&gt;<i>'Provider,client'), str(3082723680 27B 5par 'TLS'), int(164303008 12B
</I>&gt;<i>100par 1), str(3084439744 30B 80par 'socket'), Connection(3082208356
</I>&gt;<i>40B 3refs 1par), str(3084506080 33B 33par 'connected'), int(164303008
</I>&gt;<i>12B 100par 1), str(3087080928 30B 10par 'offset'), int(167915152 12B
</I>&gt;<i>1par 11436032), str(3082712632 38B 6par '_userWantWrite'),
</I>&gt;<i>bool(40623276 12B 94par 'True'), str(3082685960 34B 8par
</I>&gt;<i>'ctxFactory'), ClientContextFactory(3082188652 168B 1refs 2par),
</I>&gt;<i>str(3086955200 28B 38par 'addr'), tuple(3082649516 32B 2refs 1par),
</I>&gt;<i>&lt;ex-reference&gt;(0 0B)]
</I>&gt;<i>
</I>&gt;<i>Thanks and sorry for the insistence.
</I>&gt;<i>
</I>&gt;<i>--
</I>&gt;<i>Augusto Mecking Caringi
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Twisted-Python mailing list
</I>&gt;<i><A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="057507.html">[Twisted-Python] MemoryError in	twisted.internet.abstract.FileDescriptor
</A></li>
	<LI>Next message (by thread): <A HREF="057489.html">[Twisted-Python] Twisted-Python Digest, Vol 93, Issue 12
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57505">[ date ]</a>
              <a href="thread.html#57505">[ thread ]</a>
              <a href="subject.html#57505">[ subject ]</a>
              <a href="author.html#57505">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
