<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Telnet negotiation with Twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Telnet%20negotiation%20with%20Twisted&In-Reply-To=%3CCAEw2jfxPtp-Yaigovkru%2BXwaNePzU-kTf3AwKcOSo9bHqTAuEw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="057470.html">
   <LINK REL="Next"  HREF="057472.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Telnet negotiation with Twisted</H1>
    <B>Patrick Mylund Nielsen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Telnet%20negotiation%20with%20Twisted&In-Reply-To=%3CCAEw2jfxPtp-Yaigovkru%2BXwaNePzU-kTf3AwKcOSo9bHqTAuEw%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Telnet negotiation with Twisted">twisted at patrickmylund.com
       </A><BR>
    <I>Sat Dec  3 07:22:19 MST 2011</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="057470.html">[Twisted-Python] Telnet negotiation with Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="057472.html">[Twisted-Python] Telnet negotiation with Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57471">[ date ]</a>
              <a href="thread.html#57471">[ thread ]</a>
              <a href="subject.html#57471">[ subject ]</a>
              <a href="author.html#57471">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Lee,

Here is a complete example that works with Twisted 11.0. LINEMODE
itself is enabled at connect, but it has different modes that
determine what is sent when by the client. (See section 2.2 of
<A HREF="http://www.faqs.org/rfcs/rfc1184.html">http://www.faqs.org/rfcs/rfc1184.html</A>)

#####

#!/usr/bin/env python
from twisted.internet.protocol import Factory
from twisted.conch.telnet import TelnetProtocol,
StatefulTelnetProtocol, TelnetTransport
from twisted.conch.telnet import DO, DONT, WILL, WONT

LINEMODE = chr(34)
LINEMODE_EDIT = chr(1) + chr(1)
LINEMODE_TRAPSIG = chr(1) + chr(2)
LINEMODE_MODEACK = chr(1) + chr(4)
LINEMODE_SOFTTAB = chr(1) + chr(8)
LINEMODE_LITECHO = chr(1) + chr(16)

class LineModeProtocol(TelnetProtocol):

    def connectionMade(self):
        print(&quot;Connection made!&quot;)

    def connectionLost(self, reason):
        print(&quot;Connection lost!&quot;)

    def dataReceived(self, data):
        if self.transport.lines:
            line = data.rstrip()
            print(&quot;data received (normal): &quot; + line)
            if line == &quot;gounbuffered&quot;:
                self.transport.requestNegotiation(LINEMODE,
LINEMODE_TRAPSIG) # Only trap signals locally
                self.transport.lines = False
        else:
            # manually buffer data here
            print(&quot;data received (linemode): &quot; + data)
            if data == &quot;n&quot;:
                self.transport.requestNegotiation(LINEMODE,
LINEMODE_EDIT) # Change to edit mode
                self.transport.lines = True

class LineModeTransport(TelnetTransport):

    def connectionMade(self):
        self.lines = True
        self.do(LINEMODE) # Ask client to begin sub-negotation of linemode
        TelnetTransport.connectionMade(self)

    def commandReceived(self, command, argument):
        if argument == LINEMODE:
            if command == WILL: # Client said OK to our DO; let's... do it
                self.requestNegotiation(LINEMODE, LINEMODE_EDIT) # The
normal (buffered) mode
        else:
            TelnetTransport.commandReceived(self, command, argument)

class LineModeFactory(Factory):

    def buildProtocol(self, addr):
        return LineModeTransport(LineModeProtocol)

if __name__ == '__main__':
    from twisted.internet import reactor

    port = 2222
    factory = LineModeFactory()

    reactor.listenTCP(port, factory)
    reactor.run()

#####

There is probably an easier way to check the state of LINEMODE, e.g.
with getOptionState, but it works.

Example:

Client:
# telnet localhost 2222
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
How are you?
gounbuffered
testnback again

Server:
# ./linemode.py
Connection made!
data received (normal): How are you?
data received (normal): gounbuffered
data received (linemode): t
data received (linemode): e
data received (linemode): s
data received (linemode): t
data received (linemode): n
data received (normal): back again

Best,
Patrick

On Sat, Dec 3, 2011 at 14:59,  &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
&gt;<i> On 03:53 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">lmorsino at gmail.com</A> wrote:
</I>&gt;&gt;<i>Jean-Paul,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Thanks for your response. I still can't get self.will(LINEMODE) to work
</I>&gt;&gt;<i>but
</I>&gt;&gt;<i>I did get self.telnet_WILL(LINEMODE) to run without throwing an Error.
</I>&gt;&gt;<i>Can
</I>&gt;&gt;<i>you elaborate on what needs to happen in the enableRemote? My
</I>&gt;&gt;<i>impression
</I>&gt;&gt;<i>was that once I send the negotiation WILL command from server to the
</I>&gt;&gt;<i>client, the client will respond with either a DO or a DONT. What
</I>&gt;&gt;<i>further
</I>&gt;&gt;<i>logic is necessary?
</I>&gt;<i>
</I>&gt;<i> I can't say what further logic is necessary, because I don't know what
</I>&gt;<i> logic you have now. Â The description of your code you gave above is a
</I>&gt;<i> good introduction to an actual code listing (&lt;<A HREF="http://sscce.org/">http://sscce.org/</A>&gt;), but
</I>&gt;<i> it's not sufficient on its own.
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="057470.html">[Twisted-Python] Telnet negotiation with Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="057472.html">[Twisted-Python] Telnet negotiation with Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57471">[ date ]</a>
              <a href="thread.html#57471">[ thread ]</a>
              <a href="subject.html#57471">[ subject ]</a>
              <a href="author.html#57471">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
