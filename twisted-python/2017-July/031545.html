<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Failure of twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc under pypy2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Failure%20of%0A%20twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc%0A%20under%20pypy2&In-Reply-To=%3CCADzPF4uwRSHgikBmvmSPmfjrHz%3DFCxfrHaYE_5hndrwD7xWp_Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031544.html">
   <LINK REL="Next"  HREF="031546.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Failure of twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc under pypy2</H1>
    <B>Daniel Sutcliffe</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Failure%20of%0A%20twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc%0A%20under%20pypy2&In-Reply-To=%3CCADzPF4uwRSHgikBmvmSPmfjrHz%3DFCxfrHaYE_5hndrwD7xWp_Q%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Failure of twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc under pypy2">dansut at gmail.com
       </A><BR>
    <I>Thu Jul 13 17:22:10 MDT 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031544.html">[Twisted-Python] Failure of twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc under pypy2
</A></li>
        <LI>Next message (by thread): <A HREF="031546.html">[Twisted-Python] Failure of twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc under pypy2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31545">[ date ]</a>
              <a href="thread.html#31545">[ thread ]</a>
              <a href="subject.html#31545">[ subject ]</a>
              <a href="author.html#31545">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On Thu, Jul 13, 2017 at 5:57 AM, Daniel Sutcliffe &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> I shall do my best as my intention is to use Twisted in a live
</I>&gt;&gt;<i> environment with PyPy so it would be great if the project viewed these
</I>&gt;&gt;<i> builds as required to be clean sometime in the future. This was just
</I>&gt;&gt;<i> the first ERROR I attacked, it was always my intention to look into
</I>&gt;&gt;<i> the others too, which I am also seeing.
</I>
On Thu, Jul 13, 2017 at 11:31 AM, Craig Rodrigues
&lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">rodrigc at crodrigues.org</A>&gt; wrote:
&gt;<i> Thanks for your motivation.
</I>
No problem, this is one of the few ways I can give back to the Twisted
project that is ultimately helping me achieve my goals;
besides getting to the bottom of these type of things is a fun
learning exercise for me :)

&gt;<i> Please keep going, and share your findings on the mailing list.
</I>&gt;<i>
</I>&gt;<i> Last year, Mark Williams worked on fixing many Twisted unit tests to either
</I>&gt;<i> pass or skip on Pypy, and even found one issue with Pypy itself (
</I>&gt;<i> <A HREF="https://bitbucket.org/pypy/pypy/issues/2335/maximum-recursion-depth-exceeded-with">https://bitbucket.org/pypy/pypy/issues/2335/maximum-recursion-depth-exceeded-with</A>
</I>&gt;<i> ).
</I>
This one is likely to fall on deaf ears in the PyPy project...
The reason for the ERROR and then FAIL is as I originally thought,
that __import__() under pypy is not loading .pyc files where the .py
is missing and:
  <A HREF="http://doc.pypy.org/en/latest/config/objspace.lonepycfiles.html">http://doc.pypy.org/en/latest/config/objspace.lonepycfiles.html</A>
tl;dr - they view it as dangerous due to pyc binary variations and
only allow by build time configuration option.

So the next question I guess is how to deal with this:

- presumably my first step is to log a bug in Trac as any change will
require one, I had only held off from doing this until I was more sure
of the cause of the issue.

- the FAIL goes away if the .py is not removed from the plugins dir
and it seems to me that the .py removal is not actually required to
strictly test what
twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc
purports to be testing - so that could fix this test

- the fact that the test ERRORs and then carries on and FAILs later in
a strange fashion is due to the fact twisted.plugin.getCache() simply
does a log.err() on encountering the odd situation - so maybe this
could be dealt with better knowing that PyPy does different things
than CPython here... ?

Could the more experienced please advise :)

&gt;<i> If you feel there are improvements or additions to the buildbot jobs using
</I>&gt;<i> Pypy, please share your thoughts.  The buildbot master.cfg file is at
</I>&gt;<i> <A HREF="https://github.com/twisted-infra/braid/tree/master/services/buildbot/master">https://github.com/twisted-infra/braid/tree/master/services/buildbot/master</A>
</I>
I have not looked into why buildbot comes up with a different error to
the one I did on various platforms - fix for my situation and see if
it fixes the pypy buildbot before investigating?

The other error that I and the buildbot see on pypy is 12x (always) of
  Failure: twisted.internet.defer.TimeoutError
for
  twisted.protocols.test.test_tls.TLSMemoryBIOTests.test_hugeWrite_TLSv1_1
which is odd as if I run this test on its own it succeeds every time...
Thoughts on this appreciated but probably should start a new thread for that...

Cheers
/dan
-- 
Daniel Sutcliffe &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt;

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031544.html">[Twisted-Python] Failure of twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc under pypy2
</A></li>
	<LI>Next message (by thread): <A HREF="031546.html">[Twisted-Python] Failure of twisted.test.test_plugin.DeveloperSetupTests.test_freshPyReplacesStalePyc under pypy2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31545">[ date ]</a>
              <a href="thread.html#31545">[ thread ]</a>
              <a href="subject.html#31545">[ subject ]</a>
              <a href="author.html#31545">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
