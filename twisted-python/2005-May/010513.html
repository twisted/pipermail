<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] cleanup in twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20cleanup%20in%20twisted&In-Reply-To=20050523121249.57909.qmail%40web53110.mail.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010512.html">
   <LINK REL="Next"  HREF="010518.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] cleanup in twisted</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20cleanup%20in%20twisted&In-Reply-To=20050523121249.57909.qmail%40web53110.mail.yahoo.com"
       TITLE="[Twisted-Python] cleanup in twisted">exarkun at divmod.com
       </A><BR>
    <I>Mon May 23 09:17:36 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010512.html">[Twisted-Python] cleanup in twisted
</A></li>
        <LI>Next message: <A HREF="010518.html">[Twisted-Python] twisted.plugin plugin framework
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10513">[ date ]</a>
              <a href="thread.html#10513">[ thread ]</a>
              <a href="subject.html#10513">[ subject ]</a>
              <a href="author.html#10513">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 23 May 2005 05:12:49 -0700 (PDT), Joachim Boomberschloss &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">boomberschloss at yahoo.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i>--- Jp Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt; wrote:
</I>&gt;&gt;<i> On Mon, 23 May 2005 02:40:53 -0700 (PDT), Joachim
</I>&gt;&gt;<i> Boomberschloss &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">boomberschloss at yahoo.com</A>&gt; wrote:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;--- Bob Ippolito &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bob at redivi.com</A>&gt; wrote:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; On May 22, 2005, at 8:46 AM, Joachim
</I>&gt;&gt;<i> Boomberschloss
</I>&gt;&gt;<i> &gt;&gt; wrote:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; I just jotted down a little mechanism for
</I>&gt;&gt;<i> &gt;&gt; cleaning-up
</I>&gt;&gt;<i> &gt;&gt; &gt; in Twisted, and I wanted to see if:
</I>&gt;&gt;<i> &gt;&gt; &gt; 1. other people think it's needed
</I>&gt;&gt;<i> &gt;&gt; &gt; 2. other people manage to use it
</I>&gt;&gt;<i> &gt;&gt; &gt;
</I>&gt;&gt;<i> &gt;&gt; &gt; What this does is enable one to define a
</I>&gt;&gt;<i> &gt;&gt; __cleanup__
</I>&gt;&gt;<i> &gt;&gt; &gt; method which gets call either when the instance
</I>&gt;&gt;<i> is
</I>&gt;&gt;<i> &gt;&gt; &gt; deleted, or when the reactor shuts down. It can
</I>&gt;&gt;<i> &gt;&gt; return
</I>&gt;&gt;<i> &gt;&gt; &gt; a dereffed that delays the shutdown. The
</I>&gt;&gt;<i> benefit
</I>&gt;&gt;<i> &gt;&gt; is
</I>&gt;&gt;<i> &gt;&gt; &gt; being able to define communication-related
</I>&gt;&gt;<i> stuff
</I>&gt;&gt;<i> &gt;&gt; in
</I>&gt;&gt;<i> &gt;&gt; &gt; the cleanup method, which is not so useful to
</I>&gt;&gt;<i> do
</I>&gt;&gt;<i> &gt;&gt; in
</I>&gt;&gt;<i> &gt;&gt; &gt; __del__.
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;&gt; This is just begging for object leaks, because
</I>&gt;&gt;<i> &gt;&gt; __del__ disables
</I>&gt;&gt;<i> &gt;&gt; aspects of cyclic GC.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;Hmmpf. What does this mean, and is there a simple
</I>&gt;&gt;<i> way
</I>&gt;&gt;<i> &gt;of resolving it?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   If you construct a reference cycle which contains
</I>&gt;&gt;<i> an object which has a __del__ method, the entire
</I>&gt;&gt;<i> cycle becomes &quot;garbage&quot; - Python cannot free any of
</I>&gt;&gt;<i> the objects or call any of their __del__ methods.
</I>&gt;&gt;<i> Instead, it puts them into the gc module's `garbage'
</I>&gt;&gt;<i> list and leaves them there forever.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   There's no simple way to resolve this (except to
</I>&gt;&gt;<i> not implement __del__, of course ;).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   A non-simple way to resolve it is to use weakref
</I>&gt;&gt;<i> callbacks instead of __del__.  Weakref callbacks
</I>&gt;&gt;<i> have some nasty bugs in versions of Python older
</I>&gt;&gt;<i> than 2.3.5 (more, the further back you go), and
</I>&gt;&gt;<i> they're trickier to use than __del__.  They don't
</I>&gt;&gt;<i> create garbage cycles, though.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Can you point me to an example of this (preferably in
</I>&gt;<i>Twisted)? Is this whole cleanup thing worth my time
</I>&gt;<i>fixing it in your opinion?
</I>&gt;<i>
</I>
Twisted doesn't make use of it, due to the instabilities in previous Python versions (which Twisted still supports).

Another technique I didn't mention is to move the __del__ implementation off of the object which might participate in a cycle and onto a subsidiary object.  Deferreds do this in Twisted 2.0.  As a general technique, this doesn't make much sense, since it depends on knowledge of the structure of specific object graphs (ie, you need to know where cycles will form and where they will not).

I'm not sure if it's worth the effort.  I don't exactly see the attraction of the functionality being provided.  I tend to find that explicit cleanup is not overly burdensome.  Perhaps you can share some examples of how you see it being used?

Jp


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010512.html">[Twisted-Python] cleanup in twisted
</A></li>
	<LI>Next message: <A HREF="010518.html">[Twisted-Python] twisted.plugin plugin framework
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10513">[ date ]</a>
              <a href="thread.html#10513">[ thread ]</a>
              <a href="subject.html#10513">[ subject ]</a>
              <a href="author.html#10513">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
