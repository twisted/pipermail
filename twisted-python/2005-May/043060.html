<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] adbapi and pymssql
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20adbapi%20and%20pymssql&In-Reply-To=%3C200505261334.58599.mike%40mkp.ca%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043119.html">
   <LINK REL="Next"  HREF="043061.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] adbapi and pymssql</H1>
    <B>Mike Pelletier</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20adbapi%20and%20pymssql&In-Reply-To=%3C200505261334.58599.mike%40mkp.ca%3E"
       TITLE="[Twisted-Python] adbapi and pymssql">mike at mkp.ca
       </A><BR>
    <I>Thu May 26 11:34:57 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043119.html">[Twisted-Python] clustering or process group replication
</A></li>
        <LI>Next message (by thread): <A HREF="043061.html">[Twisted-Python] adbapi and pymssql
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43060">[ date ]</a>
              <a href="thread.html#43060">[ thread ]</a>
              <a href="subject.html#43060">[ subject ]</a>
              <a href="author.html#43060">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am attempting to use pymssql in an new Twisted app I am developing for a 
client (so please don't ask for a lot of detail).  pymssql claims to 
implement &quot;most&quot; of ADBAPI 2.0 and it's not on the list of known supported 
back ends, so I realize I'm pressing my luck a bit here.

Bare pymssql seemed to work well, so I pressed on and attempted to use it with 
adbapi.  Here is what I am using for testing:

from twisted.internet import reactor
from twisted.enterprise import adbapi
from agent.db import makeDbpool

def printResultAndDie(*result):
    print &quot;result:&quot;, result
    reactor.stop()

def printErrorAndDie(error):
    error.printTraceback()
    reactor.stop()

import sys
dbpool = makeDbpool()
query = &quot; &quot;.join(sys.argv[1:])
print query
d = dbpool.runQuery(query)
d.addCallbacks(printResultAndDie, printErrorAndDie)
reactor.run()

This reports an error, though it appears on the server that the transaction 
was completely successful.  The exception is thrown by adbapi.py:310, 
&quot;self._rollback(trans)&quot;.  This line is itself in an exception handler, and it 
is handling an exception thrown by line 306, &quot;trans._connection.commit()&quot;.

A little further testing suggested to me that there is nothing obviously wrong 
with pymssql's commit or rollback features.  The problem seems to be line 
305: &quot;trans.close()&quot;.  I guess pymssql doesn't support commits and rollbacks 
after that, which seems almost reasonable.  (Mind, I am in much deeper than I 
have any actual understanding.)

I have locally modified _runinteraction.  I would *really* appreciate it if 
someone took a look at my changes.  I don't understand why close() is 
supposed to be called before commit() or rollback(), so maybe this is a 
completely wrongheaded move on my part.  Here is my version:

    def _runInteraction(self, interaction, *args, **kw):
        trans = Transaction(self)
        try:
            try:
                result = interaction(trans, *args, **kw)
                trans._connection.commit()
            except:
                self._rollback(trans)
                raise
        finally:
            trans.close()
        return result

And for comparison, the original:

    def _runInteraction(self, interaction, *args, **kw):
        trans = Transaction(self)
        try:
            result = interaction(trans, *args, **kw)
            trans.close()
            trans._connection.commit()
            return result
        except:
            self._rollback(trans)
            raise

Thanks in advance!

Mike.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043119.html">[Twisted-Python] clustering or process group replication
</A></li>
	<LI>Next message (by thread): <A HREF="043061.html">[Twisted-Python] adbapi and pymssql
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43060">[ date ]</a>
              <a href="thread.html#43060">[ thread ]</a>
              <a href="subject.html#43060">[ subject ]</a>
              <a href="author.html#43060">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
