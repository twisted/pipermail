<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] cleanup in twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20cleanup%20in%20twisted&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010590.html">
   <LINK REL="Next"  HREF="010549.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] cleanup in twisted</H1>
    <B>Joachim Boomberschloss</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20cleanup%20in%20twisted&In-Reply-To="
       TITLE="[Twisted-Python] cleanup in twisted">boomberschloss at yahoo.com
       </A><BR>
    <I>Thu May 26 10:21:00 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010590.html">[Twisted-Python] threadedselectreactor
</A></li>
        <LI>Next message: <A HREF="010549.html">[Twisted-Python] clustering or process group replication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10548">[ date ]</a>
              <a href="thread.html#10548">[ thread ]</a>
              <a href="subject.html#10548">[ subject ]</a>
              <a href="author.html#10548">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
--- Jp Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt; wrote:
&gt;<i> On Wed, 25 May 2005 06:12:16 -0700 (PDT), Joachim
</I>&gt;<i> Boomberschloss &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">boomberschloss at yahoo.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;--- Jp Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; [snip]
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Rescuing an object from garbage collection is
</I>&gt;<i> easier
</I>&gt;<i> &gt;&gt; than you may expect:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;   <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at boson</A>:~$ python
</I>&gt;<i> &gt;&gt;   Python 2.4.1 (#2, Mar 30 2005, 21:51:10)
</I>&gt;<i> &gt;&gt;   [GCC 3.3.5 (Debian 1:3.3.5-8ubuntu2)] on linux2
</I>&gt;<i> &gt;&gt;   Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or
</I>&gt;<i> &quot;license&quot;
</I>&gt;<i> &gt;&gt; for more information.
</I>&gt;<i> &gt;&gt;   &gt;&gt;&gt; L = []
</I>&gt;<i> &gt;&gt;   &gt;&gt;&gt; class Foo:
</I>&gt;<i> &gt;&gt;   ...     def __del__(self):
</I>&gt;<i> &gt;&gt;   ...             L.append(self)
</I>&gt;<i> &gt;&gt;   ...
</I>&gt;<i> &gt;&gt;   &gt;&gt;&gt; f = Foo()
</I>&gt;<i> &gt;&gt;   &gt;&gt;&gt; del f
</I>&gt;<i> &gt;&gt;   &gt;&gt;&gt; L
</I>&gt;<i> &gt;&gt;   [&lt;__main__.Foo instance at 0xb7dff34c&gt;]
</I>&gt;<i> &gt;&gt;   &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Of course, for it to ever be collected, you'll
</I>&gt;<i> need
</I>&gt;<i> &gt;&gt; to take it out of that list.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Hmmm. Good to know. I thought this sort of thing
</I>&gt;<i> was
</I>&gt;<i> &gt;considered illegal in Python. This resolves
</I>&gt;<i> deferring
</I>&gt;<i> &gt;the destruction, but not the problem with reference
</I>&gt;<i> &gt;cycles. Is there any way to do it without __del__?
</I>&gt;<i> 
</I>&gt;<i> The garbage collector goes to great lengths to make
</I>&gt;<i> sure it works :)
</I>&gt;<i> 
</I>&gt;<i> Well, here's an example of how you'd use weakrefs. 
</I>&gt;<i> It may or may not apply to your case:
</I>&gt;<i> 
</I>&gt;<i>   <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at boson</A>:~$ python
</I>&gt;<i>   Python 2.4.1 (#2, Mar 30 2005, 21:51:10) 
</I>&gt;<i>   [GCC 3.3.5 (Debian 1:3.3.5-8ubuntu2)] on linux2
</I>&gt;<i>   Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot;
</I>&gt;<i> for more information.
</I>&gt;<i>   &gt;&gt;&gt; import weakref
</I>&gt;<i>   &gt;&gt;&gt; def cleanup(handle):
</I>&gt;<i>   ...     print 'Cleaned up', handle
</I>&gt;<i>   ... 
</I>&gt;<i>   &gt;&gt;&gt; class Foo:
</I>&gt;<i>   ...     def __init__(self, x, y, z):
</I>&gt;<i>   ...         self.x, self.y, self.z = x, y, z
</I>&gt;<i>   ...         self._cleanup = weakref.ref(
</I>&gt;<i>   ...             self, lambda deadref: cleanup(x))
</I>&gt;<i>   ... 
</I>&gt;<i>   &gt;&gt;&gt; f = Foo('hello', 'world', 42)
</I>&gt;<i>   &gt;&gt;&gt; del f
</I>&gt;<i>   Cleaned up hello
</I>&gt;<i>   &gt;&gt;&gt; 
</I>&gt;<i> 
</I>&gt;<i> The main point here is the isolation of the objects
</I>&gt;<i> needed for actual cleanup from the object which may
</I>&gt;<i> participate in a cycle. In this way, it is similar
</I>&gt;<i> to moving the __del__ implementation onto a separate
</I>&gt;<i> class.
</I>&gt;<i> 
</I>&gt;<i> Since the cleanup callback does not have access to
</I>&gt;<i> the instance, it is somewhat more limited.  For
</I>&gt;<i> example, if the `x' attribute of a Foo instance is
</I>&gt;<i> ever changed, the callback will still be invoked
</I>&gt;<i> with the original value.
</I>&gt;<i> 
</I>
Got it. Well, indeed, this is not exactly what I need
because of the limitation you mentioned, but I think I
found a solution: to have a global object that points
to all instances of Cleanuppable, and a LoopingCall
that checks every minute or so whether this global
object is the only referrer to each Cleanuppable
instance, in which case it activates the __cleanup__
method of the Cleanuppable, and waits for the
procedure to complete, then deletes the instance. This
is somewhat unelegant (because of the arbitrariness of
the LoopingCall as opposed to being dependent on the
garbage collection process), but I think it should be
completely satisfactory functionality-wise.

This brings me back to the question of attractiveness,
which makes me suspect that I am missing some point.
What I thought was that it would be very convenient to
be able to specify once, using a simple Twisted-style
idiom, what should happen with an object when it is no
longer needed, which, because of the way Twisted
works, should be given a chance to execute before the
reactor shuts down, but similarly when the object
simply dies out normally (i.e. the point here is being
able to use deferred to specify a non-instantaneous
cleanup procedure). An example of this would be an
object that interacts with a remote server that should
notify the server before retiring from the
interaction.

I think the method I proposed including the missing
element I described above handles this nicely. I'm not
sure what you meant by explicit cleanup.

Joe.

__________________________________________________
Do You Yahoo!?
Tired of spam?  Yahoo! Mail has the best spam protection around 
<A HREF="http://mail.yahoo.com">http://mail.yahoo.com</A> 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010590.html">[Twisted-Python] threadedselectreactor
</A></li>
	<LI>Next message: <A HREF="010549.html">[Twisted-Python] clustering or process group replication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10548">[ date ]</a>
              <a href="thread.html#10548">[ thread ]</a>
              <a href="subject.html#10548">[ subject ]</a>
              <a href="author.html#10548">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
