<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] cleanup in twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20cleanup%20in%20twisted&In-Reply-To=%3C20050525122120.64271.qmail%40web53109.mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043021.html">
   <LINK REL="Next"  HREF="043043.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] cleanup in twisted</H1>
    <B>Joachim Boomberschloss</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20cleanup%20in%20twisted&In-Reply-To=%3C20050525122120.64271.qmail%40web53109.mail.yahoo.com%3E"
       TITLE="[Twisted-Python] cleanup in twisted">boomberschloss at yahoo.com
       </A><BR>
    <I>Wed May 25 06:21:20 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043021.html">[Twisted-Python] cleanup in twisted
</A></li>
        <LI>Next message (by thread): <A HREF="043043.html">[Twisted-Python] cleanup in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43042">[ date ]</a>
              <a href="thread.html#43042">[ thread ]</a>
              <a href="subject.html#43042">[ subject ]</a>
              <a href="author.html#43042">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
--- Jp Calderone &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt; wrote:
&gt;<i> On Mon, 23 May 2005 05:12:49 -0700 (PDT), Joachim
</I>&gt;<i> Boomberschloss &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">boomberschloss at yahoo.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;--- Jp Calderone &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; On Mon, 23 May 2005 02:40:53 -0700 (PDT), Joachim
</I>&gt;<i> &gt;&gt; Boomberschloss &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">boomberschloss at yahoo.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;--- Bob Ippolito &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bob at redivi.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; On May 22, 2005, at 8:46 AM, Joachim
</I>&gt;<i> &gt;&gt; Boomberschloss
</I>&gt;<i> &gt;&gt; &gt;&gt; wrote:
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; I just jotted down a little mechanism for
</I>&gt;<i> &gt;&gt; &gt;&gt; cleaning-up
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; in Twisted, and I wanted to see if:
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; 1. other people think it's needed
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; 2. other people manage to use it
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; What this does is enable one to define a
</I>&gt;<i> &gt;&gt; &gt;&gt; __cleanup__
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; method which gets call either when the
</I>&gt;<i> instance
</I>&gt;<i> &gt;&gt; is
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; deleted, or when the reactor shuts down. It
</I>&gt;<i> can
</I>&gt;<i> &gt;&gt; &gt;&gt; return
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; a dereffed that delays the shutdown. The
</I>&gt;<i> &gt;&gt; benefit
</I>&gt;<i> &gt;&gt; &gt;&gt; is
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; being able to define communication-related
</I>&gt;<i> &gt;&gt; stuff
</I>&gt;<i> &gt;&gt; &gt;&gt; in
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; the cleanup method, which is not so useful
</I>&gt;<i> to
</I>&gt;<i> &gt;&gt; do
</I>&gt;<i> &gt;&gt; &gt;&gt; in
</I>&gt;<i> &gt;&gt; &gt;&gt; &gt; __del__.
</I>&gt;<i> &gt;&gt; &gt;&gt;
</I>&gt;<i> &gt;&gt; &gt;&gt; This is just begging for object leaks, because
</I>&gt;<i> &gt;&gt; &gt;&gt; __del__ disables
</I>&gt;<i> &gt;&gt; &gt;&gt; aspects of cyclic GC.
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt; &gt;Hmmpf. What does this mean, and is there a
</I>&gt;<i> simple
</I>&gt;<i> &gt;&gt; way
</I>&gt;<i> &gt;&gt; &gt;of resolving it?
</I>&gt;<i> &gt;&gt; &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;   If you construct a reference cycle which
</I>&gt;<i> contains
</I>&gt;<i> &gt;&gt; an object which has a __del__ method, the entire
</I>&gt;<i> &gt;&gt; cycle becomes &quot;garbage&quot; - Python cannot free any
</I>&gt;<i> of
</I>&gt;<i> &gt;&gt; the objects or call any of their __del__ methods.
</I>&gt;<i> &gt;&gt; Instead, it puts them into the gc module's
</I>&gt;<i> `garbage'
</I>&gt;<i> &gt;&gt; list and leaves them there forever.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;   There's no simple way to resolve this (except
</I>&gt;<i> to
</I>&gt;<i> &gt;&gt; not implement __del__, of course ;).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;   A non-simple way to resolve it is to use
</I>&gt;<i> weakref
</I>&gt;<i> &gt;&gt; callbacks instead of __del__.  Weakref callbacks
</I>&gt;<i> &gt;&gt; have some nasty bugs in versions of Python older
</I>&gt;<i> &gt;&gt; than 2.3.5 (more, the further back you go), and
</I>&gt;<i> &gt;&gt; they're trickier to use than __del__.  They don't
</I>&gt;<i> &gt;&gt; create garbage cycles, though.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Can you point me to an example of this (preferably
</I>&gt;<i> in
</I>&gt;<i> &gt;Twisted)? Is this whole cleanup thing worth my time
</I>&gt;<i> &gt;fixing it in your opinion?
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Twisted doesn't make use of it, due to the
</I>&gt;<i> instabilities in previous Python versions (which
</I>&gt;<i> Twisted still supports).
</I>&gt;<i> 
</I>&gt;<i> Another technique I didn't mention is to move the
</I>&gt;<i> __del__ implementation off of the object which might
</I>&gt;<i> participate in a cycle and onto a subsidiary object.
</I>&gt;<i>  Deferreds do this in Twisted 2.0.  As a general
</I>&gt;<i> technique, this doesn't make much sense, since it
</I>&gt;<i> depends on knowledge of the structure of specific
</I>&gt;<i> object graphs (ie, you need to know where cycles
</I>&gt;<i> will form and where they will not).
</I>&gt;<i> 
</I>&gt;<i> I'm not sure if it's worth the effort.  I don't
</I>&gt;<i> exactly see the attraction of the functionality
</I>&gt;<i> being provided.  I tend to find that explicit
</I>&gt;<i> cleanup is not overly burdensome.  Perhaps you can
</I>&gt;<i> share some examples of how you see it being used?
</I>
Well, the attraction is this: I ran into situations in
which it is desirable for an object to do some
communication-related cleanup when deleted, either
when the program shuts down or when it is no longer
referenced. For example, I have objects responsible
for maintaining communication with some servers, and I
want them to inform the server when they cease to
maintain communication with it. This should be done
either when the service is no longer necessary and the
object (the maintainer) is deleted, or when the
program shuts down, so basically, the functionality
required is to be able to define communication-related
stuff (i.e. things that aren't instantaneous and
involve deferreds) to be done either when the object
is deleted or when twisted shuts down. The latter is
easy to do, but the former isn't, and come to think of
it, my solution isn't good regardless of reference
cycles, because, since the cleanup method is spawned
from __del__, it has to do the cleanup instantaneously
or the cleanup process won't be able to refer to the
object at a later stage. Basically what is needed is
to be able to defer the destruction of the object both
at program shutdown, which is easy, and before object
deletion, which I don't know how to do. Any thoughts
(either about the attractiveness of the functionality
or about how to achieve it)?

Joe.


		
__________________________________ 
Yahoo! Mail 
Stay connected, organized, and protected. Take the tour: 
<A HREF="http://tour.mail.yahoo.com/mailtour.html">http://tour.mail.yahoo.com/mailtour.html</A> 



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043021.html">[Twisted-Python] cleanup in twisted
</A></li>
	<LI>Next message (by thread): <A HREF="043043.html">[Twisted-Python] cleanup in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43042">[ date ]</a>
              <a href="thread.html#43042">[ thread ]</a>
              <a href="subject.html#43042">[ subject ]</a>
              <a href="author.html#43042">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
