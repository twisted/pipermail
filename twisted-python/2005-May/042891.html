<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: Hanging test cases (Was: Evangelism notes...)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20Hanging%20test%20cases%20%28Was%3A%20Evangelism%20notes...%29&In-Reply-To=%3C20050507231316.15422.715887765.divmod.quotient.24760%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="042890.html">
   <LINK REL="Next"  HREF="042941.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: Hanging test cases (Was: Evangelism notes...)</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20Hanging%20test%20cases%20%28Was%3A%20Evangelism%20notes...%29&In-Reply-To=%3C20050507231316.15422.715887765.divmod.quotient.24760%40ohm%3E"
       TITLE="[Twisted-Python] Re: Hanging test cases (Was: Evangelism notes...)">exarkun at divmod.com
       </A><BR>
    <I>Sat May  7 17:13:16 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="042890.html">[Twisted-Python] Re: Hanging test cases (Was: Evangelism notes...)
</A></li>
        <LI>Next message (by thread): <A HREF="042941.html">[Twisted-Python] Re: Hanging test cases (Was: Evangelism notes...)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42891">[ date ]</a>
              <a href="thread.html#42891">[ thread ]</a>
              <a href="subject.html#42891">[ subject ]</a>
              <a href="author.html#42891">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06 May 2005 20:19:45 -0400, David Bolen &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">db3l at fitlinxx.com</A>&gt; wrote:
&gt;<i>Bob Ippolito &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bob at redivi.com</A>&gt; writes:
</I>&gt;<i>
</I>&gt;&gt;<i> (1) Reactors can only be (meaningfully/predictably/etc) iterated if
</I>&gt;&gt;<i> Twisted rules the universe AND the implementation of that reactor is
</I>&gt;&gt;<i> amenable to that feature.  This is not a tautology.
</I>&gt;&gt;<i> (2) Reactors need to fire various startup/shutdown events.  Reactors
</I>&gt;&gt;<i> shouldn't be doing ANYTHING unless they are in a running state.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The current deferredResult/deferredError breaks both of these
</I>&gt;&gt;<i> conditions.
</I>&gt;&gt;<i> (1) It iterates the reactor (which is a historically public, but
</I>&gt;&gt;<i> conceptually broken interface)
</I>&gt;&gt;<i> (2) It iterates the reactor in a STOPPED state.  The reactor is never
</I>&gt;&gt;<i> &quot;running&quot; during these tests.  Startup/Shutdown does not happen!
</I>&gt;<i>
</I>&gt;<i>This seems like an internal implementation issue to me - when a
</I>&gt;<i>reactor is &quot;running&quot; (I've called run()), it's basically stuck in a
</I>&gt;<i>loop doing runUntilCurrent and then doIteration.  That's precisely
</I>&gt;<i>what iterate does.
</I>&gt;<i>
</I>
  It's an implementation detail, yes, but not an internal one.  For the reactor to operate properly, it *must* be started up and shut down.  That's simply a requirement of the interface.  It's not even a particularly unusual one: many libraries require you call some initialization function before proceeding to other APIs they provide.

  With recent versions of Twisted, many reactors don't actually depend terribly heavily on being started up, so you may be able to call iterate() without calling run() first and see something resembling correct behavior.  However, you should note that future versions of Twisted may introduce new startup requirements which break programs which assume reactors do not need an explicit startup event.  Additionally, third-party reactors may depend on the startup event now, thus breaking when used with code that only uses iterate().

  The shutdown event is much more important these days.  People who have noticed Twisted programs and tests which hang at shutdown can attest to this.

&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>I guess that's true of any nested use of deferredResult too, but we
</I>&gt;<i>don't nest our deferredResult calls - no real need since any
</I>&gt;<i>deferrable is directly wrapped with the deferredResult call, and
</I>&gt;<i>deferredResult is only used in the tests, so what they are calling is
</I>&gt;<i>always production code that is written properly with callbacks and
</I>&gt;<i>what not.
</I>
  This is one of the cases, yes.

&gt;<i>
</I>&gt;&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>I still don't necessarily see that (the last sentence).  We use
</I>&gt;<i>multiple deferrable operations in single tests, but never more than
</I>&gt;<i>one at a time (e.g., no recursive or nested uses).  But certainly more
</I>&gt;<i>than a single deferrable operation within a single test.
</I>&gt;<i>
</I>&gt;<i>I would, however, agree that I'd prefer even more the ability to
</I>&gt;<i>completely start/stop a reactor during the course of a test, but would
</I>&gt;<i>still like to be able to iterate it manually during the test to
</I>&gt;<i>provide a natural blocking flow to the test.
</I>
  Your application code all deals with Deferred callbacks.  Why is it a stretch to have your test code do the same?

&gt;<i>
</I>&gt;<i>But in my current scenario, the majority of my components under test
</I>&gt;<i>are having interfaces tested that are not impacted by startup/shutdown
</I>&gt;<i>(and we don't use any services, in the Twisted sense, for example).
</I>
  That you know of.  With current releases of Twisted.

&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>Yeah, that's a tough problem, although one that would also simplify
</I>&gt;<i>the fact that we often run the tests under the unittest GUI, and
</I>&gt;<i>occasionally have to fight cross-test pollution from the reactor
</I>&gt;<i>persisting across test runs, which is a wart from the current
</I>&gt;<i>restrictions.
</I>
  This is one reason you should use trial, even though it is broken.  Trial will be fixed by Twisted developers who (at least occassionally) have a firm grasp of how it can correctly interact with the reactor, so by using it you benefit from this understanding.  By using unittest, you are forced to get all the things right that trial will someday get right, or accept a broken test harness.

  If you have feature requirements that trial does not satisfy, make some feature requests :)  We are quite aware that trial is not yet feature complete and will welcome suggestions for features that make it a more useful tool.

&gt;<i> [snip]
</I>&gt;<i> 
</I>&gt;<i>That's what I meant by saying that the integration into generators is
</I>&gt;<i>slick (and goes a good way to linearizing what is normally a callback
</I>&gt;<i>chain), but still isn't quite as simple as the interface provided by
</I>&gt;<i>the deferred{Result,Error} functions.
</I>
  I don't think anyone is trying to suggest that it is simpler.  However, it has the advantage of being correct.  Given the choice between simplicity and correctness, I am inclined towards correctness.

&gt;<i>
</I>&gt;&gt;<i> Well, let's say your database thing is a service, that maintains some
</I>&gt;&gt;<i> kind of ephemeral state that's required in some way.  If
</I>&gt;&gt;<i> deferredResult were properly written, this ephemeral state would hit
</I>&gt;&gt;<i> the bit bucket on each deferredResult, probably breaking your code
</I>&gt;&gt;<i> even though the test are &quot;correct&quot;.
</I>&gt;<i>
</I>&gt;<i>I might be getting lost on the &quot;properly written&quot; part, but if I were
</I>&gt;<i>testing a component that did have state triggered during reactor
</I>&gt;<i>startup/shutdown (which is what I think you're referring to), that
</I>&gt;<i>test would likely be using direct calls to the component to trigger
</I>&gt;<i>the startup/shutdown actions as part of the test setup/teardown, but
</I>&gt;<i>without using the reactor.
</I>
  You can definitely do this.  The problem is that the reactor may have internal setup and tear down of which you are not aware and which will cause problems if skipped.

&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>I don't know - maybe my use case is just limited enough (non trial, no
</I>&gt;<i>nesting, etc...) that I don't see any true exposures through
</I>&gt;<i>deferred{Result,Error} while I'm getting benefits.
</I>
  It may be the case that none of the bugs in trial synchronous result utilities cause problems for you.  If they don't, I can understand how it would not be a big priority for you to move away from them (after all, I'm sure you have plenty of things that *are* causing you problems now that you would much rather spend time on).  I recommend simply keeping this conversation in mind if and when you run into problems with your use of deferredResult and deferredError in the future and that you not let such problems take you by surprise.  You can rest relatively easily in the knowledge that deferredResult and friends will not disappear from Twisted overnight.  Broken as they are, they are clearly part of a public API and so will remain long enough to satisfy backwards compatibility requirements.

  Jp


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="042890.html">[Twisted-Python] Re: Hanging test cases (Was: Evangelism notes...)
</A></li>
	<LI>Next message (by thread): <A HREF="042941.html">[Twisted-Python] Re: Hanging test cases (Was: Evangelism notes...)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42891">[ date ]</a>
              <a href="thread.html#42891">[ thread ]</a>
              <a href="subject.html#42891">[ subject ]</a>
              <a href="author.html#42891">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
