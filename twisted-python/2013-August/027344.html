<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Serial transport protocol logging on Raspberry Pi
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Serial%20transport%20protocol%20logging%20on%20Raspberry%20Pi&In-Reply-To=%3C1056D3E3-3C3A-4C07-A292-3CB628A35335%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="059801.html">
   <LINK REL="Next"  HREF="059806.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Serial transport protocol logging on Raspberry Pi</H1>
    <B>Lucas Taylor</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Serial%20transport%20protocol%20logging%20on%20Raspberry%20Pi&In-Reply-To=%3C1056D3E3-3C3A-4C07-A292-3CB628A35335%40gmail.com%3E"
       TITLE="[Twisted-Python] Serial transport protocol logging on Raspberry Pi">ltaylor.volks at gmail.com
       </A><BR>
    <I>Fri Aug 23 11:39:16 MDT 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="059801.html">[Twisted-Python] SQL ORM for Twisted &amp; PostgreSQL?
</A></li>
        <LI>Next message (by thread): <A HREF="059806.html">[Twisted-Python] Serial transport protocol logging on Raspberry Pi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27344">[ date ]</a>
              <a href="thread.html#27344">[ thread ]</a>
              <a href="subject.html#27344">[ subject ]</a>
              <a href="author.html#27344">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have written a simple serial-to-serial logging proxy in order to discover and document the protocol used by two hardware devices. The goal is to incrementally replace one of the devices with a Twisted application, but right now I'm just trying to gather data.

A RaspberryPi seemed ideal for this given its cost and ability to run python; however, I seem to be running into some kind of timing or data corruption issue that only occurs on the Pi, and only when I am logging data.  The application works well on my dev laptop (OSX), but falters on the Pi.

I can use socat to do raw data collection for this first stage (it works fine on the Pi as a logging proxy), but I was hoping to use Twisted with custom log observers to format the data in ways that might help illuminate the framing of the protocol. The idea was to have the protocol just log and proxy each byte and then I could experiment with a series of observers to identify the patterns (emphasize STX/ETX as possible delimiters, flag this sequence as an 'INIT' sequence, etc..)


The setup:
--------------

[CON-A]  &lt;----&gt;  [SerialSpy (Twisted)]  &lt;----&gt; [CON-B]

When CON-A is powered-on, it goes through an init sequence to establish communication with CON-B and if there are any issues, CON-A gives up and displays an error message. 

When run from my dev laptop (OSX), the data is logged and proxied between the 2 devices without any problems. 

When run on the Pi (Raspbian), back and forth comm is fine for the first 4-5 framed packets (STX...ETX+CKSUM), but then CON-B begins to NAK every packet after that and CON-A gives up.

The total amount of data transferred during a successful init sequence is &lt; 1k:
CON-A: 537 bytes
CON-B: 290 bytes


The app:
------------

A minimal Protocol subclass logs each byte received and writes to its peer.

class ProxyLoggingProtocol(protocol.Protocol, object):
    peer = None

    def __init__(self, name):
        self.name = name

    def dataReceived(self, data):
        &quot;&quot;&quot;
        Log data received and proxy to peer
        &quot;&quot;&quot;
        for b in data:
            log.msg(b, system=self.name)

        # Passthrough data to &quot;other&quot; transport
        if self.peer is not None:
            self.peer.transport.write(data)
        else:
            err = ValueError('Peer protocol not set (nowhere to proxy this data)')
            log.err(err)


... setup the protocols and serial transports:

log.startLogging(sys.stdout)

conA = ProxyLoggingProtocol('CON-A--&gt;')
conB = ProxyLoggingProtocol('&lt;--CON-B')
conA.peer = conB
conB.peer = conA

SerialPort(conA,'/dev/ttyUSB0', reactor, ...)
SerialPort(conB, '/dev/ttyUSB1', reactor, ...)

reactor.run()


The Issue?
--------------
It seems that doing anything in dataReceived beyond just proxying bytes from A to B is enough to cause CON-B to interpret received data as either bad or delayed to the point where it returns a NAK. Oddly, the first few framed packets are logged, proxied, and ACKed successfully.

This occurs if I log.startLogging() to a file or stdout. If I never call startLogging(), the data proxies without error.  That is, CON-B replies with positive ACKs and everything works as expected.

I suppose the obvious answer may be that the Pi is underpowered for this task, but I am hoping to better understand why.  I may be able to defer logging to a queue or find other workarounds, but I'd like to figure out why basic usage of logging could be causing this.  Any thoughts as to what I could be looking at next would be appreciated.


Thanks,

Lucas




</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="059801.html">[Twisted-Python] SQL ORM for Twisted &amp; PostgreSQL?
</A></li>
	<LI>Next message (by thread): <A HREF="059806.html">[Twisted-Python] Serial transport protocol logging on Raspberry Pi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27344">[ date ]</a>
              <a href="thread.html#27344">[ thread ]</a>
              <a href="subject.html#27344">[ subject ]</a>
              <a href="author.html#27344">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
