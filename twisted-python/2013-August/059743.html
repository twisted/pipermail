<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] TestInternet2.testPickledTimer Failed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20TestInternet2.testPickledTimer%20Failed&In-Reply-To=%3C20130801115020.26068.1995148687.divmod.xquotient.62%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] TestInternet2.testPickledTimer Failed</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20TestInternet2.testPickledTimer%20Failed&In-Reply-To=%3C20130801115020.26068.1995148687.divmod.xquotient.62%40top%3E"
       TITLE="[Twisted-Python] TestInternet2.testPickledTimer Failed">exarkun at twistedmatrix.com
       </A><BR>
    <I>Thu Aug  1 05:50:20 MDT 2013</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59743">[ date ]</a>
              <a href="thread.html#59743">[ thread ]</a>
              <a href="subject.html#59743">[ subject ]</a>
              <a href="author.html#59743">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05:46 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">kylerzhang11 at gmail.com</A> wrote:
&gt;<i>Hi,
</I>&gt;<i>
</I>&gt;<i>I'm a Google Summer of Code intern working on &quot;Deferred Cancellation&quot;
</I>&gt;<i>project. I'm recently working on adding cancellation support to
</I>&gt;<i>twisted.internet.task.LoopingCall.
</I>&gt;<i>
</I>&gt;<i>However, after I added the canceller to LoopingCall.deferred,
</I>&gt;<i>the twisted.test.test_application.TestInternet2.testPickledTimer failed 
</I>&gt;<i>due
</I>&gt;<i>to a PicklingError.
</I>&gt;<i>
</I>&gt;<i>My branch is loopingcall-deferred-cancellation-6656. Here is the diff 
</I>&gt;<i>of my
</I>&gt;<i>code: <A HREF="http://twistedmatrix.com/~diffresource.twistd/6656">http://twistedmatrix.com/~diffresource.twistd/6656</A>
</I>&gt;<i>
</I>&gt;<i>[snip]
</I>  File &quot;/usr/lib/python2.7/pickle.py&quot;, line 748, in save_global
&gt;<i>    (obj, module, name))
</I>&gt;<i>pickle.PicklingError: Can't pickle &lt;function &lt;lambda&gt; at 0x8f1fb8c&gt;: 
</I>&gt;<i>it's
</I>&gt;<i>not found as twisted.internet.posixbase.&lt;lambda&gt;
</I>
Two things to notice about the previous line.  One, it is trying to 
pickle a function defined using a lambda expression.  Two, it is trying 
to pickle something from twisted.internet.posixbase - which probably 
means it's trying to pickle the reactor.

You can run trial with --debug and it will drop into pdb when it hits 
this error.  Then you can walk up and down the call stack and inspect 
the objects pickle is operating on.  You can get some idea of where 
things are going wrong this way.
&gt;<i>
</I>&gt;<i>I thought the reason was the circular references. However I searched 
</I>&gt;<i>about
</I>&gt;<i>it and found that pickle could handle the circular reference cases. But 
</I>&gt;<i>the
</I>&gt;<i>only significant change is that after I added the canceller, there is a
</I>&gt;<i>circular reference between LoopingCall and LoopingCall.deferred. So I 
</I>&gt;<i>don't
</I>&gt;<i>know what's the problem. How can I fix this?
</I>
There are two changes that seem like they could be relevant.

First, LoopingCall now keeps a reference to the Deferred returned by 
application code.  This means anything reachable from that Deferred is 
going to get pickled when LoopingCall is pickled.  This jumped out at me 
first, but I don't think it's actually causing the problem.

Second, there is now a reference from the Deferred returned by 
`LoopingCall` back to the `LoopingCall` instance - via the bound 
`_cancel` method.  `TimerService` holds on to a reference to this 
`Deferred`.

Of course, stepping back, it doesn't make any sense to pickle 
LoopingCall - it explicitly refers to the reactor, so it's never 
actually going to be pickleable.

I suggest you take a look at TimerService and figure out why pickling 
one of those ever tries to pickle a LoopingCall (take a look around 
`__getstate__` and `volatile`, I think that's where the problem is).  I 
think you'll find an existing bug that the unit test previously failed 
to reveal but which your changes have revealed.

Jean-Paul


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59743">[ date ]</a>
              <a href="thread.html#59743">[ thread ]</a>
              <a href="subject.html#59743">[ subject ]</a>
              <a href="author.html#59743">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
