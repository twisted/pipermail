<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Raising exception from a Deferred canceller.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Raising%20exception%20from%20a%20Deferred%20canceller.&In-Reply-To=%3CCACqnu4XiwTqfUH9QW%2BpjSvxL2x4nt8C2gzXYXyhKxoYoPxuJfg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027381.html">
   <LINK REL="Next"  HREF="027384.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Raising exception from a Deferred canceller.</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Raising%20exception%20from%20a%20Deferred%20canceller.&In-Reply-To=%3CCACqnu4XiwTqfUH9QW%2BpjSvxL2x4nt8C2gzXYXyhKxoYoPxuJfg%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Raising exception from a Deferred canceller.">terry at jon.es
       </A><BR>
    <I>Thu Aug 29 04:18:15 MDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027381.html">[Twisted-Python]  Raising exception from a Deferred canceller.
</A></li>
        <LI>Next message: <A HREF="027384.html">[Twisted-Python] Raising exception from a Deferred canceller.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27382">[ date ]</a>
              <a href="thread.html#27382">[ thread ]</a>
              <a href="subject.html#27382">[ subject ]</a>
              <a href="author.html#27382">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Kai

I think it's helpful to keep clear on two different things that cancelation
is intended to do: 1) to fire the original deferred so that things relying
on it can proceed, and 2) to try to terminate an ongoing action that the
deferred might be waiting on.

For 1, I think calling cancel() should *always* result in the deferred
being fired (with, as it currently stands, CancelledError being used if a
provided cancel function does not fire the deferred itself). Always firing
the deferred is very important because the caller of cancel may have set up
many deferreds that rely on each other and their entire program may not be
able to proceed at all until the offending deferred is actually fired. It's
also contractually simple, and easy to document &amp; understand.

For 2, the question is: do we want to also return information to the caller
if 2a) the underlying cancel function detects that it cannot, or can no
longer, stop the operation, or 2b) there is some kind of exception when
cancel calls the cancellation function.  I don't think 2a) is really an
exception situation, so it makes sense, as you say, just to return False
from cancel in this case. It's basically the cancel function saying it was
too late to do anything about the underlying operation but not providing
more information than that. Internally raising and catching
CancellationFailedError (as in your code) in that case seems good to me.
 In the case of 2b) I would just let the exception bubble up to the calling
code. Agreed, it could break some existing code, but isn't that existing
code already subject to that exact failure? It's just currently
undefined/undocumented.

Terry



On Thu, Aug 29, 2013 at 10:27 AM, zhang kai &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">kylerzhang11 at gmail.com</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> As itamar mentioned in ticket #6676 &lt;<A HREF="http://tm.tl/#6676">http://tm.tl/#6676</A>&gt;, If a
</I>&gt;<i> cancellation function for a Deferred throws an exception(the cancel() method
</I>&gt;<i> of Deferred won&#8217;t throw exceptions, but the canceller may), behavior is
</I>&gt;<i> undefined. If the cancellation function throws an exception it is currently
</I>&gt;<i> not caught, and cancellation does not occur.
</I>&gt;<i>
</I>&gt;<i> We can catch the exception and log it, and fallback to just firing
</I>&gt;<i> Deferred withCancelledError. This won&#8217;t break any old code. But an
</I>&gt;<i> exception raising from the cancellation function often means the
</I>&gt;<i> cancellation is failed.
</I>&gt;<i>
</I>&gt;<i> Another option we have is taking this opportunity to make the cancellation
</I>&gt;<i> being able to fail. There is the motivation:
</I>&gt;<i>
</I>&gt;<i> There are cases where a Deferred is uncancellable. For example, we can
</I>&gt;<i> call twisted.mail.imap4.IMAP4Client.delete to delete a mailbox. When the
</I>&gt;<i> operation is waiting in the queue, we can cancel it by removing it from the
</I>&gt;<i> queue. However, when the operation is already sent and is waiting for the
</I>&gt;<i> response, it becomes uncancellable.
</I>&gt;<i>
</I>&gt;<i> If we allow the canceller(NOT the cancel() method of the Deferred) to
</I>&gt;<i> raise an exception, we can tell the user the cancellation is failed and the
</I>&gt;<i> Deferredwon&#8217;t be fired with a CancelledError.
</I>&gt;<i>
</I>&gt;<i> Raising an exception from cancel() may break the old code. So we can
</I>&gt;<i> catch the exception raised by the canceller, then return a False without
</I>&gt;<i> firing theDeferred to tell the user that the cancellation is failed.
</I>&gt;<i>
</I>&gt;<i> In order to avoid missing unexpected exceptions, we can create a
</I>&gt;<i> CancellationFailedError. When the canceller raises CancellationFailedError,
</I>&gt;<i> we catch it and return False. When the canceller raises others
</I>&gt;<i> exceptions, we catch it, log it then return False.
</I>&gt;<i>
</I>&gt;<i> Something like this:
</I>&gt;<i>
</I>&gt;<i> def cancel(self):
</I>&gt;<i>     if not self.called:
</I>&gt;<i>         canceller = self._canceller
</I>&gt;<i>         if canceller:
</I>&gt;<i>             try:
</I>&gt;<i>                 canceller(self)
</I>&gt;<i>             except CancellationFailedError:
</I>&gt;<i>                 return False
</I>&gt;<i>             except Exception:
</I>&gt;<i>                 log.err(None, &quot;Unexpected exception from canceller.&quot;)
</I>&gt;<i>                 return False
</I>&gt;<i>         else:
</I>&gt;<i>             # Arrange to eat the callback that will eventually be fired
</I>&gt;<i>             # since there was no real canceller.
</I>&gt;<i>             self._suppressAlreadyCalled = True
</I>&gt;<i>         if not self.called:
</I>&gt;<i>             # There was no canceller, or the canceller didn't call
</I>&gt;<i>             # callback or errback.
</I>&gt;<i>             self.errback(failure.Failure(CancelledError()))
</I>&gt;<i>         return True
</I>&gt;<i>     elif isinstance(self.result, Deferred):
</I>&gt;<i>         # Waiting for another deferred -- cancel it instead.
</I>&gt;<i>         return self.result.cancel()
</I>&gt;<i>     else:
</I>&gt;<i>         return False
</I>&gt;<i>
</I>&gt;<i> This won&#8217;t break any code by raising an exception from cancel(), although
</I>&gt;<i> some code may rely on cancel() not returning any value.
</I>&gt;<i>
</I>&gt;<i> So, what&#8217;s your opinion on raising an exception from the canceller?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> -Kai
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20130829/657cd96c/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20130829/657cd96c/attachment-0001.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027381.html">[Twisted-Python]  Raising exception from a Deferred canceller.
</A></li>
	<LI>Next message: <A HREF="027384.html">[Twisted-Python] Raising exception from a Deferred canceller.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27382">[ date ]</a>
              <a href="thread.html#27382">[ thread ]</a>
              <a href="subject.html#27382">[ subject ]</a>
              <a href="author.html#27382">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
