<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Graceful shutdown
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Graceful%20shutdown&In-Reply-To=%3CCACoBDnO4YhGyFLfA064B9KLL88BstmDR86eCs1o0bCqZx6BgTQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Graceful shutdown</H1>
    <B>Jonas Lindmark</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Graceful%20shutdown&In-Reply-To=%3CCACoBDnO4YhGyFLfA064B9KLL88BstmDR86eCs1o0bCqZx6BgTQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Graceful shutdown">jonas.lindmark at gmail.com
       </A><BR>
    <I>Wed Aug 28 09:20:54 MDT 2013</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59836">[ date ]</a>
              <a href="thread.html#59836">[ thread ]</a>
              <a href="subject.html#59836">[ subject ]</a>
              <a href="author.html#59836">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

I'm trying to implement graceful shutdown of a HTTP server and I am unsure
of the preferred way of implementing it.

I'm attempting to do this by adding a system event trigger for &quot;before&quot;
&quot;shutdown&quot; that should stop accepting new requests and wait for current
ones to finish.

My problem is that though my requests has fired their notifyFinish()
deferreds the data has not been written to the client. Calling
reactor.getWriters() shows me that there are active writers who are
probably writing/flushing data to the client.

What is the preferred way of waiting for the requests to finish and finish
writing the response to the client?

Here is example code for my own attempt:

from twisted.internet import reactor, defer
from twisted.application import internet, service
from twisted.web.server import Site, NOT_DONE_YET
from twisted.web.resource import Resource

class SlowResource(Resource):
    isLeaf = True
    waiting_requests = []


    def notify_no_more_waiting(self):
        if not self.waiting_requests:
            return defer.succeed(None)
        return defer.gatherResults(self.waiting_requests, consumeErrors=True) \
                .addBoth(lambda ign: None)

    def write_result(self, request):
        request.write('{}')
        request.finish()

    def render_GET(self, request):
        reactor.callLater(5, self.write_result, request)

        d = request.notifyFinish()
        self.waiting_requests.append(d)
        d.addBoth(lambda ign: self.waiting_requests.remove(d))

        return NOT_DONE_YET


slow_resource = SlowResource()
site = Site(slow_resource)
application = service.Application(&quot;MyApp&quot;)
server = internet.TCPServer(8080, site)
server.setServiceParent(application)

def wait_for_writers():
    d = defer.Deferred()

    def check_writers():
        if len(reactor.getWriters()) &gt; 0:
            reactor.callLater(0.1, check_writers)
        else:
            d.callback(None)

    check_writers()

    return d

@defer.inlineCallbacks
def graceful_shutdown():
    yield server.stopService()
    yield slow_resource.notify_no_more_waiting()
    #yield wait_for_writers()


reactor.addSystemEventTrigger('before', 'shutdown', graceful_shutdown)


Uncommenting the yield in graceful_shutdown gives me my intended behaviour
but I don't like the solution since I have no idea if the writers there
have anything to do with writing the results. They could be any writer
writing anything I assume.

Running this code with twistd -ny graceful.tac and curling
<A HREF="http://localhost:8080">http://localhost:8080</A> and then issuing a SIGINT to the twistd process
results in an curl: (52) Empty reply from server.

-- 
/Jonas
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20130828/1ddb9777/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59836">[ date ]</a>
              <a href="thread.html#59836">[ thread ]</a>
              <a href="subject.html#59836">[ subject ]</a>
              <a href="author.html#59836">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
