<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Polling from Twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Polling%20from%20Twisted&In-Reply-To=%3C3f9007680904280411i185b90ebt4dc99e48a487bd40%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052044.html">
   <LINK REL="Next"  HREF="052046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Polling from Twisted</H1>
    <B>Juanjo Conti</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Polling%20from%20Twisted&In-Reply-To=%3C3f9007680904280411i185b90ebt4dc99e48a487bd40%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Polling from Twisted">jjconti at gmail.com
       </A><BR>
    <I>Tue Apr 28 05:11:41 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052044.html">[Twisted-Python] Polling from Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="052046.html">[Twisted-Python] Polling from Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52045">[ date ]</a>
              <a href="thread.html#52045">[ thread ]</a>
              <a href="subject.html#52045">[ subject ]</a>
              <a href="author.html#52045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks both for th soon replies.


My code looks a lot like Lucas suggested (I was messing the stop stuff).

Another question. Thinking twisted (and thinking about performance), it's ok
to loop every 30 seconds over the clients asking their status or should be
better to schudle a new polling rutine starting 30 seconds from now every
time a client is connected? In the second approach the polls will be more
spread? Is a good Idea?

It will be something like:

from twisted.internet import reactor, task

class StatusPollingReceiver(LineOnlyReceiver):
   def requestStatus(self):
       self.transport.write('stat\r\n')

   def connectionMade(self):
       self.factory.clients.append(self)
       statusloop = task.LoopingCall(self.requestStatus)
       statusloop.start(30.0)

   def lineReceived(self, line):
       print('Rx: %s' % line)

   def connectionLost(self, reason):
       self.factory.clients.remove(self)


class StatusPollingFactory(Factory):

   def __init__(self):
       self.clients = []

   def stopFactory(self):
       self.statusloop.stop()

   def buildProtocol(self, addr):
       p = StatusPollingReceiver()
       p.factory = self
       return p

2009/4/28 Lucas Taylor &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ltaylor.volks at gmail.com</A>&gt;

&gt;<i> On 4/27/09 5:06 PM, Juanjo Conti wrote:
</I>&gt;<i> &gt; Hi, this is my first mail to the list.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am writing a server using Twisted, extending LineOnlyReceiver. In it I
</I>&gt;<i> &gt; maintain a list of clients connected.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'd like to poll every client for certain status information every 30
</I>&gt;<i> &gt; seconds. Which is the correct approach to implement this?
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> A simple option is to setup a task.LoopingCall in your factory to
</I>&gt;<i> iterate over the list of clients every 30 seconds and issue your status
</I>&gt;<i> request. I don't know if it is correct for your application, but this
</I>&gt;<i> should illustrate the basic idea:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> from twisted.internet import reactor, task
</I>&gt;<i>
</I>&gt;<i> class StatusPollingReceiver(LineOnlyReceiver):
</I>&gt;<i>    def connectionMade(self):
</I>&gt;<i>        self.factory.clients.append(self)
</I>&gt;<i>
</I>&gt;<i>    def lineReceived(self, line):
</I>&gt;<i>        print('Rx: %s' % line)
</I>&gt;<i>
</I>&gt;<i>    def connectionLost(self, reason):
</I>&gt;<i>        self.factory.clients.remove(self)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class StatusPollingFactory(Factory):
</I>&gt;<i>
</I>&gt;<i>    def __init__(self):
</I>&gt;<i>        self.clients = []
</I>&gt;<i>
</I>&gt;<i>        # send a status request to each client every 30 seconds
</I>&gt;<i>        self.statusloop = task.LoopingCall(self.requestStatus)
</I>&gt;<i>        self.statusloop.start(30.0)
</I>&gt;<i>
</I>&gt;<i>    def requestStatus(self):
</I>&gt;<i>        for client in self.clients:
</I>&gt;<i>            client.transport.write('stat\r\n')
</I>&gt;<i>
</I>&gt;<i>    def stopFactory(self):
</I>&gt;<i>        self.statusloop.stop()
</I>&gt;<i>
</I>&gt;<i>    def buildProtocol(self, addr):
</I>&gt;<i>        p = StatusPollingReceiver()
</I>&gt;<i>        p.factory = self
</I>&gt;<i>        return p
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> see:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.task.LoopingCall.html">http://twistedmatrix.com/documents/current/api/twisted.internet.task.LoopingCall.html</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>


-- 
Juanjo Conti
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20090428/b1ab2e88/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052044.html">[Twisted-Python] Polling from Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="052046.html">[Twisted-Python] Polling from Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52045">[ date ]</a>
              <a href="thread.html#52045">[ thread ]</a>
              <a href="subject.html#52045">[ subject ]</a>
              <a href="author.html#52045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
