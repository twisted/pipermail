<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Fork/Spawn children to accept connections on	the same port. 
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Fork/Spawn%20children%20to%20accept%20connections%20on%0A%09the%20same%20port.%20&In-Reply-To=%3C20090411151746.24697.428522480.divmod.quotient.6019%40henry.divmod.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051986.html">
   <LINK REL="Next"  HREF="051961.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Fork/Spawn children to accept connections on	the same port. </H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Fork/Spawn%20children%20to%20accept%20connections%20on%0A%09the%20same%20port.%20&In-Reply-To=%3C20090411151746.24697.428522480.divmod.quotient.6019%40henry.divmod.com%3E"
       TITLE="[Twisted-Python] Fork/Spawn children to accept connections on	the same port. ">exarkun at divmod.com
       </A><BR>
    <I>Sat Apr 11 09:17:46 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051986.html">[Twisted-Python] Fork/Spawn children to accept connections on the	same port. 
</A></li>
        <LI>Next message (by thread): <A HREF="051961.html">[Twisted-Python] trac server error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51990">[ date ]</a>
              <a href="thread.html#51990">[ thread ]</a>
              <a href="subject.html#51990">[ subject ]</a>
              <a href="author.html#51990">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 10 Apr 2009 10:16:06 -0700, Eric York &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">eyork at apple.com</A>&gt; wrote:
&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>From: Jean-Paul Calderone &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt;
</I>&gt;&gt;<i>Date: April 10, 2009 8:57:19 AM PDT
</I>&gt;&gt;<i>To: Twisted general discussion &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt;
</I>&gt;&gt;<i>Subject: Re: [Twisted-Python] Fork/Spawn children to accept  connections on 
</I>&gt;&gt;<i>the same port.
</I>&gt;&gt;<i>Reply-To: Twisted general discussion &lt;twisted- <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">python at twistedmatrix.com</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>On Mon, 6 Apr 2009 15:25:39 -0700, Eric York &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">eyork at apple.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>I am trying to get the highest level of performance using all of  the 
</I>&gt;&gt;&gt;<i>processors cores on a server.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>In the past, a unix app would bind/listen to a socket and then fork  or 
</I>&gt;&gt;&gt;<i>spawn children to accept connections on that socket. I can’t see  how  to 
</I>&gt;&gt;&gt;<i>do that in Twisted. Can someone point me in the right  direction?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>The solution of using a single process to accept connections and  then 
</I>&gt;&gt;&gt;<i>farm out work to child processes, while a workable solution,  isn’t at 
</I>&gt;&gt;&gt;<i>the same level of performance as children processes that  are doing  their 
</I>&gt;&gt;&gt;<i>own accepts.
</I>&gt;<i>
</I>&gt;&gt;<i>It's also possible to bind a port in one process and then send it
</I>&gt;&gt;<i>over a UNIX socket to another process; this comes closer to the bind/ fork
</I>&gt;&gt;<i>approach, but accomplishes the resource sharing explicitly via fd  passing
</I>&gt;&gt;<i>rather than through fork.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>This is the path that I would like to follow. I can see how to spawn a 
</I>&gt;<i>child process and pass the fd in Twisted. What I can't see how to do  in 
</I>&gt;<i>Twisted is to have a parent process just bind and listen to a  socket and 
</I>&gt;<i>have a child process accept on that socket. In twisted/ internet/tcp.py in 
</I>&gt;<i>the class Port, there is a function startListening  which does 
</I>&gt;<i>bind/listen/startReading all in this one function. It seems  that a small 
</I>&gt;<i>refactoring would allow the parent to bind and a child to  do startReading, 
</I>&gt;<i>if the call to startReading was moved out of  startListening. The reactor 
</I>&gt;<i>calls would also need a small refactoring  to allow this type of setup. How 
</I>&gt;<i>does that sound?
</I>
The main problem that comes up with this approach is that little, or possibly
none, of Twisted is written to be fork-safe.  As with most programs, though,
this is /usually/ not a problem.  However, there are some areas where it can
be.  For example, if you use epoll reactor, the internal epoll file descriptor
may end up shared between the two processes.  This results in weird behavior
like thread wakeup messages in one process waking up the reactor thread in
the other process.  It's probably possible to fix all the problems like this,
but rather than try, I'd just not try forking a Twisted process without using
exec in one of the resulting processes shortly afterwards.

If you create a port in one process, you can just grab its fileno and pass
that to another process.  Then you can create a new Port object with that
fileno.  This may involve subclassing Port and overriding
createInternetSocket to just return the fileno you have already.  These APIs
aren't really intended for direct use by applications, but there's not really
another way to do what you want right now.  You may want to help us work out
a better API for creating Ports and such from pre-existing sockets if you go
this route so that there's less chance of some deep-down implementation
change disturbing your app.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051986.html">[Twisted-Python] Fork/Spawn children to accept connections on the	same port. 
</A></li>
	<LI>Next message (by thread): <A HREF="051961.html">[Twisted-Python] trac server error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51990">[ date ]</a>
              <a href="thread.html#51990">[ thread ]</a>
              <a href="subject.html#51990">[ subject ]</a>
              <a href="author.html#51990">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
