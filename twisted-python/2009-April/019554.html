<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] subclassing and mixing	protocol.ReconnectingClientFactory and pb.PBClientFactory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20subclassing%20and%20mixing%0A%09protocol.ReconnectingClientFactory%20and%20pb.PBClientFactory&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019553.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] subclassing and mixing	protocol.ReconnectingClientFactory and pb.PBClientFactory</H1>
    <B>Fabrizio Mancini</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20subclassing%20and%20mixing%0A%09protocol.ReconnectingClientFactory%20and%20pb.PBClientFactory&In-Reply-To="
       TITLE="[Twisted-Python] subclassing and mixing	protocol.ReconnectingClientFactory and pb.PBClientFactory">mr.file at gmail.com
       </A><BR>
    <I>Thu Apr 30 17:03:06 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019553.html">[Twisted-Python] cx_Oracle, Twisted - rollback failed
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19554">[ date ]</a>
              <a href="thread.html#19554">[ thread ]</a>
              <a href="subject.html#19554">[ subject ]</a>
              <a href="author.html#19554">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
i've implemented a pb client by writing a class which inherits from
object and a class which inherits from ReconnectingClientFactory and
PBClientFactory.
Till now it's all ok, the client detects the disconnection and try to
reconnect with an exponential delay if the connection is not
immediatly reestabilished.
The calls to the callRemote(&quot;get_item&quot;) method are repetitive, but for
sake of simplicity i've cut off the code that controls if there is
already another call running.
The problem:
i'd like to manage something like the clientConnectionMade method when
the client reconnect (thanks to the ReconnectingClientFactory) after a
disconnection and launch again the MypbClient.connect() method as i do
in the &quot;if __name__ &quot; statement, but i can't guess how to do it.
This is the code i'm using.
Thanks in advanche, any help appreciated, and hope to have been clear enough
Fabrizio

class MypbClient(object):

&#160; &#160;def __init__(self):
&#160; &#160; &#160; &#160;self.clientfactory = MypbClientFactory()
&#160; &#160; &#160; &#160;self._scheduledCall] = task.LoopingCall(self.get_item)
&#160; &#160; &#160; &#160;self._scheduledCall].start(10, False)

&#160; &#160;def connect(self):
&#160; &#160; &#160; &#160;reactor.connectTCP(server_ip, server_port, self.clientfactory)
&#160; &#160; &#160; &#160;self.rootObj = self.clientfactory.getRootObject()
&#160; &#160; &#160; &#160;self.rootObj.addCallback(self.initiateChain).addErrback(self._eb)

&#160; &#160;def initiateChain(self, broker):
&#160; &#160; &#160; &#160;self.broker = broker
&#160; &#160; &#160; &#160;self.d = self.broker.callRemote(&quot;get_item&quot;)
&#160; &#160; &#160; &#160;self.d.addCallback(self.got_item).addErrback(self._eb)

&#160; &#160;def get_item(self, result):
&#160; &#160; &#160; &#160;self.d = self.broker.callRemote(&quot;get_item&quot;)
&#160; &#160; &#160; &#160;self.d.addCallback(self.got_item).addErrback(self._eb)

&#160; &#160;def got_item(self, record):
&#160; &#160; &#160; &#160;self.op = doSomethingWith(record) #returns a deferred

class MypbClientFactory(pb.PBClientFactory, protocol.ReconnectingClientFactory):
&#160; &#160;def __init__(self):
&#160; &#160; &#160; &#160;pb.PBClientFactory.__init__(self)

&#160; &#160;def clientConnectionMade(self, broker):
&#160; &#160; &#160; &#160;self.resetDelay()
&#160; &#160; &#160; &#160;pb.PBClientFactory.clientConnectionMade(self, broker)

&#160; &#160;def clientConnectionFailed(self, connector, reason):
&#160; &#160; &#160; &#160;pb.PBClientFactory.clientConnectionFailed(self, connector, reason)
&#160; &#160; &#160; &#160;if self.continueTrying:
&#160; &#160; &#160; &#160; &#160; &#160;self.connector = connector
&#160; &#160; &#160; &#160; &#160; &#160;self.retry()

&#160; &#160;def clientConnectionLost(self, connector, reason, reconnecting=1):
&#160; &#160; &#160; &#160;pb.PBClientFactory.clientConnectionLost(self, connector,
reason, reconnecting=reconnecting)
&#160; &#160; &#160; &#160;protocol.ReconnectingClientFactory.clientConnectionLost(self,
connector, reason)

if __name__ == &quot;__main__&quot;:
&#160; &#160;dpc = MypbClient()
&#160; &#160;dpc.connect()
&#160; &#160;reactor.run()


</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019553.html">[Twisted-Python] cx_Oracle, Twisted - rollback failed
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19554">[ date ]</a>
              <a href="thread.html#19554">[ thread ]</a>
              <a href="subject.html#19554">[ subject ]</a>
              <a href="author.html#19554">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
