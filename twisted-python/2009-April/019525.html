<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Transparent pooling of deferreds to be fired upon	another deferred firing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Transparent%20pooling%20of%20deferreds%20to%20be%20fired%20upon%0A%09another%20deferred%20firing&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019522.html">
   <LINK REL="Next"  HREF="019523.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Transparent pooling of deferreds to be fired upon	another deferred firing</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Transparent%20pooling%20of%20deferreds%20to%20be%20fired%20upon%0A%09another%20deferred%20firing&In-Reply-To="
       TITLE="[Twisted-Python] Transparent pooling of deferreds to be fired upon	another deferred firing">terry at jon.es
       </A><BR>
    <I>Thu Apr 23 13:00:35 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019522.html">[Twisted-Python] Transparent pooling of deferreds to be fired upon	another deferred firing
</A></li>
        <LI>Next message: <A HREF="019523.html">[Twisted-Python] Re: Transparent pooling of deferreds to be fired	upon another
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19525">[ date ]</a>
              <a href="thread.html#19525">[ thread ]</a>
              <a href="subject.html#19525">[ subject ]</a>
              <a href="author.html#19525">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>BTW, below is a version of my code from yesterday that works on class
methods.  I didn't write the __get__ code, but took it from a decorator
tutorial on the web.

This version works with standalone functions, and with class methods that
also use @inlineCallbacks.  So you can do

    class MyClass(object):
        @DeferredPooler
        @defer.inlineCallbacks
        def xxx(self, ...):
            d = funcReturningADeferred()
            d.addCallbacks(...)
            yield d

and it works.  I also wrote a small test suite in case anyone wants it.
There are still some issues (e.g., with timeouts), but I've decorated some
methods with DeferredPooler and am happy with the result so far.

Terry


    from twisted.internet import defer
    from twisted.python import failure

    class DeferredPooler(object):
        def __init__(self, func):
            self.pool = {}
            self.func = func

        def _callOthers(self, result, key):
            if isinstance(result, failure.Failure):
                for d in self.pool[key]:
                    d.errback(result)
            else:
                for d in self.pool[key]:
                    d.callback(result)
            del self.pool[key]
            return result

        def __call__(self, *args, **kwargs):
            key = (args, hash(tuple(sorted(kwargs.items()))))
            if key in self.pool:
                d = defer.Deferred()
                self.pool[key].append(d)
                return d
            else:
                self.pool[key] = []
                d = self.func(*args, **kwargs)
                assert isinstance(d, defer.Deferred)
                d.addBoth(self._callOthers, key)
                return d

        def __get__(self, obj, type=None):
            if obj is None:
                return self
            new_func = self.func.__get__(obj, type)
            return self.__class__(new_func)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019522.html">[Twisted-Python] Transparent pooling of deferreds to be fired upon	another deferred firing
</A></li>
	<LI>Next message: <A HREF="019523.html">[Twisted-Python] Re: Transparent pooling of deferreds to be fired	upon another
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19525">[ date ]</a>
              <a href="thread.html#19525">[ thread ]</a>
              <a href="subject.html#19525">[ subject ]</a>
              <a href="author.html#19525">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
