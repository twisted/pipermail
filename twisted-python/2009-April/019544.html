<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] deferToThread help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20deferToThread%20help&In-Reply-To=b804d5d90904291145p62c3a53sa4df770001d3eb8a%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019543.html">
   <LINK REL="Next"  HREF="019545.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] deferToThread help</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20deferToThread%20help&In-Reply-To=b804d5d90904291145p62c3a53sa4df770001d3eb8a%40mail.gmail.com"
       TITLE="[Twisted-Python] deferToThread help">exarkun at divmod.com
       </A><BR>
    <I>Wed Apr 29 15:02:33 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019543.html">[Twisted-Python] deferToThread help
</A></li>
        <LI>Next message: <A HREF="019545.html">[Twisted-Python] Catching exception on a Serial Connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19544">[ date ]</a>
              <a href="thread.html#19544">[ thread ]</a>
              <a href="subject.html#19544">[ subject ]</a>
              <a href="author.html#19544">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 29 Apr 2009 11:45:09 -0700, Minesh Patel &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">minesh at gmail.com</A>&gt; wrote:
&gt;<i>Sorry if this is a newbie question.
</I>&gt;<i>
</I>&gt;<i>I have a blocking function that I defer to thread, let's say 'foo' and
</I>&gt;<i>I would like to add a callback that gets called after say 10 minues
</I>&gt;<i>after Thread finishes
</I>&gt;<i>
</I>&gt;<i>def foo():
</I>&gt;<i>   # Blocks for a while
</I>&gt;<i>
</I>&gt;<i>def bar():
</I>&gt;<i>   # Do some stuff
</I>&gt;<i>
</I>&gt;<i>d = threads.deferToThread(foo)
</I>&gt;<i>d.addCallback(bar) # How can I add timing to the callback???
</I>&gt;<i>
</I>&gt;<i>Currently I have the following code which works but doesn't account
</I>&gt;<i>for the threads execution time:
</I>&gt;<i>
</I>&gt;<i>reactor.callInThread(self.bootIso, self.iloIp, pathToIsoRename)
</I>&gt;<i># 10 minutes sleep
</I>&gt;<i>d = task.deferLater(reactor, 600, bar)
</I>&gt;<i>
</I>
You just need to combine the relevant parts of these two solutions.  First,
the deferToThread call which will let you know when the task in the thread
has completed (this is not when the thread exits, because deferToThread uses
a thread pool and threads are re-used for many tasks):

    fooComplete = deferToThread(foo)

Next, when `foo&#180; is finished, you want to wait 10 minutes.  You had the
right idea with deferLater, but you don't want to call it until `foo&#180; is
finished:

    def waitTenMinutes(result):
        return deferLater(reactor, 600, lambda: result)
    fooComplete.addCallback(waitTenMinutes)

Finally, after a ten minute delay, you want to call `bar&#180;:

    fooComplete.addCallback(bar)

Since a Deferred has a chain of callbacks which are called one after the
other, and since return a Deferred from a callback causes things to wait
for the result of that new Deferred before moving on to the next callback
in the original chain, combining deferToThread, deferLater, and bar as
above will give you the desired behavior.

Jean-Paul


</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019543.html">[Twisted-Python] deferToThread help
</A></li>
	<LI>Next message: <A HREF="019545.html">[Twisted-Python] Catching exception on a Serial Connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19544">[ date ]</a>
              <a href="thread.html#19544">[ thread ]</a>
              <a href="subject.html#19544">[ subject ]</a>
              <a href="author.html#19544">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
