<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted compatibility with multiprocessing	module in fork+execv mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20compatibility%20with%20multiprocessing%0A%09module%20in%20fork%2Bexecv%20mode&In-Reply-To=%3CF65BE466-9174-4670-A343-95498CF7E9AD%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted compatibility with multiprocessing	module in fork+execv mode</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20compatibility%20with%20multiprocessing%0A%09module%20in%20fork%2Bexecv%20mode&In-Reply-To=%3CF65BE466-9174-4670-A343-95498CF7E9AD%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] twisted compatibility with multiprocessing	module in fork+execv mode">glyph at twistedmatrix.com
       </A><BR>
    <I>Sat Oct  3 05:07:03 MDT 2015</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62236">[ date ]</a>
              <a href="thread.html#62236">[ thread ]</a>
              <a href="subject.html#62236">[ subject ]</a>
              <a href="author.html#62236">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Sep 30, 2015, at 03:25, Flavio Grossi &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">fgrossi at voismart.it</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> I know the multiprocessing module is not properly supported by twisted apps because of the interactions among duplicated file descriptors and signal handling, as discussed other times.
</I>
To be fair, the multiprocessing module has most of these issues by itself :-).  The main reason Twisted didn't work with things like multiprocessing in the past was the fact that we didn't pass SA_RESTART to the SIGCHLD handler, and that has long since been resolved; you can now fork, os.system, popen, and multiprocess more or less like you can in any other Python program.

&gt;<i> But python 3.4 introduces a new mode to use that module by spawning (i.e. fork() followed by execv()) the new processes instead of simply forking it.
</I>
That is a definite improvement and will be far more reliable.

&gt;<i> So my question is how supported this is by twisted, and in general how safe it is to use subprocesses created by duplicating the parent immediately followed by the execv of a fresh interpreter.
</I>
This is what Twisted would do if it were spawning a subprocess, so... safe enough.

&gt;<i> What i'm thinking is something like this, to asynchronously process requests and delegate the cpu-bound work to some processes:
</I>
This will probably work, but it still has the drawbacks of multiprocessing:

1. you will be serializing 'work' via pickle, which is fraught with problems,
2. you will have no way to tell when 'work' has completed, so you will easily overload all of your worker processes under heavy load.

Instead, using something like ampoule &lt;<A HREF="https://pypi.python.org/pypi/ampoule">https://pypi.python.org/pypi/ampoule</A> &lt;<A HREF="https://pypi.python.org/pypi/ampoule">https://pypi.python.org/pypi/ampoule</A>&gt;&gt; would allow you to use twisted's spawnProcess facility to send and receive data via a more reliable serialization mechanism than pickle, and get straightforward feedback (Deferreds firing with results) when work is complete.

In fairness, even doing this with ampoule is altogether too much boilerplate, and we should probably have something for quick-and-dirty multiprocessing like a 'deferToProcess' that just uses pickle and presents a similarly convenient API, spawning python interpreters as necessary behind the scenes.  So I can understand why you're looking at multiprocessing; all I can tell you for now is that it is probably worth setting up all the necessary infrastructure to do this the &quot;right way&quot; because it will be more reliable and you will rapidly need to expand to do bi-directional communication.

Thanks for using Twisted,

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20151003/a60853f4/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62236">[ date ]</a>
              <a href="thread.html#62236">[ thread ]</a>
              <a href="subject.html#62236">[ subject ]</a>
              <a href="author.html#62236">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
