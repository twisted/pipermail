<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Deprecate and remove t.internet.ssl.DistinguishedName ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Deprecate%20and%20remove%0A%20t.internet.ssl.DistinguishedName%20%3F&In-Reply-To=%3C73629A0D-81A0-4C87-B110-5FEC2F4D25EE%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065128.html">
   <LINK REL="Next"  HREF="065121.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Deprecate and remove t.internet.ssl.DistinguishedName ?</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Deprecate%20and%20remove%0A%20t.internet.ssl.DistinguishedName%20%3F&In-Reply-To=%3C73629A0D-81A0-4C87-B110-5FEC2F4D25EE%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Deprecate and remove t.internet.ssl.DistinguishedName ?">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Jun  3 00:38:14 MDT 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065128.html">[Twisted-Python] log.callWithLogger not used - slows down reactor?
</A></li>
        <LI>Next message (by thread): <A HREF="065121.html">[Twisted-Python] [RFC] Drop support for Python 3.5 sometime after May 2021?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65120">[ date ]</a>
              <a href="thread.html#65120">[ thread ]</a>
              <a href="subject.html#65120">[ subject ]</a>
              <a href="author.html#65120">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

&gt;<i> On May 29, 2020, at 11:16 PM, Wim Lewis &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">wiml at hhhh.org</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> I'm looking at a fix for bug &lt;<A HREF="https://twistedmatrix.com/trac/ticket/9804">https://twistedmatrix.com/trac/ticket/9804</A>&gt;
</I>&gt;<i> (Cannot load a PEM certificate with Unicode in subject). The underlying
</I>&gt;<i> problem is that the DistinguishedName class can't handle non-ascii AVAs.
</I>&gt;<i> The fix I've made simply avoids creating DistinguishedName instances when
</I>&gt;<i> it isn't necessary, but that leaves the question of what to do with the
</I>&gt;<i> class. I think that the best thing to do is to deprecate the class
</I>&gt;<i> entirely and replace it with simpler API. 
</I>
Thanks for checking in about this!

&gt;<i> Reasons I think that the DN class is broken:
</I>&gt;<i>  - The values in a certificate are conceptually text-strings, not
</I>&gt;<i>    byte strings; they may be in ASCII, UTF8, UTF16, or several
</I>&gt;<i>    other encodings. However
</I>&gt;<i>    - DN represents these textual values as `bytes` instead of `str`
</I>&gt;<i>    - DN can't handle non-ASCII-representable values at all, even if
</I>&gt;<i>      the user never tries to access that value
</I>&gt;<i>  - It can only handle a subset of the attribute-assertions found in
</I>&gt;<i>    a PKIX DN; there's no escape hatch for others (e.g. OID keys or
</I>&gt;<i>    whatever)
</I>&gt;<i>  - It can't represent the full structure of a DN (specific ordering,
</I>&gt;<i>    multiple-value RDNs, AVAs whos values aren't textual, etc.) ---
</I>&gt;<i>    these are not common in the PKIX world but they are valid
</I>
Ugh.  I wrote this class where I knew literally nothing about TLS, and really just wanted it to be the thing it effectively is to the user (i.e. &quot;connect to a hostname&quot;) rather than the thing it actually is (a tarpit of unnecessarily complex asn.1 nonsense).

Additionally, this was when pyOpenSSL was unmaintained and buggy as hell and X509Name would segfault when you so much as sneezed at it right.

&gt;<i> What I propose as an alternative:
</I>&gt;<i>  - Replace APIs that take `DistinguishedName` classes with ones that take
</I>&gt;<i>    `Union[OpenSSL.crypto.X509Name, dict]` where the `dict` format is parsed
</I>&gt;<i>    with the same convenience semantics as DistinguishedName, except that
</I>&gt;<i>    values are `str`
</I>&gt;<i>  - Replace APIs that return `DistinguishedName` with ones that return
</I>&gt;<i>    OpenSSL.crypto.X509Name, which is already fairly convenient to use
</I>&gt;<i>    (e.g. it has attributes for retrieving/setting commonName
</I>&gt;<i>    and so on without dealing with the full complexity of X.500 names)
</I>&gt;<i>  - Deprecate `DistinguishedName` and the APIs that use it for eventual removal
</I>&gt;<i>  - Expose a convenience function for the dict -&gt; X509Name transform
</I>&gt;<i> 
</I>&gt;<i> Any objections? Thoughts on how I should go about doing this? Should I
</I>&gt;<i> do it as part of this Trac ticket or split it out?
</I>&gt;<i> 
</I>&gt;<i> The only downside I can think of is that this exposes the
</I>&gt;<i> OpenSSL.crypto.X509Name type as part of Twisted's API. I don't think
</I>&gt;<i> this is a huge reduction in flexibility --- Twisted's API already somewhat
</I>&gt;<i> assumes that TLS is implemented using OpenSSL, and only users whose needs
</I>&gt;<i> are *already* not well met by DistinguishedName will care if that `Union`
</I>&gt;<i> type changes in the future.
</I>
We've been slowly trying to paper over the aspects of the API that expose OpenSSL details and provide a more complete abstraction for years.  We are not there yet, as you observe!  We do still somewhat assume TLS uses OpenSSL.  But I really want to get away from that; I want to be able to use SChannel on Windows and Network.framework on macOS and provide a nice abstraction that floats above that.  This means - particularly in the latter case - not just eliminating the OpenSSL dependency, but actually adding new APIs that allow some pluggability on the reactor itself to allow for combining higher-level protocols together in the reactor itself.  (Maybe even HTTP, given the way that NSURLSession seems to want to provide HTTP3 as a platform service directly, skipping sockets and indeed TCP and TLS entirely...)

In a nearer-term, more practical way that we might leverage this soon, is a &quot;lite&quot; TLS provider that uses the stdlib's SSLSocket rather than all of pyOpenSSL; this would substantially reduce the dependency weight of Twisted on embedded platforms (for example, you can get the built-in SSL module in a context like <A HREF="https://omz-software.com/pythonista/">https://omz-software.com/pythonista/</A> &lt;<A HREF="https://omz-software.com/pythonista/">https://omz-software.com/pythonista/</A>&gt; but there's no way to get cryptography &amp; pyOpenSSL at all).

One success story on this front is optionsForClientTLS().  Hopefully one day in the not too distant future we can get an optionsForServerTLS and slowly hide CertificateOptions underneath it.

So I would see this refactoring as an opportunity to move further away from pyOpenSSL dependency rather than further towards it.  I'm all for deprecating &quot;DN&quot;, it's a terrible wrapper, but I think we could have a better wrapper.

That said; if abstracting this stuff away is really challenging, and you already have a fix close to ready to go, we can always evolve the API again when we do this for real, and have an actual second backend to prove the interface against.

-glyph


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20200602/c39481ca/attachment.htm&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065128.html">[Twisted-Python] log.callWithLogger not used - slows down reactor?
</A></li>
	<LI>Next message (by thread): <A HREF="065121.html">[Twisted-Python] [RFC] Drop support for Python 3.5 sometime after May 2021?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65120">[ date ]</a>
              <a href="thread.html#65120">[ thread ]</a>
              <a href="subject.html#65120">[ subject ]</a>
              <a href="author.html#65120">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
