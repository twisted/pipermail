<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Changing supported configurations regarding Unicode handling on Windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Changing%20supported%20configurations%20regarding%0A%20Unicode%20handling%20on%20Windows&In-Reply-To=%3C7f1b79da-882a-2f10-5109-b35e0462ebfa%40atleastfornow.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065139.html">
   <LINK REL="Next"  HREF="065147.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Changing supported configurations regarding Unicode handling on Windows</H1>
    <B>Amber Brown (hawkowl)</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Changing%20supported%20configurations%20regarding%0A%20Unicode%20handling%20on%20Windows&In-Reply-To=%3C7f1b79da-882a-2f10-5109-b35e0462ebfa%40atleastfornow.net%3E"
       TITLE="[Twisted-Python] Changing supported configurations regarding Unicode handling on Windows">hawkowl at atleastfornow.net
       </A><BR>
    <I>Fri Jun 19 05:37:21 MDT 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065139.html">[Twisted-Python] mypy: class ThreadPool has workers redefined
</A></li>
        <LI>Next message (by thread): <A HREF="065147.html">[Twisted-Python] Changing supported configurations regarding Unicode handling on Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65140">[ date ]</a>
              <a href="thread.html#65140">[ thread ]</a>
              <a href="subject.html#65140">[ subject ]</a>
              <a href="author.html#65140">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

The past week or so, I noticed failures in the Azure Pipelines CI (see 
<A HREF="https://github.com/twisted/twisted/pull/1278">https://github.com/twisted/twisted/pull/1278</A> for the ticket with them, 
among others) that were due to Python + Windows falling apart on 
mgorny's name. After some debugging, I ascertained:

- The environment has Unicode strings in it (because environments are 
Unicode on Windows)
- but sys.stdout.encoding is cp1252 -- 
<A HREF="https://www.python.org/dev/peps/pep-0528/">https://www.python.org/dev/peps/pep-0528/</A> does not apply due to it being 
a non-interactive console
- One of the characters in the environment is not printable under 
cp1252, which causes an exception.

I think we should avoid running under ANSI-mode by default at all costs, 
since it causes non-obvious bugs like this (`print(os.environ)` causing 
an exception). This would also bring Windows in line with UNIX, where we 
basically assume a non-UTF-8 locale is more or less broken by design and 
we don't run the tests on it.

It also seems like Windows is heading in the direction of having console 
output be CP65001 (aka UTF-8), so I think this is a reasonable direction 
to go in as well. [1] [2] [3]

PEP-528 makes sys.stdout/sys.stdin use the W (&quot;wide&quot;, aka UTF-16LE) 
APIs, as it's assumed that a human is on the other side of the console. 
For compatibility, it will encode Unicode to UTF-8, pass it to 
WindowsConsoleIO, which will then decode it into UTF-16 and pass it to 
the console, meaning that writing raw UTF-8 bytes to sys.stdout.buffer 
works as you'd expect on Windows and UNIXes. We can enable UTF-8 text 
output universally with the environment variable 
`PYTHONIOENCODING=utf8:surrogateescape`. If a user wants ANSI output, 
they can use the &quot;PYTHONLEGACYWINDOWSSTDIO&quot; environment to make Python 
not perform the Unicode conversions for the console, so we could perhaps 
use this too, if someone is SURE they want ANSI output.

Python 3.7 has PEP-540's `-X utf8` mode, which also does this, more or 
less, but in a nicer way (no environment variables).

Python 3.5 doesn't seem to work with either of these options. Not sure 
why. Maybe it's busted.

So, due to this, I would like to propose the following:

- On Windows, raising a deprecation warning when sys.stdout and 
sys.stderr are not UTF-8 AND the environment variable 
&quot;PYTHONLEGACYWINDOWSSTDIO&quot; is not set.
- Declaring said environments unsupported and running our tests with -X 
utf8/PYTHONIOENCODING=utf8 or PYTHONLEGACYWINDOWSSTDIO (which will 
require some Unicode tests which fail because CP1252 is bad to be skipped).
- After the deprecation period, start issuing loud RuntimeWarnings 
saying that you're probably not doing the thing you want to be doing.

Opinions?

- Amber

[1] 
<A HREF="https://devblogs.microsoft.com/commandline/windows-command-line-unicode-and-utf-8-output-text-buffer/">https://devblogs.microsoft.com/commandline/windows-command-line-unicode-and-utf-8-output-text-buffer/</A>
[2] 
<A HREF="https://docs.microsoft.com/en-us/dotnet/api/system.text.encoding.default?view=netcore-3.1#the-default-property-on-net-core">https://docs.microsoft.com/en-us/dotnet/api/system.text.encoding.default?view=netcore-3.1#the-default-property-on-net-core</A>
[3] 
<A HREF="https://docs.microsoft.com/en-us/windows/uwp/design/globalizing/use-utf8-code-page">https://docs.microsoft.com/en-us/windows/uwp/design/globalizing/use-utf8-code-page</A>

</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065139.html">[Twisted-Python] mypy: class ThreadPool has workers redefined
</A></li>
	<LI>Next message (by thread): <A HREF="065147.html">[Twisted-Python] Changing supported configurations regarding Unicode handling on Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65140">[ date ]</a>
              <a href="thread.html#65140">[ thread ]</a>
              <a href="subject.html#65140">[ subject ]</a>
              <a href="author.html#65140">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
