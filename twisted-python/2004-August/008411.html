<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] zpkg usage in Twisted (was: including plugins.tml	in a package?)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20zpkg%20usage%20in%20Twisted%20%28was%3A%20including%20plugins.tml%0A%09in%20a%20package%3F%29&In-Reply-To=200408162250.35027.fdrake%40acm.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008410.html">
   <LINK REL="Next"  HREF="008429.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] zpkg usage in Twisted (was: including plugins.tml	in a package?)</H1>
    <B>Christopher Armstrong</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20zpkg%20usage%20in%20Twisted%20%28was%3A%20including%20plugins.tml%0A%09in%20a%20package%3F%29&In-Reply-To=200408162250.35027.fdrake%40acm.org"
       TITLE="[Twisted-Python] zpkg usage in Twisted (was: including plugins.tml	in a package?)">radeex at gmail.com
       </A><BR>
    <I>Mon Aug 16 23:43:08 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008410.html">[Distutils] Re: [Twisted-Python] including plugins.tml in a	package
</A></li>
        <LI>Next message: <A HREF="008429.html">[Twisted-Python] including plugins.tml in a package
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8411">[ date ]</a>
              <a href="thread.html#8411">[ thread ]</a>
              <a href="subject.html#8411">[ subject ]</a>
              <a href="author.html#8411">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 16 Aug 2004 22:50:35 -0400, Fred L. Drake, Jr. &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">fdrake at acm.org</A>&gt; wrote:
&gt;<i> It just struck me that you cross-posted from the Twisted list; Twisted is
</I>&gt;<i> moving to use the &quot;zpkg&quot; tool I wrote for Zope 3 for packaging.  zpkg
</I>&gt;<i> automatically makes data files from a package part of the installation of
</I>&gt;<i> that package if you don't tell it to do something different with them.
</I>&gt;<i> 
</I>&gt;<i> Information about zpkg is available at:
</I>&gt;<i> 
</I>&gt;<i>     <A HREF="http://www.zope.org/Members/fdrake/zpkgtools/">http://www.zope.org/Members/fdrake/zpkgtools/</A>
</I>&gt;<i> 
</I>&gt;<i> I'll be glad to answer questions and generally try to improve the
</I>&gt;<i> documentation to make zpkg easier to learn and use.
</I>
And here my cue to start asking questions. :-)

Fred, our setup.py is pretty scary. It's full of hacks specific to
various platforms, etc. I'll list all those which confuse me here and
hopefully you can tell me the best way to port this stuff to zpkg --
whether zpkg handles it already or if I need to extend the way it
calls distutils (and how I can do that).

(in order that they appear in our setup.py)
1) build_scripts_twisted
2) build_ext_twisted
3) OS-X gcc arguments hack
4) WIN32 macro

1) build_scripts_twisted

class build_scripts_twisted(build_scripts):
    &quot;&quot;&quot;Renames scripts so they end with '.py' on Windows.&quot;&quot;&quot;

    def run(self):
        build_scripts.run(self)
        if os.name == &quot;nt&quot;:
            for f in os.listdir(self.build_dir):
                fpath=os.path.join(self.build_dir, f)
                if not fpath.endswith(&quot;.py&quot;):
                    try:
                        os.unlink(fpath + &quot;.py&quot;)
                    except EnvironmentError, e:
                        if e.args[1]=='No such file or directory':
                            pass
                    os.rename(fpath, fpath + &quot;.py&quot;)

2) build_ext_twisted

This is a doozy. As the name implies, it's a subclass of build_ext. It
overrides build_extensions to call self._detect_modules before calling
the regular build_extensions; _detect_modules does a bunch of compiler
tests, conditionally adding things to self.extensions.

The tests generate .c file that uses CPP directives to test for the
existence of header files and names from those headers. Oh, and one
that checks for a struct member (yow). It uses self.compiler.compile
to run these through the compiler and checks for a CompileError.

3) OS-X GCC arguments hack

# Apple distributes a nasty version of Python 2.2 w/ all release builds of
# OS X 10.2 and OS X Server 10.2
BROKEN_CONFIG = '2.2 (#1, 07/14/02, 23:25:09) \n[GCC Apple cpp-precomp 6.14]'
if sys.platform == 'darwin' and sys.version == BROKEN_CONFIG:
    # change this to 1 if you have some need to compile
    # with -flat_namespace as opposed to -bundle_loader
    FLAT_NAMESPACE = 0
    BROKEN_ARCH = '-arch i386'
    BROKEN_NAMESPACE = '-flat_namespace -undefined_suppress'
    import distutils.sysconfig
    distutils.sysconfig.get_config_vars()
    x = distutils.sysconfig._config_vars['LDSHARED']
    y = x.replace(BROKEN_ARCH, '')
    if not FLAT_NAMESPACE:
        e = os.path.realpath(sys.executable)
        y = y.replace(BROKEN_NAMESPACE, '-bundle_loader ' + e)
    if y != x:
        print &quot;Fixing some of Apple's compiler flag mistakes...&quot;
        distutils.sysconfig._config_vars['LDSHARED'] = y


4) WIN32 macro

# always define WIN32 under Windows
if os.name == 'nt':
    define_macros = [(&quot;WIN32&quot;, 1)]
else:
    define_macros = []

I got no idea what this does.


Any idea how I should port these things to zpkg?

Thanks!

-- 
 Twisted | Christopher Armstrong: International Man of Twistery
  Radix  |          Release Manager,  Twisted Project
---------+            <A HREF="http://radix.twistedmatrix.com">http://radix.twistedmatrix.com</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008410.html">[Distutils] Re: [Twisted-Python] including plugins.tml in a	package
</A></li>
	<LI>Next message: <A HREF="008429.html">[Twisted-Python] including plugins.tml in a package
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8411">[ date ]</a>
              <a href="thread.html#8411">[ thread ]</a>
              <a href="subject.html#8411">[ subject ]</a>
              <a href="author.html#8411">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
