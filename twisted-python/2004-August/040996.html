<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Adding callback to a Deferred that's already	running?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Adding%20callback%20to%20a%20Deferred%20that%27s%20already%0A%09running%3F&In-Reply-To=%3C412E0BD0.8020004%40fettig.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="040995.html">
   <LINK REL="Next"  HREF="040999.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Adding callback to a Deferred that's already	running?</H1>
    <B>Abe Fettig</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Adding%20callback%20to%20a%20Deferred%20that%27s%20already%0A%09running%3F&In-Reply-To=%3C412E0BD0.8020004%40fettig.net%3E"
       TITLE="[Twisted-Python] Adding callback to a Deferred that's already	running?">abe at fettig.net
       </A><BR>
    <I>Thu Aug 26 10:12:00 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="040995.html">[Twisted-Python] Adding callback to a Deferred that's already	running?
</A></li>
        <LI>Next message (by thread): <A HREF="040999.html">[Twisted-Python] Re: Adding callback to a Deferred that's	already	running?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40996">[ date ]</a>
              <a href="thread.html#40996">[ thread ]</a>
              <a href="subject.html#40996">[ subject ]</a>
              <a href="author.html#40996">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Steve,

I'm all too familar with the situation you describe, and I've come up 
with a pattern that works well for me.  Here's how I would have written 
your example:

class XMLRPCResponseClass():
     def step1(self):
	finished = defer.Deferred()
	self.db.runQuery(blah).addCallback(
             self.step2, finished).addErrback(finished.errback)
         return finished

     def step2(self, result, finished):
         if result == 'yadda':
             finished.callback('This bit works')
         else:
             self.d.runOperation(blah).chainDeferred(finished)


It takes a while to really understand how Deferreds work, but I'll try 
to explain this example.  In step1, we create a new Deferred called 
'finished'.  This Deferred didn't come from a method we called; we 
created it from scratch.  This means that it won't be triggered 
automatically when some event finishes.  Instead, we have the freedom to 
call it whenever we want.

We then kick off the asyncronous operation self.db.runQuery.  We set up 
the callbacks as follows:

1. If runQuery completes successfully, call step2(), passing finished as 
an additional argument.
2. If runQuery fails, pass the error on to finished.

Then we return finished, our Deferred.  At this point finished.errback 
will get called if runQuery fails.  But what if runQuery succeeds?  That 
will be handled by step2.

In step2, we take the result of runQuery , as well as the 'finished' 
Deferred we created in step1.  Now we have the results of the first 
operation, as well as a reference to the deferred that was returned in 
step1.

If the result of runQuery was 'yadda', we callback finished with a 
successful value.  Otherwise, we kick of a second asyncronous operation, 
(self.d.runOperation) and chain the results to finished.  Remember that 
a.chainDeferred(b) doesn't do anything special, it's just shorthand for:

a.addCallback(b.callback)
a.addErrback(b.errback)

So the result is that finished ends up calling back or erring back with 
the results of self.d.runOperation, even though it wasn't bound to 
runOperation when it was first created.

The only thing to be careful of with this technique is that you have to 
make sure any operation that could possibly fail sends its error to 
finished.errback - otherwise finished will never be finished :-)

I hope that's helpful!  I'm happy to answer questions if you have any.

Abe

p.s. - It's possible there's a better way to do this sort of thing.  But 
I'm using the above technique extensively in Hep and Yarn without any 
problems.

Steve Freitas wrote:
&gt;&gt;<i>This wasn't spectacularly obvious to me the first time either, but I 
</I>&gt;&gt;<i>think it's covered somewhere in the deferred execution howto
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Ah ha! I think I figured it out. If I do this, it seems to work...
</I>&gt;<i> 
</I>&gt;<i> class XMLRPCResponseClass():
</I>&gt;<i>     def step1(self):
</I>&gt;<i>         self.d = self.db.runQuery(blah)
</I>&gt;<i>         self.d.addCallback(self.step2)
</I>&gt;<i>         return self.d
</I>&gt;<i> 
</I>&gt;<i>     def step2(self, query): # Here's where the change is
</I>&gt;<i>         if query == 'yadda':
</I>&gt;<i>           return 'This bit works'
</I>&gt;<i>         else:
</I>&gt;<i>           self.d = self.db.runOperation(blah) # Rebinding self.d to new
</I>&gt;<i>                                               # Deferred()
</I>&gt;<i>           self.d.addCallback(self.step3) # add callbacks to new one
</I>&gt;<i>           return self.d # And return ref to the new one
</I>&gt;<i>             
</I>&gt;<i>     def step3(self, data):
</I>&gt;<i>         return 'Now it gets here!'
</I>&gt;<i> 
</I>&gt;<i> The trick is that I need to add any subsequent callbacks to a new
</I>&gt;<i> deferred which I return from the function. Strangely (to me), if I try
</I>&gt;<i> using chainDeferred() instead of returning the new deferred from step2,
</I>&gt;<i> it fails with AlreadyCalled, which I don't yet understand, but that's
</I>&gt;<i> fine, 'cause this seems to work well enough.
</I>&gt;<i> 
</I>&gt;<i> I really like this technique because I don't have to use a big state
</I>&gt;<i> machine at the root level of the xmlrpc calls, or preassign possibly
</I>&gt;<i> unnecessary callbacks, or toss around callables as variables until I'm
</I>&gt;<i> thoroughly confused. Instead, it allows me to place all the
</I>&gt;<i> (client||server) state information for a given method call inside a
</I>&gt;<i> class instance which persists only until the xmlrpc method returns. And
</I>&gt;<i> multiple calls to this method while it's being simultaneously Deferred()
</I>&gt;<i> for other clients don't require any extra coding to handle, as I've got
</I>&gt;<i> one class instance per connection. Very clean, very well separated,
</I>&gt;<i> which is hard to figure out how to do with this wonderful framework.
</I>&gt;<i> Alright, I'll stop ranting now. :-) I still have to give this thing a
</I>&gt;<i> workout to make sure it does all I want it to.
</I>&gt;<i> 
</I>&gt;<i> Thanks for the help!
</I>&gt;<i> 
</I>&gt;<i> Steve
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> 
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="040995.html">[Twisted-Python] Adding callback to a Deferred that's already	running?
</A></li>
	<LI>Next message (by thread): <A HREF="040999.html">[Twisted-Python] Re: Adding callback to a Deferred that's	already	running?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40996">[ date ]</a>
              <a href="thread.html#40996">[ thread ]</a>
              <a href="subject.html#40996">[ subject ]</a>
              <a href="author.html#40996">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
