<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Adding callback to a Deferred that's already	running?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Adding%20callback%20to%20a%20Deferred%20that%27s%20already%0A%09running%3F&In-Reply-To=%3C1093531734.10911.18.camel%40ibook%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="040993.html">
   <LINK REL="Next"  HREF="040996.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Adding callback to a Deferred that's already	running?</H1>
    <B>Steve Freitas</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Adding%20callback%20to%20a%20Deferred%20that%27s%20already%0A%09running%3F&In-Reply-To=%3C1093531734.10911.18.camel%40ibook%3E"
       TITLE="[Twisted-Python] Adding callback to a Deferred that's already	running?">sflist at ihonk.com
       </A><BR>
    <I>Thu Aug 26 09:07:25 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="040993.html">[Twisted-Python] Adding callback to a Deferred that's already	running?
</A></li>
        <LI>Next message (by thread): <A HREF="040996.html">[Twisted-Python] Adding callback to a Deferred that's already	running?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40995">[ date ]</a>
              <a href="thread.html#40995">[ thread ]</a>
              <a href="subject.html#40995">[ subject ]</a>
              <a href="author.html#40995">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> This wasn't spectacularly obvious to me the first time either, but I 
</I>&gt;<i> think it's covered somewhere in the deferred execution howto
</I>
Ah ha! I think I figured it out. If I do this, it seems to work...

class XMLRPCResponseClass():
    def step1(self):
        self.d = self.db.runQuery(blah)
        self.d.addCallback(self.step2)
        return self.d

    def step2(self, query): # Here's where the change is
        if query == 'yadda':
          return 'This bit works'
        else:
          self.d = self.db.runOperation(blah) # Rebinding self.d to new
                                              # Deferred()
          self.d.addCallback(self.step3) # add callbacks to new one
          return self.d # And return ref to the new one
            
    def step3(self, data):
        return 'Now it gets here!'

The trick is that I need to add any subsequent callbacks to a new
deferred which I return from the function. Strangely (to me), if I try
using chainDeferred() instead of returning the new deferred from step2,
it fails with AlreadyCalled, which I don't yet understand, but that's
fine, 'cause this seems to work well enough.

I really like this technique because I don't have to use a big state
machine at the root level of the xmlrpc calls, or preassign possibly
unnecessary callbacks, or toss around callables as variables until I'm
thoroughly confused. Instead, it allows me to place all the
(client||server) state information for a given method call inside a
class instance which persists only until the xmlrpc method returns. And
multiple calls to this method while it's being simultaneously Deferred()
for other clients don't require any extra coding to handle, as I've got
one class instance per connection. Very clean, very well separated,
which is hard to figure out how to do with this wonderful framework.
Alright, I'll stop ranting now. :-) I still have to give this thing a
workout to make sure it does all I want it to.

Thanks for the help!

Steve



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="040993.html">[Twisted-Python] Adding callback to a Deferred that's already	running?
</A></li>
	<LI>Next message (by thread): <A HREF="040996.html">[Twisted-Python] Adding callback to a Deferred that's already	running?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40995">[ date ]</a>
              <a href="thread.html#40995">[ thread ]</a>
              <a href="subject.html#40995">[ subject ]</a>
              <a href="author.html#40995">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
