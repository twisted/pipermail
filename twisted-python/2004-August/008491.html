<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: Adding callback to a Deferred that's	already	running?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Adding%20callback%20to%20a%20Deferred%20that%27s%0A%09already%09running%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008488.html">
   <LINK REL="Next"  HREF="008495.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: Adding callback to a Deferred that's	already	running?</H1>
    <B>David Bolen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Adding%20callback%20to%20a%20Deferred%20that%27s%0A%09already%09running%3F&In-Reply-To="
       TITLE="[Twisted-Python] Re: Adding callback to a Deferred that's	already	running?">db3l at fitlinxx.com
       </A><BR>
    <I>Thu Aug 26 14:26:13 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008488.html">[Twisted-Python] Adding callback to a Deferred that's already	running?
</A></li>
        <LI>Next message: <A HREF="008495.html">[Twisted-Python] Re: Adding callback to a Deferred that's	already	running?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8491">[ date ]</a>
              <a href="thread.html#8491">[ thread ]</a>
              <a href="subject.html#8491">[ subject ]</a>
              <a href="author.html#8491">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Abe Fettig &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">abe at fettig.net</A>&gt; writes:

&gt;<i> Steve,
</I>&gt;<i> 
</I>&gt;<i> I'm all too familar with the situation you describe, and I've come up
</I>&gt;<i> with a pattern that works well for me.  Here's how I would have
</I>&gt;<i> written your example:
</I>&gt;<i> 
</I>&gt;<i> class XMLRPCResponseClass():
</I>&gt;<i>      def step1(self):
</I>&gt;<i> 	finished = defer.Deferred()
</I>&gt;<i> 	self.db.runQuery(blah).addCallback(
</I>&gt;<i>              self.step2, finished).addErrback(finished.errback)
</I>&gt;<i>          return finished
</I>&gt;<i> 
</I>&gt;<i>      def step2(self, result, finished):
</I>&gt;<i>          if result == 'yadda':
</I>&gt;<i>              finished.callback('This bit works')
</I>&gt;<i>          else:
</I>&gt;<i>              self.d.runOperation(blah).chainDeferred(finished)
</I>
I'm not sure I follow the need for the extra deferred.  I would think
that the following would work just as well:

    class XMLRPCResponseClass():

         def step1(self):
            return self.db.runQuery(blah).addCallback(self.step2)

         def step2(self, result):
             if result == 'yadda':
                 return 'This bit works'
             else:
                 return self.db.runOperation(blah)


In this case, the primary deferred is the original runQuery.  The
first callback on that forwards you to step 2.  A failure would flow
up the errback chain which you don't process locally but leave to the
caller to handle.

In the success case, if you need to additionally process the result
you just return the new value (the 'yadda' test), otherwise you spin
off another deferred operation, returning that deferred from your
callback.  Returning a deferred within a callback is an implicit
chaining operation as Twisted will wait for that new deferred to
finish before taking its result and propagating it up the callback or
errback chain appropriately.

Remember that when you add your callbacks/errbacks you are in control
of the sequence of execution as the callback/errback chain fires, and
thus you'll always get control in advance of any other
callback/errbacks that callers who you return the same deferred to
might be attaching.  That, plus the implicit chaining Twisted permits
by an individual function in the callback/errback chain itself
returning a deferred is pretty flexible.  It's certainly been rare for
me to need my own internally generated deferred unless I was the root
of the deferrable operation.

-- David





</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008488.html">[Twisted-Python] Adding callback to a Deferred that's already	running?
</A></li>
	<LI>Next message: <A HREF="008495.html">[Twisted-Python] Re: Adding callback to a Deferred that's	already	running?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8491">[ date ]</a>
              <a href="thread.html#8491">[ thread ]</a>
              <a href="subject.html#8491">[ subject ]</a>
              <a href="author.html#8491">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
