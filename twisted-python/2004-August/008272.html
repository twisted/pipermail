<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: To thread or not to thread...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20To%20thread%20or%20not%20to%20thread...&In-Reply-To=305be882040802210750f26fab%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008266.html">
   <LINK REL="Next"  HREF="008276.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: To thread or not to thread...</H1>
    <B>Jonathan Lange</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20To%20thread%20or%20not%20to%20thread...&In-Reply-To=305be882040802210750f26fab%40mail.gmail.com"
       TITLE="[Twisted-Python] Re: To thread or not to thread...">jml at divmod.com
       </A><BR>
    <I>Tue Aug  3 01:29:48 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008266.html">[Twisted-Python] To thread or not to thread...
</A></li>
        <LI>Next message: <A HREF="008276.html">[Twisted-Python] Twisted O'Reilly Book
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8272">[ date ]</a>
              <a href="thread.html#8272">[ thread ]</a>
              <a href="subject.html#8272">[ subject ]</a>
              <a href="author.html#8272">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Britt Green wrote:
&gt;<i> I've been reading some of the online documentation for Twisted, and
</I>&gt;<i> I'm slowly starting to grasp different things. However, I could use
</I>&gt;<i> some help with one point. Suppose I was coding up a chat server, or
</I>&gt;<i> perhaps a MUD. Would I need to use something threaded, as opposed to
</I>&gt;<i> just using reactor.run()? Or would the latter be sufficient?
</I>&gt;<i> 
</I>
This seems to be a common stumbling point for newcomers to Twisted.

With Twisted, you don't need threads. You don't want threads. Threads 
are actually harmful: <A HREF="http://www.kuro5hin.org/story/2002/11/18/22112/860">http://www.kuro5hin.org/story/2002/11/18/22112/860</A>

But this doesn't help you write a chat server. How can you do that 
without threads? The answer falls into two parts: how Twisted does it 
and how you use Twisted to do it.

1. How Twisted Does It
When you run a Twisted server, Twisted calls the socket functions 
asynchronously. So, rather than calling a listen function which sits 
there waiting until someone connects, it calls a listen function which 
returns immediately. Then, in the &lt;b&gt;reactor&lt;/b&gt; loop, it polls things. 
When something connects _Twisted calls your code_ which it expects to 
_return immediately_. The entire process will wait for your code to return.

So, this leaves a bit of a problem: How do I do stuff that takes time?
The answer is too complicated to go into now. The important bit is that 
your function doesn't compute a value and return it. It returns a 
Deferred -- a promise to return later.


2. How You Get Twisted to do it.

---------------------------------------
port = 8007

class MyProtocol(Protocol):
   def connectionMade(self):
     &quot;&quot;&quot;someone has connected. do something&quot;&quot;&quot;
   def dataReceived(self, data):
     &quot;&quot;&quot;do stuff with data&quot;&quot;&quot;

factory = ServerFactory()
factory.protocol = MyProtocol

reactor.listenTCP(port, factory)
reactor.run()
---------------------------------------

Notice how you don't really call any of your own code?
The code is essentially preparing an object that can be registered with 
Twisted as a server factory.

Every time someone connects to port 8007 on that host, Twisted will 
instantiate an instance of MyProtocol and call connectionMade on it.

Every time someone sends data, Twisted will call dataReceived.

The reactor calls everything. If your connectionMade implementation 
takes ages to return, then the process is in _your_ code, not the 
reactor's. This means the reactor can't listen for data and can't call 
your dataReceived method. All this really means is that your methods 
should return quickly.

Really, that's all you need to know. Your methods should return quickly.
As long as they do that, you don't really need to worry about threads 
because Twisted will take care of concurrency for you.

Recommended Reading:
&quot;Asynchronous Programming&quot; - 
<A HREF="http://www.twistedmatrix.com/documents/howto/async">http://www.twistedmatrix.com/documents/howto/async</A>

&quot;Writing Servers&quot; -
<A HREF="http://www.twistedmatrix.com/documents/howto/servers">http://www.twistedmatrix.com/documents/howto/servers</A>

&quot;Using Deferreds&quot; -
<A HREF="http://www.twistedmatrix.com/documents/howto/defer">http://www.twistedmatrix.com/documents/howto/defer</A>

&quot;Writing Clients&quot; -
<A HREF="http://www.twistedmatrix.com/documents/howto/clients">http://www.twistedmatrix.com/documents/howto/clients</A>

&quot;Threads Considered Harmful&quot;
<A HREF="http://www.kuro5hin.org/story/2002/11/18/22112/860">http://www.kuro5hin.org/story/2002/11/18/22112/860</A>


Recommended Actions:
* Try writing a _simple_ client/server app in Twisted. It might even be 
worth manually typing out the &quot;quote of the day&quot; examples in the howtos, 
to force your brain to only deal with each concept as it comes, rather 
than trying to grasp the whole in all it's detail.

* Remember that asynchronous programming is just another style of 
programming.

* Forget about threads. You almost never need them. Especially not in 
Twisted.

cheers,
jml



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008266.html">[Twisted-Python] To thread or not to thread...
</A></li>
	<LI>Next message: <A HREF="008276.html">[Twisted-Python] Twisted O'Reilly Book
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8272">[ date ]</a>
              <a href="thread.html#8272">[ thread ]</a>
              <a href="subject.html#8272">[ subject ]</a>
              <a href="author.html#8272">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
