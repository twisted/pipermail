<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] ENOBUF and Twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20ENOBUF%20and%20Twisted&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008446.html">
   <LINK REL="Next"  HREF="008430.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] ENOBUF and Twisted</H1>
    <B>screwtape at froup.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20ENOBUF%20and%20Twisted&In-Reply-To="
       TITLE="[Twisted-Python] ENOBUF and Twisted">screwtape at froup.com
       </A><BR>
    <I>Thu Aug 19 02:48:10 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008446.html">[Twisted-Python] Re: catching adbapi 'thread' failures
</A></li>
        <LI>Next message: <A HREF="008430.html">[Twisted-Python] ENOBUF and Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8428">[ date ]</a>
              <a href="thread.html#8428">[ thread ]</a>
              <a href="subject.html#8428">[ subject ]</a>
              <a href="author.html#8428">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A colleague of mine was working with a server written in Twisted
today, and he ran into a problem involving Twisted. He called me over
(since I'm supposed to be the Python Guru here, which just means I'm
slightly less ignorant than everybody else :) and we tracked the
behaviour in question all the way down to twisted.internet.tcp.

The situation is this: we have an upstream data provider who sends us
data intermittently, all day. We have downstream clients on less
reliable connections who want to recieve it. We have a sort of caching
proxy in the middle that keeps track of all the data sent so far
today, and every time a client connects we send them the total record
of the day's events, and then send them new updates as they arrive.

The problem occurred one day when we had a higher-than-usual amount of
data incoming. The symptom was that any client attempting to connect
would be immediately disconnected for No Obvious Reason. After some
ferretting about through the codebase, we discovered that the
'writeSomeData' method of twisted.internet.tcp.Connection was getting
an error it couldn't handle and dropping the connection.

The swift insertion of a debugging printf showed that the error
generated was ENOBUFS (Well, WSAENOBUFS, since it was running on
Windows 2000), which made the Connection drop the, uh, connection
immediately.

Now, it occurs to me that ENOBUFS does not necessarily mean that the
connection is irretrievably lost, it should be treated more like
EWOULDBLOCK, except that buffers over a certain size will never, ever
fit. I don't know whether special handling of ENOBUFS should happen in
Twisted (to match its already-existing special handling of
EWOULDBLOCK), or whether it should happen in the application (proper
buffer-size autodetection might be a little intricate for a class like
Connection that's supposed to be simple). But either way, just
dropping the connection immediately is probably a Bad Thing.

(for the record, the buffer we were trying to send was about 5MB, but
I assume people trying to send, say CD or DVD disk images via
twisted.web may well run into similar issues)

Is there some clever way to get around this with the current version
of Twisted? If I were to write a patch, how should I best attack the
problem? Are there any other questions I should be asking? :)

-- 
 ___________ ___________________________________
|<i> Screwtape | <A HREF="http://livejournal.com/~thristian">http://livejournal.com/~thristian</A> |______ _____ ___ __ _  _   _
</I>|<i>
</I>|<i> &quot;It's a giant beetle! Of course it doesn't have a kitchen!&quot; -- T&amp;R, 2002-07-07
</I>|<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008446.html">[Twisted-Python] Re: catching adbapi 'thread' failures
</A></li>
	<LI>Next message: <A HREF="008430.html">[Twisted-Python] ENOBUF and Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8428">[ date ]</a>
              <a href="thread.html#8428">[ thread ]</a>
              <a href="subject.html#8428">[ subject ]</a>
              <a href="author.html#8428">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
