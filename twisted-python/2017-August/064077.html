<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] SSLContext not valid for TLS Server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SSLContext%20not%20valid%20for%20TLS%20Server&In-Reply-To=%3Ctrinity-cc9f30de-b6ed-44f4-8993-b64c328379e1-1503823466848%403c-app-gmx-bs07%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064071.html">
   <LINK REL="Next"  HREF="064084.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] SSLContext not valid for TLS Server</H1>
    <B>Thomas Hartwich</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SSLContext%20not%20valid%20for%20TLS%20Server&In-Reply-To=%3Ctrinity-cc9f30de-b6ed-44f4-8993-b64c328379e1-1503823466848%403c-app-gmx-bs07%3E"
       TITLE="[Twisted-Python] SSLContext not valid for TLS Server">ceeborraa at gmx.de
       </A><BR>
    <I>Sun Aug 27 02:44:26 MDT 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064071.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
        <LI>Next message (by thread): <A HREF="064084.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64077">[ date ]</a>
              <a href="thread.html#64077">[ thread ]</a>
              <a href="subject.html#64077">[ subject ]</a>
              <a href="author.html#64077">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you for your reply. 

&gt;<i> This is a somewhat-known issue that I’ve had bubbling on the backburner for some time. For a long time PyOpenSSL didn’t automatically load all EC curves and didn’t provide any API to do so, so Twisted told OpenSSL which curve to use. Some time ago PyOpenSSL changed this behaviour to automatically load all curves, which would resolve this issue.
</I>This, I understand so far.

&gt;<i> The most comprehensive fix here is to do some history spelunking in PyOpenSSL to find out what the lowest version is that has this code block[1] in it, and then only execute the current ecCurve logic if that code block doesn’t appear to have worked.
</I>I don't really get what implies this to me and how I can come around with this issue. What do you mean with &quot;only execute the current ecCurve logic...&quot;? How can this be done?

I have the current versions of Twisted and pyOpenSSL running, so how can I make sure that the latter loads the right curve properly?

Thank you!


&gt;<i> On 24 Aug 2017, at 20:40, Thomas Hartwich &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ceeborraa at gmx.de</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> I think I now know why it is not working. As I initially suspected that ECC could be the reasons, it seems to have come true. No matter what kind of ECC curve I use, the current implementation of Twisted always uses prime256v1 curve. Maybe because pyOpenSSL hasn't got full ECC support currently!? (got it from some comments in _sslverify.py)
</I>&gt;<i>
</I>&gt;<i> In my setting I use secp521r1 curve and for testing purpose I created a key pair of prime256v1 and this works with CertificateOptions. If you have a look at the implementations of twisted.internet._sslverify you will see that prime256v1 is always used as default curve and it seems that no other curve is being accepted. This should be the reason why CertificateOptions does not work for my ECC key.
</I>&gt;<i>
</I>&gt;<i> But somehow it works even with secp521r1, if I use the DefaultOpenSSLContextFactory. So do you know any workaround how it can be fixed that twisted accepts other curves than prime256v1?
</I>&gt;<i>
</I>&gt;<i> Thank you!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Gesendet: Mittwoch, 23. August 2017 um 06:21 Uhr
</I>&gt;<i> Von: Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;
</I>&gt;<i> An: &quot;Twisted general discussion&quot; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt;
</I>&gt;<i> Betreff: Re: [Twisted-Python] SSLContext not valid for TLS Server
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Aug 22, 2017, at 9:16 AM, Thomas Hartwich &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ceeborraa at gmx.de</A>[mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ceeborraa at gmx.de</A>]&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> Yes, you're right for sure. As an alternative I tried to instantiate an object from twisted.internet._sslverify.OpenSSLCertificateOptions (as it is used by PrivateCertificate e.g.):
</I>&gt;<i>
</I>&gt;<i> co = OpenSSLCertificateOptions(privateKey=pkey,certificate=cert_obj)
</I>&gt;<i>
</I>&gt;<i> Please note that importing names with &quot;._&quot; in them is relying on private API :). The public alias for this is `twisted.internet.ssl.CertificateOptions` <A HREF="https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.ssl.CertificateOptions.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.ssl.CertificateOptions.html">https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.ssl.CertificateOptions.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.ssl.CertificateOptions.html</A>][<A HREF="https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.ssl.CertificateOptions.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.ssl.CertificateOptions.html">https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.ssl.CertificateOptions.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.ssl.CertificateOptions.html</A>]]
</I>&gt;<i>
</I>&gt;<i> Despite it provides a SSL-context, it does not work similarly to the options() method I tried before from PrivateCertificate().
</I>&gt;<i>
</I>&gt;<i> Can you tell me how I can make use of IOpenSSLServerConnectionCreator to create a valid SSL-Context for the TLS server in my case?
</I>&gt;<i>
</I>&gt;<i> You should probably just use CertificateOptions - I still would like to understand why it doesn't work ;-).
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html">https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html</A>][<A HREF="https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html">https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html</A>]] is documented here; this is just the interface you should implement (rather than subclassing ContextFactory and implementing getContext) if you want to do something totally custom with the OpenSSL API rather than Twisted's API; I'd still rather understand why Twisted's API, i.e. CertificateOptions, doesn't work for you.
</I>&gt;<i>
</I>&gt;<i> -glyph
</I>&gt;<i>
</I>&gt;<i> Thank you!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Gesendet: Sonntag, 20. August 2017 um 22:36 Uhr
</I>&gt;<i> Von: Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>[mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>]&gt;
</I>&gt;<i> An: &quot;Twisted general discussion&quot; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>[mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>]&gt;
</I>&gt;<i> Betreff: Re: [Twisted-Python] SSLContext not valid for TLS Server
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Aug 20, 2017, at 9:30 AM, Thomas Hartwich &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ceeborraa at gmx.de</A>[mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ceeborraa at gmx.de</A>][mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ceeborraa at gmx.de</A>[mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ceeborraa at gmx.de</A>]]&gt; wrote:
</I>&gt;<i> Ok, I finally got a solution for my problem. As I know, the TLS server was working with DefaultOpenSSLContextFactory but this only takes file paths to private key/certificate, I created my own SSL-Context file.
</I>&gt;<i>
</I>&gt;<i> For anybody who has the same problem:
</I>&gt;<i> Please note that this solution will prevent the use of TLS 1.3 when it is available, among other problems.
</I>&gt;<i>
</I>&gt;<i> DefaultOpenSSLContextFactory should be deprecated (I hope someone has the time to do it soon), as is the 'getContext' interface that you're using (you should be using <A HREF="https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html">https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html</A>][<A HREF="https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html">https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html</A>][<A HREF="https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html">https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html</A>][<A HREF="https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html">https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html[https://twistedmatrix.com/documents/17.5.0/api/twisted.internet.interfaces.IOpenSSLServerConnectionCreator.html</A>]]] ) so it would be really good to understand what part of the non-deprecated TLS stack is broken for you.
</I>&gt;<i>
</I>&gt;<i> -glyph_______________________________________________ Twisted-Python mailing list <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>[mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>] <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>][<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>]]
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>[mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>]
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>]
</I>&gt;<i> _______________________________________________ Twisted-Python mailing list <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>][<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>]]
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>]
</I>
_______________________________________________
Twisted-Python mailing list
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>]


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064071.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
	<LI>Next message (by thread): <A HREF="064084.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64077">[ date ]</a>
              <a href="thread.html#64077">[ thread ]</a>
              <a href="subject.html#64077">[ subject ]</a>
              <a href="author.html#64077">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
