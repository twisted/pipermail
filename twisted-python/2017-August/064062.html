<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] SSLContext not valid for TLS Server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SSLContext%20not%20valid%20for%20TLS%20Server&In-Reply-To=%3Ctrinity-c9078d03-40a8-4298-8b9d-744772f6b778-1503246631367%403c-app-gmx-bs47%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064059.html">
   <LINK REL="Next"  HREF="064063.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] SSLContext not valid for TLS Server</H1>
    <B>Thomas Hartwich</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SSLContext%20not%20valid%20for%20TLS%20Server&In-Reply-To=%3Ctrinity-c9078d03-40a8-4298-8b9d-744772f6b778-1503246631367%403c-app-gmx-bs47%3E"
       TITLE="[Twisted-Python] SSLContext not valid for TLS Server">ceeborraa at gmx.de
       </A><BR>
    <I>Sun Aug 20 10:30:31 MDT 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064059.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
        <LI>Next message (by thread): <A HREF="064063.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64062">[ date ]</a>
              <a href="thread.html#64062">[ thread ]</a>
              <a href="subject.html#64062">[ subject ]</a>
              <a href="author.html#64062">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
 Ok, I finally got a solution for my problem. As I know, the TLS server was working with DefaultOpenSSLContextFactory but this only takes file paths to private key/certificate, I created my own SSL-Context file.

For anybody who has the same problem:

class MySSLContext(ssl.ContextFactory):
    
    _context = None
    
    def __init__(self,privateKey, certificate, sslmethod=SSL.TLSv1_2_METHOD, _contextFactory=SSL.Context):
        
        self.privateKey = privateKey
        self.certificate = certificate
        self._contextFactory = _contextFactory
        self.sslmethod = sslmethod
        
        self.cacheContext()
        
    def cacheContext(self):
        
        if(self._context is None):
            
            ctx = self._contextFactory(self.sslmethod)
            
            ctx.set_options(SSL.OP_NO_SSLv2)
            ctx.set_options(SSL.OP_NO_SSLv3)
            ctx.use_privatekey(self.privateKey)
            ctx.use_certificate(self.certificate)
            
            self._context = ctx
            
    def getContext(self):
        
        return self._context

This context can now work with the EC private key from secp521r1!
 

Gesendet: Mittwoch, 16. August 2017 um 22:15 Uhr
Von: ceeborraa &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ceeborraa at gmx.de</A>&gt;
An: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>
Betreff: [Twisted-Python] SSLContext not valid for TLS Server

Hi,
I'm running Twisted 17.5.0 on Python 3.5.3 and want to create a TLS server with Twisted. I strictly sticked to the example of echoserv_ssl.py on <A HREF="http://twistedmatrix.com/documents/current/core/howto/ssl.html,">http://twistedmatrix.com/documents/current/core/howto/ssl.html,</A> but TLS server is not running properly.
Despite the server starts correctly, it doesn't offer any cipher suites to the client, no matter what kind of client is trying to connect. Any time a client connects, the connection is immediately aborted by server with the error message of:
&lt;class 'OpenSSL.SSL.Error'&gt;: [('SSL routines','tls_post_process_client_hello',no shared cipher')]
I tried to connect to server with the TLS echo client example of echoclient_ssl.py, with openssl s_client command and with nmap by using the --ssl-enum-ciphers script. Each time it failed with the above error message.
If I do not use the options offered by ssl.CertificateOptions() as suggested in the example, but instead create a ssl.DefaultOpenSSLContextFactory() where I provide the privateKey and Certificate as filename-strings, the server works correctly and offers the intended cipher suites.
But I need to create the SSLContext from a OpenSSL PKey-Object (private Key) and a OpenSSL Certificate-Object. Therefore I adjusted the server code of the TLS server example to:
certificate = ssl.Certificate(cert_obj)
privkey = ssl.KeyPair(pkey)    # pkey is the OpenSSL PKey object
prkey_and_cert = ssl.PrivateCertificate.fromCertificateAndKeyPair(certificate,privkey)
factory = protocol.Factory.forProtocol(Echo)
reactor.listenSSL(7498,factory,prkey_and_cert.options())
Again, the server starts, but it does not provide cipher suites so that no client can connect. Same as above!
Appreciate any help!
_______________________________________________ Twisted-Python mailing list <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>]


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064059.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
	<LI>Next message (by thread): <A HREF="064063.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64062">[ date ]</a>
              <a href="thread.html#64062">[ thread ]</a>
              <a href="subject.html#64062">[ subject ]</a>
              <a href="author.html#64062">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
