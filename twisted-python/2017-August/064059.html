<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] SSLContext not valid for TLS Server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SSLContext%20not%20valid%20for%20TLS%20Server&In-Reply-To=%3Ctrinity-4276b276-ae40-4b6e-a494-4450be2f772f-1503161716687%403c-app-gmx-bs07%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064058.html">
   <LINK REL="Next"  HREF="064062.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] SSLContext not valid for TLS Server</H1>
    <B>Thomas Hartwich</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SSLContext%20not%20valid%20for%20TLS%20Server&In-Reply-To=%3Ctrinity-4276b276-ae40-4b6e-a494-4450be2f772f-1503161716687%403c-app-gmx-bs07%3E"
       TITLE="[Twisted-Python] SSLContext not valid for TLS Server">ceeborraa at gmx.de
       </A><BR>
    <I>Sat Aug 19 10:55:16 MDT 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064058.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
        <LI>Next message (by thread): <A HREF="064062.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64059">[ date ]</a>
              <a href="thread.html#64059">[ thread ]</a>
              <a href="subject.html#64059">[ subject ]</a>
              <a href="author.html#64059">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Again as text mail... sorry!

Ok, let me try to provide some detailled information, hope it helps:
 
&gt;<i> openssl version -a:
</I>OpenSSL 1.1.0f  25 May 2017
built on: reproducible build, date unspecified
platform: linux-x86_64
compiler: gcc -DDSO_DLFCN -DHAVE_DLFCN_H -DNDEBUG -DOPENSSL_THREADS -DOPENSSL_NO_STATIC_ENGINE -DOPENSSL_PIC -DOPENSSL_IA32_SSE2 -DOPENSSL_BN_ASM_MONT -DOPENSSL_BN_ASM_MONT5 -DOPENSSL_BN_ASM_GF2m -DSHA1_ASM -DSHA256_ASM -DSHA512_ASM -DRC4_ASM -DMD5_ASM -DAES_ASM -DVPAES_ASM -DBSAES_ASM -DGHASH_ASM -DECP_NISTZ256_ASM -DPADLOCK_ASM -DPOLY1305_ASM -DOPENSSLDIR=&quot;\&quot;/usr/local/ssl\&quot;&quot; -DENGINESDIR=&quot;\&quot;/usr/local/lib/engines-1.1\&quot;&quot;  -Wa,--noexecstack
OPENSSLDIR: &quot;/usr/local/ssl&quot;
ENGINESDIR: &quot;/usr/local/lib/engines-1.1&quot;
 
&gt;<i> uname -vr
</I>4.9.0-3-amd64 #1 SMP Debian 4.9.30-2+deb9u2 (2017-06-26)
 
 
&gt;<i> Installed python3 (3.5.3) packages via pip:
</I>cryptography 2.0.3
pyopenssl 17.2.0
Twisted 17.5.0
 
I linked cryptography with the following flags:
CFLAGS=&quot;-I/usr/local/include&quot;
LDFLAGS=&quot;-L/usr/local/lib&quot;
 
I think I know where the problem is. It's obviously not Twisted. I'm using an ECC private key from curve secp521r1 and as far as I understand, pyOpenSSL still has some problems with supporting this type of private keys.
 
Its some kind of strange behaviour. I can parse the ECC key from file and do some operations with it (e.g. signing a file) which works well.
But if I just call the check() method of the pkey object, I get the error: &quot;Unsupported key type&quot; from pyOpenSSL. I think this is the reason why Twisted cannot get the TLS options from it.
A similar situation is being described here: <A HREF="https://github.com/pyca/pyopenssl/issues/291">https://github.com/pyca/pyopenssl/issues/291</A>
 
I tried to follow the workaround being described in the issue from the link above, namely to serialise the private key to cryptography and later to convert it to a pyOpenSSL pkey object, but it still does not support the key type.
 
Maybe you have an idea of how to get those things work?
 
Thank you 
 

Gesendet: Freitag, 18. August 2017 um 07:23 Uhr
Von: Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;
An: &quot;Twisted general discussion&quot; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt;
Betreff: Re: [Twisted-Python] SSLContext not valid for TLS Server
&gt;<i> On Aug 16, 2017, at 1:15 PM, ceeborraa &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ceeborraa at gmx.de</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm running Twisted 17.5.0 on Python 3.5.3 and want to create a TLS server with Twisted. I strictly sticked to the example of echoserv_ssl.py on <A HREF="http://twistedmatrix.com/documents/current/core/howto/ssl.html,">http://twistedmatrix.com/documents/current/core/howto/ssl.html,</A> but TLS server is not running properly.
</I>&gt;<i>
</I>&gt;<i> Despite the server starts correctly, it doesn't offer any cipher suites to the client, no matter what kind of client is trying to connect. Any time a client connects, the connection is immediately aborted by server with the error message of:
</I>&gt;<i>
</I>&gt;<i> &lt;class 'OpenSSL.SSL.Error'&gt;: [('SSL routines','tls_post_process_client_hello',no shared cipher')]
</I>&gt;<i>
</I>&gt;<i> I tried to connect to server with the TLS echo client example of echoclient_ssl.py, with openssl s_client command and with nmap by using the --ssl-enum-ciphers script. Each time it failed with the above error message.
</I>&gt;<i>
</I>&gt;<i> If I do not use the options offered by ssl.CertificateOptions() as suggested in the example, but instead create a ssl.DefaultOpenSSLContextFactory() where I provide the privateKey and Certificate as filename-strings, the server works correctly and offers the intended cipher suites.
</I>&gt;<i>
</I>&gt;<i> But I need to create the SSLContext from a OpenSSL PKey-Object (private Key) and a OpenSSL Certificate-Object. Therefore I adjusted the server code of the TLS server example to:
</I>&gt;<i>
</I>&gt;<i> certificate = ssl.Certificate(cert_obj)
</I>&gt;<i> privkey = ssl.KeyPair(pkey) # pkey is the OpenSSL PKey object
</I>&gt;<i> prkey_and_cert = ssl.PrivateCertificate.fromCertificateAndKeyPair(certificate,privkey)
</I>&gt;<i>
</I>&gt;<i> factory = protocol.Factory.forProtocol(Echo)
</I>&gt;<i> reactor.listenSSL(7498,factory,prkey_and_cert.options())
</I>&gt;<i>
</I>&gt;<i> Again, the server starts, but it does not provide cipher suites so that no client can connect. Same as above!
</I>&gt;<i>
</I>&gt;<i> Appreciate any help!
</I>
This sounds like it might be a configuration problem with your build of OpenSSL. Can you post the most detailed explanation of what versions of everything you're using that you can? Particularly: your operating system, any installed version of OpenSSL, cryptography? (If you know how to check which OpenSSL cryptography is linked to, that would be great too.) What attributes does the private key have?

Thanks for using Twisted,

-g

_______________________________________________
Twisted-Python mailing list
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python[https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>]


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064058.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
	<LI>Next message (by thread): <A HREF="064062.html">[Twisted-Python] SSLContext not valid for TLS Server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64059">[ date ]</a>
              <a href="thread.html#64059">[ thread ]</a>
              <a href="subject.html#64059">[ subject ]</a>
              <a href="author.html#64059">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
