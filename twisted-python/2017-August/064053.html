<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] trial.unitest-specific segfault with lxml
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20trial.unitest-specific%20segfault%20with%20lxml&In-Reply-To=%3C9dbd0c83-6b0c-fb9b-c223-3e1121b2caca%40imperial.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] trial.unitest-specific segfault with lxml</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20trial.unitest-specific%20segfault%20with%20lxml&In-Reply-To=%3C9dbd0c83-6b0c-fb9b-c223-3e1121b2caca%40imperial.ac.uk%3E"
       TITLE="[Twisted-Python] trial.unitest-specific segfault with lxml">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Thu Aug 17 16:47:16 MDT 2017</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64053">[ date ]</a>
              <a href="thread.html#64053">[ thread ]</a>
              <a href="subject.html#64053">[ subject ]</a>
              <a href="author.html#64053">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is an odd one; I have a simple test using the incremental xmlfile() 
feature of lxml, that crashes *only* if the test case inherits from 
trial.unittest.TestCase; it works if inheriting from unittest.TestCase.

SSCCE - well, hopefully correct - here:

<A HREF="https://gist.github.com/philmayers/387597c7407ab98f159426cea5f44a69">https://gist.github.com/philmayers/387597c7407ab98f159426cea5f44a69</A>

With lxml 3.8.0 (tried both manylinux1 wheel from PyPI and 
locally-compiled) and a debug python, I get:

$ bin/python2-debug -m twisted.trial test_repro.py
test_repro
   Test
     test_one ...    [OK]
     test_two ...    [OK]

-------------------------------------------------------------------------------
Ran 2 tests in 0.032s

PASSED (successes=2)
python2-debug: /builddir/build/BUILD/Python-2.7.13/Python/getargs.c:229: 
vgetargs1: Assertion `compat || (args != (PyObject*)NULL)' failed.
Aborted (core dumped)

Obviously lxml is a pretty big chunk of Cython, but the trial-specific 
nature of the crash has me curious which of the two is at fault.

I have tried to debug it, and it basically seems to end up somewhere 
inside the Cython-generated code with an argument to a python function 
that is NULL when it shouldn't be.

Any ideas?


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64053">[ date ]</a>
              <a href="thread.html#64053">[ thread ]</a>
              <a href="subject.html#64053">[ subject ]</a>
              <a href="author.html#64053">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
