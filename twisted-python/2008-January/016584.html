<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How can I make twisted and dbus work together?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20I%20make%20twisted%20and%20dbus%20work%20together%3F&In-Reply-To=1200464918.478da4163459c%40www-mail.usyd.edu.au">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016613.html">
   <LINK REL="Next"  HREF="016585.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How can I make twisted and dbus work together?</H1>
    <B>Bastian Winkler</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20I%20make%20twisted%20and%20dbus%20work%20together%3F&In-Reply-To=1200464918.478da4163459c%40www-mail.usyd.edu.au"
       TITLE="[Twisted-Python] How can I make twisted and dbus work together?">buz at netbuz.org
       </A><BR>
    <I>Wed Jan 16 08:01:21 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="016613.html">[Twisted-Python] How can I make twisted and dbus work together?
</A></li>
        <LI>Next message: <A HREF="016585.html">[Twisted-Python] connection pool
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16584">[ date ]</a>
              <a href="thread.html#16584">[ thread ]</a>
              <a href="subject.html#16584">[ subject ]</a>
              <a href="author.html#16584">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi,

you have to install glib2reactor before importing any other modules to
prevent them from importing the default reactor (which is the
SelectReactor on linux)

so simply put

from twisted.internet import glib2reactor
glib2reactor.install()

on top of your script/module and it should work as expected

:<i>wq buz
</I>
On Wed, Jan 16, 2008 at 05:28:38PM +1100, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">hwan2265 at mail.usyd.edu.au</A> wrote:
&gt;<i> Hello everyone,
</I>&gt;<i> 
</I>&gt;<i> I am trying to write a imap mail fetcher base on twisted and dbus. I have
</I>&gt;<i> written a simple fetcher without dbus functionality and it's working fine.
</I>&gt;<i> However I got a problem while adding dbus.
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://twistedmatrix.com/trac/ticket/1352">http://twistedmatrix.com/trac/ticket/1352</A> is the only article about how can
</I>&gt;<i> twisted and dbus work together that I could get from google and I just
</I>&gt;<i> followed its suggestion and added
</I>&gt;<i> 
</I>&gt;<i>     from twisted.internet import glib2reactor
</I>&gt;<i>     glib2reactor.install()
</I>&gt;<i> 
</I>&gt;<i> to my code.
</I>&gt;<i> 
</I>&gt;<i> As what I read from twisted API
</I>&gt;<i> <A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.glib2reactor.html">http://twistedmatrix.com/documents/current/api/twisted.internet.glib2reactor.html</A>
</I>&gt;<i> &quot;In order to use this support, simply do the following:
</I>&gt;<i> 
</I>&gt;<i>    |  from twisted.internet import glib2reactor
</I>&gt;<i>    |  glib2reactor.install()
</I>&gt;<i> 
</I>&gt;<i> Then use twisted.internet APIs as usual. &quot;
</I>&gt;<i> I thought everything will be fine.
</I>&gt;<i> 
</I>&gt;<i> But when I was running my code, I got a error:
</I>&gt;<i> 
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i>   File &quot;dbustwisted.py&quot;, line 5, in &lt;module&gt;
</I>&gt;<i>     glib2reactor.install()
</I>&gt;<i>   File &quot;/usr/lib/python2.5/site-packages/twisted/internet/glib2reactor.py&quot;,
</I>&gt;<i> line 33, in install
</I>&gt;<i>     return gtk2reactor.install(False)
</I>&gt;<i>   File &quot;/usr/lib/python2.5/site-packages/twisted/internet/gtk2reactor.py&quot;,
</I>&gt;<i> line 270, in install
</I>&gt;<i>     installReactor(reactor)
</I>&gt;<i>   File &quot;/usr/lib/python2.5/site-packages/twisted/internet/main.py&quot;, line
</I>&gt;<i> 24, in installReactor
</I>&gt;<i>     &quot;reactor already installed&quot;
</I>&gt;<i> AssertionError: reactor already installed
</I>&gt;<i> 
</I>&gt;<i> I don't know what's wrong with it.
</I>&gt;<i> This is my code, I have not add the dbus part yet and just test the
</I>&gt;<i> glib2reactor.
</I>&gt;<i> 
</I>&gt;<i> from twisted.mail import imap4
</I>&gt;<i> from twisted.internet import protocol, defer
</I>&gt;<i> import email, os, time
</I>&gt;<i> 
</I>&gt;<i> MAILPATH = &quot;Mails&quot;
</I>&gt;<i> IMAPSERVER = &quot;xxxxxxxxxxx&quot;
</I>&gt;<i> USERNAME = &quot;xxxxx&quot;
</I>&gt;<i> PASSWORD = &quot;xxxxx&quot;
</I>&gt;<i> 
</I>&gt;<i> class IMAPDownloadProtocol(imap4.IMAP4Client):
</I>&gt;<i> 
</I>&gt;<i>     def serverGreeting(self, capabilities):
</I>&gt;<i>         login = self.login(self.factory.username, self.factory.password)
</I>&gt;<i>         login.addCallback(self.__loggedIn)
</I>&gt;<i>         login.chainDeferred(self.factory.deferred) # any event that fires
</I>&gt;<i> login will also fire factory.deferred
</I>&gt;<i> 
</I>&gt;<i>     def __loggedIn(self, result):
</I>&gt;<i>         return
</I>&gt;<i> self.select(self.factory.mailbox).addCallback(self.__selectedMailbox)
</I>&gt;<i> 
</I>&gt;<i>     def __selectedMailbox(self, result):
</I>&gt;<i>         allMessages = imap4.MessageSet(1, None) # a set of messages from
</I>&gt;<i> message number 1 to the end of the mailbox
</I>&gt;<i>         return self.fetchUID(allMessages, True).addCallback(self.__gotUIDs)
</I>&gt;<i> # fetch a list of UID
</I>&gt;<i> 
</I>&gt;<i>     def __gotUIDs(self, uidResults):
</I>&gt;<i>         self.messageUIDs = [result['UID'] for result in uidResults.values(
</I>&gt;<i> )]
</I>&gt;<i>         self.messageCount = len(self.messageUIDs)
</I>&gt;<i>         print &quot;INFO: %i messages in %s.&quot; % (self.messageCount,
</I>&gt;<i> self.factory.mailbox)
</I>&gt;<i>         return self.fetchNextMessage( ) # start to download the message one
</I>&gt;<i> by one
</I>&gt;<i> 
</I>&gt;<i>     def fetchNextMessage(self):
</I>&gt;<i>         if self.messageUIDs:
</I>&gt;<i>             nextUID = self.messageUIDs.pop(0)
</I>&gt;<i>             messageListToAnalysis = imap4.MessageSet(nextUID) # creates a
</I>&gt;<i> MessageSet matching only that message's UID
</I>&gt;<i>             return self.fetchAll(messageListToAnalysis,
</I>&gt;<i> True).addCallback(self.__gotIndex)
</I>&gt;<i>             # fetchAll - fetching the UID, flags, size, date, envelope
</I>&gt;<i>             # UID keyword set to true to tell the server that the
</I>&gt;<i> MessageSet is referring to messages by UID, not sequence number
</I>&gt;<i>         else:
</I>&gt;<i>             return self.logout( ).addCallback(lambda _:
</I>&gt;<i> self.transport.loseConnection( ))
</I>&gt;<i> 
</I>&gt;<i>     def __gotIndex(self, indexResults):
</I>&gt;<i>         index = indexResults.values()
</I>&gt;<i>         index_details = index[0]
</I>&gt;<i> 
</I>&gt;<i>         UID = index_details['UID']
</I>&gt;<i>         flags = index_details['FLAGS']
</I>&gt;<i>         size = index_details['RFC822.SIZE']
</I>&gt;<i>         date = index_details['INTERNALDATE']
</I>&gt;<i>         envelope = index_details['ENVELOPE']
</I>&gt;<i> 
</I>&gt;<i>         title = envelope[1]
</I>&gt;<i>         sender = envelope[3]
</I>&gt;<i>         temp = []
</I>&gt;<i>         # replace None in the envelope as &quot;Empty&quot;, because None is a key
</I>&gt;<i> word in python
</I>&gt;<i>         for element in sender[0]:
</I>&gt;<i>             if element != None:
</I>&gt;<i>                 temp += [element]
</I>&gt;<i>             if element == None:
</I>&gt;<i>                 temp += [&quot;Empty&quot;]
</I>&gt;<i>         sender = temp
</I>&gt;<i> 
</I>&gt;<i>         if flags == []:
</I>&gt;<i>             flags = ['\\Unseen']
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>         print &quot;INFO: Downloading message %i of %i&quot; %
</I>&gt;<i> (self.messageCount-len(self.messageUIDs), self.messageCount)
</I>&gt;<i>         messageListToFetch = imap4.MessageSet(UID)
</I>&gt;<i>         return self.fetchMessage(messageListToFetch,
</I>&gt;<i> True).addCallback(self.__gotMessage, UID)
</I>&gt;<i> 
</I>&gt;<i>     def __gotMessage(self, fetchResults, UID):
</I>&gt;<i>         messageData = fetchResults.values( )[0]['RFC822']
</I>&gt;<i>         self.factory.handleMessage(messageData, UID)
</I>&gt;<i>         return self.fetchNextMessage( ) # fetch next message
</I>&gt;<i> 
</I>&gt;<i>     def connectionLost(self, reason):
</I>&gt;<i>         if not self.factory.deferred.called:
</I>&gt;<i>             # connection was lost unexpectedly!
</I>&gt;<i>             self.factory.deferred.errback(reason)
</I>&gt;<i> 
</I>&gt;<i> class IMAPDownloadFactory(protocol.ClientFactory):
</I>&gt;<i>     protocol = IMAPDownloadProtocol
</I>&gt;<i> 
</I>&gt;<i>     def __init__(self, username, password, mailbox, path):
</I>&gt;<i>         self.username = username
</I>&gt;<i>         self.password = password
</I>&gt;<i>         self.mailbox = mailbox
</I>&gt;<i>         self.path = path
</I>&gt;<i>         self.deferred = defer.Deferred( )
</I>&gt;<i> 
</I>&gt;<i>     def handleMessage(self, messageData, UID):
</I>&gt;<i>         mailFile = os.path.join(path, UID)
</I>&gt;<i>         output = file(mailFile, 'w+b')
</I>&gt;<i>         parsedMessage = email.message_from_string(messageData)
</I>&gt;<i>         output.write(parsedMessage.as_string(unixfrom=True))
</I>&gt;<i> 
</I>&gt;<i>     def startedConnecting(self, connector):
</I>&gt;<i>         print &quot;INFO: Connection start&quot;
</I>&gt;<i> 
</I>&gt;<i>     def clientConnectionFailed(self, connection, reason):
</I>&gt;<i>         self.deferred.errback(reason)
</I>&gt;<i> 
</I>&gt;<i>     def clientConnectionLost(self, connection, reason):
</I>&gt;<i>         print &quot;INFO: Connection stop&quot;
</I>&gt;<i>         #connection.connect()
</I>&gt;<i> 
</I>&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;<i>     from twisted.internet import glib2reactor
</I>&gt;<i>     glib2reactor.install()
</I>&gt;<i>     ################################################
</I>&gt;<i>     # I added the 2 lines here and made the program crash
</I>&gt;<i>     ################################################
</I>&gt;<i> 
</I>&gt;<i>     from twisted.internet import reactor
</I>&gt;<i>     import sys, getpass
</I>&gt;<i> 
</I>&gt;<i>     server = IMAPSERVER
</I>&gt;<i>     user = USERNAME
</I>&gt;<i>     mailbox = &quot;Inbox&quot;
</I>&gt;<i>     path = MAILPATH
</I>&gt;<i>     password = PASSWORD
</I>&gt;<i> 
</I>&gt;<i>     factory = IMAPDownloadFactory(user, password, mailbox, path)
</I>&gt;<i>     reactor.connectTCP(server, 143, factory)
</I>&gt;<i>     reactor.run( )
</I>&gt;<i> 
</I>&gt;<i> I am new to twisted, dbus even python, any helps will be appreciated.
</I>&gt;<i> 
</I>&gt;<i> Regards
</I>&gt;<i> Huisan
</I>&gt;<i> 
</I>&gt;<i> ----------------------------------------------------------------
</I>&gt;<i> This message was sent using IMP, the Internet Messaging Program.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
-- 
If Bill Gates had a penny for every time Windows crashed......Oh wait, he does.

GnuPG Fingerprint: 2FFF FC48 C7DF 1EA0 00A0  FD53 8C35 FD2E 6908 7B82
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: Digital signature
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20080116/eb320402/attachment.pgp">http://twistedmatrix.com/pipermail/twisted-python/attachments/20080116/eb320402/attachment.pgp</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016613.html">[Twisted-Python] How can I make twisted and dbus work together?
</A></li>
	<LI>Next message: <A HREF="016585.html">[Twisted-Python] connection pool
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16584">[ date ]</a>
              <a href="thread.html#16584">[ thread ]</a>
              <a href="subject.html#16584">[ subject ]</a>
              <a href="author.html#16584">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
