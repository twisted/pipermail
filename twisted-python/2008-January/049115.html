<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Closing connections properly
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Closing%20connections%20properly&In-Reply-To=%3Ccd8fa6f90801190641w3e4b78c3kcc87e8d205c984fc%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="049114.html">
   <LINK REL="Next"  HREF="049120.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Closing connections properly</H1>
    <B>Christian Simms</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Closing%20connections%20properly&In-Reply-To=%3Ccd8fa6f90801190641w3e4b78c3kcc87e8d205c984fc%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Closing connections properly">christian.simms at gmail.com
       </A><BR>
    <I>Sat Jan 19 07:41:58 MST 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="049114.html">[Twisted-Python] Closing connections properly
</A></li>
        <LI>Next message (by thread): <A HREF="049120.html">[Twisted-Python] LDAP server based on python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49115">[ date ]</a>
              <a href="thread.html#49115">[ thread ]</a>
              <a href="subject.html#49115">[ subject ]</a>
              <a href="author.html#49115">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Jan 19, 2008 8:41 AM, Simon Pickles &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">sipickles at hotmail.com</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Having a simple server based on a LineReceiver, what is the proper way
</I>&gt;<i> to close connections and delete the class containing those connections
</I>&gt;<i> (the class built by BuildProtocol()).
</I>&gt;<i>
</I>&gt;<i> Given the simple code below, Protocol.BuildProtocol is called when I
</I>&gt;<i> client connections, and builds and instance of the class Connection.
</I>&gt;<i> When the client disconnects, Connection.connectionLost is called, but
</I>&gt;<i> the instance continues (__del__ is never called). I even naively tried
</I>&gt;<i> added a 'del self' statement to the connectionLost method, but its not
</I>&gt;<i> c++ 'delete this'!
</I>&gt;<i>
</I>&gt;<i> How should I delete the closed connection? Is there something in twisted
</I>&gt;<i> I can overload, or should I use the server to track connections better
</I>&gt;<i> and perform my deleting there?
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i>
</I>&gt;<i> Simon
</I>&gt;<i>
</I>&gt;<i> Example
</I>&gt;<i> --------------
</I>&gt;<i>
</I>&gt;<i> class Connection(basic.LineReceiver):
</I>&gt;<i>     def __init__(self):
</I>&gt;<i>         self.ipAddress = &quot;000.000.000.000&quot;
</I>&gt;<i>         self.port = 0
</I>&gt;<i>         logger.CON(&quot;Opening new connection&quot;)
</I>&gt;<i>
</I>&gt;<i>     def __del__(self): # never called
</I>&gt;<i>         logger.CON(&quot;Closed connection to %s:%d&quot; % (self.ipAddress,
</I>&gt;<i> self.port))
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         &quot;&quot;&quot; Overrides method in basic.LineReceiver &quot;&quot;&quot;
</I>&gt;<i>         self.ipAddress = self.transport.getPeer().host
</I>&gt;<i>         self.port = self.transport.getPeer().port
</I>&gt;<i>         logger.CON(&quot;Log in attempt from %s:%d&quot; % (self.ipAddress,
</I>&gt;<i> self.port))
</I>&gt;<i>
</I>&gt;<i>     def connectionLost(self, reason):
</I>&gt;<i>         &quot;&quot;&quot; Overrides method in basic.LineReceiver &quot;&quot;&quot;
</I>&gt;<i>         logger.CON(&quot;%s:%d has closed the connection, %s&quot; %
</I>&gt;<i> (self.ipAddress, self.port, reason))
</I>&gt;<i>         self.transport.loseConnection()
</I>&gt;<i>
</I>&gt;<i>     def dataReceived(self, data):
</I>&gt;<i>         &quot;&quot;&quot; Overrides method in basic.LineReceiver &quot;&quot;&quot;
</I>&gt;<i>         logger.CON(&quot;%s:%d received %s&quot; % (self.ipAddress, self.port, data))
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class Server(Protocol):
</I>&gt;<i>     factory = Factory()
</I>&gt;<i>     factory.protocol = Connection
</I>&gt;<i>     def __init__(self, maxClients):
</I>&gt;<i>         self.max_clients = maxClients
</I>&gt;<i>         logger.NET(&quot;Server started&quot;)
</I>&gt;<i>
</I>&gt;<i>     def doStart(self):
</I>&gt;<i>         logger.NET(&quot;Port: %d&quot; % globalVars.zoneAddress[1])
</I>&gt;<i>         logger.NET(&quot;...... waiting for a connection ......&quot;)
</I>&gt;<i>     def doStop(self):
</I>&gt;<i>         logger.NET(&quot;Server is now closed&quot;)
</I>&gt;<i>
</I>&gt;<i>     def buildProtocol(self, addr):
</I>&gt;<i>         logger.NET(&quot;Connection attempt....&quot;)
</I>&gt;<i>         return Connection()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Linux user #458601 - <A HREF="http://counter.li.org.">http://counter.li.org.</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>
You should not rely on Python's garbage collector to track your open
connections, since you don't how long the garbage collector will wait
until it deletes your object. Instead, you should just track your own
list of connections in the Factory object.

Cheers,
Christian


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="049114.html">[Twisted-Python] Closing connections properly
</A></li>
	<LI>Next message (by thread): <A HREF="049120.html">[Twisted-Python] LDAP server based on python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49115">[ date ]</a>
              <a href="thread.html#49115">[ thread ]</a>
              <a href="subject.html#49115">[ subject ]</a>
              <a href="author.html#49115">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
