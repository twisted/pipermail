<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] anyway to get data from a protocol instance?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20anyway%20to%20get%20data%20from%20a%20protocol%20instance%3F&In-Reply-To=%3C20060809144333.1717.61119670.divmod.quotient.18231%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="046292.html">
   <LINK REL="Next"  HREF="046300.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] anyway to get data from a protocol instance?</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20anyway%20to%20get%20data%20from%20a%20protocol%20instance%3F&In-Reply-To=%3C20060809144333.1717.61119670.divmod.quotient.18231%40ohm%3E"
       TITLE="[Twisted-Python] anyway to get data from a protocol instance?">exarkun at divmod.com
       </A><BR>
    <I>Wed Aug  9 08:43:33 MDT 2006</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="046292.html">[Twisted-Python] anyway to get data from a protocol instance?
</A></li>
        <LI>Next message (by thread): <A HREF="046300.html">[Twisted-Python] anyway to get data from a protocol instance?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46297">[ date ]</a>
              <a href="thread.html#46297">[ thread ]</a>
              <a href="subject.html#46297">[ subject ]</a>
              <a href="author.html#46297">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 9 Aug 2006 14:19:09 +0200, Torsten Irl√§nder &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">feldmatrix at gmx.de</A>&gt; wrote:
&gt;<i>On Wed, Aug 09, 2006 at 04:43:19PM +0800, wang wei wrote:
</I>&gt;&gt;<i> please have a look of fellow code.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> from twisted.internet import reactor, protocol
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class echo(protocol.Protocol):
</I>&gt;&gt;<i>    def __init__(self):
</I>&gt;&gt;<i>        from Queue import Queue
</I>&gt;&gt;<i>        self.q = Queue()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def lineReceived(self, line):
</I>&gt;&gt;<i>        self.q.put(line)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class echofactory(protocol.ServerFactory):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def buildProtocol(self, addr):
</I>&gt;&gt;<i>        p = echo()
</I>&gt;&gt;<i>        p.factory = self
</I>&gt;&gt;<i>        return p
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class runEcho:
</I>&gt;&gt;<i>    def __init__(self):
</I>&gt;&gt;<i>        a = echofactory()
</I>&gt;&gt;<i>        reactor.listenTCP(1024, a)
</I>&gt;&gt;<i>        reactor.run()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My question is how can I get size of Queue q from another class when the
</I>&gt;&gt;<i> program running.
</I>
I suspect you are perfectly aware of how to get the size of the Queue and
that your actual problem is getting a reference to the protocol instance.

The answer here has little to do with Twisted specifically.  You just need
to organize your code such that the reference is available where it is
needed.

&gt;<i>
</I>&gt;<i>That is a question I'm also interested in a good answer. My proposal would be
</I>&gt;<i>to return the protocol object as a deferred. For me this works, but I'm not
</I>&gt;<i>sure if this is a good approach. I extended wang wei's code so that the
</I>&gt;<i>protocol data can be accessed by other classes.
</I>
This is a perfectly serviceable solution, although it may be more complex
than is strictly necessary.

&gt;<i>
</I>&gt;<i>from twisted.internet import reactor, protocol, defer
</I>&gt;<i>
</I>&gt;<i>class echo(protocol.Protocol):
</I>&gt;<i>    def __init__(self):
</I>&gt;<i>        from Queue import Queue
</I>&gt;<i>        self.q = Queue()
</I>&gt;<i>
</I>&gt;<i>    def connectionMade(self):
</I>&gt;<i>        self.factory.deferred.callback(self)
</I>&gt;<i>
</I>&gt;<i>    def lineReceived(self, line):
</I>&gt;<i>        print line
</I>&gt;<i>        self.q.put(line)
</I>&gt;<i>
</I>&gt;<i>class echofactory(protocol.ServerFactory):
</I>&gt;<i>
</I>&gt;<i>    def __init__(self):
</I>&gt;<i>        self.deferred = defer.Deferred()
</I>&gt;<i>
</I>&gt;<i>    def buildProtocol(self, addr):
</I>&gt;<i>        p = echo()
</I>&gt;<i>        p.factory = self
</I>&gt;<i>        return p
</I>&gt;<i>
</I>&gt;<i>class runEcho:
</I>&gt;<i>    def connect(self):
</I>&gt;<i>        a = echofactory()
</I>&gt;<i>        a.deferred.addCallback(self.set_myprotocol)
</I>&gt;<i>        reactor.listenTCP(1024, a)
</I>&gt;<i>        reactor.run()
</I>&gt;<i>
</I>&gt;<i>    def set_myprotocol(self,proto):
</I>&gt;<i>        print &quot;protocol ready!&quot;
</I>&gt;<i>        self.proto = proto
</I>&gt;<i>        print self.proto.q
</I>&gt;<i>
</I>&gt;<i>r = runEcho()
</I>&gt;<i>r.connect()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Can anyone give some comments on this? I am at the very beginning
</I>&gt;<i>of twisted programming and I'm not sure if this is a good way to
</I>&gt;<i>access the protocol class from the outside.
</I>
For a single connection, twisted.internet.protocols.ClientCreator performs
approximately the same task.  For multiple connections, you may want to
eliminate the Deferred entirely and simply call a method with a well-known
name.  For example:

    def connectionMade(self):
        self.factory.setMyProtocol(self)

Or, to handle multiple simultaneous connections:

    def connectionMade(self):
        self.factory.addProtocol(self)


    def connectionLost(self, reason):
        self.factory.removeProtocol(self)

There is an implementation of this tracking pattern in Twisted already,
in fact.  Take a look at twisted.protocols.policies.WrappingFactory, which
keeps a dictionary of protocol instances, updating it whenever a new
connection is made or an old one lost.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="046292.html">[Twisted-Python] anyway to get data from a protocol instance?
</A></li>
	<LI>Next message (by thread): <A HREF="046300.html">[Twisted-Python] anyway to get data from a protocol instance?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46297">[ date ]</a>
              <a href="thread.html#46297">[ thread ]</a>
              <a href="subject.html#46297">[ subject ]</a>
              <a href="author.html#46297">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
