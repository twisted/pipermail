<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] troubles with FTP server and async file writing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20troubles%20with%20FTP%20server%20and%20async%20file%20writing&In-Reply-To=20081003182618.3750a70a%40fluxx.allmydata.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018476.html">
   <LINK REL="Next"  HREF="018483.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] troubles with FTP server and async file writing</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20troubles%20with%20FTP%20server%20and%20async%20file%20writing&In-Reply-To=20081003182618.3750a70a%40fluxx.allmydata.com"
       TITLE="[Twisted-Python] troubles with FTP server and async file writing">exarkun at divmod.com
       </A><BR>
    <I>Mon Oct  6 16:40:36 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018476.html">[Twisted-Python] troubles with FTP server and async file writing
</A></li>
        <LI>Next message: <A HREF="018483.html">[Twisted-Python] troubles with FTP server and async file writing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18482">[ date ]</a>
              <a href="thread.html#18482">[ thread ]</a>
              <a href="subject.html#18482">[ subject ]</a>
              <a href="author.html#18482">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 3 Oct 2008 18:26:18 -0700, Brian Warner &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">warner at lothar.com</A>&gt; wrote:
&gt;<i>[snip]
</I>&gt;<i>The specific problem is in the way that
</I>&gt;<i>twisted.protocols.ftp.FTP.ftp_STOR() interacts with the IConsumer that it
</I>&gt;<i>gets.. the sequence goes like this:
</I>&gt;<i>
</I>&gt;<i> [snip]
</I>&gt;<i> 6: the DTP connection is closed, _onConnLost is fired
</I>&gt;<i> 7:  DTP._unregConsumer sends unregisterProducer(), and ignores the result
</I>&gt;<i> 8:  FTP.cbConsumer()'s chain regains control, runs cbSent (via Deferred)
</I>&gt;<i> 9:  cbSent returns 226 Transfer Complete
</I>&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>Most of these steps use Deferreds, so the opening of the file can take as
</I>&gt;<i>long as we need, but since DTP._unregConsumer ignores the result of
</I>&gt;<i>consumer.unregisterProducer in step #7, there's no way for the backend to
</I>&gt;<i>stall the delivery of the 226 until the file has actually been uploaded.
</I>&gt;<i>
</I>&gt;<i>We need something to address this, because FTP clients are correctly assuming
</I>&gt;<i>that once they get the 226 Transfer Complete, the file will be in place.
</I>&gt;<i>
</I>
Yep.  You're right that the FTP server protocol implementation currently
assumes that once it has written the last chunk to the consumer that the
file is successfully uploaded.  It would be a good enhancement to server
to allow application code to insert one more Deferred into processing of
uploads after the last write and before the success notification.

Unfortunately, there's no way to signal this with `IConsumer`.  Likewise
(as you pointed out) `IFinishableConsumer.finish` doesn't have very well
defined semantics.  In particular, there's no way to infer from its docs
that a Deferred might be returned.

&gt;<i>
</I>&gt;<i>I guess Plan C would be to involve the IWriteFile instance, adding a finish()
</I>&gt;<i>method of some sort, making this an FTP-specific solution.
</I>&gt;<i>
</I>&gt;<i>So, any thoughts? Something like this just at the VFS level would allow
</I>&gt;<i>backends to use asynchronous-writes, which feels like a significant gap in
</I>&gt;<i>the current functionality. It might be better to address it at the IConsumer
</I>&gt;<i>level, but that would touch more (and better-established) code.
</I>&gt;<i>
</I>
Trying to solve this in VFS before it has been solved for any specific use
case would be premature.  Similarly, making a change to `IConsumer` before
implementing the idea even once should be avoided.  I would suggest adding
a new (optional) interface to the FTP server implementation which supports
the close hook that's needed here.  Once something is working, then we can
try to generalize it.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018476.html">[Twisted-Python] troubles with FTP server and async file writing
</A></li>
	<LI>Next message: <A HREF="018483.html">[Twisted-Python] troubles with FTP server and async file writing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18482">[ date ]</a>
              <a href="thread.html#18482">[ thread ]</a>
              <a href="subject.html#18482">[ subject ]</a>
              <a href="author.html#18482">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
