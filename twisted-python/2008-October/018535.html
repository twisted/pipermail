<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] A deferred class that keeps and can log its	call/errback history
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20A%20deferred%20class%20that%20keeps%20and%20can%20log%20its%0A%09call/errback%20history&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018534.html">
   <LINK REL="Next"  HREF="018536.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] A deferred class that keeps and can log its	call/errback history</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20A%20deferred%20class%20that%20keeps%20and%20can%20log%20its%0A%09call/errback%20history&In-Reply-To="
       TITLE="[Twisted-Python] A deferred class that keeps and can log its	call/errback history">terry at jon.es
       </A><BR>
    <I>Thu Oct 16 00:48:15 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018534.html">[Twisted-Python] mystery exception
</A></li>
        <LI>Next message: <A HREF="018536.html">[Twisted-Python] Status of twisted-pair and python-eunuchs.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18535">[ date ]</a>
              <a href="thread.html#18535">[ thread ]</a>
              <a href="subject.html#18535">[ subject ]</a>
              <a href="author.html#18535">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A few days ago I thought it might be nice to augment the Deferred class to
allow you to look at the callback/errback chain to see what's going on.

Tonight I went to do it. I was nearly done in about 15 minutes, and then it
took another 4 hours to finish....  :-)

It's still a bit rough, but it seems to work.

The code comes with a history logging function that you can insert into a
callback chain. When it's run, it prints the history of the chain,
including also printing the history of any deferreds that were returned
along the way, and then prints the call/errback functions yet to be called.
You get to see the initial result passed to the first call/errback, and the
results along the way.

Output is still grungy. Here's what you get from the attached test code:

        History for deferred &lt;TDeferred at 0xbf1e60  current result: 45&gt;
        Initial result = True
        --- ALREADY FIRED ---
        CALLBACK:
          func   &lt;history&gt;
          result = True
        ERRBACK: &lt;same as CALLBACK&gt;
        CALLBACK:
          func   = &lt;function d at 0xbf46e0&gt;
          args   = '()'
          kwargs = '{}'
          result = &lt;TDeferred at 0xbf6290  current result: 45&gt;
        ERRBACK:
          func   &lt;pass&gt;

                History for deferred &lt;TDeferred at 0xbf6290  current result: 45&gt;
                Initial result = 33
                --- ALREADY FIRED ---
                CALLBACK:
                  func   = &lt;function d2 at 0xbf4758&gt;
                  args   = '()'
                  kwargs = '{}'
                  result = 45
                ERRBACK:
                  func   &lt;pass&gt;
        --- STILL TO BE FIRED ---
        CALLBACK:
          func   = &lt;function ok at 0xbf41b8&gt;
          args   = &quot;('hello',)&quot;
          kwargs = &quot;{'color': 'black'}&quot;
        ERRBACK:
          func   &lt;pass&gt;
        CALLBACK:
          func   &lt;pass&gt;
        ERRBACK:
          func   = &lt;function nok at 0xbf47d0&gt;
          args   = '()'
          kwargs = '{}'
        CALLBACK:
          func   = &lt;function ok2 at 0xbf4668&gt;
          args   = '()'
          kwargs = '{}'
        ERRBACK:
          func   &lt;pass&gt;
        CALLBACK:
          func   &lt;history&gt;
        ERRBACK: &lt;same as CALLBACK&gt;
        CALLBACK:
          func   = &lt;function stop at 0xbf4848&gt;
          args   = '()'
          kwargs = '{}'
        ERRBACK: &lt;same as CALLBACK&gt;

If you examine this you'll see that I'm using &lt;pass&gt; and &lt;history&gt; to
indicate uninteresting call/errbacks (these correspond to the
defer.passthru and the history function itself).  When the errback is the
same as the callback (due to d.addBoth), that's indicated.

If you look at the attached code you'll see I also do a bit of hiding of
housekeeping callbacks: the _continue and my own (perhaps unnecessary)
_historyPop. Those are things the caller isn't aware of, and they're just
clutter, so I don't print them.

I made the logDeferredHistory function be standalone (not a class method)
to make it easier to log any deferred (not just the current instance) and
also because it's then simpler to identify when the callback is the history
function itself (to be able to print that concisely).

You use the logging callback pretty much like any other. E.g.:

    if __name__ == '__main__':
        log.startLogging(sys.stdout)
        x = funcReturningADeferred()
        x.addCallback(d)
        x.addBoth(logDeferredHistory, x)
        x.addCallback(ok, 'hello', color='black')
        x.addBoth(logDeferredHistory, x)

Right now it logs the history. But you could pass it a file descriptor
or something else, like a list.

It would be nice to be able to make this a trivial drop-in replacement for
normal Deferreds for when you're debugging. In that case logDeferredHistory
could test to see if its deferred arg is an instance of a history deferred
and if not just act as a passthrough. Then people might be able to do
something like this when debugging:

    from twisted..... import historyDeffered as defer

and otherwise not alter their code.  Or we could add an optional argument
to Deferred.__init__ indicating that the deferred should maintain its
history. It doesn't involve much extra work - mainly just pushing things
onto a list during _runCallbacks.

Terry


-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: tdefer.py
Url: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20081016/328d318d/attachment.txt">http://twistedmatrix.com/pipermail/twisted-python/attachments/20081016/328d318d/attachment.txt</A> 
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: tdefer_test.py
Url: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20081016/328d318d/attachment-0001.txt">http://twistedmatrix.com/pipermail/twisted-python/attachments/20081016/328d318d/attachment-0001.txt</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018534.html">[Twisted-Python] mystery exception
</A></li>
	<LI>Next message: <A HREF="018536.html">[Twisted-Python] Status of twisted-pair and python-eunuchs.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18535">[ date ]</a>
              <a href="thread.html#18535">[ thread ]</a>
              <a href="subject.html#18535">[ subject ]</a>
              <a href="author.html#18535">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
