<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] getpeername from verify callback
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20getpeername%20from%20verify%20callback&In-Reply-To=CAFycZ9c2T7FBRfQ6SU3V7h5fy1jhOViqu%2ByKjbFA8b%3DOHubS6A%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026135.html">
   <LINK REL="Next"  HREF="026139.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] getpeername from verify callback</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20getpeername%20from%20verify%20callback&In-Reply-To=CAFycZ9c2T7FBRfQ6SU3V7h5fy1jhOViqu%2ByKjbFA8b%3DOHubS6A%40mail.gmail.com"
       TITLE="[Twisted-Python] getpeername from verify callback">glyph at twistedmatrix.com
       </A><BR>
    <I>Fri Oct 19 03:14:53 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="026135.html">[Twisted-Python] getpeername from verify callback
</A></li>
        <LI>Next message: <A HREF="026139.html">[Twisted-Python] getpeername from verify callback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26138">[ date ]</a>
              <a href="thread.html#26138">[ thread ]</a>
              <a href="subject.html#26138">[ subject ]</a>
              <a href="author.html#26138">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Oct 18, 2012, at 11:56 PM, Adi Roiban &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A>&gt; wrote:

&gt;<i> On 19 October 2012 09:28, Glyph &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;<i> On Oct 18, 2012, at 9:41 PM, Nathan Mower &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">nathanm at securitymetrics.com</A>&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The following sample code worked until Twisted began to prefer memory BIOs over socket BIOs.  Now it produces this error...
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> exceptions.AttributeError: 'NoneType' object has no attribute 'getpeername'
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ...on line 9 where getpeername() is called by the verify() callback.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Is there any way to obtain the peer name, given the OpenSSL.SSL.Connection object passed into verify()?  Anything that surfaces the underlying socket?  (Perhaps something similar to what is done in connectionMade(), which does work.)  Or alternatively, is there a way to tell the reactor to employ socket BIOs?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The 'socket' attribute that you're accessing is not a documented attribute of ITransport, so in a way I'm glad that your code broke - this wasn't a valid way to use Twisted in the first place :).  See &lt;<A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.ITransport.html">http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.ITransport.html</A>&gt;.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Now, as it happens, &lt;<A HREF="http://twistedmatrix.com/documents/current/api/twisted.protocols.tls.TLSMemoryBIOProtocol.html">http://twistedmatrix.com/documents/current/api/twisted.protocols.tls.TLSMemoryBIOProtocol.html</A>&gt; implements &lt;<A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.ISSLTransport.html">http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.ISSLTransport.html</A>&gt; which is a subinterface of &lt;<A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.ITCPTransport.html">http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.ITCPTransport.html</A>&gt;, which is therefore guaranteed to have a getPeer method &lt;<A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.ITCPTransport.html#getPeer">http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.ITCPTransport.html#getPeer</A>&gt; that returns an IPv4Address &lt;<A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.address.IPv4Address.html">http://twistedmatrix.com/documents/current/api/twisted.internet.address.IPv4Address.html</A>&gt; or IPv6Address &lt;<A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.address.IPv6Address.html">http://twistedmatrix.com/documents/current/api/twisted.internet.address.IPv6Address.html</A>&gt;, both of which have a 'host' attribute that is the hostname.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> So, in short, substitute &quot;self.transport.getPeer().host&quot; and your code should work again.
</I>&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> Thanks for the explanation about new interfaces.
</I>&gt;<i> 
</I>&gt;<i> I think that the initial question was about the
</I>&gt;<i> SSL.Context.set_verify(connection, certificate, errnum, errdepth,
</I>&gt;<i> code) callback.
</I>&gt;<i> 
</I>&gt;<i> From what I can see, SSL.Context or SSL.Connection has no transport attribute.
</I>&gt;<i> 
</I>&gt;<i> In previous version there was SSL.Connection.getpeername()
</I>
In this case, you actually want to pass in the hostname to verify against, not look at the connection.  getpeername() ought to return the IP of the host you actually connected to, not the hostname, which is not meaningful to verify against.  You need to pass in the host name that the user specified, so that needs to be an argument to the verifying context factory.

If you need really need information from the connection itself for verification (although that is usually a bad idea, with the exception of the very specific case that SSH uses it for - although that grants little in the way of useful security, in my opinion), you will have to use connectTCP and startTLS rather than connectSSL, so you can construct a new TLS context once you already have a reference to the protocol object.

This is a good thing, though; connectSSL is a slightly silly API and something that I hope will eventually go away; now that we have memory BIOs, TLS can be accomplished just fine without adding additional APIs for every reactor to support.

-glyph
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026135.html">[Twisted-Python] getpeername from verify callback
</A></li>
	<LI>Next message: <A HREF="026139.html">[Twisted-Python] getpeername from verify callback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26138">[ date ]</a>
              <a href="thread.html#26138">[ thread ]</a>
              <a href="subject.html#26138">[ subject ]</a>
              <a href="author.html#26138">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
