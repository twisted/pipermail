<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Simpler Twisted deferred code via decorated	callbacks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Simpler%20Twisted%20deferred%20code%20via%20decorated%0A%09callbacks&In-Reply-To=20603.9039.693914.80962%40jon.es">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026122.html">
   <LINK REL="Next"  HREF="026127.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Simpler Twisted deferred code via decorated	callbacks</H1>
    <B>Naveen Michaud-Agrawal</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Simpler%20Twisted%20deferred%20code%20via%20decorated%0A%09callbacks&In-Reply-To=20603.9039.693914.80962%40jon.es"
       TITLE="[Twisted-Python] Simpler Twisted deferred code via decorated	callbacks">naveenm at enthought.com
       </A><BR>
    <I>Mon Oct 15 12:56:31 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="026122.html">[Twisted-Python] Simpler Twisted deferred code via decorated	callbacks
</A></li>
        <LI>Next message: <A HREF="026127.html">[Twisted-Python] Simpler Twisted deferred code via decorated callbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26126">[ date ]</a>
              <a href="thread.html#26126">[ thread ]</a>
              <a href="subject.html#26126">[ subject ]</a>
              <a href="author.html#26126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Terry,

This is a really nice approach. Thanks for sharing! Are there any downsides
or functionality that can't be accomplished using this approach? This
combined with the generator approach to deferreds will make it easier to
reason about the code flow.

Naveen

On Sun, Oct 14, 2012 at 4:40 PM, Terry Jones &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">terry at jon.es</A>&gt; wrote:

&gt;<i> This morning I was thinking about deferreds and how people find them
</I>&gt;<i> difficult to grasp, but how they're conceptually simple once you get it.  I
</I>&gt;<i> guess most of us tell people a deferred is something to hold a result that
</I>&gt;<i> hasn't arrived yet. Sometimes, though, deferreds do have a result in them
</I>&gt;<i> immediately (e.g., using succeed or fail to get an already-fired deferred).
</I>&gt;<i>
</I>&gt;<i> I wondered if it might work to tell people to think of a deferred as really
</I>&gt;<i> being the result. If that were literally true, instead of writing:
</I>&gt;<i>
</I>&gt;<i>     d = getPage(...)
</I>&gt;<i>     d.addErrback(errcheck, args)
</I>&gt;<i>     d.addCallback(cleanup, args)
</I>&gt;<i>     d.addCallback(reformat, args)
</I>&gt;<i>     return d
</I>&gt;<i>
</I>&gt;<i> We might write something like:
</I>&gt;<i>
</I>&gt;<i>     result1 = getPage(...)
</I>&gt;<i>     result2 = errcheck(result1, args)
</I>&gt;<i>     result3 = cleanup(result2, args)
</I>&gt;<i>     return reformat(result3, args)
</I>&gt;<i>
</I>&gt;<i> And if you could write that, you could obviously instead write:
</I>&gt;<i>
</I>&gt;<i>     return reformat(cleanup(errcheck(getPage(...), args), args), args)
</I>&gt;<i>
</I>&gt;<i> If we could write Twisted code that way, I think using deferreds would be
</I>&gt;<i> simpler for people unfamiliar with them.
</I>&gt;<i>
</I>&gt;<i> In the style we're all used to, the programmer manually adds callbacks and
</I>&gt;<i> errbacks.  That's basically boilerplate. It gets worse when you then need
</I>&gt;<i> to also use DeferredList, etc. It's a little confusing to read deferred
</I>&gt;<i> code at first, because you need to know that the deferred result/failure is
</I>&gt;<i> automatically passed as the first arg to callbacks/errbacks.  It seems to
</I>&gt;<i> take a year or more for people to finally realize how the callback &amp;
</I>&gt;<i> errback chains actually interact :-) Also, I wonder how comfortable
</I>&gt;<i> programmers are with code ordered innermost function first, as in the
</I>&gt;<i> normal d.addCallback(inner).addCallback(outer) Twisted style, versus
</I>&gt;<i> outer(inner()), as in the line above.
</I>&gt;<i>
</I>&gt;<i> Anyway... I realized we CAN let people use the succinct style above, by
</I>&gt;<i> putting boilerplate into decorators.  I wrote two decorators, called
</I>&gt;<i> (surprise!) callback and errback.  You can do this:
</I>&gt;<i>
</I>&gt;<i>     @errback
</I>&gt;<i>     def errcheck(failure, arg):
</I>&gt;<i>         ...
</I>&gt;<i>
</I>&gt;<i>     @callback
</I>&gt;<i>     def cleanup(page, arg):
</I>&gt;<i>         ...
</I>&gt;<i>
</I>&gt;<i>     @callback
</I>&gt;<i>     def reformat(page, arg):
</I>&gt;<i>         ...
</I>&gt;<i>
</I>&gt;<i>     reformat(cleanup(errcheck(getPage(...), arg1), arg2), arg3)
</I>&gt;<i>
</I>&gt;<i> The deferred callback and errback chains are hooked up automatically. You
</I>&gt;<i> still get a regular deferred back as the return value.
</I>&gt;<i>
</I>&gt;<i> And... the &quot;deferred&quot; aspect of the code (or at least the need to talk
</I>&gt;<i> about or explain it) has conveniently vanished.
</I>&gt;<i>
</I>&gt;<i> You can also do things like
</I>&gt;<i>
</I>&gt;<i>     func1(getDeferred1(), errcheck(func2(getDeferred2(), getDeferred3())))
</I>&gt;<i>
</I>&gt;<i> This gets the result of deferreds 2 &amp; 3 and (if neither fails) passes the
</I>&gt;<i> result of calling func2 on both results through to func1, which is also
</I>&gt;<i> called with the result of deferred 1. You don't need to use DeferredLists,
</I>&gt;<i> as the decorator makes them for you. The errcheck function wont be called
</I>&gt;<i> at all unless there's an error.
</I>&gt;<i>
</I>&gt;<i> That's nice compared to the verbose equivalent:
</I>&gt;<i>
</I>&gt;<i>     d1 = DeferredList([getDeferred2(), getDeferred3()])
</I>&gt;<i>     d1.addCallback(func2)
</I>&gt;<i>     d1.addErrback(errcheck)
</I>&gt;<i>     d2 = DeferredList([getDeferred1(), d1])
</I>&gt;<i>     d2.addCallback(func1)
</I>&gt;<i>
</I>&gt;<i> Or the more compact but awkward:
</I>&gt;<i>
</I>&gt;<i>     DeferredList([getDeferred(), DeferredList([getDeferred(),
</I>&gt;<i> getDeferred()]).addCallback(func2).addErrback(errcheck)]).addCallback(func1)
</I>&gt;<i>
</I>&gt;<i> There's lots more that could be said about this, but that's enough for now.
</I>&gt;<i> The code (surely not bulletproof) and some tests are at
</I>&gt;<i> <A HREF="https://github.com/terrycojones/twisted-callback-decorators">https://github.com/terrycojones/twisted-callback-decorators</A>
</I>&gt;<i>
</I>&gt;<i> I'll add a README sometime soon.  This is still pretty much proof of
</I>&gt;<i> concept, and some it could be done slightly differently. I'm happy to
</I>&gt;<i> discuss in more detail if people are interested.
</I>&gt;<i>
</I>&gt;<i> Terry
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20121015/82fe0f81/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20121015/82fe0f81/attachment.htm</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026122.html">[Twisted-Python] Simpler Twisted deferred code via decorated	callbacks
</A></li>
	<LI>Next message: <A HREF="026127.html">[Twisted-Python] Simpler Twisted deferred code via decorated callbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26126">[ date ]</a>
              <a href="thread.html#26126">[ thread ]</a>
              <a href="subject.html#26126">[ subject ]</a>
              <a href="author.html#26126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
