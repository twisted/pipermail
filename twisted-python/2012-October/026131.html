<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] getpeername from verify callback
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20getpeername%20from%20verify%20callback&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026124.html">
   <LINK REL="Next"  HREF="026132.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] getpeername from verify callback</H1>
    <B>Nathan Mower</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20getpeername%20from%20verify%20callback&In-Reply-To="
       TITLE="[Twisted-Python] getpeername from verify callback">nathanm at securitymetrics.com
       </A><BR>
    <I>Fri Oct 19 00:41:08 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="026124.html">[Twisted-Python] If you can read this,	the mailing list is working again
</A></li>
        <LI>Next message: <A HREF="026132.html">[Twisted-Python] getpeername from verify callback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26131">[ date ]</a>
              <a href="thread.html#26131">[ thread ]</a>
              <a href="subject.html#26131">[ subject ]</a>
              <a href="author.html#26131">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The following sample code worked until Twisted began to prefer memory BIOs over socket BIOs.  Now it produces this error...

exceptions.AttributeError: 'NoneType' object has no attribute 'getpeername'

...on line 9 where getpeername() is called by the verify() callback.

Is there any way to obtain the peer name, given the OpenSSL.SSL.Connection object passed into verify()?  Anything that surfaces the underlying socket?  (Perhaps something similar to what is done in connectionMade(), which does work.)  Or alternatively, is there a way to tell the reactor to employ socket BIOs?

Thanks,
Nathan

----------------------------------------------
from OpenSSL import SSL
from twisted.internet import reactor, ssl
from twisted.internet.protocol import ClientFactory
from twisted.protocols.basic import LineReceiver

class VerifyContextFactory(ssl.ClientContextFactory):

    def verify(self, connection, x509, errnum, errdepth, ok):
        print connection.getpeername()[0]
        return ok

    def getContext(self):
        ctx = ssl.ClientContextFactory.getContext(self)
        ctx.set_verify(SSL.VERIFY_PEER|SSL.VERIFY_FAIL_IF_NO_PEER_CERT, self.verify)
        return ctx

class MyClient(LineReceiver):

    def connectionMade(self):
        print &quot;connected to&quot;, self.transport.socket.getpeername()[0]
        return

    def connectionFailed(self, reason):
        reactor.stop()

    def connectionLost(self, reason):
        reactor.stop()

class MyClientFactory(ClientFactory):

    protocol = MyClient

if __name__ == &quot;__main__&quot;:
    reactor.connectSSL('www.example.com', 443, MyClientFactory(), VerifyContextFactory())
    reactor.run()


</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026124.html">[Twisted-Python] If you can read this,	the mailing list is working again
</A></li>
	<LI>Next message: <A HREF="026132.html">[Twisted-Python] getpeername from verify callback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26131">[ date ]</a>
              <a href="thread.html#26131">[ thread ]</a>
              <a href="subject.html#26131">[ subject ]</a>
              <a href="author.html#26131">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
