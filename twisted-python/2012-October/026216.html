<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Avoiding network when testing Perspective	Broker
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Avoiding%20network%20when%20testing%20Perspective%0A%09Broker&In-Reply-To=CAKef57ONuqx%3DPSap5y_yEAUm%3DpKbR7YnQrwJ9vbNMr-WEQKHFA%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026211.html">
   <LINK REL="Next"  HREF="026217.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Avoiding network when testing Perspective	Broker</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Avoiding%20network%20when%20testing%20Perspective%0A%09Broker&In-Reply-To=CAKef57ONuqx%3DPSap5y_yEAUm%3DpKbR7YnQrwJ9vbNMr-WEQKHFA%40mail.gmail.com"
       TITLE="[Twisted-Python] Avoiding network when testing Perspective	Broker">exarkun at twistedmatrix.com
       </A><BR>
    <I>Thu Oct 25 17:22:42 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="026211.html">[Twisted-Python] Avoiding network when testing Perspective Broker
</A></li>
        <LI>Next message: <A HREF="026217.html">[Twisted-Python] Avoiding network when testing Perspective	Broker
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26216">[ date ]</a>
              <a href="thread.html#26216">[ thread ]</a>
              <a href="subject.html#26216">[ subject ]</a>
              <a href="author.html#26216">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09:18 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">lacrima.maxim at gmail.com</A> wrote:
&gt;<i>Hi!
</I>&gt;<i>
</I>&gt;<i>I am learning to develop TDD way. I want to create a server that
</I>
Hooray!
&gt;<i>understands PB protocol. Initially I thought it would be a good idea to
</I>&gt;<i>avoid real network connections in my tests, so I tried to use
</I>
Yes, that's definitely what you want to do.
&gt;<i>`proto_helpers.StringTransport`:
</I>
StringTransport is frequently what you want in order to test a protocol 
implementation, so you're on the right track.

Except... actually you're not implementing a protocol.  You're *using* a 
protocol implementation that exists already and has its own unit tests.

It would be better if you found a way to test your code without 
involving the PB protocol implementation or StringTransport.  However, I 
admit that the tools for doing this with PB are almost non-existent.  On 
the other hand, application code written for use with AMP is much more 
amenable to testing.

Just something to think about.
&gt;<i>----------
</I>&gt;<i>import cStringIO
</I>&gt;<i>from twisted.spread import pb
</I>&gt;<i>from twisted.trial import unittest
</I>&gt;<i>from twisted.test import proto_helpers
</I>&gt;<i>
</I>&gt;<i>class Document(pb.Root):
</I>&gt;<i>
</I>&gt;<i>    def remote_convert(self, props):
</I>&gt;<i>        self.props = props
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>class DocTestCase(unittest.TestCase):
</I>&gt;<i>
</I>&gt;<i>    def setUp(self):
</I>&gt;<i>
</I>&gt;<i>        # set up server
</I>&gt;<i>        self.doc = Document()
</I>&gt;<i>        factory = pb.PBServerFactory(self.doc)
</I>&gt;<i>        self.broker = factory.buildProtocol(('127.0.0.1', 0))
</I>&gt;<i>        tr = proto_helpers.StringTransport()
</I>&gt;<i>        self.broker.makeConnection(tr)
</I>
So far so good.  You made a factory, got it to make you a protocol, and 
hooked the protocol up to a StringTransport you made.  That's all good 
stuff.
&gt;<i>
</I>&gt;<i>        # this is what a client sends
</I>&gt;<i>        self.props = {'name': 'MyDoc',
</I>&gt;<i>                      'path': '/path/'}
</I>&gt;<i>
</I>&gt;<i>        # prepare data
</I>&gt;<i>        serialized_props = self.broker.serialize(self.props)
</I>&gt;<i>        msg = ('message', 1, 'root', 'convert', 1,
</I>&gt;<i>               ['tuple', serialized_props], ['dictionary'])
</I>&gt;<i>        io = cStringIO.StringIO()
</I>&gt;<i>        self.broker._encode(msg, io.write)
</I>&gt;<i>        self.chunk = io.getvalue()
</I>
This part isn't quite as good.  `broker.serialize` is basically an 
implementation detail.  `broker._encode` is *definitely* an 
implementation detail.  The exact structure of the message isn't quite 
an implementation detail, but it's such a low-level detail that you 
really don't want to be thinking about it while writing tests for 
something like Document.remote_convert.

Instead, you should probably use the PB client API (ie, PBClientFactory 
and what comes out of it) to interact with this server.  Let the PB 
client implementation figure out what bytes to &quot;send&quot; to your server.
&gt;<i>    def test_convert(self):
</I>&gt;<i>        # data arrived
</I>&gt;<i>        self.broker.dataReceived(self.chunk)
</I>
You'll definitely need to call dataReceived at some point.  Perhaps more 
than once.  So this is pretty good.
&gt;<i>        self.assertEqual(self.props, self.doc.props)
</I>&gt;<i>----------
</I>&gt;<i>
</I>&gt;<i>However, `Document.remote_convert` is never executed so the test above
</I>&gt;<i>fails. After debugging I discovered that `Broker._encode` produces
</I>&gt;<i>different results depending on whether `self.broker.makeConnection(tr)` 
</I>&gt;<i>is
</I>&gt;<i>called or not.
</I>
I haven't bothered to look into what might be going on here, because I 
think you should forget about the `._encode` code and start using a 
client instead.  The client is much more likely to produce the correct 
network traffic to exercise the code you want to exercise.  The same 
goes for the two further tests below - which seem to differ only by a 
call to setPrefixLength, which should make absolutely no difference to 
this code when it is being used in practice, so the difference it makes 
in the tests is probably due to driving the code wrong, which problem 
will go away if you start using PBClientFactory etc.

Hope this helps,
Jean-Paul
&gt;<i>And I created a test case that shows a difference. Here `test_convert1`
</I>&gt;<i>succeeds while `test_convert2` fails:
</I>&gt;<i>----------
</I>&gt;<i>class DocTestCase(unittest.TestCase):
</I>&gt;<i>
</I>&gt;<i>    def setUp(self):
</I>&gt;<i>        self.doc = Document()
</I>&gt;<i>        factory = pb.PBServerFactory(self.doc)
</I>&gt;<i>        self.broker = factory.buildProtocol(('127.0.0.1', 0))
</I>&gt;<i>
</I>&gt;<i>        self.props = {'name': 'MyDoc',
</I>&gt;<i>                      'path': '/path/'}
</I>&gt;<i>
</I>&gt;<i>        serialized_props = self.broker.serialize(self.props)
</I>&gt;<i>        self.msg = ('message', 1, 'root', 'convert', 1,
</I>&gt;<i>                    ['tuple', serialized_props], ['dictionary'])
</I>&gt;<i>
</I>&gt;<i>    def test_convert1(self):
</I>&gt;<i>        self.broker.currentDialect = 'pb'
</I>&gt;<i>        self.broker.setPrefixLimit(64)
</I>&gt;<i>        self.broker.transport = proto_helpers.StringTransport()
</I>&gt;<i>
</I>&gt;<i>        io = cStringIO.StringIO()
</I>&gt;<i>        self.broker._encode(self.msg, io.write)
</I>&gt;<i>        self.broker.dataReceived(io.getvalue())
</I>&gt;<i>
</I>&gt;<i>        self.assertEqual(self.props, self.doc.props)
</I>&gt;<i>
</I>&gt;<i>    def test_convert2(self):
</I>&gt;<i>        self.tr = proto_helpers.StringTransport()
</I>&gt;<i>        self.broker.makeConnection(self.tr)
</I>&gt;<i>
</I>&gt;<i>        io = cStringIO.StringIO()
</I>&gt;<i>        self.broker._encode(self.msg, io.write)
</I>&gt;<i>        self.broker.dataReceived(io.getvalue())
</I>&gt;<i>
</I>&gt;<i>        self.assertEqual(self.props, self.doc.props)
</I>&gt;<i>----------
</I>&gt;<i>
</I>&gt;<i>I wonder what causes this behavior and, in general, if 
</I>&gt;<i>`StringTransport` is
</I>&gt;<i>suitable for testing PB protocol.
</I>&gt;<i>
</I>&gt;<i>Thanks in advance. For your convenience I attached files with these 
</I>&gt;<i>test
</I>&gt;<i>cases.
</I>&gt;<i>
</I>&gt;<i>--
</I>&gt;<i>with regards,
</I>&gt;<i>Maxim
</I>
</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026211.html">[Twisted-Python] Avoiding network when testing Perspective Broker
</A></li>
	<LI>Next message: <A HREF="026217.html">[Twisted-Python] Avoiding network when testing Perspective	Broker
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26216">[ date ]</a>
              <a href="thread.html#26216">[ thread ]</a>
              <a href="subject.html#26216">[ subject ]</a>
              <a href="author.html#26216">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
