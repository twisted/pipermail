<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Transplating a request's transport (SockJS)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Transplating%20a%20request%27s%20transport%20%28SockJS%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026228.html">
   <LINK REL="Next"  HREF="026232.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Transplating a request's transport (SockJS)</H1>
    <B>Laurens Van Houtven</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Transplating%20a%20request%27s%20transport%20%28SockJS%29&In-Reply-To="
       TITLE="[Twisted-Python] Transplating a request's transport (SockJS)">_ at lvh.cc
       </A><BR>
    <I>Sun Oct 28 11:17:53 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="026228.html">[Twisted-Python] a question about monotonic clock
</A></li>
        <LI>Next message: <A HREF="026232.html">[Twisted-Python] Transplating a request's transport (SockJS)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26226">[ date ]</a>
              <a href="thread.html#26226">[ thread ]</a>
              <a href="subject.html#26226">[ subject ]</a>
              <a href="author.html#26226">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,


I've been trying to play with SockJS + Twisted. There's an implementation
here: <A HREF="https://github.com/Fugiman/sockjs-twisted">https://github.com/Fugiman/sockjs-twisted</A>

However, I'm already running a web server, and as the README says
sockjs-twisted is *not* intended to be run together with a web server. It
doesn't really use any of the mechanics in twisted.web.

So, I tried to make it work using Resources anyway: reconstructing the
equivalent bytes in render, and replaying them with the SockJSFactory:

class SockJSResource(resource.Resource):
    &quot;&quot;&quot;
    A resource that defers to a SockJS factory.
    &quot;&quot;&quot;
    isLeaf = True

    def __init__(self, factory, options=None):
        self._factory = SockJSFactory(factory, options)


    def render(self, request):
        transport, request.transport = request.transport, None
        protocol = self._factory.buildProtocol(transport.getPeer())
        protocol.makeConnection(transport)

        path = &quot;/&quot;.join([&quot;&quot;] + request.postpath)
        lines = [&quot;{0} {1} HTTP/1.1&quot;.format(request.method, path)]
        for name, values in request.requestHeaders.getAllRawHeaders():
            lines.append(&quot;{0}: {1}&quot;.format(name, &quot;,&quot;.join(values)))
        lines += [&quot;&quot;, request.content.read()]

        data = &quot;\r\n&quot;.join(lines)
        protocol.dataReceived(data)

        return server.NOT_DONE_YET



This only kind of works. There's an external sockjs test suite (more like
an acceptance test suite): <A HREF="https://github.com/sockjs/sockjs-protocol,">https://github.com/sockjs/sockjs-protocol,</A> that
has multiple failing tests. If anyone needs help running these, I'll gladly
assist there.

In an attempt to begin debugging this, I've found that basically none of
the protocol methods get called on that protocol instance I make on the
third line of render. This took me a while to figure out because
dataReceived *was* being called -- except then I realized I'm calling it
myself in that render method :)

This leads me to believe I'm essentially just screwing up transplanting
this transport entirely. Is that the case?

-- 
cheers
lvh
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20121028/fb53c298/attachment-0001.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20121028/fb53c298/attachment-0001.htm</A> 
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026228.html">[Twisted-Python] a question about monotonic clock
</A></li>
	<LI>Next message: <A HREF="026232.html">[Twisted-Python] Transplating a request's transport (SockJS)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26226">[ date ]</a>
              <a href="thread.html#26226">[ thread ]</a>
              <a href="subject.html#26226">[ subject ]</a>
              <a href="author.html#26226">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
