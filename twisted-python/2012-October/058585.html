<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Consensus on how to handle &quot;MySQL server has gone away&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Consensus%20on%20how%20to%20handle%20%22MySQL%20server%20has%0A%20gone%20away%22&In-Reply-To=%3CCAMwUOs2V5N%3DT2GNrTkLfAVmsD6i4N6J3Mv2EryXYz49kpa7-TQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="058584.html">
   <LINK REL="Next"  HREF="058588.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Consensus on how to handle &quot;MySQL server has gone away&quot;</H1>
    <B>E S</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Consensus%20on%20how%20to%20handle%20%22MySQL%20server%20has%0A%20gone%20away%22&In-Reply-To=%3CCAMwUOs2V5N%3DT2GNrTkLfAVmsD6i4N6J3Mv2EryXYz49kpa7-TQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Consensus on how to handle &quot;MySQL server has gone away&quot;">electric.or.sharp at gmail.com
       </A><BR>
    <I>Thu Oct  4 13:26:04 MDT 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="058584.html">[Twisted-Python] Consensus on how to handle &quot;MySQL server has	gone away&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="058588.html">[Twisted-Python] Consensus on how to handle &quot;MySQL server has	gone away&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58585">[ date ]</a>
              <a href="thread.html#58585">[ thread ]</a>
              <a href="subject.html#58585">[ subject ]</a>
              <a href="author.html#58585">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Oct 3, 2012 at 3:39 PM, Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Le Oct 3, 2012 à 6:36 AM, Augusto Mecking Caringi &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">augustocaringi at gmail.com</A>&gt; a écrit :
</I>&gt;<i>
</I>&gt;&gt;<i> On Wed, Oct 3, 2012 at 8:27 AM, Itamar Turner-Trauring
</I>&gt;&gt;<i> &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> On 10/03/2012 04:28 AM, Phil Mayers wrote:
</I>&gt;&gt;&gt;&gt;<i> I think the behaviour it should be aiming for is clear:
</I>&gt;&gt;&gt;&gt;<i> 1. Test each connection with &quot;good_sql&quot; before beginning the user
</I>&gt;&gt;&gt;&gt;<i> interaction/query
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The problem is that this adds latency; this can add up to quite a
</I>&gt;&gt;&gt;<i> slowdown if your database server is on a remote server and you're doing
</I>&gt;&gt;&gt;<i> lots of single queries (as opposed to runInteraction).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sometime ago I faced some related problems and I found this code,
</I>&gt;&gt;<i> &quot;ReconnectingConnectionPool&quot;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://www.gelens.org/2009/09/13/twisted-connectionpool-revisited/">http://www.gelens.org/2009/09/13/twisted-connectionpool-revisited/</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What are your opinion about it?
</I>&gt;<i>
</I>&gt;<i> If there are bugs in Twisted, or important missing features, step 1 should be to file a bug – first, of course, searching for duplicates – at &lt;<A HREF="http://twistedmatrix.com/trac/newticket">http://twistedmatrix.com/trac/newticket</A>&gt;.  Especially if the workaround involves calling or overriding some private, internal implementation detail.  If you're going to blog about a hack that fixes the problem for you, that post should link to the ticket, so that Twisted can move forward and provide a good experience for people getting started with it.
</I>&gt;<i>
</I>&gt;<i> I hate the idea that step 1 for some poor new Twisted user would be to go searching around a couple dozen external websites to apply undocumented hacks to try to just get something basic, like relational database communication, to work acceptably for their application.
</I>&gt;<i>
</I>&gt;<i> So, my opinion is that either this isn't a real problem, in which case you shouldn't use it, or it is a real problem, in which case Jeffrey Gelens and powdahound should open a ticket and explain why it's necessary :).
</I>&gt;<i>
</I>&gt;<i> -glyph
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
Well, I did reference two bugs already in the twisted bug tracker that
I believe are related to this issue (4964 definitely is anyway). These
issues have been in the bug tracking system for years now so I'm not
holding my breath on fixes any time soon. I appreciate your desire to
make twisted as good as it can be, but we all have schedules to meet
and hacks, documented or not, are sometimes necessary to move the
project along. So I definitely will consider input from people who
have run into this situation and found a solution that has worked for
them.

If you're not convinced it's a real problem, it's pretty easy to
recreate. Assuming your MySQL wait_timeout = 2, you can run the
following code and get the (2006, 'MySQL server has gone away') error:


from twisted.internet import reactor, defer
from twisted.enterprise import adbapi
import MySQLdb
import MySQLdb.cursors
from time import sleep

pool = adbapi.ConnectionPool(&quot;MySQLdb&quot;, host=&quot;1.2.3.4&quot;,
user=&quot;someuser&quot;, passwd=&quot;xxx&quot;, db=&quot;someschema&quot;,
cursorclass=MySQLdb.cursors.DictCursor, cp_reconnect=True)

def gopherIt(txn):
   txn.execute(&quot;UPDATE Table1 SET Field1 = 123 WHERE Field2 = 456&quot;)
   sleep(3)
   txn.execute(&quot;UPDATE Table1 SET Field1 = 123 WHERE Field2 = 456&quot;)

def done(x):
   print &quot;done&quot;

def error(f):
   print f.value

d = pool.runInteraction(gopherIt)
d.addCallback(done)
d.addErrback(error)

reactor.callLater(4, reactor.stop)
reactor.run()


So, unless I have a misunderstanding about what cp_reconnect is
supposed to do, this is a documented bug. The question is what, if
anything, can be done about it in the short term. Possible solutions
are:

1. Increase the wait_timeout value on the server
2. Override methods in the ConnectionPool class
(<A HREF="http://www.gelens.org/2009/09/13/twisted-connectionpool-revisited/">http://www.gelens.org/2009/09/13/twisted-connectionpool-revisited/</A>)
3. Setup a periodic &quot;ping&quot; in each connection to keep it alive
4. Man up and fix adbapi myself

I'm leaning towards #1 since it seems to be least invasive, but I am
open to other opinions.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="058584.html">[Twisted-Python] Consensus on how to handle &quot;MySQL server has	gone away&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="058588.html">[Twisted-Python] Consensus on how to handle &quot;MySQL server has	gone away&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58585">[ date ]</a>
              <a href="thread.html#58585">[ thread ]</a>
              <a href="subject.html#58585">[ subject ]</a>
              <a href="author.html#58585">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
