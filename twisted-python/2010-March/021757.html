<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] IMAP4 Client extrange behavior
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20IMAP4%20Client%20extrange%20behavior&In-Reply-To=b302bf881002220825g2be89yf0aa7ec7503ab1de%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021751.html">
   <LINK REL="Next"  HREF="021758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] IMAP4 Client extrange behavior</H1>
    <B>C&#233;sar Garc&#237;a</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20IMAP4%20Client%20extrange%20behavior&In-Reply-To=b302bf881002220825g2be89yf0aa7ec7503ab1de%40mail.gmail.com"
       TITLE="[Twisted-Python] IMAP4 Client extrange behavior">celord at gmail.com
       </A><BR>
    <I>Thu Mar  4 16:52:24 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021751.html">[Twisted-Python] Twisted 9.0.0?
</A></li>
        <LI>Next message: <A HREF="021758.html">[Twisted-Python] Twisted Python on Nokia E71x (Running the phone	Python Interpreter)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21757">[ date ]</a>
              <a href="thread.html#21757">[ thread ]</a>
              <a href="subject.html#21757">[ subject ]</a>
              <a href="author.html#21757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all I have solved this, here are my final functions, I thing to
notice is that with twisted 8.2 the one from the debian/ubuntu repos
this functions do not work properly, in the other hand, they work just
fine with twisted 9 and 10

   def selectMailbox(self, mailbox):
        &quot;&quot;&quot;
        Select the mailbox to examin
        &quot;&quot;&quot;
        if debug: print &quot;On selectMailbox&quot;

        mailbox = self.factory.mailbox
        return self.select(mailbox).addCallback(self.cbSelectSuccess)



    def cbSelectSuccess(self, selected):
        &quot;&quot;&quot;
        Examine the INBOX mailbox for new mails

        &quot;&quot;&quot;
        if debug: print &quot;On cbSelectSuccess&quot;


        self.messageCount = selected['EXISTS']
        print &quot;Messages: &quot;, self.messageCount

        unseen = imap4.Query(unseen=True)

        return self.search(unseen
            ).addCallback(self.cbSearch)

    def cbSearch(self,messages):
        if debug: print &quot;on cbSearch&quot;

        messageSet = imap4.MessageSet()

        for message in messages:
            messageSet += message

        if messageSet:

            self.fetchMessage(messageSet, False
                ).addCallback(self.cbProcMessage)
        else:
            return


    def cbProcMessage(self, messages):
        if debug: print &quot;on cbProcEnvelop&quot;

        for message in messages.iteritems():

            body = message[1]['RFC822']
            print body

2010/2/22 C&#233;sar Garc&#237;a &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">celord at gmail.com</A>&gt;:
&gt;<i> Hello all, I have this imap4 client <A HREF="http://www.pastebin.com/m4e387f1a">http://www.pastebin.com/m4e387f1a</A>
</I>&gt;<i> most of the code is barrowed from a IRC friend, bob_f , it works fine
</I>&gt;<i> but as soon as more that 1 email arrrives to the inbox, it only prints
</I>&gt;<i> the first new messages but not the others, &#160;I wonder what am I doing
</I>&gt;<i> wrong
</I>&gt;<i>
</I>&gt;<i> Thanks a lot
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here is the code:
</I>&gt;<i>
</I>&gt;<i> #!/usr/bin/env python
</I>&gt;<i> #coding=utf-8
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &quot;&quot;&quot;
</I>&gt;<i> Client de IMAP4 que descarga contenido del INBOX de una cuenta en especifico
</I>&gt;<i> para luego extraer el numero de telefono que debe venir en los correos enviados
</I>&gt;<i> &quot;&quot;&quot;
</I>&gt;<i>
</I>&gt;<i> import StringIO
</I>&gt;<i> import sys
</I>&gt;<i> from Config import retCredentials
</I>&gt;<i>
</I>&gt;<i> from twisted.internet.task import LoopingCall
</I>&gt;<i> from twisted.internet import protocol
</I>&gt;<i> from twisted.internet import defer
</I>&gt;<i> from twisted.mail import imap4
</I>&gt;<i> from twisted.python import util
</I>&gt;<i> from twisted.python import log
</I>&gt;<i> from twisted.internet import reactor
</I>&gt;<i> debug = 1
</I>&gt;<i>
</I>&gt;<i> class IMAP4Client(imap4.IMAP4Client):
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;def serverGreeting(self,caps):
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;Metodo llamado cuando el servidor contesta
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;if debug: print &quot;On serverGreeting&quot;
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;self.serverCapabilities = caps
</I>&gt;<i> &#160; &#160; &#160; &#160;if self.greetDeferred is not None:
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;d, self.greetDeferred = self.greetDeferred, None
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;d.addCallback(self.cbLogin)
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;d.callback(self)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;def cbLogin(self, proto):
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;Callback to IMAP login
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;if debug: print &quot;On Login&quot;
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;login = &#160;self.login(self.factory.username, self.factory.password)
</I>&gt;<i> &#160; &#160; &#160; &#160;login.addCallback(self.startPolling)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;def startPolling(self, proto):
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;Callback to poll every x seconds
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;call = LoopingCall(self.selectMailbox,mailbox=&quot;INBOX&quot;)
</I>&gt;<i> &#160; &#160; &#160; &#160;call.start(20, now=True)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;def selectMailbox(self, mailbox):
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;Select the mailbox to examin
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;if debug: print &quot;On selectMailbox&quot;
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;mailbox = self.factory.mailbox
</I>&gt;<i> &#160; &#160; &#160; &#160;return self.select(mailbox).addCallback(self.cbSelectSuccess)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;def cbSelectSuccess(self, selected):
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;Examine the INBOX mailbox for new mails
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;&quot;&quot;&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;if debug: print &quot;On cbSelectSuccess&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;self.messageCount = selected['EXISTS']
</I>&gt;<i> &#160; &#160; &#160; &#160;print &quot;Messages: &quot;, self.messageCount
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;unseen = selected['EXISTS'] - selected['RECENT']
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;if selected['RECENT'] == 0:
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;print &quot;No new messages&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;return
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;return self.fetchMessage(&quot;%s:*&quot; % (unseen)
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;).addCallback(self.cbProcMessages)
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;def cbProcMessages(self,messages):
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;print messages
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class IMAP4ClientFactory(protocol.ClientFactory):
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;protocol = IMAP4Client
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;def __init__(self, username, password, &#160;onConn):
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;self.username = username
</I>&gt;<i> &#160; &#160; &#160; &#160;self.password = password
</I>&gt;<i> &#160; &#160; &#160; &#160;self.mailbox = 'INBOX'
</I>&gt;<i> &#160; &#160; &#160; &#160;self.onConn = onConn
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;def buildProtocol(self,addr):
</I>&gt;<i> &#160; &#160; &#160; &#160;if debug: print &quot;On buildProtocol&quot;
</I>&gt;<i> &#160; &#160; &#160; &#160;p = self.protocol()
</I>&gt;<i> &#160; &#160; &#160; &#160;p.factory = self
</I>&gt;<i> &#160; &#160; &#160; &#160;p.greetDeferred = self.onConn
</I>&gt;<i> &#160; &#160; &#160; &#160;auth = imap4.CramMD5ClientAuthenticator(self.username)
</I>&gt;<i> &#160; &#160; &#160; &#160;p.registerAuthenticator(auth)
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; &#160; &#160;return p
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;def clientConectionFailed(self, connector, reason):
</I>&gt;<i> &#160; &#160; &#160; &#160;d, self.onConn = self.onConn, None
</I>&gt;<i> &#160; &#160; &#160; &#160;d.errback(reason)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def ebConnection(reason):
</I>&gt;<i> &#160; &#160;log.startLogging(sys.stdout)
</I>&gt;<i> &#160; &#160;log.err(reason)
</I>&gt;<i> &#160; &#160;reactor.stop()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> PORT = 143
</I>&gt;<i> RESULT = &quot;INBOX&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def main():
</I>&gt;<i> &#160; &#160;credentials = retCredentials()
</I>&gt;<i> &#160; &#160;hostname = credentials['server']
</I>&gt;<i> &#160; &#160;username = credentials['mailbox']
</I>&gt;<i> &#160; &#160;password = util.getPassword('IMAP4 Password: ')
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;onConn = defer.Deferred(
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;).addErrback(ebConnection
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160;)
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;factory = IMAP4ClientFactory(username, password, onConn)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160; &#160;reactor.connectTCP(hostname, PORT, factory)
</I>&gt;<i> &#160; &#160;reactor.run()
</I>&gt;<i>
</I>&gt;<i> if &#160;__name__ == &quot;__main__&quot;:
</I>&gt;<i> &#160; &#160;main()
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> <A HREF="http://celord.blogspot.com/">http://celord.blogspot.com/</A>
</I>&gt;<i>
</I>


-- 
<A HREF="http://celord.blogspot.com/">http://celord.blogspot.com/</A>

</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021751.html">[Twisted-Python] Twisted 9.0.0?
</A></li>
	<LI>Next message: <A HREF="021758.html">[Twisted-Python] Twisted Python on Nokia E71x (Running the phone	Python Interpreter)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21757">[ date ]</a>
              <a href="thread.html#21757">[ thread ]</a>
              <a href="subject.html#21757">[ subject ]</a>
              <a href="author.html#21757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
