<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] IMAP4 Client extrange behavior
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IMAP4%20Client%20extrange%20behavior&In-Reply-To=%3Cb302bf881003041352i6e7e3075i3f0daba66d7ca065%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="054249.html">
   <LINK REL="Next"  HREF="054256.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] IMAP4 Client extrange behavior</H1>
    <B>César García</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IMAP4%20Client%20extrange%20behavior&In-Reply-To=%3Cb302bf881003041352i6e7e3075i3f0daba66d7ca065%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] IMAP4 Client extrange behavior">celord at gmail.com
       </A><BR>
    <I>Thu Mar  4 14:52:24 MST 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="054249.html">[Twisted-Python] Twisted 9.0.0?
</A></li>
        <LI>Next message (by thread): <A HREF="054256.html">[Twisted-Python] Twisted Python on Nokia E71x (Running the phone	Python Interpreter)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54255">[ date ]</a>
              <a href="thread.html#54255">[ thread ]</a>
              <a href="subject.html#54255">[ subject ]</a>
              <a href="author.html#54255">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all I have solved this, here are my final functions, I thing to
notice is that with twisted 8.2 the one from the debian/ubuntu repos
this functions do not work properly, in the other hand, they work just
fine with twisted 9 and 10

   def selectMailbox(self, mailbox):
        &quot;&quot;&quot;
        Select the mailbox to examin
        &quot;&quot;&quot;
        if debug: print &quot;On selectMailbox&quot;

        mailbox = self.factory.mailbox
        return self.select(mailbox).addCallback(self.cbSelectSuccess)



    def cbSelectSuccess(self, selected):
        &quot;&quot;&quot;
        Examine the INBOX mailbox for new mails

        &quot;&quot;&quot;
        if debug: print &quot;On cbSelectSuccess&quot;


        self.messageCount = selected['EXISTS']
        print &quot;Messages: &quot;, self.messageCount

        unseen = imap4.Query(unseen=True)

        return self.search(unseen
            ).addCallback(self.cbSearch)

    def cbSearch(self,messages):
        if debug: print &quot;on cbSearch&quot;

        messageSet = imap4.MessageSet()

        for message in messages:
            messageSet += message

        if messageSet:

            self.fetchMessage(messageSet, False
                ).addCallback(self.cbProcMessage)
        else:
            return


    def cbProcMessage(self, messages):
        if debug: print &quot;on cbProcEnvelop&quot;

        for message in messages.iteritems():

            body = message[1]['RFC822']
            print body

2010/2/22 César García &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">celord at gmail.com</A>&gt;:
&gt;<i> Hello all, I have this imap4 client <A HREF="http://www.pastebin.com/m4e387f1a">http://www.pastebin.com/m4e387f1a</A>
</I>&gt;<i> most of the code is barrowed from a IRC friend, bob_f , it works fine
</I>&gt;<i> but as soon as more that 1 email arrrives to the inbox, it only prints
</I>&gt;<i> the first new messages but not the others,  I wonder what am I doing
</I>&gt;<i> wrong
</I>&gt;<i>
</I>&gt;<i> Thanks a lot
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Here is the code:
</I>&gt;<i>
</I>&gt;<i> #!/usr/bin/env python
</I>&gt;<i> #coding=utf-8
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &quot;&quot;&quot;
</I>&gt;<i> Client de IMAP4 que descarga contenido del INBOX de una cuenta en especifico
</I>&gt;<i> para luego extraer el numero de telefono que debe venir en los correos enviados
</I>&gt;<i> &quot;&quot;&quot;
</I>&gt;<i>
</I>&gt;<i> import StringIO
</I>&gt;<i> import sys
</I>&gt;<i> from Config import retCredentials
</I>&gt;<i>
</I>&gt;<i> from twisted.internet.task import LoopingCall
</I>&gt;<i> from twisted.internet import protocol
</I>&gt;<i> from twisted.internet import defer
</I>&gt;<i> from twisted.mail import imap4
</I>&gt;<i> from twisted.python import util
</I>&gt;<i> from twisted.python import log
</I>&gt;<i> from twisted.internet import reactor
</I>&gt;<i> debug = 1
</I>&gt;<i>
</I>&gt;<i> class IMAP4Client(imap4.IMAP4Client):
</I>&gt;<i>
</I>&gt;<i>    def serverGreeting(self,caps):
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        Metodo llamado cuando el servidor contesta
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        if debug: print &quot;On serverGreeting&quot;
</I>&gt;<i>
</I>&gt;<i>        self.serverCapabilities = caps
</I>&gt;<i>        if self.greetDeferred is not None:
</I>&gt;<i>            d, self.greetDeferred = self.greetDeferred, None
</I>&gt;<i>            d.addCallback(self.cbLogin)
</I>&gt;<i>            d.callback(self)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    def cbLogin(self, proto):
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        Callback to IMAP login
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        if debug: print &quot;On Login&quot;
</I>&gt;<i>
</I>&gt;<i>        login =  self.login(self.factory.username, self.factory.password)
</I>&gt;<i>        login.addCallback(self.startPolling)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    def startPolling(self, proto):
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        Callback to poll every x seconds
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        call = LoopingCall(self.selectMailbox,mailbox=&quot;INBOX&quot;)
</I>&gt;<i>        call.start(20, now=True)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    def selectMailbox(self, mailbox):
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        Select the mailbox to examin
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        if debug: print &quot;On selectMailbox&quot;
</I>&gt;<i>
</I>&gt;<i>        mailbox = self.factory.mailbox
</I>&gt;<i>        return self.select(mailbox).addCallback(self.cbSelectSuccess)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    def cbSelectSuccess(self, selected):
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        Examine the INBOX mailbox for new mails
</I>&gt;<i>
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        if debug: print &quot;On cbSelectSuccess&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>        self.messageCount = selected['EXISTS']
</I>&gt;<i>        print &quot;Messages: &quot;, self.messageCount
</I>&gt;<i>
</I>&gt;<i>        unseen = selected['EXISTS'] - selected['RECENT']
</I>&gt;<i>
</I>&gt;<i>        if selected['RECENT'] == 0:
</I>&gt;<i>            print &quot;No new messages&quot;
</I>&gt;<i>            return
</I>&gt;<i>
</I>&gt;<i>        return self.fetchMessage(&quot;%s:*&quot; % (unseen)
</I>&gt;<i>                ).addCallback(self.cbProcMessages)
</I>&gt;<i>
</I>&gt;<i>    def cbProcMessages(self,messages):
</I>&gt;<i>
</I>&gt;<i>        print messages
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class IMAP4ClientFactory(protocol.ClientFactory):
</I>&gt;<i>
</I>&gt;<i>    protocol = IMAP4Client
</I>&gt;<i>
</I>&gt;<i>    def __init__(self, username, password,  onConn):
</I>&gt;<i>
</I>&gt;<i>        self.username = username
</I>&gt;<i>        self.password = password
</I>&gt;<i>        self.mailbox = 'INBOX'
</I>&gt;<i>        self.onConn = onConn
</I>&gt;<i>
</I>&gt;<i>    def buildProtocol(self,addr):
</I>&gt;<i>        if debug: print &quot;On buildProtocol&quot;
</I>&gt;<i>        p = self.protocol()
</I>&gt;<i>        p.factory = self
</I>&gt;<i>        p.greetDeferred = self.onConn
</I>&gt;<i>        auth = imap4.CramMD5ClientAuthenticator(self.username)
</I>&gt;<i>        p.registerAuthenticator(auth)
</I>&gt;<i>
</I>&gt;<i>        return p
</I>&gt;<i>
</I>&gt;<i>    def clientConectionFailed(self, connector, reason):
</I>&gt;<i>        d, self.onConn = self.onConn, None
</I>&gt;<i>        d.errback(reason)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def ebConnection(reason):
</I>&gt;<i>    log.startLogging(sys.stdout)
</I>&gt;<i>    log.err(reason)
</I>&gt;<i>    reactor.stop()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> PORT = 143
</I>&gt;<i> RESULT = &quot;INBOX&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def main():
</I>&gt;<i>    credentials = retCredentials()
</I>&gt;<i>    hostname = credentials['server']
</I>&gt;<i>    username = credentials['mailbox']
</I>&gt;<i>    password = util.getPassword('IMAP4 Password: ')
</I>&gt;<i>
</I>&gt;<i>    onConn = defer.Deferred(
</I>&gt;<i>            ).addErrback(ebConnection
</I>&gt;<i>            )
</I>&gt;<i>
</I>&gt;<i>    factory = IMAP4ClientFactory(username, password, onConn)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    reactor.connectTCP(hostname, PORT, factory)
</I>&gt;<i>    reactor.run()
</I>&gt;<i>
</I>&gt;<i> if  __name__ == &quot;__main__&quot;:
</I>&gt;<i>    main()
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> <A HREF="http://celord.blogspot.com/">http://celord.blogspot.com/</A>
</I>&gt;<i>
</I>


-- 
<A HREF="http://celord.blogspot.com/">http://celord.blogspot.com/</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="054249.html">[Twisted-Python] Twisted 9.0.0?
</A></li>
	<LI>Next message (by thread): <A HREF="054256.html">[Twisted-Python] Twisted Python on Nokia E71x (Running the phone	Python Interpreter)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54255">[ date ]</a>
              <a href="thread.html#54255">[ thread ]</a>
              <a href="subject.html#54255">[ subject ]</a>
              <a href="author.html#54255">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
