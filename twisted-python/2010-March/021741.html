<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] SSHSessionProcessProtocol.inConnectionLost()	behavior and Git over Conch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20SSHSessionProcessProtocol.inConnectionLost%28%29%0A%09behavior%20and%20Git%20over%20Conch&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021740.html">
   <LINK REL="Next"  HREF="021765.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] SSHSessionProcessProtocol.inConnectionLost()	behavior and Git over Conch</H1>
    <B>Bo Shi</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20SSHSessionProcessProtocol.inConnectionLost%28%29%0A%09behavior%20and%20Git%20over%20Conch&In-Reply-To="
       TITLE="[Twisted-Python] SSHSessionProcessProtocol.inConnectionLost()	behavior and Git over Conch">bs1984 at gmail.com
       </A><BR>
    <I>Wed Mar  3 23:46:33 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021740.html">[Twisted-Python] debugging a memory leak
</A></li>
        <LI>Next message: <A HREF="021765.html">[Twisted-Python] SSHSessionProcessProtocol.inConnectionLost()	behavior and Git over Conch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21741">[ date ]</a>
              <a href="thread.html#21741">[ thread ]</a>
              <a href="subject.html#21741">[ subject ]</a>
              <a href="author.html#21741">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi All,

I've been struggling with this issue off and on for the better part of
a month now.  Having implemented a simple git SSH server using some of
the Conch examples in the official documentation, I encountered an
issue that would cause a git client to throw an error only part of the
time.

The little program to reproduce the issue is found at

    <A HREF="http://gist.github.com/321403">http://gist.github.com/321403</A>

    (raw version for download)
    <A HREF="http://gist.github.com/raw/321403/82ab2111a2709c8fe50a77aabb08565749087408/gitconnbug.py">http://gist.github.com/raw/321403/82ab2111a2709c8fe50a77aabb08565749087408/gitconnbug.py</A>

and can be executed to start the sample server.  Run a command like

    # The /abspath/to/git/repo should be readable by the server user
    $ git clone <A HREF="ssh://user@localhost:2222/abspath/to/git/repo">ssh://user@localhost:2222/abspath/to/git/repo</A>
    (password &quot;user&quot;)

To test the server.  On my workstation, I am able to reproduce the
error at least once every 5 tries.  It's definitely not consistent.
The behavior I see is attached at the end of this email.  The client
fails due to a premature inConnectionLost() call in the
SSHSessionProcessProtocol that sends an EOF.


As a workaround, when TraceProcessProtocol.inConnectionLost() is
overriden to do nothing, the client error goes away.  This is somewhat
foreign territory for me so I'm not sure whether it's a bug in git or
whether it's a bug in the twisted ProcessProtocol implementation.  RFC
4254 isn't terribly helpful here:

    5.3.  Closing a Channel

       When a party will no longer send more data to a channel, it SHOULD
       send SSH_MSG_CHANNEL_EOF.

So on the surface the current behavior of sending an EOF appears fine,
however, I can't really find any definitive cases of this type of
problem popping up via, say, default OpenSSH/git combinations.


Any advice?  Is the gitconnbug.py implementation flawed?  Should I
open a ticket?  Any git experts know of a case where git-upload-pack
might close it's stdout pipe?


Thanks,
Bo


Successful case (server side logging, timestamp cut out):

    [SSHChannel session (0) on SSHService ssh-connection
    on SSHServerTransport,1,127.0.0.1] executing command
    &quot;git-upload-pack '/Users/bshi/sandbox/poop'&quot;
    [-] TPP.outReceived(...) 199 bytes
    [-] TPP.outReceived(...) 146 bytes
    [-] TPP.outReceived(...) 8 bytes
    [-] TPP.outReceived(...) 33 bytes
    [-] TPP.outReceived(...) 41 bytes
    [-] TPP.outReceived(...) 77 bytes
    [-] TPP.outReceived(...) 1228 bytes
    [-] TPP.outReceived(...) 8192 bytes
    [-] TPP.outReceived(...) 4567 bytes
    [-] TPP.inConnectionLost()
    [-] sending eof
    [-] exitCode: 0

Successful case (client-side shell session):

    $ GIT_TRACE=1 git clone <A HREF="ssh://user@localhost:2222/Users/bshi/sandbox/poop">ssh://user@localhost:2222/Users/bshi/sandbox/poop</A>

    trace: built-in: git 'clone'
'<A HREF="ssh://user@localhost:2222/Users/bshi/sandbox/poop'">ssh://user@localhost:2222/Users/bshi/sandbox/poop'</A>
    Initialized empty Git repository in /tmp/poop/.git/
    trace: run_command: 'ssh' '-p' '2222' '<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">user at localhost</A>' 'git-upload-pack
           '\''/Users/bshi/sandbox/poop'\'''
    <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">user at localhost</A>'s password:
    trace: run_command: 'index-pack' '--stdin' '-v' '--fix-thin'
                        '--keep=fetch-pack 763 on Bo-Shis-MacBook-Pro.local'
    trace: exec: 'git' 'index-pack' '--stdin' '-v' '--fix-thin'
                 '--keep=fetch-pack 763 on Bo-Shis-MacBook-Pro.local'
    trace: exec: 'git-index-pack' '--stdin' '-v' '--fix-thin'
                 '--keep=fetch-pack 763 on Bo-Shis-MacBook-Pro.local'
    trace: run_command: 'git-index-pack' '--stdin' '-v' '--fix-thin'
                        '--keep=fetch-pack 763 on Bo-Shis-MacBook-Pro.local'
    remote: Counting objects: 50, done.
    remote: Compressing objects: 100% (35/35), done.
    remote: Total 50 (delta 16), reused 43 (delta 14)
    Receiving objects: 100% (50/50), 12.36 KiB, done.
    Resolving deltas: 100% (16/16), done.

Failure case (server side):

    [SSHChannel session (0) on SSHService ssh-connection
    on SSHServerTransport,2,127.0.0.1] executing command
    &quot;git-upload-pack '/Users/bshi/sandbox/poop'&quot;
    [-] TPP.outReceived(...) 345 bytes
    [-] TPP.outReceived(...) 8 bytes
    [-] TPP.outReceived(...) 33 bytes
    [-] TPP.outReceived(...) 8192 bytes
    [-] TPP.inConnectionLost()
    [-] sending eof
    [-] TPP.outReceived(...) 5903 bytes
    [-] exitCode: 0
    [-] sending request exit-status
    [-] sending close 0


Failure case (&quot;trace:&quot; messages similar, cut out for readability):

    $ GIT_TRACE=1 git clone <A HREF="ssh://user@localhost:2222/Users/bshi/sandbox/poop">ssh://user@localhost:2222/Users/bshi/sandbox/poop</A>
    <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">user at localhost</A>'s password:
    ...
    ...
    remote: Counting objects: 50, done.
    fatal: The remote end hung up unexpectedly
    fatal: early EOF
    fatal: index-pack failed

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021740.html">[Twisted-Python] debugging a memory leak
</A></li>
	<LI>Next message: <A HREF="021765.html">[Twisted-Python] SSHSessionProcessProtocol.inConnectionLost()	behavior and Git over Conch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21741">[ date ]</a>
              <a href="thread.html#21741">[ thread ]</a>
              <a href="subject.html#21741">[ subject ]</a>
              <a href="author.html#21741">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
