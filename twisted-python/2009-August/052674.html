<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Adbapi issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Adbapi%20issues&In-Reply-To=%3C4A7A383F.7010900%40krondo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052672.html">
   <LINK REL="Next"  HREF="052679.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Adbapi issues</H1>
    <B>Dave Peticolas</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Adbapi%20issues&In-Reply-To=%3C4A7A383F.7010900%40krondo.com%3E"
       TITLE="[Twisted-Python] Adbapi issues">dave at krondo.com
       </A><BR>
    <I>Wed Aug  5 19:56:15 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052672.html">[Twisted-Python] Adbapi issues
</A></li>
        <LI>Next message (by thread): <A HREF="052679.html">[Twisted-Python] Adbapi issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52674">[ date ]</a>
              <a href="thread.html#52674">[ thread ]</a>
              <a href="subject.html#52674">[ subject ]</a>
              <a href="author.html#52674">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Gerrat Rickert wrote:
&gt;<i> I'd like to use twisted's adbapi module (twisted 8.2.0 for python 2.5)
</I>&gt;<i> with cx_Oracle, but I'm having some issues with it.  
</I>&gt;<i> Specifically:
</I>&gt;<i> 
</I>&gt;<i> 1.  It doesn't seem to reconnect (or possibly I just need enlightenment
</I>&gt;<i> on how reconnecting works):
</I>&gt;<i> If I tweak part of the test_adbapi.py script to work for Oracle (using a
</I>&gt;<i> proper &quot;conn_str&quot;, and ignoring the irrelevant parts), I get something
</I>&gt;<i> like:
</I>&gt;<i> 
</I>&gt;<i> class OracleTests(unittest.TestCase):
</I>&gt;<i>     &quot;&quot;&quot;Test adbapi for Oracle&quot;&quot;&quot;
</I>&gt;<i>   
</I>&gt;<i>     timeout = 10
</I>&gt;<i>   
</I>&gt;<i>     def setUp(self):
</I>&gt;<i>         self.dbpool = adbapi.ConnectionPool('cx_Oracle', conn_str, 
</I>&gt;<i>                cp_noisy=True, cp_min=1, cp_reconnect=True, cp_max=3,
</I>&gt;<i> cp_good_sql='select * from dual', threaded=True)
</I>&gt;<i>   
</I>&gt;<i>   
</I>&gt;<i>     def test_reconnect(self):
</I>&gt;<i>         d = defer.succeed(None)
</I>&gt;<i>         d.addCallback(self._testPool_1)
</I>&gt;<i>         d.addCallback(self._testPool_2)
</I>&gt;<i>         d.addCallback(self._testPool_3)
</I>&gt;<i>         return d
</I>&gt;<i>     
</I>&gt;<i>     def _testPool_1(self, res):
</I>&gt;<i>         def _success(rslt):
</I>&gt;<i>             self.failUnless(rslt[0][0] == 'X', &quot;Select from dual not
</I>&gt;<i> working&quot;)
</I>&gt;<i>     
</I>&gt;<i>         d = self.dbpool.runQuery(&quot;select * from dual&quot;)
</I>&gt;<i>         d.addCallback(_success)
</I>&gt;<i>         return d
</I>&gt;<i>   
</I>&gt;<i>     def _testPool_2(self, res):
</I>&gt;<i>         self.dbpool.connections.values()[0].close()
</I>&gt;<i>   
</I>&gt;<i>     def _testPool_3(self, res):
</I>&gt;<i>     
</I>&gt;<i>         sql = &quot;select * from dual&quot;
</I>&gt;<i>         d = self.dbpool.runQuery(sql)
</I>&gt;<i>         def _check(row):
</I>&gt;<i>             self.failUnless(row[0][0] == 'X', &quot; Select from dual not
</I>&gt;<i> working &quot;)
</I>&gt;<i>         d.addCallback(_check)
</I>&gt;<i>         return d
</I>&gt;<i> 
</I>&gt;<i> I get this traceback:
</I>&gt;<i> 
</I>&gt;<i> [ERROR]: test_oracle.OracleTests.test_reconnect
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i>   File &quot;C:\Python25\Lib\site-packages\twisted\python\threadpool.py&quot;,
</I>&gt;<i> line 210, i
</I>&gt;<i> n _worker
</I>&gt;<i>     result = context.call(ctx, function, *args, **kwargs)
</I>&gt;<i>   File &quot;C:\Python25\Lib\site-packages\twisted\python\context.py&quot;, line
</I>&gt;<i> 59, in ca
</I>&gt;<i> llWithContext
</I>&gt;<i>     return self.currentContext().callWithContext(ctx, func, *args, **kw)
</I>&gt;<i>   File &quot;C:\Python25\Lib\site-packages\twisted\python\context.py&quot;, line
</I>&gt;<i> 37, in ca
</I>&gt;<i> llWithContext
</I>&gt;<i>     return func(*args,**kw)
</I>&gt;<i>   File &quot;c:\python25\lib\site-packages\twisted\enterprise\adbapi.py&quot;,
</I>&gt;<i> line 429, i
</I>&gt;<i> n _runInteraction
</I>&gt;<i>     result = interaction(trans, *args, **kw)
</I>&gt;<i>   File &quot;c:\python25\lib\site-packages\twisted\enterprise\adbapi.py&quot;,
</I>&gt;<i> line 443, i
</I>&gt;<i> n _runQuery
</I>&gt;<i>     trans.execute(*args, **kw)
</I>&gt;<i> cx_Oracle.InterfaceError: not connected
</I>&gt;<i> 
</I>&gt;<i> ...am I doing something wrong, or is this something specific to Oracle?
</I>&gt;<i> I apologize for the seemingly rhetorical question, but does this
</I>&gt;<i> actually work for other databases (I don't have any others installed, so
</I>&gt;<i> trial just skips most of the tests when I run test_adbapi.py)?
</I>
I didn't look at the code too closely, but here's something to note
about the 'reconnect' mode: If the connection fails, the first query
on the closed connection will still fail. Adbapi cannot, in general,
know whether the query went through and then the connection failed,
or not, so to be safe it doesn't retry.


&gt;<i> 2.  ...since I can't get it to reconnect properly, perhaps I could just
</I>&gt;<i> close the connections in the old connection pool, and create a new
</I>&gt;<i> one...
</I>&gt;<i> 
</I>&gt;<i> dbpool = adbapi.ConnectionPool('cx_Oracle', conn_str, 
</I>&gt;<i>                cp_noisy=True, cp_min=1, cp_reconnect=True, cp_max=3,
</I>&gt;<i> cp_good_sql='select * from dual', threaded=True)
</I>&gt;<i> dbpool.close()
</I>&gt;<i> 
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i>   File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;
</I>&gt;<i>   File &quot;c:\python25\lib\site-packages\twisted\enterprise\adbapi.py&quot;,
</I>&gt;<i> line 359, i
</I>&gt;<i> n close
</I>&gt;<i>     if self.shutdownID:
</I>&gt;<i> AttributeError: ConnectionPool instance has no attribute 'shutdownID'
</I>&gt;<i> 
</I>&gt;<i> ...shouldn't shutdownID be initialized in the class, or at least in
</I>&gt;<i> __init__ ?
</I>
Yes, probably so. Feel submit a ticket, including a patch if you want.


&gt;<i> 3.  ...as stated in PEP 249, under fetchall(), &quot;... Note that the
</I>&gt;<i> cursor's arraysize attribute can affect the performance of this
</I>&gt;<i> operation.&quot;  In the PEP, cursor.arraysize defaults to 1, which results
</I>&gt;<i> in absolutely terrible performance when retrieving a large number of
</I>&gt;<i> rows from the database (empirically tested).  Since twisted has already
</I>&gt;<i> gone through the trouble of wrapping simple calls to the database (like
</I>&gt;<i> it's runQuery), it would be ideal if this was an optional parameter that
</I>&gt;<i> could be passed in.  It doesn't look possible to do this in the current
</I>&gt;<i> adbapi module (or perhaps, I might just need enlightening again):
</I>&gt;<i> 
</I>&gt;<i>     def _runQuery(self, trans, *args, **kw):
</I>&gt;<i>         trans.execute(*args, **kw)
</I>&gt;<i>         return trans.fetchall() 
</I>&gt;<i> 
</I>&gt;<i> ...perhaps it could be something more like:
</I>&gt;<i> 
</I>&gt;<i>     def _runQuery(self, trans, *args, **kw):
</I>&gt;<i>         if kw.has_key('arraysize'):
</I>&gt;<i>             trans._cursor.arraysize = kw['arraysize']
</I>&gt;<i>         trans.execute(*args, **kw)
</I>&gt;<i>         return trans.fetchall()
</I>
Supporting arraysize in some form is probably a good idea. Another
ticket is in order.


&gt;<i> 
</I>&gt;<i> 4.  Timeouts.  ...well, since Deferred.setTimeout is deprecated, and we
</I>&gt;<i> can't cancel deferreds, most protocols (or asynchronous &quot;mechanisms&quot; if
</I>&gt;<i> protocol isn't the right term here) should probably have a timeout
</I>&gt;<i> mechanism.  (...or is everyone looking at me like I'm from outer-space?)
</I>&gt;<i> Is there a canonical way of timing out a connection?  If I were to do a
</I>&gt;<i> dbpool.runQuery(&quot;select some_cols from some_table&quot;); and attach a
</I>&gt;<i> timeout mechanism to the deferred that it returns, is there a way to
</I>&gt;<i> drop/recycle that particular connection from the pool if it didn't
</I>&gt;<i> respond in a timely fashion? ...or (assuming the dbpool.close() issue
</I>&gt;<i> went away), would &quot;best-practice&quot; be just closing the old pool, and
</I>&gt;<i> re-creating it?  
</I>
Since the query is running in a blocked thread, there's not much you
can do, as far as I know.


&gt;<i> 
</I>&gt;<i> ...is this module widely used in production, or are most people using
</I>&gt;<i> something like SqlAlchemy (or &quot;rolling their own&quot;)?
</I>
I use it widely in production with cx_Oracle. I use a subclass so I can
set arraysize. I use it to provide connections to other scripts, so when
the connections go wonky I close and reopen the pool, or just restart
the process.


&gt;<i> Thanks,
</I>&gt;<i> 	Gerrat
</I>&gt;<i> 
</I>
dave


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052672.html">[Twisted-Python] Adbapi issues
</A></li>
	<LI>Next message (by thread): <A HREF="052679.html">[Twisted-Python] Adbapi issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52674">[ date ]</a>
              <a href="thread.html#52674">[ thread ]</a>
              <a href="subject.html#52674">[ subject ]</a>
              <a href="author.html#52674">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
