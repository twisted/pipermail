<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Tunneling using conch (with	application.service)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Tunneling%20using%20conch%20%28with%0A%09application.service%29&In-Reply-To=66dccc4d0908060847y21a42afdt2c1d831419d710a0%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020174.html">
   <LINK REL="Next"  HREF="020206.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Tunneling using conch (with	application.service)</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Tunneling%20using%20conch%20%28with%0A%09application.service%29&In-Reply-To=66dccc4d0908060847y21a42afdt2c1d831419d710a0%40mail.gmail.com"
       TITLE="[Twisted-Python] Tunneling using conch (with	application.service)">exarkun at twistedmatrix.com
       </A><BR>
    <I>Sat Aug  8 12:49:25 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020174.html">[Twisted-Python] Tunneling using conch (with application.service)
</A></li>
        <LI>Next message: <A HREF="020206.html">[Twisted-Python] Tunneling using conch (with	application.service)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20183">[ date ]</a>
              <a href="thread.html#20183">[ thread ]</a>
              <a href="subject.html#20183">[ subject ]</a>
              <a href="author.html#20183">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6 Aug, 03:47 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">smhollingsworth at gmail.com</A> wrote:
&gt;<i>I 19ve got an app written that runs as a service using
</I>&gt;<i>twisted.application.service that I need to tunnel through SSH. Right 
</I>&gt;<i>now, I
</I>&gt;<i>use a script that makes use of Paramiko (and runs separate from my app) 
</I>&gt;<i>to
</I>&gt;<i>set up a tunnel. That more or less works, but I 19ve had some problems 
</I>&gt;<i>with
</I>&gt;<i>the tunnel just going away and would like to integrate the tunneling 
</I>&gt;<i>into
</I>&gt;<i>the app, using conch. I 19ve found an example of tunneling via conch, at
</I>&gt;<i><A HREF="http://twistedmatrix.com/pipermail/twisted-">http://twistedmatrix.com/pipermail/twisted-</A> 
</I>&gt;<i>python/2009-February/019196.html,
</I>&gt;<i>that I think I can use as a base to add the code to my app.
</I>&gt;<i>
</I>&gt;<i>Right now my app is basically:
</I>&gt;<i>
</I>&gt;<i>class DataPuller(service.Service):
</I>&gt;<i>    ...Code for my app...
</I>&gt;<i>    ... The app pulls data from a database and I can only connect to the
</I>&gt;<i>server via SSH...
</I>&gt;<i>
</I>&gt;<i>application = service.Application( 18Data_puller 19)
</I>&gt;<i>dpService = DataPuller()
</I>&gt;<i>dpService.setServiceParent(application)
</I>&gt;<i>
</I>&gt;<i>My main problems are that I 19m not sure whether or not the example 
</I>&gt;<i>linked to
</I>&gt;<i>above is a good one for tunneling with conch and, if it is, how do I 
</I>&gt;<i>merge
</I>&gt;<i>the example tunneling code with my app code. From the example, where 
</I>&gt;<i>the
</I>&gt;<i>code is:
</I>
The example you linked to sets up the traditional port forwarding 
behavior.
A local port is opened and connections to it are tunneled over the SSH
connection, where data is then delivered to some address accessible from
the server on the other end of the SSH connection.

This is fine and should work, and probably very closely mirrors what 
you're
doing with Paramiko, so if you're happy with that, you should go for it.

However, it's also possible for you to do this tunneling without opening
the extra local port.  Since your application and the SSH client code 
are
all in the same process, you don't need the TCP connection to a local 
port
to do this IPC to interact wiht the tunnel.  You can set up the tunnel 
part
of things, but instead of binding a local port to accept connections on,
you can just open a connection over the tunnel and write bytes into it 
with
API calls.

I *don't* have an example of doing things this way, and I don't even 
know
exactly what it involves. ;)  However, the example you linked to gives a
clue about where to start on this approach: when it binds the local 
port,
it uses the forwarding.SSHListenForwardingFactory factory, so I'd start
by looking at that class and see what it does.  The rest is just 
mimicking
its behavior without actually using reactor.listenTCP.
&gt;<i>class Connection(connection.SSHConnection):
</I>&gt;<i>        .
</I>&gt;<i>        .
</I>&gt;<i>        .
</I>&gt;<i>        def serviceStarted(self):
</I>&gt;<i>
</I>&gt;<i>Do I instantiate my DataPuller class there, in serviceStarted (and not
</I>&gt;<i>subclass from service.Service)? If so, how do I wrap the tunneling code 
</I>&gt;<i>so
</I>&gt;<i>that I can make it a service? If not, do I need put the tunneling code
</I>&gt;<i>inside my DataPuller class? What would that look like?
</I>
If you want things to happen when your program starts or when it is 
about
to stop, then using service.Service is still a good idea.  That's the 
easy
way to hook into startup and shutdown events.  However, you may not want
to do anything other than set up (or tear down) the SSH connection in 
your
service.Service subclass.  Creating your new non-Service DataPuller in 
the
Connection's serviceStarted (or maybe even a little later - after you
actually set up the connection over the tunnel over the connection) then
makes sense.

Jean-Paul

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020174.html">[Twisted-Python] Tunneling using conch (with application.service)
</A></li>
	<LI>Next message: <A HREF="020206.html">[Twisted-Python] Tunneling using conch (with	application.service)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20183">[ date ]</a>
              <a href="thread.html#20183">[ thread ]</a>
              <a href="subject.html#20183">[ subject ]</a>
              <a href="author.html#20183">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
