<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to debug an AMP connection?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20debug%20an%20AMP%20connection%3F&In-Reply-To=%3C1249487947.10070.1328437413%40webmail.messagingengine.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052659.html">
   <LINK REL="Next"  HREF="052688.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to debug an AMP connection?</H1>
    <B>Peter Westlake</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20debug%20an%20AMP%20connection%3F&In-Reply-To=%3C1249487947.10070.1328437413%40webmail.messagingengine.com%3E"
       TITLE="[Twisted-Python] How to debug an AMP connection?">peter.westlake at pobox.com
       </A><BR>
    <I>Wed Aug  5 09:59:07 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052659.html">[Twisted-Python] My first wxPython App with Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="052688.html">[Twisted-Python] How to debug an AMP connection?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52670">[ date ]</a>
              <a href="thread.html#52670">[ thread ]</a>
              <a href="subject.html#52670">[ subject ]</a>
              <a href="author.html#52670">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Background: I have a client program that calls callRemote, but the
Deferred that callRemote returns is not fired. This is an intermittent
error that only happens after some hours of traffic.

By putting some logging into AMP, it's apparent that the server gets
as far as sending the reply using BoxDispatcher._safeEmit. The
original version of that ignores connection errors, but I overrode it
with one that doesn't:

    trace_tags = False
 
    def _safeEmit(self, aBox):
        &quot;&quot;&quot;
        Emit a box, ignoring L{ProtocolSwitched} and L{ConnectionLost}
        errors
        which cannot be usefully handled.
        &quot;&quot;&quot;
        tag = None
        if amp.ANSWER in aBox:
            tag = aBox[amp.ANSWER]
        elif amp.ERROR in aBox:
            tag = aBox[amp.ERROR]
        if self.trace_tags and tag:
            log.debug('_safeEmit', tag)
        try:
            aBox._sendTo(self.boxSender)
        except (ProtocolSwitched, ConnectionLost):
            log.debug('ProtocolSwitched or ConnectionLost in _safeEmit',
            tag)

The message in the last line is never seen, nor is there anything else
in the logs on client or server to suggest that there has been any
problem with the connection.

On the client, BoxDispatcher._answerReceived logs all replies:

    def _answerReceived(self, box):
        &quot;&quot;&quot;
        An AMP box was received that answered a command previously sent
        with
        L{callRemote}.

        @param box: an AmpBox with a value for its L{ANSWER} key.
        &quot;&quot;&quot;
        b = box[ANSWER]
        question = self._outstandingRequests.pop(box[ANSWER])
        question.addErrback(self.unhandledError)
        log.msg('_answerReceived', b, question)
        question.callback(box)
        log.msg('_answerReceived', b, 'returning')

Likewise _errorReceived.

I always see both log.msgs or neither, so it isn't something going
wrong in the callback.

The client sends a request.
The server sends a reply with the same tag, and logs a message.
Until it goes wrong, the client receives the reply and logs it.
When it goes wrong, the client does not see the reply.

The protocol has the unfired Deferred in _outstandingRequests,
with the missing tag as key.

All this suggests that the problem is either in the low-level
network code, or somewhere in the network between the client
and server. But doesn't TCP/IP tell you if a packet doesn't
get through?

I tried tracing the packets using a python-pycapy script (attached),
but it showed more packets disappearing than actually were. That
could be for several reasons, including the packet sniffer missing
packets, and the _ask or _answer key not being the first thing in
the box. It also made the problem go away to a large extent, though
that may have been the &quot;tail -F&quot; I was running against the log. It
does take a lot longer for the bug to manifest when tracing it.

At this point, I'm stuck! If there isn't a solution to this,
the only answer will be to time out and retry the command.
But since TCP connections are meant to be reliable (or to
give an error if they fail), I hope it won't come to that.

Peter.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052659.html">[Twisted-Python] My first wxPython App with Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="052688.html">[Twisted-Python] How to debug an AMP connection?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52670">[ date ]</a>
              <a href="thread.html#52670">[ thread ]</a>
              <a href="subject.html#52670">[ subject ]</a>
              <a href="author.html#52670">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
