<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Really Basic clarification on defers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Really%20Basic%20clarification%20on%20defers&In-Reply-To=562bcc10908041135vedfa628sa611dcc941859501%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020155.html">
   <LINK REL="Next"  HREF="020160.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Really Basic clarification on defers</H1>
    <B>Johann Borck</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Really%20Basic%20clarification%20on%20defers&In-Reply-To=562bcc10908041135vedfa628sa611dcc941859501%40mail.gmail.com"
       TITLE="[Twisted-Python] Really Basic clarification on defers">johann.borck at densedata.com
       </A><BR>
    <I>Tue Aug  4 19:14:03 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020155.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
        <LI>Next message: <A HREF="020160.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20157">[ date ]</a>
              <a href="thread.html#20157">[ thread ]</a>
              <a href="subject.html#20157">[ subject ]</a>
              <a href="author.html#20157">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Tue, Aug 4, 2009 at 10:08 AM, John Aherne &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A> 
&lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A>&gt;&gt; wrote:
&gt;<i> This is a really basic problem we are trying to decide about,
</I>&gt;<i>
</I>&gt;<i> We have programs that run quite happily, so far. Its main task is to 
</I>&gt;<i> receive data from port A and send it out via port B. Then receive data 
</I>&gt;<i> via port B and send it out via port A. It's pretty much like a chat 
</I>&gt;<i> setup. You just build up a list of connected clients and send data to 
</I>&gt;<i> them as required
</I>&gt;<i>
</I>&gt;<i> One side A receives some input from a tcp port - about 100-200 
</I>&gt;<i> characters, and forwards it to another port B. We do not need to wait 
</I>&gt;<i> for any response. If we get a response we pick that up through line 
</I>&gt;<i> receiver. We also run a calllater to check if we got a response on 
</I>&gt;<i> linereceiver within the timeframe specified. If not we drop the 
</I>&gt;<i> connection.
</I>&gt;<i>
</I>&gt;<i> Traffic coming in from port B is analysed and some subset is sent back 
</I>&gt;<i> to port A.
</I>&gt;<i>
</I>&gt;<i> Ignoring port A for the moment, just concentrating on port B, we have 
</I>&gt;<i> tried three options:--
</I>&gt;<i>
</I>&gt;<i> 1. We set up a defer to handle the sendline to port B so that the 
</I>&gt;<i> reactor would schedule it in its own good time.
</I>
The reactor always schedules reads and writes &quot;in its own good time&quot;, 
which means it writes whenever there's data to write and the socket is 
ready for writing. If you have data that can't be written at once, 
because it's too much for the socket to handle in a non-blocking 
fashion, the reactor (along with the transport) will take care of it, 
and defer its delivery itself, no need for any deferreds you'd had to 
care about here.

Correct me if I'm wrong, but as I understand your description, option 1. 
and 2. do not behave identically. This is how I interpret it:
option 1:

A sends msg1 to [svc] : wrap msg1 in deferred1
[ - time - ]
B sends data? to [svc] :
                                        1. callback deferred1: [svc] 
sends msg1 to B
                                        2. handle data?
B sends rsp1 to [svc]: [svc] sends rsp1 to A

option 2:

A sends msg1 to [svc] : [svc] sends msg1 to B
B sends rsp1 to [svc] :  [svc] sends rsp1 to A

If this is the case, you rely on some data? being sent to [svc] before 
msg1 can be forwarded to B. That means that you have msg1 in memory 
until you receive data? from B. This doesn't cause problems in your 
case, since you handle small messages in big intervals. But if you'd 
increase the load significantly, you'd also need significantly more RAM 
for no good reason. A case where option 1 might make sense would be if 
it depended on data? provided by B, to decide if or how to continue 
processing msg1. Then you had a valid use-case for deferreds. Since 
there are no such requirements, option 2 is definitely the right choice.

&gt;<i> No threads involved using the standard twisted setup. When we get a 
</I>&gt;<i> response through receiveline we fire the callback defer. If we timeout 
</I>&gt;<i> via callLater we fire the errback to clear the defer. In this case the 
</I>&gt;<i> defer does not seem to be doing very much
</I>&gt;<i>
</I>&gt;<i> 2. Now a fresh pair of eyes is looking at the code and saying why are 
</I>&gt;<i> we using a deferred for sending data to port B. We could just issue a 
</I>&gt;<i> straight sendline as part of the main code and carry on. If we get a 
</I>&gt;<i> response via linereceiver,we process it normally, otherwise we set our 
</I>&gt;<i> callLater running and timeout and lose the connection. So no deferreds 
</I>&gt;<i> required at all. It does seem to work.What we are not sure about is 
</I>&gt;<i> what penalty is incurred in terms of reliability or throughput by 
</I>&gt;<i> using sendline without a deferred.
</I>
There's absolutely no penalty (unless you allow the notion of negative 
penalties). Using sendline directly is faster than using a deferred in 
between, even if you don't count the memory overhead. I think there's a 
bit confusion about the role of deferreds in twisted here. Deferreds 
don't help you (or the reactor) with scheduling, they only provide you 
with a means to continue some processing after a certain event occurred.
&gt;<i> We are not too sure what the holdup will be and whether it could end 
</I>&gt;<i> up halting the show. Is it better to schedule these messages via 
</I>&gt;<i> deferreds or am I missing something obvious
</I>&gt;<i>
</I>&gt;<i> 3. So we then did an experiment and used defertothread to run the 
</I>&gt;<i> sendline in a separate thread with its own defer to maximise the 
</I>&gt;<i> asynchronous running of the code. So now we are running threads when 
</I>&gt;<i> one of the reasons for looking at twisted was that we could avoid 
</I>&gt;<i> threads as much as possible.
</I>
Do you use sendline (the twisted api) from within the thread?  If yes 
and it works, it works accidentally, probably also due to the very small 
load, and is definitely wrong (as well as unnecessary), twisted is not 
threadsafe, with the exception of a few methods/functions like 
callInThread/callFromThread/defertoThread etc.


hope that helps,
Johann

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020155.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
	<LI>Next message: <A HREF="020160.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20157">[ date ]</a>
              <a href="thread.html#20157">[ thread ]</a>
              <a href="subject.html#20157">[ subject ]</a>
              <a href="author.html#20157">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
