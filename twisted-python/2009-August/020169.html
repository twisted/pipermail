<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Really Basic clarification on defers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Really%20Basic%20clarification%20on%20defers&In-Reply-To=faf2d7810908051504x425bf8d0o94f79617213fff8a%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020171.html">
   <LINK REL="Next"  HREF="020158.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Really Basic clarification on defers</H1>
    <B>John Aherne</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Really%20Basic%20clarification%20on%20defers&In-Reply-To=faf2d7810908051504x425bf8d0o94f79617213fff8a%40mail.gmail.com"
       TITLE="[Twisted-Python] Really Basic clarification on defers">johnaherne at rocs.co.uk
       </A><BR>
    <I>Thu Aug  6 02:59:24 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020171.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
        <LI>Next message: <A HREF="020158.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20169">[ date ]</a>
              <a href="thread.html#20169">[ thread ]</a>
              <a href="subject.html#20169">[ subject ]</a>
              <a href="author.html#20169">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A point I missed out on:
The adbapi module seems to be a good example of using deferreds and threads.
The adbapi module returns a deferred it has created, you add your callbacks
to it. It calls your callback when ready. It does seem like the examplar for
doing deferreds.

The db stuff will normally block so put it in a thread and use deferreds to
get the result or failure.

A point about the db calls is that they can be very intensive. If you need
to run some db calls every 30 secs or 60 secs and the db takes 50% or more
of the time to generate the results, you won't have much time to service any
incoming requests to see the data results. The remote connections will be
failing bigtime.

So then I suppose you should break the code into 2 programs. One that does
the db stuff, the other to handle the remote connections. The db code when
it has a result will then connect to the other program and pass across its
results. There may be better ways of doing this of course.

So as Jarrod points out, deferToThread is an easy way of solving blocking
code, but not always. It seems good for short blocks, but you do need the
bulk of the time available for handling connections.

If anyone sees howlers in this, please let me know.

Regards

John Aherne



On Wed, Aug 5, 2009 at 11:04 PM, John Aherne &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A>&gt; wrote:

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Wed, Aug 5, 2009 at 4:17 PM, &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 09:33 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A> wrote:
</I>&gt;&gt;<i> &gt;On Wed, Aug 5, 2009 at 12:14 AM, Johann Borck
</I>&gt;&gt;<i> &gt;&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johann.borck at densedata.com</A>&gt;wrote:
</I>&gt;&gt;<i> &gt;&gt;
</I>&gt;&gt;<i> &gt;[snip]
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;Sendline is not blocking so as you say we can avoid the use of
</I>&gt;&gt;<i> &gt;deferreds and
</I>&gt;&gt;<i> &gt;continue to use sendline directly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> LineReceiver.sendLine is not blocking, correct.  However, your statement
</I>&gt;&gt;<i> implies that if it were blocking, you could use Deferreds to address
</I>&gt;&gt;<i> this
</I>&gt;&gt;<i> problem.  This is incorrect.  Deferreds do not make blocking APIs into
</I>&gt;&gt;<i> non-blocking APIs.
</I>&gt;&gt;<i> &gt;[snip]
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;Our option 3 using defertothread does use sendline from the thread.
</I>&gt;&gt;<i> &gt;Your
</I>&gt;&gt;<i> &gt;response implies that is OK since you say defertothread is threadsafe.
</I>&gt;&gt;<i> &gt;Did
</I>&gt;&gt;<i> &gt;you really mean that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> deferToThread is not thread-safe: you may only call it from the reactor
</I>&gt;&gt;<i> thread
</I>&gt;&gt;<i> (the thread in which you called reactor.run).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Since deferToThread runs the function you pass to it in a non-reactor
</I>&gt;&gt;<i> thread,
</I>&gt;&gt;<i> you may not use any non-thread-safe Twisted APIs in the function you
</I>&gt;&gt;<i> pass to
</I>&gt;&gt;<i> it.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;Once again thanks for a very good response. That has cleared up a lot
</I>&gt;&gt;<i> &gt;of
</I>&gt;&gt;<i> &gt;confusion.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;I suppose it would help if there was a paragraph at the start of the
</I>&gt;&gt;<i> &gt;twisted
</I>&gt;&gt;<i> &gt;documentation detailing what you have just said. So when they start on
</I>&gt;&gt;<i> &gt;deferreds you have some sort of context in which to interpret what is
</I>&gt;&gt;<i> &gt;being
</I>&gt;&gt;<i> &gt;said
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> A significant effort is presently underway to improve the documentation
</I>&gt;&gt;<i> about
</I>&gt;&gt;<i> Deferreds.  Any specific feedback you have about it would be much
</I>&gt;&gt;<i> appreciated.
</I>&gt;&gt;<i> :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Jean-Paul
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> Thanks for the clarifications.
</I>&gt;<i>
</I>&gt;<i> I assume what I meant by blocking was I would have to put a function into
</I>&gt;<i> deferToThread and add some callbacks to return the result. And not directly
</I>&gt;<i> calling sendline from the thread. This is what Jarrod suggested in his
</I>&gt;<i> reply. If I'm wrong, please say so.
</I>&gt;<i>
</I>&gt;<i> I have read the thread regarding deferreds with interest, but did not feel
</I>&gt;<i> I knew enough to contribute.
</I>&gt;<i>
</I>&gt;<i> I do feel qualified to ask some very daft questions. Unfortunately, I don't
</I>&gt;<i> see too many daft questions being asked in the list. I reckon if I need to
</I>&gt;<i> know the answer to them then some other people probably do as well but don't
</I>&gt;<i> put themselves forward. I see it as a way to document information that is
</I>&gt;<i> difficult to come by. And I really do appreciate the very good answers I get
</I>&gt;<i>
</I>&gt;<i> However, after this little foray, I probably feel able to comment:--
</I>&gt;<i>
</I>&gt;<i> The concept of deferreds is very simple. Everyone understands the concept -
</I>&gt;<i> even I do. The issue is how and why and where you should use them in
</I>&gt;<i> twisted.
</I>&gt;<i>
</I>&gt;<i> Some Basic getting Started Points.
</I>&gt;<i>
</I>&gt;<i> 1. For simple network activity do not use deferreds. They are not
</I>&gt;<i> necessary. You can get a lot done without deferreds. And you don't know how
</I>&gt;<i> to use them yet. The reactor and the select will process the outgoing and
</I>&gt;<i> incoming buffers without blocking. Anyone familiar with networking and
</I>&gt;<i> select will already understand this. Anyone not familiar will not realise it
</I>&gt;<i> and needs to be made aware of how the select works.
</I>&gt;<i>
</I>&gt;<i> 2. If you have blocking code - please define blocking :), then first think
</I>&gt;<i> about  putting it into deferToThread with appropriate callbacks and return
</I>&gt;<i> the deferred. As suggested by Jarrod in his response.
</I>&gt;<i>
</I>&gt;<i> 3. John Goerzen in his Apress book Python Network Fundamentals has a very
</I>&gt;<i> simple chat server example. With a few comments for the uninitiated, this
</I>&gt;<i> would be a good starter. Possibly I could ask for permission to include it
</I>&gt;<i> in some twisted HOWTO documentation for beginners with suitable copyright
</I>&gt;<i> recognition.
</I>&gt;<i>
</I>&gt;<i> 4. With these few points as starters, maybe more people will be encouraged
</I>&gt;<i> to get started with twisted. And if you know you can ignore deferreds until
</I>&gt;<i> later you will find twisted is very simple to use and get some good results
</I>&gt;<i> with little effort.
</I>&gt;<i>
</I>&gt;<i> 5. The emphasis on how deferreds work probably ought to be counterbalanced
</I>&gt;<i> by some insight into how and why and where you would use them. For example,
</I>&gt;<i> if you have a text file of 10000 lines you need to read in and summarize,
</I>&gt;<i> presumably you would run this with deferToThread(+other options) and get the
</I>&gt;<i> result via the callback. If someone has a better example please let me know.
</I>&gt;<i>
</I>&gt;<i> 6. Blocking code is always put into a thread or like, and a deferred
</I>&gt;<i> callback or errback used to return the result or failure of the blocking
</I>&gt;<i> code from the thread. See jarrod's response above
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You asked :)
</I>&gt;<i> I'm giving
</I>&gt;<i>
</I>&gt;<i> I may be completely off track in what I have said above. And I would not
</I>&gt;<i> want anyone to fall upon this mail and think it represents the gospel truth.
</I>&gt;<i>
</I>&gt;<i> Thank you for the response..
</I>&gt;<i>
</I>&gt;<i> John Aherne
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20090806/f56dad02/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20090806/f56dad02/attachment.htm</A> 
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020171.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
	<LI>Next message: <A HREF="020158.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20169">[ date ]</a>
              <a href="thread.html#20169">[ thread ]</a>
              <a href="subject.html#20169">[ subject ]</a>
              <a href="author.html#20169">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
