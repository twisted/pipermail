<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Really Basic clarification on defers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Really%20Basic%20clarification%20on%20defers&In-Reply-To=%3C562bcc10908041135vedfa628sa611dcc941859501%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052654.html">
   <LINK REL="Next"  HREF="052662.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Really Basic clarification on defers</H1>
    <B>Kevin Horn</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Really%20Basic%20clarification%20on%20defers&In-Reply-To=%3C562bcc10908041135vedfa628sa611dcc941859501%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Really Basic clarification on defers">kevin.horn at gmail.com
       </A><BR>
    <I>Tue Aug  4 12:35:10 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052654.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
        <LI>Next message (by thread): <A HREF="052662.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52657">[ date ]</a>
              <a href="thread.html#52657">[ thread ]</a>
              <a href="subject.html#52657">[ subject ]</a>
              <a href="author.html#52657">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Aug 4, 2009 at 10:08 AM, John Aherne &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A>&gt; wrote:

&gt;<i> This is a really basic problem we are trying to decide about,
</I>&gt;<i>
</I>&gt;<i> We have programs that run quite happily, so far. Its main task is to
</I>&gt;<i> receive data from port A and send it out via port B. Then receive data via
</I>&gt;<i> port B and send it out via port A. It's pretty much like a chat setup. You
</I>&gt;<i> just build up a list of connected clients and send data to them as required
</I>&gt;<i>
</I>&gt;<i> One side A receives some input from a tcp port - about 100-200 characters,
</I>&gt;<i> and forwards it to another port B. We do not need to wait for any response.
</I>&gt;<i> If we get a response we pick that up through line receiver. We also run a
</I>&gt;<i> calllater to check if we got a response on linereceiver within the timeframe
</I>&gt;<i> specified. If not we drop the connection.
</I>&gt;<i>
</I>&gt;<i> Traffic coming in from port B is analysed and some subset is sent back to
</I>&gt;<i> port A.
</I>&gt;<i>
</I>&gt;<i> Ignoring port A for the moment, just concentrating on port B, we have tried
</I>&gt;<i> three options:--
</I>&gt;<i>
</I>&gt;<i> 1. We set up a defer to handle the sendline to port B so that the reactor
</I>&gt;<i> would schedule it in its own good time. No threads involved using the
</I>&gt;<i> standard twisted setup. When we get a response through receiveline we fire
</I>&gt;<i> the callback defer. If we timeout via callLater we fire the errback to clear
</I>&gt;<i> the defer. In this case the defer does not seem to be doing very much
</I>&gt;<i>
</I>&gt;<i> 2. Now a fresh pair of eyes is looking at the code and saying why are we
</I>&gt;<i> using a deferred for sending data to port B. We could just issue a straight
</I>&gt;<i> sendline as part of the main code and carry on. If we get a response via
</I>&gt;<i> linereceiver,we process it normally, otherwise we set our callLater running
</I>&gt;<i> and timeout and lose the connection. So no deferreds required at all. It
</I>&gt;<i> does seem to work.What we are not sure about is what penalty is incurred in
</I>&gt;<i> terms of reliability or throughput by using sendline without a deferred. We
</I>&gt;<i> are not too sure what the holdup will be and whether it could end up halting
</I>&gt;<i> the show. Is it better to schedule these messages via deferreds or am I
</I>&gt;<i> missing something obvious
</I>&gt;<i>
</I>&gt;<i> 3. So we then did an experiment and used defertothread to run the sendline
</I>&gt;<i> in a separate thread with its own defer to maximise the asynchronous running
</I>&gt;<i> of the code. So now we are running threads when one of the reasons for
</I>&gt;<i> looking at twisted was that we could avoid threads as much as possible.
</I>&gt;<i>
</I>&gt;<i> The conundrum we are trying to resolve now is which option should we use.
</I>&gt;<i> Do any of the options have a built-in problem awaiting the unwary. In theory
</I>&gt;<i> all 3 options work. But if No 1 works well enough for our volume of traffic
</I>&gt;<i> should we adopt that one. Or is it better to start using the defertothread
</I>&gt;<i> option. Is there a simple answer
</I>&gt;<i>
</I>&gt;<i> The traffic is not large, upto a 100-200 remote devices on port B. They
</I>&gt;<i> will send GPS data every 20 secs, and about 500 messages of about 200 bytes
</I>&gt;<i> average throught the day. The remote devices will respond in an irregular
</I>&gt;<i> manner without dropping the connection, so we force a disconnectf if
</I>&gt;<i> important messages are not getting through. They are then forced to
</I>&gt;<i> reconnect.
</I>&gt;<i>
</I>&gt;<i> We have looked through the code searching for enlightment and it does seem
</I>&gt;<i> to be well documented, but the information we are looking for comes well
</I>&gt;<i> before the doc strings.
</I>&gt;<i>
</I>&gt;<i> Hopefully, someone can give us some pointers in the right direction.
</I>&gt;<i>
</I>&gt;<i> Thanks for any help.
</I>&gt;<i>
</I>&gt;<i> John Aherne
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>It seems to me that the volume of traffic you are dealing with isn't so high
that you need to worry too much about direct sendline causing problems.  If
I were writing this from scratch based on my understanding of what you've
written above, I would probably go with option 2. (Keep in mind, my
understanding may be flawed...so...)  However, if you've already got things
working with option 1, and the added complexity isn't causing you any
trouble, I don't see any real reason not to use that, since you've already
got that working.  Others may disagree...

Option 3 seems totally unnecessary to me.  I typically stay away from
threads in Twisted unless I have a long running non-network process to deal
with (disk access, db access, heavy math processing, etc.).  Especially
because of the relative &quot;heaviness&quot; of threads when using Python (due to
complex interactions with the GIL), I would avoid this method...it will
probably hurt performance more than Option 1 (though still probably not
enough to matter).

Others feel free to slap me if I'm giving bad advice :)

Kevin Horn
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20090804/471865af/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052654.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
	<LI>Next message (by thread): <A HREF="052662.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52657">[ date ]</a>
              <a href="thread.html#52657">[ thread ]</a>
              <a href="subject.html#52657">[ subject ]</a>
              <a href="author.html#52657">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
