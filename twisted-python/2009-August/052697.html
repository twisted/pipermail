<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to debug an AMP connection?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20debug%20an%20AMP%20connection%3F&In-Reply-To=%3C1249943105.24323.1329213329%40webmail.messagingengine.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052688.html">
   <LINK REL="Next"  HREF="052672.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to debug an AMP connection?</H1>
    <B>Peter Westlake</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20debug%20an%20AMP%20connection%3F&In-Reply-To=%3C1249943105.24323.1329213329%40webmail.messagingengine.com%3E"
       TITLE="[Twisted-Python] How to debug an AMP connection?">peter.westlake at pobox.com
       </A><BR>
    <I>Mon Aug 10 16:25:05 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052688.html">[Twisted-Python] How to debug an AMP connection?
</A></li>
        <LI>Next message (by thread): <A HREF="052672.html">[Twisted-Python] Adbapi issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52697">[ date ]</a>
              <a href="thread.html#52697">[ thread ]</a>
              <a href="subject.html#52697">[ subject ]</a>
              <a href="author.html#52697">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Sat, 08 Aug 2009 16:32 +0000, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:
&gt;<i> On 5 Aug, 03:59 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">peter.westlake at pobox.com</A> wrote:
</I>&gt;<i> &gt;Background: I have a client program that calls callRemote, but the
</I>&gt;<i> &gt;Deferred that callRemote returns is not fired. This is an intermittent
</I>&gt;<i> &gt;error that only happens after some hours of traffic.
</I>...
&gt;<i> &gt;The client sends a request.
</I>&gt;<i> &gt;The server sends a reply with the same tag, and logs a message.
</I>&gt;<i> &gt;Until it goes wrong, the client receives the reply and logs it.
</I>&gt;<i> &gt;When it goes wrong, the client does not see the reply.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;The protocol has the unfired Deferred in _outstandingRequests,
</I>&gt;<i> &gt;with the missing tag as key.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;All this suggests that the problem is either in the low-level
</I>&gt;<i> &gt;network code, or somewhere in the network between the client
</I>&gt;<i> &gt;and server. But doesn't TCP/IP tell you if a packet doesn't
</I>&gt;<i> &gt;get through?
</I>&gt;<i> 
</I>&gt;<i> It doesn't really /tell/ you.  But if there is some issue with
</I>&gt;<i> the network that prevents packet delivery for long enough, then
</I>&gt;<i> the connection breaks (giving you a connectionLost call in Twisted,
</I>&gt;<i> which should errback your Deferred).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I tried tracing the packets using a python-pycapy script (attached),
</I>&gt;<i> &gt;but it showed more packets disappearing than actually were.
</I>&gt;<i> 
</I>&gt;<i> It might be simpler to use something like wireshark, which already
</I>&gt;<i> knows how to do TCP stream re-assembly and such.
</I>&gt;<i> 
</I>&gt;<i> I know this isn't much of a suggestion, but it's the only thing that
</I>&gt;<i> really comes to mind.
</I>
No, it's a good suggestion - the only problem is that it makes the
problem happen far less often! What I've done is to capture the first
few bytes of each packet, enough to show the whole of the AMP reply
packets (which are just {'_answer':tag, 'status':True}) without any
need for full-scale analysis and reassembly.

I'm pleased to say that after many hours of watching tcpdump,
the bug eventually happened again just minutes before I left
for a long weekend. Sure enough, TCP/IP delivers the packet
successfully. Tomorrow's first task is going to be putting
tracing into the low-level code where the reactor is meant
to receive the packet and call the AMP _outstandingRequests
entry for it.

It would have been almost impossible to get even this far
without the Manhole feature. I've been using it all along
to inspect the workings of the client code, and it was a big
help on the server side too. The server handles a lot of
connections, and I was able to set a debug flag in the protocol
object for the connection I was tracing. There would have been
very much more log data otherwise. It makes a big difference
being able to see values of variables without having to add
new log statements and spend another working day waiting for
the bug. Whoever invented it - thank you!

Peter.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052688.html">[Twisted-Python] How to debug an AMP connection?
</A></li>
	<LI>Next message (by thread): <A HREF="052672.html">[Twisted-Python] Adbapi issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52697">[ date ]</a>
              <a href="thread.html#52697">[ thread ]</a>
              <a href="subject.html#52697">[ subject ]</a>
              <a href="author.html#52697">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
