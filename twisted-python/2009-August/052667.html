<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Really Basic clarification on defers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Really%20Basic%20clarification%20on%20defers&In-Reply-To=%3Cfaf2d7810908050233s5adf4464ybdf217cb3566ff17%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052664.html">
   <LINK REL="Next"  HREF="052669.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Really Basic clarification on defers</H1>
    <B>John Aherne</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Really%20Basic%20clarification%20on%20defers&In-Reply-To=%3Cfaf2d7810908050233s5adf4464ybdf217cb3566ff17%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Really Basic clarification on defers">johnaherne at rocs.co.uk
       </A><BR>
    <I>Wed Aug  5 03:33:28 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052664.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
        <LI>Next message (by thread): <A HREF="052669.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52667">[ date ]</a>
              <a href="thread.html#52667">[ thread ]</a>
              <a href="subject.html#52667">[ subject ]</a>
              <a href="author.html#52667">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Aug 5, 2009 at 12:14 AM, Johann Borck &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johann.borck at densedata.com</A>&gt;wrote:

&gt;<i>
</I>&gt;<i> On Tue, Aug 4, 2009 at 10:08 AM, John Aherne &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A>&gt;&gt; wrote:
</I>&gt;<i> &gt; This is a really basic problem we are trying to decide about,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We have programs that run quite happily, so far. Its main task is to
</I>&gt;<i> &gt; receive data from port A and send it out via port B. Then receive data
</I>&gt;<i> &gt; via port B and send it out via port A. It's pretty much like a chat
</I>&gt;<i> &gt; setup. You just build up a list of connected clients and send data to
</I>&gt;<i> &gt; them as required
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; One side A receives some input from a tcp port - about 100-200
</I>&gt;<i> &gt; characters, and forwards it to another port B. We do not need to wait
</I>&gt;<i> &gt; for any response. If we get a response we pick that up through line
</I>&gt;<i> &gt; receiver. We also run a calllater to check if we got a response on
</I>&gt;<i> &gt; linereceiver within the timeframe specified. If not we drop the
</I>&gt;<i> &gt; connection.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Traffic coming in from port B is analysed and some subset is sent back
</I>&gt;<i> &gt; to port A.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Ignoring port A for the moment, just concentrating on port B, we have
</I>&gt;<i> &gt; tried three options:--
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1. We set up a defer to handle the sendline to port B so that the
</I>&gt;<i> &gt; reactor would schedule it in its own good time.
</I>&gt;<i>
</I>&gt;<i> The reactor always schedules reads and writes &quot;in its own good time&quot;,
</I>&gt;<i> which means it writes whenever there's data to write and the socket is
</I>&gt;<i> ready for writing. If you have data that can't be written at once,
</I>&gt;<i> because it's too much for the socket to handle in a non-blocking
</I>&gt;<i> fashion, the reactor (along with the transport) will take care of it,
</I>&gt;<i> and defer its delivery itself, no need for any deferreds you'd had to
</I>&gt;<i> care about here.
</I>&gt;<i>
</I>&gt;<i> Correct me if I'm wrong, but as I understand your description, option 1.
</I>&gt;<i> and 2. do not behave identically. This is how I interpret it:
</I>&gt;<i> option 1:
</I>&gt;<i>
</I>&gt;<i> A sends msg1 to [svc] : wrap msg1 in deferred1
</I>&gt;<i> [ - time - ]
</I>&gt;<i> B sends data? to [svc] :
</I>&gt;<i>                                        1. callback deferred1: [svc]
</I>&gt;<i> sends msg1 to B
</I>&gt;<i>                                        2. handle data?
</I>&gt;<i> B sends rsp1 to [svc]: [svc] sends rsp1 to A
</I>&gt;<i>
</I>&gt;<i> option 2:
</I>&gt;<i>
</I>&gt;<i> A sends msg1 to [svc] : [svc] sends msg1 to B
</I>&gt;<i> B sends rsp1 to [svc] :  [svc] sends rsp1 to A
</I>&gt;<i>
</I>&gt;<i> If this is the case, you rely on some data? being sent to [svc] before
</I>&gt;<i> msg1 can be forwarded to B. That means that you have msg1 in memory
</I>&gt;<i> until you receive data? from B. This doesn't cause problems in your
</I>&gt;<i> case, since you handle small messages in big intervals. But if you'd
</I>&gt;<i> increase the load significantly, you'd also need significantly more RAM
</I>&gt;<i> for no good reason. A case where option 1 might make sense would be if
</I>&gt;<i> it depended on data? provided by B, to decide if or how to continue
</I>&gt;<i> processing msg1. Then you had a valid use-case for deferreds. Since
</I>&gt;<i> there are no such requirements, option 2 is definitely the right choice.
</I>&gt;<i>
</I>&gt;<i> &gt; No threads involved using the standard twisted setup. When we get a
</I>&gt;<i> &gt; response through receiveline we fire the callback defer. If we timeout
</I>&gt;<i> &gt; via callLater we fire the errback to clear the defer. In this case the
</I>&gt;<i> &gt; defer does not seem to be doing very much
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2. Now a fresh pair of eyes is looking at the code and saying why are
</I>&gt;<i> &gt; we using a deferred for sending data to port B. We could just issue a
</I>&gt;<i> &gt; straight sendline as part of the main code and carry on. If we get a
</I>&gt;<i> &gt; response via linereceiver,we process it normally, otherwise we set our
</I>&gt;<i> &gt; callLater running and timeout and lose the connection. So no deferreds
</I>&gt;<i> &gt; required at all. It does seem to work.What we are not sure about is
</I>&gt;<i> &gt; what penalty is incurred in terms of reliability or throughput by
</I>&gt;<i> &gt; using sendline without a deferred.
</I>&gt;<i>
</I>&gt;<i> There's absolutely no penalty (unless you allow the notion of negative
</I>&gt;<i> penalties). Using sendline directly is faster than using a deferred in
</I>&gt;<i> between, even if you don't count the memory overhead. I think there's a
</I>&gt;<i> bit confusion about the role of deferreds in twisted here. Deferreds
</I>&gt;<i> don't help you (or the reactor) with scheduling, they only provide you
</I>&gt;<i> with a means to continue some processing after a certain event occurred.
</I>&gt;<i> &gt; We are not too sure what the holdup will be and whether it could end
</I>&gt;<i> &gt; up halting the show. Is it better to schedule these messages via
</I>&gt;<i> &gt; deferreds or am I missing something obvious
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 3. So we then did an experiment and used defertothread to run the
</I>&gt;<i> &gt; sendline in a separate thread with its own defer to maximise the
</I>&gt;<i> &gt; asynchronous running of the code. So now we are running threads when
</I>&gt;<i> &gt; one of the reasons for looking at twisted was that we could avoid
</I>&gt;<i> &gt; threads as much as possible.
</I>&gt;<i>
</I>&gt;<i> Do you use sendline (the twisted api) from within the thread?  If yes
</I>&gt;<i> and it works, it works accidentally, probably also due to the very small
</I>&gt;<i> load, and is definitely wrong (as well as unnecessary), twisted is not
</I>&gt;<i> threadsafe, with the exception of a few methods/functions like
</I>&gt;<i> callInThread/callFromThread/defertoThread etc.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> hope that helps,
</I>&gt;<i> Johann
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>

Johann

Thanks for a very informative reply.

Our problem was more basic than deferreds. It was to with the reactor and
select command.

Sendline is not blocking so as you say we can avoid the use of deferreds and
continue to use sendline directly.

Regarding messages being stored in memory, we only store the sequence number
for each message so we can identify the message being responded to. We can
then report back to A with the original message sequence number. So the
memory footprint is quite small.

Our option 3 using defertothread does use sendline from the thread. Your
response implies that is OK since you say defertothread is threadsafe. Did
you really mean that.

Once again thanks for a very good response. That has cleared up a lot of
confusion.

I suppose it would help if there was a paragraph at the start of the twisted
documentation detailing what you have just said. So when they start on
deferreds you have some sort of context in which to interpret what is being
said

Regards

John Aherne
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20090805/14ee349e/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052664.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
	<LI>Next message (by thread): <A HREF="052669.html">[Twisted-Python] Really Basic clarification on defers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52667">[ date ]</a>
              <a href="thread.html#52667">[ thread ]</a>
              <a href="subject.html#52667">[ subject ]</a>
              <a href="author.html#52667">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
