<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Telnet server using Twisted and	AuthenticatingTelnetProtocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Telnet%20server%20using%20Twisted%20and%0A%09AuthenticatingTelnetProtocol&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020253.html">
   <LINK REL="Next"  HREF="020263.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Telnet server using Twisted and	AuthenticatingTelnetProtocol</H1>
    <B>filoufake-python at yahoo.fr</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Telnet%20server%20using%20Twisted%20and%0A%09AuthenticatingTelnetProtocol&In-Reply-To="
       TITLE="[Twisted-Python] Telnet server using Twisted and	AuthenticatingTelnetProtocol">filoufake-python at yahoo.fr
       </A><BR>
    <I>Thu Aug 20 03:07:24 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020253.html">[Twisted-Python] weird spammy trac emails?
</A></li>
        <LI>Next message: <A HREF="020263.html">[Twisted-Python] Telnet server using Twisted	and	AuthenticatingTelnetProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20254">[ date ]</a>
              <a href="thread.html#20254">[ thread ]</a>
              <a href="subject.html#20254">[ subject ]</a>
              <a href="author.html#20254">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I have created a telnet server in python.

Maybe you wonder why to create a telnet server while Windows has one?
Because the windows telnet server does not allow to interract with the
desktop. If you try to start a GUI app, it will start and run but will
not be displayed on the server desktop.

My telnet server will allow to start a GUI application interracting with the windows desktop of the server.
Ex. : typing &quot;notepad&quot; in the telnet console will pop up the notepad on the Windows desktop of the server.

At the time this server works but has no authentication feature implemented.

I would like to implement the authentication using AuthenticatingTelnetProtocol and credential.
I found the &quot;cred.py&quot; example on the twistedmatrix website (in the example section) and looked fine as starting point.

I quite well understand this expample.

I modified the code as follow but always got the same error message when a connectiion is attempted.
I have been trying since two weeks but I cannot get it work.

Is there a problem with &quot;AuthenticatingTelnetProtocol&quot;

The error message:
************************************************************
D:\workspace\twisted&gt;telnet_cred.py
2009-08-20 08:57:11+0200 [-] Log opened.
2009-08-20 08:57:11+0200 [-] __main__.ServerFactory starting on 4738
2009-08-20 08:57:11+0200 [-] Starting factory &lt;__main__.ServerFactory instance at 0x00D79C60&gt;
2009-08-20 08:57:15+0200 [__main__.ServerFactory] DEBUG: buildProtocol - addr IPv4Address(TCP, '127.0.0.1', 4978)
2009-08-20 08:57:15+0200 [__main__.ServerFactory] Unhandled Error
        Traceback (most recent call last):
          File &quot;C:\Python25\lib\site-packages\twisted\python\log.py&quot;, line 69, in callWithContext
            return context.call({ILogContext: newCtx}, func, *args, **kw)
          File &quot;C:\Python25\lib\site-packages\twisted\python\context.py&quot;, line 59, in callWithContext
            return self.currentContext().callWithContext(ctx, func, *args, **kw)
          File &quot;C:\Python25\lib\site-packages\twisted\python\context.py&quot;, line 37, in callWithContext
            return func(*args,**kw)
          File &quot;C:\Python25\lib\site-packages\twisted\internet\selectreactor.py&quot;, line 146, in _doReadOrWrite
            why = getattr(selectable, method)()
        --- &lt;exception caught here&gt; ---
          File &quot;C:\Python25\lib\site-packages\twisted\internet\tcp.py&quot;, line 932, in doRead
            protocol = self.factory.buildProtocol(self._buildAddr(addr))
          File &quot;D:\workspace\twisted\telnet_cred.py&quot;, line 130, in buildProtocol
            p = protocol.ServerFactory.buildProtocol(self, addr)
          File &quot;C:\Python25\lib\site-packages\twisted\internet\protocol.py&quot;, line 98, in buildProtocol
            p = self.protocol()
        exceptions.TypeError: __init__() takes exactly 2 arguments (1 given)
************************************************************

The modified code:
************************************************************

# Copyright (c) 2001-2004 Twisted Matrix Laboratories.
# See LICENSE for details.



import sys
from zope.interface import implements, Interface

from twisted.protocols import basic
from twisted.internet import protocol
from twisted.python import log

from twisted.cred import error
from twisted.cred import portal
from twisted.cred import checkers
from twisted.cred import credentials

from twisted.conch.telnet import AuthenticatingTelnetProtocol, ITelnetProtocol, TelnetProtocol

class IProtocolUser(Interface):
    def getPrivileges():
        &quot;&quot;&quot;Return a list of privileges this user has.&quot;&quot;&quot;

    def logout():
        &quot;&quot;&quot;Cleanup per-login resources allocated to this avatar&quot;&quot;&quot;

class AnonymousUser:
    implements(IProtocolUser)
    
    def getPrivileges(self):
        return [1, 2, 3]

    def logout(self):
        print &quot;Cleaning up anonymous user resources&quot;

class RegularUser:
    implements(IProtocolUser)
    
    def getPrivileges(self):
        return [1, 2, 3, 5, 6]

    def logout(self):
        print &quot;Cleaning up regular user resources&quot;

class Administrator:
    implements(IProtocolUser)
    
    def getPrivileges(self):
        return range(50)

    def logout(self):
        print &quot;Cleaning up administrator resources&quot;

class Protocol(basic.LineReceiver):
    user = None
    portal = None
    avatar = None
    logout = None

    def connectionMade(self):
        self.sendLine(&quot;Login with USER &lt;name&gt; followed by PASS &lt;password&gt; or ANON&quot;)
        self.sendLine(&quot;Check privileges with PRIVS&quot;)

    def connectionLost(self, reason):
        if self.logout:
            self.logout()
            self.avatar = None
            self.logout = None
    
    def lineReceived(self, line):
        f = getattr(self, 'cmd_' + line.upper().split()[0])
        if f:
            try:
                f(*line.split()[1:])
            except TypeError:
                self.sendLine(&quot;Wrong number of arguments.&quot;)
            except:
                self.sendLine(&quot;Server error (probably your fault)&quot;)

    def cmd_ANON(self):
        if self.portal:
            self.portal.login(credentials.Anonymous(), None, IProtocolUser
                ).addCallbacks(self._cbLogin, self._ebLogin
                )
        else:
            self.sendLine(&quot;DENIED&quot;)
    
    def cmd_USER(self, name):
        self.user = name
        self.sendLine(&quot;Alright.  Now PASS?&quot;)
    
    def cmd_PASS(self, password):
        if not self.user:
            self.sendLine(&quot;USER required before PASS&quot;)
        else:
            if self.portal:
                self.portal.login(
                    credentials.UsernamePassword(self.user, password),
                    None,
                    IProtocolUser
                ).addCallbacks(self._cbLogin, self._ebLogin
                )
            else:
                self.sendLine(&quot;DENIED&quot;)

    def cmd_PRIVS(self):
        self.sendLine(&quot;You have the following privileges: &quot;)
        self.sendLine(&quot; &quot;.join(map(str, self.avatar.getPrivileges())))

    def _cbLogin(self, (interface, avatar, logout)):
        assert interface is IProtocolUser
        self.avatar = avatar
        self.logout = logout
        self.sendLine(&quot;Login successful.  Available commands: PRIVS&quot;)
    
    def _ebLogin(self, failure):
        failure.trap(error.UnauthorizedLogin)
        self.sendLine(&quot;Login denied!  Go away.&quot;)

class ServerFactory(protocol.ServerFactory):
##    protocol = Protocol
    protocol = AuthenticatingTelnetProtocol
    
    def __init__(self, portal):
        self.portal = portal
    
    def buildProtocol(self, addr):
        print &quot;DEBUG: buildProtocol - addr&quot;, addr
        p = protocol.ServerFactory.buildProtocol(self, addr)
        print &quot;DEBUG2: buildProtocol - addr&quot;, addr
        p.portal = self.portal
        return p

class Realm:
    implements(portal.IRealm)

    def requestAvatar(self, avatarId, mind, *interfaces):
        if IProtocolUser in interfaces:
            if avatarId == checkers.ANONYMOUS:
                av = AnonymousUser()
            elif avatarId.isupper():
                # Capitalized usernames are administrators.
                av = Administrator()
            else:
                av = RegularUser()
            return IProtocolUser, av, av.logout
        elif ITelnetProtocol in interfaces:
            print &quot;BEGUG: aaaa&quot;
            if avatarId.isupper():
                av = TelnetProtocol()
            return ITelnetProtocol, av, None
        raise NotImplementedError(&quot;Only IProtocolUser interface is supported by this realm&quot;)

def main():
    r = Realm()
    p = portal.Portal(r)
    c = checkers.InMemoryUsernamePasswordDatabaseDontUse()
    c.addUser(&quot;auser&quot;, &quot;thepass&quot;)
    c.addUser(&quot;SECONDUSER&quot;, &quot;secret&quot;)
    p.registerChecker(c)
    p.registerChecker(checkers.AllowAnonymousAccess())
    
    f = ServerFactory(p)
    
    log.startLogging(sys.stdout)

    from twisted.internet import reactor
    reactor.listenTCP(4738, f)
    reactor.run()

if __name__ == '__main__':
    main()

************************************************************

If someone could help me.

Philippe


      
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20090820/37542693/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20090820/37542693/attachment.htm</A> 
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020253.html">[Twisted-Python] weird spammy trac emails?
</A></li>
	<LI>Next message: <A HREF="020263.html">[Twisted-Python] Telnet server using Twisted	and	AuthenticatingTelnetProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20254">[ date ]</a>
              <a href="thread.html#20254">[ thread ]</a>
              <a href="subject.html#20254">[ subject ]</a>
              <a href="author.html#20254">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
