<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Wrapping blocking code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Wrapping%20blocking%20code&In-Reply-To=20030725141752.398A938393%40www.fastmail.fm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005184.html">
   <LINK REL="Next"  HREF="005186.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Wrapping blocking code</H1>
    <B>Bob Ippolito</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Wrapping%20blocking%20code&In-Reply-To=20030725141752.398A938393%40www.fastmail.fm"
       TITLE="[Twisted-Python] Wrapping blocking code">bob at redivi.com
       </A><BR>
    <I>Fri Jul 25 10:39:48 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="005184.html">[Twisted-Python] Wrapping blocking code
</A></li>
        <LI>Next message: <A HREF="005186.html">[Twisted-Python] Wrapping blocking code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5185">[ date ]</a>
              <a href="thread.html#5185">[ thread ]</a>
              <a href="subject.html#5185">[ subject ]</a>
              <a href="author.html#5185">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>That's kind of amusing.  I'm not particularly familiar with the log or  
win32eventreactor modules... but as far as I can tell, those messages  
mean &quot;dude, don't use log.logOwner anymore&quot;.  It's not your fault, it's  
the twisted team's fault for not keeping win32eventreactor up to date  
with the latest conventions.  They're just DeprecationWarnings, so  
they're harmless to everything other than your eyes and our pride :)

Also, instead of using that reactor.iterate() hack.. it's better to be  
in the habit of writing something event driven.. for example, you could  
override the __init__ for protocol.ProcessProtocol (well, it's not  
really overriding anything, since it doesn't have one) from your  
subclass, stick a Deferred in the instance, and do a callback in  
processEnded... like this:

class MyProcessProtocol(protocol.ProcessProtocol):
	def __init__(self):
		self.deferred = defer.Deferred()

	...cut and paste your code...

	def processEnded(self, reason):
		...cut and paste some more code...
		self.deferred.callback(reason)

...cut and paste again, but throw out your for loop...
p.addBoth(lambda ignore: reactor.callLater(0.0, reactor.stop))
reactor.run()

The reactor.callLater(0.0, ....) is just to prevent the reactor from  
shutting down before it starts, because a deferred could theoretically  
fire immediately.  I'm pretty sure it couldn't in this case, but I  
usually put it there anyway when I'm stopping a reactor because in some  
situations it can (usually a bug in my code that causes an errback  
immediately, or something).

-bob

On Friday, Jul 25, 2003, at 10:17 America/New_York, Justin Johnson  
wrote:

&gt;<i> Since I'm running on win2k (ugh!) I followed the instructions to use
</I>&gt;<i> win32eventreactor instead of the default posix reactor.  I did read
</I>&gt;<i> through the docstrings, and it does mention that process calling can be
</I>&gt;<i> problematic.  I ran the code below and got the following error.  Is it
</I>&gt;<i> possible to get this working on windows?  It is marked as semi-stable.
</I>&gt;<i> Man I hate windows!  Unfortunately the servers I support are all  
</I>&gt;<i> windows
</I>&gt;<i> boxes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> C:\Python22\Lib\site- 
</I>&gt;<i> packages\twisted\internet\win32eventreactor.py:198:
</I>&gt;<i> Depreca
</I>&gt;<i> tionWarning: Foolish capitalist!  Your opulent toilet will be your
</I>&gt;<i> undoing!!
</I>&gt;<i>   log.logOwner.own(fd)
</I>&gt;<i> C:\Python22\Lib\site- 
</I>&gt;<i> packages\twisted\internet\win32eventreactor.py:213:
</I>&gt;<i> Depreca
</I>&gt;<i> tionWarning: The proletariat is victorious.
</I>&gt;<i>   log.logOwner.disown(fd)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> [snip]
</I>&gt;<i> from twisted.internet import protocol
</I>&gt;<i> from twisted.internet import win32eventreactor
</I>&gt;<i> win32eventreactor.install()
</I>&gt;<i> from twisted.internet import reactor
</I>&gt;<i>
</I>&gt;<i> class MyProcessProtocol(protocol.ProcessProtocol):
</I>&gt;<i> 	finished = 0
</I>&gt;<i>
</I>&gt;<i> 	def connectionMade(self):
</I>&gt;<i> 		self.data = ''
</I>&gt;<i> 		self.err = ''
</I>&gt;<i> 		self.transport.write(&quot;connectionMade&quot;)
</I>&gt;<i>
</I>&gt;<i> 	def outReceived(self, data):
</I>&gt;<i> 		self.data = self.data + data
</I>&gt;<i>
</I>&gt;<i> 	def outConnectionLost(self):
</I>&gt;<i> 		self.transport.write(&quot;outConnectionLost&quot;)
</I>&gt;<i>
</I>&gt;<i> 	def errReceived(self, data):
</I>&gt;<i> 		self.err = self.err + data
</I>&gt;<i> 		self.transport.write(&quot;errReceived&quot;)
</I>&gt;<i>
</I>&gt;<i> 	def errConnectionLost(self):
</I>&gt;<i> 		self.transport.write(&quot;errConnectionLost&quot;)
</I>&gt;<i>
</I>&gt;<i> 	def inConnectionLost(self):
</I>&gt;<i> 		self.transport.write(&quot;inConnectionLost&quot;)
</I>&gt;<i>
</I>&gt;<i> 	def processEnded(self, reason):
</I>&gt;<i> 		self.finished = 1
</I>&gt;<i> 		self.reason = reason
</I>&gt;<i> 		self.transport.write(&quot;processEnded&quot;)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> exe = r&quot;c:\program files\rational\clearcase\bin\cleartool.exe&quot;
</I>&gt;<i> p = MyProcessProtocol()
</I>&gt;<i> reactor.spawnProcess(p, exe, [exe, &quot;lsview&quot;, &quot;-s&quot;], env=None)
</I>&gt;<i> while not p.finished:
</I>&gt;<i> 	reactor.iterate()
</I>&gt;<i> [/snip]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Wed, 23 Jul 2003 14:42:15 -0600, &quot;Dave Smith&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dizzyd at jabber.org</A>&gt;
</I>&gt;<i> said:
</I>&gt;&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;&gt;<i> Hash: SHA1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sounds to me like you want to use a deferToThread(...), to pass the
</I>&gt;&gt;<i> calls off to the reactor's thread pool so they can run there without
</I>&gt;&gt;<i> holding up the reactor's runloop.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> See also:
</I>&gt;&gt;<i> <A HREF="http://www.itamarst.org/writings/OSCON03/twisted_internet-95.html">http://www.itamarst.org/writings/OSCON03/twisted_internet-95.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hope that helps. :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Diz
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Wednesday, Jul 23, 2003, at 10:16 America/Denver, Justin Johnson
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have some code in my xmlrpc service that executes commands using
</I>&gt;&gt;&gt;<i> process.py (<A HREF="http://starship.python.net/crew/tmick/">http://starship.python.net/crew/tmick/</A>).  The service
</I>&gt;&gt;&gt;<i> appears
</I>&gt;&gt;&gt;<i> to block this code, thus only allowing one connection to get any work
</I>&gt;&gt;&gt;<i> done at a time, at least while the commands are being executed.
</I>&gt;&gt;&gt;<i> Should I
</I>&gt;&gt;&gt;<i> be wrapping this up in a Deferred somehow to avoid blocking?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Slowly but surely this is starting to make sense to me.  Twisted  
</I>&gt;&gt;&gt;<i> rocks!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thanks.
</I>&gt;&gt;&gt;<i> -Justin
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;&gt;<i> Version: GnuPG v1.2.1 (Darwin)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> iD8DBQE/HvMnYNE3chVHHsMRAplLAJ0bbnqUGSDkDz3AZPvCNTvOn1T8TgCg8nCd
</I>&gt;&gt;<i> m830zVM1AnnL3fF76V1WHqY=
</I>&gt;&gt;<i> =39jf
</I>&gt;&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005184.html">[Twisted-Python] Wrapping blocking code
</A></li>
	<LI>Next message: <A HREF="005186.html">[Twisted-Python] Wrapping blocking code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5185">[ date ]</a>
              <a href="thread.html#5185">[ thread ]</a>
              <a href="subject.html#5185">[ subject ]</a>
              <a href="author.html#5185">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
