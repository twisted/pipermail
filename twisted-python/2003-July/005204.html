<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: Considering Twisted for OfflineIMAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Considering%20Twisted%20for%20OfflineIMAP&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005202.html">
   <LINK REL="Next"  HREF="005205.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: Considering Twisted for OfflineIMAP</H1>
    <B>John Goerzen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Considering%20Twisted%20for%20OfflineIMAP&In-Reply-To="
       TITLE="[Twisted-Python] Re: Considering Twisted for OfflineIMAP">jgoerzen at complete.org
       </A><BR>
    <I>Sat Jul 26 12:40:20 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="005202.html">[Twisted-Python] Considering Twisted for OfflineIMAP
</A></li>
        <LI>Next message: <A HREF="005205.html">[Twisted-Python] Re: Considering Twisted for OfflineIMAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5204">[ date ]</a>
              <a href="thread.html#5204">[ thread ]</a>
              <a href="subject.html#5204">[ subject ]</a>
              <a href="author.html#5204">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Andrew Bennetts &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrew-twisted at puzzling.org</A>&gt; writes:

&gt;<i> Ooh, nifty :)
</I>
Thanks :-)
&gt;<i>
</I>&gt;<i> Twisted uses non-blocking sockets, so it can do an arbitrary amount of
</I>&gt;<i> connections (both client and server) without any threads.  Running multiple
</I>&gt;<i> clients (or servers) at a time is as easy as calling reactor.connectTCP more
</I>&gt;<i> than once.
</I>
Well, yes and no, I think.  Let me elaborate.

OfflineIMAP always behaves as an IMAP client, so I'll be using
twisted.protocols.imap4.IMAP4Client.  This class is written to use one
and exactly one connection to the server (it must, since it takes a
single SSL contextFactory as an arg to __init__).

OfflineIMAP would like to do, say, 4 operations at once.  For the sake
of example, let's say these four are:

1. Getting a list of messages in folder A
2. Downloading a message from folder B
3. Uploading a message to folder B
4. Deleting a message in folder C

Now, the way I'd handle this pre-twisted is that my own IMAP folder
class would basically do this:

imap = pool.acquireconnection()
try:
    # do the stuff here
    # imap.select() to pick the relevant folder
    # imap.download() or whatnot
finally:
    pool.releaseconnection(imap)

This was running with multiple threads, so even though the stuff in
the &quot;try&quot; was blocking, it didn't matter. 

With Twisted, I could clone this setup somewhat by making sure
the last callback and errback in my deferreds from IMAP4Client 
release the connection, that's ugly and error-prone.

I'd imagine that downloading a message would basically go like this:

d = pool.acquireconnection()
d.addCallback(select)
d.addCallback(download)
d.addCallback(releaseconnection)
d.addCallback(returnresults)

But this doesn't take into account errors, and it rather annoying to boot.

So my question is: just how might I accomplish this in a nice way with
Twisted?

&gt;<i> [What happened to question 2?]
</I>
I found the answer to it before I posted the message, so I deleted it
but forgot to renumber.

&gt;&gt;<i> (e.g. twisted.internet.utils.getProcessOutput), a function call in another
</I>&gt;<i> thread completing (e.g. twisted.internet.threads.deferToThread), and so on.
</I>
Got it.

&gt;&gt;<i> 4. The howto &quot;book&quot; alludes to pending improvements on the mail
</I>&gt;&gt;<i>    infrastructure.  Anything I should be aware of here?
</I>&gt;<i>
</I>&gt;<i> Jp has been doing a lot of great work on this recently -- you should
</I>&gt;<i> definitely be working with CVS rather than 1.0.6 if you can.  I don't know
</I>&gt;<i> much about the details, though.
</I>
Do the online API docs refer to the CVS version or 1.0.6?  It's 1.0.6 that
I've got right now.

&gt;<i> I suspect this can be dealt with, but I'm not sure off the top of my head
</I>&gt;<i> how... hopefully someone else can help you here.
</I>
One thought I had was to wait to import the reactor until I know what
kind of UI I want.  That works OK as long as I continue using
ConfigParser for my configuration.  If at some point I switch to using
Twisted's config storage (I know it's there but I haven't looked at it
yet), I suspect that could introduce a chicken-and-egg problem.

-- John



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005202.html">[Twisted-Python] Considering Twisted for OfflineIMAP
</A></li>
	<LI>Next message: <A HREF="005205.html">[Twisted-Python] Re: Considering Twisted for OfflineIMAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5204">[ date ]</a>
              <a href="thread.html#5204">[ thread ]</a>
              <a href="subject.html#5204">[ subject ]</a>
              <a href="author.html#5204">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
