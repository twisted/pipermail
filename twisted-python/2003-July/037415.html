<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: IMAP fixes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20IMAP%20fixes&In-Reply-To=%3C20030707072435.GA32716%40intarweb.us%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="037414.html">
   <LINK REL="Next"  HREF="037416.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: IMAP fixes</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20IMAP%20fixes&In-Reply-To=%3C20030707072435.GA32716%40intarweb.us%3E"
       TITLE="[Twisted-Python] Re: IMAP fixes">exarkun at twistedmatrix.com
       </A><BR>
    <I>Mon Jul  7 01:24:35 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="037414.html">[Twisted-Python] Re: IMAP fixes
</A></li>
        <LI>Next message (by thread): <A HREF="037416.html">[Twisted-Python] Re: IMAP fixes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37415">[ date ]</a>
              <a href="thread.html#37415">[ thread ]</a>
              <a href="subject.html#37415">[ subject ]</a>
              <a href="author.html#37415">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Jul 07, 2003 at 03:57:45PM +1200, Tony Meyer wrote:
&gt;<i> Regarding the new parameter parsing for the IMAP server:
</I>&gt;<i> 
</I>&gt;<i> At the moment, FETCH args are parsed with ParseNestedList, which means that
</I>&gt;<i> any items inside [] are appended as an additional list.
</I>&gt;<i> 
</I>&gt;<i> For example, this command:
</I>&gt;<i>     0003 FETCH 1 BODY.PEEK[HEADER.FIELDS (References X-Ref)] UID
</I>&gt;<i> Becomes:
</I>&gt;<i>     ['BODY.PEEK', ['HEADER.FIELDS', ['References', 'X-Ref']], UID]
</I>&gt;<i> 
</I>&gt;<i> There are really two items that have been requested - BODY.PEEK and UID, but
</I>&gt;<i> the args list has three, because the BODY.PEEK information has been split
</I>&gt;<i> into a separate item.
</I>
  Ideally, I'd like to see this parsed into a structure resembling this:

    [Header(peek=1, name=1, value=1, ['References', 'X-Ref']), UID()]

  The mailbox implementation should have as little knowledge of IMAP4 as
humanly possible.  The current implementation is an example of the &quot;just
enough to work&quot; philosophy.  parseNestedList was actually hacked pretty
awfully to support this after I initially wrote it, because I'd forgotten
about this particular aspect of the IMAP4 query syntax.

&gt;<i> 
</I>&gt;<i> It seems to me that it would make more sense for the result to be:
</I>&gt;<i>     [['BODY.PEEK', ['HEADER.FIELDS', ['References', 'X-Ref']]], UID]
</I>&gt;<i> Or something like that, which keeps the body.peek information together.
</I>&gt;<i> (Note that BODY and BODY.PEEK are the only two FETCH args that have a []
</I>&gt;<i> part.)
</I>&gt;<i> 
</I>
  It does seem like a slight improvement, but I'm not sure it is significant
enough to merit a stop in the API roadmap.  On the other hand, if you're
willing to implement it... ;)


&gt;<i> This is both closer to what was requested, and much easier to parse (IMO).
</I>
  Parsing the current form isn't so bad.  Here's a snippet from the mailbox
I've written:

        i = 0
        r = {}
        L = len(parts)
        while i &lt; L:
            p = parts[i]
            fn = p.upper().replace('.', '_')
            f = getattr(self, '_fetch_' + fn, None)
            if not f:
                raise NotImplementedError, fn
            if i + 1 &lt; L:
                if isinstance(parts[i + 1], types.ListType):
                    r.update(f(msg, parts[i + 1]))
                    i += 2
                    continue
            r.update(f(msg))
            i += 1
        return r

  The key section of interest here is the isinstance() check (the loop
dispatches actual fetching to methods named like &quot;_fetch_BODY_PEEK&quot; and so
on).  I believe parsing an alternate form that continued to intersperse
lists with strings would be pretty similar, with just a few checks
re-arranged.

  Would you be interested in patching the fetch methods to generate a
structure like the one I described above?  Or if you have another idea for a
parsed query structure that is similarly abstracted away from the protocol,
I'd be glad to entertain it.

  Lastly, I definitely recognize this as a weak point in the IMAP4 code, but
fixing it has not yet become a priority, as I already have a working parser.

  Jp

-- 
A disciple of another sect once came to Drescher as he was eating his
morning meal. &quot;I would like to give you this personality test,&quot; said the
outsider, &quot;because I want you to be happy.&quot; Drescher took the paper that was
offered him and put it into the toaster: &quot;I wish the toaster to be happy, 
too.&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="037414.html">[Twisted-Python] Re: IMAP fixes
</A></li>
	<LI>Next message (by thread): <A HREF="037416.html">[Twisted-Python] Re: IMAP fixes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37415">[ date ]</a>
              <a href="thread.html#37415">[ thread ]</a>
              <a href="subject.html#37415">[ subject ]</a>
              <a href="author.html#37415">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
