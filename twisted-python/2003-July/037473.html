<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Implementing a syslog-deamon ??
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Implementing%20a%20syslog-deamon%20%3F%3F&In-Reply-To=%3C20030710124249.GD2672%40shitbomb.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="037476.html">
   <LINK REL="Next"  HREF="037483.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Implementing a syslog-deamon ??</H1>
    <B>Skinny Puppy</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Implementing%20a%20syslog-deamon%20%3F%3F&In-Reply-To=%3C20030710124249.GD2672%40shitbomb.com%3E"
       TITLE="[Twisted-Python] Implementing a syslog-deamon ??">skin_pup-twisted at damnable.happypoo.com
       </A><BR>
    <I>Thu Jul 10 06:42:49 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="037476.html">[Twisted-Python] Implementing a syslog-deamon ??
</A></li>
        <LI>Next message (by thread): <A HREF="037483.html">[Twisted-Python] IMAP BODYSTRUCTURE format &amp; the email.Messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37473">[ date ]</a>
              <a href="thread.html#37473">[ thread ]</a>
              <a href="subject.html#37473">[ subject ]</a>
              <a href="author.html#37473">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Attached is a basic quick easy syslog listener (best name I could come up
with).  In our environment we user deamontools for all daemons and us
multilog to handle logging this is no different. 

Jeremy

Thomas Weholt ( PRIVAT ) [<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">2002 at weholt.org</A>] wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I was wondering if I could implement a fully syslog-compatible
</I>&gt;<i> syslog-deamon/server using Twisted? We need a syslog up and running as soon
</I>&gt;<i> as possible to let our firewall use it, due to some suspicion about hacking
</I>&gt;<i> etc. It would help alot of I could implement a syslog-deamon that put data
</I>&gt;<i> sent to it into a database, instead of to a file. The server must be able to
</I>&gt;<i> run on Windows.
</I>&gt;<i> 
</I>&gt;<i> This would also be a perfect oppertunity to show of Python, open-source and
</I>&gt;<i> Twisted to a group of people who adore Microsoft and Borland and think
</I>&gt;<i> python and all other scripting-languages are for kids and trivial,
</I>&gt;<i> non-critical things.
</I>&gt;<i> 
</I>&gt;<i> Anyway, any hint you can give me will be appreciated.
</I>&gt;<i> 
</I>&gt;<i> Best regards,
</I>&gt;<i> Thomas
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>-------------- next part --------------
#!/usr/local/bin/pythonN)
from twisted.internet import defer, reactor, protocol, ssl
from twisted.python import usage
from OpenSSL import SSL
import sys, os.path

LOG_PRIMASK = 0x07
PRIMASK = { 
0 : &quot;emerg&quot;, 
1 : &quot;alert&quot;,
2 : &quot;crit&quot;,
3 : &quot;err&quot;,
4 : &quot;warning&quot;,
5 : &quot;notice&quot;,
6 : &quot;info&quot;,
7 : &quot;debug&quot;
}

FACILITYMASK = {
      0  : &quot;kern&quot;,
      1  : &quot;user&quot;,
      2  : &quot;mail&quot;,
      3  : &quot;daemon&quot;,
      4  : &quot;auth&quot;,
      5  : &quot;syslog&quot;,
      6  : &quot;lpr&quot;,
      7  : &quot;news&quot;,
      8  : &quot;uucp&quot;,
      9  : &quot;cron&quot;,
      10 : &quot;authpriv&quot;,
      11 : &quot;ftp&quot;,
      12 : &quot;ntp&quot;,
      13 : &quot;security&quot;,
      14 : &quot;console&quot;,
      15 : &quot;mark&quot;,
      16 : &quot;local0&quot;,
      17 : &quot;local1&quot;,
      18 : &quot;local2&quot;,
      19 : &quot;local3&quot;,
      20 : &quot;local4&quot;,
      21 : &quot;local5&quot;,
      22 : &quot;local6&quot;,
      23 : &quot;local7&quot;,
}

def bit2string(number):
    try: return &quot;%s.%s&quot;%(FACILITYMASK[number&gt;&gt;3] , PRIMASK[number &amp; LOG_PRIMASK])
    except: return &quot;unknown.unknown&quot;
        

class syslogOptions(usage.Options):
    optParameters = [['cert', 'c', './server.pem','SSL Server certificate'],
                     ['ip',   'i', None, 'IP Address to listen on']]
    def postOptions_cert(self):
        if (not self.opts['cert']) or (not os.path.isfile(self.opts['cert'])):
            raise usage.UsageError, &quot;%s: is not a file&quot;
    def portOptions_ip(self):
        if (not self.opts['ip']):
            raise usage.UsageError, &quot;IP Address is required&quot;
    
class outputUPD(protocol.DatagramProtocol):
    def datagramReceived(self, data, (ip, port)):
        if data[2] == &quot;&gt;&quot;:
            other = &quot; &quot;.join([ip, bit2string(int(data[1]))])
            sys.stdout.write(&quot; &quot;.join([other, data[3:], &quot;\n&quot;]))
        elif data[3] == &quot;&gt;&quot;:
            other = &quot; &quot;.join([ip, bit2string(int(data[1:2]))])
            sys.stdout.write(&quot; &quot;.join([other, data[4:], &quot;\n&quot;]))
        else:
            other = &quot; &quot;.join([ip, &quot;unknown.unknown&quot;])
            sys.stdout.write(&quot; &quot;.join([other, data, &quot;\n&quot;]))

class outputTCP(protocol.Protocol):
    def connectionMade(self):
        self.factory.numberConnections += 1
        if self.factory.numberConnections &gt; self.factory.maxNumberConnections:
            self.transport.loseConnection()

    def connectionLost(self, reason):
        self.factory.numberConnections -= 1

    def dataReceived(self, data):
        ip = self.transport.getPeer()[1]
        if data[2] == &quot;&gt;&quot;:
            other = &quot; &quot;.join([ip, bit2string(int(data[1]))])
            self.factory.write(&quot; &quot;.join([other, data[3:], &quot;\n&quot;]))
        elif data[3] == &quot;&gt;&quot;:
            other = &quot; &quot;.join([ip, bit2string(int(data[1:2]))])
            self.factory.write(&quot; &quot;.join([other, data[4:], &quot;\n&quot;]))
        else:
            other = &quot; &quot;.join([ip, &quot;unknown.unknown&quot;])
            self.factory.write(&quot; &quot;.join([other, data, &quot;\n&quot;]))

class syslogFactory(protocol.Factory):
    noisy = 0
    numberConnections = 0
    maxNumberConnections = 256
    write = sys.stdout.write
    
    

if __name__ == &quot;__main__&quot;:
    import sys, os
    from twisted.python import log
    log.logfile=sys.stderr
    try:
        config = syslogOptions()
        config.parseOptions()
    except usage.UsageError, ue:
        print &gt;&gt;sys.stderr, '%s:'%sys.argv[0], ue
        sys.exit(1)
    syslogTCP = syslogFactory()
    syslogTCP.protocol = outputTCP
    syslogSSL = syslogFactory()
    syslogSSL.protocol = outputTCP
    ctx = ssl.DefaultOpenSSLContextFactory(config.opts['cert'], config.opts['cert'])
    reactor.listenUDP(514, outputUPD(), interface=config.opts['ip'])
    reactor.listenTCP(514, syslogTCP,   interface=config.opts['ip'])
    reactor.listenSSL(728, syslogSSL , ctx, interface=config.opts['ip'])
    reactor.run()
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="037476.html">[Twisted-Python] Implementing a syslog-deamon ??
</A></li>
	<LI>Next message (by thread): <A HREF="037483.html">[Twisted-Python] IMAP BODYSTRUCTURE format &amp; the email.Messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37473">[ date ]</a>
              <a href="thread.html#37473">[ thread ]</a>
              <a href="subject.html#37473">[ subject ]</a>
              <a href="author.html#37473">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
