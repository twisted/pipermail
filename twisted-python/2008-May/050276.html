<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Implementing STARTTLS in a protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Implementing%20STARTTLS%20in%20a%20protocol&In-Reply-To=%3C20080523203216.4714.1408844087.divmod.quotient.2162%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="050275.html">
   <LINK REL="Next"  HREF="050277.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Implementing STARTTLS in a protocol</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Implementing%20STARTTLS%20in%20a%20protocol&In-Reply-To=%3C20080523203216.4714.1408844087.divmod.quotient.2162%40ohm%3E"
       TITLE="[Twisted-Python] Implementing STARTTLS in a protocol">exarkun at divmod.com
       </A><BR>
    <I>Fri May 23 14:32:16 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="050275.html">[Twisted-Python] Implementing STARTTLS in a protocol
</A></li>
        <LI>Next message (by thread): <A HREF="050277.html">[Twisted-Python] Implementing STARTTLS in a protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50276">[ date ]</a>
              <a href="thread.html#50276">[ thread ]</a>
              <a href="subject.html#50276">[ subject ]</a>
              <a href="author.html#50276">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 23 May 2008 12:29:44 -0500, Kevin Horn &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">kevin.horn at gmail.com</A>&gt; wrote:
&gt;<i>Howdy list,
</I>&gt;<i>
</I>&gt;<i>I'm trying to implement a protocol using Twisted which has a &quot;STARTTLS&quot;
</I>&gt;<i>command to switch the protocol from plain TCP to TCP over TLS.
</I>&gt;<i>
</I>&gt;<i>I've mostly been going by the way that the imap4.py module seems to do it,
</I>&gt;<i>but I can't seem to get a handshake to complete.
</I>&gt;<i>
</I>&gt;<i>I found this page ( <A HREF="http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes">http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes</A> )
</I>&gt;<i>which was helpful, but I don't want to force client cert authentication.
</I>&gt;<i>
</I>&gt;<i>In order to separate this problem from other issues, I've adapted the echo
</I>&gt;<i>protocol code from above the above page to try and get a simple test case
</I>&gt;<i>(my code below)
</I>&gt;<i>
</I>&gt;<i>I am recieving the following output and traceback when running the client
</I>&gt;<i>code ( on both Windows and Linux ):
</I>&gt;<i>
</I>&gt;<i>using TLSv1:
</I>&gt;<i>
</I>&gt;&gt;<i>tls_echoclient.py
</I>&gt;<i>
</I>&gt;<i>Sending: Hello, world!
</I>&gt;<i>receive: ERROR: Must authenticate
</I>&gt;<i>Sending: STARTTLS
</I>&gt;<i>receive: READY
</I>&gt;<i>Sending: Continuing
</I>&gt;<i>connection lost (protocol)
</I>&gt;<i>connection lost: [('SSL routines', 'SSL3_READ_BYTES', 'sslv3 alert handshake
</I>&gt;<i>failure'), ('SSL routines', 'SSL3_READ_BYTES', 'ssl handshake failure')]
</I>&gt;<i>Traceback (most recent call last):
</I>&gt;<i>  File &quot;C:\Documents and
</I>&gt;<i>Settings\kevinh\Desktop\mine_id\sandbox\funsize\sslecho\tls_echoclient.py&quot;,
</I>&gt;<i>line 58, in &lt;module&gt;
</I>&gt;<i>    reactor.run()
</I>&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\internet\posixbase.py&quot;, line
</I>&gt;<i>223, in run
</I>&gt;<i>    self.mainLoop()
</I>&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\internet\posixbase.py&quot;, line
</I>&gt;<i>234, in mainLoop
</I>&gt;<i>    self.doIteration(t)
</I>&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\internet\selectreactor.py&quot;,
</I>&gt;<i>line 140, in doSelect
</I>&gt;<i>    _logrun(selectable, _drdw, selectable, method, dict)
</I>&gt;<i>--- &lt;exception caught here&gt; ---
</I>&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\python\log.py&quot;, line 51, in
</I>&gt;<i>callWithLogger
</I>&gt;<i>    return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
</I>&gt;<i>&lt;&lt; SNIP &gt;&gt;
</I>&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\internet\base.py&quot;, line 490,
</I>&gt;<i>in stop
</I>&gt;<i>    &quot;Can't stop reactor that isn't running.&quot;)
</I>&gt;<i>twisted.internet.error.ReactorNotRunning: Can't stop reactor that isn't
</I>&gt;<i>running.
</I>&gt;<i>
</I>&gt;<i>What am I doing wrong?  Is there a SSL config option I'm setting
</I>&gt;<i>incorrectly?  Do I need to use a different SSL Context? Am I totally off
</I>&gt;<i>base?
</I>&gt;<i>
</I>&gt;<i>Thanks,
</I>&gt;<i>
</I>
The traceback here is just because you're calling reactor.stop() twice,
once in Protocol.connectionLost, then again in Factory.clientConnectionLost.
Get rid of one of these and at least you'll get rid of some spurious noise.

As far as the TLS part of your code goes, it basically looks okay.  By doing
a sendLine immediately before you call startTLS, you risk running into #686,
but if you actually hit that, you should see a warning and the connection
should be closed without an OpenSSL error.

So I'm not exactly sure what problem you're encountering.  To further
complicate matters, when I run your code, TLS is successfully negotiated.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="050275.html">[Twisted-Python] Implementing STARTTLS in a protocol
</A></li>
	<LI>Next message (by thread): <A HREF="050277.html">[Twisted-Python] Implementing STARTTLS in a protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50276">[ date ]</a>
              <a href="thread.html#50276">[ thread ]</a>
              <a href="subject.html#50276">[ subject ]</a>
              <a href="author.html#50276">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
