<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] ldaptor's LDAPClient.send_multiResponse not dealing with chained deferreds, patch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20ldaptor%27s%20LDAPClient.send_multiResponse%20not%0A%20dealing%20with%20chained%20deferreds%2C%20patch&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017629.html">
   <LINK REL="Next"  HREF="017631.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] ldaptor's LDAPClient.send_multiResponse not dealing with chained deferreds, patch</H1>
    <B>Michael Torrie</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20ldaptor%27s%20LDAPClient.send_multiResponse%20not%0A%20dealing%20with%20chained%20deferreds%2C%20patch&In-Reply-To="
       TITLE="[Twisted-Python] ldaptor's LDAPClient.send_multiResponse not dealing with chained deferreds, patch">torriem at gmail.com
       </A><BR>
    <I>Sat May  3 21:03:29 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="017629.html">[Twisted-Python] Problem Changing Time Format of a Log
</A></li>
        <LI>Next message: <A HREF="017631.html">[Twisted-Python] ldaptor's LDAPClient.send_multiResponse not	dealing with chained deferreds, patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17630">[ date ]</a>
              <a href="thread.html#17630">[ thread ]</a>
              <a href="subject.html#17630">[ subject ]</a>
              <a href="author.html#17630">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This message is probably for Tv.

I have a situation where the callback to a
LDAPClient.send_multiResponse() call needs to do a bunch of work that I
want to split up over several functions, using deferred chaining.  What
I want to do is something like this (this in conjunction with an LDAP
proxy server I am writing using Twisted and ldaptor):


d = self.client.send_multiResponse(request, got_response)

then later:

def got_response(response):

    # get a list of other things to do with the response
    d = do_stuff_with_response(response)
    d.addCallback(finish)

    return d


def finish(response):
    # we're done

    return isinstance(response, (
            pureldap.LDAPSearchResultDone,
            pureldap.LDAPBindResponse,
            ))

However, this doesn't work, because the send_multiResponse() method of
LDAPClient isn't expecting the handler to return a deferred, even though
if I do return a deferred the reactor does handle it properly, chaining
the deferreds and their callbacks.

The problem is that in ldapclient.py, line 171, we have:

                # Return true to mark request as fully handled
                if handler(msg.value, *args, **kwargs):
                    del self.onwire[msg.id]

When handler() returns a deferred object, after the reactor processes
the chain the value is a Deferred object, not True or False, even though
the value of the deferred object may be True or False.  Hence the del
self.onwire[msg.id] always executes, which when dealing with search
result entries is a problem as they all share the same id.  I made a
quick hack to fix this:
-----------------------------------------------------------
--- /tmp/ldapclient.py  2008-05-03 18:53:26.000000000 -0600
+++ ldaptor/protocols/ldap/ldapclient.py        2008-05-03
18:58:07.000000000 -0600
@@ -168,7 +168,14 @@
                 assert args is not None
                 assert kwargs is not None
                 # Return true to mark request as fully handled
-                if handler(msg.value, *args, **kwargs):
+                result = handler(msg.value, *args, **kwargs)
+
+                try:
+                    result = result.result
+                except AttributeError:
+                    pass
+
+               if result:
                     del self.onwire[msg.id]

     ##Bind
----------------------------------------------------------

Is this an acceptable way to do this?


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017629.html">[Twisted-Python] Problem Changing Time Format of a Log
</A></li>
	<LI>Next message: <A HREF="017631.html">[Twisted-Python] ldaptor's LDAPClient.send_multiResponse not	dealing with chained deferreds, patch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17630">[ date ]</a>
              <a href="thread.html#17630">[ thread ]</a>
              <a href="subject.html#17630">[ subject ]</a>
              <a href="author.html#17630">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
