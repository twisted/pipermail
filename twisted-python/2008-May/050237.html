<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] __slots__ help (Re: Memory size of Deferreds)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20__slots__%20help%20%28Re%3A%20Memory%20size%20of%20Deferreds%29&In-Reply-To=%3C87d4nhum1w.fsf_-_%40softax.com.pl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="050235.html">
   <LINK REL="Next"  HREF="050246.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] __slots__ help (Re: Memory size of Deferreds)</H1>
    <B>Marcin Kasperski</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20__slots__%20help%20%28Re%3A%20Memory%20size%20of%20Deferreds%29&In-Reply-To=%3C87d4nhum1w.fsf_-_%40softax.com.pl%3E"
       TITLE="[Twisted-Python] __slots__ help (Re: Memory size of Deferreds)">Marcin.Kasperski at softax.com.pl
       </A><BR>
    <I>Tue May 20 07:44:59 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="050235.html">[Twisted-Python] Re: Memory size of Deferreds
</A></li>
        <LI>Next message (by thread): <A HREF="050246.html">[Twisted-Python] Re: __slots__ help (Re: Memory size of Deferreds)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50237">[ date ]</a>
              <a href="thread.html#50237">[ thread ]</a>
              <a href="subject.html#50237">[ subject ]</a>
              <a href="author.html#50237">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
It is not that difficult to see what is inside the deferred (spawn
some debugger and see):

(this may be a class variable)

 debug  (boolean)

(those surely are instance variables)

 callbacks (a list, initially empty, later containing tuples of tuples)
 called (int)
 paused (int)
 result (anything)
 timeoutCall (None or object)
 _runningCallbacks (boolean)
 _debugInfo (object of type DebugInfo)

Bare names of attributes take about 60 bytes (this is what could be
reclamied with __slots__), some of them are references, we have a list
(which inside contains complicated structures), ....

It could be an interesting experiment to define __slots__ for Deferred
class and see what is the memory impact.

Hmm, hmm. I did an experiment. Here is one version of the testing code:

    Cls = Deferred
    count = 250000
    import os
    pid = os.getpid()
    cmd = &quot;ps -F %d&quot; % pid
    a = [Cls() for _ in xrange(count)]
    os.system(cmd)
    b = [Cls() for _ in xrange(count)]
    os.system(cmd)
    c = [Cls() for _ in xrange(count)]
    os.system(cmd)

and here is one using __slots__:


    from twisted.internet.defer import timeout, Deferred

    class SlotsDeferred(object):
        __slots__ = ['debug', 'callbacks', 'called', 'paused', 'result', 'timeoutCall', '_runningCallbacks', '_debugInfo']

        # whole content of original Deferred class copied as-is here

    Cls = SlotsDeferred
    count = 250000
    import os
    pid = os.getpid()
    cmd = &quot;ps -F %d&quot; % pid
    a = [Cls() for _ in xrange(count)]
    os.system(cmd)
    b = [Cls() for _ in xrange(count)]
    os.system(cmd)
    c = [Cls() for _ in xrange(count)]
    os.system(cmd)

And here are the results:

(standard Deferred)

$ python testdef.py
UID        PID  PPID  C    SZ   RSS PSR STIME TTY      STAT   TIME CMD
marcink  23109 20536 92 15180 56992   1 15:40 pts/18   S+     0:00 python testdef.py
UID        PID  PPID  C    SZ   RSS PSR STIME TTY      STAT   TIME CMD
marcink  23109 20536 99 28374 109000  1 15:40 pts/18   S+     0:02 python testdef.py
UID        PID  PPID  C    SZ   RSS PSR STIME TTY      STAT   TIME CMD
marcink  23109 20536 99 41568 161020  1 15:40 pts/18   S+     0:05 python testdef.py

(Deferred with __slots__ added)

$ python testdef.py
UID        PID  PPID  C    SZ   RSS PSR STIME TTY      STAT   TIME CMD
marcink  23127 20536  0  7834 28068   1 15:41 pts/18   S+     0:00 python testdef.py
UID        PID  PPID  C    SZ   RSS PSR STIME TTY      STAT   TIME CMD
marcink  23127 20536 99 13683 51160   0 15:41 pts/18   S+     0:01 python testdef.py
UID        PID  PPID  C    SZ   RSS PSR STIME TTY      STAT   TIME CMD
marcink  23127 20536 99 19532 74256   1 15:41 pts/18   S+     0:02 python testdef.py

As one can see, the memory usage is ~ halved.

So ... maybe it would make sense to add __slots__ to deferreds, after all?

-- 
----------------------------------------------------------------------
|<i> Marcin Kasperski   |  In any large change, 1/3 will think it is
</I>|<i> <A HREF="http://mekk.waw.pl">http://mekk.waw.pl</A> | great, 1/3 will think it is stupid, and 1/3
</I>|<i>                    |               will wait (Reed)
</I>----------------------------------------------------------------------



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="050235.html">[Twisted-Python] Re: Memory size of Deferreds
</A></li>
	<LI>Next message (by thread): <A HREF="050246.html">[Twisted-Python] Re: __slots__ help (Re: Memory size of Deferreds)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50237">[ date ]</a>
              <a href="thread.html#50237">[ thread ]</a>
              <a href="subject.html#50237">[ subject ]</a>
              <a href="author.html#50237">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
