<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: Memory size of Deferreds
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20Memory%20size%20of%20Deferreds&In-Reply-To=%3C87tzgu9g61.fsf%40hbox.dyndns.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="050233.html">
   <LINK REL="Next"  HREF="050235.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: Memory size of Deferreds</H1>
    <B>Martin Geisler</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20Memory%20size%20of%20Deferreds&In-Reply-To=%3C87tzgu9g61.fsf%40hbox.dyndns.org%3E"
       TITLE="[Twisted-Python] Re: Memory size of Deferreds">mg at daimi.au.dk
       </A><BR>
    <I>Mon May 19 14:45:26 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="050233.html">[Twisted-Python] Memory size of Deferreds
</A></li>
        <LI>Next message (by thread): <A HREF="050235.html">[Twisted-Python] Re: Memory size of Deferreds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50234">[ date ]</a>
              <a href="thread.html#50234">[ thread ]</a>
              <a href="subject.html#50234">[ subject ]</a>
              <a href="author.html#50234">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&quot;Michal Pasternak&quot; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">michal.dtz at gmail.com</A>&gt; writes:

Thanks for the reply!

&gt;<i> 2008/5/19 Martin Geisler &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mg at daimi.au.dk</A>&gt;:
</I>&gt;&gt;<i> What worries me is the size of a single Deferred. One user wanted to
</I>&gt;&gt;<i> do computations on very large lists of Deferreds and reported that his
</I>&gt;&gt;<i> programs used more memory than expected.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried to measure the size of a Deferred by creating large lists of
</I>&gt;&gt;<i> them and found that a single empty Deferred takes up about 200 bytes.
</I>&gt;&gt;<i> Adding a callback brings that up to about 500 bytes.
</I>&gt;<i>
</I>&gt;<i> As such thing as memory allocation is tightly tied to the runtime
</I>&gt;<i> environment, it is a bit hard to give reasonable answers without any
</I>&gt;<i> information about, at least, an OS and a CPU.
</I>
Ah, sorry: I tested this on an Athlon 64 X2 (but with 32-bit Debian). I
simply tested like this:

% python
Python 2.5.2 (r252:60911, Apr 17 2008, 13:15:05) 
[GCC 4.2.3 (Debian 4.2.3-3)] on linux2
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt;<i> from twisted.internet.defer import Deferred
</I>&gt;&gt;&gt;<i> a = [Deferred() for _ in xrange(100000)]
</I>&gt;&gt;&gt;<i> b = [Deferred() for _ in xrange(100000)]
</I>&gt;&gt;&gt;<i> c = [Deferred() for _ in xrange(100000)]
</I>
and noted how the memory usage rose from 8 MiB to 30 MiB, to 52 MiB to
73 MiB in 'top'. So that is about 22 MiB per list -- around ~200 bytes
pr Deferred. (I know there is some overhead for the list.)

&gt;<i> Did the memory in the case you mention grow constantly? Is that user
</I>&gt;<i> sure, that it was not a memory leak in his/hers code?
</I>
I think he was just concerned that his application used 450 MiB RAM, and
that made me try to see how big an empty Deferred is.

&gt;<i> Deferreds, as you all already know, are a core concept that Twisted is
</I>&gt;<i> built upon. If you need to optimize such areas of Twisted, then, just
</I>&gt;<i> my suggestion - maybe you are using a wrong tool to do the job. If the
</I>&gt;<i> memory usage is a problem, then, well, maybe you are trying to do
</I>&gt;<i> things at once, when you should do them sequentially (eg. using a
</I>&gt;<i> generator).
</I>
Yes, you may be right... scheduling everything to run at once is
probably not necessary. It just makes things simple with my design.

I would love to get some advice on the design of my library -- it is the
first thing I have made with Twisted. The goal of VIFF is to enable
shared computations -- think addition and multiplication. So the user writes

  x = add(a, mul(b * c))

and where a, b, c are Deferreds which will eventually hold integers. The
add and mul functions return new Deferreds which will eventually hold
the results. Addition is simple:

  def add(x, y):
      sum = gatherResults([x, y])
      sum.addCallback(lambda results: results[0] + results[1])
      return sum

Multiplication is similar, but requires network communication -- that is
why it returns a Deferred.

This is the basic operation of the library: an expression tree is built
and evaluated from the leaves inwards. The important point is that as
much as possible is done in parallel, that all operations run as soon as
their operands are available. Twisted made this extremely easy thanks to
the DeferredList and Deferred abstraction.

&gt;<i> Maybe you should rather look into other areas of the problem (eg. not
</I>&gt;<i> try to optimize deferreds, but the code that uses them). Maybe you
</I>&gt;<i> should use something else than Deferreds for that job. As for memory
</I>&gt;<i> usage of such small objects like Deferreds, well... Python is, well,
</I>&gt;<i> Python. Python string or integer uses much more memory, than C string
</I>&gt;<i> or int. You can't tune Python string memory usage, and you hardly can
</I>&gt;<i> do anything about size of Deferred if that becomes a problem.
</I>
There is the possibility of using the __slots__ attribute to avoid the
object dictionary. I don't know what negative sideeffects that might
have, though.

Also, I have yet to try the C implementation of Deferred to see how it
performs memory-wise.

&gt;<i> On the other hand, you should be able to write optimal code with
</I>&gt;<i> Python faster and memory footprint shouldn't be a problem (from my
</I>&gt;<i> experience, in many cases Twisted footprint is suprisingly low).
</I>&gt;<i>
</I>&gt;<i> In other words - if size of Deferred object is your only bottleneck,
</I>&gt;<i> then congratulations :-)
</I>
Hehe, thanks! :-) I am certainly not claiming that Deferreds are the
only bottleneck or consumer of memory. I just figured that they would be
an easy starting point since my code (and as you say, Twisted in
general) uses them a lot.

&gt;<i> I'd rather suggest optimizing other parts of the code - as Deferreds
</I>&gt;<i> are the core of Twisted, I suppose it could be a bit hard to do
</I>&gt;<i> anything about them, in the same way you can't do anything about
</I>&gt;<i> memory footprint of core Python objects.
</I>
Right... I'll try looking through the code to see if I by mistake hold
on to Deferreds or other objects longer than I have to.

-- 
Martin Geisler

VIFF (Virtual Ideal Functionality Framework) brings easy and efficient
SMPC (Secure Multi-Party Computation) to Python. See: <A HREF="http://viff.dk/.">http://viff.dk/.</A>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 188 bytes
Desc: not available
URL: &lt;/pipermail/twisted-python/attachments/20080519/129814a7/attachment.sig&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="050233.html">[Twisted-Python] Memory size of Deferreds
</A></li>
	<LI>Next message (by thread): <A HREF="050235.html">[Twisted-Python] Re: Memory size of Deferreds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50234">[ date ]</a>
              <a href="thread.html#50234">[ thread ]</a>
              <a href="subject.html#50234">[ subject ]</a>
              <a href="author.html#50234">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
