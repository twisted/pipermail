<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Implementing STARTTLS in a protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Implementing%20STARTTLS%20in%20a%20protocol&In-Reply-To=20080523203216.4714.1408844087.divmod.quotient.2162%40ohm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017768.html">
   <LINK REL="Next"  HREF="017770.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Implementing STARTTLS in a protocol</H1>
    <B>Kevin Horn</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Implementing%20STARTTLS%20in%20a%20protocol&In-Reply-To=20080523203216.4714.1408844087.divmod.quotient.2162%40ohm"
       TITLE="[Twisted-Python] Implementing STARTTLS in a protocol">kevin.horn at gmail.com
       </A><BR>
    <I>Fri May 23 18:31:39 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="017768.html">[Twisted-Python] Implementing STARTTLS in a protocol
</A></li>
        <LI>Next message: <A HREF="017770.html">[Twisted-Python] Implementing STARTTLS in a protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17769">[ date ]</a>
              <a href="thread.html#17769">[ thread ]</a>
              <a href="subject.html#17769">[ subject ]</a>
              <a href="author.html#17769">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, May 23, 2008 at 3:32 PM, Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt;
wrote:

&gt;<i> On Fri, 23 May 2008 12:29:44 -0500, Kevin Horn &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">kevin.horn at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Howdy list,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm trying to implement a protocol using Twisted which has a &quot;STARTTLS&quot;
</I>&gt;&gt;<i> command to switch the protocol from plain TCP to TCP over TLS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've mostly been going by the way that the imap4.py module seems to do it,
</I>&gt;&gt;<i> but I can't seem to get a handshake to complete.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I found this page ( <A HREF="http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes">http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes</A>)
</I>&gt;&gt;<i> which was helpful, but I don't want to force client cert authentication.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In order to separate this problem from other issues, I've adapted the echo
</I>&gt;&gt;<i> protocol code from above the above page to try and get a simple test case
</I>&gt;&gt;<i> (my code below)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am recieving the following output and traceback when running the client
</I>&gt;&gt;<i> code ( on both Windows and Linux ):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> using TLSv1:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  tls_echoclient.py
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sending: Hello, world!
</I>&gt;&gt;<i> receive: ERROR: Must authenticate
</I>&gt;&gt;<i> Sending: STARTTLS
</I>&gt;&gt;<i> receive: READY
</I>&gt;&gt;<i> Sending: Continuing
</I>&gt;&gt;<i> connection lost (protocol)
</I>&gt;&gt;<i> connection lost: [('SSL routines', 'SSL3_READ_BYTES', 'sslv3 alert
</I>&gt;&gt;<i> handshake
</I>&gt;&gt;<i> failure'), ('SSL routines', 'SSL3_READ_BYTES', 'ssl handshake failure')]
</I>&gt;&gt;<i> Traceback (most recent call last):
</I>&gt;&gt;<i>  File &quot;C:\Documents and
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Settings\kevinh\Desktop\mine_id\sandbox\funsize\sslecho\tls_echoclient.py&quot;,
</I>&gt;&gt;<i> line 58, in &lt;module&gt;
</I>&gt;&gt;<i>   reactor.run()
</I>&gt;&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\internet\posixbase.py&quot;, line
</I>&gt;&gt;<i> 223, in run
</I>&gt;&gt;<i>   self.mainLoop()
</I>&gt;&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\internet\posixbase.py&quot;, line
</I>&gt;&gt;<i> 234, in mainLoop
</I>&gt;&gt;<i>   self.doIteration(t)
</I>&gt;&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\internet\selectreactor.py&quot;,
</I>&gt;&gt;<i> line 140, in doSelect
</I>&gt;&gt;<i>   _logrun(selectable, _drdw, selectable, method, dict)
</I>&gt;&gt;<i> --- &lt;exception caught here&gt; ---
</I>&gt;&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\python\log.py&quot;, line 51, in
</I>&gt;&gt;<i> callWithLogger
</I>&gt;&gt;<i>   return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
</I>&gt;&gt;<i> &lt;&lt; SNIP &gt;&gt;
</I>&gt;&gt;<i>  File &quot;C:\Python25\lib\site-packages\twisted\internet\base.py&quot;, line 490,
</I>&gt;&gt;<i> in stop
</I>&gt;&gt;<i>   &quot;Can't stop reactor that isn't running.&quot;)
</I>&gt;&gt;<i> twisted.internet.error.ReactorNotRunning: Can't stop reactor that isn't
</I>&gt;&gt;<i> running.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What am I doing wrong?  Is there a SSL config option I'm setting
</I>&gt;&gt;<i> incorrectly?  Do I need to use a different SSL Context? Am I totally off
</I>&gt;&gt;<i> base?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> The traceback here is just because you're calling reactor.stop() twice,
</I>&gt;<i> once in Protocol.connectionLost, then again in
</I>&gt;<i> Factory.clientConnectionLost.
</I>&gt;<i> Get rid of one of these and at least you'll get rid of some spurious noise.
</I>&gt;<i>
</I>
Thanks for responding, Jean-Paul, and thanks for the tip.  I've been so
consumed
with reading through the noise that for some reason it never occurred to me
to try
and get rid of it.

As far as the TLS part of your code goes, it basically looks okay.  By doing
&gt;<i> a sendLine immediately before you call startTLS, you risk running into
</I>&gt;<i> #686,
</I>&gt;<i> but if you actually hit that, you should see a warning and the connection
</I>&gt;<i> should be closed without an OpenSSL error.
</I>&gt;<i>
</I>&gt;<i> So I'm not exactly sure what problem you're encountering.  To further
</I>&gt;<i> complicate matters, when I run your code, TLS is successfully negotiated.
</I>&gt;<i>
</I>Jean-Paul



Well that's ... frustrating.  I was hoping I had just overlooked something
obvious (and easy to fix!)

Can you tell me more about the environment you are running under?

So far I've tried:
WinXP,  Python 2.5, Twisted 8.0.1, pyOpenSSL 0.7, OpenSSL 0.9.8g
Linux(CentOS), Python 2.4, Twisted 8.1.0, pyOpenSSL 0.7, OpenSSL 0.9.7a

Perhaps there is something wrong with my certificates?  I would expect that
this would cause errors on the server end, though...

Is there any way to get more information about the handshake failure?

Thanks,

Kevin Horn
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20080523/1d7edf0e/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20080523/1d7edf0e/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017768.html">[Twisted-Python] Implementing STARTTLS in a protocol
</A></li>
	<LI>Next message: <A HREF="017770.html">[Twisted-Python] Implementing STARTTLS in a protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17769">[ date ]</a>
              <a href="thread.html#17769">[ thread ]</a>
              <a href="subject.html#17769">[ subject ]</a>
              <a href="author.html#17769">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
