<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted Perspective Broker: get client ip
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted%20Perspective%20Broker%3A%20get%20client%20ip&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024494.html">
   <LINK REL="Next"  HREF="024497.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted Perspective Broker: get client ip</H1>
    <B>Andrea Di Mario</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted%20Perspective%20Broker%3A%20get%20client%20ip&In-Reply-To="
       TITLE="[Twisted-Python] Twisted Perspective Broker: get client ip">anddimario at gmail.com
       </A><BR>
    <I>Mon Sep 12 04:19:53 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="024494.html">[Twisted-Python] Announcement: txHybridCluster client released
</A></li>
        <LI>Next message: <A HREF="024497.html">[Twisted-Python] Autobahn WebSockets - Twisted based WS	implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24496">[ date ]</a>
              <a href="thread.html#24496">[ thread ]</a>
              <a href="subject.html#24496">[ subject ]</a>
              <a href="author.html#24496">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, i'm writing a perspective broker server. Now, i should get the
client IP, that perspective broker writes well in the log. I've tried
to get it from MyRealm with: mind.broker.transport.getPeer(), without
success. I've tried self.transport.getPeer() to, with this result:
exceptions.AttributeError: Listner instance has no attribute 'transport'
It's strange, because PB wrote the client IP, infact in log i've line with:
2011-09-11 16:41:58+0200 [Broker,0,127.0.0.1] ............

Could you suggest me something?
Thanks.
Here the code:

from OpenSSL import SSL
from twisted.internet import reactor, ssl
from ConfigParser import SafeConfigParser
from twisted.python import log
from twisted.spread import pb
from twisted.cred import checkers, portal
from zope.interface import implements
import hashlib

class Listner(pb.Avatar):

   def __init__(self, name):
           self.name = name

   def perspective_getDictionary(self, dictionary):
      print dictionary

   def perspective_simplyAccess(self, access):
      print access

def verifyCallback(connection, x509,  errnum, errdepth, ok):
   if not ok:
      log.msg(&quot;Certificato non valido: %s&quot; % x509.get_subject())
      return False
   else:
      log.msg(&quot;Connessione stabilita, vertificato valido: %s&quot; %
x509.get_subject())
   return True


class MyRealm:
    implements(portal.IRealm)
    def requestAvatar(self, avatarId, mind, *interfaces):
        if pb.IPerspective not in interfaces:
            raise NotImplementedError
        return pb.IPerspective, Listner(avatarId), lambda:None


if __name__ == &quot;__main__&quot;:

       CONFIGURATION = SafeConfigParser()
       CONFIGURATION.read('server.conf')
       PORT = CONFIGURATION.get('general', 'port')
       LOGFILE = CONFIGURATION.get('general', 'log')

        log.startLogging(open(LOGFILE,'a'))


       myContextFactory =
ssl.DefaultOpenSSLContextFactory(CONFIGURATION.get('general',
'keypath'), CONFIGURATION.get('general', 'certpath'))
       ctx = myContextFactory.getContext()
       ctx.set_verify(SSL.VERIFY_PEER |
SSL.VERIFY_FAIL_IF_NO_PEER_CERT, verifyCallback)

       ctx.load_verify_locations(CONFIGURATION.get('general', 'cacert'))

       p = portal.Portal(MyRealm())
       c = checkers.FilePasswordDB('passwords.txt',
caseSensitive=True, cache=True)
       p.registerChecker(c)
       factory = pb.PBServerFactory(p)
       reactor.listenSSL(int(PORT), factory, myContextFactory)
       reactor.run()

-- 
Andrea Di Mario

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024494.html">[Twisted-Python] Announcement: txHybridCluster client released
</A></li>
	<LI>Next message: <A HREF="024497.html">[Twisted-Python] Autobahn WebSockets - Twisted based WS	implementation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24496">[ date ]</a>
              <a href="thread.html#24496">[ thread ]</a>
              <a href="subject.html#24496">[ subject ]</a>
              <a href="author.html#24496">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
