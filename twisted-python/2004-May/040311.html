<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] A problem with runUntilCurrent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20problem%20with%20runUntilCurrent&In-Reply-To=%3C20040517150438.56987.qmail%40web8307.mail.in.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="040309.html">
   <LINK REL="Next"  HREF="040312.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] A problem with runUntilCurrent</H1>
    <B>Bill la Forge</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20problem%20with%20runUntilCurrent&In-Reply-To=%3C20040517150438.56987.qmail%40web8307.mail.in.yahoo.com%3E"
       TITLE="[Twisted-Python] A problem with runUntilCurrent">laforge49 at yahoo.co.in
       </A><BR>
    <I>Mon May 17 09:04:38 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="040309.html">[Twisted-Python] A problem with runUntilCurrent
</A></li>
        <LI>Next message (by thread): <A HREF="040312.html">[Twisted-Python] A problem with runUntilCurrent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40311">[ date ]</a>
              <a href="thread.html#40311">[ thread ]</a>
              <a href="subject.html#40311">[ subject ]</a>
              <a href="author.html#40311">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Itamar, 
 
This is also problematic. What this code does is limit the number of
calls that will be made by runUntilCurrent. However, if there's code
that does a callLater with a delay of 0, it will always execute that.
 
The problem now is that only callLater's with a delay of 0 will be
executed. Yes, now the main loop runs fine, but the other timeouts
are prevented from running. 
 
I'm thinking that what you need to do is to have runUntilCurrent first
extract all the pending timed calls that it plans to execute, creating
a sub-list, and then call them. It takes two loops, not one.
 
Bill

Itamar Shtull-Trauring &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A>&gt; wrote:
On Mon, 2004-05-17 at 10:14, Bill la Forge wrote:

&gt;<i> This means that when you do a callLater with a delay of 0, 
</I>&gt;<i> runUntilCurrent will immediately call the delayed function, which then
</I>&gt;<i> calls callLater, and again the delayed function is immediately called,
</I>&gt;<i> etc.
</I>
And that's why testImmediateThread failed. Attached is a fixed up patch
that solves that problem.


Index: base.py
===================================================================
--- base.py (revision 10658)
+++ base.py (working copy)
@@ -368,7 +368,11 @@
assert callable(_f), &quot;%s is not callable&quot; % _f
assert sys.maxint &gt;= _seconds &gt;= 0, \
&quot;%s is not greater than or equal to 0 seconds&quot; % (_seconds,)
- tple = DelayedCall(seconds() + _seconds, _f, args, kw,
+ if _seconds == 0:
+ tcc = 0
+ else:
+ tcc = seconds() + _seconds
+ tple = DelayedCall(tcc, _f, args, kw,
self._pendingTimedCalls.remove,
self._resetCallLater)
insort(self._pendingTimedCalls, tple)
@@ -416,7 +420,10 @@
count += 1
del self.threadCallQueue[:count]
now = seconds()
- while self._pendingTimedCalls and (self._pendingTimedCalls[-1].time &lt;= now):
+ # make sure we don't run newly added calls, so we don't get into infinite loop
+ numCalls = len(self._pendingTimedCalls)
+ while numCalls and (self._pendingTimedCalls[-1].time &lt;= now):
+ numCalls -= 1
call = self._pendingTimedCalls.pop()
try:
call.called = 1


Bill la Forge
<A HREF="http://www.geocities.com/laforge49/">http://www.geocities.com/laforge49/</A>
Yahoo! India Matrimony: Find your partner online.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20040517/cd589a6c/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="040309.html">[Twisted-Python] A problem with runUntilCurrent
</A></li>
	<LI>Next message (by thread): <A HREF="040312.html">[Twisted-Python] A problem with runUntilCurrent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40311">[ date ]</a>
              <a href="thread.html#40311">[ thread ]</a>
              <a href="subject.html#40311">[ subject ]</a>
              <a href="author.html#40311">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
