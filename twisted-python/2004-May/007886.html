<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] service takedown (one newbie to other newbies,	methinks)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20service%20takedown%20%28one%20newbie%20to%20other%20newbies%2C%0A%09methinks%29&In-Reply-To=20040522091550.54246.qmail%40web8303.mail.in.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007885.html">
   <LINK REL="Next"  HREF="007883.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] service takedown (one newbie to other newbies,	methinks)</H1>
    <B>Bill la Forge</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20service%20takedown%20%28one%20newbie%20to%20other%20newbies%2C%0A%09methinks%29&In-Reply-To=20040522091550.54246.qmail%40web8303.mail.in.yahoo.com"
       TITLE="[Twisted-Python] service takedown (one newbie to other newbies,	methinks)">laforge49 at yahoo.co.in
       </A><BR>
    <I>Sat May 22 06:58:04 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="007885.html">[Twisted-Python] service takedown (one newbie to other newbies,	methinks)
</A></li>
        <LI>Next message: <A HREF="007883.html">[Twisted-Python] delay 0 patch for 1.3 base.py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7886">[ date ]</a>
              <a href="thread.html#7886">[ thread ]</a>
              <a href="subject.html#7886">[ subject ]</a>
              <a href="author.html#7886">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>OK, I've got a better test environment for Tiered,
and found yet another bug. ;-)

I've also done a bit of refactoring. A terminology
change, actually. When the TieredService is started,
it initializes subordinate services. It only starts 
them when the reactor is actually running.

The idea is that its easy to immediately cancel
a service which is initialized, but not yet actively
being used. And I'm thinking (feedback requested!),
once a service is started, it is fair game to go
ahead and use it. Thus the delay in starting
subordinate services until the need for cancelation
is truely past.

Bill

from twisted.application import service
from twisted.internet import reactor
from twisted.python import log

class SubordinateService(service.Service):
    def __getstate__(self):
        d = service.Service.__getstate__(self)
        for attr in self.volatile:
            if d.has_key(attr):
                del d[attr]
        return d
    volatile=[]
    def initService(self):
        &quot;&quot;&quot;
        Initialize the service, prior to starting.
        &quot;&quot;&quot;
    def cancelService(self):
        &quot;&quot;&quot;
        Immediate cancelation of the subordinate
service
        which has been initialized but not started.
        &quot;&quot;&quot;

class TieredService(service.MultiService):
    &quot;&quot;&quot;
    Subordinate services should raise an
    exception when unable to init.
    &quot;&quot;&quot;
    def __init__(self,stopOnStartFailure=False):
        service.MultiService.__init__(self)
        self.stopOnStartFailure=stopOnStartFailure
    def __getstate__(self):
        d = service.Service.__getstate__(self)
        for attr in self.volatile:
            if d.has_key(attr):
                del d[attr]
        return d
    volatile=['shutdownTrigger','initialized']
    def startService(self):
        self.initialized=[]
        for svc in self:
            try:
                svc.initService()
            except:
                log.err()
                self._cancelService()
                return
            else:
                self.initialized.append(svc)
        self.shutdownTrigger=reactor \
            .addSystemEventTrigger(
                'before',
                'shutdown',
                self._cancelService)
        reactor.callWhenRunning(self._nowRunning)
        service.Service.startService(self)
    def _cancelService(self):
        &quot;&quot;&quot;
        Immediate cancelation of the
        subordinate service(s).
        &quot;&quot;&quot;
        service.Service.stopService(self)
        for svc in self.initialized[::-1]:
            svc.cancelService()
        if self.stopOnStartFailure:
            reactor.stop()
    def _nowRunning(self):
        reactor.removeSystemEventTrigger(
            self.shutdownTrigger)
        self.shutdownTrigger=None
        self.initialized=None
        service.MultiService.startService(self)


________________________________________________________________________
Yahoo! India Matrimony: Find your partner online. <A HREF="http://yahoo.shaadi.com/india-matrimony/">http://yahoo.shaadi.com/india-matrimony/</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007885.html">[Twisted-Python] service takedown (one newbie to other newbies,	methinks)
</A></li>
	<LI>Next message: <A HREF="007883.html">[Twisted-Python] delay 0 patch for 1.3 base.py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7886">[ date ]</a>
              <a href="thread.html#7886">[ thread ]</a>
              <a href="subject.html#7886">[ subject ]</a>
              <a href="author.html#7886">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
