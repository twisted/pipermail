<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] integrating CompStrm//adding background processing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20integrating%20CompStrm//adding%20background%20processing&In-Reply-To=%3C20040516114956.67585.qmail%40web8309.mail.in.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="040297.html">
   <LINK REL="Next"  HREF="040292.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] integrating CompStrm//adding background processing</H1>
    <B>Bill la Forge</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20integrating%20CompStrm//adding%20background%20processing&In-Reply-To=%3C20040516114956.67585.qmail%40web8309.mail.in.yahoo.com%3E"
       TITLE="[Twisted-Python] integrating CompStrm//adding background processing">laforge49 at yahoo.co.in
       </A><BR>
    <I>Sun May 16 05:49:56 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="040297.html">[Twisted-Python] Learning Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="040292.html">[Twisted-Python] integrating CompStrm//adding background	processing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40291">[ date ]</a>
              <a href="thread.html#40291">[ thread ]</a>
              <a href="subject.html#40291">[ subject ]</a>
              <a href="author.html#40291">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've been working on integrating Compstrm 
( <A HREF="http://compstrm.sourceforge.net">http://compstrm.sourceforge.net</A> ) and, while integration was pretty 
easy, it got harder when I wanted to speed things up.
 
Basicly, compstrm uses yields to impliment a kind of light-weight 
threads. So I needed to add background processing to the main reactor 
loop. Here's the code I finally came up with:
 
from twisted.internet import reactor
def _runUntilCurrentNew():
    if reactor.poll:
        p=reactor.poll
        reactor.poll=None
        p()
    _runUntilCurrentOld()
 
_runUntilCurrentOld=reactor.runUntilCurrent
reactor.runUntilCurrent=_runUntilCurrentNew

reactor.poll=None
def _timeoutNew():
    if reactor.poll:
        return 0
    return _timeoutOld
 
_timeoutOld=reactor.timeout
reactor.timeout=_timeoutNew

Just using reactor.callLater, I could only get a speed of 90, in contrast to 
the asyncore integration which was doing better than 12,000.
 
By replacing runUntilCurrent and timeout, I managed to bump my speed up to better than 8,000, which seems reasonable, as Twisted is a bit 
more &quot;heavy weight&quot; than asyncore. ;-)
 
While I'm at it, here's my revised takedown code:

class whenNoDelayedCalls:
    &quot;I check for when there are no delayed calls.&quot;
    
    def __init__(self,granularity=1.0,func=reactor.stop):
        self.func=func
        self.granularity=granularity
        reactor.callLater(granularity,self)
    def __call__(self):
        c=len(reactor.getDelayedCalls())
        if c or reactor.poll:
            reactor.callLater(self.granularity,self)
        else:
            self.func()
 
def pollLoop(granularity=1.0,func=reactor.stop):
    &quot;I run the reactor until there are no more delayed calls.&quot;
    
    whenNoDelayedCalls(granularity,func)
    reactor.run()

This gives me an approximate equivalent to the asyncore poll loop,
at least when there's no threads or sockets running. ;-)
 


Bill la Forge
<A HREF="http://www.geocities.com/laforge49/">http://www.geocities.com/laforge49/</A>
Yahoo! India Matrimony: Find your partner online.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20040516/56a15f73/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="040297.html">[Twisted-Python] Learning Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="040292.html">[Twisted-Python] integrating CompStrm//adding background	processing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40291">[ date ]</a>
              <a href="thread.html#40291">[ thread ]</a>
              <a href="subject.html#40291">[ subject ]</a>
              <a href="author.html#40291">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
