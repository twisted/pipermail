<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Waiting for transports to close
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Waiting%20for%20transports%20to%20close&In-Reply-To=%3C5672B0E3.90306%40googlemail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030069.html">
   <LINK REL="Next"  HREF="030071.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Waiting for transports to close</H1>
    <B>Chris Norman</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Waiting%20for%20transports%20to%20close&In-Reply-To=%3C5672B0E3.90306%40googlemail.com%3E"
       TITLE="[Twisted-Python] Waiting for transports to close">chris.norman2 at googlemail.com
       </A><BR>
    <I>Thu Dec 17 05:56:03 MST 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="030069.html">[Twisted-Python] Waiting for transports to close
</A></li>
        <LI>Next message: <A HREF="030071.html">[Twisted-Python] Waiting for transports to close
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30070">[ date ]</a>
              <a href="thread.html#30070">[ thread ]</a>
              <a href="subject.html#30070">[ subject ]</a>
              <a href="author.html#30070">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
It's a MUD server, so players type in commands and receive textual 
responses.

One of the admin commands is the ability to shutdown the server (or 
CTRL-C might be pressed on the console). I'd like this action to notify 
all connected transports that the server is going down for shutdown, so 
they're not rudely disconnected, then once the notifications have all 
gone through, then the server is free to shutdown.

I hope all this makes sense.

Cheers,

On 12/17/2015 11:49 AM, Glyph Lefkowitz wrote:
&gt;<i>
</I>&gt;&gt;<i> On Dec 16, 2015, at 9:25 AM, Chris Norman 
</I>&gt;&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris.norman2 at googlemail.com</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris.norman2 at googlemail.com</A>&gt;&gt; 
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi all,
</I>&gt;&gt;<i> I'm writing a MUD server, and I want a way for transports to be 
</I>&gt;&gt;<i> notified ofa shutdown before being disconnected, and the reactor 
</I>&gt;&gt;<i> being stopped.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've tried:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> for t in transports:
</I>&gt;&gt;<i> t.write('Shutting down.\r\n')
</I>&gt;&gt;<i> t.loseConnection()
</I>&gt;&gt;<i> reactor.stop()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This doesn't seem to notify the transports.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I also tried:
</I>&gt;&gt;<i> for t in transports:
</I>&gt;&gt;<i> t.write('Shutting down.\r\n')
</I>&gt;&gt;<i> t.loseConnection()
</I>&gt;&gt;<i> while t.connected:
</I>&gt;&gt;<i>  pass
</I>&gt;&gt;<i> reactor.stop()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That just blocked and did nothing, presumably something do with my 
</I>&gt;&gt;<i> while loop.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there a stopWhenEmpty function on the somewhere? I did look over 
</I>&gt;&gt;<i> the methods, and I couldn't find anything promising.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm just using the standard from twisted.internet import reactor 
</I>&gt;&gt;<i> reactor, so no special cases here. In case it matters the transports 
</I>&gt;&gt;<i> I'm using are twisted.protocols.basic.LineReceiver, and everything 
</I>&gt;&gt;<i> else works with them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers in advance for the help.
</I>&gt;<i>
</I>&gt;<i> This is definitely doable, but before I explain it would help to know 
</I>&gt;<i> /why/ you want to do this.
</I>&gt;<i>
</I>&gt;<i> The reason I ask is: servers crash; hardware fails.  The falcon cannot 
</I>&gt;<i> hear the falconer; things fall apart; the centre cannot hold.
</I>&gt;<i>
</I>&gt;<i> When those servers /do/ crash (and they will), you don't get a clean 
</I>&gt;<i> notification of disconnects.  So if you're writing your application to 
</I>&gt;<i> rely very heavily on the ability to do a clean shutdown and get 
</I>&gt;<i> notifications of every disconnect at the time you expect 
</I>&gt;<i> reactor.stop() to be running, you are probably designing your system 
</I>&gt;<i> in a way that will be very fragile and prone to data loss.  I know, I 
</I>&gt;<i> have made this mistake more than once myself :).
</I>&gt;<i>
</I>&gt;<i> So, before you continue: do you actually need to do this?  Could you 
</I>&gt;<i> just ignore the notification of the connection drop and exit 
</I>&gt;<i> gracefully, perhaps properly cleaning up whatever state is left over 
</I>&gt;<i> at next startup?  If you really need this, understanding why you need 
</I>&gt;<i> it would also help in determining which implementation technique to 
</I>&gt;<i> suggest (there are a few).
</I>&gt;<i>
</I>&gt;<i> -glyph
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20151217/b1f56d32/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20151217/b1f56d32/attachment-0001.html</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030069.html">[Twisted-Python] Waiting for transports to close
</A></li>
	<LI>Next message: <A HREF="030071.html">[Twisted-Python] Waiting for transports to close
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30070">[ date ]</a>
              <a href="thread.html#30070">[ thread ]</a>
              <a href="subject.html#30070">[ subject ]</a>
              <a href="author.html#30070">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
