<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Waiting for transports to close
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Waiting%20for%20transports%20to%20close&In-Reply-To=%3C40B1D1CF-3B04-4351-8675-2E23854A87F9%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030061.html">
   <LINK REL="Next"  HREF="030070.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Waiting for transports to close</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Waiting%20for%20transports%20to%20close&In-Reply-To=%3C40B1D1CF-3B04-4351-8675-2E23854A87F9%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Waiting for transports to close">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Dec 17 04:49:55 MST 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="030061.html">[Twisted-Python] Waiting for transports to close
</A></li>
        <LI>Next message: <A HREF="030070.html">[Twisted-Python] Waiting for transports to close
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30069">[ date ]</a>
              <a href="thread.html#30069">[ thread ]</a>
              <a href="subject.html#30069">[ subject ]</a>
              <a href="author.html#30069">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Dec 16, 2015, at 9:25 AM, Chris Norman &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris.norman2 at googlemail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hi all,
</I>&gt;<i> I'm writing a MUD server, and I want a way for transports to be notified ofa shutdown before being disconnected, and the reactor being stopped.
</I>&gt;<i> 
</I>&gt;<i> I've tried:
</I>&gt;<i> 
</I>&gt;<i> for t in transports:
</I>&gt;<i> t.write('Shutting down.\r\n')
</I>&gt;<i> t.loseConnection()
</I>&gt;<i> reactor.stop()
</I>&gt;<i> 
</I>&gt;<i> This doesn't seem to notify the transports.
</I>&gt;<i> 
</I>&gt;<i> I also tried:
</I>&gt;<i> for t in transports:
</I>&gt;<i> t.write('Shutting down.\r\n')
</I>&gt;<i> t.loseConnection()
</I>&gt;<i> while t.connected:
</I>&gt;<i>  pass
</I>&gt;<i> reactor.stop()
</I>&gt;<i> 
</I>&gt;<i> That just blocked and did nothing, presumably something do with my while loop.
</I>&gt;<i> 
</I>&gt;<i> Is there a stopWhenEmpty function on the somewhere? I did look over the methods, and I couldn't find anything promising.
</I>&gt;<i> 
</I>&gt;<i> I'm just using the standard from twisted.internet import reactor reactor, so no special cases here. In case it matters the transports I'm using are twisted.protocols.basic.LineReceiver, and everything else works with them.
</I>&gt;<i> 
</I>&gt;<i> Cheers in advance for the help.
</I>
This is definitely doable, but before I explain it would help to know why you want to do this.

The reason I ask is: servers crash; hardware fails.  The falcon cannot hear the falconer; things fall apart; the centre cannot hold.

When those servers do crash (and they will), you don't get a clean notification of disconnects.  So if you're writing your application to rely very heavily on the ability to do a clean shutdown and get notifications of every disconnect at the time you expect reactor.stop() to be running, you are probably designing your system in a way that will be very fragile and prone to data loss.  I know, I have made this mistake more than once myself :).

So, before you continue: do you actually need to do this?  Could you just ignore the notification of the connection drop and exit gracefully, perhaps properly cleaning up whatever state is left over at next startup?  If you really need this, understanding why you need it would also help in determining which implementation technique to suggest (there are a few).

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20151217/89da4d80/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20151217/89da4d80/attachment.html</A>&gt;
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030061.html">[Twisted-Python] Waiting for transports to close
</A></li>
	<LI>Next message: <A HREF="030070.html">[Twisted-Python] Waiting for transports to close
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30069">[ date ]</a>
              <a href="thread.html#30069">[ thread ]</a>
              <a href="subject.html#30069">[ subject ]</a>
              <a href="author.html#30069">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
