<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] custom FTP server is blocking
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20custom%20FTP%20server%20is%20blocking&In-Reply-To=%3CCACgdh2gWoY8Vu%3DA4r5Q03s7-%2BHxEak6KD6en8tpy578QQ-GNsw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="061758.html">
   <LINK REL="Next"  HREF="029301.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] custom FTP server is blocking</H1>
    <B>Paul Wiseman</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20custom%20FTP%20server%20is%20blocking&In-Reply-To=%3CCACgdh2gWoY8Vu%3DA4r5Q03s7-%2BHxEak6KD6en8tpy578QQ-GNsw%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] custom FTP server is blocking">poalman at gmail.com
       </A><BR>
    <I>Fri Mar 20 06:47:12 MDT 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="061758.html">[Twisted-Python] custom FTP server is blocking
</A></li>
        <LI>Next message (by thread): <A HREF="029301.html">[Twisted-Python] Twisted 15.1 feedback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61759">[ date ]</a>
              <a href="thread.html#61759">[ thread ]</a>
              <a href="subject.html#61759">[ subject ]</a>
              <a href="author.html#61759">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20 March 2015 at 12:19, Adi Roiban &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A>&gt; wrote:
&gt;<i> On 20 March 2015 at 11:16, Paul Wiseman &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">poalman at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> On 19 March 2015 at 20:38, Louis D. Burr &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ldanielburr at me.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> Hi Paul,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On Mar 19, 2015, at 1:18 PM, Paul Wiseman &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">poalman at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> I want to stream the http request back to the client connected over
</I>&gt;&gt;<i> FTP. I guess I could do that with io.BytesIO right? I can't figure out
</I>&gt;&gt;<i> how to wire it up though. I've added agent.request which is firing
</I>&gt;&gt;<i> back a twisted.web.client.Response but I'm not sure how to stream the
</I>&gt;&gt;<i> data from that into the BytesIO object so that _FileReader has a file
</I>&gt;&gt;<i> like interface to read from.
</I>&gt;<i>
</I>&gt;<i> Without an example code use on your side I find it hard to help here.
</I>&gt;<i> Do you have an <A HREF="http://sscce.org/">http://sscce.org/</A> for your problem?
</I>&gt;<i>
</I>&gt;<i> Most probably you will need to implemented your own FileReader which
</I>&gt;<i> will hook into the response.deliverBody with a protocol which will
</I>&gt;<i> forward the data from dataReceived to your FTP data connection...all
</I>&gt;<i> this using a consumer/producer API.
</I>&gt;<i>
</I>
I just wrote an example that shows what I'm trying to do, it runs an
anonymous ftp server on 2121 of the local file system and any file you
try to download show should stream the body of <A HREF="http://www.yahoo.com">http://www.yahoo.com</A>
instead of the file contents.

There's a couple of reasons I think this doesn't work, I think I need
to return the _FileReader right away so it can begin streaming, but I
don't know how to make it wait for the deferred which is created in
the streamBody function, as this will file once the streaming is
complete.

I also think another problem is that as the stream is written the file
pointer on the BytesIO object will be at the end of the file, so I
guess the reader would need to seek to the right place, then tell to
the end afterwards so the writer continues to stream properly?

I'm not sure how to hook this up!

import io
from twisted.python import log
from twisted.internet import reactor
from twisted.internet.defer import Deferred
from twisted.internet.protocol import Protocol
from twisted.web.client import Agent, ContentDecoderAgent, GzipDecoder
from twisted.protocols.ftp import FTPFactory, FTPRealm,
FTPAnonymousShell, _FileReader
from twisted.cred.portal import Portal
from twisted.cred.checkers import AllowAnonymousAccess, FilePasswordDB
from twisted.internet import defer

agent = ContentDecoderAgent(Agent(reactor), [('gzip', GzipDecoder)])

class StreamWriter(Protocol):
    def __init__(self, finished, stream):
        self.finished = finished
        self.stream = stream

    def dataReceived(self, bytes):
        self.stream.write(bytes)

    def connectionLost(self, reason):
        print 'Finished receiving body:', reason.type, reason.value
        self.finished.callback(None)


def streamBody(response, stream):
    finished = Deferred()
    response.deliverBody(StreamWriter(finished, stream))
    return finished

def openForReading(self, path):
    d = agent.request(&quot;GET&quot;, &quot;<A HREF="http://www.yahoo.com">http://www.yahoo.com</A>&quot;)

    stream = io.BytesIO()
    d.addCallback(lambda resp: streamBody(resp, stream))
    d.addErrback(log.err)

    return defer.succeed(_FileReader(stream))

def main():

    FTPAnonymousShell.openForReading = openForReading

    p = Portal(FTPRealm('./'),
           [AllowAnonymousAccess(), FilePasswordDB(&quot;pass.dat&quot;)])

    f = FTPFactory(p)

    reactor.listenTCP(2121, f)
    reactor.run()

if __name__ == &quot;__main__&quot;:
    main()


&gt;<i> Cheers
</I>&gt;<i> --
</I>&gt;<i> Adi Roiban
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="061758.html">[Twisted-Python] custom FTP server is blocking
</A></li>
	<LI>Next message (by thread): <A HREF="029301.html">[Twisted-Python] Twisted 15.1 feedback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61759">[ date ]</a>
              <a href="thread.html#61759">[ thread ]</a>
              <a href="subject.html#61759">[ subject ]</a>
              <a href="author.html#61759">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
