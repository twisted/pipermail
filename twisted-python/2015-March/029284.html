<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] 100-continue and rejecting connection after	headers are received
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20100-continue%20and%20rejecting%20connection%20after%0A%09headers%20are%20received&In-Reply-To=%3CCAFycZ9cT9BUvPg8o72iVUQE%2BGO_Svx7my5TXKyr%2BDcBpBG9WiQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="061743.html">
   <LINK REL="Next"  HREF="029285.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] 100-continue and rejecting connection after	headers are received</H1>
    <B>Adi Roiban</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20100-continue%20and%20rejecting%20connection%20after%0A%09headers%20are%20received&In-Reply-To=%3CCAFycZ9cT9BUvPg8o72iVUQE%2BGO_Svx7my5TXKyr%2BDcBpBG9WiQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] 100-continue and rejecting connection after	headers are received">adi at roiban.ro
       </A><BR>
    <I>Thu Mar 19 10:30:02 MDT 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="061743.html">[Twisted-Python] Pausing the transport in	http.HTTPChannel.lineReceived after all headers are received
</A></li>
        <LI>Next message (by thread): <A HREF="029285.html">[Twisted-Python] custom FTP server is blocking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29284">[ date ]</a>
              <a href="thread.html#29284">[ thread ]</a>
              <a href="subject.html#29284">[ subject ]</a>
              <a href="author.html#29284">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am moving this to a dedicated ticket

I start working on 100-Continue here
<A HREF="https://twistedmatrix.com/trac/ticket/6928">https://twistedmatrix.com/trac/ticket/6928</A> and was asked to follow up
on the mailinglist ... which due to slow review progress I gave up..
so I am doing it now.


On 19 March 2015 at 15:53, HawkOwl &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">hawkowl at atleastfornow.net</A>&gt; wrote:
&gt;<i>
</I>&gt;&gt;<i> On 19 Mar 2015, at 23:26, Adi Roiban &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My usecase is this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When all headers of an HTTP request are received I want to ask a
</I>&gt;&gt;<i> remote service if the
</I>&gt;&gt;<i> request should be accepted and what to do with it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Before I got the response for the remote service, I don't want to
</I>&gt;&gt;<i> receive/read HTTP data.
</I>&gt;&gt;<i> The response is returned via an deferred.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The HTTP data might be a 10G file which might be rejected.. for
</I>&gt;&gt;<i> example due to quota limits.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is a gist with a short example and my quick and dirty fix:
</I>&gt;&gt;<i> <A HREF="https://gist.github.com/adiroiban/621efeab47662a04cb20">https://gist.github.com/adiroiban/621efeab47662a04cb20</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do you think this is a valid use case and that  someone would be
</I>&gt;&gt;<i> willing to review a patch to add such a feature?
</I>&gt;<i>
</I>&gt;<i> Ah yes, the 100-Continue stuff! I mentioned it briefly in my talk at PyCon AU.
</I>&gt;<i>
</I>&gt;<i> It would be a useful feature, and I looked into it a little bit, but I'm not entirely sure how it would be accessible to user code. Most web server frameworks (Django, Klein, Flask, et al) work on a &quot;here's a full request, send a full response&quot; (only Twisted/Klein can do more than send a whole response without hacks :) ) and fitting it into that sort of framework would be a bit confusing.
</I>&gt;<i>
</I>&gt;<i> So, my question is, because this functionality is desirable, how would it be exposed to the user? Maybe if it did traversal prior to the whole request being completed, and called something like headers_POST() or headers_GET() similar to render_GET/POST/etc, which would give the user access to these headers. A Deferred firing with True unblocks the producer, a Deferred firing with False kills off the request.
</I>
I already have 100-continue in production ... and I also have a code
which rejects a request after headers were received even if
100-continue was not used.

When all headers are received I am traversing the url and inform the
resource about the headers... before content is received.

I have a special resource which has a new headersReceived method. This
method should return http._CONTINUE as otherwise the request is
rejected.

This only work for resource traversals which don't depend on the request body.
Exarkun made an excellent comment here
<A HREF="https://twistedmatrix.com/trac/ticket/6928#comment:5">https://twistedmatrix.com/trac/ticket/6928#comment:5</A>

The new resource interface is simple.

Here is a dump from my current code
<A HREF="https://gist.github.com/adiroiban/1a515a9354a8168a0275">https://gist.github.com/adiroiban/1a515a9354a8168a0275</A>

Here is a diff on Twisted
<A HREF="https://github.com/twisted/twisted/compare/trunk...chevah:6928-http-100-accept">https://github.com/twisted/twisted/compare/trunk...chevah:6928-http-100-accept</A>

Please review the interface and let me know if it make sense to you.
I am happy to continue working on this as long as others are
interested in reviewing the patch.

Thanks!

-- 
Adi Roiban

</PRE>























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="061743.html">[Twisted-Python] Pausing the transport in	http.HTTPChannel.lineReceived after all headers are received
</A></li>
	<LI>Next message (by thread): <A HREF="029285.html">[Twisted-Python] custom FTP server is blocking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#29284">[ date ]</a>
              <a href="thread.html#29284">[ thread ]</a>
              <a href="subject.html#29284">[ subject ]</a>
              <a href="author.html#29284">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
