<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] flushing data to clients after a global variable	is updated in server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20flushing%20data%20to%20clients%20after%20a%20global%20variable%0A%09is%20updated%20in%20server&In-Reply-To=%3CCALgu0tjOhhMVFzAHfP%2Bzw6EMsY2-HcwpZvZEoLkzym623kwk-g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] flushing data to clients after a global variable	is updated in server</H1>
    <B>Jessica Tsui</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20flushing%20data%20to%20clients%20after%20a%20global%20variable%0A%09is%20updated%20in%20server&In-Reply-To=%3CCALgu0tjOhhMVFzAHfP%2Bzw6EMsY2-HcwpZvZEoLkzym623kwk-g%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] flushing data to clients after a global variable	is updated in server">jesadjust at gmail.com
       </A><BR>
    <I>Wed Apr 29 01:33:57 MDT 2015</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61901">[ date ]</a>
              <a href="thread.html#61901">[ thread ]</a>
              <a href="subject.html#61901">[ subject ]</a>
              <a href="author.html#61901">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, it's me again. I am still working on the kivy app, and now I am trying
to add a function to the app - the server side has two seconds to decide if
he wants to alter the original data sent from one client to other clients.
If he would like to do so, he has to press a button. If he does not press
the button in 2 seconds, the original data will be sent to other clients
automatically.

Right now I am trying to achieve that with the following code - by calling
the MultiClientEcho().dataReceived(msg, &quot;censored&quot;) line in the function as
if MultiClientEcho received another data, however once i click the button,
the program crashed and said (MultiClientEcho().dataReceived(msg,
&quot;censored&quot;)
 TypeError: __init__() takes exactly 3 arguments (1 given))

I wonder how can I fix this and achieve the function I am aiming at?

import kivy
from kivy.app import App
from kivy.uix.label import Label
from kivy.uix.scatter import Scatter
from kivy.uix.boxlayout import BoxLayout
from kivy.uix.scrollview import ScrollView
from kivy.uix.button import Button
from kivy.graphics.vertex_instructions import Rectangle
from kivy.graphics.context_instructions import Color
from kivy.graphics.instructions import Instruction
from kivy.base import runTouchApp
from kivy.lang import Builder
import socket
from kivy.core.window import Window
import pygame
import random
from kivy.support import install_twisted_reactor
install_twisted_reactor()
from twisted.internet import protocol, defer
from time import sleep
from twisted.internet import reactor, task
from twisted.protocols.basic import LineReceiver
from twisted.internet.protocol import Protocol, Factory

censored = 0

class MultiClientEcho(protocol.Protocol):
    def __init__(self, factory, app):
        self.factory = factory
        self.app = app

    def connectionMade(self):
        self.factory.clients.append(self)

    def dataReceived(self, data):

        storedmessage = self.factory.app.handle_message(data)

        global censored

        def f(data):
                for client in self.factory.clients:
                    client.transport.write(data)
                    print &quot;this will run in 1 sec after it's
scheduled: %s&quot; % data

        if censored == 0 and storedmessage:
                reactor.callLater(2, f, data)
                # client.transport.write(data)
        elif censored == 1:
                reactor.callLater(0, f, 'censored')
                censored == 0


    def connectionLost(self, reason):
        self.factory.clients.remove(self)


class MultiClientEchoFactory(protocol.Factory):
    protocol = MultiClientEcho

    def __init__(self, app):
        self.clients = []
        self.app = app

    def buildProtocol(self, addr):
        return MultiClientEcho(self, self.app)


class ServerApp(App):
    def build(self):
        self.label = Label(text=&quot;server started\n&quot;)


        self.approve_btn = Button(text=&quot;approve&quot;)
        # self.approve_btn.bind(on_release=self.send_message)
        self.banned_btn = Button(text=&quot;banned&quot;)
        self.banned_btn.bind(on_release=self.banned_message)
        self.layout = BoxLayout(orientation='vertical', spacing=10)

        reactor.listenTCP(8000, MultiClientEchoFactory(self))

        self.layout.add_widget(self.label)
        self.layout.add_widget(self.banned_btn)

        return self.layout

    def banned_message(self, msg):
        global censored
        censored = 1
        self.label.text += &quot;censored\n&quot;
        MultiClientEcho().dataReceived(msg, &quot;censored&quot;)
        print censored
        return censored

    def handle_message(self, msg):
        self.label.text += &quot;%s\n&quot; % msg
        return msg


if __name__ == '__main__':
    ServerApp().run()

for i in range(0,1):
    print 1-i
    sleep(0.1)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20150429/f8f7b0e4/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61901">[ date ]</a>
              <a href="thread.html#61901">[ thread ]</a>
              <a href="subject.html#61901">[ subject ]</a>
              <a href="author.html#61901">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
