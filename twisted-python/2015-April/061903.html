<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] flushing data to clients after a global	variable is updated in server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20flushing%20data%20to%20clients%20after%20a%20global%0A%09variable%20is%20updated%20in%20server&In-Reply-To=%3C34899C77-074B-487C-B376-ECE8796C129A%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="029440.html">
   <LINK REL="Next"  HREF="061904.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] flushing data to clients after a global	variable is updated in server</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20flushing%20data%20to%20clients%20after%20a%20global%0A%09variable%20is%20updated%20in%20server&In-Reply-To=%3C34899C77-074B-487C-B376-ECE8796C129A%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] flushing data to clients after a global	variable is updated in server">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Apr 30 13:39:07 MDT 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="029440.html">[Twisted-Python] flushing data to clients after a global variable	is updated in server
</A></li>
        <LI>Next message (by thread): <A HREF="061904.html">[Twisted-Python] flushing data to clients after a global variable is updated in server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61903">[ date ]</a>
              <a href="thread.html#61903">[ thread ]</a>
              <a href="subject.html#61903">[ subject ]</a>
              <a href="author.html#61903">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Apr 29, 2015, at 12:33 AM, Jessica Tsui &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jesadjust at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hi, it's me again. I am still working on the kivy app, and now I am trying to add a function to the app - the server side has two seconds to decide if he wants to alter the original data sent from one client to other clients. If he would like to do so, he has to press a button. If he does not press the button in 2 seconds, the original data will be sent to other clients automatically.
</I>&gt;<i> 
</I>&gt;<i> Right now I am trying to achieve that with the following code - by calling the MultiClientEcho().dataReceived(msg, &quot;censored&quot;) line in the function as if MultiClientEcho received another data, however once i click the button, the program crashed and said (MultiClientEcho().dataReceived(msg, &quot;censored&quot;)
</I>&gt;<i>  TypeError: __init__() takes exactly 3 arguments (1 given))
</I>
The first problem here is that &quot;MultiEchoClient()&quot; means &quot;create a new MultiEchoClient&quot;.  Since MultiEchoClient.__init__ takes &quot;factory&quot; and &quot;app&quot; parameters, you tried to create it with 1 parameter (just &quot;self&quot;, which is passed implicitly) instead of the required 3 (self, factory, app).

The second problem, once you've addressed that, is that you almost certainly don't want to create a new MultiEchoClient :).  It's not clear to me which MultiEchoClient you are trying to send this message to.

The third problem is that you should never call dataReceived yourself.  dataReceived is a method invoked by Twisted to tell your protocol that data has arrived.

The fourth problem is that you're treating dataReceived as delivering a discrete message.  It doesn't; it delivers a segment of some data in the stream coming from a client.  This is our most popular FAQ; basically, you need to use a NetstringReceiver or something to ensure you're getting complete messages in dataReceived: <A HREF="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions#Whyisprotocol.dataReceivedcalledwithonlypartofthedataIcalledtransport.writewith">https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions#Whyisprotocol.dataReceivedcalledwithonlypartofthedataIcalledtransport.writewith</A> &lt;<A HREF="https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions#Whyisprotocol.dataReceivedcalledwithonlypartofthedataIcalledtransport.writewith">https://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions#Whyisprotocol.dataReceivedcalledwithonlypartofthedataIcalledtransport.writewith</A>&gt;

Hopefully once you've addressed all these it will work more like you want it to :).

&gt;<i> I wonder how can I fix this and achieve the function I am aiming at?
</I>
I've put other comments inline in the code below.
&gt;<i> import kivy
</I>&gt;<i> from kivy.app import App
</I>&gt;<i> from kivy.uix.label import Label
</I>&gt;<i> from kivy.uix.scatter import Scatter
</I>&gt;<i> from kivy.uix.boxlayout import BoxLayout
</I>&gt;<i> from kivy.uix.scrollview import ScrollView
</I>&gt;<i> from kivy.uix.button import Button
</I>&gt;<i> from kivy.graphics.vertex_instructions import Rectangle
</I>&gt;<i> from kivy.graphics.context_instructions import Color
</I>&gt;<i> from kivy.graphics.instructions import Instruction
</I>&gt;<i> from kivy.base import runTouchApp
</I>&gt;<i> from kivy.lang import Builder
</I>&gt;<i> import socket
</I>You don't actually use &quot;socket&quot; anywhere in this module so you don't need to import it :).
&gt;<i> from kivy.core.window import Window
</I>&gt;<i> import pygame
</I>&gt;<i> import random
</I>&gt;<i> from kivy.support import install_twisted_reactor
</I>&gt;<i> install_twisted_reactor()
</I>&gt;<i> from twisted.internet import protocol, defer
</I>&gt;<i> from time import sleep
</I>&gt;<i> from twisted.internet import reactor, task
</I>&gt;<i> from twisted.protocols.basic import LineReceiver
</I>&gt;<i> from twisted.internet.protocol import Protocol, Factory
</I>&gt;<i> 
</I>&gt;<i> censored = 0
</I>&gt;<i> 
</I>&gt;<i> class MultiClientEcho(protocol.Protocol):
</I>&gt;<i>     def __init__(self, factory, app):
</I>&gt;<i>         self.factory = factory
</I>&gt;<i>         self.app = app
</I>&gt;<i> 
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         self.factory.clients.append(self)
</I>&gt;<i> 
</I>&gt;<i>     def dataReceived(self, data):
</I>&gt;<i> 
</I>&gt;<i>         storedmessage = self.factory.app.handle_message(data)
</I>&gt;<i> 
</I>&gt;<i>         global censored
</I>&gt;<i> 
</I>Rather than making this a global variable, consider putting it (as with &quot;app&quot; and with &quot;clients&quot;) onto the factory, so you can instantiate multiple MultiClientEchoFactory instances in one process.
&gt;<i>         def f(data):
</I>&gt;<i>                 for client in self.factory.clients:
</I>This is a bit too much indentation - you should stick to 4 spaces per indent for stylistic reasons :).
&gt;<i>                     client.transport.write(data)
</I>&gt;<i>                     print &quot;this will run in 1 sec after it's scheduled: %s&quot; % data
</I>&gt;<i> 
</I>&gt;<i>         if censored == 0 and storedmessage:
</I>&gt;<i>                 reactor.callLater(2, f, data)
</I>You're not hanging on to the result of this callLater call, which means you are giving up any way of stopping this call from happening in the future.  If you want to allow the caller to cancel it, note that reactor.callLater returns an IDelayedCall, which has a &quot;cancel()&quot; method that stops it from happening if it hasn't happened yet.  See the API documentation here; <A HREF="https://twistedmatrix.com/documents/15.1.0/api/twisted.internet.interfaces.IReactorTime.callLater.html">https://twistedmatrix.com/documents/15.1.0/api/twisted.internet.interfaces.IReactorTime.callLater.html</A> &lt;<A HREF="https://twistedmatrix.com/documents/15.1.0/api/twisted.internet.interfaces.IReactorTime.callLater.html">https://twistedmatrix.com/documents/15.1.0/api/twisted.internet.interfaces.IReactorTime.callLater.html</A>&gt; 
&gt;<i>                 # client.transport.write(data)
</I>&gt;<i>         elif censored == 1:
</I>&gt;<i>                 reactor.callLater(0, f, 'censored')
</I>&gt;<i>                 censored == 0
</I>I think maybe you mean &quot;censored = 0&quot; here? &quot;censored == 0&quot; just means &quot;compare censored to 0&quot; which will create a True or False value but otherwise do nothing; in this context, it pretty much means &quot;do nothing&quot;.
&gt;<i> 
</I>&gt;<i>     def connectionLost(self, reason):
</I>&gt;<i>         self.factory.clients.remove(self)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> class MultiClientEchoFactory(protocol.Factory):
</I>&gt;<i>     protocol = MultiClientEcho
</I>&gt;<i> 
</I>&gt;<i>     def __init__(self, app):
</I>&gt;<i>         self.clients = []
</I>&gt;<i>         self.app = app
</I>&gt;<i> 
</I>&gt;<i>     def buildProtocol(self, addr):
</I>&gt;<i>         return MultiClientEcho(self, self.app)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> class ServerApp(App):
</I>&gt;<i>     def build(self):
</I>&gt;<i>         self.label = Label(text=&quot;server started\n&quot;)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>         self.approve_btn = Button(text=&quot;approve&quot;)
</I>&gt;<i>         # self.approve_btn.bind(on_release=self.send_message)
</I>&gt;<i>         self.banned_btn = Button(text=&quot;banned&quot;)
</I>&gt;<i>         self.banned_btn.bind(on_release=self.banned_message)
</I>&gt;<i>         self.layout = BoxLayout(orientation='vertical', spacing=10)
</I>&gt;<i> 
</I>&gt;<i>         reactor.listenTCP(8000, MultiClientEchoFactory(self))
</I>&gt;<i> 
</I>Rather than calling listenTCP directly, you should be using some kind of Endpoint here; TCP4ServerEndpoint if you just want to hard code port 8000, or serverFromString if you want to allow your user to customize it.  See this document: <A HREF="https://twistedmatrix.com/documents/15.1.0/core/howto/endpoints.html">https://twistedmatrix.com/documents/15.1.0/core/howto/endpoints.html</A> &lt;<A HREF="https://twistedmatrix.com/documents/15.1.0/core/howto/endpoints.html">https://twistedmatrix.com/documents/15.1.0/core/howto/endpoints.html</A>&gt;        self.layout.add_widget(self.label)
&gt;<i>         self.layout.add_widget(self.banned_btn)
</I>&gt;<i> 
</I>&gt;<i>         return self.layout
</I>&gt;<i> 
</I>&gt;<i>     def banned_message(self, msg):
</I>&gt;<i>         global censored
</I>&gt;<i>         censored = 1
</I>&gt;<i>         self.label.text += &quot;censored\n&quot;
</I>&gt;<i>         MultiClientEcho().dataReceived(msg, &quot;censored&quot;)
</I>&gt;<i>         print censored
</I>&gt;<i>         return censored
</I>&gt;<i> 
</I>&gt;<i>     def handle_message(self, msg):
</I>&gt;<i>         self.label.text += &quot;%s\n&quot; % msg
</I>&gt;<i>         return msg
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> if __name__ == '__main__':
</I>&gt;<i>     ServerApp().run()
</I>&gt;<i> 
</I>&gt;<i> for i in range(0,1):
</I>&gt;<i>     print 1-i
</I>&gt;<i>     sleep(0.1)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Thanks again for using Twisted!

-g

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20150430/dd617168/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="029440.html">[Twisted-Python] flushing data to clients after a global variable	is updated in server
</A></li>
	<LI>Next message (by thread): <A HREF="061904.html">[Twisted-Python] flushing data to clients after a global variable is updated in server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61903">[ date ]</a>
              <a href="thread.html#61903">[ thread ]</a>
              <a href="subject.html#61903">[ subject ]</a>
              <a href="author.html#61903">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
