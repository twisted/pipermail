<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Looking for some advice debugging issue with	transport.write calls
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20some%20advice%20debugging%20issue%20with%0A%09transport.write%20calls&In-Reply-To=%3CCACLJ_dEO2T8Y-dE%2B-Z2mcDZX_9uzpqBXg8aKhxNDK28TN4fkgQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Looking for some advice debugging issue with	transport.write calls</H1>
    <B>Brian Costlow</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20some%20advice%20debugging%20issue%20with%0A%09transport.write%20calls&In-Reply-To=%3CCACLJ_dEO2T8Y-dE%2B-Z2mcDZX_9uzpqBXg8aKhxNDK28TN4fkgQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Looking for some advice debugging issue with	transport.write calls">brian.costlow at gmail.com
       </A><BR>
    <I>Mon Apr 27 14:05:19 MDT 2015</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61873">[ date ]</a>
              <a href="thread.html#61873">[ thread ]</a>
              <a href="subject.html#61873">[ subject ]</a>
              <a href="author.html#61873">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Summary: I am having an issue writing data from an object based on
twisted's LineReceiver. Calling self.transport.write from the protocol,
some data makes it through, some does not. Using tcpdump, I am not seeing
the missing data cross the network interface.

Ubuntu LTS 14.04
Python 2.7.6
Twisted 15.0.0

The app recieves a bunch of messages from various upstream servers (not
mine) and either discardsâ€”or bends, folds, spindles and muilates and sends
the modified message to a downstream server. The message format is
text-based, proprietary and not mine.

The way it works:

1. The app puts messages, consisting of a tuple of two strings: an id and
the message data, on a queue. The queue is actually a deque on the factory.
2. There's one client protocol instance for sending, it holds a connection
to downstream server. The factory is a reconnecting one, but only if the
connection drops. (I'm not creating a new protocol instance/connection per
message)
3. There's a method on the protocol that checks for messages in the
factory's queue, and sends them, one at a time. It waits for a short ack
text message back from the receiving end, or times out (my app's timeout,
not a network stack one) before sending the next message, if any. Code for
the sending piece is below.
4. The downstream end (an app not under my control) is not getting all the
messages. If my timeout check runs, and there's not been a returned ack
message yet, invariably the sysadmins for the downstream system report they
never got that message.

def check_for_send(self):
    if not self.in_send_message:
        try:
            self.in_send_message = True
            msg = self.factory.queue.popleft()
            try:
                self.waiting_id = msg[0]
                log.msg(&quot;Sending Message: {0}&quot;.format(msg[0]))
                raw_msg = &quot;&quot;.join([self.MSG_START, msg[1], self.MSG_END,
self.delimiter])
                threads.deferToThread(self._dump_raw_message, msg[0],
raw_msg)
                self.transport.write(raw_msg)
                reactor.callLater(30, self.check_for_timeout, msg[0])
            except:
                log.msg(&quot;Error sending Message: {0}&quot;.format(msg[0]))
                log.err()
                self.factory.add_message(msg)
                self.waiting_id = &quot;&quot;
                self.in_send_message = False
        except IndexError:
            self.in_send_message = False
        finally:
            reactor.callLater(0, self.check_for_send)
    else:
        reactor.callLater(1, self.check_for_send)

Mostly looking for some advice on further debugging this, as whenever I've
called self.transport.write on a lineReceiver over tcp before, it &quot;just
worked.&quot;

Observations.

1. The event loop doesn't appear to be getting stuck. Messages that don't
arrive downstream are interleaved with those that do. And the other part of
the app that is receiving messages from upstream keeps right on trucking.

2. I am now writing copies of the messages to disk, that call is right
before the transport.write call, and all the &quot;missing&quot; messages do end up
on disk.

3. I also fire the callLater for the timeout function on each message. The
disk write and the callLater both happen for missing messages.

4. I ran tcpdump on the interface for about 30 minutes and matched up with
log statements. If I see my protocol timed out waiting for an ack message
in my app's log, I can't find the outgoing message on the interface.

5. I am not seeing any errors in my logs.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20150427/c84aa1e0/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61873">[ date ]</a>
              <a href="thread.html#61873">[ thread ]</a>
              <a href="subject.html#61873">[ subject ]</a>
              <a href="author.html#61873">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
