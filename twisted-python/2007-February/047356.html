<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Removing cruft from logs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Removing%20cruft%20from%20logs&In-Reply-To=%3C45CF9570.2040101%40norsk-esport.no%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="047350.html">
   <LINK REL="Next"  HREF="047352.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Removing cruft from logs</H1>
    <B>&quot;Einar S. Ids√∏&quot;</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Removing%20cruft%20from%20logs&In-Reply-To=%3C45CF9570.2040101%40norsk-esport.no%3E"
       TITLE="[Twisted-Python] Removing cruft from logs">einar.twisted at norsk-esport.no
       </A><BR>
    <I>Sun Feb 11 15:15:12 MST 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="047350.html">[Twisted-Python] Removing cruft from logs
</A></li>
        <LI>Next message (by thread): <A HREF="047352.html">[Twisted-Python] general documentation question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47356">[ date ]</a>
              <a href="thread.html#47356">[ thread ]</a>
              <a href="subject.html#47356">[ subject ]</a>
              <a href="author.html#47356">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Eric Mangold wrote:
&gt;<i> I take it you're using twistd? In that case, yes, twistd adds a log
</I>&gt;<i> observer when it starts. There also isn't any supported way of getting
</I>&gt;<i> access to it. This and other issues are an unfortunate component of the
</I>&gt;<i> present Twisted reality :)
</I>&gt;<i> 
</I>&gt;<i> Here's a hack:
</I>&gt;<i> 
</I>&gt;<i> from twisted.python import log
</I>&gt;<i> log.removeObserver(log.theLogPublisher.observers[0])
</I>&gt;<i> 
</I>&gt;<i> Then your custom observer should be the only one left.
</I>&gt;<i> 
</I>&gt;<i> Hope that helps,
</I>&gt;<i> --Eric Mangold
</I>&gt;<i> Twisted/Win32 Co-Maintainer
</I>
Thank you for your answer! It's too bad that it isn't possible to
manipulate the default logger when using twistd.

I tried your hack, but even though it stops the twistd.log from spewing
cruft, I am unable to remove it from my own log. If I simply return from
emit(), nothing is printed, as expected. But if I don't return but
instead call log.fileObserver.emit(self, logEntryDict), both the line I
wish to log and the line I wish to get rid of are printed. It seems as
if both lines are printed as the result of one call to emit(). How can I
prevent the second from being printed?

Below is a simple working example.

Cheers,
Einar

******* Server ********

from twisted.application import internet, service, strports
from twisted.web import server, xmlrpc
from twisted.internet import protocol as tiprotocol, reactor, task
from twisted.python import log, logfile
import sys

class ErrorLog(log.FileLogObserver):
   def emit(self, logEntryDict):
      # We can take a look at the message we are asked to log
      # sys.stdout.write(&quot;MSG: ----&gt;%s&lt;----&quot; %logEntryDict['message'])
      # Alternatively just return to have no lines logged
      # return
      log.FileLogObserver.emit(self, logEntryDict)

class ErrorLogService(service.Service):
   def __init__(self, logName, logDir):
      self.logName = logName
      self.logDir = logDir
      self.maxLogSize = 1000000

   def startService(self):
      self.logFile = logfile.LogFile(
         self.logName, self.logDir, rotateLength = self.maxLogSize)
      #self.logFile.rotate()


      self.log = ErrorLog(self.logFile)
      self.log.start()

   def stopService(self):
      self.log.stop()
      self.logFile.close()
      del(self.logFile)

class XmlRpcServer(xmlrpc.XMLRPC):
   def xmlrpc_test(self, data):
      log.msg(&quot;Received: %s&quot; %data)
      return 2*data;

xmlServer = XmlRpcServer()
application = service.Application('MyApp')
serviceCollection = service.IServiceCollection(application)
xmlSite = server.Site(xmlServer)
xmlServer = strports.service(&quot;35550&quot;, xmlSite)

errorLogServer = ErrorLogService('myapp.err.log', './')

xmlServer.setServiceParent(application)
errorLogServer.setServiceParent(application)



****** Simple test ******
&gt;&gt;&gt;<i> import xmlrpclib
</I>&gt;&gt;&gt;<i> s=xmlrpclib.Server('<A HREF="http://localhost:35550">http://localhost:35550</A>')
</I>&gt;&gt;&gt;<i> s.test(1)
</I>2

***** Results *******
The following two lines should be logged to myapp.err.log. I need to get
rid of the second:

2007/02/11 23:12 CET [HTTPChannel,1,127.0.0.1] Received: 1
2007/02/11 23:12 CET [HTTPChannel,1,127.0.0.1] 127.0.0.1 - -
[11/Feb/2007:22:12:19 +0000] &quot;POST /RPC2 HTTP/1.0&quot; 200 121 &quot;-&quot;
&quot;xmlrpclib.py/1.0.1 (by www.pythonware.com)



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="047350.html">[Twisted-Python] Removing cruft from logs
</A></li>
	<LI>Next message (by thread): <A HREF="047352.html">[Twisted-Python] general documentation question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47356">[ date ]</a>
              <a href="thread.html#47356">[ thread ]</a>
              <a href="subject.html#47356">[ subject ]</a>
              <a href="author.html#47356">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
