<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Broker leak in spread server on login failure =	denial of service?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Broker%20leak%20in%20spread%20server%20on%20login%20failure%20%3D%0A%09denial%20of%20service%3F&In-Reply-To=BB9C0D9A-37BA-4E0F-AD78-2DAF967CB765%40verscend.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011373.html">
   <LINK REL="Next"  HREF="011376.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Broker leak in spread server on login failure =	denial of service?</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Broker%20leak%20in%20spread%20server%20on%20login%20failure%20%3D%0A%09denial%20of%20service%3F&In-Reply-To=BB9C0D9A-37BA-4E0F-AD78-2DAF967CB765%40verscend.com"
       TITLE="[Twisted-Python] Broker leak in spread server on login failure =	denial of service?">exarkun at divmod.com
       </A><BR>
    <I>Fri Sep  9 18:01:12 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="011373.html">[Twisted-Python] Broker leak in spread server on login failure =	denial of service?
</A></li>
        <LI>Next message: <A HREF="011376.html">[Twisted-Python] Broker leak in spread server on login failure =	denial of service?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11374">[ date ]</a>
              <a href="thread.html#11374">[ thread ]</a>
              <a href="subject.html#11374">[ subject ]</a>
              <a href="author.html#11374">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 9 Sep 2005 16:31:28 -0500, &quot;David K. Hess&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dhess at verscend.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i>I believe I've discovered a broker leak when a checker denies a login  and 
</I>&gt;<i>that it can be used to launch a denial of service attack on a  spread 
</I>&gt;<i>server.
</I>&gt;<i>
</I>&gt;<i>When a checker throws a Failure exception, since requestAvatar in the  realm 
</I>&gt;<i>doesn't get called, the realm (or anything else) doesn't end up  with a 
</I>&gt;<i>reference it can use to disconnect the network connection that  was denied 
</I>&gt;<i>login.
</I>&gt;<i>
</I>&gt;<i>If a malicious (or just buggy as was my case) client tries to login  over 
</I>&gt;<i>and over again and doesn't shutdown each connection from the  client side, 
</I>&gt;<i>the server will continue to leak brokers until (under  Windows) the select() 
</I>&gt;<i>call begins to fail because there are greater  than 512 (with a stock Python 
</I>&gt;<i>build) file descriptors open and being  monitored by the reactor. At this 
</I>&gt;<i>point, your server is dead as the  reactor goes into an infinite loop 
</I>&gt;<i>retrying failing select() calls  when this happens.
</I>
It's easier than this.  A client could connect and send no bytes at all.  The socket would remain open forever with the default factory behavior, allowing a user to exhaust all available file descriptors.

This is an attack possible on any server that doesn't limit new connections or time out existing ones somehow.

&gt;<i>
</I>&gt;<i>What I think might be best is if another method in the realm (say 
</I>&gt;<i>&quot;loginFailed(self, mind)&quot;) was called with the remote reference so  the 
</I>&gt;<i>server could then call mind.broker.transport.loseConnection() on  it. It 
</I>&gt;<i>would be nice too if this was after the Failure had been sent  back across 
</I>&gt;<i>the connection and not before.
</I>&gt;<i>
</I>&gt;<i>clientConnectionMade in PBServerFactory also looks promising but it  doesn't 
</I>&gt;<i>seem possible to figure out which connection is  authenticating from within 
</I>&gt;<i>the checker.
</I>&gt;<i>
</I>&gt;<i>Can anybody offer some advice on how best to handle this?
</I>
Rather than extending the cred interface, which may not even be invoked, I'd start by altering the behavior of the server factory.  Either impose a per-IP connection limit, or a connection rate limit, or a timeout for idle connections, or something along these lines.  You might want to look at twisted.protocols.policies.LimitTotalConnectionsFactory or TimeoutFactory.

Hope this helps,

Jp


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011373.html">[Twisted-Python] Broker leak in spread server on login failure =	denial of service?
</A></li>
	<LI>Next message: <A HREF="011376.html">[Twisted-Python] Broker leak in spread server on login failure =	denial of service?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11374">[ date ]</a>
              <a href="thread.html#11374">[ thread ]</a>
              <a href="subject.html#11374">[ subject ]</a>
              <a href="author.html#11374">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
