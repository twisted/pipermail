<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted.web signal handling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted.web%20signal%20handling&In-Reply-To=cc4a20de05092405435742ca9e%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011487.html">
   <LINK REL="Next"  HREF="011498.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted.web signal handling</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted.web%20signal%20handling&In-Reply-To=cc4a20de05092405435742ca9e%40mail.gmail.com"
       TITLE="[Twisted-Python] Twisted.web signal handling">exarkun at divmod.com
       </A><BR>
    <I>Sat Sep 24 11:25:04 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="011487.html">[Twisted-Python] Twisted.web signal handling
</A></li>
        <LI>Next message: <A HREF="011498.html">[Twisted-Python] Twisted.web signal handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11488">[ date ]</a>
              <a href="thread.html#11488">[ thread ]</a>
              <a href="subject.html#11488">[ subject ]</a>
              <a href="author.html#11488">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sat, 24 Sep 2005 14:43:09 +0200, Krzysztof Nowak &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">pegazik at gmail.com</A>&gt; wrote:
&gt;<i>Hello. I wrote a simple application using twisted.web. One of activity
</I>&gt;<i>of my program is to contacting with some other processes. I need some
</I>&gt;<i>timeout to perform this activity. The structure of my program looks
</I>&gt;<i>like this:
</I>
Timeouts should be managed using twisted.internet.reactor.callLater().

&gt;<i>
</I>&gt;<i>/////////////////////////////////////////////////////////////////////////////////////
</I>&gt;<i>def TimeoutHandler(pid):
</I>&gt;<i>    os.kill(pid, signal.SIGUSR1)
</I>
twistd uses SIGUSR1 for logfile rotation.  Your handler is probably getting clobbered.

&gt;<i>
</I>&gt;<i>def handler():
</I>&gt;<i>    raise ConnectionError
</I>&gt;<i>
</I>&gt;<i>signal.signal(signal.SIGUSR1, handler)
</I>&gt;<i>MyPID = os.getpid()
</I>&gt;<i>
</I>
Depending on exactly where this code is run, this is probably the wrong PID.  twistd daemonizes, which involves forking and exiting in the parent.  If your code is imported before daemonization happens, the above will retrieve the PID of the parent, which will not be your PID at any time during the actual operation of your program.

&gt;<i>def HistosRendering:
</I>&gt;<i>        timer = threading.Timer(0.001, TimeoutHandler, [MyPID])
</I>&gt;<i>        timer.start()
</I>&gt;<i>        try:
</I>&gt;<i>            &lt;Some activity that need timeout&gt;
</I>&gt;<i>        except ConnectionError:
</I>&gt;<i>            &lt;In case of timeout&gt;
</I>&gt;<i>            return
</I>&gt;<i>        else:
</I>&gt;<i>            timer.cancel()
</I>
Why aren't you using Twisted to handle this connection attempt?  The threading.Timer/signal/raise combo is a very bad way to manage timeouts.  Twisted provides much better ways.

Also, there is a race condition between the end of your try suite and the timer.cancel() call.  The exception could be raised after the else suite is entered but before the timer is actually cancelled.

&gt;<i>
</I>&gt;<i>class Resource(resource.Resource):
</I>&gt;<i>    def render(self, request):
</I>&gt;<i>        HistosRender()
</I>
You are blocking the entire process for the during of the render() call.  This is another reason not to make whatever synchronous connection attempt you are making and instead use something Twisted provides.  No other activities can occur, process-wide, while your code is running.  If this is a multiuser application, *everyone* using it will experience periods of unresponsiveness when *anyone* causes blocking code to run.

&gt;<i>
</I>&gt;<i>resource = Resource()
</I>&gt;<i>/////////////////////////////////////////////////////////////////////////////////////
</I>&gt;<i>
</I>&gt;<i>Unfortunately, there is something wrong, cause in case of timeout I am
</I>&gt;<i>receiving error message, the TimeoutHandler is activated (in the Timer
</I>&gt;<i>thread), but handler() in the main thread is not activated.
</I>&gt;<i>I am using this kind of commands to start a server:
</I>&gt;&gt;<i> mktap web --path /www/ --port 8081
</I>&gt;&gt;<i> twistd -f web.tap
</I>&gt;<i>Maybe I should somehow &quot;turn on&quot; handling of signals?
</I>&gt;<i>
</I>&gt;<i>Do you see any solution?
</I>
The main thing to figure out is how to rewrite the operation which you wish to timeout so that it is asynchronous and easily cancellable.  Then all the signal related difficulties will disappear.

Jp


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011487.html">[Twisted-Python] Twisted.web signal handling
</A></li>
	<LI>Next message: <A HREF="011498.html">[Twisted-Python] Twisted.web signal handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11488">[ date ]</a>
              <a href="thread.html#11488">[ thread ]</a>
              <a href="subject.html#11488">[ subject ]</a>
              <a href="author.html#11488">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
