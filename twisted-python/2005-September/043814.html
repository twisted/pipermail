<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted UDP &amp; makeConnection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20UDP%20%26%20makeConnection&In-Reply-To=%3C200509031417.13952.jamessaker%40firepole.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043812.html">
   <LINK REL="Next"  HREF="043816.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted UDP &amp; makeConnection</H1>
    <B>James Saker</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20UDP%20%26%20makeConnection&In-Reply-To=%3C200509031417.13952.jamessaker%40firepole.com%3E"
       TITLE="[Twisted-Python] Twisted UDP &amp; makeConnection">jamessaker at firepole.com
       </A><BR>
    <I>Sat Sep  3 13:17:07 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043812.html">[Twisted-Python] Speaking of defgen
</A></li>
        <LI>Next message (by thread): <A HREF="043816.html">[Twisted-Python] Twisted UDP &amp; makeConnection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43814">[ date ]</a>
              <a href="thread.html#43814">[ thread ]</a>
              <a href="subject.html#43814">[ subject ]</a>
              <a href="author.html#43814">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Got a bit of a puzzle trying to make a minimal syslog relay out of twisted and 
am wondering if it's due to an incompatibility between ServerFactory and 
Twisted's UDP, or if I'm simply missing something obvious.

In trying to learn Twisted better, I've taken the finger13.py sample and have 
changed it to listen to the syslog UDP port and echo messages (code follows 
this message). One minor variation is that I want to only take UDP messages 
from hosts in my hostlist (granted UDP can be easily spoofed, but that's 
another matter).

I'm invoking finger13 with twistd, and end up with twistd complaining about 
the ServerFactory instance not having an attribute &quot;makeConnection.&quot;:

2005/09/03 14:06 CDT [-] AttributeError: ServerFactory instance has no 
attribute 'makeConnection'

 I've traced this message back to Twisted's udp.py (line 96, 
_connectToProtocol) which refers to self.protocol, and self.protocol is the 
protocol passed in when class Port is initialized (self.protocol = proto). 
I've tried putting makeConnection in the BSDSyslogProtocol class but that 
doesn't work; actually, I'm surprised it's complaining because the parent 
twisted DatagramProtocol class has a makeConnection method.

Perhaps factories need to be handled differently for UDP? I'm stumped!

Jamie


# syslogd13.py Based on finger13.py 
from twisted.application import internet, service
from twisted.internet import protocol, reactor, defer
from twisted.internet.protocol import DatagramProtocol
from twisted.protocols import basic

class BSDSyslogProtocol(DatagramProtocol):
    
    def datagramReceived(self, data, (host, port)):
        self.factory.getMessage(data
        ).addErrback(lambda _: &quot;Internal error in server&quot;
        ).addCallback(self.transport.loseConnection())
    def makeConnection(self): pass

class ValidHostSetterProtocol(basic.LineReceiver):
    def connectionMade(self): self.lines = []
    
    def lineReceived(self, line): 
        self.lines.append(line)
    def connectionLost(self, _connDropMsg):
        for line in self.lines:
            print &quot;Received the following.&quot; % line

class SyslogRelayService(service.Service):
    def __init__(self, *args, **kwargs):
        self.parent.__init__(self, *args)
        self.hosts = kwargs
    def getHost(self, host):
        return defer.succeed(self.hosts.get(host, &quot;No such host&quot;))
    def getHostFactory(self):
        h = protocol.ServerFactory()
        h.protocol, h.getHost = BSDSyslogProtocol, self.getHost
        return h

application = service.Application('syslog-relay', uid=1, gid=1)
slr = SyslogRelayService('syslog-relay', hosts='127.0.0.1')
serviceCollection = service.IServiceCollection(application)
internet.UDPServer(514, slr.getHostFactory()
                   ).setServiceParent(serviceCollection)

-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
URL: &lt;/pipermail/twisted-python/attachments/20050903/eb0fdc75/attachment.sig&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043812.html">[Twisted-Python] Speaking of defgen
</A></li>
	<LI>Next message (by thread): <A HREF="043816.html">[Twisted-Python] Twisted UDP &amp; makeConnection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43814">[ date ]</a>
              <a href="thread.html#43814">[ thread ]</a>
              <a href="subject.html#43814">[ subject ]</a>
              <a href="author.html#43814">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
