<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: ReconnectingClientFactory creates multiple	Protocols? (clarification)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20ReconnectingClientFactory%20creates%20multiple%0A%09Protocols%3F%20%28clarification%29&In-Reply-To=%3C20050920080712.3914.889614784.divmod.quotient.18783%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043979.html">
   <LINK REL="Next"  HREF="043981.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: ReconnectingClientFactory creates multiple	Protocols? (clarification)</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20ReconnectingClientFactory%20creates%20multiple%0A%09Protocols%3F%20%28clarification%29&In-Reply-To=%3C20050920080712.3914.889614784.divmod.quotient.18783%40ohm%3E"
       TITLE="[Twisted-Python] Re: ReconnectingClientFactory creates multiple	Protocols? (clarification)">exarkun at divmod.com
       </A><BR>
    <I>Tue Sep 20 02:07:12 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043979.html">[Twisted-Python] Re: ReconnectingClientFactory creates multiple	Protocols? (clarification)
</A></li>
        <LI>Next message (by thread): <A HREF="043981.html">[Twisted-Python] Resource instanciated and never destroyed ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43980">[ date ]</a>
              <a href="thread.html#43980">[ thread ]</a>
              <a href="subject.html#43980">[ subject ]</a>
              <a href="author.html#43980">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 20 Sep 2005 15:36:18 +0800, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mikah at ceruleansoftware.com</A> wrote:
&gt;<i>Itamar Shtull-Trauring &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A>&gt; wrote:
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mikah at ceruleansoftware.com</A> wrote:
</I>&gt;&gt;<i> &gt;   As far as I can tell, it's related to the connection being
</I>&gt;&gt;<i> &gt; dropped, at which point the Factory reconnects and creates a
</I>&gt;&gt;<i> &gt; new protocol instance.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Protocols (at least, when used with TCP) are designed so that their
</I>&gt;&gt;<i> lifetime matches that of the TCP connection they are handling. As a
</I>&gt;&gt;<i> result, when the connection is lost and the factory reconnects, this is
</I>&gt;&gt;<i> a new TCP connection with a new protocol. This is why there's a factory,
</I>&gt;&gt;<i> to manage data and logic that is not tied to a specific TCP connection
</I>&gt;&gt;<i> (e.g. &quot;should I reconnect?&quot; or &quot;how far along was the download when I
</I>&gt;&gt;<i> got disconnected.&quot;)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In general you'd want to use the factory to store state that needs to
</I>&gt;&gt;<i> last past the lifetime of the protocol. You can, of course, have
</I>&gt;&gt;<i> buildProtocol always return the same instance, but that's pretty ugly
</I>&gt;&gt;<i> and can easily lead to obscure bugs if you don't clean up the state
</I>&gt;&gt;<i> correctly.
</I>&gt;<i>
</I>&gt;<i>Itamar,
</I>&gt;<i>
</I>&gt;<i>  Thanks for the reply. I think I have to clarify though, I
</I>&gt;<i>wasn't very clear describing the situation -- my problem isn't
</I>&gt;<i>that the RCFactory creates protocols on the fly, it's that
</I>&gt;<i>after disconnecting/reconnecting, the old protocol instance
</I>&gt;<i>seems to be still active! After the server has run a few days,
</I>&gt;<i>I start seeing a handful of protocol instances. I know they
</I>&gt;<i>aren't the same protocol because I can tell them apart from the
</I>&gt;<i>data they write to the log file.
</I>&gt;<i>
</I>&gt;<i>  Only one of the protocols is actually connected to the remote
</I>&gt;<i>host, that much I can say. It's the 'newest' one (I hope). The
</I>&gt;<i>other instances are not connected but they attempt to send
</I>&gt;<i>requests anyway, and worse, continue to pull tasks out of the
</I>&gt;<i>task queue. So I end up with a bunch of tasks that never get
</I>&gt;<i>acted on because the protocols can't service them without a
</I>&gt;<i>connection.
</I>&gt;<i>
</I>&gt;<i>  My question is: when an RCFactory makes a new protocol
</I>&gt;<i>instance, is the old one supposed to be deleted and cleaned
</I>&gt;<i>up?
</I>&gt;<i>
</I>&gt;<i>  Everything hinges on this, pretty much. If the answer is yes,
</I>&gt;<i>then I'm doing something wrong because mine aren't getting
</I>&gt;<i>cleaned up. If the answer is no, then I must somehow take
</I>&gt;<i>responsibility for preventing the old instances from trying to
</I>&gt;<i>do work when they shouldn't, and somehow delete them.
</I>
To some minor extent, yes.  Completely and totally?  No.  For example, if you have a delayed call which invokes a method on the protocol instance, this will still occur.

&gt;<i>
</I>&gt;<i>  I have some related questions if someone would like to answer
</I>&gt;<i>them ... (1) is there a proper way for me to disconnect a
</I>&gt;<i>connected protocol and then stop its factory from reconnecting
</I>&gt;<i>and (2) start the factory connecting again at some time in the
</I>&gt;<i>future?
</I>&gt;<i>
</I>
When the connection is lost, &quot;connectionLost&quot; is called on the protocol and &quot;clientConnectionLost&quot; is called on the factory.  Use one or both of these hooks to clean up after your now defunct protocol.

Jp


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043979.html">[Twisted-Python] Re: ReconnectingClientFactory creates multiple	Protocols? (clarification)
</A></li>
	<LI>Next message (by thread): <A HREF="043981.html">[Twisted-Python] Resource instanciated and never destroyed ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43980">[ date ]</a>
              <a href="thread.html#43980">[ thread ]</a>
              <a href="subject.html#43980">[ subject ]</a>
              <a href="author.html#43980">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
