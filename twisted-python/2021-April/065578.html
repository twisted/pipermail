<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] GitHub Actions parallelism limit increase
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20GitHub%20Actions%20parallelism%20limit%20increase&In-Reply-To=%3CCAFycZ9f0xmzDYGEEingaTcsiFe22yJOUYoFL06h5i75exmNAcg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065577.html">
   <LINK REL="Next"  HREF="065582.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] GitHub Actions parallelism limit increase</H1>
    <B>Adi Roiban</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20GitHub%20Actions%20parallelism%20limit%20increase&In-Reply-To=%3CCAFycZ9f0xmzDYGEEingaTcsiFe22yJOUYoFL06h5i75exmNAcg%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] GitHub Actions parallelism limit increase">adi at roiban.ro
       </A><BR>
    <I>Thu Apr  1 07:36:29 MDT 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065577.html">[Twisted-Python] GitHub Actions parallelism limit increase
</A></li>
        <LI>Next message (by thread): <A HREF="065582.html">[Twisted-Python] GitHub Actions parallelism limit increase
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65578">[ date ]</a>
              <a href="thread.html#65578">[ thread ]</a>
              <a href="subject.html#65578">[ subject ]</a>
              <a href="author.html#65578">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 1 Apr 2021 at 13:46, Kyle Altendorf &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">sda at fstab.net</A>&gt; wrote:

&gt;<i> On 2021-03-31 05:45, Adi Roiban wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; On Tue, 30 Mar 2021, 22:23 Kyle Altendorf, &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">sda at fstab.net</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; On 2021-03-30 15:24, Glyph wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt; On Mar 30, 2021, at 7:57 AM, Kyle Altendorf &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">sda at fstab.net</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; Hi All,
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; Has anyone contacted GitHub to see if they would be willing to
</I>&gt;<i> &gt;&gt;&gt;&gt; increase the parallelism limit in Actions?  My understanding is that
</I>&gt;<i> &gt;&gt;&gt;&gt; we maintain two CI systems (GitHub Actions and Azure Pipelines) for
</I>&gt;<i> &gt;&gt;&gt;&gt; the sake of more parallelism.  While perhaps worthwhile, this
</I>&gt;<i> &gt;&gt;&gt;&gt; doesn't
</I>&gt;<i> &gt;&gt;&gt;&gt; seem fun.  Maybe GitHub would be willing to help out.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Not as far as I know. Do you want to give it a shot?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; That was the plan.  Submitted.  I'll let you all know.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On a related note I am working to reduce the general duration of
</I>&gt;<i> &gt; Twisted CI jobs.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This should result in keeping the jobs slot busy for less time and
</I>&gt;<i> &gt; allowing more total jobs per day.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The first step was to enable parallel trial tests. Use both CPUs
</I>&gt;<i> &gt; available to the CI VMs.
</I>&gt;<i> &gt; This was already done for Linux and MacOS.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Distributed trial is not yet supported on Windows, but I am working on
</I>&gt;<i> &gt; it.
</I>&gt;<i> &gt; I already have a working distributed trial for Windows on my system.
</I>&gt;<i> &gt; It needs various fixed and I have submitted smaller PR for review.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Just getting distrial to work on Windows is not all...as we need to
</I>&gt;<i> &gt; update and clean the  Twsited test to reduce the side effects.
</I>&gt;<i> &gt; Linux and macOS are more relaxed in terms of file access and for
</I>&gt;<i> &gt; example you can delete a file, even if its opened by another process or
</I>&gt;<i> &gt; by the same process.
</I>&gt;<i> &gt; Windows is not happy about that.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; And then there are the 2 pypy jobs taking 30 minutes each - working to
</I>&gt;<i> &gt; fix it here <A HREF="https://github.com/twisted/twisted/pull/1543/">https://github.com/twisted/twisted/pull/1543/</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; And then there are also general CI jobs improvements.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; For example we can save about 40 seconds  if we decide to stop sending
</I>&gt;<i> &gt; coverage to coveralls and only use codecov.io
</I>&gt;<i> &gt; Another example is save another 1 minute by stop using `tox --notests`
</I>&gt;<i> &gt; and replace it with something like
</I>&gt;<i> &gt; <A HREF="https://github.com/twisted/python-info-action">https://github.com/twisted/python-info-action</A> to show the dependencies.
</I>&gt;<i> &gt; With `tox --notest` we now create the wheels and install the
</I>&gt;<i> &gt; dependencies twice for each job.
</I>&gt;<i>
</I>&gt;<i> Would `tox --skip-pkg-install` cut it for the second invocation?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/ericaltendorf/plotman/pull/66/files#diff-b803fcb7f17ed9235f1e5cb1fcd2f5d3b2838429d4368ae4c57ce4436577f03fR145">https://github.com/ericaltendorf/plotman/pull/66/files#diff-b803fcb7f17ed9235f1e5cb1fcd2f5d3b2838429d4368ae4c57ce4436577f03fR145</A>
</I>&gt;<i>
</I>&gt;<i>
</I>I don't know. I still don't understand the tox install and test process...
and tox is not my friend as every week tox hits me with various errors that
I don't understand.
Most probably, tox is an advanced tool and I am a poor developer who
doesn't know much and sticks to the manual labour of calling venv + pip +
trial  :)

--------

For example, I don't understand why you need to create an sdist and from
sdist to create a wheel and then install that wheel inside tox for each tox
test environment.

Why not create the wheel once and install the same wheel in all
environments.


&gt;<i> &gt; There is an extra 1 minute required for each job to generate the
</I>&gt;<i> &gt; coverage XML file. We can download all the coverage artifacts and
</I>&gt;<i> &gt; generate the XML only once.
</I>&gt;<i>
</I>&gt;<i> I did coverage collection from all jobs for pymodbus.  Looks like I
</I>&gt;<i> still had the XML report generating in each job, but that could
</I>&gt;<i> presumably be shifted.  Anyways, I'm sure several of us could do this
</I>&gt;<i> off the top of our heads but in case it is of any interest here's what I
</I>&gt;<i> did.  Or maybe you just point out something silly I did there and should
</I>&gt;<i> learn from.  :]
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/riptideio/pymodbus/pull/592/files">https://github.com/riptideio/pymodbus/pull/592/files</A>
</I>&gt;<i>
</I>

That is one big matrix :) ... I don't understand why you need test and
check and coverage, each with a separate matrix.

I am thinking of something like this:

* A matrix to run jobs with coverage on each environment (os + py
combination + extra stuff noipv6, nodeps, etc)
* Each job from the matrix will run an initial combine to combine
sub-process coverage
* Each job will upload once python coverage raw file.
* A single job will  download those coverage file, combine them once again
to generate an XML file to be pushed to codecov.io

The maximum jobs time will continue to be the same...as you still need to
wait for the slowest env, but the total run time can be reduced by more
than 20 minutes
as each job will no longer have to spend 2 minutes creating XML and
reporting JSON to coveralls.

-----------

Note that coveralls API is different. Instead of receiving an XML file,
with coverall there are separate API calls for reporting the coverage in
JSON format.
This is why coveralls reporting takes so long
Also, for coveralls, the python uploader is a 3rd party tool, and not an
official tool from the Coveralls team.
So maybe the python coveralls uploader tool can be improved to send the
reports faster.

Cheers

-- 
Adi Roiban
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20210401/1f1f2584/attachment-0001.htm&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065577.html">[Twisted-Python] GitHub Actions parallelism limit increase
</A></li>
	<LI>Next message (by thread): <A HREF="065582.html">[Twisted-Python] GitHub Actions parallelism limit increase
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65578">[ date ]</a>
              <a href="thread.html#65578">[ thread ]</a>
              <a href="subject.html#65578">[ subject ]</a>
              <a href="author.html#65578">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
