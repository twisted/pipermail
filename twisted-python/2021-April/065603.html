<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] IDNA problem in twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IDNA%20problem%20in%20twisted&In-Reply-To=%3C8766856.CDJkKcVGEf%40fpbarry%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065595.html">
   <LINK REL="Next"  HREF="065584.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] IDNA problem in twisted</H1>
    <B>Barry Scott</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IDNA%20problem%20in%20twisted&In-Reply-To=%3C8766856.CDJkKcVGEf%40fpbarry%3E"
       TITLE="[Twisted-Python] IDNA problem in twisted">barry.scott at forcepoint.com
       </A><BR>
    <I>Thu Apr 29 03:22:21 MDT 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065595.html">[Twisted-Python] IDNA problem in twisted
</A></li>
        <LI>Next message (by thread): <A HREF="065584.html">[Twisted-Python] startTLS errors not propagating to Factory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65603">[ date ]</a>
              <a href="thread.html#65603">[ thread ]</a>
              <a href="subject.html#65603">[ subject ]</a>
              <a href="author.html#65603">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wednesday, 28 April 2021 06:52:30 BST Glyph wrote:
&gt;<i> 
</I>&gt;<i> &gt; On Apr 27, 2021, at 8:58 PM, Wim Lewis &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">wiml at hhhh.org</A>&gt; wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; On Thursday, April 8, 2021 8:43:35 AM PDT, Barry Scott wrote:
</I>&gt;<i> &gt;&gt; We just added a patch to our twisted to prevent twisted from doing idna validation.
</I>&gt;<i> &gt;&gt; _idnaBytes and _idnaText not convert from bytes to unicode based on the type of
</I>&gt;<i> &gt;&gt; the provided arg.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; We had to do this because there are domain names that youtube.com uses that are
</I>&gt;<i> &gt;&gt; not valid under IDNA-2008 <A HREF="https://tools.ietf.org/html/rfc5891#section-4.2.3.1">https://tools.ietf.org/html/rfc5891#section-4.2.3.1</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; My reading of the RFC is that the YouTube domain you mention (r2---sn-aigzrn7e.googlevideo.com) is an invalid &quot;U-Label&quot;, but that doesn't mean it's an entirely invaid domain label. It just means you can't legally run it through IDNA and turn it into &quot;xn--r2---sn-aigzrn7e-&quot;. The intent, as I understand it, is to forbid any possibility of double-encoding or double-decoding a label, not to forbid the possibility of using labels like the one you mention.
</I>&gt;<i> 
</I>&gt;<i> I agree with this reading.
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt; I can see why a UI would need to do IDNA-2008 converts and validation
</I>&gt;<i> &gt;&gt; but I'm not clear why its of value deep in the guts of twisted.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; My guess is that this is just an accident of the way that the bytes/characters distinction and the IDNA features were added to Twisted, and is probably a bug.
</I>&gt;<i> 
</I>&gt;<i> +1.
</I>&gt;<i> 
</I>&gt;<i> We also have other issues with the Python IDNA library: <A HREF="https://github.com/kjd/idna/issues/18">https://github.com/kjd/idna/issues/18</A> &lt;<A HREF="https://github.com/kjd/idna/issues/18">https://github.com/kjd/idna/issues/18</A>&gt; and would generally like to reduce our strictness via whatever mechanisms we can, even for things that genuinely require it (which this does not).
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt; Why is this code needed at all in twisted?
</I>&gt;<i> &gt;&gt; If its for a high level API then why isn't it being called at the
</I>&gt;<i> &gt;&gt; edge of the high level API calls?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'd argue that resolving URLs is in fact a high level API (from the point of view of the name resoution system) but even so, it seems to me that Twisted is doing the wrong thing here. The format of that label should prevent it from ever being transformed by IDNA, but shouldn't prevent it from being passed through unchanged, since it doesn't contain any codepoints outside of the usual ASCII range.
</I>&gt;<i> 
</I>&gt;<i> Also agreed with all of this.
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt; The key idea here is that its human input that will be converted.
</I>&gt;<i> &gt;&gt; But the code is used deep in the _sslverify.py where no human
</I>&gt;<i> &gt;&gt; input is entered.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; _sslverify has to check whether the information in the server's certificate matches the URL that the user supplied. Certificates can contain Unicode text — at least in the (completely obsolete) CN-as-domain-name situation — so _sslverify probably picked up the requirement for IDNA transformations from that. (I don't remember whether dNSName SANs can contain unicode.)
</I>&gt;<i> 
</I>&gt;<i> Yep.
</I>&gt;<i> 
</I>&gt;<i> &gt; What is the patch you decided to add to your version? Where in _sslverify did the problem surface?
</I>
When _idaBytes was called to raise an exception in ClientTLSOptions.__init__.

&gt;<i> I am also very curious about this :).
</I>
Attached is the patch we are using. We are using 19.07 for sad reasons.

Barry
-------------- next part --------------
A non-text attachment was scrubbed...
Name: twisted-remove-idna-checks.patch
Type: text/x-patch
Size: 1093 bytes
Desc: not available
URL: &lt;/pipermail/twisted-python/attachments/20210429/bf8701cc/attachment.bin&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065595.html">[Twisted-Python] IDNA problem in twisted
</A></li>
	<LI>Next message (by thread): <A HREF="065584.html">[Twisted-Python] startTLS errors not propagating to Factory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65603">[ date ]</a>
              <a href="thread.html#65603">[ thread ]</a>
              <a href="subject.html#65603">[ subject ]</a>
              <a href="author.html#65603">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
