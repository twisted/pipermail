<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Limiting a task.Cooperator to N work units /	sec
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Limiting%20a%20task.Cooperator%20to%20N%20work%20units%20/%0A%09sec&In-Reply-To=%3C20101001124624.2022.97774815.divmod.xquotient.95%40localhost.localdomain%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="055461.html">
   <LINK REL="Next"  HREF="055463.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Limiting a task.Cooperator to N work units /	sec</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Limiting%20a%20task.Cooperator%20to%20N%20work%20units%20/%0A%09sec&In-Reply-To=%3C20101001124624.2022.97774815.divmod.xquotient.95%40localhost.localdomain%3E"
       TITLE="[Twisted-Python] Limiting a task.Cooperator to N work units /	sec">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri Oct  1 06:46:24 MDT 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="055461.html">[Twisted-Python] Limiting a task.Cooperator to N work units / sec
</A></li>
        <LI>Next message (by thread): <A HREF="055463.html">[Twisted-Python] Limiting a task.Cooperator to N work units / sec
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55462">[ date ]</a>
              <a href="thread.html#55462">[ thread ]</a>
              <a href="subject.html#55462">[ subject ]</a>
              <a href="author.html#55462">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09:41 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">p.mayers at imperial.ac.uk</A> wrote:
&gt;<i>Is there an easy way to make a task.Cooperator instance only execute N
</I>&gt;<i>ticks / sec, summed across all iterators it's driving? So if you add 
</I>&gt;<i>two
</I>&gt;<i>iterators, they each run at N/2 per sec, 3 at N/3, etc.
</I>&gt;<i>
</I>&gt;<i>It seems like this ought to do it:
</I>
Very close!  It took me a while to notice the mistake.
&gt;<i>N = &lt;rate&gt;
</I>&gt;<i>
</I>&gt;<i>def myScheduler(x):
</I>&gt;<i>   # reschedule N times per second
</I>&gt;<i>   reactor.callLater(1.0/N, x)
</I>
The scheduler function must not return None!  This confuses the 
scheduling code in cooperator and causes it to run too many things in 
parallel.  This mistake could be detected easily by cooperator and a 
useful exception raised to point out the problem.  Want to file a 
ticket?

Jean-Paul
&gt;<i>class myTermination:
</I>&gt;<i>   def __call__(self):
</I>&gt;<i>     # stop immediately after one iterator.next()
</I>&gt;<i>     return True
</I>&gt;<i>
</I>&gt;<i>myCoop = task.Cooperator(
</I>&gt;<i>   terminationPredicateFactory=myTermination,
</I>&gt;<i>   scheduler=myScheduler,
</I>&gt;<i>)
</I>&gt;<i>
</I>&gt;<i>...but this doesn't seem to work when I try it:
</I>&gt;<i>
</I>&gt;<i>def mytask(name, limit):
</I>&gt;<i>     for i in range(limit):
</I>&gt;<i>         print name, time.time(), i
</I>&gt;<i>         yield i
</I>&gt;<i>
</I>&gt;<i>def running():
</I>&gt;<i>     finish_a = myCoop.coiterate(mytask('a', 40))
</I>&gt;<i>     def start_b():
</I>&gt;<i>         finish_b = myCoop.coiterate(mytask('b', 10))
</I>&gt;<i>     reactor.callLater(6.5, start_b)
</I>&gt;<i>
</I>&gt;<i>def main():
</I>&gt;<i>     reactor.callWhenRunning(running)
</I>&gt;<i>     reactor.run()
</I>&gt;<i>
</I>&gt;<i>if __name__=='__main__':
</I>&gt;<i>     main()
</I>&gt;<i>
</I>&gt;<i>...shows that, once the &quot;b&quot; iterator is added, each iterator is running
</I>&gt;<i>1/sec, rather than the whole cooperator:
</I>&gt;<i>
</I>&gt;<i>a 1285925864.05 0
</I>&gt;<i>a 1285925865.05 1
</I>&gt;<i>a 1285925866.05 2
</I>&gt;<i>a 1285925867.05 3
</I>&gt;<i>a 1285925868.05 4
</I>&gt;<i>a 1285925869.05 5 &lt;&lt; running fine 1/sec up until here
</I>&gt;<i>b 1285925870.05 0
</I>&gt;<i>a 1285925870.55 6 &lt;&lt; now running 2/sec
</I>&gt;<i>b 1285925871.05 1
</I>&gt;<i>a 1285925871.55 7
</I>&gt;<i>b 1285925872.05 2
</I>&gt;<i>a 1285925872.55 8
</I>&gt;<i>b 1285925873.05 3
</I>&gt;<i>
</I>&gt;<i>I've had a look at the source code, and it looks like the logic should
</I>&gt;<i>cause what I want to happen, but obviously it's not. Version is Twisted
</I>&gt;<i>8.2.0 on python 2.6 (Fedora 12)
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Twisted-Python mailing list
</I>&gt;<i><A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="055461.html">[Twisted-Python] Limiting a task.Cooperator to N work units / sec
</A></li>
	<LI>Next message (by thread): <A HREF="055463.html">[Twisted-Python] Limiting a task.Cooperator to N work units / sec
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55462">[ date ]</a>
              <a href="thread.html#55462">[ thread ]</a>
              <a href="subject.html#55462">[ subject ]</a>
              <a href="author.html#55462">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
