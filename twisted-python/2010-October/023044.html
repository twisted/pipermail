<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20connectionLost%20never%20reached%20after%20calling%0A%20loseConnection%3A%20stuck%20in%20CLOSE_WAIT%20forever&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023041.html">
   <LINK REL="Next"  HREF="023045.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever</H1>
    <B>Stefano Debenedetti</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20connectionLost%20never%20reached%20after%20calling%0A%20loseConnection%3A%20stuck%20in%20CLOSE_WAIT%20forever&In-Reply-To="
       TITLE="[Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever">ste at demaledetti.net
       </A><BR>
    <I>Mon Oct 18 11:21:59 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="023041.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
        <LI>Next message: <A HREF="023045.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23044">[ date ]</a>
              <a href="thread.html#23044">[ thread ]</a>
              <a href="subject.html#23044">[ subject ]</a>
              <a href="author.html#23044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Jean-Paul, thanks for looking into this.

&gt;&gt;<i>What did make a difference was to comment this line, the problem
</I>&gt;&gt;<i>never happens without it:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>to.transport.registerProducer(_from.transport, True)
</I>&gt;<i> 
</I>&gt;<i> This suggests that your problem is that you don't unregister the 
</I>&gt;<i> produce.  The connection can never be closed as long as a producer is 
</I>&gt;<i> registered.  Does your code ever unregister this producer?
</I>
I am 100% sure that I unregister the producer from the transport
right before I call loseConnection on that transport (see code
snippet in my original post). Even using reactor.callLater for
calling loseConnection asynchronously after the producer has been
unregistered didn't help.

Moreover, if it was just a problem of my code not unregistering the
producer then this wouldn't explain why registering the producer as
non-streaming fixes the issue. It also wouldn't explain why does
this happen only in particular conditions and not always (even if I
managed to reproduce it reliably, I still have to debug the exact
external conditions that trigger it).

As a side note, for once what you wrote is not 200% exact ;) because
the connection is always closed properly if it's the peer closing it
first, even if the producer is still registered in that case. (Maybe
Twisted unregisters the producer by itself when this happens?)

Anyway, I ran Twisted tests on my installation after the patch I
mentioned in my previous mail and I got the same results as before
applying it so at least it seems it doesn't break any obvious stuff.

thank you, ciao
ste



</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023041.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
	<LI>Next message: <A HREF="023045.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23044">[ date ]</a>
              <a href="thread.html#23044">[ thread ]</a>
              <a href="subject.html#23044">[ subject ]</a>
              <a href="author.html#23044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
