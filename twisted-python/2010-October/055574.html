<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20connectionLost%20never%20reached%20after%20calling%0A%20loseConnection%3A%20stuck%20in%20CLOSE_WAIT%20forever&In-Reply-To=%3C4CC9AA40.4090509%40demaledetti.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="055535.html">
   <LINK REL="Next"  HREF="055577.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever</H1>
    <B>Stefano Debenedetti</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20connectionLost%20never%20reached%20after%20calling%0A%20loseConnection%3A%20stuck%20in%20CLOSE_WAIT%20forever&In-Reply-To=%3C4CC9AA40.4090509%40demaledetti.net%3E"
       TITLE="[Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever">ste at demaledetti.net
       </A><BR>
    <I>Thu Oct 28 10:52:16 MDT 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="055535.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
        <LI>Next message (by thread): <A HREF="055577.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55574">[ date ]</a>
              <a href="thread.html#55574">[ thread ]</a>
              <a href="subject.html#55574">[ subject ]</a>
              <a href="author.html#55574">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Il 18/10/2010 17:21, Stefano Debenedetti ha scritto:
&gt;<i> Anyway, I ran Twisted tests on my installation after the patch I
</I>&gt;<i> mentioned in my previous mail and I got the same results as before
</I>&gt;<i> applying it so at least it seems it doesn't break any obvious stuff.
</I>

Sorry for replying to myself but for the record: the patch I sent
does break stuff (connections are sometimes closed before all data
has been sent) so don't use it.

The partially good news is that I managed to write a self-contained
and quite short example that can reproduce the exact same problem
I'm witnessing in my app. The bad news is that it does so only about
50% of the times but I thought I would share it while I keep on
trying to make it more reliable.

Please find attached one .sh file and one .py file, save somewhere
and make them executable. You will also need netcat (nc).

If you run the .sh file and after three seconds type in a short line
of text followed by the enter key, you should see the same line you
typed printed back many times on your terminal and quite a lot of
network activity going through the localhost interface for about a
minute. Don't redirect the .sh output to /dev/null, the problem
seems to occur only when the terminal application you run it in gets
to 100% CPU while it's printing data received by netcat. Hopefully
you have a multicore machine and this won't disrupt your desktop.

If you're lucky and nothing bad happens, after a while the .sh
script will terminate and all connections opened by it and the .py
file will be closed. Please remember to kill the three python
processes launched by the script before trying again.

If you're unlucky like I am, after a while all connections will be
closed except the one between netcat and one of the three servers
powered by the .py file.

That connection will be in this state according to netstat:

# netstat -np --inet 2&gt; /dev/null | grep 127.0.0.1
tcp        0      0 127.0.0.1:8080          127.0.0.1:36815
ESTABLISHED 10042/python2.6
tcp        0      0 127.0.0.1:36815         127.0.0.1:8080
ESTABLISHED 10051/nc

If you then CTRL-C the .sh script so that netcat gets terminated,
you will get to the dreaded CLOSE_WAIT forever state:

# netstat -np --inet 2&gt; /dev/null | grep 127.0.0.1
tcp        1      0 127.0.0.1:8080          127.0.0.1:36815
CLOSE_WAIT  10042/python2.6


Please note that even though the .py file is called three times and
launches a different server application each time, the only one I'm
interested in is the first one (&quot;one&quot;), the other two are just there
to simulate the third-party apps that my server is dealing with.
This is why servers &quot;two&quot; and &quot;three&quot; do seemingly silly stuff
including closing some of their connections at some point.

My goal is that no matter how and when the client and the &quot;two&quot; and
&quot;three&quot; servers close their connections to &quot;one&quot;, the client
connection to &quot;one&quot; is always properly terminated and does never get
stuck in CLOSE_WAIT state.

Thanks for any feedback you might have,

ciao
ste



-------------- next part --------------
A non-text attachment was scrubbed...
Name: test_producer.sh
Type: application/x-sh
Size: 260 bytes
Desc: not available
URL: &lt;/pipermail/twisted-python/attachments/20101028/31bdef34/attachment-0002.sh&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: test_producer.py
Type: text/x-python
Size: 4750 bytes
Desc: not available
URL: &lt;/pipermail/twisted-python/attachments/20101028/31bdef34/attachment-0002.py&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="055535.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
	<LI>Next message (by thread): <A HREF="055577.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55574">[ date ]</a>
              <a href="thread.html#55574">[ thread ]</a>
              <a href="subject.html#55574">[ subject ]</a>
              <a href="author.html#55574">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
