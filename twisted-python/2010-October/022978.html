<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Unable to start twistd service on Ubuntu 10.04 when using pseudo terminal
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Unable%20to%20start%20twistd%20service%20on%20Ubuntu%2010.04%0A%20when%20using%20pseudo%20terminal&In-Reply-To=4CA4B230.1030709%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022977.html">
   <LINK REL="Next"  HREF="022979.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Unable to start twistd service on Ubuntu 10.04 when using pseudo terminal</H1>
    <B>Garret Heaton</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Unable%20to%20start%20twistd%20service%20on%20Ubuntu%2010.04%0A%20when%20using%20pseudo%20terminal&In-Reply-To=4CA4B230.1030709%40gmail.com"
       TITLE="[Twisted-Python] Unable to start twistd service on Ubuntu 10.04 when using pseudo terminal">powdahound at gmail.com
       </A><BR>
    <I>Fri Oct  1 12:24:44 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022977.html">[Twisted-Python] how to write a safe catch-all
</A></li>
        <LI>Next message: <A HREF="022979.html">[Twisted-Python] getPage generates a traceback in abstract.py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22978">[ date ]</a>
              <a href="thread.html#22978">[ thread ]</a>
              <a href="subject.html#22978">[ subject ]</a>
              <a href="author.html#22978">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks, that explains everything. The code I was using to test was copied
from Twisted's daemonizing function:
<A HREF="http://github.com/powdahound/twisted/blob/master/twisted/scripts/_twistd_unix.py#L155-169">http://github.com/powdahound/twisted/blob/master/twisted/scripts/_twistd_unix.py#L155-169</A>

It should probably be updated before more users upgrade to the new kernel
and run into this issue. Ticket #823 (
<A HREF="http://twistedmatrix.com/trac/ticket/823">http://twistedmatrix.com/trac/ticket/823</A>) seems very related to this.

On Thu, Sep 30, 2010 at 8:52 AM, &#381;iga Seilnacht &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ziga.seilnacht at gmail.com</A>&gt;wrote:

&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> Garret Heaton wrote:
</I>&gt;<i> &gt; I've simplified this issue down and am able to reproduce it without
</I>&gt;<i> &gt; Twisted: <A HREF="http://gist.github.com/603154">http://gist.github.com/603154</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Still not sure what the cause is, so if anyone has any ideas I'd love to
</I>&gt;<i> &gt; hear them. Thanks!
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> The behavior that you are seeing seems to be related to the change in
</I>&gt;<i> the 2.6.32 kernel, where they changed the child-runs-first scheduler
</I>&gt;<i> parameter to false. Setting that parameter to 1 with:
</I>&gt;<i>
</I>&gt;<i> $ sudo sysctl -w kernel.sched_child_runs_first=1
</I>&gt;<i>
</I>&gt;<i> and rebooting the computer restores the behavior that you saw on the
</I>&gt;<i> old kernel for me. See <A HREF="http://lwn.net/Articles/352863/">http://lwn.net/Articles/352863/</A> for more details.
</I>&gt;<i>
</I>&gt;<i> Parent (which is the controlling process when ran with -t) exiting before
</I>&gt;<i> the child starts causes the child to receive SIGHUP signal immediately as
</I>&gt;<i> it starts running, before it has time to disassociate itself from the
</I>&gt;<i> parent's process group. It seems to me that this might be an actual bug
</I>&gt;<i> in twistd, it should block the SIGHUP signal across the fork() calls.
</I>&gt;<i>
</I>&gt;<i> Your test program has an additional assumption that the child will run
</I>&gt;<i> before the parent; the child in your program tries to write to stdout,
</I>&gt;<i> i.e. the controlling terminal, which gets closed once the parent exits.
</I>&gt;<i>
</I>&gt;<i> The modified test program below works for me regardless of the setting
</I>&gt;<i> of the kernel.sched_child_runs_first parameter.
</I>&gt;<i>
</I>&gt;<i> Hope this helps,
</I>&gt;<i> Ziga
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> import os
</I>&gt;<i> import signal
</I>&gt;<i>
</I>&gt;<i> f = open(&quot;test_fork.out&quot;, &quot;w&quot;)
</I>&gt;<i>
</I>&gt;<i> def daemonize():
</I>&gt;<i>     # See <A HREF="http://www.faqs.org/faqs/unix-faq/programmer/faq/">http://www.faqs.org/faqs/unix-faq/programmer/faq/</A> - Section 1.7
</I>&gt;<i>     print &gt;&gt; f, '--- %s: daemonizing' % os.getpid()
</I>&gt;<i>
</I>&gt;<i>     signal.signal(signal.SIGHUP, signal.SIG_IGN)
</I>&gt;<i>     if os.fork(): # launch child and...
</I>&gt;<i>         print &gt;&gt; f, '--- %s: kill parent 1' % os.getpid()
</I>&gt;<i>         os._exit(0) # kill off parent
</I>&gt;<i>     print &gt;&gt; f, '--- %s: old sid: %r' % (os.getpid(),
</I>&gt;<i> os.getsid(os.getpid()))
</I>&gt;<i>     os.setsid()
</I>&gt;<i>     print &gt;&gt; f, '--- %s: new sid: %r' % (os.getpid(),
</I>&gt;<i> os.getsid(os.getpid()))
</I>&gt;<i>     if os.fork(): # launch child and...
</I>&gt;<i>         print &gt;&gt; f, '--- %s: kill parent 2' % os.getpid()
</I>&gt;<i>         os._exit(0) # kill off parent again.
</I>&gt;<i>
</I>&gt;<i>     signal.signal(signal.SIGHUP, signal.SIG_DFL)
</I>&gt;<i>     print &gt;&gt; f, '--- %s: daemonizing done' % os.getpid()
</I>&gt;<i>
</I>&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;<i>     print &gt;&gt; f, 'starting as %d' % os.getpid()
</I>&gt;<i>     daemonize()
</I>&gt;<i>     print &gt;&gt; f, 'stopping as %s' % os.getpid()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20101001/07bef191/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20101001/07bef191/attachment.htm</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022977.html">[Twisted-Python] how to write a safe catch-all
</A></li>
	<LI>Next message: <A HREF="022979.html">[Twisted-Python] getPage generates a traceback in abstract.py
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22978">[ date ]</a>
              <a href="thread.html#22978">[ thread ]</a>
              <a href="subject.html#22978">[ subject ]</a>
              <a href="author.html#22978">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
