<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20connectionLost%20never%20reached%20after%20calling%0A%20loseConnection%3A%20stuck%20in%20CLOSE_WAIT%20forever&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023037.html">
   <LINK REL="Next"  HREF="023041.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever</H1>
    <B>Stefano Debenedetti</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20connectionLost%20never%20reached%20after%20calling%0A%20loseConnection%3A%20stuck%20in%20CLOSE_WAIT%20forever&In-Reply-To="
       TITLE="[Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever">ste at demaledetti.net
       </A><BR>
    <I>Sun Oct 17 13:00:27 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="023037.html">[Twisted-Python] Weekly Bug Summary
</A></li>
        <LI>Next message: <A HREF="023041.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23040">[ date ]</a>
              <a href="thread.html#23040">[ thread ]</a>
              <a href="subject.html#23040">[ subject ]</a>
              <a href="author.html#23040">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Glyph, thanks for your reply and suggestions.

I don't have a self-contained sample yet but at least I managed to
reproduce it reliably on my installation and after a few more
experiments I think I am narrowing this down, please read below.

&gt;<i> On Oct 16, 2010, at 11:22 AM, Stefano Debenedetti wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Does this sound familiar in any way? Any suggestions off top of head
</I>&gt;&gt;<i> while I try to come up with a self-contained sample which is
</I>&gt;&gt;<i> reliably reproducing the issue I'm seeing happening only &quot;sometimes
</I>&gt;&gt;<i> and quite seldom[TM]&quot;?
</I>&gt;<i> 
</I>&gt;<i> I can't recall having seen this exact issue in the past, but as you've described it it sounds like you may have discovered a Twisted bug.  I'm looking forward to your example.
</I>&gt;<i> 
</I>&gt;<i> I do have a few questions:
</I>&gt;<i> 
</I>&gt;<i>     * What version of Twisted are you using?
</I>&gt;<i>     * Have you tried a more recent version? Trunk?
</I>

I'm using 10.1.0. I haven't tested on trunk because I see basically
no difference in internet/abstract.py and internet/tcp.py but if you
really think I should I will give trunk a try.


&gt;<i>     * What reactor are you using?
</I>&gt;<i>     * Have you tried a different reactor?
</I>

Same behavior with select, poll and epoll.


&gt;<i>     * What platform/OS are you on?  What version?
</I>&gt;<i>     * Have you tried a different platform?
</I>

I am using debian lenny with a self-compiled 2.6.35.2 kernel.
/etc/debian_version says: 5.0.5


&gt;<i> I am also curious whether changing
</I>&gt;<i> 
</I>&gt;<i>    proto.transport.loseConnection()
</I>&gt;<i> 
</I>&gt;<i> to
</I>&gt;<i>    reactor.callLater(0, proto.transport.loseConnection)
</I>&gt;<i> 
</I>&gt;<i> makes any difference to your example.
</I>

I tried this and it didn't make any difference. Using a 1 second
delay didn't improve things either.

What did make a difference was to comment this line, the problem
never happens without it:

to.transport.registerProducer(_from.transport, True)

Next test I did was to try registering the producer as non-streaming:

to.transport.registerProducer(_from.transport, False)

This also fixes the problem but it causes an exception to be printed
in the log once per set of A, B and C connections:

Traceback (most recent call last):
  File &quot;/home/lala/lib/python/twisted/python/log.py&quot;, line 84, in
callWithLogger
    return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
  File &quot;/home/lala/lib/python/twisted/python/log.py&quot;, line 69, in
callWithContext
    return context.call({ILogContext: newCtx}, func, *args, **kw)
  File &quot;/home/lala/lib/python/twisted/python/context.py&quot;, line 59,
in callWithContext
    return self.currentContext().callWithContext(ctx, func, *args, **kw)
  File &quot;/home/lala/lib/python/twisted/python/context.py&quot;, line 37,
in callWithContext
    return func(*args,**kw)
--- &lt;exception caught here&gt; ---
  File &quot;/home/lala/lib/python/twisted/internet/pollreactor.py&quot;, line
184, in _doReadOrWrite
    why = selectable.doWrite()
  File &quot;/home/lala/lib/python/twisted/internet/tcp.py&quot;, line 428, in
doWrite
    result = abstract.FileDescriptor.doWrite(self)
  File &quot;/home/lala/lib/python/twisted/internet/abstract.py&quot;, line
145, in doWrite
    self.producer.resumeProducing()
  File &quot;/home/lala/lib/python/twisted/internet/abstract.py&quot;, line
339, in resumeProducing
    assert self.connected and not self.disconnecting
exceptions.AssertionError:


This lead me to change the following lines in the doWrite code in
internet/abstract.py:

if self.disconnecting:
    # But if I was previously asked to let the connection die, do
    # so.
    return self._postLoseConnection()
elif self.producer is not None and ((not self.streamingProducer)
				  or self.producerPaused):
    # tell them to supply some more.
    self.producerPaused = 0
    self.producer.resumeProducing()
#elif self.disconnecting:
#    # But if I was previously asked to let the connection die, do
#    # so.
#    return self._postLoseConnection()

Basically this just inverts the order of checks: first check if
disconnecting, then check if a producer should be unpaused.

This makes the above traceback disappear and still fixes my
CLOSE_WAIT problem.

But using a non-streaming producer makes my app consume a lot more
memory so I reverted back my code to register the producer as streaming:

to.transport.registerProducer(_from.transport, True)

Now the CLOSE_WAIT issue is gone, no traceback appears in the log
and my app consumes the same memory as before. Victory?

I will still try to come up with a self-contained sample which
reproduces the CLOSE_WAIT problem but in the meanwhile I would like
to ask if the above-mentioned change to the doWrite definition in
internet/abstract.py is likely to destroy the universe in the near
future or if it actually sounds like a good idea.


&gt;<i> Thanks, and good luck,
</I>&gt;<i> 
</I>&gt;<i> -glyph
</I>

Thanks a lot for your help!

ciao
ste








</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023037.html">[Twisted-Python] Weekly Bug Summary
</A></li>
	<LI>Next message: <A HREF="023041.html">[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23040">[ date ]</a>
              <a href="thread.html#23040">[ thread ]</a>
              <a href="subject.html#23040">[ subject ]</a>
              <a href="author.html#23040">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
