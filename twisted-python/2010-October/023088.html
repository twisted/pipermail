<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20connectionLost%20never%20reached%20after%0A%09calling%09loseConnection%3A%20stuck%20in%20CLOSE_WAIT%20forever&In-Reply-To=4CC9AA40.4090509%40demaledetti.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023085.html">
   <LINK REL="Next"  HREF="023089.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20connectionLost%20never%20reached%20after%0A%09calling%09loseConnection%3A%20stuck%20in%20CLOSE_WAIT%20forever&In-Reply-To=4CC9AA40.4090509%40demaledetti.net"
       TITLE="[Twisted-Python] connectionLost never reached after	calling	loseConnection: stuck in CLOSE_WAIT forever">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri Oct 29 11:22:56 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="023085.html">[Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever
</A></li>
        <LI>Next message: <A HREF="023089.html">[Twisted-Python] connectionLost never reached after calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23088">[ date ]</a>
              <a href="thread.html#23088">[ thread ]</a>
              <a href="subject.html#23088">[ subject ]</a>
              <a href="author.html#23088">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28 Oct, 04:52 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ste at demaledetti.net</A> wrote:
&gt;<i>Il 18/10/2010 17:21, Stefano Debenedetti ha scritto:
</I>&gt;&gt;<i>Anyway, I ran Twisted tests on my installation after the patch I
</I>&gt;&gt;<i>mentioned in my previous mail and I got the same results as before
</I>&gt;&gt;<i>applying it so at least it seems it doesn't break any obvious stuff.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Sorry for replying to myself but for the record: the patch I sent
</I>&gt;<i>does break stuff (connections are sometimes closed before all data
</I>&gt;<i>has been sent) so don't use it.
</I>&gt;<i>
</I>&gt;<i>The partially good news is that I managed to write a self-contained
</I>&gt;<i>and quite short example that can reproduce the exact same problem
</I>&gt;<i>I'm witnessing in my app. The bad news is that it does so only about
</I>&gt;<i>50% of the times but I thought I would share it while I keep on
</I>&gt;<i>trying to make it more reliable.
</I>
Thanks.  Frequent sharing can definitely be more productive than keeping 
everything in secret until it's &quot;done&quot;. :)
&gt;<i>Please find attached one .sh file and one .py file, save somewhere
</I>&gt;<i>and make them executable. You will also need netcat (nc).
</I>&gt;<i>
</I>&gt;<i>If you run the .sh file and after three seconds type in a short line
</I>&gt;<i>of text followed by the enter key, you should see the same line you
</I>&gt;<i>typed printed back many times on your terminal and quite a lot of
</I>&gt;<i>network activity going through the localhost interface for about a
</I>&gt;<i>minute. Don't redirect the .sh output to /dev/null, the problem
</I>&gt;<i>seems to occur only when the terminal application you run it in gets
</I>&gt;<i>to 100% CPU while it's printing data received by netcat. Hopefully
</I>&gt;<i>you have a multicore machine and this won't disrupt your desktop.
</I>&gt;<i>
</I>&gt;<i>If you're lucky and nothing bad happens, after a while the .sh
</I>&gt;<i>script will terminate and all connections opened by it and the .py
</I>&gt;<i>file will be closed. Please remember to kill the three python
</I>&gt;<i>processes launched by the script before trying again.
</I>&gt;<i>
</I>&gt;<i>If you're unlucky like I am, after a while all connections will be
</I>&gt;<i>closed except the one between netcat and one of the three servers
</I>&gt;<i>powered by the .py file.
</I>&gt;<i>
</I>&gt;<i>That connection will be in this state according to netstat:
</I>&gt;<i>
</I>&gt;<i># netstat -np --inet 2&gt; /dev/null | grep 127.0.0.1
</I>&gt;<i>tcp        0      0 127.0.0.1:8080          127.0.0.1:36815
</I>&gt;<i>ESTABLISHED 10042/python2.6
</I>&gt;<i>tcp        0      0 127.0.0.1:36815         127.0.0.1:8080
</I>&gt;<i>ESTABLISHED 10051/nc
</I>&gt;<i>
</I>&gt;<i>If you then CTRL-C the .sh script so that netcat gets terminated,
</I>&gt;<i>you will get to the dreaded CLOSE_WAIT forever state:
</I>&gt;<i>
</I>&gt;<i># netstat -np --inet 2&gt; /dev/null | grep 127.0.0.1
</I>&gt;<i>tcp        1      0 127.0.0.1:8080          127.0.0.1:36815
</I>&gt;<i>CLOSE_WAIT  10042/python2.6
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Please note that even though the .py file is called three times and
</I>&gt;<i>launches a different server application each time, the only one I'm
</I>&gt;<i>interested in is the first one (&quot;one&quot;), the other two are just there
</I>&gt;<i>to simulate the third-party apps that my server is dealing with.
</I>&gt;<i>This is why servers &quot;two&quot; and &quot;three&quot; do seemingly silly stuff
</I>&gt;<i>including closing some of their connections at some point.
</I>&gt;<i>
</I>&gt;<i>My goal is that no matter how and when the client and the &quot;two&quot; and
</I>&gt;<i>&quot;three&quot; servers close their connections to &quot;one&quot;, the client
</I>&gt;<i>connection to &quot;one&quot; is always properly terminated and does never get
</I>&gt;<i>stuck in CLOSE_WAIT state.
</I>&gt;<i>
</I>&gt;<i>Thanks for any feedback you might have,
</I>
After a few runs, I managed to reproduce the problem.  I instrumented 
the reactor with some extra logging and test_producer.py with a manhole 
server.
The sequence of events appears to be something like this:

  OneA has a producer of OneE
  OneA has a consumer of OneB
  At some point OneB gives up and tells OneA to stopProducing 
(loseConnection)
  OneA.loseConnection stops the reactor from reading OneA and starts it 
writing
  OneA.doWrite happens
    it finds the send buffer empty
    it finds a registered producer (OneE) and resumes it
  OneE never produces any more bytes
  OneE loses its connection at some point and unregisters itself from 
OneA
  OneA takes note that it has no more producer, but does nothing about it

So the bug is likely that FileDescriptor.unregisterProducer doesn't do 
anything special when disconnecting=True.

You should be able to reproduce this very simply by setting up a 
transport-producer/consumer pair, calling loseConnection on the 
transport, then unregistering the producer.

This all sounds somewhat familiar, but I don't see an existing ticket 
for it, so maybe that's my imagination.

Jean-Paul

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023085.html">[Twisted-Python] connectionLost never reached after calling loseConnection: stuck in CLOSE_WAIT forever
</A></li>
	<LI>Next message: <A HREF="023089.html">[Twisted-Python] connectionLost never reached after calling	loseConnection: stuck in CLOSE_WAIT forever
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23088">[ date ]</a>
              <a href="thread.html#23088">[ thread ]</a>
              <a href="subject.html#23088">[ subject ]</a>
              <a href="author.html#23088">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
