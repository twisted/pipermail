<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] _twistd_unix.py / daemonize() / OSX /	USING_FORK_WITHOUT_EXEC_IS_NOT_SUPPORTED_BY_FILE_MANAGER
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20_twistd_unix.py%20/%20daemonize%28%29%20/%20OSX%20/%0A%09USING_FORK_WITHOUT_EXEC_IS_NOT_SUPPORTED_BY_FILE_MANAGER&In-Reply-To=361A70CD-B61F-42C9-8750-6556D437BD52%40fuhm.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023014.html">
   <LINK REL="Next"  HREF="023016.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] _twistd_unix.py / daemonize() / OSX /	USING_FORK_WITHOUT_EXEC_IS_NOT_SUPPORTED_BY_FILE_MANAGER</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20_twistd_unix.py%20/%20daemonize%28%29%20/%20OSX%20/%0A%09USING_FORK_WITHOUT_EXEC_IS_NOT_SUPPORTED_BY_FILE_MANAGER&In-Reply-To=361A70CD-B61F-42C9-8750-6556D437BD52%40fuhm.net"
       TITLE="[Twisted-Python] _twistd_unix.py / daemonize() / OSX /	USING_FORK_WITHOUT_EXEC_IS_NOT_SUPPORTED_BY_FILE_MANAGER">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Oct 13 16:46:35 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="023014.html">[Twisted-Python] _twistd_unix.py / daemonize() / OSX /	USING_FORK_WITHOUT_EXEC_IS_NOT_SUPPORTED_BY_FILE_MANAGER
</A></li>
        <LI>Next message: <A HREF="023016.html">[Twisted-Python] _twistd_unix.py / daemonize() / OSX	/	USING_FORK_WITHOUT_EXEC_IS_NOT_SUPPORTED_BY_FILE_MANAGER
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23015">[ date ]</a>
              <a href="thread.html#23015">[ thread ]</a>
              <a href="subject.html#23015">[ subject ]</a>
              <a href="author.html#23015">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Oct 13, 2010, at 1:20 PM, James Y Knight wrote:

&gt;&gt;<i> Here's a compact version. The script uses OSX' Quartz to create and manipulate images. Twisted is used to wrap it as a webserver, images are served. More pointers on how to start and use it in the script itself.
</I>&gt;<i> 
</I>&gt;<i> You need to avoid using or importing any OSX APIs until after the daemonization has occurred. Unfortunately, twisted executes the entire script file before daemonizing. [that's unfortunate for other reasons besides this, too]
</I>
To the extent that this is an intentional decision (it's at least half accidents of implementation) it's an attempt to allow twistd to actually display an error on the console if there is a serious error starting up, i.e. your plugin is not syntactically valid Python and it's just going to exit.

While I remember agreeing that it's unfortunate, I can't actually recall any issues with executing the script before forking.  Do we have tickets for them?  Can you describe a couple?

If we are going to change this behavior, we should make twistd do something more correct, and optionally allow it to report startup errors to the console after it's forked, even if those errors don't necessarily crash it during startup.  This isn't rocket science, inheriting file descriptors and delaying exit are all pretty easy.

&gt;<i> Here's a corrected version of your script which works properly. It defers importing Quartz until the reactor is running, by moving it into a function called by reactor.callWhenRunning().
</I>
Thanks for this, I'm sure that other folks will find it useful.  I'm a bit surprised it's not more of a FAQ!

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20101013/b06957fc/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20101013/b06957fc/attachment.htm</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023014.html">[Twisted-Python] _twistd_unix.py / daemonize() / OSX /	USING_FORK_WITHOUT_EXEC_IS_NOT_SUPPORTED_BY_FILE_MANAGER
</A></li>
	<LI>Next message: <A HREF="023016.html">[Twisted-Python] _twistd_unix.py / daemonize() / OSX	/	USING_FORK_WITHOUT_EXEC_IS_NOT_SUPPORTED_BY_FILE_MANAGER
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23015">[ date ]</a>
              <a href="thread.html#23015">[ thread ]</a>
              <a href="subject.html#23015">[ subject ]</a>
              <a href="author.html#23015">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
