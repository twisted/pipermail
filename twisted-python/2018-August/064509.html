<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Using twistd with -c option causes permission error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Using%20twistd%20with%20-c%20option%20causes%20permission%0A%20error&In-Reply-To=%3C8FFE3993-2742-40B2-89C3-D15763F1BECE%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064507.html">
   <LINK REL="Next"  HREF="032037.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Using twistd with -c option causes permission error</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Using%20twistd%20with%20-c%20option%20causes%20permission%0A%20error&In-Reply-To=%3C8FFE3993-2742-40B2-89C3-D15763F1BECE%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Using twistd with -c option causes permission error">glyph at twistedmatrix.com
       </A><BR>
    <I>Fri Aug 31 01:04:37 MDT 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064507.html">[Twisted-Python] Using twistd with -c option causes permission error
</A></li>
        <LI>Next message (by thread): <A HREF="032037.html">[Twisted-Python] Forking after starting AsyncioSelectorReactor: Supported?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64509">[ date ]</a>
              <a href="thread.html#64509">[ thread ]</a>
              <a href="subject.html#64509">[ subject ]</a>
              <a href="author.html#64509">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

&gt;<i> On Aug 29, 2018, at 4:04 AM, Jean-Paul Calderone &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On Tue, Aug 28, 2018 at 5:54 AM Richard Shea &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">rshea at thecubagroup.com</A> &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">rshea at thecubagroup.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> With Apache the process starts as root, reads the key and then makes the apache process run as a different, less powerful, user  but I can't see how you can do the equivalent for twistd ? Am I overlooking something ?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> twistd has `--uid` and `--gid` options for switching to another user after `privilegedStartService` runs.  However, I'm not sure how much help this will be since there is a strong desire to replace twistd with twist and twist does not have these features.  Perhaps someone who has been working on twist can explain the preferred workflow using that tool.
</I>
The origin of the desire to replace twistd with twist is that twistd represents an older, and worse, generation of UNIX administration practices.

twistd assumes privilege separation is accomplished via daemons that start up (and, implicitly, import all their code) as root, and then carefully shed privileges on their own.  this assumption was based in large part on the idea that twistd will want to bind privileged ports, and only root can bind privileged ports.  twist assumes privilege separation is accomplished by starting your process in a container, or under a process supervision regime (such as systemd) which can hand it a privileged listening port.
twistd assumes that process supervision is accomplished by an elaborate and frankly never quite fully specified dance involving PID files, self-truncation of logs, signal handling, and thus, writes pidfiles and daemonizes by default.  twist assumes that process supervision is accomplished by using a process supervisor; either a container runtime, or systemd, or something like supervisord or ncolony.

However, use of `twist` is gently encouraged, not mandated, as there are lots of old/bad systems where new versions of Twisted run, and will continue to run for some time.  If your deployment constraints are better satisfied by twistd, by all means continue using it, report bugs in it, file PRs that fix those bugs.

However, there are a long list of reasons why this new idiom is a lot better than the older one.  One specific problem with read-certs-then-shed-privileges is that it means your process can never receive a new certificate without restarting; so no certificate rotation, no adding new subdomains on the fly.  If your process has permissions to read and act on the certificate in memory, what benefit is there to making sure that it can't read it out of the filesystem a second time?  If it's bound to a privileged port, a compromised node could provision its own certificate via Let's Encrypt anyway.

So my suggestion would be to just provide the process long-lived read access to the certificates, via whatever access control mechanisms are available to you.  If all you've got are filesystem permissions, u+rw g+r should do the trick, and then just put the user running `twistd` into the appropriate group.

-g


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20180831/2cc6a82c/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064507.html">[Twisted-Python] Using twistd with -c option causes permission error
</A></li>
	<LI>Next message (by thread): <A HREF="032037.html">[Twisted-Python] Forking after starting AsyncioSelectorReactor: Supported?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64509">[ date ]</a>
              <a href="thread.html#64509">[ thread ]</a>
              <a href="subject.html#64509">[ subject ]</a>
              <a href="author.html#64509">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
