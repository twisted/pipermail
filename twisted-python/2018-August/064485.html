<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Can transport.write() to hostname instead of IP address?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Can%20transport.write%28%29%20to%20hostname%20instead%20of%0A%20IP%20address%3F&In-Reply-To=%3CCANzH6evc9dxfD%3DbwiZuQtUw1r6f4ni9o_f62AVU07bc-5vsN%2BA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064484.html">
   <LINK REL="Next"  HREF="064486.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Can transport.write() to hostname instead of IP address?</H1>
    <B>Sean DiZazzo</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Can%20transport.write%28%29%20to%20hostname%20instead%20of%0A%20IP%20address%3F&In-Reply-To=%3CCANzH6evc9dxfD%3DbwiZuQtUw1r6f4ni9o_f62AVU07bc-5vsN%2BA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Can transport.write() to hostname instead of IP address?">sean.dizazzo at gmail.com
       </A><BR>
    <I>Thu Aug 16 19:44:35 MDT 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064484.html">[Twisted-Python] Can transport.write() to hostname instead of IP address?
</A></li>
        <LI>Next message (by thread): <A HREF="064486.html">[Twisted-Python] Can transport.write() to hostname instead of IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64485">[ date ]</a>
              <a href="thread.html#64485">[ thread ]</a>
              <a href="subject.html#64485">[ subject ]</a>
              <a href="author.html#64485">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I guess thats still kind of confusing without making something more clear...

In my example, both myprotocol.example.com and test.example.com DNS records
would point to the same IP address.  One nginx instance then listens on
that IP and serves up several ssl apps. They go through a &quot;mapper&quot; that
uses the SNI and the ssl_preread directive to read the destination hostname
of the packet to determine which app to route the traffic to.

I just want transport.write() to not resolve the ip address of the host I
pass in.  Everything will work if it connects and sends packets to
myprotocol.example.com:443 instead of 23.23.23.23:443.

Nginx reference:
<A HREF="http://nginx.org/en/docs/stream/ngx_stream_ssl_preread_module.html">http://nginx.org/en/docs/stream/ngx_stream_ssl_preread_module.html</A>

On Thu, Aug 16, 2018 at 6:14 PM, Sean DiZazzo &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">sean.dizazzo at gmail.com</A>&gt;
wrote:

&gt;<i> Thanks for responding, Adi!
</I>&gt;<i>
</I>&gt;<i> I don't want each packet to go it's own way from Twisted.  They all go to
</I>&gt;<i> the same place from each instance of the server/protocol.  They go to my
</I>&gt;<i> custom protocol listening on another local port.
</I>&gt;<i>
</I>&gt;<i> It's just that I'm serving up several different ssl apps on the same nginx
</I>&gt;<i> server, and nginx uses the hostname to route the packets.  So in this case,
</I>&gt;<i> traffic coming in on http.example.com:443 might be routed to an https app
</I>&gt;<i> listening on a socket, and traffic coming in to myprotocol.example.com:443
</I>&gt;<i> should be routed to my own protocol listening on port 9999.  So if nginx
</I>&gt;<i> doesn't get the hostname, it doesn't know to route the packet to my custom
</I>&gt;<i> protocol instead of the web server.  Does that make sense?
</I>&gt;<i>
</I>&gt;<i> It seems that the transport is resolving the hostname to an ip address and
</I>&gt;<i> then sending the traffic to the generic ip which is not enough info for
</I>&gt;<i> nginx to route the packet correctly.
</I>&gt;<i>
</I>&gt;<i> On Thu, Aug 16, 2018 at 5:49 PM, Adi Roiban &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On Fri, 17 Aug 2018 at 01:25, Sean DiZazzo &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">sean.dizazzo at gmail.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; Hi all!
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; After I start a reactor connecting to a specific hostname and port, I
</I>&gt;&gt;<i> do my thing and then call transport.write() to send the data to the peer.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; From what I can tell, though, the hostname is resolved, and the data is
</I>&gt;&gt;<i> written back to the ip address itself, instead of the hostname I started
</I>&gt;&gt;<i> the reactor with.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; This is a problem in my case because we are using nginx's ssl_preread
</I>&gt;&gt;<i> server_name directive to route several different streams all coming in on
</I>&gt;&gt;<i> the same ip address.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; So the write() method needs to explicitly use the hostname to route the
</I>&gt;&gt;<i> packet properly.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; So... Is there any way to have transport.write() use the hostname given
</I>&gt;&gt;<i> instead of it's resolved IP address? Or am I missing something?
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I assume you are using TCP here.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I guess that you are missing something.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you want each write to go over its own way / route and have the
</I>&gt;&gt;<i> hostname re-resolved you should open + write + close a connection for
</I>&gt;&gt;<i> each write.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But I think that there is something else there and this is now what you
</I>&gt;&gt;<i> want :)
</I>&gt;&gt;<i> Do you use HTTP or have a custom protocol?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Adi Roiban
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20180816/a0b346f3/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064484.html">[Twisted-Python] Can transport.write() to hostname instead of IP address?
</A></li>
	<LI>Next message (by thread): <A HREF="064486.html">[Twisted-Python] Can transport.write() to hostname instead of IP address?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64485">[ date ]</a>
              <a href="thread.html#64485">[ thread ]</a>
              <a href="subject.html#64485">[ subject ]</a>
              <a href="author.html#64485">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
