<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Learning about IPushProducer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Learning%20about%20IPushProducer&In-Reply-To=C8853DE689283B47B5D348BC33E06193043D64F9%40gsmbnmp04es.firmwide.corp.gs.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014988.html">
   <LINK REL="Next"  HREF="015026.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Learning about IPushProducer</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Learning%20about%20IPushProducer&In-Reply-To=C8853DE689283B47B5D348BC33E06193043D64F9%40gsmbnmp04es.firmwide.corp.gs.com"
       TITLE="[Twisted-Python] Learning about IPushProducer">exarkun at divmod.com
       </A><BR>
    <I>Mon Mar 12 18:18:43 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="014988.html">[Twisted-Python] Learning about IPushProducer
</A></li>
        <LI>Next message: <A HREF="015026.html">[Twisted-Python] Learning about IPushProducer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14990">[ date ]</a>
              <a href="thread.html#14990">[ thread ]</a>
              <a href="subject.html#14990">[ subject ]</a>
              <a href="author.html#14990">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 12 Mar 2007 17:46:54 -0400, &quot;Rutt, Benjamin&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">benjamin.rutt at gs.com</A>&gt; wrote:
&gt;<i>    Sorry, your question was big and challenging to approach.
</I>&gt;<i>
</I>&gt;<i>Understood, thanks.  I should have pared it down.
</I>&gt;<i>
</I>&gt;<i>    This loop:
</I>&gt;<i>
</I>&gt;<i>    &gt;	        while not self.paused and self.howmany &gt;
</I>&gt;<i>    &gt;self.sent_already:
</I>&gt;<i>    &gt;	            chunksz = min(maxchunksz, self.howmany -
</I>&gt;<i>    &gt;self.sent_already)
</I>&gt;<i>    &gt;	            self.consumer.write('x' * chunksz)
</I>&gt;<i>    &gt;	            self.sent_already += chunksz
</I>&gt;<i>
</I>&gt;<i>    is a bit atypical, I think.  The reason it is eventually stopping
</I>&gt;<i>    is that your code is being invoked re-entrantly by the consumer as
</I>&gt;<i>    soon as it decides its buffer is full.  I'm not sure the loop is
</I>&gt;<i>    /wrong/, but it is a bit surprising.  You don't need a mutex here,
</I>&gt;<i>    since it's single threaded, but you do need to be aware that your
</I>&gt;<i>    code can be re-entered within a single thread.
</I>&gt;<i>
</I>&gt;<i>    Does that answer your questions?
</I>&gt;<i>
</I>&gt;<i>Yes, thank you, it answers some of them but it raises more :).  I see,
</I>&gt;<i>it's self.consumer.write(...) that ends up calling the pause method.  So
</I>&gt;<i>that's how it's reentrant.  I knew twisted wasn't multithreaded in this
</I>&gt;<i>case.  Makes sense.
</I>&gt;<i>
</I>&gt;<i>I have since made my resumeProducing() code loop for up to 100 (or 500,
</I>&gt;<i>or 1000 etc.) iterations and then return.  Thus I'm treating
</I>&gt;<i>resumeProducing as if it should &quot;produce a chunk larger than 1 byte but
</I>&gt;<i>smaller that the whole dataset&quot; then return.  How is this approach, does
</I>&gt;<i>it better match the intention of the producer/consumer system vs. the
</I>&gt;<i>&quot;loop forever until paused&quot; scheme I had earlier?
</I>
That's more like what I expect to see in a resumeProducing, yea.  Of course,
paused might still get set before your loop decides to exit, if you are no
longer checking paused.  This isn't disasterous, but it means some
information about what a good amount of stuff to keep in memory is.

I think the most common thing for a resumeProducing implementation to do is
build up a chunk of data and then call write on the consumer just once.  So
it doesn't end up mattering if you get paused or not, since you're done any
way by the time that happens.

I think you have the basic idea of how producers should work, though, and
now I'm just blabbing. :)

&gt;<i>
</I>&gt;<i>A final question -- is it safe for my code to ever call pauseProducing,
</I>&gt;<i>stopProducing, resumeProducing directly?  Or that will mess up the
</I>&gt;<i>balance of the twisted universe?  (I'm thinking that the calls to these
</I>&gt;<i>3 methods should only originate &quot;from within twisted&quot; in case the whole
</I>&gt;<i>producer/consumer system is tracking how many times it calls each one
</I>&gt;<i>etc.)  I don't plan on calling them directly, but want to critically
</I>&gt;<i>review in an informed way my colleague's code which does this.
</I>
The consumer you register the producer with basically gets control of those
methods for as long as the producer remains registered.  They're there for
it to communicate its needs with the producer, so having any other code call
them is probably bad in general, although it might work in specific cases.

&gt;<i>
</I>&gt;<i>Thank you so much for the response!
</I>&gt;<i>
</I>
No problem. :)

Jean-Paul



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014988.html">[Twisted-Python] Learning about IPushProducer
</A></li>
	<LI>Next message: <A HREF="015026.html">[Twisted-Python] Learning about IPushProducer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14990">[ date ]</a>
              <a href="thread.html#14990">[ thread ]</a>
              <a href="subject.html#14990">[ subject ]</a>
              <a href="author.html#14990">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
