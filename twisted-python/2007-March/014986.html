<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Learning about IPushProducer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Learning%20about%20IPushProducer&In-Reply-To=C8853DE689283B47B5D348BC33E06193043D64F4%40gsmbnmp04es.firmwide.corp.gs.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014983.html">
   <LINK REL="Next"  HREF="014988.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Learning about IPushProducer</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Learning%20about%20IPushProducer&In-Reply-To=C8853DE689283B47B5D348BC33E06193043D64F4%40gsmbnmp04es.firmwide.corp.gs.com"
       TITLE="[Twisted-Python] Learning about IPushProducer">exarkun at divmod.com
       </A><BR>
    <I>Mon Mar 12 17:09:56 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="014983.html">[Twisted-Python] Learning about IPushProducer
</A></li>
        <LI>Next message: <A HREF="014988.html">[Twisted-Python] Learning about IPushProducer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14986">[ date ]</a>
              <a href="thread.html#14986">[ thread ]</a>
              <a href="subject.html#14986">[ subject ]</a>
              <a href="author.html#14986">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 12 Mar 2007 15:44:41 -0400, &quot;Rutt, Benjamin&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">benjamin.rutt at gs.com</A>&gt; wrote:
&gt;<i>Hi.
</I>&gt;<i>
</I>&gt;<i>Anyone have any pointers as to how I can get some of my questions
</I>&gt;<i>answered below?  I had hoped to get some response.  Did I not use the
</I>&gt;<i>proper etiquitte?  Or there is some expert on the IPushProducer
</I>&gt;<i>mechanism or the author of page
</I>
Sorry, your question was big and challenging to approach.

&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>	When running the following code (my 2nd twisted program!), it
</I>&gt;<i>works as I had hoped - it doesn't starve any clients that want to
</I>&gt;<i>receive data back, even with a simultaneously active really long
</I>&gt;<i>streaming server-to-client communication (i.e. one piggy client asking
</I>&gt;<i>for millions of bytes).  i.e. another client can get in and ask for just
</I>&gt;<i>a few bytes while a large payload is being delivered to a different
</I>&gt;<i>client.  Which is great!
</I>&gt;<i>
</I>&gt;<i>	Here's a sample interaction from the client side:
</I>&gt;<i>
</I>&gt;<i>	$ telnet localhost 8007
</I>&gt;<i>	Trying 127.0.0.1...
</I>&gt;<i>	Connected to localhost.
</I>&gt;<i>	Escape character is '^]'.
</I>&gt;<i>	1
</I>&gt;<i>	x
</I>&gt;<i>	2
</I>&gt;<i>	xx
</I>&gt;<i>	3
</I>&gt;<i>	xxx
</I>&gt;<i>	10
</I>&gt;<i>	xxxxxxxxxx
</I>&gt;<i>	99999
</I>&gt;<i>
</I>&gt;<i>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</I>&gt;<i>xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</I>&gt;<i>
</I>&gt;<i>	[...lots of x's...]
</I>&gt;<i>	xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
</I>&gt;<i>	bye
</I>&gt;<i>	Connection closed by foreign host.
</I>&gt;<i>	$
</I>&gt;<i>
</I>&gt;<i>	So I have 2 questions on my code:
</I>&gt;<i>
</I>&gt;<i>	1) am I doing anything wrong in setting up the plumbing?
</I>&gt;<i>	2) does pauseProducing() get called by another thread whilst
</I>&gt;<i>resumeProducing() is running?  (I believe it must, otherwise my
</I>&gt;<i>resumeProducing() would only be entered once).  If so I should have an
</I>&gt;<i>appropriate mutex around the read/write of self.pause, no?
</I>&gt;<i>
</I>&gt;<i>	Here is the code, and output from the server is at the end.
</I>&gt;<i>Thanks -- Benjamin
</I>&gt;<i>
</I>&gt;<i>	#!/usr/bin/env python
</I>&gt;<i>	import os, os.path, sys, re, commands, pickle, tempfile, getopt,
</I>&gt;<i>datetime
</I>&gt;<i>	import socket, string, random, time, traceback, shutil, popen2
</I>&gt;<i>
</I>&gt;<i>	from zope.interface import implements
</I>&gt;<i>	from twisted.internet import protocol, defer, interfaces, error,
</I>&gt;<i>reactor
</I>&gt;<i>	from twisted.internet.protocol import Protocol, Factory
</I>&gt;<i>	from twisted.protocols.basic import LineReceiver
</I>&gt;<i>
</I>&gt;<i>	class NonStarvingXGiver:
</I>&gt;<i>	    implements(interfaces.IPushProducer)
</I>&gt;<i>	    def __init__(self, howmany, consumer):
</I>&gt;<i>	        self.howmany = howmany
</I>&gt;<i>	        self.sent_already = 0
</I>&gt;<i>	        self.paused = False
</I>&gt;<i>	        self.consumer = consumer
</I>&gt;<i>	    def beginSendingXs(self):
</I>&gt;<i>	        self.deferred = deferred = defer.Deferred()
</I>&gt;<i>	        self.consumer.registerProducer(self, False)
</I>&gt;<i>	        return deferred
</I>&gt;<i>	    def pauseProducing(self):
</I>&gt;<i>	        print 'pauseProducing: invoked'
</I>&gt;<i>	        self.paused = True
</I>&gt;<i>	    def resumeProducing(self):
</I>&gt;<i>	        print 'resumeProducing: invoked'
</I>&gt;<i>	        self.paused = False
</I>&gt;<i>	        maxchunksz = 1024
</I>
This loop:

&gt;<i>	        while not self.paused and self.howmany &gt;
</I>&gt;<i>self.sent_already:
</I>&gt;<i>	            chunksz = min(maxchunksz, self.howmany -
</I>&gt;<i>self.sent_already)
</I>&gt;<i>	            self.consumer.write('x' * chunksz)
</I>&gt;<i>	            self.sent_already += chunksz
</I>
is a bit atypical, I think.  The reason it is eventually stopping
is that your code is being invoked re-entrantly by the consumer as
soon as it decides its buffer is full.  I'm not sure the loop is
/wrong/, but it is a bit surprising.  You don't need a mutex here,
since it's single threaded, but you do need to be aware that your
code can be re-entered within a single thread.

Does that answer your questions?

&gt;<i> [snip]
</I>
Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014983.html">[Twisted-Python] Learning about IPushProducer
</A></li>
	<LI>Next message: <A HREF="014988.html">[Twisted-Python] Learning about IPushProducer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14986">[ date ]</a>
              <a href="thread.html#14986">[ thread ]</a>
              <a href="subject.html#14986">[ subject ]</a>
              <a href="author.html#14986">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
