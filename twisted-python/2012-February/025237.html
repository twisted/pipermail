<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Problem with address-literals and SMTP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Problem%20with%20address-literals%20and%20SMTP&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025240.html">
   <LINK REL="Next"  HREF="025238.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Problem with address-literals and SMTP</H1>
    <B>George Pajari</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Problem%20with%20address-literals%20and%20SMTP&In-Reply-To="
       TITLE="[Twisted-Python] Problem with address-literals and SMTP">George.Pajari at glentel.com
       </A><BR>
    <I>Mon Feb 13 18:30:31 EST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="025240.html">[Twisted-Python] installing pyOpenSSL on Centos6 help
</A></li>
        <LI>Next message: <A HREF="025238.html">[Twisted-Python] Problem with address-literals and SMTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25237">[ date ]</a>
              <a href="thread.html#25237">[ thread ]</a>
              <a href="subject.html#25237">[ subject ]</a>
              <a href="author.html#25237">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We're deploying Zenoss and found that some of the email alert messages that were being delivered to Zenoss were not being properly handled. The problem turns out to be an omission in the Python Twisted SMTP class in that it cannot handle an email address that contains an address-literal (cf. Section 4.1.2 or RFC 5321), for example, zenoss@[10.100.1.192]

This is a valid mailbox address but the 8.1.0 version of the Twisted SMTP Class rejects such addresses with a &quot;501 Syntax error&quot;. No idea if this has been fixed in more recent versions (and no time to find out for myself).

I am no Python programmer so I'm sure others can do better than this, but here is my fix for this problem:

*** smtp.py
--- smtp.py.original
***************
*** 412,423 ****
                  else:
                      # Now in domain
                      domain = ['']
-             elif atl[0] == '[':
-                 if not domain:
-                     raise AddressError, &quot;[ encountered on LHS&quot;
-                 elif atl[-1] != ']':
-                     raise AddressError, &quot;Unbalanced []&quot;
-                 atl = atl[1:-1]
              elif len(atl[0]) == 1 and not self.atomre.match(atl[0]) and atl[0] !=  '.':
                  raise AddressError, &quot;Parse error at %r of %r&quot; % (atl[0], (addr, atl))
              else:
--- 412,417 ----
***************
*** 627,633 ****

      # A string of quoted strings, backslash-escaped character or
      # atom characters + '@.,:'
!     qstring = r'(&quot;[^&quot;]*&quot;|\\.|' + atom + r'|[@.,:\[\]])+'

      mail_re = re.compile(r'''\s*FROM:\s*(?P&lt;path&gt;&lt;&gt; # Empty &lt;&gt;
                           |&lt;''' + qstring + r'''&gt; # &lt;addr&gt;
--- 621,627 ----

      # A string of quoted strings, backslash-escaped character or
      # atom characters + '@.,:'
!     qstring = r'(&quot;[^&quot;]*&quot;|\\.|' + atom + r'|[@.,:])+'

      mail_re = re.compile(r'''\s*FROM:\s*(?P&lt;path&gt;&lt;&gt; # Empty &lt;&gt;
                           |&lt;''' + qstring + r'''&gt; # &lt;addr&gt;

~~~~~
George Pajari - Glentel Inc.







</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025240.html">[Twisted-Python] installing pyOpenSSL on Centos6 help
</A></li>
	<LI>Next message: <A HREF="025238.html">[Twisted-Python] Problem with address-literals and SMTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25237">[ date ]</a>
              <a href="thread.html#25237">[ thread ]</a>
              <a href="subject.html#25237">[ subject ]</a>
              <a href="author.html#25237">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
