<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] pushing out same message on 100k TCPs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20pushing%20out%20same%20message%20on%20100k%20TCPs&In-Reply-To=%3C4F364BDF.7080007%40imperial.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="057692.html">
   <LINK REL="Next"  HREF="057700.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] pushing out same message on 100k TCPs</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20pushing%20out%20same%20message%20on%20100k%20TCPs&In-Reply-To=%3C4F364BDF.7080007%40imperial.ac.uk%3E"
       TITLE="[Twisted-Python] pushing out same message on 100k TCPs">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Sat Feb 11 04:07:11 MST 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="057692.html">[Twisted-Python] pushing out same message on 100k TCPs
</A></li>
        <LI>Next message (by thread): <A HREF="057700.html">[Twisted-Python] pushing out same message on 100k TCPs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57697">[ date ]</a>
              <a href="thread.html#57697">[ thread ]</a>
              <a href="subject.html#57697">[ subject ]</a>
              <a href="author.html#57697">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02/10/2012 08:20 PM, Tobias Oberstein wrote:
&gt;<i>
</I>&gt;&gt;<i> store the socket buffer as a (fairly complex) linked list of reference-counted
</I>&gt;&gt;<i> blocks, and use scatter-gather IO to the network card.
</I>&gt;<i>
</I>&gt;<i> Doesn't a (modern) kernel do something like that for virtual memory pages ie.?
</I>
Possibly. My knowledge of kernel memory management is a lot more patchy 
than network stacks.

One option you could investigate, that I was going to suggest in my 
original reply but didn't have the time to write up, is the sendfile() 
API. If you write your message to a temporary file, you could call 
sendfile() on all 100k connections using the same file descriptor. So, 
something like:

  fd = os.open(PATH, os.O_RDWR)
  os.write(fd, message)
  os.unlink(PATH)
  for connection in biglist:
    connection.sendfile(fd, offset=0, len=100)
  os.close(fd)

Now, as I understand it, sendfile() will perform zero-copy IO; since the 
contents of the file will undoubtedly be in the page cache, it should in 
theory DMA the data straight from the (single copy of the) data in RAM 
to the NIC buffers.

It should also handle refcounting for you - you unlink the filename 
after obtaining a descriptor, and close() the FD once you've called 
sendfile, and the kernel *should* in theory free the inode and page 
containing file data once all TCP ACKs have been received.

You'll still have to make 100k syscalls, and you may find the kernel 
chooses to copy the data anyway.

However - AFAIK Twisted does not support sendfile(), and it can be 
tricky to make it work with non-blocking IO.

:<i>o(
</I>
You may also want to look at the splice() vmsplice() and tee() syscalls 
added to recent Linux kernels. tee() in particular can copy data from 
pipe to pipe without consuming, so can be repeated multiple times. It 
may be possible to assemble something that will do this task efficiently 
from those building blocks, but the APIs aren't available in Twisted.

&gt;&gt;<i> and not useful.
</I>&gt;<i>
</I>&gt;<i> When using VM pages (_if_ that would be possible) and thus no data duplication,
</I>&gt;<i> then why not useful?
</I>
Sorry, I should have been more precise - it's probably not often useful. 
There are not very many applications where sending the same TCP stream 
to that many clients at the same time is helpful - realtime video/audio 
over TCP spring to mind, and typically those need to adapt to slow 
clients by dropping them to a lower rate i.e. not the same stream any more.

As Glyph has mentioned, encryption is also a factor in todays internet.

I'm kind of curious about what your application is!


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="057692.html">[Twisted-Python] pushing out same message on 100k TCPs
</A></li>
	<LI>Next message (by thread): <A HREF="057700.html">[Twisted-Python] pushing out same message on 100k TCPs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57697">[ date ]</a>
              <a href="thread.html#57697">[ thread ]</a>
              <a href="subject.html#57697">[ subject ]</a>
              <a href="author.html#57697">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
