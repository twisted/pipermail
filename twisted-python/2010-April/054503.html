<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Question about processes in python
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Question%20about%20processes%20in%20python&In-Reply-To=%3C4BC33FE2.40809%40imperial.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="054512.html">
   <LINK REL="Next"  HREF="054507.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Question about processes in python</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Question%20about%20processes%20in%20python&In-Reply-To=%3C4BC33FE2.40809%40imperial.ac.uk%3E"
       TITLE="[Twisted-Python] Question about processes in python">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Mon Apr 12 09:44:34 MDT 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="054512.html">[Twisted-Python] Question about processes in python
</A></li>
        <LI>Next message (by thread): <A HREF="054507.html">[Twisted-Python] Twisted Download Page
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54503">[ date ]</a>
              <a href="thread.html#54503">[ thread ]</a>
              <a href="subject.html#54503">[ subject ]</a>
              <a href="author.html#54503">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/12/2010 01:09 PM, Gabriel Rossetti wrote:
&gt;<i> Hello everyone,
</I>&gt;<i>
</I>&gt;<i> I'd like to run a python function in a new process, like python 2.6's
</I>&gt;<i> multiprocessing does. I wanted to use ProcessProtocol, but it seems to
</I>&gt;<i> only work for executing executables and interacting with them using
</I>&gt;<i> stdin/stdout/other fds. Is there a way of running a python piece of code
</I>&gt;<i> in a new process?
</I>
I frequently use a model like this:


#!/usr/bin/python

import sys
# and loads of twisted imports

# function to run in a child process
def work():
     while True:
         cmd = sys.stdin.readline()
         if not cmd:
             break
         # do something
         sys.stdout.write('result\n')
         sys.stdout.flush()

class MyProcessProtocol(protocol.ProcessProtocol):
     def __init__(self):
         self.buffer = ''
         self.queue = []

     def outReceived(self, data):
         self.buffer += data
         while '\n' in self.buffer:
             reply, self.buffer = self.buffer.split('\n', 1)
             d,c = self.queue.pop(0)
             d.callback(reply)

         if self.queue:
             self.transport.write('%s\n' % (self.queue[0][1],)

     def cmd(self, c):
         d = defer.Deferred()
         if self.queue:
             # just enqueue it
             self.queue.append((d,c))
         else:
             # hang onto the deferred and also send the cmd
             self.queue.append((d,c))
             self.transport.write(c+'\n')
         return d

def parent():
     proto = MyProcessProtocol()
     reactor.spawnProcess(
         proto,
        sys.executable,
        (sys.executable, os.path.abspath(__file__), 'WORKER')
     )

     # write some commands to the child
     d = proto.send_cmd('something')
     d.addCallback(result).addErrback(failed)

def twisted_main():
     reactor.callWhenRunning(parent)
     reactor.run()

def main():
     args = sys.argv[1:]
     if args and args[0]=='WORKER':
         # we're a child process
         work()
     else:
         twisted_main()

if __name__=='__main__':
     main()


It's pretty simple; you need to be sure that the module does all the 
imports it needs in the child process. You can extend the above model to 
something more complex than simple line-based results, using e.g. JSON 
or python pickle, to handle exceptions, and so forth.

IMHO Twisted REALLY REALLY needs something built-in to do this. I'm 
aware of Ampoule; it didn't work for me when I tried it (which was a 
while ago) and having to define AMP commands to use it was a bit of a 
turn off for me.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="054512.html">[Twisted-Python] Question about processes in python
</A></li>
	<LI>Next message (by thread): <A HREF="054507.html">[Twisted-Python] Twisted Download Page
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54503">[ date ]</a>
              <a href="thread.html#54503">[ thread ]</a>
              <a href="subject.html#54503">[ subject ]</a>
              <a href="author.html#54503">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
