<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Question about processes in python
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Question%20about%20processes%20in%20python&In-Reply-To=20100412160637.GA18548%40vidar.dreamhost.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022012.html">
   <LINK REL="Next"  HREF="022014.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Question about processes in python</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Question%20about%20processes%20in%20python&In-Reply-To=20100412160637.GA18548%40vidar.dreamhost.com"
       TITLE="[Twisted-Python] Question about processes in python">glyph at twistedmatrix.com
       </A><BR>
    <I>Mon Apr 12 14:23:31 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022012.html">[Twisted-Python] Question about processes in python
</A></li>
        <LI>Next message: <A HREF="022014.html">[Twisted-Python] Question about processes in python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22013">[ date ]</a>
              <a href="thread.html#22013">[ thread ]</a>
              <a href="subject.html#22013">[ subject ]</a>
              <a href="author.html#22013">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Apr 12, 2010, at 12:06 PM, David Ripton wrote:

&gt;<i> On 2010.04.12 09:39:21 -0600, Jason J. W. Williams wrote:
</I>&gt;&gt;<i> Haven't had any issues yet. Twisted imports occur inside the process
</I>&gt;&gt;<i> function. The app was originally written as a purely blocking
</I>&gt;&gt;<i> multiprocessing app and rewritten to use Twisted inside the
</I>&gt;&gt;<i> sub-processes. It's passed all automated and hand tests without an
</I>&gt;&gt;<i> issue. Is there a reason importing Twisted inside sub-process should
</I>&gt;&gt;<i> not work?
</I>&gt;<i> 
</I>&gt;<i> Here's JP's canonical answer:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://stackoverflow.com/questions/1948641/twisted-threading-with-subprocess-popen">http://stackoverflow.com/questions/1948641/twisted-threading-with-subprocess-popen</A>
</I>&gt;<i> 
</I>&gt;<i> I've seen this problem in real code.  We had a PyGTK + Twisted program
</I>&gt;<i> that erroneously used subprocess in one place.  2% of the time, it
</I>&gt;<i> caused an exception.  98% of the time, it worked fine.  Classic race
</I>&gt;<i> condition.  Could be you have a similar bug but it never actually
</I>&gt;<i> manifests on your combination of code, OS, and hardware.  Hard to say.
</I>
I've noted this in a comment on the stackoverflow answer, but it bears repeating:

This was a long-standing bug in Twisted which has since been fixed on trunk, although it isn't present in a release: &lt;<A HREF="http://twistedmatrix.com/trac/ticket/733">http://twistedmatrix.com/trac/ticket/733</A>&gt;.  Starting with the next release (Twisted 10.1, we hope), you should be able to do this without getting this particular type of error.

Still, I wouldn't recommend using the subprocess module in a Twisted application, and multiprocessing even less.  'subprocess' uses select(), which means that if you are running processes in a server handling a large number of connections with a reactor that you've selected for that job, you will occasionally notice that '.communicate()' will blow up because your file descriptors are too big to fit into a select() call.  Its handling of EINTR and EAGAIN are less consistent than spawnProcess, you can't independently handle subprocess termination and subprocess-closing-its-output, so certain types of bugs are much tricker to track down... and I'm sure there are other issues, but I haven't had an opportunity to thoroughly audit it.

Multiprocessing has its own subtly *differently* wonky implementation of subprocess spawning (it uses os.fork(), not the subprocess module), it uses pickle to move objects between processes, and it seems to spawn threads internally, which means it depends on correct thread/process (and hey, maybe thread/pickle too) interaction.

Both of these will work reasonably well for small applications; multiprocessing is *great* if you have a simple, straightforward little multithreaded thing that you want to make multiprocess in order to take advantage of multiple cores.  But by the time you've already taken the trouble to learn how to use Twisted, IMHO spawnProcess is a lot more powerful and a lot less trouble than either of these solutions.  Even more so if you use a higher-level abstraction over it, like ampoule: &lt;<A HREF="https://launchpad.net/ampoule">https://launchpad.net/ampoule</A>&gt;.


</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022012.html">[Twisted-Python] Question about processes in python
</A></li>
	<LI>Next message: <A HREF="022014.html">[Twisted-Python] Question about processes in python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22013">[ date ]</a>
              <a href="thread.html#22013">[ thread ]</a>
              <a href="subject.html#22013">[ subject ]</a>
              <a href="author.html#22013">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
