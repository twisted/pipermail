<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Newbie - how to modify my db-intensive app to	useTwisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Newbie%20-%20how%20to%20modify%20my%20db-intensive%20app%20to%0A%09useTwisted&In-Reply-To=%3C20051121071508.3CDE23F4361%40fcserver.chagford.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044522.html">
   <LINK REL="Next"  HREF="044528.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Newbie - how to modify my db-intensive app to	useTwisted</H1>
    <B>Frank Millman</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Newbie%20-%20how%20to%20modify%20my%20db-intensive%20app%20to%0A%09useTwisted&In-Reply-To=%3C20051121071508.3CDE23F4361%40fcserver.chagford.com%3E"
       TITLE="[Twisted-Python] Newbie - how to modify my db-intensive app to	useTwisted">frank at chagford.com
       </A><BR>
    <I>Mon Nov 21 00:20:34 MST 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044522.html">[Twisted-Python] Newbie - how to modify my db-intensive app to	use Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="044528.html">[Twisted-Python] Newbie - how to modify my db-intensive app to	useTwisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44525">[ date ]</a>
              <a href="thread.html#44525">[ thread ]</a>
              <a href="subject.html#44525">[ subject ]</a>
              <a href="author.html#44525">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> 
</I>&gt;<i> Hi all
</I>&gt;<i> 
</I>
[snip]

&gt;<i> Moving this concept onto Twisted does not seem to work, as it 
</I>&gt;<i> can be running sessions for multiple users, and each 'block' 
</I>&gt;<i> will block the main loop, resulting in a major performance 
</I>&gt;<i> hit. The correct solution, as I understand it, is to change 
</I>&gt;<i> each SQL command to a deferred with a callback. I can do this 
</I>&gt;<i> on the inner layers, where the actual SQL command is 
</I>&gt;<i> executed. But I would also have to do it on each outer layer 
</I>&gt;<i> that calls a function which 'may' trigger a SQL command. 
</I>&gt;<i> There are many of these, and it goes to the heart of my 
</I>&gt;<i> approach of hiding the underlying database complexity from 
</I>&gt;<i> the application layer. Changing this feels like a daunting 
</I>&gt;<i> task, and frankly I would not know where to start.
</I>&gt;<i> 
</I>&gt;<i> The alternative is to use a multi-threaded approach. In this 
</I>&gt;<i> case, I can keep my existing approach largely unchanged, as 
</I>&gt;<i> it does not matter if one thread blocks, the others will 
</I>&gt;<i> continue without being affected.
</I>&gt;<i> 
</I>
Thanks for the replies, Marcin and Clark.

I think you have helped to to see a solution, but I would like to clarify
it.

Take the following piece of pseudo code -

    def main():
        result = func1(...)
        do something with result

If func1 blocks, the entire program will be blocked until it returns.

The Twisted approach is -

    def main():
        deferred = func1(...).addCallback(doSomething)

    def doSomething(result):
        do something with result

Now the program will not block, but the key is that main() must return
immediately, thus returning control to Twisted's main loop.

I have many cases where I call a blocking function and wait for a result. I
had envisaged something like this -

Instead of

    def main():
        result1 = func1(...)
        do something with result1
        result2 = func2(...)
        do something with result2

do this

    def main():
        deferred = func1(...).addCallback(doSomething)

    def doSomething(result1):
        do something with result1
        deferred = func2(...).addCallback(doSomethingElse)

    def doSomethingElse(result2):
        do something with result2

If this was the correct approach, it would be a nightmare to go through all
my code and split up each call into a separate deferred and callback.

If I understand Marcin and Clark correctly, I should rather do it this way -

    def main():
        conn = adbapi.ConnectionPool(...)
        conn.runInteraction(main2)

    def main2():
        result1 = func1(...)
        do something with result1
        result2 = func2(...)
        do something with result2

This involves far fewer changes to my existing code, so I think I could
tackle this. As Marcin says, this is really a multi-threaded solution, so it
is a bit of a cheat, but it looks as if it will work.

Clark, I am using psycopg2, but if I make use of the feature you describe,
would I have to define a separate callback for every SQL command? If so, it
puts me back in my original nightmare scenario. Or have I missed the point?
An example of how I could use this would be very useful.

I hope this makes sense. Any comments will be much appreciated.

Thanks again

Frank



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044522.html">[Twisted-Python] Newbie - how to modify my db-intensive app to	use Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="044528.html">[Twisted-Python] Newbie - how to modify my db-intensive app to	useTwisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44525">[ date ]</a>
              <a href="thread.html#44525">[ thread ]</a>
              <a href="subject.html#44525">[ subject ]</a>
              <a href="author.html#44525">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
