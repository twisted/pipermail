<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: mktap/twistd in a Windows service
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20mktap/twistd%20in%20a%20Windows%20service&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016258.html">
   <LINK REL="Next"  HREF="016260.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: mktap/twistd in a Windows service</H1>
    <B>David Bolen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20mktap/twistd%20in%20a%20Windows%20service&In-Reply-To="
       TITLE="[Twisted-Python] Re: mktap/twistd in a Windows service">db3l.net at gmail.com
       </A><BR>
    <I>Sun Nov  4 14:55:23 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="016258.html">[Twisted-Python] mktap/twistd in a Windows service
</A></li>
        <LI>Next message: <A HREF="016260.html">[Twisted-Python] mktap/twistd in a Windows service
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16259">[ date ]</a>
              <a href="thread.html#16259">[ thread ]</a>
              <a href="subject.html#16259">[ subject ]</a>
              <a href="author.html#16259">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Paul Moore &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">pf_moore at yahoo.co.uk</A>&gt; writes:

&gt;<i> I want to run a tiny non-authoritative DNS server on my PC. I've never
</I>&gt;<i> done this before, but twisted names looks ideal. The documentation
</I>&gt;<i> (<A HREF="http://twistedmatrix.com/projects/names/documentation/howto/names.html">http://twistedmatrix.com/projects/names/documentation/howto/names.html</A>)
</I>&gt;<i> says I just need to do
</I>&gt;<i>
</I>&gt;<i>     mktap dns --recursive --cache
</I>&gt;<i>     twistd -f dns.tap
</I>&gt;<i>
</I>&gt;<i> and indeed this works fine. I seem to recall some time ago seeing
</I>&gt;<i> postings to the effect that tap format files were out of favour, but I
</I>&gt;<i> don't follow the twisted list much, so I don't know if this is still
</I>&gt;<i> true. Nevertheless, it works so who cares?
</I>&gt;<i>
</I>&gt;<i> However, I want to run this as a Windows service. Ideally, twistd
</I>&gt;<i> would have a --install-service flag or something, but it doesn't so I
</I>&gt;<i> went looking, and found postings covering tap2ntsvc which creates
</I>&gt;<i> services from tap files, but it seems to have been replaced by ntsvc,
</I>&gt;<i> which only handles .tac files :-(
</I>
For what it's worth, I rarely use twistd for my Twisted applications,
and it's not that much work to run Twisted-based code as an NT service
without any external utilities.

You can set things up with the pywin32's service support
(win32service/util), and just have your main entry point run Twisted's
reactor.  The shutdown code stops the reactor and also terminates the
service.  Note that service startup runs the main entry point in a
second thread, but that's the &quot;main&quot; thread from Twisted's
perspective.  It does mix up signal handling under Windows, so I
typically disable that in the reactor.  Also, service control messages
(like stop) are run in the service thread (true application main
thread), so you need to call into Twisted's thread to stop the
reactor.

Here's a tiny startup script that provides service support for some
application - I've removed any special logging initialization and
registry parameter support for clarity.

          - - - - - - - - - - - - - - - - - - - - - - - - -

import os, sys
import win32service,win32serviceutil

from twisted.internet import reactor
from twisted.python import log

# Ensure basic thread support is enabled for twisted
from twisted.python import threadable
threadable.init(1)


class Service(win32serviceutil.ServiceFramework):

    _svc_name_ = '{servicename}'
    _svc_display_name_ = '{Display name for Service}'

    def SvcStop(self):
        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
        log.msg('Stopping {server}...')
        reactor.callFromThread(reactor.stop)

    def SvcDoRun(self):

        #
        # ... Initialize application here
        #

        log.msg('{Server} running...')
        reactor.run(installSignalHandlers=0)


if __name__ == &quot;__main__&quot;:
    win32serviceutil.HandleCommandLine(Service)

              - - - - - - - - - - - - - - - - - - - - - - - - -

The above provides for install/uninstall based on the default command
line handling in win32serviceutil, and of course normal Windows
control (&quot;net start&quot;, &quot;net stop&quot;) afterwards.  Registering as a Python
module only runs on the machine with Python/pywin32 installed, but you
can package the above with something like py2exe.

You can then get as complicated as you want from here.  There are some
helper functions in win32serviceutil (Get/SetServiceCustomOption) that
can simplify storing startup information in the registry if you like.

Alternatively, I've implemented my own equivalent to HandleCommandLine
in some cases where I wanted better control (or preferred &quot;--install&quot;
to just &quot;install&quot;), wanted to work in a stdin/stdout debug mode when
run directly, or needed to synchronize startup handling with the
py2exe version, when I packaged the service into an executable.

Note that I'm not sure how the above plays with Twisted's service
framework, as I never got comfortable with using it.  But aside from that
anything beyond the basics above are general python service questions,
and not specific to Twisted applications.

-- David



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016258.html">[Twisted-Python] mktap/twistd in a Windows service
</A></li>
	<LI>Next message: <A HREF="016260.html">[Twisted-Python] mktap/twistd in a Windows service
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16259">[ date ]</a>
              <a href="thread.html#16259">[ thread ]</a>
              <a href="subject.html#16259">[ subject ]</a>
              <a href="author.html#16259">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
