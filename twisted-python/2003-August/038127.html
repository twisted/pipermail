<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] timeout using LivePage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20timeout%20using%20LivePage&In-Reply-To=%3C2FF8F04E-D756-11D7-9014-000A95864FC4%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="038121.html">
   <LINK REL="Next"  HREF="038133.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] timeout using LivePage</H1>
    <B>Donovan Preston</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20timeout%20using%20LivePage&In-Reply-To=%3C2FF8F04E-D756-11D7-9014-000A95864FC4%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] timeout using LivePage">dp at twistedmatrix.com
       </A><BR>
    <I>Mon Aug 25 17:45:20 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="038121.html">[Twisted-Python] timeout using LivePage
</A></li>
        <LI>Next message (by thread): <A HREF="038133.html">[Twisted-Python] timeout using LivePage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38127">[ date ]</a>
              <a href="thread.html#38127">[ thread ]</a>
              <a href="subject.html#38127">[ subject ]</a>
              <a href="author.html#38127">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Monday, August 25, 2003, at 1:30 PM, Sean Gillies wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> Am very new to Twisted but am quickly finding that I like
</I>&gt;<i> it.  All my questions and comments involve Twisted 1.0.6
</I>&gt;<i> in combo with Python 2.3 on OS X.
</I>
Great! Always glad to have more users giving me feedback.

If you are going to be using LivePage, you should probably
track CVS instead of using a release, since LivePage is the
one major area of woven I am still doing major work on.

First, I want to clarify some terminology. LivePage is designed
to allow two things:

Client-To-Server Events: A JavaScript event handler in the
browser is routed to the Twisted server and causes some code
to run. This uses a channel I am calling the &quot;InputConduit&quot;

Server-To-Client Events: Some event happened on the server
(For example, new mail arrived, another player entered the room)
and the server wants to &quot;Push&quot; some new HTML to the client.
This uses a channel I am calling the &quot;OutputConduit&quot;

&gt;<i> I've run into a problem while making a rough .rpy prototype of
</I>&gt;<i> a mapping application (ala MapQuest) using the U of Minnesota
</I>&gt;<i> MapServer's Python interface.
</I>&gt;<i>
</I>&gt;<i> I will need to have server-side handlers for javascript events
</I>&gt;<i> to allow map zooming, panning, &amp;c and so have been experimenting
</I>&gt;<i> with LivePage.  I intend that the code should render a map image,
</I>&gt;<i> and upon clicking the image, we zoom into the map (changing model
</I>&gt;<i> data), and redraw the map image.  Unfortunately, browsers are
</I>&gt;<i> unable to load the
</I>&gt;<i>
</I>&gt;<i> mapserv.rpy/?woven_hookupOutputConduitToThisFrame=1
</I>&gt;<i>
</I>&gt;<i> URL that is generated by my instance of LivePage, and so the map
</I>&gt;<i> is never redrawn as it should.
</I>
There are actually two unrelated issues here. The first is that the
current implementation of LivePage in the Twisted CVS is geared
towards the NewReality web client (NewReality is a multiuser text
environment (game) written in Twisted) and thus the ability for
the server to send events to the client is pretty important.
You are connected and logged in using the web client, and
someone else enters the room -- you want the web browser to
display a notice about someone entering the room without having
to refresh the browser manually or set up continual reloading.

The output conduit is implemented in certain browsers (those
lacking Flash and LiveConnect) by embedding an &lt;iframe&gt;
tag whose src=&quot;?woven_hookupOutputConduitToThisFrame=1&quot;
in the page. When the browser attempts to load this iframe, it
makes a request to the server, and twisted notices that the
browser &quot;wants to hook up the output conduit to this frame&quot;,
and *never finishes sending this page to the client*. The
Twisted server just holds this connection open forever, so
that it can write data to the client on demand in response
to events on the server, and this is why it appears your
browser is unable to load this URL.

Since with your application it sounds like you only want
client-to-server events, you need to do a little bit of
hacking to prevent Woven from including the output
conduit HTML in your pages. This will get easier in future
releases of Twisted; I just haven't had time to enumerate
the possible ways people will want to use LivePage and
come up with an easy way for the programmer to specify
the features they want.

If you look at the HTML fragment woven includes in your
page when you specify the view directive &quot;webConduitGlue&quot;
you will see it includes the following parts:

   &lt;div&gt;
    &lt;script src=&quot;WebConduit2_js&quot; language=&quot;javascript&quot;&gt;&lt;/script&gt;
    &lt;iframe src=&quot;input_html&quot;
         style=&quot;width: 0; height: 0&quot; id=&quot;woven_inputConduit&quot;&gt;&lt;/iframe&gt;
    &lt;iframe
         src=&quot;?woven_hookupOutputConduitToThisFrame=1&quot;
         style=&quot;width: 100%&quot; id=&quot;woven_outputConduit&quot;&gt;&lt;/iframe&gt;
   &lt;/div&gt;

Simply replace the view=&quot;webConduitGlue&quot; node with the above
fragment, sans the output conduit frame:

   &lt;div&gt;
    &lt;script src=&quot;WebConduit2_js&quot; language=&quot;javascript&quot;&gt;&lt;/script&gt;
    &lt;iframe src=&quot;input_html&quot;
         style=&quot;width: 0; height: 0&quot; id=&quot;woven_inputConduit&quot;&gt;&lt;/iframe&gt;
   &lt;/div&gt;

After you have done this, your pages will actually appear to fully
load and you should feel happier.

&gt;<i> The model data does get changed
</I>&gt;<i> successfully, and when I manually reload the page, I do see
</I>&gt;<i> the zoomed map image as I expect.
</I>
The second issue is that you are not notifying your models
properly to tell them that they have changed. When a
client-to-server event is sent from the browser to the server,
the current version of Woven only sends the portions of the
page which have actually changed, not the entire page,
back to the browser. Again, this is something I would like
the programmer to be able to control, because sometimes
the changes are extensive enough that it makes more sense
to send the entire page back.

Your redirect hack is not a terrible solution, actually. I have
used it before.

See below for an example of how you can make your current
controller code notify the model properly.

&gt;<i> What is this 'woven_hookupOutputConduitToThisFrame' all about?
</I>&gt;<i> Do I need to set up another method to handle this URL?
</I>&gt;<i>
</I>&gt;<i> I know that it's not recommended to put so much logic in the .rpy
</I>&gt;<i> file, but as I said, a quick and dirty prototype is what I'm after.
</I>&gt;<i> Am attaching the source of mapserv.rpy here:
</I>&gt;<i>
</I>&gt;<i> --------------------------------------------------------------------
</I>&gt;<i> import os
</I>&gt;<i> import time
</I>&gt;<i> from twisted.web.woven import page, widgets, controller, model
</I>&gt;<i> from mapscript import *
</I>&gt;<i>
</I>&gt;<i> base_mapfile = 'navtech_std.map'
</I>&gt;<i>
</I>&gt;<i> # Get map object from the session data if we can
</I>&gt;<i> class MapModel(model.MethodModel):
</I>&gt;<i>     def wmfactory_mapobj(self, request):
</I>&gt;<i>         session_obj = request.getSession()
</I>&gt;<i>         try:
</I>&gt;<i>             session_mapobj = session_obj.mapobj
</I>&gt;<i>         except AttributeError:
</I>&gt;<i>             session_mapobj = mapObj(base_mapfile)
</I>&gt;<i>             session_obj.mapobj = session_mapobj
</I>&gt;<i>         return session_mapobj
</I>&gt;<i>
</I>&gt;<i> # Widget for creating a temp map image and a tag linking to it
</I>&gt;<i> class MapImage(widgets.Widget):
</I>&gt;<i>     def setUp(self, request, node, data):
</I>&gt;<i>         mapobj = data
</I>&gt;<i>         node.tagName = &quot;img&quot;
</I>&gt;<i>         imgobj = mapobj.draw()
</I>&gt;<i>         tmp_file = '%s_%d_%d.%s' \
</I>&gt;<i>                  % (mapobj.name, time.time(), os.getpid(),
</I>&gt;<i>                     imgobj.format.extension )
</I>&gt;<i>         imgobj.save(os.path.join('/tmp', tmp_file))
</I>&gt;<i>         map_url = os.path.join('/tmp', tmp_file)
</I>&gt;<i>         node.setAttribute('src', map_url)
</I>&gt;<i>         node.setAttribute('height', str(mapobj.height))
</I>&gt;<i>         node.setAttribute('width', str(mapobj.width))
</I>&gt;<i>         node.setAttribute('border', '1')
</I>&gt;<i>
</I>&gt;<i> # Widget for displaying the current scale of the map
</I>&gt;<i> class MapScale(widgets.Widget):
</I>&gt;<i>     def setUp(self, request, node, data):
</I>&gt;<i>         text = 'Scale: 1:%d' % (data.scale)
</I>&gt;<i>         newNode = request.d.createTextNode(text)
</I>&gt;<i>         node.appendChild(newNode)
</I>&gt;<i>
</I>&gt;<i> # Template, using the web conduit glue
</I>&gt;<i> template = &quot;&quot;&quot;&lt;html&gt;
</I>&gt;<i>   &lt;body&gt;
</I>&gt;<i>     &lt;img model=&quot;mapobj&quot; view=&quot;map_image&quot; controller=&quot;map_ctrl&quot;/&gt;
</I>&gt;<i>     &lt;p model=&quot;mapobj&quot; view=&quot;map_scale&quot; /&gt;
</I>&gt;<i>     &lt;div view=&quot;webConduitGlue&quot; /&gt;
</I>&gt;<i>   &lt;/body&gt;
</I>&gt;<i> &lt;/html&gt;
</I>&gt;<i> &quot;&quot;&quot;
</I>&gt;<i>
</I>&gt;<i> # Zoom into the map in the event of a javascript onclick
</I>&gt;<i> class MyEventHandler(controller.Controller):
</I>&gt;<i>     def handle(self, request):
</I>&gt;<i>         self.view.addEventHandler(&quot;onclick&quot;, self.onClick)
</I>&gt;<i>
</I>&gt;<i>     def onClick(self, request, widget):
</I>&gt;<i>         # Get session map object (layers and spatial extents)
</I>&gt;<i>         session_obj = request.getSession()
</I>&gt;<i>         try:
</I>&gt;<i>             session_mapobj = session_obj.mapobj
</I>&gt;<i>         except AttributeError:
</I>&gt;<i>             session_mapobj = mapObj(base_mapfile)
</I>&gt;<i>             session_obj.mapobj = session_mapob
</I>&gt;<i>
</I>&gt;<i>         # zoom in on the map
</I>&gt;<i>         w = session_mapobj.width
</I>&gt;<i>         h = session_mapobj.height
</I>&gt;<i>         pt = pointObj()
</I>&gt;<i>         pt.x, pt.y = w/2, h/2
</I>&gt;<i>         session_mapobj.zoomPoint(2, pt, w, h, session_mapobj.extent, 
</I>&gt;<i> None)
</I>&gt;<i>         print session_mapobj.extent.minx, session_mapobj.extent.maxx
</I>&gt;<i>         print self, &quot;Zoomed!!!&quot;
</I>
            # Tell the browser that the model has changed, and
            # any widgets which rely on this model will have to be
            # rerendered, and the HTML sent to the browser
	 widget.model.notify({'request': request})

            # Delete the next three lines
&gt;<i>         # There is a better way to redraw the map, certainly
</I>&gt;<i>         request.redirect('<A HREF="http://localhost:8084/mapserv.rpy/">http://localhost:8084/mapserv.rpy/</A>')
</I>&gt;<i>         request.finish()
</I>&gt;<i>
</I>&gt;<i> # Page class
</I>&gt;<i> class MyPage(page.LivePage):
</I>&gt;<i>     def wcfactory_map_ctrl(self, request, node, model):
</I>&gt;<i>         return MyEventHandler(model)
</I>&gt;<i>
</I>&gt;<i> # Resource
</I>&gt;<i> resource = MyPage(MapModel(), template=template)
</I>&gt;<i> resource.setSubviewFactory(&quot;map_image&quot;, MapImage)
</I>&gt;<i> resource.setSubviewFactory(&quot;map_scale&quot;, MapScale)
</I>&gt;<i> -----------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> looking forward to any insights into LivePage and also looking forward
</I>&gt;<i> to getting enough experience with Twisted that I can begin to 
</I>&gt;<i> contribute
</I>&gt;<i> to the list discussions.
</I>
By the way, addEventHandler takes additional arguments
which are javascript strings which will be evaluated within the
context of the browser, and the results will be sent as additional
arguments to the server-side event handler.

To take advantage of this, you have to know a bit about
JavaScript, but for example, if you know about the IE global
&quot;event&quot; object, you could use it to pass the current x, y
position of the mouse to the server with something like
this:

self.view.addEventHandler(&quot;onclick&quot;, self.onClick, 'event.x', 'event.y')

Then defining the event handler like this:

def addEventHandler(self, request, widget, x, y):
	print &quot;x, y&quot;, x, y

Of course, doing this means knowing enough about javascript to do
this properly, but those are problems with JavaScript and not Woven.
I think Mozilla has different semantics for getting at the event object
which may require changes in WebConduit2_js. I would consider it a
bug if changes are required.

I hope this helps!

Donovan



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="038121.html">[Twisted-Python] timeout using LivePage
</A></li>
	<LI>Next message (by thread): <A HREF="038133.html">[Twisted-Python] timeout using LivePage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38127">[ date ]</a>
              <a href="thread.html#38127">[ thread ]</a>
              <a href="subject.html#38127">[ subject ]</a>
              <a href="author.html#38127">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
