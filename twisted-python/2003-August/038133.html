<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] timeout using LivePage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20timeout%20using%20LivePage&In-Reply-To=%3CEF75DB24-D7CB-11D7-8128-000393B98B56%40frii.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="038127.html">
   <LINK REL="Next"  HREF="038136.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] timeout using LivePage</H1>
    <B>Sean Gillies</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20timeout%20using%20LivePage&In-Reply-To=%3CEF75DB24-D7CB-11D7-8128-000393B98B56%40frii.com%3E"
       TITLE="[Twisted-Python] timeout using LivePage">sgillies at frii.com
       </A><BR>
    <I>Tue Aug 26 07:48:12 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="038127.html">[Twisted-Python] timeout using LivePage
</A></li>
        <LI>Next message (by thread): <A HREF="038136.html">[Twisted-Python] timeout using LivePage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38133">[ date ]</a>
              <a href="thread.html#38133">[ thread ]</a>
              <a href="subject.html#38133">[ subject ]</a>
              <a href="author.html#38133">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Monday, August 25, 2003, at 05:45  PM, Donovan Preston wrote:

&gt;<i>
</I>&gt;<i> On Monday, August 25, 2003, at 1:30 PM, Sean Gillies wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Am very new to Twisted but am quickly finding that I like
</I>&gt;&gt;<i> it.  All my questions and comments involve Twisted 1.0.6
</I>&gt;&gt;<i> in combo with Python 2.3 on OS X.
</I>&gt;<i>
</I>&gt;<i> Great! Always glad to have more users giving me feedback.
</I>&gt;<i>
</I>&gt;<i> If you are going to be using LivePage, you should probably
</I>&gt;<i> track CVS instead of using a release, since LivePage is the
</I>&gt;<i> one major area of woven I am still doing major work on.
</I>&gt;<i>
</I>&gt;<i> First, I want to clarify some terminology. LivePage is designed
</I>&gt;<i> to allow two things:
</I>&gt;<i>
</I>&gt;<i> Client-To-Server Events: A JavaScript event handler in the
</I>&gt;<i> browser is routed to the Twisted server and causes some code
</I>&gt;<i> to run. This uses a channel I am calling the &quot;InputConduit&quot;
</I>&gt;<i>
</I>&gt;<i> Server-To-Client Events: Some event happened on the server
</I>&gt;<i> (For example, new mail arrived, another player entered the room)
</I>&gt;<i> and the server wants to &quot;Push&quot; some new HTML to the client.
</I>&gt;<i> This uses a channel I am calling the &quot;OutputConduit&quot;
</I>&gt;<i>
</I>&gt;&gt;<i> I've run into a problem while making a rough .rpy prototype of
</I>&gt;&gt;<i> a mapping application (ala MapQuest) using the U of Minnesota
</I>&gt;&gt;<i> MapServer's Python interface.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I will need to have server-side handlers for javascript events
</I>&gt;&gt;<i> to allow map zooming, panning, &amp;c and so have been experimenting
</I>&gt;&gt;<i> with LivePage.  I intend that the code should render a map image,
</I>&gt;&gt;<i> and upon clicking the image, we zoom into the map (changing model
</I>&gt;&gt;<i> data), and redraw the map image.  Unfortunately, browsers are
</I>&gt;&gt;<i> unable to load the
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> mapserv.rpy/?woven_hookupOutputConduitToThisFrame=1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> URL that is generated by my instance of LivePage, and so the map
</I>&gt;&gt;<i> is never redrawn as it should.
</I>&gt;<i>
</I>&gt;<i> There are actually two unrelated issues here. The first is that the
</I>&gt;<i> current implementation of LivePage in the Twisted CVS is geared
</I>&gt;<i> towards the NewReality web client (NewReality is a multiuser text
</I>&gt;<i> environment (game) written in Twisted) and thus the ability for
</I>&gt;<i> the server to send events to the client is pretty important.
</I>&gt;<i> You are connected and logged in using the web client, and
</I>&gt;<i> someone else enters the room -- you want the web browser to
</I>&gt;<i> display a notice about someone entering the room without having
</I>&gt;<i> to refresh the browser manually or set up continual reloading.
</I>&gt;<i>
</I>&gt;<i> The output conduit is implemented in certain browsers (those
</I>&gt;<i> lacking Flash and LiveConnect) by embedding an &lt;iframe&gt;
</I>&gt;<i> tag whose src=&quot;?woven_hookupOutputConduitToThisFrame=1&quot;
</I>&gt;<i> in the page. When the browser attempts to load this iframe, it
</I>&gt;<i> makes a request to the server, and twisted notices that the
</I>&gt;<i> browser &quot;wants to hook up the output conduit to this frame&quot;,
</I>&gt;<i> and *never finishes sending this page to the client*. The
</I>&gt;<i> Twisted server just holds this connection open forever, so
</I>&gt;<i> that it can write data to the client on demand in response
</I>&gt;<i> to events on the server, and this is why it appears your
</I>&gt;<i> browser is unable to load this URL.
</I>&gt;<i>
</I>&gt;<i> Since with your application it sounds like you only want
</I>&gt;<i> client-to-server events, you need to do a little bit of
</I>&gt;<i> hacking to prevent Woven from including the output
</I>&gt;<i> conduit HTML in your pages. This will get easier in future
</I>&gt;<i> releases of Twisted; I just haven't had time to enumerate
</I>&gt;<i> the possible ways people will want to use LivePage and
</I>&gt;<i> come up with an easy way for the programmer to specify
</I>&gt;<i> the features they want.
</I>&gt;<i>
</I>&gt;<i> If you look at the HTML fragment woven includes in your
</I>&gt;<i> page when you specify the view directive &quot;webConduitGlue&quot;
</I>&gt;<i> you will see it includes the following parts:
</I>&gt;<i>
</I>&gt;<i>   &lt;div&gt;
</I>&gt;<i>    &lt;script src=&quot;WebConduit2_js&quot; language=&quot;javascript&quot;&gt;&lt;/script&gt;
</I>&gt;<i>    &lt;iframe src=&quot;input_html&quot;
</I>&gt;<i>         style=&quot;width: 0; height: 0&quot; id=&quot;woven_inputConduit&quot;&gt;&lt;/iframe&gt;
</I>&gt;<i>    &lt;iframe
</I>&gt;<i>         src=&quot;?woven_hookupOutputConduitToThisFrame=1&quot;
</I>&gt;<i>         style=&quot;width: 100%&quot; id=&quot;woven_outputConduit&quot;&gt;&lt;/iframe&gt;
</I>&gt;<i>   &lt;/div&gt;
</I>&gt;<i>
</I>&gt;<i> Simply replace the view=&quot;webConduitGlue&quot; node with the above
</I>&gt;<i> fragment, sans the output conduit frame:
</I>&gt;<i>
</I>&gt;<i>   &lt;div&gt;
</I>&gt;<i>    &lt;script src=&quot;WebConduit2_js&quot; language=&quot;javascript&quot;&gt;&lt;/script&gt;
</I>&gt;<i>    &lt;iframe src=&quot;input_html&quot;
</I>&gt;<i>         style=&quot;width: 0; height: 0&quot; id=&quot;woven_inputConduit&quot;&gt;&lt;/iframe&gt;
</I>&gt;<i>   &lt;/div&gt;
</I>&gt;<i>
</I>&gt;<i> After you have done this, your pages will actually appear to fully
</I>&gt;<i> load and you should feel happier.
</I>&gt;<i>
</I>&gt;&gt;<i> The model data does get changed
</I>&gt;&gt;<i> successfully, and when I manually reload the page, I do see
</I>&gt;&gt;<i> the zoomed map image as I expect.
</I>&gt;<i>
</I>&gt;<i> The second issue is that you are not notifying your models
</I>&gt;<i> properly to tell them that they have changed. When a
</I>&gt;<i> client-to-server event is sent from the browser to the server,
</I>&gt;<i> the current version of Woven only sends the portions of the
</I>&gt;<i> page which have actually changed, not the entire page,
</I>&gt;<i> back to the browser. Again, this is something I would like
</I>&gt;<i> the programmer to be able to control, because sometimes
</I>&gt;<i> the changes are extensive enough that it makes more sense
</I>&gt;<i> to send the entire page back.
</I>&gt;<i>
</I>&gt;<i> Your redirect hack is not a terrible solution, actually. I have
</I>&gt;<i> used it before.
</I>&gt;<i>
</I>&gt;<i> See below for an example of how you can make your current
</I>&gt;<i> controller code notify the model properly.
</I>&gt;<i>
</I>&gt;&gt;<i> What is this 'woven_hookupOutputConduitToThisFrame' all about?
</I>&gt;&gt;<i> Do I need to set up another method to handle this URL?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I know that it's not recommended to put so much logic in the .rpy
</I>&gt;&gt;<i> file, but as I said, a quick and dirty prototype is what I'm after.
</I>&gt;&gt;<i> Am attaching the source of mapserv.rpy here:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --------------------------------------------------------------------
</I>&gt;&gt;<i> import os
</I>&gt;&gt;<i> import time
</I>&gt;&gt;<i> from twisted.web.woven import page, widgets, controller, model
</I>&gt;&gt;<i> from mapscript import *
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> base_mapfile = 'navtech_std.map'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Get map object from the session data if we can
</I>&gt;&gt;<i> class MapModel(model.MethodModel):
</I>&gt;&gt;<i>     def wmfactory_mapobj(self, request):
</I>&gt;&gt;<i>         session_obj = request.getSession()
</I>&gt;&gt;<i>         try:
</I>&gt;&gt;<i>             session_mapobj = session_obj.mapobj
</I>&gt;&gt;<i>         except AttributeError:
</I>&gt;&gt;<i>             session_mapobj = mapObj(base_mapfile)
</I>&gt;&gt;<i>             session_obj.mapobj = session_mapobj
</I>&gt;&gt;<i>         return session_mapobj
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Widget for creating a temp map image and a tag linking to it
</I>&gt;&gt;<i> class MapImage(widgets.Widget):
</I>&gt;&gt;<i>     def setUp(self, request, node, data):
</I>&gt;&gt;<i>         mapobj = data
</I>&gt;&gt;<i>         node.tagName = &quot;img&quot;
</I>&gt;&gt;<i>         imgobj = mapobj.draw()
</I>&gt;&gt;<i>         tmp_file = '%s_%d_%d.%s' \
</I>&gt;&gt;<i>                  % (mapobj.name, time.time(), os.getpid(),
</I>&gt;&gt;<i>                     imgobj.format.extension )
</I>&gt;&gt;<i>         imgobj.save(os.path.join('/tmp', tmp_file))
</I>&gt;&gt;<i>         map_url = os.path.join('/tmp', tmp_file)
</I>&gt;&gt;<i>         node.setAttribute('src', map_url)
</I>&gt;&gt;<i>         node.setAttribute('height', str(mapobj.height))
</I>&gt;&gt;<i>         node.setAttribute('width', str(mapobj.width))
</I>&gt;&gt;<i>         node.setAttribute('border', '1')
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Widget for displaying the current scale of the map
</I>&gt;&gt;<i> class MapScale(widgets.Widget):
</I>&gt;&gt;<i>     def setUp(self, request, node, data):
</I>&gt;&gt;<i>         text = 'Scale: 1:%d' % (data.scale)
</I>&gt;&gt;<i>         newNode = request.d.createTextNode(text)
</I>&gt;&gt;<i>         node.appendChild(newNode)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Template, using the web conduit glue
</I>&gt;&gt;<i> template = &quot;&quot;&quot;&lt;html&gt;
</I>&gt;&gt;<i>   &lt;body&gt;
</I>&gt;&gt;<i>     &lt;img model=&quot;mapobj&quot; view=&quot;map_image&quot; controller=&quot;map_ctrl&quot;/&gt;
</I>&gt;&gt;<i>     &lt;p model=&quot;mapobj&quot; view=&quot;map_scale&quot; /&gt;
</I>&gt;&gt;<i>     &lt;div view=&quot;webConduitGlue&quot; /&gt;
</I>&gt;&gt;<i>   &lt;/body&gt;
</I>&gt;&gt;<i> &lt;/html&gt;
</I>&gt;&gt;<i> &quot;&quot;&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Zoom into the map in the event of a javascript onclick
</I>&gt;&gt;<i> class MyEventHandler(controller.Controller):
</I>&gt;&gt;<i>     def handle(self, request):
</I>&gt;&gt;<i>         self.view.addEventHandler(&quot;onclick&quot;, self.onClick)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def onClick(self, request, widget):
</I>&gt;&gt;<i>         # Get session map object (layers and spatial extents)
</I>&gt;&gt;<i>         session_obj = request.getSession()
</I>&gt;&gt;<i>         try:
</I>&gt;&gt;<i>             session_mapobj = session_obj.mapobj
</I>&gt;&gt;<i>         except AttributeError:
</I>&gt;&gt;<i>             session_mapobj = mapObj(base_mapfile)
</I>&gt;&gt;<i>             session_obj.mapobj = session_mapob
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         # zoom in on the map
</I>&gt;&gt;<i>         w = session_mapobj.width
</I>&gt;&gt;<i>         h = session_mapobj.height
</I>&gt;&gt;<i>         pt = pointObj()
</I>&gt;&gt;<i>         pt.x, pt.y = w/2, h/2
</I>&gt;&gt;<i>         session_mapobj.zoomPoint(2, pt, w, h, session_mapobj.extent,  
</I>&gt;&gt;<i> None)
</I>&gt;&gt;<i>         print session_mapobj.extent.minx, session_mapobj.extent.maxx
</I>&gt;&gt;<i>         print self, &quot;Zoomed!!!&quot;
</I>&gt;<i>
</I>&gt;<i>            # Tell the browser that the model has changed, and
</I>&gt;<i>            # any widgets which rely on this model will have to be
</I>&gt;<i>            # rerendered, and the HTML sent to the browser
</I>&gt;<i> 	 widget.model.notify({'request': request})
</I>&gt;<i>
</I>&gt;<i>            # Delete the next three lines
</I>&gt;&gt;<i>         # There is a better way to redraw the map, certainly
</I>&gt;&gt;<i>         request.redirect('<A HREF="http://localhost:8084/mapserv.rpy/">http://localhost:8084/mapserv.rpy/</A>')
</I>&gt;&gt;<i>         request.finish()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Page class
</I>&gt;&gt;<i> class MyPage(page.LivePage):
</I>&gt;&gt;<i>     def wcfactory_map_ctrl(self, request, node, model):
</I>&gt;&gt;<i>         return MyEventHandler(model)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Resource
</I>&gt;&gt;<i> resource = MyPage(MapModel(), template=template)
</I>&gt;&gt;<i> resource.setSubviewFactory(&quot;map_image&quot;, MapImage)
</I>&gt;&gt;<i> resource.setSubviewFactory(&quot;map_scale&quot;, MapScale)
</I>&gt;&gt;<i> ---------------------------------------------------------------------- 
</I>&gt;&gt;<i> -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> looking forward to any insights into LivePage and also looking forward
</I>&gt;&gt;<i> to getting enough experience with Twisted that I can begin to  
</I>&gt;&gt;<i> contribute
</I>&gt;&gt;<i> to the list discussions.
</I>&gt;<i>
</I>&gt;<i> By the way, addEventHandler takes additional arguments
</I>&gt;<i> which are javascript strings which will be evaluated within the
</I>&gt;<i> context of the browser, and the results will be sent as additional
</I>&gt;<i> arguments to the server-side event handler.
</I>&gt;<i>
</I>&gt;<i> To take advantage of this, you have to know a bit about
</I>&gt;<i> JavaScript, but for example, if you know about the IE global
</I>&gt;<i> &quot;event&quot; object, you could use it to pass the current x, y
</I>&gt;<i> position of the mouse to the server with something like
</I>&gt;<i> this:
</I>&gt;<i>
</I>&gt;<i> self.view.addEventHandler(&quot;onclick&quot;, self.onClick, 'event.x',  
</I>&gt;<i> 'event.y')
</I>&gt;<i>
</I>&gt;<i> Then defining the event handler like this:
</I>&gt;<i>
</I>&gt;<i> def addEventHandler(self, request, widget, x, y):
</I>&gt;<i> 	print &quot;x, y&quot;, x, y
</I>&gt;<i>
</I>&gt;<i> Of course, doing this means knowing enough about javascript to do
</I>&gt;<i> this properly, but those are problems with JavaScript and not Woven.
</I>&gt;<i> I think Mozilla has different semantics for getting at the event object
</I>&gt;<i> which may require changes in WebConduit2_js. I would consider it a
</I>&gt;<i> bug if changes are required.
</I>&gt;<i>
</I>&gt;<i> I hope this helps!
</I>&gt;<i>
</I>&gt;<i> Donovan
</I>&gt;<i>
</I>
Hi Donovan,

Thanks for the reply.  I can't wait to try out your recommendations.

I had read in the docs about the extra args to addEventHandler, but
appreciate seeing an example that's so close to my particular need.

cheers,
Sean

--
Sean Gillies
sgillies at frii dot com
<A HREF="http://www.frii.com/~sgillies">http://www.frii.com/~sgillies</A>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="038127.html">[Twisted-Python] timeout using LivePage
</A></li>
	<LI>Next message (by thread): <A HREF="038136.html">[Twisted-Python] timeout using LivePage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38133">[ date ]</a>
              <a href="thread.html#38133">[ thread ]</a>
              <a href="subject.html#38133">[ subject ]</a>
              <a href="author.html#38133">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
