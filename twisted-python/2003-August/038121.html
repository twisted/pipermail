<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] timeout using LivePage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20timeout%20using%20LivePage&In-Reply-To=%3CF8103AB0-D73A-11D7-8128-000393B98B56%40frii.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="038120.html">
   <LINK REL="Next"  HREF="038127.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] timeout using LivePage</H1>
    <B>Sean Gillies</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20timeout%20using%20LivePage&In-Reply-To=%3CF8103AB0-D73A-11D7-8128-000393B98B56%40frii.com%3E"
       TITLE="[Twisted-Python] timeout using LivePage">sgillies at frii.com
       </A><BR>
    <I>Mon Aug 25 14:30:30 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="038120.html">[Twisted-Python] bug in conch tutorial
</A></li>
        <LI>Next message (by thread): <A HREF="038127.html">[Twisted-Python] timeout using LivePage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38121">[ date ]</a>
              <a href="thread.html#38121">[ thread ]</a>
              <a href="subject.html#38121">[ subject ]</a>
              <a href="author.html#38121">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Am very new to Twisted but am quickly finding that I like
it.  All my questions and comments involve Twisted 1.0.6
in combo with Python 2.3 on OS X.

I've run into a problem while making a rough .rpy prototype of
a mapping application (ala MapQuest) using the U of Minnesota
MapServer's Python interface.

I will need to have server-side handlers for javascript events
to allow map zooming, panning, &amp;c and so have been experimenting
with LivePage.  I intend that the code should render a map image,
and upon clicking the image, we zoom into the map (changing model
data), and redraw the map image.  Unfortunately, browsers are
unable to load the

mapserv.rpy/?woven_hookupOutputConduitToThisFrame=1

URL that is generated by my instance of LivePage, and so the map
is never redrawn as it should.  The model data does get changed
successfully, and when I manually reload the page, I do see
the zoomed map image as I expect.

What is this 'woven_hookupOutputConduitToThisFrame' all about?
Do I need to set up another method to handle this URL?

I know that it's not recommended to put so much logic in the .rpy
file, but as I said, a quick and dirty prototype is what I'm after.
Am attaching the source of mapserv.rpy here:

--------------------------------------------------------------------
import os
import time
from twisted.web.woven import page, widgets, controller, model
from mapscript import *

base_mapfile = 'navtech_std.map'

# Get map object from the session data if we can
class MapModel(model.MethodModel):
     def wmfactory_mapobj(self, request):
         session_obj = request.getSession()
         try:
             session_mapobj = session_obj.mapobj
         except AttributeError:
             session_mapobj = mapObj(base_mapfile)
             session_obj.mapobj = session_mapobj
         return session_mapobj

# Widget for creating a temp map image and a tag linking to it
class MapImage(widgets.Widget):
     def setUp(self, request, node, data):
         mapobj = data
         node.tagName = &quot;img&quot;
         imgobj = mapobj.draw()
         tmp_file = '%s_%d_%d.%s' \
                  % (mapobj.name, time.time(), os.getpid(),
                     imgobj.format.extension )
         imgobj.save(os.path.join('/tmp', tmp_file))
         map_url = os.path.join('/tmp', tmp_file)
         node.setAttribute('src', map_url)
         node.setAttribute('height', str(mapobj.height))
         node.setAttribute('width', str(mapobj.width))
         node.setAttribute('border', '1')

# Widget for displaying the current scale of the map
class MapScale(widgets.Widget):
     def setUp(self, request, node, data):
         text = 'Scale: 1:%d' % (data.scale)
         newNode = request.d.createTextNode(text)
         node.appendChild(newNode)

# Template, using the web conduit glue
template = &quot;&quot;&quot;&lt;html&gt;
   &lt;body&gt;
     &lt;img model=&quot;mapobj&quot; view=&quot;map_image&quot; controller=&quot;map_ctrl&quot;/&gt;
     &lt;p model=&quot;mapobj&quot; view=&quot;map_scale&quot; /&gt;
     &lt;div view=&quot;webConduitGlue&quot; /&gt;
   &lt;/body&gt;
&lt;/html&gt;
&quot;&quot;&quot;

# Zoom into the map in the event of a javascript onclick
class MyEventHandler(controller.Controller):
     def handle(self, request):
         self.view.addEventHandler(&quot;onclick&quot;, self.onClick)

     def onClick(self, request, widget):
         # Get session map object (layers and spatial extents)
         session_obj = request.getSession()
         try:
             session_mapobj = session_obj.mapobj
         except AttributeError:
             session_mapobj = mapObj(base_mapfile)
             session_obj.mapobj = session_mapob

         # zoom in on the map
         w = session_mapobj.width
         h = session_mapobj.height
         pt = pointObj()
         pt.x, pt.y = w/2, h/2
         session_mapobj.zoomPoint(2, pt, w, h, session_mapobj.extent, 
None)
         print session_mapobj.extent.minx, session_mapobj.extent.maxx
         print self, &quot;Zoomed!!!&quot;

         # There is a better way to redraw the map, certainly
         request.redirect('<A HREF="http://localhost:8084/mapserv.rpy/">http://localhost:8084/mapserv.rpy/</A>')
         request.finish()

# Page class
class MyPage(page.LivePage):
     def wcfactory_map_ctrl(self, request, node, model):
         return MyEventHandler(model)

# Resource
resource = MyPage(MapModel(), template=template)
resource.setSubviewFactory(&quot;map_image&quot;, MapImage)
resource.setSubviewFactory(&quot;map_scale&quot;, MapScale)
-----------------------------------------------------------------------

looking forward to any insights into LivePage and also looking forward
to getting enough experience with Twisted that I can begin to contribute
to the list discussions.

cheers,
Sean

--
Sean Gillies
sgillies at frii dot com
<A HREF="http://www.frii.com/~sgillies">http://www.frii.com/~sgillies</A>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="038120.html">[Twisted-Python] bug in conch tutorial
</A></li>
	<LI>Next message (by thread): <A HREF="038127.html">[Twisted-Python] timeout using LivePage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38121">[ date ]</a>
              <a href="thread.html#38121">[ thread ]</a>
              <a href="subject.html#38121">[ subject ]</a>
              <a href="author.html#38121">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
