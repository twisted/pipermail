<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] [PATCH] SMTP cleanup, do not hide error messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%5BPATCH%5D%20SMTP%20cleanup%2C%20do%20not%20hide%20error%20messages&In-Reply-To=%3C20030802142216.GA25941%40lapdog%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="037849.html">
   <LINK REL="Next"  HREF="037852.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] [PATCH] SMTP cleanup, do not hide error messages</H1>
    <B>Tommi Virtanen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%5BPATCH%5D%20SMTP%20cleanup%2C%20do%20not%20hide%20error%20messages&In-Reply-To=%3C20030802142216.GA25941%40lapdog%3E"
       TITLE="[Twisted-Python] [PATCH] SMTP cleanup, do not hide error messages">tv at twistedmatrix.com
       </A><BR>
    <I>Sat Aug  2 08:22:16 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="037849.html">[Twisted-Python] Event Driven Programming 101 question
</A></li>
        <LI>Next message (by thread): <A HREF="037852.html">[Twisted-Python] [PATCH] SMTP cleanup, do not hide error messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37846">[ date ]</a>
              <a href="thread.html#37846">[ thread ]</a>
              <a href="subject.html#37846">[ subject ]</a>
              <a href="author.html#37846">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>	Hi. Here's a patch that does two things to twisted.protocol.smtp:

	1) use sendLine instead of self.transport.write, for prettiness
	   and also to make debug printing in sendLine be actually useful.

	2) use the code and error message from SMTPBadSender and
	   SMTPBadRcpt exceptions trapped, not a hardcoded &quot;550 I'm
	   not telling you what want wrong.&quot; Helps debugging scalemail
	   a _lot_.

	You have at most a few days to protest, or I will
	commit. Explicitly saying &quot;looks good&quot; appreciated.

Index: twisted/protocols/smtp.py
===================================================================
RCS file: /cvs/Twisted/twisted/protocols/smtp.py,v
retrieving revision 1.69
diff -u -u -r1.69 smtp.py
--- twisted/protocols/smtp.py	23 Jul 2003 23:10:54 -0000	1.69
+++ twisted/protocols/smtp.py	2 Aug 2003 14:46:49 -0000
@@ -444,9 +444,9 @@
         lines = message.splitlines()
         lastline = lines[-1:]
         for line in lines[:-1]:
-            self.transport.write('%3.3d-%s\r\n' % (code, line))
-        self.transport.write('%3.3d %s\r\n' % (code,
-                                               lastline and lastline[0] or ''))
+            self.sendLine('%3.3d-%s' % (code, line))
+        self.sendLine('%3.3d %s' % (code,
+                                    lastline and lastline[0] or ''))
 
     def lineReceived(self, line):
         self.resetTimeout()
@@ -558,7 +558,9 @@
 
     def _ebFromValidate(self, failure):
         if failure.check(SMTPBadSender):
-            self.sendCode(550, 'Cannot receive for specified address')
+            self.sendCode(failure.value.code,
+                          'Cannot receive for specified address %s: %s'
+                          % (repr(str(failure.value.addr)), failure.value.resp))
         elif failure.check(SMTPServerError):
             self.sendCode(failure.value.code, failure.value.resp)
         else:
@@ -632,7 +634,7 @@
 
     def _ebToValidate(self, failure):
         if failure.check(SMTPBadRcpt):
-            self.sendCode(550, 'Cannot receive for specified address')
+            self.sendCode(failure.value.code, failure.value.resp)
         elif failure.check(SMTPServerError):
             self.sendCode(failure.value.code, failure.value.resp)
         else:

-- 
:<i>(){ :|:&amp;};:
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="037849.html">[Twisted-Python] Event Driven Programming 101 question
</A></li>
	<LI>Next message (by thread): <A HREF="037852.html">[Twisted-Python] [PATCH] SMTP cleanup, do not hide error messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#37846">[ date ]</a>
              <a href="thread.html#37846">[ thread ]</a>
              <a href="subject.html#37846">[ subject ]</a>
              <a href="author.html#37846">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
