<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Unruly Callback Code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Unruly%20Callback%20Code&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005383.html">
   <LINK REL="Next"  HREF="005394.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Unruly Callback Code</H1>
    <B>Justin Johnson</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Unruly%20Callback%20Code&In-Reply-To="
       TITLE="[Twisted-Python] Unruly Callback Code">justinjohnson at fastmail.fm
       </A><BR>
    <I>Tue Aug  5 10:02:31 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="005383.html">[Twisted-Python] Subclassing static.File
</A></li>
        <LI>Next message: <A HREF="005394.html">[Twisted-Python] Unruly Callback Code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5384">[ date ]</a>
              <a href="thread.html#5384">[ thread ]</a>
              <a href="subject.html#5384">[ subject ]</a>
              <a href="author.html#5384">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have some code that is getting a bit unruly due to the number of
callbacks I am doing.  I've defined all of this in a single method
because it is part of a command line tool with multiple sub-commands,
each with its own options, and I made the entire program (i.e. the
command line tool) the class, and the sub-commands are methods on that
class.  However, I'm beginning to think I need to rearrange this so it is
more maintainable, like putting each sub-command in its own class so the
callbacks can be methods on the class instead of inline functions.

Would someone mind looking at the code below and suggesting ways to clean
this up?

Thanks.
-Justin


	# Subcommand: mkvob
	def cmd_mkvob(self):
		&quot;&quot;&quot;Usage: mkvob -v vob-tag[,vob-tag,...] -o site [-g group] [-s site,site,...]
		&quot;&quot;&quot;
		options = self.config.subOptions
		original_site = options[&quot;original&quot;]
		group = options[&quot;group&quot;]
		vobs = options[&quot;vobs&quot;].split(&quot;,&quot;)
		sites = []
		if options[&quot;sites&quot;] != None:
			sites = options[&quot;sites&quot;].split(&quot;,&quot;)

		def gotObject(object):
			self.perspectives[original_site] = object
			print &quot;Successfully connected to %s (%s).&quot; % (original_site, config.siteToServer[original_site])
			print &quot;Calling remote mkvob ...&quot;
			d = object.callRemote(&quot;mkvob&quot;, vobs, group)
			return d
		def gotNoObject(object):
			print &quot;Failed to connect:&quot;, object
			return object

		def renameReplica(results, vobs, original_site):
			# Do I have to connect again to do this?
			obj = self.perspectives[original_site]
			obj.callRemote(&quot;renameReplica&quot;, vobs, &quot;original&quot;, original_site)
			return obj

		def mkRepExport(results, vobs, sites, original_site):
			obj = self.perspectives[original_site]
			d = obj.callRemote(&quot;mkReplicaExport&quot;, vobs, sites)
			return d

		def _stop(*args):
			print &quot;The mkvob operation completed successfully&quot;
			reactor.stop()
			return args

		def mkRepImport(results, vobs, sites):
			if len(vobs) &gt; 0 and len(sites) &gt; 0:
				deferreds = []
				for site in sites:
					def onSuccess(object, site):
						self.perspectives[site] = object
						d = object.callRemote(&quot;mkReplicaImport&quot;, vobs)
						return d
					def applyTriggers(results, vobs, site):
						obj = self.perspectives[site]
						d = obj.callRemote(&quot;applyTriggers&quot;, vobs)
						return d
					d = self.connectToServer(config.siteToServer[site])
					d.addCallback(onSuccess, site).addErrback(log.err)
					d.addCallback(applyTriggers, vobs, site).addErrback(log.err)
					deferreds.append(d)
				return defer.DeferredList(deferreds)
			return results
				
		d = self.connectToServer(config.siteToServer[original_site])
		d.addCallbacks(gotObject, gotNoObject)
		d.addCallback(renameReplica, vobs, original_site).addErrback(log.err)
		d.addCallback(mkRepExport, vobs, sites, original_site).addErrback(log.err)
		d.addCallback(mkRepImport, vobs, sites).addErrback(log.err)
		d.addBoth(_stop)
		#log.startLogging(sys.stdout)
		reactor.run()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005383.html">[Twisted-Python] Subclassing static.File
</A></li>
	<LI>Next message: <A HREF="005394.html">[Twisted-Python] Unruly Callback Code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5384">[ date ]</a>
              <a href="thread.html#5384">[ thread ]</a>
              <a href="subject.html#5384">[ subject ]</a>
              <a href="author.html#5384">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
