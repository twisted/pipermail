<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Running CPU bound function concurrently in twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Running%20CPU%20bound%20function%20concurrently%20in%0A%20twisted&In-Reply-To=%3CCAONdThp7H8QSKHqTSqenE-m%2BCxjuZxYRUJUGh_Civewjz0-RAw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064836.html">
   <LINK REL="Next"  HREF="064838.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Running CPU bound function concurrently in twisted</H1>
    <B>Chengi Liu</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Running%20CPU%20bound%20function%20concurrently%20in%0A%20twisted&In-Reply-To=%3CCAONdThp7H8QSKHqTSqenE-m%2BCxjuZxYRUJUGh_Civewjz0-RAw%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Running CPU bound function concurrently in twisted">chengi.liu.86 at gmail.com
       </A><BR>
    <I>Mon Jun 24 17:26:33 MDT 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064836.html">[Twisted-Python] Running CPU bound function concurrently in twisted
</A></li>
        <LI>Next message (by thread): <A HREF="064838.html">[Twisted-Python] Running CPU bound function concurrently in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64837">[ date ]</a>
              <a href="thread.html#64837">[ thread ]</a>
              <a href="subject.html#64837">[ subject ]</a>
              <a href="author.html#64837">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Moshe &amp; Meejah &amp; Gelin for the suggestions and advice. This is super
helpful.

I think, I am able to move forward with this.
Let me just summarize this..
My usecase is.. fetch the data.. and then you assemble the data. Fetching
data is network bound, assembling data is like CPU bound.

Can you guys confirm if what I am doing makes sense?

def compute_heavy_function(x):
    return x*x

@defer.inlinecallbacks
def network_get(x):
     x = yield treq.get('<A HREF="http://localhost:8081">http://localhost:8081</A>')
   content = yield x.content()
   defer.returnValue(val)

@defer.inlinecallbacks
def twisted_do_your_magic():
     nets, cpus = [], []
      for i in range(10):
             t = defer.ensureDeferred(network_get(i))
              nets.append(t)
             d = threads.deferToThread(compute_heavy_function, i)
             cpus.append(d)

     cpu_res = yield defer.gatherResults(cpus)
  network_res = yield defer.gatherResults(nets)
  defer.returnValue({'cpu': cpu_res, 'network': network_res})

if __name__ == '__main__':
    twisted_do_your_magic()
        reactor.callLater(2, reactor.stop)
    reactor.run()


I ran it locally.. it seems to be running fine. But just want to make sure
that I got the concept on what to deferToThread &amp; what to &quot;ensureDeferred&quot;.
&gt;<i>From the SO, I got the impression that network based IO benefits from
</I>`deferToThread` but from video tutorial.. I got the impression that
ensureDefer followed by gatherResults seems to be the right way to go?



Moshe.. One last question..
I was trying to follow the tutorial on video lecture..
But, I wasnt able to make it run on python3.


Say, I have an async function

async def foo():
     resp = await treq.get(&quot;localhost:1234/foo&quot;)
     content = await resp.content()
     return json.loads(content.decode(&quot;utf-8&quot;)

async def func():
     d1 = defer.ensureDeffered(foo())
     d2 = defer.ensureDeffered(foo())
     res = await defer.gatherResults([d1, d2])
     return res

if __name__ == '__main__'
     x = func()
     reactor.callLater(2, reactor.stop)
  reactor.run()

In this case, I get an error (x = func() in main code block)..
 RuntimeWarning: coroutine 'func' was never awaited
How do i fix this.

Again, thanks for all the help, support and advice in getting me started
with twisted.



On Mon, Jun 24, 2019 at 3:49 PM meejah &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">meejah at meejah.ca</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> As a clarification to the above, parallelization of Python code across
</I>&gt;<i> cores is not unique to Twisted; all Python code has this same
</I>&gt;<i> limitation.
</I>&gt;<i>
</I>&gt;<i> To use multiple cores with Python code, you need multiple Python
</I>&gt;<i> processes (as has been pointed out). One way to achieve this is to have
</I>&gt;<i> the multiple processes talking to each other (using some kind of RPC
</I>&gt;<i> protocol).
</I>&gt;<i>
</I>&gt;<i> Another way is to simply spawn some number of subprocesses (and Twisted
</I>&gt;<i> has good support for running subprocesses). So, for example, if you
</I>&gt;<i> write a CLI tool that can be told to run &quot;part of your problem&quot; then
</I>&gt;<i> your parent Twisted process can simply spawn some number of those with
</I>&gt;<i> appropriate arguments to split up the problem (e.g. give each process 1
</I>&gt;<i> / num_cores of the problem). This will incur some startup penalty as
</I>&gt;<i> each process starts up (especially if you're using PyPy, which you
</I>&gt;<i> should be if you care about speed) but is way simpler.
</I>&gt;<i>
</I>&gt;<i> Obviously, an RPC-style communication system avoids the startup penalty
</I>&gt;<i> (but can be more complex).
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> meejah
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190624/38b7b3db/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064836.html">[Twisted-Python] Running CPU bound function concurrently in twisted
</A></li>
	<LI>Next message (by thread): <A HREF="064838.html">[Twisted-Python] Running CPU bound function concurrently in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64837">[ date ]</a>
              <a href="thread.html#64837">[ thread ]</a>
              <a href="subject.html#64837">[ subject ]</a>
              <a href="author.html#64837">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
