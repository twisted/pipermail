<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python]  Running CPU bound function concurrently in twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%0A%20%3D%3Futf-8%3Fq%3FRunning_CPU_bound_function_concurrent%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fly_in_twisted%3F%3D&In-Reply-To=%3C9834d492-7399-4099-b807-255b68721e9b%40www.fastmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032373.html">
   <LINK REL="Next"  HREF="032375.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python]  Running CPU bound function concurrently in twisted</H1>
    <B>Moshe Zadka</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%0A%20%3D%3Futf-8%3Fq%3FRunning_CPU_bound_function_concurrent%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fly_in_twisted%3F%3D&In-Reply-To=%3C9834d492-7399-4099-b807-255b68721e9b%40www.fastmail.com%3E"
       TITLE="[Twisted-Python]  Running CPU bound function concurrently in twisted">moshez at zadka.club
       </A><BR>
    <I>Mon Jun 24 13:40:06 MDT 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032373.html">[Twisted-Python] Running CPU bound function concurrently in twisted
</A></li>
        <LI>Next message (by thread): <A HREF="032375.html">[Twisted-Python] Running CPU bound function concurrently in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32374">[ date ]</a>
              <a href="thread.html#32374">[ thread ]</a>
              <a href="subject.html#32374">[ subject ]</a>
              <a href="author.html#32374">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Cheng,

deferToThread *returns* a deferred, and sends the work to a thread pool. The other two functions are useful for manipulating deferreds or other promises, but will not send work to a separate thread, so they cannot be used instead.

The simple example is pretty simple, it's pretty much

@inlineCallbacks
def some_function():
 d1 = deferToThread(cpu_heavy_square, 5)
 d2 = deferToThread(cpu_heavy_square, 6)
 five_squared, six_squared = yield gatherResults([d1, d2])
 returnValue(five_squared + six_squared)

Note that the tutorial below can be downloaded in notebook form from <A HREF="https://github.com/moshez/twisted-tutorial/blob/master/Twisted-Tutorial.ipynb">https://github.com/moshez/twisted-tutorial/blob/master/Twisted-Tutorial.ipynb</A>

However, as explained, this will *defer to threads*, but will *not* use multiple cores, since Python is single-core. This is not entirely accurate: if your heavy functions are using numpy, numpy will release the GIL sometimes. Otherwise, you might want to use ampoule, but there are no easy tutorials for it that I'm aware of. You might want to consider something like dask + deferToThread for using multiple cores. See <A HREF="https://github.com/dask/dask-tutorial/blob/master/01_dask.delayed.ipynb">https://github.com/dask/dask-tutorial/blob/master/01_dask.delayed.ipynb</A> for a simple example: you just plan your computation, and run the `compute` method in a thread. In this case, the only thing the thread is doing is avoiding blocking the reactor, while dask internally apportions computations.

(Thank you for the kind of words about the tutorial -- I'm one of the presenters.)

Moshe Z.

On Mon, Jun 24, 2019, at 11:34, Chengi Liu wrote:
&gt;<i> Thanks for pointing that out. Is there a dead simply example on how to parallelize a function using ampoule.
</I>&gt;<i> Again, I have a function.. I have a for loop.. the function takes in an argument from loop.. but the for loop is extremely parallelizable.
</I>&gt;<i> 
</I>&gt;<i> Also, I was going thru this awesome twisted tutorial from pycon 2107 (<A HREF="https://www.youtube.com/watch?v=ztkBG4qLR_4">https://www.youtube.com/watch?v=ztkBG4qLR_4</A>)
</I>&gt;<i> I found couple of use features.
</I>&gt;<i> (defer.*ensureDeferred*
</I>&gt;<i> and
</I>&gt;<i> defer.*gatherResults*
</I>&gt;<i> )
</I>&gt;<i> Can these two be used instead of deferToThread.
</I>&gt;<i> When are the above defered used and when to use deferToThread.
</I>&gt;<i> 
</I>&gt;<i> Thanks for entertaining my dumb questions.
</I>&gt;<i> 
</I>&gt;<i> On Mon, Jun 24, 2019 at 1:28 AM Gelin Yan &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dynamicgl at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> Hi
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>  If your purpose is merely not to block the reactor, you can run your code in a separate thread by using deferToThread. If you want to benefit from multi cores, you may consider use <A HREF="https://github.com/twisted/ampoule">https://github.com/twisted/ampoule</A> or other similar tools.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Regards
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> gelin yan
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i>  Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> 
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190624/4462b994/attachment.html&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032373.html">[Twisted-Python] Running CPU bound function concurrently in twisted
</A></li>
	<LI>Next message (by thread): <A HREF="032375.html">[Twisted-Python] Running CPU bound function concurrently in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32374">[ date ]</a>
              <a href="thread.html#32374">[ thread ]</a>
              <a href="subject.html#32374">[ subject ]</a>
              <a href="author.html#32374">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
