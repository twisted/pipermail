<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] What to do when a service fails to start, also, 	deferred and startService
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20What%20to%20do%20when%20a%20service%20fails%20to%20start%2C%20also%2C%20%0A%09deferred%20and%20startService&In-Reply-To=%3C20081221082032.12555.570369233.divmod.xquotient.2379%40weber.divmod.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051415.html">
   <LINK REL="Next"  HREF="051421.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] What to do when a service fails to start, also, 	deferred and startService</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20What%20to%20do%20when%20a%20service%20fails%20to%20start%2C%20also%2C%20%0A%09deferred%20and%20startService&In-Reply-To=%3C20081221082032.12555.570369233.divmod.xquotient.2379%40weber.divmod.com%3E"
       TITLE="[Twisted-Python] What to do when a service fails to start, also, 	deferred and startService">glyph at divmod.com
       </A><BR>
    <I>Sun Dec 21 01:20:32 MST 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051415.html">[Twisted-Python] how to get an idle callback while running a	reactor?
</A></li>
        <LI>Next message (by thread): <A HREF="051421.html">[Twisted-Python] How is happened?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51418">[ date ]</a>
              <a href="thread.html#51418">[ thread ]</a>
              <a href="subject.html#51418">[ subject ]</a>
              <a href="author.html#51418">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 28 Nov, 03:38 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">terry at jon.es</A> wrote:
&gt;<i>Hi Glyph
</I>&gt;<i>
</I>&gt;<i>Thanks for the detailed reply.
</I>
No problem, sorry it took so long to get back to this; I definitely left 
the conversation halfway through.
&gt;&gt;&gt;&gt;&gt;&gt;<i>&quot;glyph&quot; == glyph  &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A>&gt; writes:
</I>&gt;<i>glyph&gt; On 27 Nov, 05:16 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">terry at jon.es</A> wrote:
</I>
&gt;<i>glyph&gt; The key question here is: indicate to whom?  If you want to 
</I>&gt;<i>indicate
</I>&gt;<i>glyph&gt; it to some other object, well, try:except: or addErrback and 
</I>&gt;<i>call a
</I>&gt;<i>glyph&gt; method on that object.  Nothing magic about it.
</I>&gt;<i>
</I>&gt;<i>I have code written as a Twisted plugin. So I have a class implementing
</I>&gt;<i>IServiceMaker and IPlugin, and I create an instance of that class which
</I>&gt;<i>gets found when I invoke twistd from the command line.
</I>&gt;<i>
</I>&gt;<i>So in my case I want to indicate to twistd that the service that my 
</I>&gt;<i>class
</I>&gt;<i>creates a makeService method to create, but which I do not set in 
</I>&gt;<i>motion,
</I>&gt;<i>has failed to start and that twistd should exit, or do something other 
</I>&gt;<i>than
</I>&gt;<i>cheerfully tell me that there's been an Unhandled Error.
</I>
&gt;<i>Does that make more sense? Sorry, I should have said I was using 
</I>&gt;<i>twistd.
</I>
Yes.  And I think that this is a good use-case for making IService a bit 
deeper than it is.  twistd (and, one day, other tools that might be able 
to start IService objects) potentially needs some more information so it 
can make a more intelligent high-level decision about what to do next.

My previous messages were basically saying &quot;you can't do what you want 
with IService&quot;.  i.e. you can't write your own code to do something 
clever and somehow have dependencies and notifications to users of 
&quot;twistd&quot; fall out of that.  But that shouldn't be taken as an indication 
that twistd itself shouldn't be improved.

For reasons I brought up in previous messages, exiting is not always the 
right thing to do.  But in some cases (*none* of the services on offer 
were able to start up, for example) it might be.
&gt;<i>I'm not sure what should happen. I'm sitting at the command line, I've
</I>&gt;<i>asked twistd to start something for me, there's clearly been a problem
</I>&gt;<i>doing so (and this doesn't have to be baroque, maybe I just couldn't 
</I>&gt;<i>listen
</I>&gt;<i>on a specific port I wanted, or maybe my code somehow raised an 
</I>&gt;<i>Exception),
</I>&gt;<i>but I don't seem to have a mechanism for having twistd take any notice 
</I>&gt;<i>at
</I>&gt;<i>all.
</I>
Keep in mind that you may be sitting on the other end of a blackberry 
which needs to get an email when 'twistd' fails to start up after a 
server reboot - you're not necessarily at a command line.  One of the 
reasons that no mechanism has yet evolved for propagating interesting 
status messages about services is that there's no obvious channel for 
those messages to be communicated to.
&gt;<i>In the case of a service being started by twistd, it doesn't seem as 
</I>&gt;<i>simple
</I>&gt;<i>as you describe, but maybe that's my lack of understanding again.
</I>&gt;<i>I can easily subclass IService, but something else is calling the 
</I>&gt;<i>startService
</I>&gt;<i>method of that subclass. And that thing, whatever it is, is not 
</I>&gt;<i>expecting
</I>&gt;<i>me to return a deferred. So if my startService has for some reason got 
</I>&gt;<i>its
</I>&gt;<i>hands on a deferred, it can't simply hand it back to its caller and 
</I>&gt;<i>have
</I>&gt;<i>something (twistd in my case) see that an error occurred.
</I>
&gt;<i>It does feel like I have to track down what this something else might
</I>&gt;<i>be.
</I>
It's not that you've failed to understand something - you have correctly 
identified that there is nothing to understand :).  You need to go find 
that thing (&quot;whatever it is&quot; ;-)) in twistd that's invoking the very 
first call to IService.startService (and privilegedStartService as well) 
and propose a concrete way to make it smarter.

(I've elided your exploration of twisted code, but you're basically 
looking in the right direction.)
&gt;<i>So should I write my own twistd?
</I>
No way, man, it's open source!  Not writing your own is the whole point! 
Open a ticket, write a patch.  If you're not really sure what the patch 
should do, we can continue this discussion about reporting startup 
errors and service dependencies here.  This poorly-specified ticket 
indicates that other developers have had similar problems in the past: 
<A HREF="http://twistedmatrix.com/trac/ticket/1572">http://twistedmatrix.com/trac/ticket/1572</A>
&gt;<i>All this doesn't seem to be a matter of
</I>&gt;<i>simple subclassing. Plus, I can't just go in and start editing the
</I>&gt;<i>top-level functions in twisted/application/app.py and
</I>&gt;<i>twisted/scripts/_twistd_unix.py or code that imports app, etc.
</I>
Sure you can.  Then, you take the results of running 'svn diff' on the 
copy of Twisted where you did that, and... :)
&gt;<i>Sorry for so many questions - I really don't know if I'm missing 
</I>&gt;<i>something
</I>&gt;<i>simple here. I do enjoy digging into all this, and I appreciate your
</I>&gt;<i>apparently limitless patience. I wish I knew it all better. Twisted is
</I>&gt;<i>complex and it's a pretty good bet that anything you think of or run 
</I>&gt;<i>into
</I>&gt;<i>as a n00b has been thought of or encountered before, and that whatever 
</I>&gt;<i>way
</I>&gt;<i>you think of to solve it will probably be non-optimal, or plain wrong, 
</I>&gt;<i>or
</I>&gt;<i>in ignorance of a solution someone much more experienced has already
</I>&gt;<i>implemented, or... etc.  Hence my many questions.
</I>
Unfortunately it's equally likely that it's come up a million times and 
a half dozen people know it's an unresolved issue but it's never been 
filed as a ticket and never been clearly framed as a specific problem 
rather than a vague architectural queasiness.  The value of a good 
ticket should not be underestimated.
&gt;<i>In fact I have something like a process pool running in one service and 
</I>&gt;<i>I
</I>&gt;<i>talk to it from another machine. I say &quot;hey, process pool, start me up 
</I>&gt;<i>the
</I>&gt;<i>following service (a twistd service)&quot; and I would then like to know if 
</I>&gt;<i>that
</I>&gt;<i>service started, and if not then why not. So having twistd fail or 
</I>&gt;<i>report
</I>&gt;<i>an error if it can't start a service would be useful.
</I>
Quite so.  But, this is a great example of how this is a use-case beyond 
twistd's current capabilities, but not out of the scope of its eventual 
ambition.  It isn't currently designed to manage processes on remote 
machines.  Maybe ampoule has something which does?  I don't know, that's 
a tricky area which requires a lot of thought beyond this one feature.
&gt;<i>glyph&gt; Doing either of those things would definitely be wrong.  There's 
</I>&gt;<i>no
</I>&gt;<i>glyph&gt; reason to sys.exit or reactor.stop if your application can't 
</I>&gt;<i>start
</I>&gt;<i>glyph&gt; up, unless your management system specifically calls for such a
</I>&gt;<i>glyph&gt; thing.
</I>&gt;<i>
</I>&gt;<i>Maybe this is a case where it's (semi-)justified. At least if I called
</I>&gt;<i>sys.exit the twistd process would go away, instead of sitting there 
</I>&gt;<i>acting
</I>&gt;<i>as though nothing's wrong :-) I can also, of course, try interacting 
</I>&gt;<i>with
</I>&gt;<i>the service I think I just started on the remote machine, and if I 
</I>&gt;<i>can't
</I>&gt;<i>then I can tell the original process pool to kill the twistd process. 
</I>&gt;<i>But
</I>&gt;<i>that seems a pretty roundabout alternative to just having twistd notice
</I>&gt;<i>that something went awry when calling startService.
</I>
It may be worthwhile, before writing a patch, to devise your *own* 
error-reporting channel on top of twistd.  For example, a dedicated 
error-report-processing server listening on a dedicated port.  Then you 
can specify your own enhanced-IService interface that handles 
dependencies and deferreds and whatever else you need, and an adapter to 
hooks it up to twistd via IService but reports errors to your external 
error-reporting channel.  Once you're sure that design works, it should 
be straightforward to change the implementation of twistd to honor your 
expanded interface, and provide an alternate implementation of the 
error-reporting channel.
&gt;<i>glyph&gt; In the future, even the Twisted plugin code might be starting 
</I>&gt;<i>some
</I>&gt;<i>glyph&gt; things in addition to your application.  As I mentioned above, a
</I>&gt;<i>glyph&gt; good reason to do that is to perform diagnostics on failed 
</I>&gt;<i>startups
</I>&gt;<i>glyph&gt; :).
</I>&gt;<i>
</I>&gt;<i>I assume you really mean &quot;startups&quot; and not &quot;services&quot;. In which case, 
</I>&gt;<i>I'm
</I>&gt;<i>100% sure there's something funny here, but I can't figure it out. I'd 
</I>&gt;<i>love
</I>&gt;<i>to know, and I'm smiling broadly in any case. Too bad email loses so 
</I>&gt;<i>much
</I>&gt;<i>humor.....  we can always try though.
</I>
By &quot;startups&quot; I simply meant &quot;attempts to start-up a service&quot; i.e. calls 
to startService.  I'm sure there is a truckload of subtle and completely 
unintentional humor in there somewhere though.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051415.html">[Twisted-Python] how to get an idle callback while running a	reactor?
</A></li>
	<LI>Next message (by thread): <A HREF="051421.html">[Twisted-Python] How is happened?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51418">[ date ]</a>
              <a href="thread.html#51418">[ thread ]</a>
              <a href="subject.html#51418">[ subject ]</a>
              <a href="author.html#51418">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
