<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: A Python metaclass for Twisted allowing	__init__ to return a Deferred
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20A%20Python%20metaclass%20for%20Twisted%20allowing%0A%09__init__%20to%20return%20a%20Deferred&In-Reply-To=%3C18746.12940.638819.228559%40jon.es%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051326.html">
   <LINK REL="Next"  HREF="051328.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: A Python metaclass for Twisted allowing	__init__ to return a Deferred</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20A%20Python%20metaclass%20for%20Twisted%20allowing%0A%09__init__%20to%20return%20a%20Deferred&In-Reply-To=%3C18746.12940.638819.228559%40jon.es%3E"
       TITLE="[Twisted-Python] Re: A Python metaclass for Twisted allowing	__init__ to return a Deferred">terry at jon.es
       </A><BR>
    <I>Sat Dec  6 01:06:36 MST 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051326.html">[Twisted-Python] Re: A Python metaclass for Twisted allowing	__init__ to return a Deferred
</A></li>
        <LI>Next message (by thread): <A HREF="051328.html">[Twisted-Python] Weekly Bug Summary
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51327">[ date ]</a>
              <a href="thread.html#51327">[ thread ]</a>
              <a href="subject.html#51327">[ subject ]</a>
              <a href="author.html#51327">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Nicola!

&gt;&gt;&gt;&gt;&gt;<i> &quot;Nicola&quot; == Nicola Larosa &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">nico at teknico.net</A>&gt; writes:
</I>Nicola&gt; Terry Jones wrote:
&gt;&gt;<i> BTW, I spent an interesting morning getting my head around *exactly* how
</I>&gt;&gt;<i> inlineCallbacks does its thing... No summary of my thoughts could do it
</I>&gt;&gt;<i> justice. I wonder how many people on the planet have been down that
</I>&gt;&gt;<i> rabbit hole.
</I>
Nicola&gt; Not me, man, not me. I just use the bloody thing, and curse it when
Nicola&gt; it shortens tracebacks.

I know exactly what you're talking about, and I hated that too. But I dug
into that and found out where the problem was: I didn't know Python well
enough :-)

I bet you're doing something like this:

@inlineCallbacks
def f():
    # Whatever
    try:
        # Your code here
    except Exception, e:
        # Do some cleaning up, maybe write to the log, maybe call another
        # function that uses inlineCallbacks
        raise e

or just

@inlineCallbacks
def f():
    # Whatever
    try:
        # Your code here
    except Exception:
        # Do some cleaning up, maybe write to the log, maybe call another
        # function that uses inlineCallbacks
        raise


The problem here is that you're not using the 3-argument form of raise. So
you're either dropping information (with the raise e) or pulling out the
last exception (with the no-arg raise).

Consider the latter case. Suppose your cleanup code calls another function
that uses inlineCallbacks. That function will eventually raise
StopIteration or raise via calling defer.returnValue. So by the time
control returns to your code, your raise (which implicitly uses
sys.exc_info()) raises the wrong exception! So you get e.g., a
StopIteration exception coming at you out of your inlineCallbacks function
and you curse the thing :-) This applies if your cleanup code calls any
iterator, or if you call something that try/except catches a KeyError, etc.

So just use

@inlineCallbacks
def f():
    # Whatever
    try:
        # Your code here
    except Exception:
        info = sys.exc_info()
        # Do some cleaning up, maybe write to the log, maybe call another
        # function that uses inlineCallbacks
        raise info[0], info[1], info[2]

and it just works. Try it :-) You cant do anything nice like raise *info
because Python's parser doesn't like that (AFAIR).

I nearly posted about this to the list, but I figured it might help if I
had more of a clue about Python itself, seeing as what I was doing was
nothing to do with Twisted.


&gt;&gt;<i> I hope people don't mind my peanut gallery commentary. We're all in this
</I>&gt;&gt;<i> together, after all. A little gallows humor occasionally seems in order.
</I>Nicola&gt; Again, certainly not me. Go right ahead! ;-)

Don't encourage me...

Terry


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051326.html">[Twisted-Python] Re: A Python metaclass for Twisted allowing	__init__ to return a Deferred
</A></li>
	<LI>Next message (by thread): <A HREF="051328.html">[Twisted-Python] Weekly Bug Summary
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51327">[ date ]</a>
              <a href="thread.html#51327">[ thread ]</a>
              <a href="subject.html#51327">[ subject ]</a>
              <a href="author.html#51327">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
