<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] RFC: IPv6 multicast join/ticket 6597
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20RFC%3A%20IPv6%20multicast%20join/ticket%206597&In-Reply-To=%3C4608F909-EE03-401B-A898-BAC3D3CBB35B%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030637.html">
   <LINK REL="Next"  HREF="030654.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] RFC: IPv6 multicast join/ticket 6597</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20RFC%3A%20IPv6%20multicast%20join/ticket%206597&In-Reply-To=%3C4608F909-EE03-401B-A898-BAC3D3CBB35B%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] RFC: IPv6 multicast join/ticket 6597">glyph at twistedmatrix.com
       </A><BR>
    <I>Tue Jul 26 01:57:29 MDT 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="030637.html">[Twisted-Python] RFC: IPv6 multicast join/ticket 6597
</A></li>
        <LI>Next message: <A HREF="030654.html">[Twisted-Python] RFC: IPv6 multicast join/ticket 6597
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30642">[ date ]</a>
              <a href="thread.html#30642">[ thread ]</a>
              <a href="subject.html#30642">[ subject ]</a>
              <a href="author.html#30642">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Jul 25, 2016, at 9:43 PM, Jason Litzinger &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jlitzingerdev at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I'm looking at making the changes to support IPv6 multicast groups as described
</I>&gt;<i> in ticket 6597 but wanted to get some feedback (and get a feel whether this is
</I>&gt;<i> even desirable) before formally submitting any patches.
</I>
Thanks for taking this up!

&gt;<i> Specifically:
</I>&gt;<i> 
</I>&gt;<i> 1.  I've read [1] and it alludes to udp hopefully disappearing, is that something in the
</I>&gt;<i>    works?  Is there a new approach to solving this problem I should look at?  A
</I>&gt;<i>    branch in the works where this (conceptual) change belongs?
</I>&gt;<i> 
</I>&gt;<i>    Note:  The addressFamily attribute referenced already exists and is set
</I>&gt;<i>           properly for IPv6.
</I>
'twisted.internet.udp', as an importable module; not 'udp' as a feature of Twisted (or of the Internet, for that matter).  

&gt;<i> 2.  The attached change has the side effect that calls to ReactorBase.resolve()
</I>&gt;<i>    with IPv6 literals will now likely succeed where they may have failed in the
</I>&gt;<i>    past.  That means clients counting on resolve raising an exception for an
</I>&gt;<i>    IPv6 literal will break.  Not sure whether this is considered a
</I>&gt;<i>    compatibility issue, but I wanted to raise it.
</I>
We have explicitly avoided adding IPv6 name resolution to the reactor because the reactor's API for name resolution is fundamentally the wrong shape for IPv6.  If you want to add the ability to resolve IPv6 names to the reactor itself, please see this ticket: <A HREF="https://twistedmatrix.com/trac/ticket/4362">https://twistedmatrix.com/trac/ticket/4362</A> &lt;<A HREF="https://twistedmatrix.com/trac/ticket/4362">https://twistedmatrix.com/trac/ticket/4362</A>&gt;

For the purposes of this ticket alone, you should probably just skip resolution in _joinAddr1 if resolution is 

&gt;<i> 3.  One alternative to the above would be a complete API separation, via
</I>&gt;<i>    something like joinIPv6Group(), and a new resolve.  Is that more appealing
</I>&gt;<i>    in this case?
</I>
Given what we've done with connectTCP et. al., it makes sense to leave 'joinGroup' as the API for doing this.  But we probably want to leave '.resolve' alone.

&gt;<i> Caveats:
</I>&gt;<i> 
</I>&gt;<i> 1.  I have not finished all of the documentation related to developers, I will
</I>&gt;<i>    do so prior to formal submission.
</I>
I think we can do the narrative docs in a separate PR, as the interface looks like the straightforward expansion of the IPv4 interface.  You should clean up the reference documentation (i.e. docstrings) to ensure they're accurate of course.

&gt;<i> 2.  I know I need tests and docs and will submit them with the final changes.
</I>
Testing multicast is ... challenging.  I barely have any idea how to set up a test environment for IPv4, and no idea what to do for IPv6.  If you can speak to this in your tests (and hopefully docs as well) that would be super helpful.

&gt;<i> On to the patches.  With these changes, I can use the joinGroup API to add
</I>&gt;<i> myself to an IPv6 multicast group on Linux (verified via /proc/net/igmp6).
</I>&gt;<i> Additionally, trial reports the same two failures before and after these changes
</I>&gt;<i> (twisted.python.test.test_release.APIBuilderTests.test_build and
</I>&gt;<i> test_buildWithPolicy).  These changes struck me as the obvious approach, but
</I>&gt;<i> given the changes to resolve, not necessarily the best.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> diff --git a/twisted/internet/base.py b/twisted/internet/base.py
</I>&gt;<i> index 4f2c862..e813741 100644
</I>&gt;<i> --- a/twisted/internet/base.py
</I>&gt;<i> +++ b/twisted/internet/base.py
</I>&gt;<i> @@ -567,6 +567,8 @@ class ReactorBase(object):
</I>&gt;<i>             return defer.succeed('0.0.0.0')
</I>&gt;<i>         if abstract.isIPAddress(name):
</I>&gt;<i>             return defer.succeed(name)
</I>&gt;<i> +        elif abstract.isIPv6Address(name):
</I>&gt;<i> +            return defer.succeed(name)
</I>&gt;<i>         return self.resolver.getHostByName(name, timeout)
</I>&gt;<i> 
</I>&gt;<i>     # Installation.
</I>&gt;<i> diff --git a/twisted/internet/udp.py b/twisted/internet/udp.py
</I>&gt;<i> index b5a5322..210b079 100644
</I>&gt;<i> --- a/twisted/internet/udp.py
</I>&gt;<i> +++ b/twisted/internet/udp.py
</I>&gt;<i> @@ -485,7 +485,10 @@ class MulticastMixin:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     def _joinAddr1(self, addr, interface, join):
</I>&gt;<i> -        return self.reactor.resolve(interface).addCallback(self._joinAddr2, addr, join)
</I>&gt;<i> +        if self.addressFamily == socket.AF_INET:
</I>&gt;<i> +            return self.reactor.resolve(interface).addCallback(self._joinAddr2, addr, join)
</I>&gt;<i> +        else:
</I>&gt;<i> +            return self.reactor.resolve(interface).addCallback(self._joinAddrIPv6, addr, join)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     def _joinAddr2(self, interface, addr, join):
</I>&gt;<i> @@ -500,6 +503,18 @@ class MulticastMixin:
</I>&gt;<i>         except socket.error as e:
</I>&gt;<i>             return failure.Failure(error.MulticastJoinError(addr, interface, *e.args))
</I>&gt;<i> 
</I>&gt;<i> +    def _joinAddrIPv6(self, interface, addr, join):
</I>&gt;<i> +        addr = socket.inet_pton(socket.AF_INET6, addr)
</I>&gt;<i> +        interface = socket.inet_pton(socket.AF_INET6, interface)
</I>&gt;<i> +        if join:
</I>&gt;<i> +            cmd = socket.IPV6_JOIN_GROUP
</I>&gt;<i> +        else:
</I>&gt;<i> +            cmd = socket.IPV6_LEAVE_GROUP
</I>&gt;<i> +        try:
</I>&gt;<i> +            self.socket.setsockopt(socket.IPPROTO_IPV6, cmd, addr + interface)
</I>&gt;<i> +        except socket.error as e:
</I>&gt;<i> +            return failure.Failure(error.MulticastJoinError(addr, interface, *e.args))
</I>&gt;<i> +
</I>&gt;<i> 
</I>&gt;<i>     def leaveGroup(self, addr, interface=&quot;&quot;):
</I>&gt;<i>         &quot;&quot;&quot;Leave multicast group, return Deferred of success.&quot;&quot;&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This does require the client specify the interface argument when calling
</I>&gt;<i> joinGroup, e.g. self.transport.joinGroup(&quot;ff02::1&quot;, interface=&quot;::&quot;).
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance for any feedback!
</I>&gt;<i> 
</I>&gt;<i> -Jason Litzinger
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> [1] <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2016-March/030188.html">http://twistedmatrix.com/pipermail/twisted-python/2016-March/030188.html</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20160726/e52151af/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20160726/e52151af/attachment.html</A>&gt;
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030637.html">[Twisted-Python] RFC: IPv6 multicast join/ticket 6597
</A></li>
	<LI>Next message: <A HREF="030654.html">[Twisted-Python] RFC: IPv6 multicast join/ticket 6597
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30642">[ date ]</a>
              <a href="thread.html#30642">[ thread ]</a>
              <a href="subject.html#30642">[ subject ]</a>
              <a href="author.html#30642">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
