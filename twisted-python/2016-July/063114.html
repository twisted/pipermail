<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Fixes for Twisted bindings in M2Crypto
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Fixes%20for%20Twisted%20bindings%20in%20M2Crypto&In-Reply-To=%3CCAG%3DrPVejnWDK9g8vQRqBuBPCWcqLFruSYEetc%3DMoN7938yx2wA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Fixes for Twisted bindings in M2Crypto</H1>
    <B>Craig Rodrigues</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Fixes%20for%20Twisted%20bindings%20in%20M2Crypto&In-Reply-To=%3CCAG%3DrPVejnWDK9g8vQRqBuBPCWcqLFruSYEetc%3DMoN7938yx2wA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Fixes for Twisted bindings in M2Crypto">rodrigc at crodrigues.org
       </A><BR>
    <I>Tue Jul 26 20:19:30 MDT 2016</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63114">[ date ]</a>
              <a href="thread.html#63114">[ thread ]</a>
              <a href="subject.html#63114">[ subject ]</a>
              <a href="author.html#63114">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Jul 26, 2016 at 8:47 AM, MatÄ›j Cepl &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mcepl at cepl.eu</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> I believe I have fixed all I can do without actually understanding Twisted
</I>&gt;<i> in
</I>&gt;<i> <A HREF="https://gitlab.com/mcepl/m2crypto/commit/6cd5f87b31e50016ebb7e44f3f2ae46610bc24e0.">https://gitlab.com/mcepl/m2crypto/commit/6cd5f87b31e50016ebb7e44f3f2ae46610bc24e0.</A>
</I>&gt;<i> So now, if Twisted is so transparent and perfectly understandable, could
</I>&gt;<i> you please suggest, what I do wrong, that the test ends in the endless loop
</I>&gt;<i> (<A HREF="https://travis-ci.org/mcepl/M2Crypto/builds/147175901">https://travis-ci.org/mcepl/M2Crypto/builds/147175901</A>)?
</I>&gt;<i>
</I>&gt;<i>
</I>
In your initial e-mail, it would have been useful if you could have
provided reproduction steps
for your problem.

Can you provide reproduction steps?

Since I wasn't sure, I took a guess.

I did the following inside a Python 3.6 virtual environment under OS X:

git clone <A HREF="https://gitlab.com/mcepl/m2crypto.git">https://gitlab.com/mcepl/m2crypto.git</A> m2crypto_test
cd m2crypto_test
git checkout python3
python setup.py build --openssl=/usr/local/opt/openssl
python setup.py bdist
python setup.py develop

py.test -v -s -k test_twisted_wrapper tests/test_ssl.py

I was able to reproduce the problem with something looping around:

DEBUG:_encrypt:self.data = &quot;b'GET / HTTP/1.0\n\n\r\n'&quot;
DEBUG:_decrypt:self.encrypted = &quot;b''&quot;
DEBUG:_encrypt:self.data = &quot;b'GET / HTTP/1.0\n\n\r\n'&quot;
DEBUG:_decrypt:self.encrypted = &quot;b''&quot;
DEBUG:_encrypt:self.data = &quot;b'GET / HTTP/1.0\n\n\r\n'&quot;
DEBUG:_decrypt:self.encrypted = &quot;b''&quot;
DEBUG:_encrypt:self.data = &quot;b'GET / HTTP/1.0\n\n\r\n'&quot;
DEBUG:_decrypt:self.encrypted = &quot;b''&quot;

I took a look in the M2Crypto code which interfaces with
Twisted, and found that the dataReceived() loop was never terminating
because dataReceived() takes bytes, but the code was
comparing to an emptry str.  So, the loop was never terminating.

I fixed this and other problems, and now the test_twisted_wrapper
passes on Python 3.  I submitted this merge request:

<A HREF="https://gitlab.com/mcepl/m2crypto/merge_requests/3/commits">https://gitlab.com/mcepl/m2crypto/merge_requests/3/commits</A>


While I was looking at the code, I also saw that the make_certs.py
utility does not work on Python 3.

I fixed that, and submitted this merge request:

<A HREF="https://gitlab.com/mcepl/m2crypto/merge_requests/4/commits">https://gitlab.com/mcepl/m2crypto/merge_requests/4/commits</A>

--
Craig
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20160726/ff9caa33/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63114">[ date ]</a>
              <a href="thread.html#63114">[ thread ]</a>
              <a href="subject.html#63114">[ subject ]</a>
              <a href="author.html#63114">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
