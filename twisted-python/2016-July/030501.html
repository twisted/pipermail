<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Coverage exceptions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Coverage%20exceptions&In-Reply-To=%3C449CFA03-C24F-453C-AE8C-FDB46A132246%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   <LINK REL="Next"  HREF="062963.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Coverage exceptions</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Coverage%20exceptions&In-Reply-To=%3C449CFA03-C24F-453C-AE8C-FDB46A132246%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Coverage exceptions">glyph at twistedmatrix.com
       </A><BR>
    <I>Fri Jul  1 00:08:55 MDT 2016</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="062963.html">[Twisted-Python] Coverage exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30501">[ date ]</a>
              <a href="thread.html#30501">[ thread ]</a>
              <a href="subject.html#30501">[ subject ]</a>
              <a href="author.html#30501">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Jun 30, 2016, at 17:36, Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On Thu, Jun 30, 2016 at 6:25 PM, Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On Jun 30, 2016, at 04:13, Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Thu, Jun 30, 2016 at 6:43 AM, Adi Roiban &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A>&gt;&gt; wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Recently we have introduced a hard check of 100% coverage for all changes.
</I>&gt;&gt;<i> This is done via coverage + codecov + github protected branches.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Now, if your patch is not 100% covered github will not let you merge it.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> See for example this change: <A HREF="https://github.com/twisted/twisted/pull/261/files#diff-0fea8a8ca713deb7ea6a10053273319aR2360">https://github.com/twisted/twisted/pull/261/files#diff-0fea8a8ca713deb7ea6a10053273319aR2360</A> &lt;<A HREF="https://github.com/twisted/twisted/pull/261/files#diff-0fea8a8ca713deb7ea6a10053273319aR2360">https://github.com/twisted/twisted/pull/261/files#diff-0fea8a8ca713deb7ea6a10053273319aR2360</A>&gt;
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The errback is there to help with test failures ... but the test should never fail, so that errback is never called... and that line is not covered.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> It doesn't always make sense to require 100% execution of all test code.  It's not at all uncommon to only have code in a test suite that runs when a test fails.  Historically, Twisted has never had a requirement of 100% execution of test code.  The only test suite coverage requirements that have commonly been requested or enforced is for coverage of implementation code.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I'd suggest removing the coverage enforcement for test suite code.
</I>&gt;<i> 
</I>&gt;<i> I am inclined to disagree, albeit mildly.
</I>&gt;<i> 
</I>&gt;<i> When one is writing a deliberately un-covered path in test code, presumably, one is writing either a test helper - a mock, fake, or utility for setting up a real implementation - or an assertion method.  Historically, I believe that when we've invested more heavily in making these utilities &quot;real&quot; themselves, and not just throwaway stuff inline in a test method or module, the benefits have far outweighed the costs.  In fact the availability of proto_helpers is one of the selling points of Twisted as opposed to other competing engines.
</I>&gt;<i> 
</I>&gt;<i> I mostly agree with this.  However, I was thinking of a slightly different pattern when I wrote my earlier email.  Here's are a couple (fictional) examples of that pattern one might find in unit tests for application code (and there's nothing Twisted-specific here):
</I>&gt;<i> 
</I>&gt;<i> if foo:
</I>&gt;<i>     self.fail(&quot;Foo!&quot;)
</I>&gt;<i> 
</I>&gt;<i> try:
</I>&gt;<i>     foo()
</I>&gt;<i> except:
</I>&gt;<i>     bar
</I>&gt;<i> else:
</I>&gt;<i>     self.fail(&quot;Foo :(&quot;)
</I>
Hm.  This pattern is exactly what I was thinking of though - as you point out, these examples did get generalized :-).

In principle, I agree that a one-off example like this does not benefit from extensive refactoring to facilitate general use.  But... in practice, every example of this that I've seen in a long-lived codebase eventually metastasizes into a repeated copy/paste pattern, or a big gross mixin that all tests practically need.  Forcing everyone to deal with the problem sooner rather than later seems to have been a win on the few projects where I've gotten to practice it.

&gt;<i> It's not exactly that this can't be code that's executed in a passing run of the test suite.  It's more a question of what the right balance point is.  If someone wants to generalize logic like this (and, fortunately, someone did generalize these particular examples - they're assertFalse and assertRaises, respectively) then that's great and the result is a higher level of confidence resulting from a successful run of the test suite.  I'd suggest that if tests like these exercise all of the implementation code (on a successful run), though, then you've still achieved a pretty high level of test coverage and maybe further efforts are more productively directed elsewhere (increasing the coverage level of other implementation code in Twisted, for example :).
</I>
Speaking only from my direct experience here, adding good test helpers is a net reduction in effort very quickly; they pay for themselves on only the third test you write with them :).  So I don't feel like this is much of a burden, but I'd be interested in hearing others' feedback here.

&gt;<i> If folks want a higher bar than this, I'm not going to argue (at least not much, at least not now).  The bar hasn't been this high in the past though (and there are many many such cases to be found in Twisted's test suite right now and I don't have the impression this has ever been much of a source of problems).
</I>
I wish it were easier to search my own reviews, because I think I've prodded people to factor this kind of stuff out, but I can't find any handy examples.

But, I can see that right after this, I'm going to have to answer Craig's email, so perhaps we'll get to see a specific example :).

&gt;<i> Therefore, I think that asking folks to add independent test coverage to verify their fakes and ensure that the failure-reporting of their assertion messages are helpful in the event a test fails is a generally good idea, and we should keep the requirement for 100% coverage on both test and implementation coverage.
</I>&gt;<i> 
</I>&gt;<i> However, if there is contention around this, I'd much rather get a ratchet in place for implementation code that's reliable and everyone is happy with, so I'm OK with disabling coverage reporting for our *.test.* packages as a step towards that.
</I>&gt;<i> 
</I>&gt;<i> I completely agree that fakes should be verified.  So much so that I'm not even sure I believe in fakes in general anymore.  Instead, you should just have easy to use interfaces and ship inexpensive implementations alongside whatever other implementations you also need.
</I>
&#128175;

&gt;<i> And all those implementations should have great test coverage.  I also completely agree that when tests fail, they should do so in a meaningful way.  I suspect slightly the implication that automated test coverage for the failure case demonstrates the failure is reported meaningfully, though. :)  I think we're still stuck with relying on humans (authors, reviewers) to verify that property.
</I>
Sure, rich and meaningful semantic error reporting is a human's job.  But &quot;doesn't just raise an exception and lose all the information about what happened due to an attribute spelling error on the rare race-y test that fails 1/10000 times&quot; is a good first approximation, and tests are good at that sort of thing ;-).

-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20160630/2fb16647/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20160630/2fb16647/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="062963.html">[Twisted-Python] Coverage exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30501">[ date ]</a>
              <a href="thread.html#30501">[ thread ]</a>
              <a href="subject.html#30501">[ subject ]</a>
              <a href="author.html#30501">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
