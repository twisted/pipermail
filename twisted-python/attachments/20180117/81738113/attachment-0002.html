<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;Jan&nbsp;17,&nbsp;2018,&nbsp;at&nbsp;1:09&nbsp;PM,&nbsp;Ilya&nbsp;Skriblovsky&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:ilyaskriblovsky@gmail.com&quot;&nbsp;class=&quot;&quot;&gt;ilyaskriblovsky@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;Hello,&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;I&nbsp;have&nbsp;the&nbsp;Twisted&nbsp;app&nbsp;that&nbsp;serves&nbsp;tons&nbsp;of&nbsp;short-lived&nbsp;TLS&nbsp;connections&nbsp;using&nbsp;TLSMemoryBIOFactory.&nbsp;I&nbsp;usually&nbsp;set&nbsp;loosened&nbsp;garbage&nbsp;collector&nbsp;thresholds&nbsp;in&nbsp;production&nbsp;environment&nbsp;for&nbsp;the&nbsp;sake&nbsp;of&nbsp;performance.&nbsp;But&nbsp;I've&nbsp;noticed&nbsp;that&nbsp;this&nbsp;app's&nbsp;RAM&nbsp;usage&nbsp;quickly&nbsp;grows&nbsp;up&nbsp;to&nbsp;unreasonable&nbsp;values.&nbsp;Digging&nbsp;into&nbsp;the&nbsp;issue&nbsp;using&nbsp;pdb&nbsp;and&nbsp;objgraph&nbsp;showed&nbsp;that&nbsp;protocol&nbsp;instances&nbsp;are&nbsp;still&nbsp;living&nbsp;long&nbsp;after&nbsp;they&nbsp;were&nbsp;closed.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;sounds&nbsp;like&nbsp;an&nbsp;issue&nbsp;that&nbsp;should&nbsp;be&nbsp;reported&nbsp;as&nbsp;a&nbsp;bug&nbsp;and&nbsp;fixed!&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;would&nbsp;be&nbsp;great&nbsp;if&nbsp;you&nbsp;could&nbsp;come&nbsp;up&nbsp;with&nbsp;a&nbsp;performance&nbsp;regression&nbsp;test&nbsp;or&nbsp;benchmark&nbsp;which&nbsp;could&nbsp;validate&nbsp;that&nbsp;this&nbsp;doesn't&nbsp;regress,&nbsp;but,&nbsp;it's&nbsp;quite&nbsp;challenging&nbsp;to&nbsp;do&nbsp;this&nbsp;(especially&nbsp;for&nbsp;memory&nbsp;issues)&nbsp;so&nbsp;as&nbsp;long&nbsp;as&nbsp;it's&nbsp;adequately&nbsp;behaviorally&nbsp;tested&nbsp;I'm&nbsp;sure&nbsp;we&nbsp;could&nbsp;accept&nbsp;something.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;I&nbsp;found&nbsp;two&nbsp;circular&nbsp;dependencies&nbsp;which&nbsp;are&nbsp;created&nbsp;for&nbsp;each&nbsp;TLS&nbsp;connection:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;1.&nbsp;Between&nbsp;twisted.protocols.policies.ProtocolWrapper&nbsp;and&nbsp;its&nbsp;self.wrappedProtocol&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;2.&nbsp;Between&nbsp;twisted.protocols.tls.TLSMemoryBIOProtocol&nbsp;and&nbsp;its&nbsp;self._tlsConnection&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Both&nbsp;of&nbsp;them&nbsp;cause&nbsp;protocol&nbsp;instance&nbsp;to&nbsp;not&nbsp;be&nbsp;deleted&nbsp;when&nbsp;the&nbsp;connection&nbsp;is&nbsp;closed.&nbsp;So&nbsp;all&nbsp;OpenSSL-related&nbsp;objects&nbsp;and&nbsp;all&nbsp;business-related&nbsp;data&nbsp;attached&nbsp;to&nbsp;that&nbsp;protocol&nbsp;instance&nbsp;are&nbsp;still&nbsp;living&nbsp;untill&nbsp;the&nbsp;next&nbsp;GC&nbsp;collection.&nbsp;This&nbsp;affects&nbsp;both&nbsp;RAM&nbsp;usage&nbsp;and&nbsp;performance&nbsp;(due&nbsp;to&nbsp;much&nbsp;more&nbsp;often&nbsp;GC&nbsp;collections)&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;I've&nbsp;tried&nbsp;to&nbsp;fix&nbsp;both&nbsp;circular&nbsp;dependencies:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;replaced&nbsp;&lt;a&nbsp;href=&quot;https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/policies.py#L75&quot;&nbsp;class=&quot;&quot;&gt;https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/policies.py#L75&lt;/a&gt;&nbsp;by&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;self.wrappedProtocol.makeConnection(weakref.proxy(self))&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;and&nbsp;replaced&nbsp;&lt;a&nbsp;href=&quot;https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/tls.py#L199&quot;&nbsp;class=&quot;&quot;&gt;https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/tls.py#L199&lt;/a&gt;&nbsp;by:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;self._tlsConnection&nbsp;=&nbsp;self.factory._createConnection(weakref.proxy(self))&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Memory&nbsp;usage&nbsp;pattern&nbsp;changed&nbsp;drastically&nbsp;after&nbsp;this&nbsp;change.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;I've&nbsp;created&nbsp;demo&nbsp;script&nbsp;that&nbsp;makes&nbsp;10k&nbsp;TLS&nbsp;loopback&nbsp;connections&nbsp;with&nbsp;GC&nbsp;disabled&nbsp;and&nbsp;measures&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;are&nbsp;still&nbsp;living&nbsp;after&nbsp;the&nbsp;work&nbsp;is&nbsp;done&nbsp;and&nbsp;total&nbsp;resident&nbsp;RAM&nbsp;consumption:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;a&nbsp;href=&quot;https://gist.github.com/IlyaSkriblovsky/4dd3abfd5f67c64b13f1c673f56466f9&quot;&nbsp;class=&quot;&quot;&gt;https://gist.github.com/IlyaSkriblovsky/4dd3abfd5f67c64b13f1c673f56466f9&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Output&nbsp;without&nbsp;the&nbsp;fix:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;N&nbsp;=&nbsp;10000&nbsp;,&nbsp;K&nbsp;=&nbsp;100&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;before&nbsp;50136&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;DummyServerProtocols&nbsp;still&nbsp;living&nbsp;10000&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;after&nbsp;439919&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;mem&nbsp;778&nbsp;mb&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Output&nbsp;with&nbsp;the&nbsp;fix:&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;N&nbsp;=&nbsp;10000&nbsp;,&nbsp;K&nbsp;=&nbsp;100&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;before&nbsp;50133&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;DummyServerProtocols&nbsp;still&nbsp;living&nbsp;0&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;objects&nbsp;after&nbsp;159919&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;mem&nbsp;96&nbsp;mb&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;So&nbsp;using&nbsp;weakrefs&nbsp;makes&nbsp;all&nbsp;protocol&nbsp;instances&nbsp;and&nbsp;instances&nbsp;of&nbsp;TLSMemoryBIOProtocol&nbsp;to&nbsp;be&nbsp;deleted&nbsp;right&nbsp;after&nbsp;a&nbsp;connection&nbsp;is&nbsp;closed.&nbsp;Less&nbsp;circular-dependent&nbsp;objects&nbsp;→&nbsp;less&nbsp;GC&nbsp;invocations&nbsp;→&nbsp;better&nbsp;performance.&nbsp;And&nbsp;I&nbsp;see&nbsp;much&nbsp;nicer&nbsp;RAM&nbsp;usage&nbsp;pattern&nbsp;in&nbsp;my&nbsp;app.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Hooray!&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Is&nbsp;it&nbsp;possible&nbsp;to&nbsp;fix&nbsp;circular&nbsp;deps&nbsp;in&nbsp;some&nbsp;more&nbsp;clean&nbsp;way?&nbsp;Can&nbsp;this&nbsp;be&nbsp;solved&nbsp;at&nbsp;all&nbsp;while&nbsp;user's&nbsp;code&nbsp;is&nbsp;able&nbsp;to&nbsp;try&nbsp;to&nbsp;touch&nbsp;both&nbsp;sides&nbsp;of&nbsp;circular&nbsp;dep&nbsp;after&nbsp;connection&nbsp;is&nbsp;closed?&nbsp;Please&nbsp;advice&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Protocols&nbsp;and&nbsp;transports&nbsp;have&nbsp;a&nbsp;fairly&nbsp;defined&nbsp;lifecycle,&nbsp;and&nbsp;as&nbsp;L.&nbsp;Daniel&nbsp;Burr&nbsp;already&nbsp;pointed&nbsp;out,&nbsp;it&nbsp;would&nbsp;probably&nbsp;be&nbsp;appropriate&nbsp;to&nbsp;explicitly&nbsp;break&nbsp;these&nbsp;reference&nbsp;cycles&nbsp;in&nbsp;connectionLost.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;-g&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Thanks&nbsp;for&nbsp;consideration&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Best&nbsp;regards,&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;Ilya&lt;/div&gt;&lt;/div&gt;<br>
_______________________________________________&lt;br&nbsp;class=&quot;&quot;&gt;Twisted-Python&nbsp;mailing&nbsp;list&lt;br&nbsp;class=&quot;&quot;&gt;&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&nbsp;class=&quot;&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
