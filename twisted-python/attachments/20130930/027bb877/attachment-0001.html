<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hi&nbsp;everyone,&lt;br&gt;&lt;br&gt;&lt;br&gt;I&nbsp;think&nbsp;I&#39;ve&nbsp;hit&nbsp;one&nbsp;of&nbsp;those&nbsp;cases&nbsp;where&nbsp;AMP&nbsp;really&nbsp;seems&nbsp;to&nbsp;want&nbsp;everything&nbsp;(locator,&nbsp;receiver,&nbsp;sender)&nbsp;to&nbsp;be&nbsp;an&nbsp;instance&nbsp;of&nbsp;t.p.amp.AMP&nbsp;:-(&lt;br&gt;&lt;br&gt;&lt;/div&gt;I&#39;ve&nbsp;written&nbsp;some&nbsp;code&nbsp;that&nbsp;tries&nbsp;to&nbsp;multiplex&nbsp;stream&nbsp;transports&nbsp;over&nbsp;AMP:&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;a&nbsp;href=&quot;https://github.com/lvh/txampext/blob/multiplexing/txampext/multiplexing.py&quot;&gt;https://github.com/lvh/txampext/blob/multiplexing/txampext/multiplexing.py&lt;/a&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;The&nbsp;repo&nbsp;contains&nbsp;an&nbsp;example&nbsp;server&nbsp;and&nbsp;client,&nbsp;which&nbsp;demonstrate&nbsp;the&nbsp;issue:&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;a&nbsp;href=&quot;https://github.com/lvh/txampext/blob/multiplexing/docs/examples/multiplexing_client.py&quot;&gt;https://github.com/lvh/txampext/blob/multiplexing/docs/examples/multiplexing_client.py&lt;/a&gt;&lt;br&gt;&lt;a&nbsp;href=&quot;https://github.com/lvh/txampext/blob/multiplexing/docs/examples/multiplexing_server.py&quot;&gt;https://github.com/lvh/txampext/blob/multiplexing/docs/examples/multiplexing_server.py&lt;/a&gt;&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;In&nbsp;order&nbsp;to&nbsp;do&nbsp;some&nbsp;of&nbsp;this&nbsp;multiplexing,&nbsp;I&nbsp;need&nbsp;access&nbsp;to&nbsp;the&nbsp;protocol&nbsp;instance&nbsp;inside&nbsp;the&nbsp;responder&nbsp;on&nbsp;the&nbsp;server&nbsp;side.&nbsp;Fortunately,&nbsp;I&nbsp;already&nbsp;had&nbsp;some&nbsp;code&nbsp;that&nbsp;exposed&nbsp;box&nbsp;senders&nbsp;(after&nbsp;a&nbsp;lot&nbsp;of&nbsp;advice&nbsp;from&nbsp;Glyph).&nbsp;I&nbsp;modified&nbsp;it&nbsp;to&nbsp;expose&nbsp;the&nbsp;protocol&nbsp;as&nbsp;well:&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;a&nbsp;href=&quot;https://github.com/lvh/txampext/blob/multiplexing/txampext/exposed.py#L41&quot;&gt;https://github.com/lvh/txampext/blob/multiplexing/txampext/exposed.py#L41&lt;/a&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;However,&nbsp;it&nbsp;turns&nbsp;out&nbsp;fromBox&nbsp;gets&nbsp;called&nbsp;with&nbsp;the&nbsp;*responder&nbsp;locator*&nbsp;as&nbsp;the&nbsp;&quot;proto&quot;&nbsp;argument,&nbsp;not&nbsp;the&nbsp;actual&nbsp;protocol.&lt;br&gt;<br>
<br>
&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;server&nbsp;has&nbsp;a&nbsp;pudb&nbsp;call&nbsp;that&nbsp;makes&nbsp;it&nbsp;easy&nbsp;(?!)&nbsp;to&nbsp;trace&nbsp;this&nbsp;down.&nbsp;The&nbsp;CommandLocator&nbsp;class,&nbsp;inside&nbsp;doit&nbsp;(a&nbsp;function&nbsp;defined&nbsp;in&nbsp;_wrapWithSerialization)&nbsp;passes&nbsp;&quot;self&quot;&nbsp;to&nbsp;command.parseArguments:&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/trac/browser/trunk/twisted/protocols/amp.py#L1015&quot;&gt;https://twistedmatrix.com/trac/browser/trunk/twisted/protocols/amp.py#L1015&lt;/a&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;the&nbsp;part&nbsp;where&nbsp;I&nbsp;think&nbsp;the&nbsp;contract&nbsp;is&nbsp;broken,&nbsp;since&nbsp;parseArguments&nbsp;claims&nbsp;to&nbsp;want&nbsp;the&nbsp;protocol&nbsp;(well,&nbsp;it&nbsp;says&nbsp;it&nbsp;wants&nbsp;the&nbsp;AMP&nbsp;protocol,&nbsp;which,&nbsp;subclassing&nbsp;everything,&nbsp;is&nbsp;also&nbsp;all&nbsp;of&nbsp;the&nbsp;things,&nbsp;of&nbsp;course),&nbsp;but&nbsp;receives&nbsp;the&nbsp;responder&nbsp;locator.&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;am&nbsp;I&nbsp;doing&nbsp;wrong?&nbsp;Is&nbsp;this&nbsp;a&nbsp;bug?&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;confusedly,&lt;br&gt;lvh&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
