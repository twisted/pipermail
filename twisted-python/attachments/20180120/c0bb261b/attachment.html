<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Yes,&nbsp;doing&nbsp;it&nbsp;only&nbsp;for&nbsp;TLSMemoryBIOProtocol&nbsp;fails&nbsp;test&nbsp;too&nbsp;:(&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;SSL-related&nbsp;seem&nbsp;to&nbsp;be&nbsp;touching&nbsp;both&nbsp;ends&nbsp;of&nbsp;this&nbsp;reference&nbsp;cycle&nbsp;after&nbsp;connectionLost:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1. twisted/test/test_sslverify.py:2102&lt;/div&gt;&lt;div&gt;self.assertEqual(sProto.wrappedProtocol.data,&nbsp;b&#39;&#39;)&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;one&nbsp;touches&nbsp;`wrappedProtocol`&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2. twisted/test/proto_helpers.py:924&nbsp;(waitUntilAllDisconnected,&nbsp;used&nbsp;by&nbsp;twisted.web.test.test_webclient.WebClientSSLTests,&nbsp;for&nbsp;example)&lt;/div&gt;&lt;div&gt;if&nbsp;not&nbsp;True&nbsp;in&nbsp;[x.transport&nbsp;is&nbsp;not&nbsp;None&nbsp;and&nbsp;x.transport.connected&nbsp;for&nbsp;x&nbsp;in&nbsp;protocols]:&lt;/div&gt;&lt;div&gt;and&nbsp;this&nbsp;one&nbsp;touches&nbsp;`transport`&nbsp;field&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;are&nbsp;other&nbsp;examples&nbsp;as&nbsp;well.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Sure,&nbsp;these&nbsp;test&nbsp;failures&nbsp;can&nbsp;probably&nbsp;be&nbsp;fixed&nbsp;by&nbsp;changing&nbsp;tests&nbsp;themselves,&nbsp;for&nbsp;example&nbsp;by&nbsp;making&nbsp;them&nbsp;to&nbsp;hold&nbsp;their&nbsp;own&nbsp;references&nbsp;to&nbsp;both&nbsp;wrapping&nbsp;and&nbsp;wrapped&nbsp;protocols.&nbsp;But&nbsp;I&#39;m&nbsp;not&nbsp;sure&nbsp;this&nbsp;wouldn&#39;t&nbsp;break&nbsp;any&nbsp;user&#39;s&nbsp;code&nbsp;too...&nbsp;For&nbsp;my&nbsp;app&nbsp;it&nbsp;was&nbsp;easily&nbsp;fixed&nbsp;by&nbsp;breaking&nbsp;cycle&nbsp;in&nbsp;my&nbsp;protocol&#39;s&nbsp;connectionLost.&nbsp;But&nbsp;I&#39;m&nbsp;not&nbsp;experienced&nbsp;enough&nbsp;in&nbsp;Twisted&nbsp;internals&nbsp;to&nbsp;be&nbsp;sure&nbsp;doing&nbsp;it&nbsp;inside&nbsp;TLSMemoryBIOProtocol&nbsp;wouldn&#39;t&nbsp;break&nbsp;any&nbsp;real-world&nbsp;usage&nbsp;scenarios.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;Ilya&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;сб,&nbsp;20&nbsp;янв.&nbsp;2018&nbsp;г.&nbsp;в&nbsp;9:10,&nbsp;Glyph&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:glyph@twistedmatrix.com&quot;&gt;glyph@twistedmatrix.com&lt;/a&gt;&gt;:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;On&nbsp;Jan&nbsp;19,&nbsp;2018,&nbsp;at&nbsp;11:52&nbsp;AM,&nbsp;Ilya&nbsp;Skriblovsky&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:ilyaskriblovsky@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;ilyaskriblovsky@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;Protocols&nbsp;and&nbsp;transports&nbsp;have&nbsp;a&nbsp;fairly&nbsp;defined&nbsp;lifecycle,&nbsp;and&nbsp;as&nbsp;L.&nbsp;Daniel&nbsp;Burr&nbsp;already&nbsp;pointed&nbsp;out,&nbsp;it&nbsp;would&nbsp;probably&nbsp;be&nbsp;appropriate&nbsp;to&nbsp;explicitly&nbsp;break&nbsp;these&nbsp;reference&nbsp;cycles&nbsp;in&nbsp;connectionLost.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Explicitly&nbsp;breaking&nbsp;cycle&nbsp;in&nbsp;ProtocolWrapper.connectionLost&nbsp;by&nbsp;any&nbsp;of:&lt;br&gt;<br>
&gt;&nbsp;•&nbsp;self.wrappedProtocol&nbsp;=&nbsp;None&lt;br&gt;<br>
&gt;&nbsp;•&nbsp;self.wrappedProtocol.transport&nbsp;=&nbsp;None&lt;br&gt;<br>
&gt;&nbsp;•&nbsp;self.wrappedProtocol&nbsp;=&nbsp;weakref.proxy(self.wrappedProtocol)&lt;br&gt;<br>
&gt;&nbsp;•&nbsp;self.wrappedProtocol.transport&nbsp;=&nbsp;weakref.proxy(self)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;...&nbsp;breaks&nbsp;some&nbsp;existing&nbsp;tests&nbsp;:(&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Seems&nbsp;like&nbsp;these&nbsp;tests&nbsp;do&nbsp;some&nbsp;post-run&nbsp;checks&nbsp;against&nbsp;protocol&nbsp;instances&nbsp;and&nbsp;their&nbsp;transports.&nbsp;Not&nbsp;sure&nbsp;whether&nbsp;it&nbsp;is&nbsp;relevant&nbsp;to&nbsp;real-life&nbsp;usage.&lt;br&gt;<br>
&gt;&nbsp;Will&nbsp;investigate&nbsp;more...&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;-&nbsp;Ilya&lt;br&gt;<br>
&lt;br&gt;<br>
Do&nbsp;these&nbsp;tests&nbsp;fail&nbsp;if&nbsp;you&nbsp;only&nbsp;do&nbsp;it&nbsp;in&nbsp;TLSMemoryBIOProtocol&nbsp;instead&nbsp;of&nbsp;WrapperProtocol?&lt;br&gt;<br>
&lt;br&gt;<br>
If&nbsp;so,&nbsp;this&nbsp;may&nbsp;be&nbsp;worth&nbsp;a&nbsp;compatibility&nbsp;exception.&lt;br&gt;<br>
&lt;br&gt;<br>
-g&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
