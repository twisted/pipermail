<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;3.2//EN&quot;&gt;<br>
&lt;HTML&gt;<br>
&lt;HEAD&gt;<br>
&lt;META&nbsp;HTTP-EQUIV=&quot;Content-Type&quot;&nbsp;CONTENT=&quot;text/html;&nbsp;charset=iso-8859-1&quot;&gt;<br>
&lt;META&nbsp;NAME=&quot;Generator&quot;&nbsp;CONTENT=&quot;MS&nbsp;Exchange&nbsp;Server&nbsp;version&nbsp;6.5.7638.1&quot;&gt;<br>
&lt;TITLE&gt;web.client&nbsp;blowing&nbsp;up&nbsp;on&nbsp;non-fully&nbsp;qualified&nbsp;301s&lt;/TITLE&gt;<br>
&lt;/HEAD&gt;<br>
&lt;BODY&gt;<br>
&lt;!--&nbsp;Converted&nbsp;from&nbsp;text/plain&nbsp;format&nbsp;--&gt;<br>
<br>
&lt;P&gt;&lt;FONT&nbsp;SIZE=2&gt;Hello,&lt;BR&gt;<br>
&lt;BR&gt;<br>
I&nbsp;have&nbsp;run&nbsp;into&nbsp;an&nbsp;odd&nbsp;problem.&amp;nbsp;&nbsp;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;if&nbsp;it&nbsp;is&nbsp;my&nbsp;issue&nbsp;or&nbsp;Twisted:&nbsp;any&nbsp;help&nbsp;would&nbsp;be&nbsp;appreciated.&amp;nbsp;&nbsp;Under&nbsp;at&nbsp;least&nbsp;some&nbsp;circumstances,&nbsp;twisted.web.client&nbsp;seems&nbsp;to&nbsp;1)&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;follow&nbsp;a&nbsp;301,&nbsp;and&nbsp;2)&nbsp;throw&nbsp;an&nbsp;unhandled&nbsp;exception,&nbsp;when&nbsp;trying&nbsp;to&nbsp;follow&nbsp;a&nbsp;301.&amp;nbsp;&nbsp;A&nbsp;specific&nbsp;example&nbsp;and&nbsp;resulting&nbsp;error&nbsp;is&nbsp;given&nbsp;below:&lt;BR&gt;<br>
&lt;BR&gt;<br>
&lt;BR&gt;<br>
from&nbsp;twisted.internet&nbsp;import&nbsp;defer&lt;BR&gt;<br>
from&nbsp;twisted.web&nbsp;import&nbsp;client&lt;BR&gt;<br>
from&nbsp;twisted.internet&nbsp;import&nbsp;reactor&lt;BR&gt;<br>
&lt;BR&gt;<br>
class&nbsp;HTTPGetter(client.HTTPClientFactory):&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;protocol&nbsp;=&nbsp;client.HTTPPageGetter&lt;BR&gt;<br>
&lt;BR&gt;<br>
class&nbsp;Fetcher:&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;__init__(self,client_factory&nbsp;=&nbsp;HTTPGetter):&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.factory&nbsp;=&nbsp;client_factory&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;download(self,host,port,url):&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;f&nbsp;=&nbsp;self.factory(url)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;f.deferred.addCallback(self.downloadFinished).addErrback(self.downloadFailed)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;k&nbsp;=&nbsp;reactor.connectTCP(host,&nbsp;port,&nbsp;f,&nbsp;timeout=10)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;f.deferred&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;downloadFinished(self,v):&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;print&amp;nbsp;&nbsp;&amp;quot;good&amp;quot;&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;downloadFailed(self,&nbsp;v):&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;print&nbsp;&amp;quot;bad&amp;quot;&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;print&nbsp;v&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;BR&gt;<br>
r&nbsp;=&nbsp;Fetcher()&lt;BR&gt;<br>
w&nbsp;=&nbsp;r.download(&amp;quot;www.shopzilla.com&amp;quot;,80,&amp;quot;/aaaa&amp;quot;)&lt;BR&gt;<br>
reactor.callLater(10,reactor.stop)&lt;BR&gt;<br>
reactor.run()&lt;BR&gt;<br>
&lt;BR&gt;<br>
This&nbsp;results&nbsp;in:&lt;BR&gt;<br>
&lt;BR&gt;<br>
Unhandled&nbsp;error&nbsp;in&nbsp;Deferred:&lt;BR&gt;<br>
Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;BR&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/local/lib/python2.4/site-packages/twisted/internet/posixbase.py&amp;quot;,&nbsp;line&nbsp;226,&nbsp;in&nbsp;mainLoop&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.runUntilCurrent()&lt;BR&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/local/lib/python2.4/site-packages/twisted/internet/base.py&amp;quot;,&nbsp;line&nbsp;541,&nbsp;in&nbsp;runUntilCurrent&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;call.func(*call.args,&nbsp;**call.kw)&lt;BR&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/local/lib/python2.4/site-packages/twisted/internet/tcp.py&amp;quot;,&nbsp;line&nbsp;494,&nbsp;in&nbsp;resolveAddress&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;d.addCallbacks(self._setRealAddress,&nbsp;self.failIfNotConnected)&lt;BR&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/local/lib/python2.4/site-packages/twisted/internet/defer.py&amp;quot;,&nbsp;line&nbsp;182,&nbsp;in&nbsp;addCallbacks&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self._runCallbacks()&lt;BR&gt;<br>
---&nbsp;&amp;lt;exception&nbsp;caught&nbsp;here&amp;gt;&nbsp;---&lt;BR&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/local/lib/python2.4/site-packages/twisted/internet/defer.py&amp;quot;,&nbsp;line&nbsp;307,&nbsp;in&nbsp;_runCallbacks&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.result&nbsp;=&nbsp;callback(self.result,&nbsp;*args,&nbsp;**kw)&lt;BR&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/local/lib/python2.4/site-packages/twisted/internet/tcp.py&amp;quot;,&nbsp;line&nbsp;498,&nbsp;in&nbsp;_setRealAddress&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.doConnect()&lt;BR&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/local/lib/python2.4/site-packages/twisted/internet/tcp.py&amp;quot;,&nbsp;line&nbsp;520,&nbsp;in&nbsp;doConnect&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;connectResult&nbsp;=&nbsp;self.socket.connect_ex(self.realAddress)&lt;BR&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;&amp;lt;string&amp;gt;&amp;quot;,&nbsp;line&nbsp;1,&nbsp;in&nbsp;connect_ex&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;BR&gt;<br>
exceptions.TypeError:&nbsp;an&nbsp;integer&nbsp;is&nbsp;required&lt;BR&gt;<br>
&lt;BR&gt;<br>
Which&nbsp;is&nbsp;apparently&nbsp;due&nbsp;to&nbsp;the&nbsp;fact&nbsp;that&nbsp;doConnect&nbsp;assumes&nbsp;a&nbsp;good&nbsp;address&nbsp;and&nbsp;so&nbsp;does&nbsp;not&nbsp;trap&nbsp;for&nbsp;TypeError.&lt;BR&gt;<br>
&lt;BR&gt;<br>
The&nbsp;bad&nbsp;address&nbsp;that&nbsp;doConnect&nbsp;blows&nbsp;up&nbsp;on&nbsp;('',None)&nbsp;for&nbsp;(host,port)&nbsp;slips&nbsp;in&nbsp;due&nbsp;to&nbsp;twisted.web.client.handleStatus_301.&amp;nbsp;&amp;nbsp;&nbsp;The&nbsp;example&nbsp;site&nbsp;(Shopzilla.com)&nbsp;posts&nbsp;a&nbsp;URL&nbsp;for&nbsp;the&nbsp;301&nbsp;Location&nbsp;that&nbsp;is&nbsp;not&nbsp;fully&nbsp;qualified.&amp;nbsp;&nbsp;handleStatus_301,&nbsp;in&nbsp;the&nbsp;face&nbsp;of&nbsp;such&nbsp;a&nbsp;URL,&nbsp;appears&nbsp;to&nbsp;fail&nbsp;because&nbsp;it&nbsp;relies&nbsp;on&nbsp;getting&nbsp;the&nbsp;host/port&nbsp;from&nbsp;the&nbsp;location&nbsp;URL,&nbsp;but&nbsp;these&nbsp;are&nbsp;not&nbsp;present&nbsp;in&nbsp;it.&amp;nbsp;&nbsp;Thus&nbsp;it&nbsp;passes&nbsp;in&nbsp;the&nbsp;('',None)&nbsp;to&nbsp;its&nbsp;reactor.connectTCP&nbsp;attempt&nbsp;to&nbsp;follow&nbsp;the&nbsp;redirect,&nbsp;leading&nbsp;to&nbsp;the&nbsp;error&nbsp;above.&amp;nbsp;&nbsp;My&nbsp;kludge&nbsp;fix&nbsp;to&nbsp;handleStatus_301&nbsp;is&nbsp;given&nbsp;below,&nbsp;where&nbsp;if&nbsp;the&nbsp;host&nbsp;or&nbsp;port&nbsp;are&nbsp;missing&nbsp;I&nbsp;steal&nbsp;them&nbsp;from&nbsp;the&nbsp;transport,&nbsp;which&nbsp;should&nbsp;be&nbsp;correct&nbsp;since&nbsp;it&nbsp;was&nbsp;just&nbsp;used&nbsp;to&nbsp;get&nbsp;the&nbsp;page.&amp;nbsp;&nbsp;I&nbsp;am&nbsp;running&nbsp;with&nbsp;this&nbsp;now,&nbsp;with&nbsp;no&nbsp;errors.&lt;BR&gt;<br>
&lt;BR&gt;<br>
Is&nbsp;this&nbsp;a&nbsp;Twisted&nbsp;issue?&amp;nbsp;&nbsp;If&nbsp;so,&nbsp;is&nbsp;my&nbsp;fix&nbsp;reasonable?&amp;nbsp;&nbsp;If&nbsp;it&nbsp;is&nbsp;not&nbsp;a&nbsp;Twisted&nbsp;issue,&nbsp;what&nbsp;am&nbsp;I&nbsp;doing&nbsp;wrong?&amp;nbsp;&lt;BR&gt;<br>
&lt;BR&gt;<br>
Thanks,&lt;BR&gt;<br>
&lt;BR&gt;<br>
Keith&lt;BR&gt;<br>
&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;handleStatus_301(self):&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;l&nbsp;=&nbsp;self.headers.get('location')&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;not&nbsp;l:&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.handleStatusDefault()&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;url&nbsp;=&nbsp;l[0]&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;self.followRedirect:&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;scheme,&nbsp;host,&nbsp;port,&nbsp;path&nbsp;=&nbsp;\&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;_parse(url,&nbsp;defaultPort=self.transport.getPeer().port)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.factory.setURL(url)&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;#following&nbsp;4&nbsp;lines&nbsp;added&nbsp;kad&nbsp;to&nbsp;fix&nbsp;apparent&nbsp;issue&nbsp;with&nbsp;301&nbsp;to&nbsp;a&nbsp;url&nbsp;that&nbsp;is&nbsp;not&nbsp;fully&nbsp;qualified&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;self.factory.host&nbsp;==&nbsp;'':&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.factory.host&nbsp;=&nbsp;self.transport.addr[0]&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;if&nbsp;self.factory.port&nbsp;==&nbsp;None:&lt;BR&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.factory.port&nbsp;=&nbsp;self.transport.addr[1]&lt;BR&gt;<br>
&lt;BR&gt;<br>
&lt;BR&gt;<br>
&lt;/FONT&gt;<br>
&lt;/P&gt;<br>
<br>
&lt;/BODY&gt;<br>
&lt;/HTML&gt;
</tt>
