<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;On&nbsp;Wed,&nbsp;Feb&nbsp;27,&nbsp;2019&nbsp;at&nbsp;9:34&nbsp;AM&nbsp;Scott,&nbsp;Barry&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:barry.scott@forcepoint.com&quot;&nbsp;target=&quot;_blank&quot;&gt;barry.scott@forcepoint.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;On&nbsp;Tuesday,&nbsp;26&nbsp;February&nbsp;2019&nbsp;06:34:28&nbsp;GMT&nbsp;Glyph&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;On&nbsp;Feb&nbsp;25,&nbsp;2019,&nbsp;at&nbsp;3:32&nbsp;AM,&nbsp;Scott,&nbsp;Barry&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:barry.scott@forcepoint.com&quot;&nbsp;target=&quot;_blank&quot;&gt;barry.scott@forcepoint.com&lt;/a&gt;&gt;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;wrote:&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;On&nbsp;Tuesday,&nbsp;19&nbsp;February&nbsp;2019&nbsp;11:00:57&nbsp;GMT&nbsp;Chris&nbsp;Withers&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;&gt;&gt;&nbsp;Hi&nbsp;All,&lt;br&gt;<br>
&gt;&nbsp;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&gt;&nbsp;There&#39;s&nbsp;this&nbsp;assert:&lt;br&gt;<br>
&gt;&nbsp;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&gt;&nbsp;&lt;a&nbsp;href=&quot;https://github.com/twisted/twisted/blob/trunk/src/twisted/internet/defer&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/twisted/twisted/blob/trunk/src/twisted/internet/defer&lt;/a&gt;.&lt;br&gt;<br>
&gt;&nbsp;&gt;&gt;&nbsp;py#&nbsp;L459&lt;br&gt;<br>
&gt;&nbsp;&gt;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&gt;&nbsp;...and&nbsp;I&#39;d&nbsp;like&nbsp;to&nbsp;understand&nbsp;why&nbsp;it&#39;s&nbsp;there.&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;We&nbsp;hit&nbsp;this&nbsp;assert&nbsp;when&nbsp;porting&nbsp;from&nbsp;very&nbsp;old&nbsp;twisted&nbsp;to&nbsp;current&nbsp;twisted.&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;In&nbsp;all&nbsp;cases&nbsp;the&nbsp;problem&nbsp;was&nbsp;with&nbsp;our&nbsp;code&nbsp;that&nbsp;used&nbsp;deferreds&nbsp;in&nbsp;a&nbsp;poor,&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;not&nbsp;well&nbsp;understood&nbsp;way.&nbsp;After&nbsp;refactoring&nbsp;we&nbsp;are&nbsp;a&nbsp;lot&nbsp;happier&nbsp;with&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;&gt;&nbsp;resulting&nbsp;code&nbsp;as&nbsp;it&nbsp;easier&nbsp;to&nbsp;maintain&nbsp;now.&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;Thanks&nbsp;for&nbsp;the&nbsp;feedback,&nbsp;Barry!&lt;br&gt;<br>
&gt;&nbsp;&lt;br&gt;<br>
&gt;&nbsp;It&nbsp;would&nbsp;still&nbsp;be&nbsp;great&nbsp;to&nbsp;figure&nbsp;out,&nbsp;if&nbsp;we&nbsp;can,&nbsp;how&nbsp;we&nbsp;might&nbsp;make&nbsp;the&lt;br&gt;<br>
&gt;&nbsp;error&nbsp;message&nbsp;a&nbsp;bit&nbsp;more&nbsp;legible&nbsp;to&nbsp;folks&nbsp;with&nbsp;less&nbsp;knowledge&nbsp;of&nbsp;Twisted&#39;s&lt;br&gt;<br>
&gt;&nbsp;internals.&lt;br&gt;<br>
&lt;br&gt;<br>
Let&nbsp;suppose&nbsp;that&nbsp;I&nbsp;need&nbsp;work&nbsp;done&nbsp;by&nbsp;doWork&nbsp;function.&lt;br&gt;<br>
It&nbsp;returns&nbsp;a&nbsp;deferred&nbsp;for&nbsp;me&nbsp;to&nbsp;hang&nbsp;call&nbsp;backs&nbsp;and&nbsp;error&nbsp;backs&nbsp;on.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;d&nbsp;=&nbsp;doWork()&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;d.addCallback(handleWorkDone)&lt;br&gt;<br>
&lt;br&gt;<br>
In&nbsp;my&nbsp;handleWorkDone&nbsp;I&nbsp;expect&nbsp;to&nbsp;get&nbsp;the&nbsp;result&nbsp;of&nbsp;doWork&nbsp;completing.&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;assert&nbsp;fires&nbsp;if&nbsp;instead&nbsp;of&nbsp;a&nbsp;result&nbsp;value&nbsp;is&nbsp;returned&nbsp;a&nbsp;Deferred&nbsp;is&nbsp;&lt;br&gt;<br>
returned.&nbsp;This&nbsp;I&nbsp;consider&nbsp;a&nbsp;bug&nbsp;in&nbsp;the&nbsp;doWork()&nbsp;implementation.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;doesn&#39;t&nbsp;sound&nbsp;right. &nbsp;Can&nbsp;you&nbsp;provide&nbsp;an&nbsp;example&nbsp;implementation&nbsp;of&nbsp;doWork&nbsp;that&nbsp;provokes&nbsp;this&nbsp;behavior? &nbsp;Here&#39;s&nbsp;an&nbsp;implementation&nbsp;that&nbsp;seems&nbsp;like&nbsp;it&nbsp;matches&nbsp;your&nbsp;description&nbsp;and&nbsp;which&nbsp;does&nbsp;not&nbsp;provoke&nbsp;the&nbsp;behavior:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;def&nbsp;doWork():&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;d&nbsp;=&nbsp;Deferred()&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;d.callback(&quot;result&quot;)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;d&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;d&nbsp;=&nbsp;doWork()&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;d.addCallback(handleWorkDone)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;doesn&#39;t&nbsp;trigger&nbsp;the&nbsp;assert. &nbsp;This&nbsp;calls&nbsp;handleWorkDone&nbsp;with&nbsp;&quot;result&quot;. &nbsp;If&nbsp;you&nbsp;simplify&nbsp;the&nbsp;code&nbsp;so&nbsp;the&nbsp;Deferred&nbsp;interaction&nbsp;remains&nbsp;the&nbsp;same&nbsp;but&nbsp;all&nbsp;the&nbsp;extraneous&nbsp;code&nbsp;is&nbsp;removed,&nbsp;it&nbsp;looks&nbsp;like&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;d&nbsp;=&nbsp;Deferred()&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;d.callback(&quot;result&quot;)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;d.addCallback(handleWorkDone)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;which&nbsp;&lt;b&gt;must&lt;/b&gt; work&nbsp;or&nbsp;Deferred&nbsp;is&nbsp;completely&nbsp;useless.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Jean-Paul&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&lt;br&gt;<br>
What&nbsp;must&nbsp;happen&nbsp;in&nbsp;doWork&nbsp;is&nbsp;that&nbsp;it&nbsp;must&nbsp;arrange&nbsp;that&lt;br&gt;<br>
any&nbsp;Deferred&nbsp;it&nbsp;used&nbsp;internally&nbsp;has&nbsp;an&nbsp;addCallback&nbsp;used&nbsp;to&lt;br&gt;<br>
cause&nbsp;the&nbsp;d&nbsp;returned&nbsp;to&nbsp;the&nbsp;user&nbsp;to&nbsp;complete.&nbsp;Leaking&nbsp;the&lt;br&gt;<br>
any&nbsp;internal&nbsp;Deferred()&nbsp;objects&nbsp;must&nbsp;not&nbsp;happen&nbsp;to&nbsp;the&nbsp;user&lt;br&gt;<br>
of&nbsp;doWork.&lt;br&gt;<br>
&lt;br&gt;<br>
def&nbsp;doWork():&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;d&nbsp;=&nbsp;Deferred()&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;def&nbsp;completeWork(result,&nbsp;d):&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;d.callback(result)&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;inner_d&nbsp;=&nbsp;doAsyncWork()&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;inner_d.addCallback(completeWork,&nbsp;d)&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;d&lt;br&gt;<br>
&lt;br&gt;<br>
The&nbsp;error&nbsp;message&nbsp;would&nbsp;need&nbsp;to&nbsp;say&nbsp;something&nbsp;like:&lt;br&gt;<br>
&quot;Cannot&nbsp;return&nbsp;a&nbsp;Deferred&nbsp;as&nbsp;a&nbsp;result.&nbsp;Did&nbsp;you&nbsp;forgot&nbsp;to&nbsp;addCallback&nbsp;to&nbsp;the&nbsp;&lt;br&gt;<br>
deferred?&quot;&lt;br&gt;<br>
&lt;br&gt;<br>
Maybe&nbsp;add&nbsp;something&nbsp;to&nbsp;docs&nbsp;based&nbsp;on&nbsp;the&nbsp;above&nbsp;and&nbsp;refer&nbsp;to&nbsp;it&nbsp;in&nbsp;the&nbsp;message?&lt;br&gt;<br>
&lt;br&gt;<br>
Barry&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
