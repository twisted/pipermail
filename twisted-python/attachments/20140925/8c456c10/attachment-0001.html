<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;Hi&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;(For&nbsp;those&nbsp;of&nbsp;you&nbsp;wondering&nbsp;about&nbsp;the&nbsp;subject,&nbsp;note&nbsp;that&nbsp;this&nbsp;message&nbsp;is&nbsp;sent&nbsp;in&nbsp;compliance&nbsp;with&nbsp;This&nbsp;email&nbsp;sent&nbsp;in&nbsp;compliance&nbsp;with&nbsp;&lt;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/trac/wiki/CompatibilityPolicy#ProcedureforExceptionstothisPolicy&quot;&gt;https://twistedmatrix.com/trac/wiki/CompatibilityPolicy#ProcedureforExceptionstothisPolicy&lt;/a&gt;&gt;.)&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I've&nbsp;been&nbsp;trying&nbsp;to&nbsp;improve&nbsp;the&nbsp;reliability&nbsp;of&nbsp;the&nbsp;buildbots.&nbsp;&nbsp;(On&nbsp;that&nbsp;note,&nbsp;by&nbsp;the&nbsp;way,&nbsp;several&nbsp;builders&nbsp;are&nbsp;failing&nbsp;and&nbsp;more&nbsp;will&nbsp;be&nbsp;soon&nbsp;as&nbsp;security&nbsp;updates&nbsp;roll&nbsp;out,&nbsp;it&nbsp;would&nbsp;be&nbsp;great&nbsp;if&nbsp;someone&nbsp;could&nbsp;review&nbsp;&lt;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/trac/ticket/7651&quot;&gt;https://twistedmatrix.com/trac/ticket/7651&lt;/a&gt;&gt;&nbsp;before&nbsp;the&nbsp;whole&nbsp;fleet&nbsp;turns&nbsp;red.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;so&nbsp;doing&nbsp;I&nbsp;(re-)discovered&nbsp;this&nbsp;bug:&nbsp;&lt;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/trac/ticket/2673&quot;&gt;https://twistedmatrix.com/trac/ticket/2673&lt;/a&gt;&gt;.&nbsp;&nbsp;At&nbsp;first&nbsp;I&nbsp;just&nbsp;wanted&nbsp;to&nbsp;delete&nbsp;an&nbsp;intermittently&nbsp;failing&nbsp;test&nbsp;which&nbsp;appears&nbsp;to&nbsp;be&nbsp;nonsense.&nbsp;&nbsp;However,&nbsp;after&nbsp;some&nbsp;prodding&nbsp;from&nbsp;exarkun,&nbsp;I&nbsp;investigated&nbsp;and&nbsp;discovered&nbsp;that&nbsp;this&nbsp;very&nbsp;poorly-written&nbsp;test&nbsp;case&nbsp;does&nbsp;in&nbsp;fact&nbsp;illustrate&nbsp;a&nbsp;real&nbsp;problem&nbsp;with&nbsp;our&nbsp;current&nbsp;threadpool&nbsp;implementation&nbsp;which&nbsp;can&nbsp;result&nbsp;in&nbsp;deadlocks,&nbsp;hangs&nbsp;on&nbsp;exit,&nbsp;and&nbsp;other&nbsp;unpleasantness.&nbsp;&nbsp;In&nbsp;my&nbsp;use&nbsp;of&nbsp;Twisted&nbsp;I&nbsp;have&nbsp;encountered&nbsp;several&nbsp;&quot;huh,&nbsp;this&nbsp;can't&nbsp;happen,&nbsp;maybe&nbsp;cosmic&nbsp;rays&nbsp;or&nbsp;something&quot;&nbsp;bugs&nbsp;which&nbsp;&lt;i&gt;might&lt;/i&gt;&nbsp;have&nbsp;been&nbsp;caused&nbsp;by&nbsp;this,&nbsp;so&nbsp;I&nbsp;would&nbsp;very&nbsp;much&nbsp;like&nbsp;to&nbsp;fix&nbsp;it.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One&nbsp;reason&nbsp;that&nbsp;our&nbsp;threadpool&nbsp;implementation&nbsp;is&nbsp;problematic&nbsp;is&nbsp;that&nbsp;it&nbsp;has&nbsp;a&nbsp;somewhat&nbsp;complex&nbsp;internal&nbsp;design,&nbsp;lots&nbsp;of&nbsp;weird&nbsp;little&nbsp;features&nbsp;(context&nbsp;preservation,&nbsp;completion&nbsp;callbacks,&nbsp;workload&nbsp;estimation)&nbsp;all&nbsp;built&nbsp;at&nbsp;the&nbsp;same&nbsp;layer&nbsp;with&nbsp;no&nbsp;composition.&nbsp;&nbsp;I&nbsp;tried&nbsp;to&nbsp;figure&nbsp;out&nbsp;a&nbsp;way&nbsp;to&nbsp;salvage&nbsp;its&nbsp;current&nbsp;architecture&nbsp;and&nbsp;I&nbsp;could&nbsp;not&nbsp;reasonably&nbsp;do&nbsp;so.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;prototyped&nbsp;a&nbsp;completely&nbsp;new&nbsp;threadpool&nbsp;implementation&nbsp;(&quot;twisted.threads&quot;)&nbsp;in&nbsp;a&nbsp;spike.&nbsp;&nbsp;It&nbsp;is&nbsp;definitely&nbsp;not&nbsp;ready&nbsp;for&nbsp;review,&nbsp;but&nbsp;I&nbsp;would&nbsp;definitely&nbsp;appreciate&nbsp;design-level&nbsp;feedback&nbsp;on&nbsp;the&nbsp;code&nbsp;right&nbsp;now.&nbsp;&nbsp;You&nbsp;can&nbsp;see&nbsp;the&nbsp;implementation&nbsp;here:&nbsp;&lt;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/trac/browser/branches/desynchronize-2673/twisted/threads&quot;&gt;https://twistedmatrix.com/trac/browser/branches/desynchronize-2673/twisted/threads&lt;/a&gt;&gt;&nbsp;(or&nbsp;here:&nbsp;&lt;&lt;a&nbsp;href=&quot;https://github.com/twisted/twisted/tree/desynchronize-2673/twisted/threads&quot;&gt;https://github.com/twisted/twisted/tree/desynchronize-2673/twisted/threads&lt;/a&gt;&gt;&nbsp;if&nbsp;that's&nbsp;more&nbsp;your&nbsp;speed)&nbsp;&nbsp;It's&nbsp;less&nbsp;code&nbsp;than&nbsp;the&nbsp;existing&nbsp;implementation&nbsp;and&nbsp;provides&nbsp;more&nbsp;useful&nbsp;features&nbsp;at&nbsp;the&nbsp;same&nbsp;time.&nbsp;&nbsp;It&nbsp;might,&nbsp;in&nbsp;fact,&nbsp;provide&nbsp;some&nbsp;of&nbsp;the&nbsp;threading&nbsp;primitives&nbsp;that&nbsp;we&nbsp;would&nbsp;need&nbsp;for&nbsp;a&nbsp;reactor-per-thread&nbsp;implementation.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;However,&nbsp;there&nbsp;is&nbsp;a&nbsp;very&nbsp;ugly&nbsp;implementation&nbsp;detail&nbsp;that&nbsp;prevents&nbsp;us&nbsp;from&nbsp;marching&nbsp;onwards&nbsp;to&nbsp;a&nbsp;glorious&nbsp;multithreading&nbsp;future:&nbsp;twisted.internet.interfaces.IReactorThreads.getThreadPool.&nbsp;&nbsp;The&nbsp;nominally&nbsp;&quot;public&quot;&nbsp;interface&nbsp;provided&nbsp;by&nbsp;its&nbsp;documented&nbsp;return&nbsp;type,&nbsp;the&nbsp;concrete&nbsp;(old-style!)&nbsp;class&nbsp;twisted.python.threadpool.ThreadPool,&nbsp;is&nbsp;ridiculously&nbsp;over-broad.&nbsp;&nbsp;Here&nbsp;are&nbsp;the&nbsp;features&nbsp;(attributes&nbsp;and&nbsp;methods)&nbsp;in&nbsp;its&nbsp;&quot;public&quot;&nbsp;interface:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&gt;callInThread&lt;/li&gt;&lt;li&gt;callInThreadWithCallback&lt;/li&gt;&lt;li&gt;adjustPoolsize&lt;/li&gt;&lt;li&gt;start&lt;/li&gt;&lt;li&gt;stop&lt;/li&gt;&lt;li&gt;q&lt;/li&gt;&lt;li&gt;min&lt;/li&gt;&lt;li&gt;max&lt;/li&gt;&lt;li&gt;joined&lt;/li&gt;&lt;li&gt;started&lt;/li&gt;&lt;li&gt;name&lt;/li&gt;&lt;li&gt;waiters&lt;/li&gt;&lt;li&gt;threads&lt;/li&gt;&lt;li&gt;working&lt;/li&gt;&lt;li&gt;workers&lt;/li&gt;&lt;li&gt;start&lt;/li&gt;&lt;li&gt;startAWorker&lt;/li&gt;&lt;li&gt;stopAWorker&lt;/li&gt;&lt;li&gt;dumpStats&lt;/li&gt;&lt;li&gt;__getstate__&lt;/li&gt;&lt;li&gt;__setstate__&lt;/li&gt;&lt;li&gt;threadFactory&lt;/li&gt;&lt;li&gt;currentThread&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Here's&nbsp;what&nbsp;I&nbsp;would&nbsp;like&nbsp;its&nbsp;public&nbsp;interface&nbsp;to&nbsp;be,&nbsp;more&nbsp;or&nbsp;less&nbsp;what&nbsp;it's&nbsp;intended&nbsp;to&nbsp;be,&nbsp;based&nbsp;on&nbsp;the&nbsp;ways&nbsp;it's&nbsp;documented&nbsp;and&nbsp;used&nbsp;in&nbsp;Twisted&nbsp;and&nbsp;in&nbsp;the&nbsp;various&nbsp;projects&nbsp;I&nbsp;can&nbsp;see&nbsp;using&nbsp;it:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&gt;callInThread&lt;/li&gt;&lt;li&gt;callInThreadWithCallback&lt;/li&gt;&lt;li&gt;adjustPoolsize&lt;/li&gt;&lt;li&gt;start&lt;/li&gt;&lt;li&gt;stop&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;would&nbsp;not&nbsp;be&nbsp;too&nbsp;much&nbsp;effort&nbsp;to&nbsp;also&nbsp;preserve,&nbsp;for&nbsp;legacy&nbsp;purposes:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&gt;min&lt;/li&gt;&lt;li&gt;max&lt;/li&gt;&lt;li&gt;joined&lt;/li&gt;&lt;li&gt;started&lt;/li&gt;&lt;li&gt;name&lt;/li&gt;&lt;li&gt;dumpStats&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;However,&nbsp;I&nbsp;would&nbsp;REALLY&nbsp;like&nbsp;to&nbsp;delete&nbsp;these&nbsp;implementation&nbsp;details:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&gt;workers&lt;br&gt;&lt;/li&gt;&lt;li&gt;threads&lt;/li&gt;&lt;li&gt;working&lt;/li&gt;&lt;li&gt;startAWorker&lt;/li&gt;&lt;li&gt;q&lt;/li&gt;&lt;li&gt;__getstate__&lt;/li&gt;&lt;li&gt;__setstate__&lt;/li&gt;&lt;li&gt;threadFactory&lt;/li&gt;&lt;li&gt;currentThread&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Deleting&nbsp;these&nbsp;implementation&nbsp;details&nbsp;straight&nbsp;up&nbsp;would&nbsp;also&nbsp;make&nbsp;it&nbsp;such&nbsp;that&nbsp;anyone&nbsp;who&nbsp;inherited&nbsp;from&nbsp;the&nbsp;public&nbsp;class&nbsp;ThreadPool&nbsp;would&nbsp;not&nbsp;be&nbsp;able&nbsp;to&nbsp;&lt;i&gt;override&lt;/i&gt;&nbsp;any&nbsp;of&nbsp;these&nbsp;things&nbsp;(oh&nbsp;my&nbsp;goodness,&nbsp;why&nbsp;would&nbsp;you&nbsp;do&nbsp;that,&nbsp;I&nbsp;really&nbsp;hope&nbsp;nobody&nbsp;has&nbsp;done&nbsp;that).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;three&nbsp;ways&nbsp;I&nbsp;could&nbsp;proceed,&nbsp;in&nbsp;order&nbsp;of&nbsp;my&nbsp;own&nbsp;preference,&nbsp;are:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;ol&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&gt;Put&nbsp;the&nbsp;new&nbsp;implementation&nbsp;with&nbsp;entirely&nbsp;new&nbsp;interfaces&nbsp;into&nbsp;twisted.threads,&nbsp;put&nbsp;a&nbsp;compatibility&nbsp;shim&nbsp;into&nbsp;twisted.python.threadpool.ThreadPool&nbsp;that&nbsp;wraps&nbsp;those&nbsp;objects,&nbsp;provides&nbsp;my&nbsp;more&nbsp;minimal&nbsp;interface&nbsp;proposed&nbsp;above,&nbsp;and&nbsp;deletes&nbsp;90%&nbsp;of&nbsp;its&nbsp;tests.&nbsp;&nbsp;Change&nbsp;IReactorThreads.getThreadPool&nbsp;to&nbsp;return&nbsp;a&nbsp;documented&nbsp;interface&nbsp;considerably&nbsp;more&nbsp;restricted&nbsp;than&nbsp;&lt;br&gt;&lt;br&gt;Compatibility&nbsp;implications:&nbsp;twisted.internet.interfaces.IReactorThreads's&nbsp;contract&nbsp;would&nbsp;be&nbsp;relaxed.&nbsp;&nbsp;Implementors&nbsp;of&nbsp;IReactorThreads&nbsp;would&nbsp;not&nbsp;see&nbsp;an&nbsp;impact&nbsp;unless&nbsp;they&nbsp;were&nbsp;talking&nbsp;to&nbsp;deleted&nbsp;parts&nbsp;of&nbsp;ThreadPool&nbsp;internally.&nbsp;&nbsp;ThreadPool's&nbsp;clients&nbsp;would&nbsp;have&nbsp;several&nbsp;methods&nbsp;removed,&nbsp;and&nbsp;subclassing&nbsp;would&nbsp;effectively&nbsp;not&nbsp;be&nbsp;possible&nbsp;any&nbsp;more&nbsp;(a&nbsp;bunch&nbsp;of&nbsp;overridable&nbsp;hooks&nbsp;would&nbsp;have&nbsp;been&nbsp;removed,&nbsp;and&nbsp;no&nbsp;replacements&nbsp;would&nbsp;be&nbsp;provided).&nbsp;However,&nbsp;I&nbsp;prefer&nbsp;this&nbsp;option&nbsp;because&nbsp;there&nbsp;are&nbsp;an&nbsp;&lt;i&gt;extremely&lt;/i&gt;&nbsp;restrictive&nbsp;set&nbsp;of&nbsp;use-cases&nbsp;(basically:&nbsp;only&nbsp;logging,&nbsp;any&nbsp;behavioral&nbsp;changes&nbsp;would&nbsp;have&nbsp;been&nbsp;broken)&nbsp;where&nbsp;clients&nbsp;could&nbsp;have&nbsp;made&nbsp;legitimate&nbsp;use&nbsp;of&nbsp;these&nbsp;attributes&nbsp;or&nbsp;overriding&nbsp;any&nbsp;of&nbsp;these&nbsp;functions.&lt;br&gt;&lt;br&gt;&lt;/li&gt;&lt;li&gt;Delete&nbsp;all&nbsp;of&nbsp;twisted.python.threadpool's&nbsp;test&nbsp;coverage,&nbsp;deprecate&nbsp;the&nbsp;entire&nbsp;module,&nbsp;and&nbsp;delete&nbsp;it&nbsp;in&nbsp;the&nbsp;next&nbsp;release&nbsp;(14.1+1).&nbsp;&nbsp;This&nbsp;has&nbsp;the&nbsp;advantage&nbsp;of&nbsp;making&nbsp;the&nbsp;test&nbsp;suite&nbsp;reliable,&nbsp;and&nbsp;gets&nbsp;the&nbsp;benefits&nbsp;for&nbsp;any&nbsp;users&nbsp;of&nbsp;callInThread,&nbsp;but&nbsp;does&nbsp;&lt;i&gt;not&lt;/i&gt;&nbsp;relay&nbsp;any&nbsp;of&nbsp;the&nbsp;benefits&nbsp;to&nbsp;users&nbsp;of&nbsp;ThreadPool.&nbsp;&nbsp;The&nbsp;only&nbsp;ones&nbsp;doing&nbsp;this&nbsp;&lt;i&gt;directly&lt;/i&gt;&nbsp;in&nbsp;Twisted&nbsp;are&nbsp;deferToThreadPool&nbsp;(and&nbsp;by&nbsp;extension,&nbsp;deferToThread)&nbsp;and&nbsp;WSGIResource.&nbsp;&nbsp;I&nbsp;could&nbsp;update&nbsp;these&nbsp;in&nbsp;tandem,&nbsp;however;&nbsp;the&nbsp;code&nbsp;changes&nbsp;would&nbsp;be&nbsp;very&nbsp;small.&nbsp;&nbsp;I&nbsp;don't&nbsp;think&nbsp;it&nbsp;would&nbsp;be&nbsp;incompatible&nbsp;to&nbsp;make&nbsp;WSGIResource&nbsp;itself&nbsp;accept&nbsp;a&nbsp;different&nbsp;type&nbsp;of&nbsp;constructor&nbsp;argument&nbsp;(although&nbsp;if&nbsp;we&nbsp;don't,&nbsp;I&nbsp;wonder&nbsp;if&nbsp;subclassing&nbsp;&lt;i&gt;anything&lt;/i&gt;&nbsp;with&nbsp;a&nbsp;constructor&nbsp;can&nbsp;be&nbsp;considered&nbsp;applicable&nbsp;to&nbsp;the&nbsp;compatibility&nbsp;policy&nbsp;in&nbsp;Twisted;&nbsp;hmm).&lt;br&gt;&lt;br&gt;&lt;/li&gt;&lt;li&gt;Actually&nbsp;go&nbsp;through&nbsp;the&nbsp;trouble&nbsp;of&nbsp;emulating&nbsp;all&nbsp;the&nbsp;attributes&nbsp;on&nbsp;ThreadPool&nbsp;and&nbsp;emulating&nbsp;them&nbsp;as&nbsp;best&nbsp;I&nbsp;can.&nbsp;&nbsp;Delete&nbsp;the&nbsp;direct&nbsp;tests&nbsp;for&nbsp;ThreadPool&nbsp;itself&nbsp;and&nbsp;write&nbsp;a&nbsp;private&nbsp;subclass&nbsp;that&nbsp;will&nbsp;be&nbsp;returned&nbsp;from&nbsp;getThreadPool&nbsp;that&nbsp;returns&nbsp;a&nbsp;compatibility&nbsp;shim&nbsp;which&nbsp;isinstance(ThreadPool)&nbsp;for&nbsp;compatibility&nbsp;and&nbsp;still&nbsp;has&nbsp;all&nbsp;the&nbsp;gross&nbsp;attributes.&nbsp;&nbsp;This&nbsp;change&nbsp;would&nbsp;be&nbsp;technically&nbsp;compatible,&nbsp;but&nbsp;would&nbsp;be&nbsp;a&nbsp;huge&nbsp;amount&nbsp;of&nbsp;additional&nbsp;work&nbsp;and&nbsp;I&nbsp;am&nbsp;doubtful&nbsp;that&nbsp;it&nbsp;would&nbsp;provide&nbsp;any&nbsp;value.&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So,&nbsp;does&nbsp;anyone&nbsp;out&nbsp;there&nbsp;have&nbsp;any&nbsp;code&nbsp;which&nbsp;makes&nbsp;use&nbsp;of&nbsp;the&nbsp;aforementioned&nbsp;bad&nbsp;attributes&nbsp;of&nbsp;ThreadPool,&nbsp;whose&nbsp;applications&nbsp;would&nbsp;break&nbsp;if&nbsp;I&nbsp;removed&nbsp;them?&nbsp;&nbsp;If&nbsp;so,&nbsp;how&nbsp;can&nbsp;I&nbsp;make&nbsp;you&nbsp;feel&nbsp;as&nbsp;bad&nbsp;about&nbsp;yourselves&nbsp;for&nbsp;using&nbsp;it&nbsp;as&nbsp;I&nbsp;feel&nbsp;bad&nbsp;about&nbsp;myself&nbsp;for&nbsp;writing&nbsp;it?&nbsp;;-)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-glyph&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
