<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;Feb&nbsp;20,&nbsp;2019,&nbsp;at&nbsp;11:03&nbsp;PM,&nbsp;Chris&nbsp;Withers&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:chris@withers.org&quot;&nbsp;class=&quot;&quot;&gt;chris@withers.org&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;21/02/2019&nbsp;06:55,&nbsp;Glyph&nbsp;wrote:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;The&nbsp;methods&nbsp;being&nbsp;hooked&nbsp;don't&nbsp;necessarily&nbsp;return&nbsp;deferreds.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Glyph,&nbsp;this&nbsp;bit&nbsp;^^^&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;I'd&nbsp;like&nbsp;it&nbsp;to&nbsp;be&nbsp;an&nbsp;explicit&nbsp;choice&nbsp;of&nbsp;the&nbsp;caller,&nbsp;ie:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;result&nbsp;=&nbsp;yield&nbsp;SomeProtocol.onMessage.called()&lt;br&nbsp;class=&quot;&quot;&gt;#&nbsp;okay,&nbsp;we&nbsp;got&nbsp;here,&nbsp;we&nbsp;know&nbsp;onMessage&nbsp;was&nbsp;called,&lt;br&nbsp;class=&quot;&quot;&gt;#&nbsp;now&nbsp;we&nbsp;might&nbsp;want&nbsp;to&nbsp;tick&nbsp;a&nbsp;clock,&nbsp;or&nbsp;otherwise&nbsp;simulate&lt;br&nbsp;class=&quot;&quot;&gt;#&nbsp;async&nbsp;state&nbsp;manipulation.&lt;br&nbsp;class=&quot;&quot;&gt;#&nbsp;now&nbsp;I&nbsp;want&nbsp;to&nbsp;make&nbsp;sure&nbsp;the&nbsp;deferred&nbsp;chain&nbsp;on&nbsp;the&nbsp;onMessage&nbsp;result&nbsp;has&nbsp;been&nbsp;completed:&lt;br&nbsp;class=&quot;&quot;&gt;yield&nbsp;result&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;I'm&nbsp;not&nbsp;sure&nbsp;I&nbsp;understand&nbsp;your&nbsp;example&nbsp;here.&nbsp;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Yeah,&nbsp;this&nbsp;is&nbsp;part&nbsp;of&nbsp;carly,&nbsp;that&nbsp;I&nbsp;posted&nbsp;earlier.&nbsp;It&nbsp;stems&nbsp;from&nbsp;the&nbsp;need&nbsp;to&nbsp;get&nbsp;the&nbsp;results&nbsp;of&nbsp;method&nbsp;calls&nbsp;when&nbsp;you&nbsp;have&nbsp;no&nbsp;reference&nbsp;to&nbsp;the&nbsp;object&nbsp;being&nbsp;calls,&nbsp;or&nbsp;sometimes&nbsp;a&nbsp;result&nbsp;that's&nbsp;a&nbsp;deferred&nbsp;you&nbsp;need&nbsp;to&nbsp;wait&nbsp;on,&nbsp;particularly&nbsp;in&nbsp;a&nbsp;test,&nbsp;but&nbsp;have&nbsp;no&nbsp;way&nbsp;of&nbsp;doing&nbsp;so.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;just&nbsp;can't&nbsp;parse&nbsp;this&nbsp;sentence.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Breaking&nbsp;it&nbsp;down:&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;span&nbsp;id=&quot;x-apple-selection:end&quot;&gt;&lt;/span&gt;you&nbsp;have&nbsp;no&nbsp;reference&nbsp;to&nbsp;the&nbsp;object&nbsp;being&nbsp;calls,&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;How&nbsp;do&nbsp;you&nbsp;have&nbsp;no&nbsp;reference&nbsp;to&nbsp;the&nbsp;object&nbsp;being&nbsp;called?&nbsp;Aren't&nbsp;you&nbsp;calling&nbsp;it?&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;or&nbsp;sometimes&nbsp;a&nbsp;result&nbsp;that's&nbsp;a&nbsp;deferred&nbsp;you&nbsp;need&nbsp;to&nbsp;wait&nbsp;on,&nbsp;particularly&nbsp;in&nbsp;a&nbsp;test,&nbsp;but&nbsp;have&nbsp;no&nbsp;way&nbsp;of&nbsp;doing&nbsp;so&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;But...&nbsp;you&nbsp;do&nbsp;have&nbsp;a&nbsp;way&nbsp;of&nbsp;doing&nbsp;so.&nbsp;&nbsp;You&nbsp;yield&nbsp;it&nbsp;from&nbsp;inlineCallbacks&nbsp;or&nbsp;you&nbsp;add&nbsp;a&nbsp;callback&nbsp;to&nbsp;it.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;In&nbsp;any&nbsp;case&nbsp;you&nbsp;either&nbsp;have&nbsp;a&nbsp;Deferred&nbsp;or&nbsp;you&nbsp;don't;&nbsp;if&nbsp;you&nbsp;do,&nbsp;then&nbsp;it's&nbsp;clear&nbsp;you&nbsp;should&nbsp;wait&nbsp;on&nbsp;it,&nbsp;if&nbsp;you&nbsp;don't,&nbsp;then&nbsp;it's&nbsp;clear&nbsp;you&nbsp;should&nbsp;not&nbsp;wait&nbsp;on&nbsp;it.&nbsp;&nbsp;If&nbsp;you&nbsp;want&nbsp;an&nbsp;API&nbsp;that&nbsp;allows&nbsp;some&nbsp;user&nbsp;code&nbsp;to&nbsp;do&nbsp;either,&nbsp;that's&nbsp;what&nbsp;'maybeDeferred'&nbsp;is&nbsp;for.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;If&nbsp;you're&nbsp;feeling&nbsp;brave,&nbsp;have&nbsp;a&nbsp;read&nbsp;of:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;a&nbsp;href=&quot;https://github.com/cjw296/carly/blob/master/carly/hook.py&quot;&nbsp;class=&quot;&quot;&gt;https://github.com/cjw296/carly/blob/master/carly/hook.py&lt;/a&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;The&nbsp;assertion&nbsp;in&nbsp;question&nbsp;only&nbsp;happens&nbsp;if&nbsp;you&nbsp;call&nbsp;returnValue&nbsp;or&nbsp;do&nbsp;a&nbsp;return&nbsp;with&nbsp;a&nbsp;Deferred&nbsp;directly;&nbsp;this&nbsp;example&nbsp;doesn't&nbsp;do&nbsp;either&nbsp;of&nbsp;those&nbsp;things.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;This&nbsp;is&nbsp;the&nbsp;test&nbsp;situation&nbsp;where&nbsp;I&nbsp;hit&nbsp;this&nbsp;issue:&lt;br&nbsp;class=&quot;&quot;&gt;https://github.com/cjw296/carly/blob/master/tests/test_untracked_deferred.py#L28-L35&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;I'd&nbsp;originally&nbsp;wanted&nbsp;to&nbsp;have&nbsp;that&nbsp;read:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;@inlineCallbacks&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;test1(self):&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;yield&nbsp;pita.asyncMethod.called()&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;ShouldRaise(Exception(1)):&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;result&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Now,&nbsp;which&nbsp;I'm&nbsp;actually&nbsp;happier&nbsp;with&nbsp;the&nbsp;end&nbsp;result&nbsp;here,&nbsp;I&nbsp;think&nbsp;the&nbsp;above&nbsp;it&nbsp;legit,&nbsp;if&nbsp;unusual,&nbsp;and&nbsp;that&nbsp;assert&nbsp;trips&nbsp;it&nbsp;up.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Some&nbsp;type&nbsp;annotations&nbsp;might&nbsp;make&nbsp;it&nbsp;a&nbsp;bit&nbsp;clearer&nbsp;what&nbsp;the&nbsp;two&nbsp;states&nbsp;here&nbsp;are&nbsp;:).&nbsp;&nbsp;As&nbsp;it&nbsp;is,&nbsp;it&nbsp;looks&nbsp;to&nbsp;me&nbsp;you&nbsp;want&nbsp;a&nbsp;Deferred&nbsp;to&nbsp;come&nbsp;*out*&nbsp;of&nbsp;a&nbsp;'yield',&nbsp;which&nbsp;should&nbsp;definitely&nbsp;never&nbsp;happen.&nbsp;&nbsp;If&nbsp;this&nbsp;assert&nbsp;were&nbsp;to&nbsp;be&nbsp;removed,&nbsp;it&nbsp;would&nbsp;be&nbsp;done&nbsp;in&nbsp;such&nbsp;a&nbsp;way&nbsp;that&nbsp;would&nbsp;implicitly&nbsp;wait&nbsp;for&nbsp;the&nbsp;Deferred&nbsp;in&nbsp;question&nbsp;to&nbsp;fire:&nbsp;you&nbsp;should&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;never&lt;/i&gt;&nbsp;receive&nbsp;a&nbsp;Deferred&nbsp;as&nbsp;an&nbsp;argument&nbsp;to&nbsp;a&nbsp;function,&nbsp;or&nbsp;as&nbsp;the&nbsp;result&nbsp;of&nbsp;an&nbsp;(inlineCallbacks)&nbsp;'yield'&nbsp;or&nbsp;(async&nbsp;def)&nbsp;'await'.&nbsp;&nbsp;It&nbsp;breaks&nbsp;the&nbsp;whole&nbsp;model&nbsp;of&nbsp;what&nbsp;'awaiting'&nbsp;means.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;-g&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
