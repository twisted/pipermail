#import the required modules and packages
import socket
import sys
import MySQLdb
import json,requests
import base64
import time

#used twisted framework for the chat module
from twisted.internet.protocol import Protocol, Factory
from twisted.internet import reactor

#this the protocol for both dashbord and chat module
class IphoneChat(Protocol):
	#set up client connections
	#self is the socket id of the connection
	def connectionMade(self):
		self.factory.clients.append(self)

	#remove the client from connection
	def connectionLost(self, reason):
	    self.factory.clients.remove(self)

	#Data received from client in format of commands
	def dataReceived(self, data):

		#split the commands on the basis of } , using this you can handle multiple commands at a time
		a = data.split(':',1)
		sizeof=len(a )
		if sizeof >= 1:
					command = a[0]
					content = a[1]+ "}"
					msg = ""

					#started with the actual chat commands
					#if the chat command is requested from iphone
					if command == "demo":
						datajson = {'chatroomid' : 1, 'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userstatus':'A','userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'userid' : 2 ,'chatid' : 3 ,'comment':'Hi Thank you','username':'OAB','userfirstname':'OAB','useranonymousname':'BLUE123','profilepic':'userprofilepic','chatdate':'2014:09:11','likecount':'0','likestatus':'0','commandtype':'demo','chat_type':'T','timezone':'settimezone','usertype':'A','dmlist':'[{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"},{"dmuserid": "7","dmusertype": "R"}{"dmuserid": "6","dmusertype": "R"]'}
						msg= json.dumps(datajson, sort_keys=True, indent=4)

						#put the msg into the json to send to the ios
						for c in self.factory.clients:
									c.message(msg)

	#the function which writes the messge to the client screen
	def message(self, message):
		self.transport.write(message + '\n')

print "Iphone Chat server started"
factory = Factory()
factory.protocol = IphoneChat
factory.clients = []
reactor.listenTCP(236, factory)
reactor.run()