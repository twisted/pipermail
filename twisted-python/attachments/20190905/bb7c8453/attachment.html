<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Perhaps&nbsp;this&nbsp;line&nbsp;from&nbsp;OpenSSL.SSL.Connection&nbsp;is&nbsp;a&nbsp;clue.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&quot;socket&nbsp;may&nbsp;be&nbsp;None;&nbsp;in&nbsp;this&nbsp;case,&nbsp;the&nbsp;Connection&nbsp;is&nbsp;created&nbsp;with&nbsp;a&nbsp;memory&nbsp;BIO:&nbsp;see&nbsp;the&nbsp;bio_read(),&nbsp;bio_write(),&nbsp;and&nbsp;bio_shutdown()&nbsp;methods.&quot;&lt;div&gt;&lt;a&nbsp;href=&quot;https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Connection&quot;&gt;https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Connection&lt;/a&gt;&lt;span&nbsp;style=&quot;color:rgb(64,64,64);font-family:Lato,proxima-nova,&quot;Helvetica&nbsp;Neue&quot;,Arial,sans-serif;font-size:16px;background-color:rgb(252,252,252)&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;input&nbsp;name=&quot;virtru-metadata&quot;&nbsp;type=&quot;hidden&quot;&nbsp;value=&quot;{&quot;email-policy&quot;:{&quot;state&quot;:&quot;closed&quot;,&quot;expirationUnit&quot;:&quot;days&quot;,&quot;disableCopyPaste&quot;:false,&quot;disablePrint&quot;:false,&quot;disableForwarding&quot;:false,&quot;enableNoauth&quot;:false,&quot;persistentProtection&quot;:false,&quot;expandedWatermarking&quot;:false,&quot;expires&quot;:false,&quot;isManaged&quot;:false},&quot;attachments&quot;:{},&quot;compose-id&quot;:&quot;1&quot;,&quot;compose-window&quot;:{&quot;secure&quot;:false}}&quot;&gt;&lt;/div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Wed,&nbsp;Sep&nbsp;4,&nbsp;2019&nbsp;at&nbsp;1:38&nbsp;AM&nbsp;Arn&nbsp;Vollebregt&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:kpn.arn.vollebregt@gmail.com&quot;&gt;kpn.arn.vollebregt@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Hi,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;noticed&nbsp;that&nbsp;PyOpenSSL&nbsp;SNI&nbsp;callbacks&nbsp;(set&nbsp;with&nbsp;&lt;i&gt;ctx.set_tlsext_servername_callback&lt;/i&gt;)&nbsp;receive&nbsp;a&nbsp;&lt;i&gt;OpenSSL.SSL.Connection&lt;/i&gt;&nbsp;object&nbsp;within&nbsp;Twisted&nbsp;that&nbsp;have&nbsp;an&nbsp;empty&nbsp;&lt;i&gt;_socket&lt;/i&gt;&nbsp;property,&nbsp;while&nbsp;this&nbsp;property&nbsp;&lt;u&gt;is&lt;/u&gt;&nbsp;actually&nbsp;set&nbsp;when&nbsp;using&nbsp;&lt;i&gt;PyOpenSSL&lt;/i&gt;&nbsp;directly.&nbsp;For&nbsp;my&nbsp;use-case&nbsp;this&nbsp;is&nbsp;a&nbsp;problem&nbsp;as&nbsp;I&nbsp;want&nbsp;to&nbsp;call&nbsp;&lt;i&gt;conn._socket.getpeername()&lt;/i&gt;&nbsp;to&nbsp;determine&nbsp;the&nbsp;peer&#39;s&nbsp;IP&nbsp;address.&nbsp;So&nbsp;I&nbsp;am&nbsp;wondering:&nbsp;why&nbsp;is&nbsp;this&nbsp;behaviour&nbsp;different?&nbsp;And&nbsp;how&nbsp;do&nbsp;I&nbsp;get&nbsp;the&nbsp;peer&nbsp;IP&nbsp;address?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---console---&lt;/div&gt;&lt;div&gt;user:~$&nbsp;sudo&nbsp;python&nbsp;testTwisted.py&nbsp;&amp;&lt;/div&gt;&lt;div&gt;[3]&nbsp;32842&lt;/div&gt;&lt;div&gt;user:~$&nbsp;curl&nbsp;-s&nbsp;--insecure&nbsp;--key&nbsp;clientPrivateKey.pem&nbsp;--cert&nbsp;clientCertificate.pem&nbsp;&lt;a&nbsp;href=&quot;https://127.0.0.1&quot;&nbsp;target=&quot;_blank&quot;&gt;https://127.0.0.1&lt;/a&gt;&nbsp;&gt;&nbsp;/dev/null&lt;br&gt;&#39;sniCallback&#39;&nbsp;called.&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;conn._socket:&nbsp;None&lt;br&gt;&#39;verifyCallback&#39;&nbsp;called&nbsp;for&nbsp;result&nbsp;0&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;conn._socket:&nbsp;None&lt;br&gt;&#39;verifyCallback&#39;&nbsp;called&nbsp;for&nbsp;result&nbsp;1&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;conn._socket:&nbsp;None&lt;/div&gt;&lt;div&gt;user:~$&nbsp;sudo&nbsp;python&nbsp;testPyOpenSSL.py&nbsp;&amp;&lt;br&gt;[1]&nbsp;33270&lt;/div&gt;&lt;div&gt;user:~$&nbsp;curl&nbsp;-s&nbsp;--insecure&nbsp;--key&nbsp;clientPrivateKey.pem&nbsp;--cert&nbsp;clientCertificate.pem&nbsp;&lt;a&nbsp;href=&quot;https://127.0.0.1&quot;&nbsp;target=&quot;_blank&quot;&gt;https://127.0.0.1&lt;/a&gt;&nbsp;&gt;&nbsp;/dev/null&lt;br&gt;&#39;sniCallback&#39;&nbsp;called.&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;conn._socket:&nbsp;&lt;socket._socketobject&nbsp;object&nbsp;at&nbsp;0x7f34c5bd3130&gt;&lt;br&gt;&lt;class&nbsp;&#39;OpenSSL.SSL.Connection&#39;&gt;&lt;br&gt;&#39;verifyCallback&#39;&nbsp;called&nbsp;for&nbsp;result&nbsp;0&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;conn._socket:&nbsp;&lt;socket._socketobject&nbsp;object&nbsp;at&nbsp;0x7f34c5bd3130&gt;&lt;br&gt;&#39;verifyCallback&#39;&nbsp;called&nbsp;for&nbsp;result&nbsp;1&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;conn._socket:&nbsp;&lt;socket._socketobject&nbsp;object&nbsp;at&nbsp;0x7f34c5bd3130&gt;&lt;br&gt;127.0.0.1&nbsp;-&nbsp;-&nbsp;[29/Aug/2019&nbsp;11:45:47]&nbsp;&quot;GET&nbsp;/&nbsp;HTTP/1.1&quot;&nbsp;200&nbsp;-&lt;/div&gt;&lt;div&gt;------&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---testTwisted.py---&lt;/div&gt;&lt;div&gt;###&nbsp;Generate&nbsp;server&nbsp;key&nbsp;material&nbsp;###&lt;br&gt;#<br>
&nbsp;openssl&nbsp;req&nbsp;-x509&nbsp;-nodes&nbsp;-days&nbsp;365&nbsp;-newkey&nbsp;rsa:2048&nbsp;-keyout&nbsp;<br>
serverPrivateKey.pem&nbsp;-out&nbsp;serverCertificate.pem&nbsp;-subj&nbsp;<br>
&quot;/C=&#39;&#39;/O=&#39;&#39;/OU=&#39;&#39;/CN=server&quot;&lt;br&gt;###&nbsp;Generate&nbsp;client&nbsp;key&nbsp;material&nbsp;###&lt;br&gt;#<br>
&nbsp;openssl&nbsp;req&nbsp;-x509&nbsp;-nodes&nbsp;-days&nbsp;365&nbsp;-newkey&nbsp;rsa:2048&nbsp;-keyout&nbsp;<br>
clientPrivateKey.pem&nbsp;-out&nbsp;clientCertificate.pem&nbsp;-subj&nbsp;<br>
&quot;/C=&#39;&#39;/O=&#39;&#39;/OU=&#39;&#39;/CN=client&quot;&lt;br&gt;from&nbsp;__future__&nbsp;import&nbsp;print_function&lt;br&gt;#&lt;a&nbsp;href=&quot;https://twistedmatrix.com/documents/12.0.0/core/howto/ssl.html&quot;&nbsp;target=&quot;_blank&quot;&gt;https://twistedmatrix.com/documents/12.0.0/core/howto/ssl.html&lt;/a&gt;&lt;br&gt;from&nbsp;OpenSSL&nbsp;import&nbsp;SSL&lt;br&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;ssl,&nbsp;reactor&lt;br&gt;from&nbsp;twisted.web&nbsp;import&nbsp;server,&nbsp;resource&lt;br&gt;from&nbsp;twisted.internet.protocol&nbsp;import&nbsp;Factory,&nbsp;Protocol&lt;br&gt;&lt;br&gt;def&nbsp;verifyCallback(conn,&nbsp;cert,&nbsp;errno,&nbsp;depth,&nbsp;result):&lt;br&gt; &nbsp; &nbsp;print(&#39;\&#39;verifyCallback\&#39;&nbsp;called&nbsp;for&nbsp;result&nbsp;&#39;&nbsp;+&nbsp;str(result))&lt;br&gt; &nbsp; &nbsp;print(&#39;\tconn._socket:&nbsp;&#39;&nbsp;+&nbsp;str(conn._socket))&lt;br&gt; &nbsp; &nbsp;return&nbsp;True&lt;br&gt;&lt;br&gt;def&nbsp;sniCallback(conn):&lt;br&gt; &nbsp; &nbsp;print(&#39;\&#39;sniCallback\&#39;&nbsp;called.&#39;)&lt;br&gt; &nbsp; &nbsp;print(&#39;\tconn._socket:&nbsp;&#39;&nbsp;+&nbsp;str(conn._socket))&lt;br&gt;&lt;br&gt;class&nbsp;MainResource(resource.Resource):&lt;br&gt; &nbsp; &nbsp;isLeaf&nbsp;=&nbsp;True&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;def&nbsp;render_GET(self,&nbsp;request):&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;request.responseHeaders.addRawHeader(&quot;Content-Type&quot;,&nbsp;&quot;text/html;&nbsp;charset=utf-8&quot;)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;b&quot;&lt;html&gt;&lt;body&gt;Hello&nbsp;World&lt;/body&gt;&lt;/html&gt;&quot;&lt;br&gt;&lt;br&gt;if&nbsp;__name__&nbsp;==&nbsp;&#39;__main__&#39;:&lt;br&gt; &nbsp; &nbsp;myContextFactory&nbsp;=&nbsp;ssl.DefaultOpenSSLContextFactory(&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;&#39;serverPrivateKey.pem&#39;,&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;&#39;serverCertificate.pem&#39;&lt;br&gt; &nbsp; &nbsp;)&lt;br&gt; &nbsp; &nbsp;ctx&nbsp;=&nbsp;myContextFactory.getContext()&lt;br&gt; &nbsp; &nbsp;#&nbsp;&lt;a&nbsp;href=&quot;https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_verify&quot;&nbsp;target=&quot;_blank&quot;&gt;https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_verify&lt;/a&gt;&lt;br&gt; &nbsp; &nbsp;ctx.set_verify(SSL.VERIFY_PEER,&nbsp;verifyCallback)&lt;br&gt; &nbsp; &nbsp;#&nbsp;&lt;a&nbsp;href=&quot;https://pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_tlsext_servername_callback&quot;&nbsp;target=&quot;_blank&quot;&gt;https://pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_tlsext_servername_callback&lt;/a&gt;&lt;br&gt; &nbsp; &nbsp;ctx.set_tlsext_servername_callback(sniCallback)&lt;br&gt;&lt;br&gt; &nbsp; &nbsp;site&nbsp;=&nbsp;server.Site(MainResource())&lt;br&gt; &nbsp; &nbsp;reactor.listenSSL(443,&nbsp;site,&nbsp;myContextFactory)&lt;br&gt; &nbsp; &nbsp;reactor.run()&lt;/div&gt;&lt;div&gt;------&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;---testPyOpenSSL.py---&lt;/div&gt;&lt;div&gt;###&nbsp;Generate&nbsp;server&nbsp;key&nbsp;material&nbsp;###&lt;br&gt;#<br>
&nbsp;openssl&nbsp;req&nbsp;-x509&nbsp;-nodes&nbsp;-days&nbsp;365&nbsp;-newkey&nbsp;rsa:2048&nbsp;-keyout&nbsp;<br>
serverPrivateKey.pem&nbsp;-out&nbsp;serverCertificate.pem&nbsp;-subj&nbsp;<br>
&quot;/C=&#39;&#39;/O=&#39;&#39;/OU=&#39;&#39;/CN=server&quot;&lt;br&gt;###&nbsp;Generate&nbsp;client&nbsp;key&nbsp;material&nbsp;###&lt;br&gt;#<br>
&nbsp;openssl&nbsp;req&nbsp;-x509&nbsp;-nodes&nbsp;-days&nbsp;365&nbsp;-newkey&nbsp;rsa:2048&nbsp;-keyout&nbsp;<br>
clientPrivateKey.pem&nbsp;-out&nbsp;clientCertificate.pem&nbsp;-subj&nbsp;<br>
&quot;/C=&#39;&#39;/O=&#39;&#39;/OU=&#39;&#39;/CN=client&quot;&lt;br&gt;from&nbsp;__future__&nbsp;import&nbsp;print_function&lt;br&gt;import&nbsp;socket,&nbsp;sys,&nbsp;os&lt;br&gt;from&nbsp;SocketServer&nbsp;import&nbsp;BaseServer&lt;br&gt;from&nbsp;BaseHTTPServer&nbsp;import&nbsp;HTTPServer&lt;br&gt;from&nbsp;SimpleHTTPServer&nbsp;import&nbsp;SimpleHTTPRequestHandler&lt;br&gt;from&nbsp;OpenSSL&nbsp;import&nbsp;SSL&lt;br&gt;&lt;br&gt;def&nbsp;verifyCallback(conn,&nbsp;cert,&nbsp;errno,&nbsp;depth,&nbsp;result):&lt;br&gt; &nbsp; &nbsp;print(&#39;\&#39;verifyCallback\&#39;&nbsp;called&nbsp;for&nbsp;result&nbsp;&#39;&nbsp;+&nbsp;str(result))&lt;br&gt; &nbsp; &nbsp;print(&#39;\tconn._socket:&nbsp;&#39;&nbsp;+&nbsp;str(conn._socket))&lt;br&gt; &nbsp; &nbsp;return&nbsp;True&lt;br&gt;&lt;br&gt;def&nbsp;sniCallback(conn):&lt;br&gt; &nbsp; &nbsp;print(&#39;\&#39;sniCallback\&#39;&nbsp;called.&#39;)&lt;br&gt; &nbsp; &nbsp;print(&#39;\tconn._socket:&nbsp;&#39;&nbsp;+&nbsp;str(conn._socket))&lt;br&gt; &nbsp; &nbsp;print(type(conn))&lt;br&gt;&lt;br&gt;class&nbsp;SecureHTTPServer(HTTPServer):&lt;br&gt; &nbsp; &nbsp;def&nbsp;__init__(self,&nbsp;server_address,&nbsp;HandlerClass):&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;BaseServer.__init__(self,&nbsp;server_address,&nbsp;HandlerClass)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;ctx&nbsp;=&nbsp;SSL.Context(SSL.TLSv1_2_METHOD)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;ctx.use_privatekey_file(&#39;serverPrivateKey.pem&#39;)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;ctx.use_certificate_file(&#39;serverCertificate.pem&#39;)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;&lt;a&nbsp;href=&quot;https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_verify&quot;&nbsp;target=&quot;_blank&quot;&gt;https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_verify&lt;/a&gt;&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;ctx.set_verify(SSL.VERIFY_PEER,&nbsp;verifyCallback)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;&lt;a&nbsp;href=&quot;https://pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_tlsext_servername_callback&quot;&nbsp;target=&quot;_blank&quot;&gt;https://pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_tlsext_servername_callback&lt;/a&gt;&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;ctx.set_tlsext_servername_callback(sniCallback)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.socket&nbsp;=&nbsp;SSL.Connection(ctx,&nbsp;socket.socket(self.address_family,self.socket_type))&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.server_bind()&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.server_activate()&lt;br&gt; &nbsp; &nbsp;&lt;br&gt; &nbsp; &nbsp;def&nbsp;shutdown_request(self,request):&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;request.shutdown()&lt;br&gt;&lt;br&gt;class&nbsp;SecureHTTPRequestHandler(SimpleHTTPRequestHandler):&lt;br&gt; &nbsp; &nbsp;def&nbsp;setup(self):&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.connection&nbsp;=&nbsp;self.request&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.rfile&nbsp;=&nbsp;socket._fileobject(self.request,&nbsp;&quot;rb&quot;,&nbsp;self.rbufsize)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.wfile&nbsp;=&nbsp;socket._fileobject(self.request,&nbsp;&quot;wb&quot;,&nbsp;self.wbufsize)&lt;br&gt; &nbsp; &nbsp;&lt;br&gt; &nbsp; &nbsp;def&nbsp;do_GET(self):&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.send_response(200)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;SimpleHTTPRequestHandler.end_headers(self)&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.wfile.write(&#39;&lt;html&gt;&lt;body&gt;Hello&nbsp;World&lt;/body&gt;&lt;/html&gt;&#39;)&lt;br&gt;&lt;br&gt;if&nbsp;__name__&nbsp;==&nbsp;&#39;__main__&#39;:&lt;br&gt; &nbsp; &nbsp;ip,port&nbsp;=&nbsp;(&#39;0.0.0.0&#39;,&nbsp;443)&lt;br&gt; &nbsp; &nbsp;httpd&nbsp;=&nbsp;SecureHTTPServer((ip,&nbsp;port),&nbsp;SecureHTTPRequestHandler)&lt;br&gt; &nbsp; &nbsp;httpd.serve_forever()&lt;/div&gt;&lt;div&gt;------&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;(Please&nbsp;note&nbsp;that&nbsp;even&nbsp;though&nbsp;these&nbsp;examples&nbsp;are&nbsp;for&nbsp;Python2&nbsp;(due&nbsp;to&nbsp;other&nbsp;quirks)&nbsp;I&nbsp;am&nbsp;aiming&nbsp;to&nbsp;implement&nbsp;this&nbsp;in&nbsp;Python3.)&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regards,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Arn&lt;/div&gt;&lt;/div&gt;<br>
_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
