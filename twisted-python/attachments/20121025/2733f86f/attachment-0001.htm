<tt>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Mon,&nbsp;Oct&nbsp;22,&nbsp;2012&nbsp;at&nbsp;12:06&nbsp;PM,&nbsp;Glyph&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:glyph@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&gt;glyph@twistedmatrix.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;div&nbsp;style=&quot;word-wrap:break-word&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Oct&nbsp;20,&nbsp;2012,&nbsp;at&nbsp;7:56&nbsp;PM,&nbsp;gelin&nbsp;yan&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:dynamicgl@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;dynamicgl@gmail.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;div&nbsp;style=&quot;font-family:Menlo;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;text-align:-webkit-auto;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px&quot;&gt;<br>
&amp;quot;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;A&nbsp;pending&nbsp;operation&nbsp;is&nbsp;indicated&nbsp;when&nbsp;the&nbsp;function&nbsp;that&nbsp;started&nbsp;the&nbsp;operation&nbsp;returns &lt;/span&gt;&lt;strong&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;FALSE&lt;/strong&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;,&nbsp;and&nbsp;the &lt;/span&gt;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/windows/desktop/ms679360(v=vs.85).aspx&quot;&nbsp;style=&quot;text-decoration:none;color:rgb(3,105,122);font-size:12px;line-height:18px&quot;&nbsp;target=&quot;_blank&quot;&gt;&lt;strong&gt;GetLastError&lt;/strong&gt;&lt;/a&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt; function&nbsp;returns &lt;/span&gt;&lt;strong&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;ERROR_IO_PENDING&lt;/strong&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;.&nbsp;When&nbsp;an&nbsp;I/O&nbsp;operation&nbsp;is&nbsp;pending,&nbsp;the&nbsp;function&nbsp;that&nbsp;started&nbsp;the&nbsp;operation&nbsp;resets&nbsp;the &lt;/span&gt;&lt;strong&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;hEvent&lt;/strong&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt; member&nbsp;of&nbsp;the &lt;/span&gt;&lt;strong&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;OVERLAPPED&lt;/strong&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt; structure&nbsp;to&nbsp;the&nbsp;nonsignaled&nbsp;state.&nbsp;Then&nbsp;when&nbsp;the&nbsp;pending&nbsp;operation&nbsp;has&nbsp;been&nbsp;completed,&nbsp;the&nbsp;system&nbsp;sets&nbsp;the&nbsp;event&nbsp;object&nbsp;to&nbsp;the&nbsp;signaled&nbsp;state&lt;/span&gt;&lt;/font&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt;.&amp;quot;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&nbsp;style=&quot;font-family:Menlo;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;text-align:-webkit-auto;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px&quot;&gt;<br>
&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-family:Menlo;font-size:medium;font-style:normal;font-variant:normal;font-weight:normal;letter-spacing:normal;line-height:normal;text-align:-webkit-auto;text-indent:0px;text-transform:none;white-space:normal;word-spacing:0px&quot;&gt;<br>
&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt; &lt;span&gt; &lt;/span&gt;&lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;line-height:18px&quot;&gt;&lt;font&nbsp;size=&quot;4&quot;&gt;If&nbsp;we&nbsp;can&nbsp;know&nbsp;when&nbsp;event&nbsp;object&nbsp;is&nbsp;in&nbsp;the&nbsp;signaled&nbsp;state&nbsp;we&nbsp;definitely&nbsp;can&nbsp;use&nbsp;a&nbsp;queue&nbsp;directly.&nbsp;Any&nbsp;idea?&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Sounds&nbsp;like&nbsp;you&amp;#39;re&nbsp;at&nbsp;the&nbsp;point&nbsp;where&nbsp;you&nbsp;should&nbsp;just&nbsp;try&nbsp;doing&nbsp;an&nbsp;implementation,&nbsp;and&nbsp;if&nbsp;it&nbsp;works&nbsp;and&nbsp;passes&nbsp;all&nbsp;the&nbsp;tests&nbsp;you&nbsp;can&nbsp;think&nbsp;of&nbsp;for&nbsp;it,&nbsp;submit&nbsp;it&nbsp;for&nbsp;code&nbsp;review.&nbsp; Much&nbsp;more&nbsp;speculation&nbsp;without&nbsp;testing&nbsp;wouldn&amp;#39;t&nbsp;be&nbsp;useful.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;working&nbsp;on&nbsp;this!&lt;/div&gt;&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-glyph&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;target=&quot;_blank&quot;&gt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;Hi&nbsp;All&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; Sorry&nbsp;for&nbsp;coming&nbsp;late.&nbsp;The&nbsp;day&nbsp;before&nbsp;yesterday,&nbsp;I&nbsp;dig&nbsp;out&nbsp;what&nbsp;happen&nbsp;in&nbsp;that&nbsp;code.&nbsp;Actually,&nbsp;ERROR_IO_PENDING&nbsp;isn&amp;#39;t&nbsp;the&nbsp;root&nbsp;of&nbsp;problem.&nbsp;The&nbsp;problem&nbsp;is&nbsp;doWrite&nbsp;method&nbsp;might&nbsp;be&nbsp;triggered&nbsp;twice&nbsp;instead&nbsp;of&nbsp;once;&nbsp;in&nbsp;particular,&nbsp;when&nbsp;trying&nbsp;to&nbsp;send&nbsp;a&nbsp;large&nbsp;chunks&nbsp;data&nbsp;whose&nbsp;size&nbsp;is&nbsp;bigger&nbsp;then&nbsp;SEND_LIMIT,&nbsp;it&nbsp;will&nbsp;always&nbsp;happen.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;When&nbsp;doWrite&nbsp;being&nbsp;invoked&nbsp;twice,&nbsp;it&nbsp;means&nbsp;the&nbsp;same&nbsp;buffer&nbsp;data&nbsp;will&nbsp;be&nbsp;sent&nbsp;twice.&nbsp;It&nbsp;is&nbsp;for&nbsp;sure&nbsp;that&nbsp;PB&nbsp;is&nbsp;unable&nbsp;to&nbsp;deserialize&nbsp; these&nbsp;data&nbsp;and&nbsp;finally&nbsp;it&nbsp;raise&nbsp;an&nbsp;exception,&nbsp;now,&nbsp;we&nbsp;can&nbsp;see&nbsp;connection&nbsp;lost.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;The&nbsp;solution&nbsp;is&nbsp;to&nbsp;make&nbsp;sure&nbsp;doWrite&nbsp;calling&nbsp;in&nbsp;order;&nbsp;hence&nbsp;I&nbsp;introduce&nbsp;a&nbsp;new&nbsp;field&nbsp;named&nbsp;_doWriteCalling&nbsp;to&nbsp;detect&nbsp;whether&nbsp;doWrite&nbsp;call&nbsp;is&nbsp;completed.&nbsp;(due&nbsp;to&nbsp;doWrite&nbsp;always&nbsp;post&nbsp;an&nbsp;event&nbsp;to&nbsp;IOCP,&nbsp;so&nbsp;once&nbsp;_cbWrite&nbsp;get&nbsp;called,&nbsp;it&nbsp;means&nbsp;we&nbsp;can&nbsp;schedule&nbsp;another&nbsp;doWrite).&nbsp;If&nbsp;_cbWrite&nbsp;isn&amp;#39;t&nbsp;called,&nbsp;we&nbsp;simply&nbsp;re-schedule&nbsp;the&nbsp;doWrite&nbsp;by&nbsp;reactor.callLater.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;I&nbsp;attach&nbsp;a&nbsp;modified&nbsp;abstract.py&nbsp;here.&nbsp;You&nbsp;may&nbsp;put&nbsp;it&nbsp;in&nbsp; Path\twisted\internet\iocpreactor&lt;/div&gt;&lt;div&gt;and&nbsp;give&nbsp;it&nbsp;a&nbsp;try.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regards&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;gelin&nbsp;yan&lt;/div&gt;&lt;div&gt;<br>
  &lt;/div&gt;<br>

</tt>
