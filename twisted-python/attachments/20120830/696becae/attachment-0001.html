<tt>
Jean-Paul,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;thank&nbsp;you&nbsp;very&nbsp;much&nbsp;for&nbsp;your&nbsp;answer&nbsp;-&nbsp;I&nbsp;would&nbsp;have&nbsp;missed&nbsp;this&nbsp;problem&nbsp;for&nbsp;sure. &lt;/div&gt;&lt;div&gt;Second&nbsp;option&nbsp;seems&nbsp;a&nbsp;bit&nbsp;more&nbsp;challenging,&nbsp;I&#39;ll&nbsp;try&nbsp;this&nbsp;one.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Best&nbsp;Regards&lt;/div&gt;<br>
&lt;div&gt;Maciej&nbsp;Wasilak&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;2012/8/29&nbsp;&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:exarkun@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&gt;exarkun@twistedmatrix.com&lt;/a&gt;&gt;&lt;/span&gt;&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;On&nbsp;07:53&nbsp;pm,&nbsp;&lt;a&nbsp;href=&quot;mailto:wasilak@gmail.com&quot;&gt;wasilak@gmail.com&lt;/a&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;Hello,&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;I&nbsp;am&nbsp;implementing&nbsp;UDP-based&nbsp;protocol&nbsp;in&nbsp;Twisted&nbsp;(CoAP)&nbsp;which&nbsp;allows&nbsp;two&lt;br&gt;<br>
&gt;behaviors&nbsp;when&nbsp;answering&nbsp;requests:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;1.&nbsp;If&nbsp;response&nbsp;is&nbsp;immediately&nbsp;available&nbsp;-&nbsp;send&nbsp;acknowledgement&nbsp;and&lt;br&gt;<br>
&gt;response&lt;br&gt;<br>
&gt;in&nbsp;a&nbsp;single&nbsp;datagram&nbsp;(piggyback&nbsp;response)&lt;br&gt;<br>
&gt;2.&nbsp;If&nbsp;response&nbsp;needs&nbsp;to&nbsp;be&nbsp;fetched&nbsp;or&nbsp;prepared&nbsp;-&nbsp;send&nbsp;datagram&nbsp;with&lt;br&gt;<br>
&gt;acknowledgement,&nbsp;and&nbsp;then&nbsp;send&nbsp;another&nbsp;datagram&nbsp;with&nbsp;a&nbsp;response&lt;br&gt;<br>
&gt;(separate&lt;br&gt;<br>
&gt;response)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;(I&nbsp;think&nbsp;behavior&nbsp;#1&nbsp;is&nbsp;called&nbsp;synchronous&nbsp;in&nbsp;most&nbsp;Twisted&nbsp;tutorials,&lt;br&gt;<br>
&gt;and&lt;br&gt;<br>
&gt;behavior&nbsp;#2&nbsp;is&nbsp;called&nbsp;asynchronous.)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;When&nbsp;programmer&nbsp;is&nbsp;implementing&nbsp;his&nbsp;application&nbsp;on&nbsp;top&nbsp;of&nbsp;CoAP&lt;br&gt;<br>
&gt;protocol,&nbsp;he&lt;br&gt;<br>
&gt;or&nbsp;she&nbsp;needs&nbsp;to&nbsp;choose&nbsp;how&nbsp;his&nbsp;request&nbsp;handler&nbsp;is&nbsp;going&nbsp;to&nbsp;behave.&nbsp;I&lt;br&gt;<br>
&gt;would&lt;br&gt;<br>
&gt;like&nbsp;to&nbsp;handle&nbsp;both&nbsp;behaviors&nbsp;in&nbsp;the&nbsp;same&nbsp;manner&nbsp;-&nbsp;by&nbsp;forcing&nbsp;every&lt;br&gt;<br>
&gt;user-written&nbsp;request&nbsp;handler&nbsp;to&nbsp;return&nbsp;Deferred.&nbsp;Then&nbsp;I&nbsp;would&lt;br&gt;<br>
&gt;check&nbsp;Deferred.called&nbsp;parameter.&lt;br&gt;<br>
&gt;1.&nbsp;If&nbsp;True&nbsp;-&nbsp;callback&nbsp;will&nbsp;execute&nbsp;immediately&nbsp;and&nbsp;send&nbsp;proper&lt;br&gt;<br>
&gt;ACK+Response&lt;br&gt;<br>
&gt;(that&nbsp;means&nbsp;request&nbsp;handler&nbsp;used&nbsp;defer.succeed()&nbsp;or&nbsp;somethin&nbsp;similar)&lt;br&gt;<br>
&gt;2.&nbsp;If&nbsp;False&nbsp;I&nbsp;send&nbsp;empty&nbsp;ACK,&nbsp;and&nbsp;wait&nbsp;for&nbsp;callback&nbsp;to&nbsp;send&nbsp;Response&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;code:&lt;br&gt;<br>
&gt;def&nbsp;respond(request):&lt;br&gt;<br>
&gt;&nbsp; &nbsp; &nbsp; &nbsp; d&nbsp;=&nbsp;requestHandler(request)&lt;br&gt;<br>
&gt;&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;d.called&nbsp;is&nbsp;False:&lt;br&gt;<br>
&gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; sendEmptyAck()&lt;br&gt;<br>
&gt;&nbsp; &nbsp; &nbsp; &nbsp; d.addCallback(sendResponse)&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;I&nbsp;assume&nbsp;that&nbsp;sendResponse&nbsp;can&nbsp;send&nbsp;either&nbsp;ACK+RSP,&nbsp;or&nbsp;only&nbsp;RSP.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;I&nbsp;would&nbsp;like&nbsp;to&nbsp;ask&nbsp;if&nbsp;this&nbsp;is&nbsp;a&nbsp;proper&nbsp;approach?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;This&nbsp;isn&#39;t&nbsp;the&nbsp;right&nbsp;way&nbsp;to&nbsp;go.&nbsp; The&nbsp;`called`&nbsp;attribute&nbsp;is&nbsp;set&nbsp;to&nbsp;`True`&lt;br&gt;<br>
as&nbsp;soon&nbsp;as&nbsp;`Deferred.callback`&nbsp;is&nbsp;called.&nbsp; This&nbsp;might&nbsp;sound&nbsp;like&nbsp;it&#39;s&lt;br&gt;<br>
what&nbsp;you&nbsp;want,&nbsp;but&nbsp;only&nbsp;if&nbsp;you&nbsp;disregard&nbsp;the&nbsp;chaining&nbsp;feature&nbsp;of&lt;br&gt;<br>
Deferreds,&nbsp;where&nbsp;a&nbsp;callback&nbsp;on&nbsp;the&nbsp;Deferred&nbsp;might&nbsp;return&nbsp;a&nbsp;*new*&nbsp;unfired&lt;br&gt;<br>
Deferred.&nbsp; Now&nbsp;your&nbsp;original&nbsp;Deferred&nbsp;has&nbsp;`called`&nbsp;set&nbsp;to&nbsp;`True`&nbsp;but&nbsp;you&lt;br&gt;<br>
don&#39;t&nbsp;actually&nbsp;have&nbsp;a&nbsp;result&nbsp;yet.&lt;br&gt;<br>
&lt;br&gt;<br>
Instead,&nbsp;there&nbsp;are&nbsp;two&nbsp;obvious&nbsp;options:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;1.&nbsp;Allow&nbsp;the&nbsp;application&nbsp;to&nbsp;return&nbsp;a&nbsp;non-Deferred&nbsp;result.&nbsp; Use&lt;br&gt;<br>
`isinstance`&nbsp;to&nbsp;detect&nbsp;this&nbsp;case&nbsp;and&nbsp;do&nbsp;the&nbsp;synchronous&nbsp;send&nbsp;when&nbsp;you&lt;br&gt;<br>
see&nbsp;a&nbsp;non-Deferred&nbsp;come&nbsp;back.&nbsp; Send&nbsp;the&nbsp;empty&nbsp;ACK&nbsp;and&nbsp;ultimately&nbsp;the&lt;br&gt;<br>
result&nbsp;in&nbsp;the&nbsp;other&nbsp;case.&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp;2.&nbsp;Change&nbsp;your&nbsp;empty&nbsp;ACK&nbsp;logic&nbsp;to&nbsp;be&nbsp;time-based&nbsp;instead.&nbsp; Say,&nbsp;if&nbsp;the&lt;br&gt;<br>
application&nbsp;doesn&#39;t&nbsp;produce&nbsp;a&nbsp;result&nbsp;within&nbsp;10&nbsp;milliseconds,&nbsp;send&nbsp;the&lt;br&gt;<br>
empty&nbsp;ACK.&nbsp; Implement&nbsp;this&nbsp;using&nbsp;`reactor.callLater`&nbsp;and&lt;br&gt;<br>
`IDelayedCall.cancel`.&nbsp; You&#39;ll&nbsp;set&nbsp;up&nbsp;a&nbsp;delayed&nbsp;call&nbsp;to&nbsp;send&nbsp;the&nbsp;empty&lt;br&gt;<br>
ACK&nbsp;every&nbsp;time&nbsp;you&nbsp;call&nbsp;application&nbsp;code,&nbsp;but&nbsp;in&nbsp;the&nbsp;callback&nbsp;on&nbsp;the&lt;br&gt;<br>
application&#39;s&nbsp;Deferred,&nbsp;you&#39;ll&nbsp;cancel&nbsp;that&nbsp;call&nbsp;(unless&nbsp;it&nbsp;has&nbsp;already&lt;br&gt;<br>
happened).&lt;br&gt;<br>
&lt;br&gt;<br>
Hope&nbsp;this&nbsp;helps,&lt;br&gt;<br>
Jean-Paul&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;target=&quot;_blank&quot;&gt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
