<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hi&nbsp;all&lt;br&gt;&lt;br&gt;&lt;/div&gt;I&#39;m&nbsp;building&nbsp;a&nbsp;simple&nbsp;TCP&nbsp;load&nbsp;balancer&nbsp;based&nbsp;on&nbsp;a&nbsp;code&nbsp;snippet&nbsp;from&nbsp;Glyph&nbsp;on&nbsp;SO:&nbsp;&lt;a&nbsp;href=&quot;http://stackoverflow.com/questions/4096061/general-question-regarding-wether-or-not-use-twisted-in-tcp-proxy-project&quot;&gt;http://stackoverflow.com/questions/4096061/general-question-regarding-wether-or-not-use-twisted-in-tcp-proxy-project&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;It&#39;s&nbsp;served&nbsp;me&nbsp;well&nbsp;but&nbsp;I&nbsp;can&#39;t&nbsp;work&nbsp;out&nbsp;how&nbsp;to&nbsp;convert&nbsp;Glyphs&nbsp;round&nbsp;robin&nbsp;retrieval&nbsp;of&nbsp;the&nbsp;server&nbsp;endpoint&nbsp;into&nbsp;an&nbsp;async&nbsp;balancing&nbsp;decision&nbsp;in&nbsp;the&nbsp;buildProtocol&nbsp;method&nbsp;of&nbsp;the&nbsp;Factory.&nbsp;If&nbsp;I&nbsp;return&nbsp;a&nbsp;deferred&nbsp;here&nbsp;it&nbsp;fails&nbsp;with&nbsp;an&nbsp;AttributeError:&nbsp;Deferred&nbsp;instance&nbsp;has&nbsp;no&nbsp;attribute&nbsp;&#39;makeConnection&#39;.&lt;br&gt;<br>
&lt;br&gt;Currently&nbsp;I&#39;m&nbsp;working&nbsp;around&nbsp;this&nbsp;by&nbsp;running&nbsp;a&nbsp;separate&nbsp;management&nbsp;loop&nbsp;that&nbsp;periodically&nbsp;updates&nbsp;a&nbsp;dictionary&nbsp;with&nbsp;all&nbsp;the&nbsp;data&nbsp;necessary&nbsp;to&nbsp;make&nbsp;my&nbsp;routing&nbsp;decision&nbsp;so&nbsp;that&nbsp;I&nbsp;can&nbsp;do&nbsp;it&nbsp;without&nbsp;a&nbsp;deferred.&nbsp;This&nbsp;worries&nbsp;me&nbsp;because&nbsp;I&nbsp;may&nbsp;be&nbsp;making&nbsp;my&nbsp;decision&nbsp;on&nbsp;slightly&nbsp;stale&nbsp;data&nbsp;and&nbsp;I&#39;d&nbsp;really&nbsp;like&nbsp;this&nbsp;to&nbsp;be&nbsp;a&nbsp;real&nbsp;time&nbsp;decision&nbsp;as&nbsp;the&nbsp;connection&nbsp;comes&nbsp;in.&nbsp;Does&nbsp;anyone&nbsp;have&nbsp;a&nbsp;clever&nbsp;way&nbsp;of&nbsp;doing&nbsp;this?&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;An&nbsp;example&nbsp;is&nbsp;below.&nbsp;The&nbsp;hashed&nbsp;out&nbsp;buildProtocol&nbsp;is&nbsp;a&nbsp;synchronous&nbsp;decision&nbsp;which&nbsp;works.&nbsp;Thanks&nbsp;in&nbsp;advance!&lt;br&gt;&lt;br&gt;from&nbsp;twisted.internet.protocol&nbsp;import&nbsp;Factory&lt;br&gt;from&nbsp;twisted.protocols.portforward&nbsp;import&nbsp;ProxyFactory&lt;br&gt;<br>
from&nbsp;twisted.internet&nbsp;import&nbsp;reactor,&nbsp;defer&lt;br&gt;import&nbsp;random&lt;br&gt;&lt;br&gt;from&nbsp;twisted.python&nbsp;import&nbsp;log&lt;br&gt;import&nbsp;sys&lt;br&gt;log.startLogging(sys.stderr)&lt;br&gt;&lt;br&gt;local_ports&nbsp;=&nbsp;set([1024,&nbsp;1025])&lt;br&gt;&lt;br&gt;def&nbsp;port_routing_decision_sync():&lt;br&gt;<br>
   &nbsp;return&nbsp;random.choice(list(local_ports))&lt;br&gt;&lt;br&gt;def&nbsp;port_routing_decision_async():&lt;br&gt;   &nbsp;d&nbsp;=&nbsp;defer.Deferred()&lt;br&gt;   &nbsp;reactor.callLater(1,&nbsp;d.callback,&nbsp;port_routing_decision_sync())&lt;br&gt;   &nbsp;return&nbsp;d&lt;br&gt;&lt;br&gt;class&nbsp;Balancer(Factory):&lt;br&gt;<br>
   &nbsp;#&nbsp;def&nbsp;buildProtocol(self,&nbsp;addr):&lt;br&gt;   &nbsp;#    &nbsp;port&nbsp;=&nbsp;port_routing_decision_sync()&lt;br&gt;   &nbsp;#    &nbsp;print&nbsp;&quot;connecting&nbsp;to&nbsp;local&nbsp;port&nbsp;{}&quot;.format(port)&lt;br&gt;   &nbsp;#    &nbsp;return&nbsp;ProxyFactory(&quot;127.0.0.1&quot;,&nbsp;port).buildProtocol(addr)&lt;br&gt;<br>
&lt;br&gt;   &nbsp;@defer.inlineCallbacks&lt;br&gt;   &nbsp;def&nbsp;buildProtocol(self,&nbsp;addr):&lt;br&gt;       &nbsp;port&nbsp;=&nbsp;yield&nbsp;port_routing_decision_async()&lt;br&gt;       &nbsp;print&nbsp;&quot;connecting&nbsp;to&nbsp;local&nbsp;port&nbsp;{}&quot;.format(port)&lt;br&gt;       &nbsp;defer.returnValue(ProxyFactory(&quot;127.0.0.1&quot;,&nbsp;port).buildProtocol(addr))&lt;br&gt;<br>
&lt;br&gt;def&nbsp;main():&lt;br&gt;   &nbsp;factory&nbsp;=&nbsp;Balancer()&lt;br&gt;   &nbsp;reactor.listenTCP(5678,&nbsp;factory)&lt;br&gt;   &nbsp;reactor.run()&lt;br&gt;&lt;br&gt;if&nbsp;__name__&nbsp;==&nbsp;&quot;__main__&quot;:&lt;br&gt;   &nbsp;main()&lt;br&gt;&lt;/div&gt;<br>

</tt>
