<tt>
&lt;html&gt;&lt;body&gt;On&nbsp;02:32&nbsp;pm,&nbsp;markus@bluegap.ch&nbsp;wrote:&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Requests&nbsp;per&nbsp;second:&nbsp;&#160;&nbsp;&#160;494.40&nbsp;[#/sec]&nbsp;(mean)&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Now,&nbsp;measured&nbsp;while&nbsp;the&nbsp;server&nbsp;is&nbsp;under&nbsp;very&nbsp;small&nbsp;load:&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Requests&nbsp;per&nbsp;second:&nbsp;&#160;&nbsp;&#160;24.37&nbsp;[#/sec]&nbsp;(mean)&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;When&nbsp;putting&nbsp;the&nbsp;server&nbsp;under&nbsp;real&nbsp;load,&nbsp;those&nbsp;response&nbsp;times&nbsp;climb&nbsp;up&nbsp;to&nbsp;&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;What&nbsp;is&nbsp;'real&nbsp;load'?&nbsp;&#160;Are&nbsp;you&nbsp;talking&nbsp;about&nbsp;things&nbsp;in&nbsp;process&nbsp;with,&nbsp;but&nbsp;not&nbsp;related&nbsp;to,&nbsp;the&nbsp;web&nbsp;server?&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;two&nbsp;seconds,&nbsp;so&nbsp;there&nbsp;must&nbsp;be&nbsp;something&nbsp;wrong.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;Maybe&nbsp;your&nbsp;server&nbsp;is&nbsp;slow?&nbsp;:)&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Can&nbsp;I&nbsp;somehow&nbsp;get&nbsp;the&nbsp;reactor's&nbsp;state,&nbsp;i.e.&nbsp;how&nbsp;many&nbsp;deferreds&nbsp;are&nbsp;waiting&nbsp;&lt;br&nbsp;/&gt;&gt;in&nbsp;the&nbsp;queue,&nbsp;how&nbsp;many&nbsp;threads&nbsp;are&nbsp;running&nbsp;concurrently,&nbsp;etc?&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;There&nbsp;is&nbsp;no&nbsp;queue&nbsp;of&nbsp;Deferreds.&nbsp;&#160;They&nbsp;don't&nbsp;actually&nbsp;have&nbsp;anything&nbsp;to&nbsp;do&nbsp;with&nbsp;the&nbsp;reactor.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;How&nbsp;good&nbsp;is&nbsp;the&nbsp;idea&nbsp;of&nbsp;deferring&nbsp;File&nbsp;I/O&nbsp;to&nbsp;threads,&nbsp;i.e.&nbsp;&lt;br&nbsp;/&gt;&gt;threads.deferToThread(self.filehandle.write,&nbsp;data)?&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;If&nbsp;you&nbsp;do&nbsp;indeed&nbsp;discover&nbsp;that&nbsp;you&nbsp;are&nbsp;waiting&nbsp;a&nbsp;long&nbsp;time&nbsp;to&nbsp;write&nbsp;your&nbsp;particular&nbsp;stuff&nbsp;to&nbsp;files,&nbsp;then&nbsp;that&nbsp;might&nbsp;help.&nbsp;&#160;It&nbsp;might&nbsp;also&nbsp;randomly&nbsp;interleave&nbsp;the&nbsp;data&nbsp;and&nbsp;corrupt&nbsp;your&nbsp;files,&nbsp;if&nbsp;'data'&nbsp;is&nbsp;big&nbsp;enough.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;&nbsp;Another&nbsp;possibly&nbsp;&lt;br&nbsp;/&gt;&gt;blocking&nbsp;module&nbsp;might&nbsp;be&nbsp;the&nbsp;database&nbsp;api,&nbsp;but&nbsp;I'm&nbsp;using&nbsp;twisted's&nbsp;&lt;br&nbsp;/&gt;&gt;enterprise&nbsp;adbapi,&nbsp;which&nbsp;should&nbsp;be&nbsp;async,&nbsp;AFAICT.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;It&nbsp;does&nbsp;the&nbsp;operations&nbsp;in&nbsp;threads,&nbsp;yes.&nbsp;&#160;However,&nbsp;the&nbsp;threadpool&nbsp;will&nbsp;eventually&nbsp;fill&nbsp;up;&nbsp;the&nbsp;concurrency&nbsp;is&nbsp;fairly&nbsp;limited.&nbsp;&#160;(The&nbsp;default&nbsp;is&nbsp;10&nbsp;or&nbsp;so&nbsp;workers,&nbsp;I&nbsp;think).&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Maybe&nbsp;copying&nbsp;data&nbsp;around&nbsp;takes&nbsp;time.&nbsp;I'm&nbsp;sending&nbsp;around&nbsp;chunks&nbsp;of&nbsp;64k&nbsp;size&nbsp;&lt;br&nbsp;/&gt;&gt;(streaming&nbsp;from&nbsp;the&nbsp;database&nbsp;to&nbsp;an&nbsp;external&nbsp;programm).&nbsp;Reducing&nbsp;chunk&nbsp;size&nbsp;&lt;br&nbsp;/&gt;&gt;to&nbsp;1k&nbsp;helps&nbsp;somewhat&nbsp;(i.e.&nbsp;response&nbsp;time&nbsp;is&nbsp;seldom&nbsp;over&nbsp;150ms,&nbsp;but&nbsp;can&nbsp;still&nbsp;&lt;br&nbsp;/&gt;&gt;climb&nbsp;up&nbsp;to&nbsp;&gt;&nbsp;0.5&nbsp;seconds).&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;That's&nbsp;a&nbsp;possibility&nbsp;that&nbsp;the&nbsp;&quot;--profile&quot;&nbsp;option&nbsp;to&nbsp;twistd&nbsp;which&nbsp;JP&nbsp;suggested&nbsp;might&nbsp;help&nbsp;you&nbsp;with.&nbsp;&#160;You'll&nbsp;see&nbsp;the&nbsp;functions&nbsp;copying&nbsp;data&nbsp;taking&nbsp;a&nbsp;lot&nbsp;of&nbsp;CPU&nbsp;time&nbsp;in&nbsp;that&nbsp;case.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Hum...&nbsp;external&nbsp;program....&nbsp;maybe&nbsp;it's&nbsp;the&nbsp;self.transport.write()&nbsp;call&nbsp;which&nbsp;&lt;br&nbsp;/&gt;&gt;blocks&nbsp;several&nbsp;100ms?&nbsp;Is&nbsp;it&nbsp;safe&nbsp;to&nbsp;write:&lt;br&nbsp;/&gt;&gt;&lt;br&nbsp;/&gt;&gt;&nbsp;&#160;&nbsp;d&nbsp;=&nbsp;threads.deferToThread(self.transport.write,&nbsp;dataChunk)&lt;br&nbsp;/&gt;&gt;&lt;br&nbsp;/&gt;&gt;(i.e.&nbsp;call&nbsp;transport.write&nbsp;from&nbsp;a&nbsp;thread?)&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;No.&nbsp;&#160;_All_&nbsp;Twisted&nbsp;APIs&nbsp;are&nbsp;not&nbsp;thread&nbsp;safe.&nbsp;&#160;This&nbsp;call&nbsp;does&nbsp;not&nbsp;block&nbsp;though,&nbsp;and&nbsp;it&nbsp;is&nbsp;extremely,&nbsp;vanishingly&nbsp;unlikely&nbsp;that&nbsp;it&nbsp;is&nbsp;causing&nbsp;your&nbsp;problems.&nbsp;&#160;It&nbsp;just&nbsp;sticks&nbsp;some&nbsp;data&nbsp;into&nbsp;the&nbsp;outgoing&nbsp;queue&nbsp;and&nbsp;returns&nbsp;immediately.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;How&nbsp;much&nbsp;resources&nbsp;do&nbsp;these&nbsp;deferToThread()&nbsp;deferreds&nbsp;eat?&nbsp;AFAICT,&nbsp;the&nbsp;&lt;br&nbsp;/&gt;&gt;reactor&nbsp;prepares&nbsp;a&nbsp;thread&nbsp;pool,&nbsp;which&nbsp;leads&nbsp;me&nbsp;to&nbsp;think&nbsp;that&nbsp;it's&nbsp;a&nbsp;well&nbsp;&lt;br&nbsp;/&gt;&gt;optimized&nbsp;implementation...&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;It's&nbsp;not&nbsp;particularly&nbsp;&quot;optimized&quot;,&nbsp;in&nbsp;the&nbsp;sense&nbsp;that&nbsp;we&nbsp;haven't&nbsp;measured&nbsp;the&nbsp;performance&nbsp;or&nbsp;improved&nbsp;it&nbsp;much,&nbsp;but&nbsp;it's&nbsp;also&nbsp;not&nbsp;doing&nbsp;very&nbsp;much;&nbsp;put&nbsp;a&nbsp;value&nbsp;into&nbsp;a&nbsp;queue,&nbsp;get&nbsp;it&nbsp;out&nbsp;in&nbsp;a&nbsp;thread,&nbsp;do&nbsp;it:&nbsp;that's&nbsp;about&nbsp;all.&nbsp;&#160;It&nbsp;would&nbsp;certainly&nbsp;surprise&nbsp;me&nbsp;if&nbsp;that&nbsp;operation&nbsp;were&nbsp;taking&nbsp;100ms.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;One&nbsp;quick&nbsp;measurement&nbsp;you&nbsp;can&nbsp;do&nbsp;to&nbsp;determine&nbsp;what&nbsp;might&nbsp;be&nbsp;causing&nbsp;this&nbsp;performance&nbsp;loss&nbsp;is&nbsp;to&nbsp;examine&nbsp;the&nbsp;server&nbsp;in&nbsp;'top'&nbsp;while&nbsp;it&nbsp;is&nbsp;allegedly&nbsp;under&nbsp;load.&nbsp;&#160;Is&nbsp;it&nbsp;taking&nbsp;up&nbsp;100%&nbsp;CPU?&nbsp;&#160;If&nbsp;not,&nbsp;then&nbsp;it's&nbsp;probably&nbsp;blocked&nbsp;on&nbsp;some&nbsp;kind&nbsp;of&nbsp;I/O&nbsp;in&nbsp;your&nbsp;application,&nbsp;or&nbsp;perhaps&nbsp;writing&nbsp;the&nbsp;log.&nbsp;&#160;If&nbsp;so,&nbsp;then&nbsp;there's&nbsp;some&nbsp;inefficient&nbsp;application&nbsp;code&nbsp;(or&nbsp;Twisted&nbsp;code)&nbsp;that&nbsp;you&nbsp;need&nbsp;to&nbsp;profile&nbsp;and&nbsp;optimize.&nbsp;&#160;The&nbsp;output&nbsp;of&nbsp;&quot;strace&nbsp;-T&quot;&nbsp;on&nbsp;your&nbsp;Twisted&nbsp;server&nbsp;*might*&nbsp;be&nbsp;useful&nbsp;if&nbsp;you&nbsp;discover&nbsp;that&nbsp;you're&nbsp;blocking&nbsp;on&nbsp;some&nbsp;kind&nbsp;of&nbsp;I/O.&lt;br&nbsp;/&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
