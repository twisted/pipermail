<tt>
Howdy&nbsp;list,&lt;br&gt;&lt;br&gt;I&#39;m&nbsp;trying&nbsp;to&nbsp;implement&nbsp;a&nbsp;protocol&nbsp;using&nbsp;Twisted&nbsp;which&nbsp;has&nbsp;a&nbsp;&quot;STARTTLS&quot;&nbsp;command&nbsp;to&nbsp;switch&nbsp;the&nbsp;protocol&nbsp;from&nbsp;plain&nbsp;TCP&nbsp;to&nbsp;TCP&nbsp;over&nbsp;TLS.&lt;br&gt;&lt;br&gt;I&#39;ve&nbsp;mostly&nbsp;been&nbsp;going&nbsp;by&nbsp;the&nbsp;way&nbsp;that&nbsp;the&nbsp;imap4.py&nbsp;module&nbsp;seems&nbsp;to&nbsp;do&nbsp;it,&nbsp;but&nbsp;I&nbsp;can&#39;t&nbsp;seem&nbsp;to&nbsp;get&nbsp;a&nbsp;handshake&nbsp;to&nbsp;complete.&lt;br&gt;<br>
&lt;br&gt;I&nbsp;found&nbsp;this&nbsp;page&nbsp;(&nbsp;&lt;a&nbsp;href=&quot;http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes&quot;&gt;http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes&lt;/a&gt;&nbsp;)&nbsp;which&nbsp;was&nbsp;helpful,&nbsp;but&nbsp;I&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;force&nbsp;client&nbsp;cert&nbsp;authentication.&lt;br&gt;<br>
&lt;br&gt;In&nbsp;order&nbsp;to&nbsp;separate&nbsp;this&nbsp;problem&nbsp;from&nbsp;other&nbsp;issues,&nbsp;I&#39;ve&nbsp;adapted&nbsp;the&nbsp;echo&nbsp;protocol&nbsp;code&nbsp;from&nbsp;above&nbsp;the&nbsp;above&nbsp;page&nbsp;to&nbsp;try&nbsp;and&nbsp;get&nbsp;a&nbsp;simple&nbsp;test&nbsp;case&nbsp;(my&nbsp;code&nbsp;below)&lt;br&gt;&lt;br&gt;I&nbsp;am&nbsp;recieving&nbsp;the&nbsp;following&nbsp;output&nbsp;and&nbsp;traceback&nbsp;when&nbsp;running&nbsp;the&nbsp;client&nbsp;code&nbsp;(&nbsp;on&nbsp;both&nbsp;Windows&nbsp;and&nbsp;Linux&nbsp;):&lt;br&gt;<br>
&lt;br&gt;using&nbsp;TLSv1:&lt;br&gt;&lt;br&gt;&gt;tls_echoclient.py&lt;br&gt;&lt;br&gt;Sending:&nbsp;Hello,&nbsp;world!&lt;br&gt;receive:&nbsp;ERROR:&nbsp;Must&nbsp;authenticate&lt;br&gt;Sending:&nbsp;STARTTLS&lt;br&gt;receive:&nbsp;READY&lt;br&gt;Sending:&nbsp;Continuing&lt;br&gt;connection&nbsp;lost&nbsp;(protocol)&lt;br&gt;connection&nbsp;lost:&nbsp;[(&#39;SSL&nbsp;routines&#39;,&nbsp;&#39;SSL3_READ_BYTES&#39;,&nbsp;&#39;sslv3&nbsp;alert&nbsp;handshake&nbsp;failure&#39;),&nbsp;(&#39;SSL&nbsp;routines&#39;,&nbsp;&#39;SSL3_READ_BYTES&#39;,&nbsp;&#39;ssl&nbsp;handshake&nbsp;failure&#39;)]&lt;br&gt;<br>
Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;br&gt;&nbsp;&nbsp;File&nbsp;&quot;C:\Documents&nbsp;and&nbsp;Settings\kevinh\Desktop\mine_id\sandbox\funsize\sslecho\tls_echoclient.py&quot;,&nbsp;line&nbsp;58,&nbsp;in&nbsp;&lt;module&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;reactor.run()&lt;br&gt;&nbsp;&nbsp;File&nbsp;&quot;C:\Python25\lib\site-packages\twisted\internet\posixbase.py&quot;,&nbsp;line&nbsp;223,&nbsp;in&nbsp;run&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;self.mainLoop()&lt;br&gt;&nbsp;&nbsp;File&nbsp;&quot;C:\Python25\lib\site-packages\twisted\internet\posixbase.py&quot;,&nbsp;line&nbsp;234,&nbsp;in&nbsp;mainLoop&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;self.doIteration(t)&lt;br&gt;&nbsp;&nbsp;File&nbsp;&quot;C:\Python25\lib\site-packages\twisted\internet\selectreactor.py&quot;,&nbsp;line&nbsp;140,&nbsp;in&nbsp;doSelect&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;_logrun(selectable,&nbsp;_drdw,&nbsp;selectable,&nbsp;method,&nbsp;dict)&lt;br&gt;---&nbsp;&lt;exception&nbsp;caught&nbsp;here&gt;&nbsp;---&lt;br&gt;&nbsp;&nbsp;File&nbsp;&quot;C:\Python25\lib\site-packages\twisted\python\log.py&quot;,&nbsp;line&nbsp;51,&nbsp;in&nbsp;callWithLogger&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;callWithContext({&quot;system&quot;:&nbsp;lp},&nbsp;func,&nbsp;*args,&nbsp;**kw)&lt;br&gt;<br>
&lt;&lt;&nbsp;SNIP&nbsp;&gt;&gt;&lt;br&gt;&nbsp;&nbsp;File&nbsp;&quot;C:\Python25\lib\site-packages\twisted\internet\base.py&quot;,&nbsp;line&nbsp;490,&nbsp;in&nbsp;stop&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&quot;Can&#39;t&nbsp;stop&nbsp;reactor&nbsp;that&nbsp;isn&#39;t&nbsp;running.&quot;)&lt;br&gt;twisted.internet.error.ReactorNotRunning:&nbsp;Can&#39;t&nbsp;stop&nbsp;reactor&nbsp;that&nbsp;isn&#39;t&nbsp;running.&lt;br&gt;<br>
&lt;br&gt;What&nbsp;am&nbsp;I&nbsp;doing&nbsp;wrong?&nbsp;&nbsp;Is&nbsp;there&nbsp;a&nbsp;SSL&nbsp;config&nbsp;option&nbsp;I&#39;m&nbsp;setting&nbsp;incorrectly?&nbsp;&nbsp;Do&nbsp;I&nbsp;need&nbsp;to&nbsp;use&nbsp;a&nbsp;different&nbsp;SSL&nbsp;Context?&nbsp;Am&nbsp;I&nbsp;totally&nbsp;off&nbsp;base?&lt;br&gt;&lt;br&gt;Thanks,&nbsp;&lt;br&gt;&lt;br&gt;Kevin&nbsp;Horn&lt;br&gt;&lt;br&gt;=========&nbsp;tls_echoserver.py&lt;br&gt;<br>
&lt;br&gt;#&nbsp;adapted&nbsp;from:&nbsp;&lt;a&nbsp;href=&quot;http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes&quot;&gt;http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes&lt;/a&gt;&lt;br&gt;&lt;br&gt;import&nbsp;sys&lt;br&gt;from&nbsp;OpenSSL&nbsp;import&nbsp;SSL&lt;br&gt;from&nbsp;twisted.python&nbsp;import&nbsp;log&lt;br&gt;<br>
from&nbsp;twisted.internet&nbsp;import&nbsp;ssl,&nbsp;reactor&lt;br&gt;from&nbsp;twisted.protocols.basic&nbsp;import&nbsp;LineReceiver&lt;br&gt;from&nbsp;twisted.internet.protocol&nbsp;import&nbsp;Factory&lt;br&gt;&lt;br&gt;private_key_file&nbsp;=&nbsp;&quot;privkey_dsa.pem&quot;&lt;br&gt;cert_file_name&nbsp;=&nbsp;&quot;cacert.pem&quot;&lt;br&gt;<br>
sslmethod&nbsp;=&nbsp;ssl.SSL.TLSv1_METHOD&lt;br&gt;#~&nbsp;sslmethod&nbsp;=&nbsp;ssl.SSL.SSLv23_METHOD&lt;br&gt;&lt;br&gt;class&nbsp;Echo(LineReceiver):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;donetls&nbsp;=&nbsp;0&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;sendLine(self,&nbsp;line):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;Sending:&quot;,line&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LineReceiver.sendLine(self,line)&lt;br&gt;<br>
&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;lineReceived(self,&nbsp;line):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;Got:&quot;,line&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.donetls:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;Sending&nbsp;OK&quot;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.write(&quot;OK&quot;)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;line&nbsp;==&nbsp;&quot;STARTTLS&quot;:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.sendLine(&quot;READY&quot;)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#~&nbsp;self.tlsCtx&nbsp;=&nbsp;CtxFactory()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.tlsCtx&nbsp;=&nbsp;ssl.DefaultOpenSSLContextFactory(private_key_file,&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cert_file_name,&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslmethod)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.startTLS(self.tlsCtx)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.donetls&nbsp;=&nbsp;1&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.sendLine(&quot;ERROR:&nbsp;Must&nbsp;authenticate&quot;)&lt;br&gt;<br>
&lt;br&gt;factory&nbsp;=&nbsp;Factory()&lt;br&gt;factory.protocol&nbsp;=&nbsp;Echo&lt;br&gt;reactor.listenTCP(8000,&nbsp;factory)&lt;br&gt;reactor.run()&lt;br&gt;&lt;br&gt;=========&nbsp;tls_echoclient.py&lt;br&gt;&lt;br&gt;#&nbsp;adapted&nbsp;from:&nbsp;&lt;a&nbsp;href=&quot;http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes&quot;&gt;http://wiki.vislab.usyd.edu.au/moin.cgi/SSLCertNotes&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;from&nbsp;OpenSSL&nbsp;import&nbsp;SSL&lt;br&gt;import&nbsp;sys&lt;br&gt;&lt;br&gt;from&nbsp;twisted.internet.protocol&nbsp;import&nbsp;ClientFactory&lt;br&gt;from&nbsp;twisted.protocols.basic&nbsp;import&nbsp;LineReceiver&lt;br&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;ssl,&nbsp;reactor&lt;br&gt;&lt;br&gt;class&nbsp;EchoClient(LineReceiver):&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;end=&quot;Bye-bye!&quot;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;connectionMade(self):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.sendLine(&quot;Hello,&nbsp;world!&quot;)&nbsp;&nbsp;#&nbsp;Signals&nbsp;error&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;connectionLost(self,&nbsp;reason):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&#39;connection&nbsp;lost&nbsp;(protocol)&#39;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reactor.stop()&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;sendLine(self,&nbsp;line):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;Sending:&quot;,line&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LineReceiver.sendLine(self,line)&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;lineReceived(self,&nbsp;line):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;receive:&quot;,&nbsp;line&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;line&nbsp;==&nbsp;&quot;ERROR:&nbsp;Must&nbsp;authenticate&quot;:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.sendLine(&quot;STARTTLS&quot;)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;line&nbsp;==&nbsp;&quot;READY&quot;:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#~&nbsp;self.ctx&nbsp;=&nbsp;CxtFactory()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.ctx&nbsp;=&nbsp;ssl.ClientContextFactory()&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.ctx.method&nbsp;=&nbsp;ssl.SSL.TLSv1_METHOD&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#~&nbsp;self.ctx.method&nbsp;=&nbsp;ssl.SSL.SSLv23_METHOD&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.startTLS(self.ctx)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.sendLine(&quot;Continuing&quot;);&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.sendLine(&quot;wibble&quot;)&lt;br&gt;&lt;br&gt;class&nbsp;EchoClientFactory(ClientFactory):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;protocol&nbsp;=&nbsp;EchoClient&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;clientConnectionFailed(self,&nbsp;connector,&nbsp;reason):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&#39;connection&nbsp;failed:&#39;,&nbsp;reason.getErrorMessage()&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reactor.stop()&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;clientConnectionLost(self,&nbsp;connector,&nbsp;reason):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&#39;connection&nbsp;lost:&#39;,&nbsp;reason.getErrorMessage()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reactor.stop()&lt;br&gt;&lt;br&gt;factory&nbsp;=&nbsp;EchoClientFactory()&lt;br&gt;<br>
reactor.connectTCP(&#39;localhost&#39;,&nbsp;8000,&nbsp;factory)&lt;br&gt;reactor.run()&lt;br&gt;<br>

</tt>
