<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;After&nbsp;filing&nbsp;&lt;a&nbsp;href=&quot;https://github.com/tornadoweb/tornado/issues/2636&quot;&nbsp;class=&quot;&quot;&gt;https://github.com/tornadoweb/tornado/issues/2636&lt;/a&gt;&nbsp;recently,&nbsp;I&nbsp;was&nbsp;reminded&nbsp;that&nbsp;Twisted&nbsp;should&nbsp;support&nbsp;asyncio&nbsp;seamlessly,&nbsp;and&nbsp;currently&nbsp;we&nbsp;have&nbsp;some&nbsp;quite-visible&nbsp;seams.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;There&nbsp;are&nbsp;three&nbsp;major&nbsp;use-cases&nbsp;for&nbsp;asyncio&nbsp;integration:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;ol&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&nbsp;class=&quot;&quot;&gt;I've&nbsp;got&nbsp;a&nbsp;large&nbsp;Twisted&nbsp;application.&nbsp;&nbsp;I&nbsp;run&nbsp;the&nbsp;reactor&nbsp;at&nbsp;startup.&nbsp;&nbsp;I&nbsp;find&nbsp;a&nbsp;cool&nbsp;asyncio&nbsp;lib.&nbsp;&nbsp;I&nbsp;want&nbsp;to&nbsp;use&nbsp;it.&nbsp;&nbsp;What&nbsp;do&nbsp;I&nbsp;do?&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;I've&nbsp;got&nbsp;a&nbsp;large&nbsp;asyncio&nbsp;application.&nbsp;&nbsp;I&nbsp;run&nbsp;the&nbsp;main&nbsp;loop&nbsp;at&nbsp;startup.&nbsp;&nbsp;I&nbsp;find&nbsp;a&nbsp;cool&nbsp;twisted&nbsp;lib.&nbsp;&nbsp;I&nbsp;want&nbsp;to&nbsp;use&nbsp;it.&nbsp;&nbsp;What&nbsp;do&nbsp;I&nbsp;do?&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;I'm&nbsp;noodling&nbsp;around&nbsp;in&nbsp;an&nbsp;environment,&nbsp;like&nbsp;a&nbsp;Jupyter&nbsp;notebook,&nbsp;which&nbsp;already&nbsp;happens&nbsp;to&nbsp;have&nbsp;an&nbsp;event&nbsp;loop&nbsp;but&nbsp;I&nbsp;don't&nbsp;really&nbsp;know&nbsp;which&nbsp;one&nbsp;it&nbsp;is.&nbsp;&nbsp;How&nbsp;do&nbsp;I&nbsp;have&nbsp;the&nbsp;fewest&nbsp;number&nbsp;of&nbsp;steps?&lt;/li&gt;&lt;/ol&gt;&lt;br&nbsp;class=&quot;&quot;&gt;What&nbsp;happens&nbsp;today&nbsp;in&nbsp;each&nbsp;case?&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Case&nbsp;1:&nbsp;If&nbsp;I've&nbsp;got&nbsp;a&nbsp;large&nbsp;Twisted&nbsp;application,&nbsp;I&nbsp;either&nbsp;start&nbsp;off&nbsp;by&nbsp;doing&nbsp;Deferred.fromFuture&nbsp;or&nbsp;ensureDeferred.&nbsp;&nbsp;These&nbsp;give&nbsp;me&nbsp;Deferreds&nbsp;that&nbsp;never&nbsp;fire,&nbsp;because&nbsp;no&nbsp;asyncio&nbsp;loop&nbsp;is&nbsp;running,&nbsp;but&nbsp;they&nbsp;don't&nbsp;yell&nbsp;at&nbsp;me;&nbsp;they&nbsp;just&nbsp;hang.&nbsp;&nbsp;Now&nbsp;I&nbsp;have&nbsp;to&nbsp;switch&nbsp;my&nbsp;event&nbsp;loop&nbsp;over&nbsp;to&nbsp;be&nbsp;an&nbsp;AsyncioSelectorReactor.&nbsp;&nbsp;Except&nbsp;wait,&nbsp;my&nbsp;application&nbsp;is&nbsp;a&nbsp;GTK+&nbsp;application,&nbsp;and&nbsp;the&nbsp;only&nbsp;GTK+&nbsp;main&nbsp;loop&nbsp;I&nbsp;can&nbsp;get&nbsp;that&nbsp;implements&nbsp;the&nbsp;asyncio&nbsp;APIs&nbsp;is&nbsp;unmaintained!&nbsp;&nbsp;So&nbsp;I&nbsp;either&nbsp;give&nbsp;up&nbsp;my&nbsp;custom&nbsp;Twisted&nbsp;reactor&nbsp;or&nbsp;I&nbsp;give&nbsp;up&nbsp;my&nbsp;asyncio&nbsp;functionality&nbsp;or&nbsp;I&nbsp;run&nbsp;it&nbsp;all&nbsp;in&nbsp;a&nbsp;thread.&nbsp;&nbsp;None&nbsp;of&nbsp;these&nbsp;are&nbsp;great&nbsp;experiences.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Case&nbsp;2:&nbsp;if&nbsp;I've&nbsp;got&nbsp;an&nbsp;asyncio&nbsp;application,&nbsp;I&nbsp;have&nbsp;a&nbsp;similar&nbsp;problem;&nbsp;I&nbsp;need&nbsp;a&nbsp;reactor,&nbsp;but&nbsp;one&nbsp;isn't&nbsp;running,&nbsp;so&nbsp;all&nbsp;my&nbsp;Deferred.asFuture(get_event_loop())s&nbsp;just&nbsp;hang.&nbsp;&nbsp;So&nbsp;I&nbsp;need&nbsp;to&nbsp;run&nbsp;AsyncioSelectorReactor,&nbsp;but&nbsp;now&nbsp;I&nbsp;need&nbsp;to&nbsp;know&nbsp;a&nbsp;bunch&nbsp;of&nbsp;obscure&nbsp;Twisted&nbsp;trivia&nbsp;to&nbsp;boostrap&nbsp;all&nbsp;of&nbsp;this&nbsp;properly:&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Case&nbsp;3:&nbsp;oh&nbsp;no,&nbsp;how&nbsp;do&nbsp;I&nbsp;even&nbsp;know&nbsp;which&nbsp;one&nbsp;I&nbsp;need&nbsp;to&nbsp;run?&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;In&nbsp;all&nbsp;of&nbsp;these&nbsp;cases&nbsp;I&nbsp;need&nbsp;to&nbsp;know&nbsp;a&nbsp;bunch&nbsp;of&nbsp;really&nbsp;inane&nbsp;trivia:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;ol&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&nbsp;class=&quot;&quot;&gt;I&nbsp;need&nbsp;to&nbsp;call&nbsp;startRunning()&nbsp;on&nbsp;the&nbsp;reactor,&nbsp;but&nbsp;just&nbsp;once,&nbsp;when&nbsp;it&nbsp;gets&nbsp;set&nbsp;up,&nbsp;or&nbsp;threadpool&nbsp;invocations&nbsp;(such&nbsp;as&nbsp;name&nbsp;resolution)&nbsp;will&nbsp;hang.&nbsp;&nbsp;Unless&nbsp;I'm&nbsp;lucky&nbsp;enough&nbsp;to&nbsp;actually&nbsp;control&nbsp;the&nbsp;whole&nbsp;process&nbsp;startup,&nbsp;in&nbsp;which&nbsp;case&nbsp;I&nbsp;can&nbsp;replace&nbsp;my&nbsp;event&nbsp;loop's&nbsp;.run_forever()&nbsp;with&nbsp;Twisted's&nbsp;.run().&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;I&nbsp;need&nbsp;to&nbsp;know&nbsp;whether&nbsp;I&nbsp;need&nbsp;subprocess&nbsp;support,&nbsp;and&nbsp;from&nbsp;whom.&nbsp;&nbsp;If&nbsp;I&nbsp;need&nbsp;it&nbsp;in&nbsp;Twisted,&nbsp;I&nbsp;need&nbsp;to&nbsp;do&nbsp;startRunning(installSignalHandlers=True);&nbsp;if&nbsp;I&nbsp;need&nbsp;it&nbsp;in&nbsp;asyncio,&nbsp;I&nbsp;need&nbsp;to&nbsp;do&nbsp;installSignalHandlers=False.&nbsp;&nbsp;I&nbsp;don't&nbsp;think&nbsp;there's&nbsp;a&nbsp;way&nbsp;to&nbsp;have&nbsp;both.&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;I'd&nbsp;better&nbsp;hope&nbsp;that&nbsp;this&nbsp;is&nbsp;not&nbsp;on&nbsp;Windows,&nbsp;because&nbsp;Twisted&nbsp;is&nbsp;going&nbsp;to&nbsp;use&nbsp;its&nbsp;POSIX&nbsp;socket&nbsp;I/O&nbsp;implementation&nbsp;no&nbsp;matter&nbsp;what.&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Then,&nbsp;once&nbsp;it's&nbsp;up&nbsp;and&nbsp;running,&nbsp;rather&nbsp;than&nbsp;just&nbsp;'await'-ing&nbsp;Deferreds,&nbsp;I&nbsp;always&nbsp;need&nbsp;to&nbsp;await&nbsp;someDeferred().asFuture(loop=get_event_loop()).&nbsp;&nbsp;From&nbsp;a&nbsp;practical&nbsp;perspective,&nbsp;get_event_loop()&nbsp;is&nbsp;the&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;only&lt;/i&gt;&nbsp;correct&nbsp;value&nbsp;that&nbsp;I'd&nbsp;ever&nbsp;want&nbsp;to&nbsp;pass&nbsp;here,&nbsp;but&nbsp;for&nbsp;some&nbsp;reason&nbsp;the&nbsp;library&nbsp;makes&nbsp;me&nbsp;pass&nbsp;it&nbsp;every&nbsp;time.&lt;/li&gt;&lt;/ol&gt;&lt;br&nbsp;class=&quot;&quot;&gt;I&nbsp;propose&nbsp;a&nbsp;series&nbsp;of&nbsp;changes&nbsp;that&nbsp;would&nbsp;make&nbsp;this&nbsp;seamless&nbsp;from&nbsp;either&nbsp;side.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;ol&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Make&nbsp;Deferreds&nbsp;awaitable&nbsp;by&nbsp;asyncio&nbsp;by&nbsp;just&nbsp;calling&nbsp;`get_event_loop`&nbsp;and&nbsp;lying&nbsp;about&nbsp;what&nbsp;loop&nbsp;they're&nbsp;connected&nbsp;to.&nbsp;&nbsp;My&nbsp;reading&nbsp;of&nbsp;this&nbsp;is&nbsp;that&nbsp;&lt;a&nbsp;href=&quot;https://github.com/python/cpython/blob/c5c6cdada3d41148bdeeacfe7528327b481c5d18/Modules/_asynciomodule.c#L215&quot;&nbsp;class=&quot;&quot;&gt;https://github.com/python/cpython/blob/c5c6cdada3d41148bdeeacfe7528327b481c5d18/Modules/_asynciomodule.c#L215&lt;/a&gt;&nbsp;will&nbsp;totally&nbsp;let&nbsp;us&nbsp;do&nbsp;that,&nbsp;if&nbsp;we&nbsp;just&nbsp;have&nbsp;a&nbsp;get_loop&nbsp;method&nbsp;(or,&nbsp;gross,&nbsp;_loop&nbsp;property)&nbsp;on&nbsp;Deferred&nbsp;or&nbsp;whatever's&nbsp;returned&nbsp;from&nbsp;Deferred.__await__.&nbsp;&nbsp;It&nbsp;would&nbsp;be&nbsp;fine&nbsp;if&nbsp;this&nbsp;raised&nbsp;a&nbsp;warning&nbsp;or&nbsp;something,&nbsp;as&nbsp;long&nbsp;as&nbsp;it&nbsp;worked&nbsp;in&nbsp;the&nbsp;80%&nbsp;case&nbsp;so&nbsp;people&nbsp;could&nbsp;get&nbsp;some&nbsp;initial&nbsp;success&nbsp;and&nbsp;a&nbsp;pointer&nbsp;as&nbsp;to&nbsp;how&nbsp;to&nbsp;succeed,&nbsp;and&nbsp;not&nbsp;just&nbsp;hitting&nbsp;a&nbsp;wall&nbsp;with&nbsp;&quot;task&nbsp;got&nbsp;bad&nbsp;yield&quot;.&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Make&nbsp;the&nbsp;reactor&nbsp;automagical.&lt;/li&gt;&lt;ol&nbsp;class=&quot;&quot;&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Phase&nbsp;one&nbsp;of&nbsp;this&nbsp;change&nbsp;would&nbsp;be:&nbsp;when&nbsp;you&nbsp;do&nbsp;'from&nbsp;twisted.internet&nbsp;import&nbsp;reactor',&nbsp;if&nbsp;there's&nbsp;already&nbsp;an&nbsp;asyncio&nbsp;loop&nbsp;installed&nbsp;and&nbsp;running,&nbsp;automatically&nbsp;select&nbsp;the&nbsp;asyncio&nbsp;integration.&nbsp;&nbsp;This&nbsp;only&nbsp;helps&nbsp;you&nbsp;if&nbsp;you're&nbsp;in&nbsp;a&nbsp;context&nbsp;like&nbsp;a&nbsp;Jupyter&nbsp;notebook&nbsp;where&nbsp;you're&nbsp;not&nbsp;doing&nbsp;it&nbsp;at&nbsp;the&nbsp;module&nbsp;level,&nbsp;but&nbsp;that's&nbsp;still&nbsp;interesting.&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Make&nbsp;'twisted.internet.reactor'&nbsp;into&nbsp;a&nbsp;dynamic&nbsp;proxy&nbsp;object&nbsp;which&nbsp;forwards&nbsp;reactor&nbsp;calls&nbsp;to&nbsp;whichever&nbsp;the&nbsp;running&nbsp;reactor&nbsp;is&nbsp;at&nbsp;the&nbsp;moment&nbsp;of&nbsp;the&nbsp;method&nbsp;call&nbsp;(connectTCP,&nbsp;callLater,&nbsp;etc).&nbsp;&nbsp;This&nbsp;can&nbsp;move&nbsp;the&nbsp;reactor&nbsp;selection&nbsp;to&nbsp;whenever&nbsp;the&nbsp;&quot;first&nbsp;touch&quot;&nbsp;on&nbsp;the&nbsp;reactor&nbsp;is,&nbsp;rather&nbsp;than&nbsp;whenever&nbsp;it's&nbsp;imported.&nbsp;&nbsp;(This&nbsp;also&nbsp;fixes&nbsp;a&nbsp;ton&nbsp;of&nbsp;of&nbsp;annoying&nbsp;import-order&nbsp;stuff&nbsp;in&nbsp;Twisted&nbsp;itself,&nbsp;as&nbsp;a&nbsp;bonus.)&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Automatically&nbsp;call&nbsp;startRunning()&nbsp;as&nbsp;necessary&nbsp;if&nbsp;another&nbsp;loop&nbsp;is&nbsp;in&nbsp;charge.&lt;/li&gt;&lt;/ol&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Fix&nbsp;the&nbsp;subprocess&nbsp;integration:&lt;/li&gt;&lt;ol&nbsp;class=&quot;&quot;&gt;&lt;li&nbsp;class=&quot;&quot;&gt;As&nbsp;a&nbsp;simple&nbsp;first&nbsp;step,&nbsp;for&nbsp;UNIX,&nbsp;at&nbsp;least&nbsp;participate&nbsp;in&nbsp;the&nbsp;asyncio&nbsp;get_child_watcher()&nbsp;/&nbsp;set_child_watcher()&nbsp;protocol,&nbsp;so&nbsp;that&nbsp;at&nbsp;least&nbsp;someone&nbsp;trying&nbsp;to&nbsp;coordinate&nbsp;a&nbsp;Twisted&nbsp;loop&nbsp;and&nbsp;an&nbsp;asyncio&nbsp;loop&nbsp;can&nbsp;intentionally&nbsp;select&nbsp;which&nbsp;one&nbsp;gets&nbsp;child&nbsp;process&nbsp;termination&nbsp;notifications,&nbsp;and&nbsp;possibly&nbsp;even&nbsp;multiplex&nbsp;this.&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Fix&nbsp;subprocesses&nbsp;along&nbsp;with&nbsp;any&nbsp;platform-specific&nbsp;socket&nbsp;quirks,&nbsp;by&nbsp;doing&nbsp;the&nbsp;next&nbsp;step...&lt;/li&gt;&lt;/ol&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Actually&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;use&lt;/i&gt;&nbsp;the&nbsp;asyncio&nbsp;APIs&nbsp;in&nbsp;the&nbsp;&quot;asyncio&nbsp;side&nbsp;down&quot;&nbsp;integration,&nbsp;i.e.&nbsp;AsyncioSelectorReactor.&nbsp;&nbsp;Presently&nbsp;we&nbsp;implement&nbsp;everything&nbsp;in&nbsp;terms&nbsp;of&nbsp;the&nbsp;add_reader&nbsp;and&nbsp;add_writer&nbsp;APIs,&nbsp;which&nbsp;is&nbsp;both&nbsp;very&nbsp;low-level&nbsp;and&nbsp;also&nbsp;fairly&nbsp;UNIX-specific.&nbsp;&nbsp;We&nbsp;should&nbsp;instead&nbsp;be&nbsp;using&nbsp;loop.create_connection,&nbsp;loop.create_server,&nbsp;loop.subprocess_exec,&nbsp;loop.getaddrinfo,&nbsp;etc,&nbsp;and&nbsp;translating&nbsp;between&nbsp;asyncio&nbsp;protocol/transport&nbsp;APIs&nbsp;and&nbsp;our&nbsp;own.&lt;/li&gt;&lt;li&nbsp;class=&quot;&quot;&gt;Implement&nbsp;the&nbsp;&quot;twisted&nbsp;side&nbsp;down&quot;&nbsp;integration&nbsp;with&nbsp;asyncio;&nbsp;i.e.&nbsp;instead&nbsp;of&nbsp;implementing&nbsp;the&nbsp;twisted&nbsp;APIs&nbsp;in&nbsp;terms&nbsp;of&nbsp;asyncio's&nbsp;interfaces,&nbsp;implement&nbsp;the&nbsp;asyncio&nbsp;APIs&nbsp;in&nbsp;terms&nbsp;of&nbsp;Twisted's&nbsp;interfaces,&nbsp;so&nbsp;we&nbsp;can&nbsp;use&nbsp;existing&nbsp;custom&nbsp;reactors,&nbsp;GUI&nbsp;loop&nbsp;integration,&nbsp;etc.&lt;/li&gt;&lt;/ol&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;This&nbsp;is&nbsp;all&nbsp;quite&nbsp;a&nbsp;bit&nbsp;of&nbsp;work&nbsp;but&nbsp;I&nbsp;think&nbsp;it&nbsp;would&nbsp;massively&nbsp;improve&nbsp;the&nbsp;experience&nbsp;of&nbsp;a&nbsp;novice&nbsp;trying&nbsp;to&nbsp;adopt&nbsp;Twisted&nbsp;in&nbsp;a&nbsp;modern&nbsp;Python&nbsp;stack.&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;In&nbsp;particular,&nbsp;I&nbsp;think&nbsp;that&nbsp;in&nbsp;addition&nbsp;to&nbsp;being&nbsp;a&nbsp;good&nbsp;example&nbsp;of&nbsp;the&nbsp;general&nbsp;problem&nbsp;domain,&nbsp;Jupyter&nbsp;is&nbsp;quite&nbsp;specifically&nbsp;incredibly&nbsp;strategic,&nbsp;and&nbsp;having&nbsp;the&nbsp;ability&nbsp;to&nbsp;just&nbsp;grab&nbsp;Treq&nbsp;and&nbsp;start&nbsp;doing&nbsp;massively&nbsp;parallel&nbsp;I/O&nbsp;to&nbsp;ingest&nbsp;data,&nbsp;then&nbsp;just&nbsp;'await'&nbsp;on&nbsp;it,&nbsp;would&nbsp;be&nbsp;a&nbsp;very&nbsp;powerful&nbsp;demonstration&nbsp;of&nbsp;Twisted's&nbsp;capabilities.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Let&nbsp;me&nbsp;know&nbsp;what&nbsp;you&nbsp;all&nbsp;think!&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;-glyph&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
