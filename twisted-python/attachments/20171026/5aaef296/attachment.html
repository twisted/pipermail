<tt>
&lt;html&nbsp;style=&quot;direction:&nbsp;ltr;&quot;&gt;<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=utf-8&quot;&gt;<br>
&lt;style&nbsp;type=&quot;text/css&quot;&gt;body&nbsp;p&nbsp;{&nbsp;margin-bottom:&nbsp;0cm;&nbsp;margin-top:&nbsp;0pt;&nbsp;}&nbsp;&lt;/style&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bidimailui-charset-is-forced=&quot;true&quot;&nbsp;style=&quot;direction:&nbsp;ltr;&quot;&nbsp;text=&quot;#000000&quot;&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;<br>
&lt;div&nbsp;class=&quot;moz-cite-prefix&quot;&gt;Thanks&nbsp;exvito&nbsp;for&nbsp;your&nbsp;detailed&nbsp;response.&lt;br&gt;<br>
Re&nbsp;2&nbsp;&amp;&nbsp;3:&nbsp;You're&nbsp;right&nbsp;on&nbsp;the&nbsp;nail&nbsp;&lt;span&nbsp;class=&quot;moz-smiley-s1&quot;&gt;&lt;span&gt;:-)&lt;/span&gt;&lt;/span&gt;&nbsp;&nbsp;See&nbsp;my&nbsp;previous&nbsp;email&nbsp;to&nbsp;Jason.&lt;br&gt;<br>
Re&nbsp;4:&nbsp;I&nbsp;can't&nbsp;use&nbsp;the&nbsp;high&nbsp;level&nbsp;Transport&nbsp;mechanism&nbsp;as&nbsp;I&nbsp;am&nbsp;using&nbsp;Twisted&nbsp;(most&nbsp;of&nbsp;the&nbsp;time)&nbsp;through&nbsp;another&nbsp;library&nbsp;layer&nbsp;(pymodbus).&lt;br&gt;<br>
Re&nbsp;5:&nbsp;My&nbsp;server&nbsp;is&nbsp;still&nbsp;using&nbsp;Python's&nbsp;bloated&nbsp;ThreadingTCPServer&nbsp;model.&nbsp;&lt;br&gt;<br>
Re&nbsp;6:&nbsp;Right!&lt;br&gt;<br>
&lt;br&gt;<br>
Bottom&nbsp;line,&nbsp;I&nbsp;suggested&nbsp;a&nbsp;change&nbsp;of&nbsp;argument&nbsp;name,&nbsp;from&nbsp;&quot;ssl.optionsForClientTLS(hostName,&nbsp;...&quot;&nbsp;to&nbsp;&quot;ssl.optionsForClientTLS(commonName,&nbsp;...&quot;&lt;br&gt;<br>
&lt;br&gt;<br>
Regards,&nbsp;Enoch.&lt;br&gt;<br>
&lt;br&gt;<br>
On&nbsp;10/26/2017&nbsp;05:20&nbsp;AM,&nbsp;ex&nbsp;vito&nbsp;wrote:&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;cite=&quot;mid:4FAF7ED7-0C2B-4D11-B0D8-24B662270136@gmail.com&quot;&gt;<br>
&lt;pre&nbsp;wrap=&quot;&quot;&gt;On&nbsp;2017-10-25,&nbsp;at&nbsp;21:07,&nbsp;Enoch&nbsp;W.&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-rfc2396E&quot;&nbsp;href=&quot;mailto:ixew@hotmail.com&quot;&gt;&lt;ixew@hotmail.com&gt;&lt;/a&gt;&nbsp;wrote:<br>
<br>
&lt;/pre&gt;<br>
&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;<br>
&lt;pre&nbsp;wrap=&quot;&quot;&gt;Hi,<br>
<br>
I&nbsp;am&nbsp;using&nbsp;a&nbsp;self-signed&nbsp;CA&nbsp;to&nbsp;issue&nbsp;server&nbsp;and&nbsp;client(s)&nbsp;certificates.&nbsp;<br>
<br>
My&nbsp;server&nbsp;is&nbsp;using&nbsp;the&nbsp;standard&nbsp;Python&nbsp;ssl&nbsp;module.&nbsp;<br>
One&nbsp;client,&nbsp;that&nbsp;is&nbsp;using&nbsp;twisted.internet.ssl,&nbsp;consistently&nbsp;fails&nbsp;to&nbsp;connect&nbsp;with:&nbsp;<br>
On&nbsp;the&nbsp;Server:&nbsp;&nbsp;&nbsp;&nbsp;[SSL:&nbsp;TLSV1_ALERT_UNKNOWN_CA]&nbsp;tlsv1&nbsp;alert&nbsp;unknown&nbsp;ca&nbsp;(_ssl.c:661),&nbsp;<br>
On&nbsp;the&nbsp;Client:&nbsp;&nbsp;&nbsp;&nbsp;[WARNING]&nbsp;[('SSL&nbsp;routines',&nbsp;'tls_process_server_certificate',&nbsp;'certificate&nbsp;verify&nbsp;failed')]<br>
<br>
This&nbsp;is&nbsp;my&nbsp;code:<br>
<br>
path&nbsp;=&nbsp;getModule(__name__).filePath.sibling(u'data')<br>
<br>
txt&nbsp;=&nbsp;path.child(u'ca.crt').getContent()<br>
cacert&nbsp;=&nbsp;ssl.Certificate.loadPEM(txt)<br>
root&nbsp;=&nbsp;ssl.trustRootFromCertificates([cacert])<br>
<br>
txt&nbsp;=&nbsp;path.child(u'client.pem').getContent()<br>
mycert&nbsp;=&nbsp;ssl.PrivateCertificate.loadPEM(txt)<br>
<br>
ctx&nbsp;=&nbsp;ssl.optionsForClientTLS(hostName,&nbsp;trustRoot=root,&nbsp;clientCertificate=mycert)<br>
<br>
reactor.connectSSL(hostName,&nbsp;portNumber,&nbsp;factory,&nbsp;ctx)<br>
<br>
<br>
I&nbsp;am&nbsp;using&nbsp;the&nbsp;latest&nbsp;git&nbsp;trunk&nbsp;code.<br>
With&nbsp;a&nbsp;regular&nbsp;ssl&nbsp;client&nbsp;I&nbsp;don't&nbsp;have&nbsp;an&nbsp;issue.<br>
<br>
A&nbsp;known&nbsp;bug?<br>
&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;pre&nbsp;wrap=&quot;&quot;&gt;<br>
I&nbsp;would&nbsp;review&nbsp;a&nbsp;few&nbsp;things&nbsp;before&nbsp;suspecting&nbsp;a&nbsp;bug.<br>
<br>
Your&nbsp;code&nbsp;is&nbsp;using&nbsp;client&nbsp;side&nbsp;certificates&nbsp;(nice,&nbsp;not&nbsp;often&nbsp;seen)&nbsp;so&nbsp;both&nbsp;server&nbsp;and&nbsp;client&nbsp;need&nbsp;to&nbsp;validate&nbsp;each&nbsp;other's&nbsp;certificates&nbsp;on&nbsp;connection&nbsp;establishment.&nbsp;It&nbsp;seems&nbsp;they&nbsp;are&nbsp;both&nbsp;failing,&nbsp;but&nbsp;we're&nbsp;only&nbsp;looking&nbsp;at&nbsp;your&nbsp;client&nbsp;code&nbsp;though.<br>
<br>
Here&nbsp;are&nbsp;a&nbsp;few&nbsp;ideas:<br>
<br>
1.&nbsp;Double&nbsp;check&nbsp;your&nbsp;certificates:&nbsp;Issuers,&nbsp;Subjects,&nbsp;Dates,&nbsp;SANs,&nbsp;etc.<br>
<br>
2.&nbsp;Check&nbsp;that&nbsp;the&nbsp;hostName&nbsp;in&nbsp;optionsForClientTLS&nbsp;matches&nbsp;the&nbsp;name&nbsp;in&nbsp;the&nbsp;server&nbsp;certificate.<br>
<br>
3.&nbsp;Use&nbsp;the&nbsp;latest&nbsp;Twisted&nbsp;release&nbsp;instead&nbsp;of&nbsp;trunk,&nbsp;if&nbsp;possible.<br>
&nbsp;&nbsp;&nbsp;Do&nbsp;the&nbsp;same&nbsp;for&nbsp;pyOpenSSL&nbsp;and&nbsp;other&nbsp;dependencies.<br>
<br>
4.&nbsp;On&nbsp;the&nbsp;client&nbsp;side&nbsp;try&nbsp;using&nbsp;SSL4ClientEndpoint&nbsp;instead&nbsp;of&nbsp;connectSSL.<br>
&nbsp;&nbsp;&nbsp;I'm&nbsp;almost&nbsp;sure&nbsp;they&nbsp;behave&nbsp;differently&nbsp;regarding&nbsp;validation&nbsp;(could&nbsp;not&nbsp;quickly&nbsp;find<br>
&nbsp;&nbsp;&nbsp;docs&nbsp;on&nbsp;that,&nbsp;though:&nbsp;I've&nbsp;had&nbsp;your&nbsp;problem&nbsp;before&nbsp;and&nbsp;I&nbsp;think&nbsp;I&nbsp;addressed&nbsp;it&nbsp;this&nbsp;way).<br>
<br>
&nbsp;&nbsp;&nbsp;Instead&nbsp;of&nbsp;reactor.connectSSL(...)&nbsp;go&nbsp;for&nbsp;something&nbsp;like:<br>
<br>
&nbsp;&nbsp;&nbsp;ep&nbsp;=&nbsp;endpoints.SSL4ClientEndpoint(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reactor,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;host=hostName,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port=portNumber,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslContextFactory=ctx,<br>
&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;client&nbsp;=&nbsp;yield&nbsp;ep.connect(factory)<br>
<br>
&nbsp;&nbsp;&nbsp;For&nbsp;completeness,&nbsp;even&nbsp;though&nbsp;my&nbsp;client&nbsp;skeleton&nbsp;is&nbsp;mostly&nbsp;your&nbsp;client&nbsp;code&nbsp;with<br>
&nbsp;&nbsp;&nbsp;this&nbsp;diff,&nbsp;a&nbsp;quick&nbsp;test&nbsp;shows&nbsp;that&nbsp;my&nbsp;client&nbsp;also&nbsp;establishes&nbsp;the&nbsp;TLS&nbsp;connection<br>
&nbsp;&nbsp;&nbsp;if&nbsp;I&nbsp;do&nbsp;the&nbsp;reverse:&nbsp;replace&nbsp;SSL4ClientEndpoint&nbsp;with&nbsp;connectSSL&nbsp;in&nbsp;my&nbsp;code.<br>
<br>
&nbsp;&nbsp;&nbsp;This&nbsp;may&nbsp;not&nbsp;be&nbsp;the&nbsp;culprit,&nbsp;but&nbsp;I&nbsp;would&nbsp;try&nbsp;and&nbsp;see&nbsp;if&nbsp;anything&nbsp;changes.<br>
<br>
5.&nbsp;On&nbsp;the&nbsp;server&nbsp;side&nbsp;I&nbsp;have&nbsp;the&nbsp;following&nbsp;Twisted&nbsp;code&nbsp;skeleton:<br>
<br>
&nbsp;&nbsp;&nbsp;dhFile&nbsp;=&nbsp;filepath.FilePath(...)<br>
&nbsp;&nbsp;&nbsp;dhParams&nbsp;=&nbsp;ssl.DiffieHellmanParameters.fromFile(dhFile)<br>
&nbsp;&nbsp;&nbsp;caCert&nbsp;=&nbsp;ssl.Certificate.loadPEM(...)<br>
&nbsp;&nbsp;&nbsp;privateCert&nbsp;=&nbsp;ssl.PrivateCertificate.loadPEM(...)<br>
&nbsp;&nbsp;&nbsp;cf&nbsp;=&nbsp;ssl.CertificateOptions(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;privateKey=privateCert.privateKey.original,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;certificate=privateCert.original,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trustRoot=caCert,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dhParameters=dhParams,<br>
&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;ep&nbsp;=&nbsp;endpoints.SSL4ServerEndpoint(<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reactor,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port=...,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sslContextFactory=cf,<br>
&nbsp;&nbsp;&nbsp;)<br>
&nbsp;&nbsp;&nbsp;f&nbsp;=&nbsp;protocol.Factory.forProtocol(...)<br>
&nbsp;&nbsp;&nbsp;ep.listen(f)<br>
&nbsp;&nbsp;&nbsp;reactor.run()<br>
<br>
&nbsp;&nbsp;&nbsp;Your&nbsp;code&nbsp;is&nbsp;obviously&nbsp;different,&nbsp;if&nbsp;based&nbsp;on&nbsp;the&nbsp;standard&nbsp;library's&nbsp;ssl&nbsp;module.<br>
&nbsp;&nbsp;&nbsp;If&nbsp;1&nbsp;to&nbsp;4&nbsp;don't&nbsp;produce&nbsp;results,&nbsp;this&nbsp;is&nbsp;a&nbsp;good&nbsp;candidate&nbsp;for&nbsp;needing&nbsp;some&nbsp;work.<br>
&nbsp;&nbsp;&nbsp;Can&nbsp;you&nbsp;share&nbsp;a&nbsp;minimal&nbsp;version&nbsp;of&nbsp;that?&nbsp;I'll&nbsp;be&nbsp;glad&nbsp;to&nbsp;take&nbsp;it&nbsp;for&nbsp;a&nbsp;spin.<br>
<br>
6.&nbsp;Double&nbsp;check&nbsp;your&nbsp;certificates,&nbsp;again.&nbsp;Triple-check&nbsp;them&nbsp;if&nbsp;managed&nbsp;manually.<br>
<br>
<br>
For&nbsp;completeness&nbsp;and&nbsp;reference:<br>
-&nbsp;See&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://twistedmatrix.com/documents/current/core/howto/ssl.html&quot;&gt;http://twistedmatrix.com/documents/current/core/howto/ssl.html&lt;/a&gt;&nbsp;as&nbsp;a&nbsp;starting&nbsp;point<br>
&nbsp;&nbsp;Twisted&nbsp;TLS,&nbsp;containing&nbsp;useful&nbsp;information&nbsp;and&nbsp;working&nbsp;examples.<br>
-&nbsp;My&nbsp;working&nbsp;test&nbsp;environment&nbsp;runs&nbsp;Linux&nbsp;with&nbsp;OpenSSL&nbsp;1.0.1t.<br>
<br>
<br>
Cheers,<br>
--<br>
exvito<br>
<br>
_______________________________________________<br>
Twisted-Python&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&gt;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;<br>
&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
