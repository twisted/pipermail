<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=windows-1252&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;Honored&nbsp;twistedeers,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Consider&nbsp;the&nbsp;following&nbsp;(blocking)&nbsp;decorator,&nbsp;which&nbsp;runs&nbsp;a&nbsp;function&nbsp;in&nbsp;a&nbsp;transaction:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;def&nbsp;_with_transaction(f):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;decorated(self,&nbsp;*args,&nbsp;**kwargs):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn&nbsp;=&nbsp;self.engine.connect()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txn&nbsp;=&nbsp;conn.begin()&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;f(self,&nbsp;conn,&nbsp;*args,&nbsp;**kwargs)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txn.rollback()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txn.commit()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;decorated&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;webkit-block-placeholder&quot;&gt;&lt;/div&gt;&lt;div&gt;Where&nbsp;I&nbsp;to&nbsp;translate&nbsp;this&nbsp;logic&nbsp;verbatim&nbsp;to&nbsp;@inlineCallbacks,&nbsp;I&nbsp;get:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;def&nbsp;_with_transaction(f):&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;@inlineCallbacks&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;decorated(self,&nbsp;*args,&nbsp;**kwargs):&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;conn&nbsp;=&nbsp;yield&nbsp;self.engine.connect()&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txn&nbsp;=&nbsp;yield&nbsp;conn.begin()&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;yield&nbsp;f(self,&nbsp;conn,&nbsp;*args,&nbsp;**kwargs)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;txn.rollback()&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;txn.commit()&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;returnValue(result)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;decorated&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;webkit-block-placeholder&quot;&gt;&lt;/div&gt;&lt;div&gt;However,&nbsp;there’s&nbsp;a&nbsp;bug&nbsp;here!&nbsp;In&nbsp;the&nbsp;except&nbsp;clause:&nbsp;there’s&nbsp;an&nbsp;(implicit)&nbsp;current&nbsp;exception,&nbsp;to&nbsp;be&nbsp;re-raised&nbsp;by&nbsp;the&nbsp;bare&nbsp;raise&nbsp;statement.&nbsp;Unfortunately,&nbsp;when&nbsp;doing&nbsp;yield&nbsp;txn.rollback(),&nbsp;that&nbsp;conveniently&nbsp;eats&nbsp;said&nbsp;exception.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Of&nbsp;course,&nbsp;there’s&nbsp;a&nbsp;fairly&nbsp;simple&nbsp;workaround&nbsp;involving&nbsp;catching&nbsp;BaseException&nbsp;and&nbsp;capturing&nbsp;the&nbsp;exception&nbsp;instance&nbsp;explicitly.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I’m&nbsp;wondering&nbsp;if&nbsp;this&nbsp;is&nbsp;just&nbsp;a&nbsp;leaky&nbsp;abstraction,&nbsp;or&nbsp;if&nbsp;I&nbsp;should&nbsp;report&nbsp;it&nbsp;as&nbsp;a&nbsp;bug&nbsp;in&nbsp;@inlineCallbacks?&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;webkit-block-placeholder&quot;&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;cheers&lt;br&gt;lvh&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
