<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=windows-1252&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Jul&nbsp;28,&nbsp;2014,&nbsp;at&nbsp;1:54&nbsp;AM,&nbsp;Laurens&nbsp;Van&nbsp;Houtven&nbsp;&lt;_@lvh.io&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=windows-1252&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;Honored&nbsp;twistedeers,&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Seriously,&nbsp;we&nbsp;need&nbsp;to&nbsp;come&nbsp;up&nbsp;with&nbsp;a&nbsp;good&nbsp;collective&nbsp;noun&nbsp;for&nbsp;ourselves&nbsp;one&nbsp;day.&nbsp;&nbsp;We&nbsp;should&nbsp;have&nbsp;a&nbsp;referendum&nbsp;or&nbsp;something.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;&lt;div&gt;Consider&nbsp;the&nbsp;following&nbsp;(blocking)&nbsp;decorator,&nbsp;which&nbsp;runs&nbsp;a&nbsp;function&nbsp;in&nbsp;a&nbsp;transaction:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;def&nbsp;_with_transaction(f):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;decorated(self,&nbsp;*args,&nbsp;**kwargs):&lt;br&gt;...&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;f(self,&nbsp;conn,&nbsp;*args,&nbsp;**kwargs)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txn.rollback()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;...&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;&lt;div&gt;Where&nbsp;I&nbsp;to&nbsp;translate&nbsp;this&nbsp;logic&nbsp;verbatim&nbsp;to&nbsp;@inlineCallbacks,&nbsp;I&nbsp;get:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;def&nbsp;_with_transaction(f):&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;@inlineCallbacks&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;decorated(self,&nbsp;*args,&nbsp;**kwargs):&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;...&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;yield&nbsp;f(self,&nbsp;conn,&nbsp;*args,&nbsp;**kwargs)&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except:&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;txn.rollback()&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;Monaco;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;face=&quot;Monaco&quot;&gt;...&lt;/font&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;webkit-block-placeholder&quot;&gt;&lt;/div&gt;&lt;div&gt;However,&nbsp;there’s&nbsp;a&nbsp;bug&nbsp;here!&nbsp;In&nbsp;the&nbsp;except&nbsp;clause:&nbsp;there’s&nbsp;an&nbsp;(implicit)&nbsp;current&nbsp;exception,&nbsp;to&nbsp;be&nbsp;re-raised&nbsp;by&nbsp;the&nbsp;bare&nbsp;raise&nbsp;statement.&nbsp;Unfortunately,&nbsp;when&nbsp;doing&nbsp;yield&nbsp;txn.rollback(),&nbsp;that&nbsp;conveniently&nbsp;eats&nbsp;said&nbsp;exception.&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;actually&nbsp;true&nbsp;of&nbsp;_with_transaction&nbsp;as&nbsp;well.&nbsp;&nbsp;Any&nbsp;code,&nbsp;anywhere,&nbsp;&lt;i&gt;might&lt;/i&gt;&nbsp;call&nbsp;sys.exc_clear(),&nbsp;or&nbsp;do&nbsp;some&nbsp;interpreter&nbsp;shenanigans&nbsp;that&nbsp;accidentally&nbsp;make&nbsp;the&nbsp;equivalent&nbsp;happen.&nbsp;&nbsp;So&nbsp;when&nbsp;you&nbsp;are&nbsp;calling&nbsp;&quot;rollback&quot;&nbsp;on&nbsp;your&nbsp;transaction&nbsp;and&nbsp;perhaps&nbsp;running&nbsp;application&nbsp;code&nbsp;in&nbsp;a&nbsp;post-rollback&nbsp;hook&nbsp;(because&nbsp;your&nbsp;database&nbsp;has&nbsp;that,&nbsp;right?&nbsp;&nbsp;you&nbsp;totally&nbsp;need&nbsp;it&nbsp;for&nbsp;some&nbsp;things).&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;And&nbsp;of&nbsp;course&nbsp;rollback&nbsp;can&nbsp;*itself*&nbsp;fail&nbsp;which&nbsp;wipes&nbsp;out&nbsp;the&nbsp;exception&nbsp;anyway&nbsp;-&nbsp;is&nbsp;that&nbsp;what&nbsp;you&nbsp;want&nbsp;to&nbsp;happen&nbsp;in&nbsp;that&nbsp;condition?&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;&lt;div&gt;Of&nbsp;course,&nbsp;there’s&nbsp;a&nbsp;fairly&nbsp;simple&nbsp;workaround&nbsp;involving&nbsp;catching&nbsp;BaseException&nbsp;and&nbsp;capturing&nbsp;the&nbsp;exception&nbsp;instance&nbsp;explicitly.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I’m&nbsp;wondering&nbsp;if&nbsp;this&nbsp;is&nbsp;just&nbsp;a&nbsp;leaky&nbsp;abstraction,&nbsp;or&nbsp;if&nbsp;I&nbsp;should&nbsp;report&nbsp;it&nbsp;as&nbsp;a&nbsp;bug&nbsp;in&nbsp;@inlineCallbacks?&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;I&nbsp;don't&nbsp;think&nbsp;there's&nbsp;any&nbsp;such&nbsp;thing&nbsp;as&nbsp;&quot;just&quot;&nbsp;a&nbsp;leaky&nbsp;abstraction&nbsp;:-).&nbsp;&nbsp;If&nbsp;an&nbsp;abstraction&nbsp;leaks&nbsp;in&nbsp;an&nbsp;unspecified&nbsp;way,&nbsp;it's&nbsp;a&nbsp;bug.&nbsp;&nbsp;Report&nbsp;away.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Personally,&nbsp;I'd&nbsp;do&nbsp;something&nbsp;like&nbsp;this:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;blockquote&nbsp;style=&quot;margin:&nbsp;0&nbsp;0&nbsp;0&nbsp;40px;&nbsp;border:&nbsp;none;&nbsp;padding:&nbsp;0px;&quot;&gt;&lt;div&gt;try:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;...&lt;/div&gt;&lt;div&gt;except:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;captured&nbsp;=&nbsp;Failure()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;txn.rollback()&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;captured&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;because&nbsp;I&nbsp;find&nbsp;that&nbsp;it's&nbsp;more&nbsp;readable&nbsp;-&nbsp;rather&nbsp;than&nbsp;relying&nbsp;on&nbsp;ephemeral,&nbsp;manipulable&nbsp;state&nbsp;which&nbsp;should&nbsp;(but&nbsp;doesn't&nbsp;necessarily)&nbsp;follow&nbsp;conventions&nbsp;related&nbsp;to&nbsp;indentation,&nbsp;I&nbsp;explicitly&nbsp;capture&nbsp;the&nbsp;implicit&nbsp;state,&nbsp;on&nbsp;the&nbsp;only&nbsp;line&nbsp;of&nbsp;code&nbsp;where&nbsp;it's&nbsp;guaranteed&nbsp;to&nbsp;be&nbsp;the&nbsp;right&nbsp;thing.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Also&nbsp;worth&nbsp;noting&nbsp;that&nbsp;yielding&nbsp;the&nbsp;Failure&nbsp;will&nbsp;fail&nbsp;the&nbsp;Deferred&nbsp;returned&nbsp;by&nbsp;your&nbsp;inlineCallbacks&nbsp;function,&nbsp;implicitly&nbsp;terminating&nbsp;the&nbsp;execution&nbsp;of&nbsp;that&nbsp;function.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-glyph&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
