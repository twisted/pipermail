<tt>
&lt;html&nbsp;xmlns:v=&quot;urn:schemas-microsoft-com:vml&quot;&nbsp;xmlns:o=&quot;urn:schemas-microsoft-com:office:office&quot;&nbsp;xmlns:w=&quot;urn:schemas-microsoft-com:office:word&quot;&nbsp;xmlns:m=&quot;http://schemas.microsoft.com/office/2004/12/omml&quot;&nbsp;xmlns=&quot;http://www.w3.org/TR/REC-html40&quot;&gt;<br>
<br>
&lt;head&gt;<br>
&lt;meta&nbsp;http-equiv=Content-Type&nbsp;content=&quot;text/html;&nbsp;charset=iso-8859-1&quot;&gt;<br>
&lt;meta&nbsp;name=Generator&nbsp;content=&quot;Microsoft&nbsp;Word&nbsp;12&nbsp;(filtered&nbsp;medium)&quot;&gt;<br>
&lt;style&gt;<br>
&lt;!--<br>
&nbsp;/*&nbsp;Font&nbsp;Definitions&nbsp;*/<br>
&nbsp;@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:Wingdings;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:5&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0&nbsp;0;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:&quot;Cambria&nbsp;Math&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;4&nbsp;5&nbsp;3&nbsp;5&nbsp;4&nbsp;6&nbsp;3&nbsp;2&nbsp;4;}<br>
@font-face<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{font-family:Calibri;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;panose-1:2&nbsp;15&nbsp;5&nbsp;2&nbsp;2&nbsp;2&nbsp;4&nbsp;3&nbsp;2&nbsp;4;}<br>
&nbsp;/*&nbsp;Style&nbsp;Definitions&nbsp;*/<br>
&nbsp;p.MsoNormal,&nbsp;li.MsoNormal,&nbsp;div.MsoNormal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{margin:0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin-bottom:.0001pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-size:11.0pt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;}<br>
a:link,&nbsp;span.MsoHyperlink<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:blue;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-decoration:underline;}<br>
a:visited,&nbsp;span.MsoHyperlinkFollowed<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-priority:99;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:purple;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;text-decoration:underline;}<br>
span.EmailStyle17<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-type:personal-compose;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;color:windowtext;}<br>
.MsoChpDefault<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{mso-style-type:export-only;}<br>
@page&nbsp;Section1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{size:8.5in&nbsp;11.0in;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;margin:1.0in&nbsp;1.0in&nbsp;1.0in&nbsp;1.0in;}<br>
div.Section1<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{page:Section1;}<br>
--&gt;<br>
&lt;/style&gt;<br>
&lt;!--[if&nbsp;gte&nbsp;mso&nbsp;9]&gt;&lt;xml&gt;<br>
&nbsp;&lt;o:shapedefaults&nbsp;v:ext=&quot;edit&quot;&nbsp;spidmax=&quot;1026&quot;&nbsp;/&gt;<br>
&lt;/xml&gt;&lt;![endif]--&gt;&lt;!--[if&nbsp;gte&nbsp;mso&nbsp;9]&gt;&lt;xml&gt;<br>
&nbsp;&lt;o:shapelayout&nbsp;v:ext=&quot;edit&quot;&gt;<br>
&nbsp;&nbsp;&lt;o:idmap&nbsp;v:ext=&quot;edit&quot;&nbsp;data=&quot;1&quot;&nbsp;/&gt;<br>
&nbsp;&lt;/o:shapelayout&gt;&lt;/xml&gt;&lt;![endif]--&gt;<br>
&lt;/head&gt;<br>
<br>
&lt;body&nbsp;lang=EN-US&nbsp;link=blue&nbsp;vlink=purple&gt;<br>
<br>
&lt;div&nbsp;class=Section1&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;I&nbsp;have&nbsp;been&nbsp;operating&nbsp;a&nbsp;busy&nbsp;twisted&nbsp;TCP&nbsp;server&nbsp;for&nbsp;quite<br>
some&nbsp;time&nbsp;(1&nbsp;year+).&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;Yesterday,&nbsp;it&nbsp;strangely&nbsp;crashed&nbsp;under&nbsp;peak&nbsp;load&nbsp;for&nbsp;that&nbsp;day<br>
(it&nbsp;has&nbsp;been&nbsp;under&nbsp;more&nbsp;load&nbsp;in&nbsp;the&nbsp;past).&nbsp; &lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;#&nbsp;grep&nbsp;segfault&nbsp;/var/log/messages&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;Mar&nbsp;20&nbsp;19:12:15&nbsp;serv2&nbsp;kernel:&nbsp;[17687209.144548]<br>
twistd[10701]:&nbsp;segfault&nbsp;at&nbsp;8&nbsp;rip&nbsp;41eccf&nbsp;rsp&nbsp;7fff33675270&nbsp;error&nbsp;6&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;I&nbsp;cannot&nbsp;understand&nbsp;the&nbsp;reason&nbsp;of&nbsp;the&nbsp;crash,&nbsp;except&nbsp;that&nbsp;it&#8217;s<br>
some&nbsp;very&nbsp;rare&nbsp;race&nbsp;condition.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;While&nbsp;the&nbsp;code&nbsp;is&nbsp;quite&nbsp;cumbersome,&nbsp;here&nbsp;are&nbsp;some&nbsp;general<br>
details:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;8&nbsp;min&nbsp;before&nbsp;the&nbsp;crash,&nbsp;the&nbsp;server&nbsp;started&nbsp;giving&nbsp;repeated&nbsp;error<br>
on&nbsp;clients&nbsp;disconnect,&nbsp;that&nbsp;I&nbsp;have&nbsp;never&nbsp;seen&nbsp;before&nbsp;in&nbsp;the&nbsp;last&nbsp;year.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;It&nbsp;first&nbsp;produced&nbsp;this&nbsp;twice:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;2009/03/20&nbsp;19:04&nbsp;-0700&nbsp;[ClientProtocol,318930,70.132.227.150]<br>
Unhandled&nbsp;Error&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;       &nbsp;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/application/app.py&quot;,<br>
line&nbsp;113,&nbsp;in&nbsp;runReactorWithLogging&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;reactor.run()&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posixbase.py&quot;,<br>
line&nbsp;220,&nbsp;in&nbsp;run&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;self.mainLoop()&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File&nbsp;&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posixbase.py&quot;,<br>
line&nbsp;231,&nbsp;in&nbsp;mainLoop&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;self.doIteration(t)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/epollreactor.py&quot;,<br>
line&nbsp;181,&nbsp;in&nbsp;doPoll&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;log.callWithLogger(selectable,&nbsp;_drdw,<br>
selectable,&nbsp;fd,&nbsp;event)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;       &nbsp;---&nbsp;&lt;exception&nbsp;caught&nbsp;here&gt;&nbsp;---&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/log.py&quot;,<br>
line&nbsp;48,&nbsp;in&nbsp;callWithLogger&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;return&nbsp;callWithContext({&quot;system&quot;:&nbsp;lp},<br>
func,&nbsp;*args,&nbsp;**kw)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/log.py&quot;,<br>
line&nbsp;33,&nbsp;in&nbsp;callWithContext&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;return&nbsp;context.call({ILogContext:&nbsp;newCtx},&nbsp;func,<br>
*args,&nbsp;**kw)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/context.py&quot;,<br>
line&nbsp;59,&nbsp;in&nbsp;callWithContext&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;return<br>
self.currentContext().callWithContext(ctx,&nbsp;func,&nbsp;*args,&nbsp;**kw)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File&nbsp;&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/context.py&quot;,<br>
line&nbsp;37,&nbsp;in&nbsp;callWithContext&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;return&nbsp;func(*args,**kw)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/epollreactor.py&quot;,<br>
line&nbsp;212,&nbsp;in&nbsp;_doReadOrWrite&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;  self._disconnectSelectable(selectable,&nbsp;why,<br>
inRead)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posixbase.py&quot;,<br>
line&nbsp;252,&nbsp;in&nbsp;_disconnectSelectable&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;selectable.readConnectionLost(f)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File&nbsp;&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/tcp.py&quot;,<br>
line&nbsp;405,&nbsp;in&nbsp;readConnectionLost&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;self.connectionLost(reason)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/tcp.py&quot;,<br>
line&nbsp;416,&nbsp;in&nbsp;connectionLost&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;protocol.connectionLost(reason)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File&nbsp;&quot;/nail/live/im/myserv/protocols.py&quot;,<br>
line&nbsp;170,&nbsp;in&nbsp;connectionLost&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;self.session.logout()&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File&nbsp;&quot;/nail/live/im/myserv/service.py&quot;,<br>
line&nbsp;1199,&nbsp;in&nbsp;logout&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;      &nbsp;     if&nbsp;self.nick&nbsp;in&nbsp;session.sellers:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;       &nbsp;exceptions.AttributeError:&nbsp;Deferred&nbsp;instance&nbsp;has&nbsp;no<br>
attribute&nbsp;'sellers'&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;and&nbsp;then&nbsp;a&nbsp;different&nbsp;error&nbsp;in&nbsp;the&nbsp;same&nbsp;line&nbsp;with&nbsp;the&nbsp;same<br>
call&nbsp;stack,&nbsp;that&nbsp;was&nbsp;repeated&nbsp;about&nbsp;1000&nbsp;times&nbsp;for&nbsp;different&nbsp;logging&nbsp;out&nbsp;clients:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;2009/03/20&nbsp;19:04&nbsp;-0700&nbsp;[ClientProtocol,326158,99.245.246.187]<br>
Unhandled&nbsp;Error&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;       &nbsp;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File&nbsp;&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/application/app.py&quot;,<br>
line&nbsp;113,&nbsp;in&nbsp;runReactorWithLogging&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;reactor.run()&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posixbase.py&quot;,<br>
line&nbsp;220,&nbsp;in&nbsp;run&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;self.mainLoop()&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posixbase.py&quot;,<br>
line&nbsp;231,&nbsp;in&nbsp;mainLoop&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;self.doIteration(t)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/epollreactor.py&quot;,<br>
line&nbsp;181,&nbsp;in&nbsp;doPoll&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;log.callWithLogger(selectable,&nbsp;_drdw,<br>
selectable,&nbsp;fd,&nbsp;event)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;       &nbsp;---&nbsp;&lt;exception&nbsp;caught&nbsp;here&gt;&nbsp;---&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/log.py&quot;,<br>
line&nbsp;48,&nbsp;in&nbsp;callWithLogger&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;return&nbsp;callWithContext({&quot;system&quot;:&nbsp;lp},<br>
func,&nbsp;*args,&nbsp;**kw)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/log.py&quot;,<br>
line&nbsp;33,&nbsp;in&nbsp;callWithContext&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;return&nbsp;context.call({ILogContext:&nbsp;newCtx},&nbsp;func,<br>
*args,&nbsp;**kw)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/context.py&quot;,<br>
line&nbsp;59,&nbsp;in&nbsp;callWithContext&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;return&nbsp;self.currentContext().callWithContext(ctx,<br>
func,&nbsp;*args,&nbsp;**kw)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/context.py&quot;,<br>
line&nbsp;37,&nbsp;in&nbsp;callWithContext&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;return&nbsp;func(*args,**kw)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/epollreactor.py&quot;,<br>
line&nbsp;212,&nbsp;in&nbsp;_doReadOrWrite&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;self._disconnectSelectable(selectable,&nbsp;why,<br>
inRead)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posixbase.py&quot;,<br>
line&nbsp;252,&nbsp;in&nbsp;_disconnectSelectable&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;selectable.readConnectionLost(f)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File<br>
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/tcp.py&quot;,<br>
line&nbsp;405,&nbsp;in&nbsp;readConnectionLost&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;self.connectionLost(reason)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File&nbsp;&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/tcp.py&quot;,<br>
line&nbsp;416,&nbsp;in&nbsp;connectionLost&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;protocol.connectionLost(reason)&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;         &nbsp;File&nbsp;&quot;/nail/live/im/myserv/protocols.py&quot;,<br>
line&nbsp;170,&nbsp;in&nbsp;connectionLost&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;self.session.logout()&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;     &nbsp;    File&nbsp;&quot;/nail/live/im/myserv/service.py&quot;,<br>
line&nbsp;1199,&nbsp;in&nbsp;logout&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;           &nbsp;if&nbsp;self.nick&nbsp;in&nbsp;session.sellers:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;       &nbsp;exceptions.AttributeError:&nbsp;WLResultSet&nbsp;instance&nbsp;has<br>
no&nbsp;attribute&nbsp;'sellers'&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;This&nbsp;last&nbsp;error&nbsp;repeated&nbsp;about&nbsp;1000&nbsp;times&nbsp;for&nbsp;different<br>
clients,&nbsp;after&nbsp;which&nbsp;the&nbsp;segfault&nbsp;occurred.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;The&nbsp;problem&nbsp;is,&nbsp;that&nbsp;&#8220;session&#8221;&nbsp;is&nbsp;an&nbsp;instance&nbsp;of<br>
a&nbsp;Session&nbsp;class&nbsp;that&nbsp;is&nbsp;defined&nbsp;in&nbsp;the&nbsp;code,&nbsp;it&nbsp;is&nbsp;NEITHER&nbsp;a&nbsp;Deferred&nbsp;NOR&nbsp;an<br>
instance&nbsp; of&nbsp;WLResultSet&nbsp;class-&nbsp;these&nbsp;are&nbsp;completely&nbsp;different&nbsp;classes,&nbsp;and<br>
there&#8217;s&nbsp;no&nbsp;possible&nbsp;way&nbsp;in&nbsp;the&nbsp;code&nbsp;for&nbsp;variable&nbsp;session&nbsp;to&nbsp;become&nbsp;an<br>
instance&nbsp;of&nbsp;Deferred.&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;The&nbsp;code&nbsp;is&nbsp;approximately&nbsp;like&nbsp;this:&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;def&nbsp;logout(self):&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&nbsp;style='text-indent:.5in'&gt;self.on_logout(self.do_logout)&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&nbsp;style='text-indent:.5in'&gt;for&nbsp;session&nbsp;in<br>
self.service.client_sessions:&nbsp;&lt;span&nbsp;style='font-family:Wingdings'&gt;ß&lt;/span&gt;&nbsp;self.service.client_sessions<br>
is&nbsp;a&nbsp;dictionary&nbsp;of&nbsp;custom&nbsp;Session&nbsp;class&nbsp;instances&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&nbsp;style='margin-left:.5in;text-indent:.5in'&gt;if&nbsp;self.nick&nbsp;in<br>
session.sellers: &nbsp;&lt;span&nbsp;style='font-family:Wingdings'&gt;ß&lt;/span&gt;&nbsp;error&nbsp;here,&nbsp;it<br>
claims&nbsp;that&nbsp;session&nbsp;is&nbsp;a&nbsp;Deferred&nbsp;or&nbsp;sometimes&nbsp;an&nbsp;instance&nbsp;of&nbsp;a&nbsp;completely<br>
unrelated&nbsp;class&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;               &nbsp;               &nbsp;               &nbsp;#Some<br>
statements&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;The&nbsp;function&nbsp;self.on_logout&nbsp;sometimes&nbsp;(rarely)&nbsp;dispatches&nbsp;a<br>
deferred&nbsp;(it&nbsp;has&nbsp;maybeDeferred&nbsp;in&nbsp;it),&nbsp;such&nbsp;that&nbsp;its&nbsp;argument&nbsp;self.on_logout&nbsp;is<br>
called&nbsp;when&nbsp;that&nbsp;deferred&nbsp;returns&nbsp;(otherwise&nbsp;it&#8217;s&nbsp;called&nbsp;synchronously).&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;My&nbsp;question&nbsp;is,&nbsp;is&nbsp;it&nbsp;possible&nbsp;to&nbsp;muck&nbsp;up&nbsp;deferred&nbsp;in&nbsp;such&nbsp;a<br>
way,&nbsp;that&nbsp;after&nbsp;dispatching&nbsp;a&nbsp;deferred&nbsp;chain&nbsp;inside&nbsp; self.on_logout(self.do_logout)<br>
,&nbsp;the&nbsp;remaining&nbsp;statements&nbsp;would&nbsp;be&nbsp;executed&nbsp;in&nbsp;some&nbsp; unexpected&nbsp;local&nbsp;scope,<br>
such&nbsp;that&nbsp;I&nbsp;would&nbsp;see&nbsp;these&nbsp;weird&nbsp;errors&nbsp;where&nbsp;my&nbsp;for&nbsp;loop&nbsp;iterator&nbsp;would<br>
suddenly&nbsp;go&nbsp;over&nbsp;Deferred&nbsp;instances,&nbsp;instead&nbsp;of&nbsp;the&nbsp;dictionary&nbsp;of&nbsp;Session<br>
instances&nbsp;that&nbsp;I&nbsp;define&nbsp;in&nbsp;the&nbsp;code&nbsp;??&nbsp;&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;&lt;o:p&gt;&nbsp;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt;Also,&nbsp;why&nbsp;did&nbsp;these&nbsp;errors&nbsp;lead&nbsp;to&nbsp;segfault&nbsp;of&nbsp;the&nbsp;whole<br>
twisted&nbsp;process&nbsp;after&nbsp;8&nbsp;minutes?&lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;p&nbsp;class=MsoNormal&gt; &lt;o:p&gt;&lt;/o:p&gt;&lt;/p&gt;<br>
<br>
&lt;/div&gt;<br>
<br>
&lt;/body&gt;<br>
<br>
&lt;/html&gt;<br>

</tt>
