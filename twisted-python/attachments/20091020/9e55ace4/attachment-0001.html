<tt>
Hi&nbsp;Guys,&lt;br&gt;&lt;br&gt;Im&nbsp;playing&nbsp;with&nbsp;a&nbsp;dns-cache&nbsp;script,&nbsp;that&nbsp;overrides&nbsp;DNS&nbsp;requests&nbsp;for&nbsp;certain&nbsp;IP&nbsp;addresses.&lt;br&gt;&lt;br&gt;I&nbsp;would&nbsp;like&nbsp;to&nbsp;add&nbsp;functionality,&nbsp;so&nbsp;unresolved&nbsp;requests&nbsp;are&nbsp;sent&nbsp;to&nbsp;a&nbsp;spicific&nbsp;IP.&nbsp;How&nbsp;do&nbsp;I&nbsp;go&nbsp;about&nbsp;doing&nbsp;that?&lt;br&gt;<br>
&lt;br&gt;Is&nbsp;there&nbsp;a&nbsp;negative&nbsp;answer&nbsp;in&nbsp;the&nbsp;(udp)&nbsp;DNS&nbsp;protocol&nbsp;or&nbsp;am&nbsp;I&nbsp;forced&nbsp;to&nbsp;use&nbsp;a&nbsp;timeout.&lt;br&gt;&lt;br&gt;Kind&nbsp;regards&lt;br&gt;&lt;br&gt;Tax&lt;br&gt;&lt;br&gt;&lt;br&gt;import&nbsp;sys,&nbsp;os&lt;br&gt;from&nbsp;socket&nbsp;import&nbsp;*&lt;br&gt;from&nbsp;twisted.internet.protocol&nbsp;import&nbsp;Factory,&nbsp;Protocol&lt;br&gt;<br>
from&nbsp;twisted.internet&nbsp;import&nbsp;reactor&lt;br&gt;from&nbsp;twisted.names&nbsp;import&nbsp;dns,&nbsp;client,&nbsp;server&lt;br&gt;import&nbsp;time&lt;br&gt;&lt;br&gt;LOGFILE&nbsp;=&nbsp;&#39;dnsfilter.log&#39;&lt;br&gt;&lt;br&gt;def&nbsp;allowip(ip):&lt;br&gt;   &nbsp;return&nbsp;True&lt;br&gt;&lt;br&gt;&lt;br&gt;class&nbsp;Log:&lt;br&gt;   &nbsp;&quot;&quot;&quot;file&nbsp;like&nbsp;for&nbsp;writes&nbsp;with&nbsp;auto&nbsp;flush&nbsp;after&nbsp;each&nbsp;write&lt;br&gt;<br>
   &nbsp;to&nbsp;ensure&nbsp;that&nbsp;everything&nbsp;is&nbsp;logged,&nbsp;even&nbsp;during&nbsp;an&lt;br&gt;   &nbsp;unexpected&nbsp;exit.&quot;&quot;&quot;&lt;br&gt;   &nbsp;def&nbsp;__init__(self,&nbsp;f):&lt;br&gt;       &nbsp;self.f&nbsp;=&nbsp;f&lt;br&gt;   &nbsp;def&nbsp;write(self,&nbsp;s):&lt;br&gt;       &nbsp;self.f.write(s)&lt;br&gt;       &nbsp;self.f.flush()&lt;br&gt;<br>
&lt;br&gt;if&nbsp;__name__&nbsp;==&nbsp;&quot;__main__&quot;:&lt;br&gt;   &nbsp;dns_servers&nbsp;=&nbsp;[]&lt;br&gt;   &nbsp;f&nbsp;=&nbsp;open(&#39;/etc/resolv.conf&#39;,&nbsp;&quot;r&quot;)&lt;br&gt;   &nbsp;while&nbsp;1:&lt;br&gt;       &nbsp;line&nbsp;=&nbsp;f.readline()&lt;br&gt;       &nbsp;if&nbsp;not&nbsp;line:&lt;br&gt;           &nbsp;break&lt;br&gt;       &nbsp;if&nbsp;line[0]!=&#39;#&#39;:&lt;br&gt;<br>
           &nbsp;s,&nbsp;ns&nbsp;=&nbsp;line.strip().split(&#39;&nbsp;&#39;)&lt;br&gt;           &nbsp;if&nbsp;s&nbsp;==&nbsp;&#39;nameserver&#39;:&lt;br&gt;               &nbsp;dns_servers.append((ns,53))&lt;br&gt;   &nbsp;#redirect&nbsp;outputs&nbsp;to&nbsp;a&nbsp;logfile&lt;br&gt;   &nbsp;sys.stdout&nbsp;=&nbsp;sys.stderr&nbsp;=&nbsp;Log(open(LOGFILE,&nbsp;&#39;a+&#39;))&lt;br&gt;<br>
&lt;br&gt;   &nbsp;print&nbsp;&#39;dnsfilter&nbsp;starting&#39;&lt;br&gt;   &nbsp;print&nbsp;dns_servers&lt;br&gt;   &nbsp;&lt;br&gt;   &nbsp;#address&nbsp;that&nbsp;traffic&nbsp;is&nbsp;redirected&nbsp;to&lt;br&gt;   &nbsp;redirect&nbsp;=&nbsp;&#39;10.0.64.1&#39;&lt;br&gt;   &nbsp;&lt;br&gt;   &nbsp;greenlist= &nbsp;[&#39;63.4.241.16&#39;,&nbsp;\&lt;br&gt;                &nbsp;&#39;216.13.188.67&#39;]&lt;br&gt;<br>
   &nbsp;&lt;br&gt;   &nbsp;&lt;br&gt;   &nbsp;class&nbsp;DNSDatagramProtocolTest(dns.DNSDatagramProtocol):&lt;br&gt;       &nbsp;def&nbsp;writeMessage(self,&nbsp;message,&nbsp;address):&lt;br&gt;           &nbsp;log&nbsp;=&nbsp;&#39;%s&nbsp;DNS&nbsp;request&nbsp;from:&nbsp;%s\n&#39;&nbsp;%&nbsp;(time.strftime(&quot;%m/%d/%y&nbsp;-&nbsp;%H:%M:%S&quot;,&nbsp;time.localtime())&nbsp;,address[0])&lt;br&gt;<br>
           &nbsp;for&nbsp;i&nbsp;in&nbsp;range(len(message.answers)):&lt;br&gt;               &nbsp;x&nbsp;=&nbsp;message.answers[i]&lt;br&gt;               &nbsp;print&nbsp;x.type&lt;br&gt;               &nbsp;if&nbsp;x.type==1&nbsp;and&nbsp;x.payload:&lt;br&gt;                   &nbsp;if&nbsp;not&nbsp;allowip(address[0]):&lt;br&gt;<br>
                       &nbsp;to_adr&nbsp;=&nbsp;inet_ntoa(x.payload.address)&lt;br&gt;                       &nbsp;if&nbsp;to_adr&nbsp;in&nbsp;greenlist:&lt;br&gt;                           &nbsp;log&nbsp;+=&nbsp;&#39;&nbsp;allowed&nbsp;to&nbsp;%s\n&#39;%(to_adr)&lt;br&gt;                       &nbsp;else:&lt;br&gt;<br>
                           &nbsp;log&nbsp;+=&nbsp;&#39;&nbsp;not&nbsp;allowed&nbsp;so&nbsp;%s&nbsp;becomes&nbsp;%s\n&#39;%(to_adr,&nbsp;redirect)&lt;br&gt;                           &nbsp;x.payload.address&nbsp;=&nbsp;inet_aton(redirect)&lt;br&gt;                   &nbsp;else:&lt;br&gt;                       &nbsp;log&nbsp;+=&nbsp;&#39;&nbsp;to&nbsp;%s\n&#39;%(inet_ntoa(x.payload.address))&lt;br&gt;<br>
           &nbsp;print&nbsp;log&lt;br&gt;           &nbsp;self.transport.write(message.toStr(),&nbsp;address)&lt;br&gt;&lt;br&gt;   &nbsp;resolver&nbsp;=&nbsp;client.Resolver(servers=dns_servers)&lt;br&gt;   &nbsp;f&nbsp;=&nbsp;server.DNSServerFactory(clients=[resolver])&lt;br&gt;   &nbsp;p&nbsp;=&nbsp;DNSDatagramProtocolTest(f)&lt;br&gt;<br>
   &nbsp;reactor.listenUDP(53,&nbsp;p)&lt;br&gt;   &nbsp;reactor.run()&lt;br&gt;&lt;br&gt;<br>

</tt>
