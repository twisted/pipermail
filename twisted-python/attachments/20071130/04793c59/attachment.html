<tt>
Hello.&nbsp;At&nbsp;first&nbsp;excuse&nbsp;me&nbsp;for&nbsp;my&nbsp;poor&nbsp;English.&nbsp;&lt;br&gt;I&#39;ve&nbsp;making&nbsp;a&nbsp;python&nbsp;library&nbsp;for&nbsp;handle&nbsp;the&nbsp;pcican&nbsp;board,&nbsp;using&nbsp;the&nbsp;canlib&nbsp;library.&nbsp;It&nbsp;works&nbsp;fine.&nbsp;&lt;br&gt;Now,&nbsp;I&nbsp;have&nbsp;to&nbsp;integrate&nbsp;to&nbsp;a&nbsp;twisted&nbsp;application&nbsp;that&nbsp;I&nbsp;made,&nbsp;for&nbsp;package&nbsp;encapsulation&nbsp;over&nbsp;tcp/ip.&nbsp;This&nbsp;works&nbsp;fine&nbsp;in&nbsp;serialport&nbsp;using&nbsp;<br>
abstract.filedescriptor&nbsp;and&nbsp;pyserial,&nbsp;but&nbsp;in&nbsp;the&nbsp;canlib&nbsp;case&nbsp;I&nbsp;have&nbsp;no&nbsp;file&nbsp;descriptor&nbsp;for&nbsp;this.&nbsp;&lt;br&gt;&lt;br&gt;What&nbsp;can&nbsp;I&nbsp;do&nbsp;for&nbsp;encapsulate&nbsp;like&nbsp;serial&nbsp;protocol,&nbsp;but&nbsp;with&nbsp;canlib&nbsp;methods?&nbsp;&lt;br&gt;I&nbsp;have&nbsp;to&nbsp;re&nbsp;factorize&nbsp;the&nbsp;pycanlib&nbsp;library&nbsp;to&nbsp;build&nbsp;a&nbsp;file&nbsp;descriptor&nbsp;that&nbsp;represents,&nbsp;or&nbsp;is&nbsp;a&nbsp;way&nbsp;to&nbsp;readapt&nbsp;the&nbsp;<br>
abstract.filedescriptor&nbsp;for&nbsp;that?&lt;br&gt;The&nbsp;methods&nbsp;that&nbsp;I&nbsp;have&nbsp;is:&lt;br&gt;&lt;br&gt;Channel.readWait()&nbsp;&lt;-&nbsp;this&nbsp;is&nbsp;persistent&lt;br&gt;Channel.read()&nbsp;&lt;-this&nbsp;is&nbsp;not&nbsp;persistent.&nbsp;If&nbsp;buffer&nbsp;is&nbsp;empty&nbsp;returns.&lt;br&gt;Channel.write(&lt;can&nbsp;package&nbsp;attributes&gt;)<br>
&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;br&gt;More&nbsp;details:&lt;br&gt;&lt;br&gt;This&nbsp;is&nbsp;the&nbsp;file&nbsp;descriptor&nbsp;I&nbsp;wrote...&nbsp;&lt;br&gt;----------------&lt;br&gt;#&nbsp;twisted&nbsp;imports&lt;br&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;abstract,&nbsp;fdesc,&nbsp;main&lt;br&gt;import&nbsp;canlib&lt;br&gt;from&nbsp;canlib&nbsp;import&nbsp;canOPEN_EXCLUSIVE,&nbsp;canWANT_EXTENDED,&nbsp;BAUD_1M,&nbsp;canDRIVER_NORMAL<br>
&lt;br&gt;&lt;br&gt;class&nbsp;CANConnector(abstract.FileDescriptor):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;Conector&nbsp;para&nbsp;el&nbsp;dispositivo&nbsp;pcican&nbsp;usando&nbsp;pycanlib&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&quot;&quot;&quot;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;connected&nbsp;=&nbsp;1&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;protocol,&nbsp;conf,&nbsp;reactor):<br>
&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;abstract.FileDescriptor.__init__(self,&nbsp;reactor)&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._channel&nbsp;=&nbsp;canlib.Channel(0)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._channel.open(canOPEN_EXCLUSIVE&nbsp;|&nbsp;canWANT_EXTENDED)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;self._channel.setBusOff()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;self._channel.setBusParams(BAUD_1M,&nbsp;4,&nbsp;3,&nbsp;1,&nbsp;1)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;self._channel.setBusOutputControl(canDRIVER_NORMAL)&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;self._channel.setBusOn()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.reactor&nbsp;=&nbsp;reactor&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.protocol&nbsp;=&nbsp;protocol<br>
&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;self.protocol.makeConnection(self)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.startReading()&lt;br&gt;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;writeSomeData(self,&nbsp;data):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self._channel.write(1000,&nbsp;data,&nbsp;10,&nbsp;0)&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;doRead(self):&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pack&nbsp;=&nbsp;self._channel.readWait()&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;returns&nbsp;the&nbsp;message&nbsp;of&nbsp;package&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;pack[&#39;msg&#39;]&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;connectionLost(self,&nbsp;reason=None):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;abstract.FileDescriptor.connectionLost<br>
(self,&nbsp;reason)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._channel.close()&lt;br&gt;------------&lt;br&gt;&lt;br&gt;in&nbsp;the&nbsp;main&nbsp;tac&nbsp;service&nbsp;this&nbsp;is&nbsp;how&nbsp;I&nbsp;use&nbsp;the&nbsp;connector:&lt;br&gt;&lt;br&gt;---------------&lt;br&gt;(...)&lt;br&gt;&lt;br&gt;class&nbsp;ServiceChannel(protocol.Protocol):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;connectionMade(self):<br>
&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&#39;Canal&nbsp;conectado&#39;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;dataReceived(self,&nbsp;data):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;datorecibido&quot;&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;s.writeOnPort(data)&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;connectionLost(self):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&#39;Canal&nbsp;desconectado&#39;<br>
&lt;br&gt;&lt;br&gt;class&nbsp;SimulatorService(service.Service):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;(...)&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;startChannel(self):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(...)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;ServiceChannel()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(...)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.channel&nbsp;=&nbsp;CANConnector(c,&nbsp;self.conf.channel<br>
,&nbsp;reactor)&lt;br&gt;&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;(...)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;writeOnPort(self,&nbsp;data):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.factory.instance.transport.write(data)&lt;br&gt;&lt;br&gt;--------&lt;br&gt;This&nbsp;application&nbsp;pipes&nbsp;the&nbsp;can&nbsp;comunications&nbsp;whith&nbsp;a&nbsp;tcp&nbsp;ip&nbsp;port.&lt;br&gt;&lt;br&gt;Then&nbsp;,when&nbsp;I&nbsp;run:&nbsp;<br>
&lt;br&gt;$&nbsp;twistd&nbsp;-ny&nbsp;main.tac&lt;br&gt;&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;Log&nbsp;opened.&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;twistd&nbsp;2.5.0&nbsp;(/usr/bin/python&nbsp;2.5.1)&nbsp;starting&nbsp;up&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;reactor&nbsp;class:&nbsp;&lt;class&nbsp;&#39;twisted.internet.selectreactor.SelectReactor<br>
&#39;&gt;&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;Loading&nbsp;main.tac...&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;/usr/bin/twistd:&nbsp;option&nbsp;-n&nbsp;not&nbsp;recognized&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;/usr/bin/twistd:&nbsp;Try&nbsp;--help&nbsp;for&nbsp;usage&nbsp;details.&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;Loaded.<br>
&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;__builtin__.ServiceFactory&nbsp;starting&nbsp;on&nbsp;5000&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;Starting&nbsp;factory&nbsp;&lt;__builtin__.ServiceFactory&nbsp;instance&nbsp;at&nbsp;0x84069cc&gt;&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[__builtin__.ServiceFactory]&nbsp;{&#39;protocol&#39;:&nbsp;&#39;can&#39;,&nbsp;&#39;number&#39;:&nbsp;&#39;0&#39;,&nbsp;&#39;channel&#39;:&nbsp;&#39;1&#39;}<br>
&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[__builtin__.ServiceFactory]&nbsp;Canal&nbsp;conectado&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[__builtin__.ServiceFactory]&nbsp;channel&nbsp;started.................&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[__builtin__.ServiceFactory]&nbsp;se&nbsp;generan&nbsp;los&nbsp;archivos&nbsp;de&nbsp;registro<br>
&lt;br&gt;&lt;br&gt;&lt;...&nbsp;(Connect&nbsp;to&nbsp;5000&nbsp;port&nbsp;)&nbsp;..&gt;&lt;br&gt;&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[__builtin__.ServiceFactory]&nbsp;Conexion&nbsp;establecida&nbsp;desde&nbsp;IPv4Address(TCP,&nbsp;&#39;&lt;a&nbsp;href=&quot;http://192.168.6.38&quot;&gt;192.168.6.38&lt;/a&gt;&#39;,&nbsp;5000)&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;Unhandled&nbsp;Error<br>
&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;/usr/lib/python2.5/site-packages/twisted/scripts/_twistd_unix.py&quot;,&nbsp;line&nbsp;214,&nbsp;in&nbsp;postApplication&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;app.runReactorWithLogging(self.config<br>
,&nbsp;self.oldstdout,&nbsp;self.oldstderr)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;/usr/lib/python2.5/site-packages/twisted/application/app.py&quot;,&nbsp;line&nbsp;113,&nbsp;in&nbsp;runReactorWithLogging&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reactor.run()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;/usr/lib/python2.5/site-packages/twisted/internet/posixbase.py&quot;,&nbsp;line&nbsp;220,&nbsp;in&nbsp;run<br>
&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.mainLoop()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;/usr/lib/python2.5/site-packages/twisted/internet/posixbase.py&quot;,&nbsp;line&nbsp;231,&nbsp;in&nbsp;mainLoop&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.doIteration(t)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---&nbsp;&lt;exception&nbsp;caught&nbsp;here&gt;&nbsp;---<br>
&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;/usr/lib/python2.5/site-packages/twisted/internet/selectreactor.py&quot;,&nbsp;line&nbsp;97,&nbsp;in&nbsp;doSelect&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[],&nbsp;timeout)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptions.ValueError:&nbsp;file&nbsp;descriptor&nbsp;cannot&nbsp;be&nbsp;a&nbsp;negative&nbsp;integer&nbsp;(-1)<br>
&lt;br&gt;&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;Malformed&nbsp;file&nbsp;descriptor&nbsp;found.&nbsp;&nbsp;Preening&nbsp;lists.&lt;br&gt;2007/11/30&nbsp;10:52&nbsp;-0300&nbsp;[-]&nbsp;bad&nbsp;descriptor&nbsp;&lt;can.CANConnector&nbsp;object&nbsp;at&nbsp;0x83e94ec&gt;&lt;br&gt;&lt;br&gt;Thanks&nbsp;for&nbsp;your&nbsp;attention.&nbsp;&lt;br&gt;&lt;br&gt;Fran<br>
&lt;br&gt;&lt;br&gt;PD:&nbsp;If&nbsp;anybody&nbsp;is&nbsp;interested&nbsp;in&nbsp;this&nbsp;pycanlib&nbsp;library&nbsp;I&nbsp;pass&nbsp;the&nbsp;source&nbsp;for&nbsp;liberation.&lt;br&gt;&lt;br&gt;--&nbsp;&lt;br&gt;&quot;El&nbsp;hombre&nbsp;se&nbsp;descubre&nbsp;cuando&nbsp;se&nbsp;mide&nbsp;con&nbsp;un&nbsp;obstáculo&quot;&nbsp;&lt;br&gt;(Saint&nbsp;Exupéry)<br>

</tt>
