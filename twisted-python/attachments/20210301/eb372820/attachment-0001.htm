<tt>
&lt;div&nbsp;dir=&quot;auto&quot;&gt;I&#39;ve&nbsp;used&nbsp;decorators&nbsp;that&nbsp;execute&nbsp;the&nbsp;route&nbsp;function&nbsp;and&nbsp;then&nbsp;fire&nbsp;a&nbsp;call&nbsp;back&nbsp;at&nbsp;the&nbsp;end.&nbsp;Here&#39;s&nbsp;a&nbsp;quick&nbsp;example&nbsp;of&nbsp;&quot;metrics&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;a&nbsp;request&nbsp;and&nbsp;at&nbsp;the&nbsp;end.&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;```&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;from&nbsp;functools&nbsp;import&nbsp;wraps&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;from&nbsp;random&nbsp;import&nbsp;randint&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;import&nbsp;time&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;from&nbsp;klein&nbsp;import&nbsp;Klein&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;defer,&nbsp;reactor&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;def&nbsp;startMetric(f):&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;@wraps(f)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;def&nbsp;deco(*args,&nbsp;**kw):&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;req&nbsp;=&nbsp;args[1]&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;print(f&quot;[x]&nbsp;start:{time.time()}&nbsp;path:{req.path.decode(&#39;utf8&#39;)}&quot;)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;result&nbsp;=&nbsp;defer.maybeDeferred(f,&nbsp;*args,&nbsp;**kw)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;result.addBoth(endMetric,&nbsp;req)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;result&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;return&nbsp;deco&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;def&nbsp;endMetric(result,&nbsp;req):&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;print(f&quot;[x]&nbsp;end:{time.time()}&nbsp;path:{req.path.decode(&#39;utf8&#39;)}&nbsp;status:{req.code}&quot;)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;return&nbsp;result&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;class&nbsp;MyApp:&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;rtr&nbsp;=&nbsp;Klein()&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;@rtr.route(&quot;/hello&quot;)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;@startMetric&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;def&nbsp;hello(self,&nbsp;req):&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;d&nbsp;=&nbsp;defer.Deferred()&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;delay&nbsp;=&nbsp;randint(1,&nbsp;5)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;reactor.callLater(delay,&nbsp;d.callback,&nbsp;f&quot;delay:{delay}&quot;)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;req.setResponseCode(403,&nbsp;b&quot;whoopsie&quot;)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;d&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;def&nbsp;main():&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;app&nbsp;=&nbsp;MyApp()&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt; &nbsp; &nbsp;app.rtr.run(&quot;localhost&quot;,&nbsp;9999)&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;main()&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;```&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;dir=&quot;auto&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&nbsp;dir=&quot;auto&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Mon,&nbsp;Mar&nbsp;1,&nbsp;2021,&nbsp;15:52&nbsp;Robert&nbsp;DiFalco&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:robert.difalco@gmail.com&quot;&gt;robert.difalco@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Is&nbsp;this&nbsp;the&nbsp;right&nbsp;place&nbsp;to&nbsp;ask&nbsp;klein&nbsp;questions?&nbsp;I&#39;m&nbsp;writing a&nbsp;metrics&nbsp;plugin&nbsp;for&nbsp;Klein&nbsp;and&nbsp;I&nbsp;can&#39;t&nbsp;figure&nbsp;out&nbsp;how&nbsp;to&nbsp;inject&nbsp;a&nbsp;metrics&nbsp;handler&nbsp;so&nbsp;that&nbsp;I&nbsp;can&nbsp;get&nbsp;route,&nbsp;path,&nbsp;duration,&nbsp;and&nbsp;status&nbsp;code.&nbsp;What&nbsp;I&#39;m&nbsp;doing&nbsp;now&nbsp;sucks&nbsp;because&nbsp;Klein&nbsp;and&nbsp;twisted&nbsp;interact&nbsp;in&nbsp;complex&nbsp;ways&nbsp;on&nbsp;Failure&nbsp;and&nbsp;status&nbsp;codes. &lt;div&gt;&lt;pre&nbsp;style=&quot;background-color:rgb(43,43,43);color:rgb(169,183,198);font-family:&quot;JetBrains&nbsp;Mono&quot;,monospace;font-size:9.8pt&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(128,128,128)&quot;&gt;#&nbsp;Replace&nbsp;the&nbsp;klein&nbsp;_call&nbsp;with&nbsp;the&nbsp;metrics&nbsp;generating&nbsp;call&lt;br&gt;&lt;/span&gt;_app._call&nbsp;=&nbsp;_callWithMetrics&lt;br&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div&gt;Rather&nbsp;than&nbsp;replace&nbsp;_call&nbsp;with&nbsp;my&nbsp;version&nbsp;of&nbsp;_call&nbsp;I&nbsp;was&nbsp;hoping&nbsp;there&nbsp;was&nbsp;a&nbsp;cleaner&nbsp;way&nbsp;to&nbsp;get&nbsp;the&nbsp;start&nbsp;and&nbsp;stop&nbsp;with&nbsp;the&nbsp;result&nbsp;code&nbsp;of&nbsp;a&nbsp;route&nbsp;invocation.&nbsp;Thoughts? &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;<br>
_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&nbsp;rel=&quot;noreferrer&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;rel=&quot;noreferrer&nbsp;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
