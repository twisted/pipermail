<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Nov&nbsp;18,&nbsp;2015&nbsp;at&nbsp;9:28&nbsp;AM,&nbsp;Tom&nbsp;Boland&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:tom@t0mb.net&quot;&nbsp;target=&quot;_blank&quot;&gt;tom@t0mb.net&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;<br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;&lt;div&nbsp;text=&quot;#000000&quot;&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;think&nbsp;what&nbsp;you&#39;ve&nbsp;provided&nbsp;me&nbsp;with&nbsp;is&nbsp;useful&nbsp;for&nbsp;me,&nbsp;but&nbsp;I&nbsp;think<br>
&nbsp;&nbsp;&nbsp;&nbsp;it&#39;s&nbsp;backwards&nbsp;for&nbsp;my&nbsp;purposes,&nbsp;as&nbsp;I&nbsp;need&nbsp;to&nbsp;be&nbsp;connecting&nbsp;to&nbsp;the<br>
&nbsp;&nbsp;&nbsp;&nbsp;policy&nbsp;daemon&nbsp;rather&nbsp;than&nbsp;being&nbsp;the&nbsp;policy&nbsp;daemon!&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;wanted&nbsp;to&nbsp;do&nbsp;this&nbsp;with&nbsp;deferred&nbsp;calls&nbsp;in&nbsp;case&nbsp;one&nbsp;of&nbsp;the&nbsp;policy<br>
&nbsp;&nbsp;&nbsp;&nbsp;daemons&nbsp;becomes&nbsp;unreachable&nbsp;and&nbsp;blocks&nbsp;my&nbsp;application. &nbsp;Do&nbsp;you&nbsp;think<br>
&nbsp;&nbsp;&nbsp;&nbsp;I&nbsp;should&nbsp;do&nbsp;something&nbsp;differently&nbsp;in&nbsp;that&nbsp;regard? &nbsp;My&nbsp;SQL&nbsp;lookups<br>
&nbsp;&nbsp;&nbsp;&nbsp;are&nbsp;done&nbsp;synchronously. &nbsp;If&nbsp;the&nbsp;database&nbsp;server&nbsp;goes&nbsp;away,&nbsp;I&#39;ve&nbsp;got<br>
&nbsp;&nbsp;&nbsp;&nbsp;bigger&nbsp;problems&nbsp;anyway!&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;So&nbsp;maybe&nbsp;something&nbsp;like&nbsp;this&nbsp;is&nbsp;more&nbsp;likely&nbsp;to&nbsp;be&nbsp;useful:&lt;br&gt;&lt;br&gt;&lt;span&nbsp;style=&quot;font-family:monospace,monospace&quot;&gt;#!/usr/bin/env&nbsp;python&lt;br&gt;&lt;br&gt;from&nbsp;__future__&nbsp;import&nbsp;print_function&lt;br&gt;&lt;br&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;reactor,&nbsp;protocol,&nbsp;endpoints,&nbsp;defer&lt;br&gt;from&nbsp;twisted.protocols&nbsp;import&nbsp;basic&lt;br&gt;&lt;br&gt;&lt;br&gt;class&nbsp;PostfixProtocol(basic.LineReceiver):&lt;br&gt;&lt;br&gt;   &nbsp;#&nbsp;Assuming&nbsp;Postfix&nbsp;uses&nbsp;&#39;\r\n&#39;&nbsp;line&nbsp;breaks&nbsp;(does&nbsp;it?)&lt;br&gt;   &nbsp;delimiter&nbsp;=&nbsp;&#39;\r\n&#39;&lt;br&gt;&lt;br&gt;   &nbsp;def&nbsp;__init__(self):&lt;br&gt;   &nbsp;   &nbsp;self.action&nbsp;=&nbsp;None&lt;br&gt;   &nbsp;   &nbsp;self.action_deferred&nbsp;=&nbsp;None&lt;br&gt;&lt;br&gt;   &nbsp;def&nbsp;lineReceived(self,&nbsp;line):&lt;br&gt;   &nbsp;   &nbsp;if&nbsp;&#39;=&#39;&nbsp;in&nbsp;line:&lt;br&gt;   &nbsp;   &nbsp;   &nbsp;self.action&nbsp;=&nbsp;line.split(&#39;=&#39;)[1]&lt;br&gt;   &nbsp;   &nbsp;elif&nbsp;line&nbsp;==&nbsp;&#39;&#39;:&lt;br&gt;   &nbsp;   &nbsp;   &nbsp;self.action_deferred.callback(self.action)&lt;br&gt;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-family:monospace,monospace&quot;&gt;&lt;span&nbsp;style=&quot;font-family:monospace,monospace&quot;&gt;   &nbsp;   &nbsp;   &nbsp;self.action_deferred&nbsp;=&nbsp;None&lt;br&gt;&lt;/span&gt;   &nbsp;   &nbsp;else:&lt;br&gt;   &nbsp;   &nbsp;   &nbsp;#&nbsp;oops,&nbsp;bad&nbsp;input&lt;br&gt;   &nbsp;   &nbsp;   &nbsp;pass&lt;br&gt;&lt;br&gt;   &nbsp;def&nbsp;sendPostfixRequest(self,&nbsp;request_dict):&lt;br&gt;   &nbsp;   &nbsp;if&nbsp;not&nbsp;self.action_deferred&nbsp;is&nbsp;None:&lt;br&gt;   &nbsp;   &nbsp;   &nbsp;raise&nbsp;Exception(&#39;transaction&nbsp;pending&#39;)&lt;br&gt;   &nbsp;   &nbsp;for&nbsp;k,&nbsp;v&nbsp;in&nbsp;request_dict.items():&lt;br&gt;   &nbsp;   &nbsp;   &nbsp;self.sendLine(&#39;{}={}&#39;.format(k,v))&lt;br&gt;   &nbsp;   &nbsp;#&nbsp;Empty&nbsp;line&nbsp;signals&nbsp;we&#39;re&nbsp;done&lt;br&gt;   &nbsp;   &nbsp;self.sendLine(&#39;&#39;)&lt;br&gt;   &nbsp;   &nbsp;self.action_deferred&nbsp;=&nbsp;defer.Deferred()&lt;br&gt;   &nbsp;   &nbsp;return&nbsp;self.action_deferred&lt;br&gt;&lt;br&gt;@defer.inlineCallbacks&lt;br&gt;def&nbsp;checkPostfixPolicy(request_dict):&lt;br&gt;   &nbsp;ep&nbsp;=&nbsp;endpoints.clientFromString(reactor,&nbsp;&#39;tcp:host=127.0.0.1:port=10000&#39;)&lt;br&gt;   &nbsp;p&nbsp;=&nbsp;yield&nbsp;endpoints.connectProtocol(ep,&nbsp;PostfixProtocol())&lt;br&gt;   &nbsp;action&nbsp;=&nbsp;yield&nbsp;p.sendPostfixRequest(request_dict)&lt;br&gt;   &nbsp;print(&#39;got:&nbsp;{}&#39;.format(action))&lt;br&gt;   &nbsp;reactor.stop()&lt;br&gt;&lt;br&gt;&lt;br&gt;if&nbsp;__name__&nbsp;==&nbsp;&#39;__main__&#39;:&lt;br&gt;&lt;br&gt;   &nbsp;request_dict&nbsp;=&nbsp;{&lt;br&gt;   &nbsp;   &nbsp;&#39;recipient&#39;:&nbsp;&#39;email@ddr.ess&#39;,&lt;br&gt;   &nbsp;   &nbsp;&#39;sender&#39;:&nbsp;&#39;email@ddr.ess&#39;,&lt;br&gt;   &nbsp;}&lt;br&gt;   &nbsp;reactor.callWhenRunning(checkPostfixPolicy,&nbsp;request_dict)&lt;br&gt;   &nbsp;reactor.run()&lt;br&gt;&lt;/span&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;Highlights:&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;-&nbsp;This&nbsp;is&nbsp;not&nbsp;the&nbsp;same&nbsp;protocol&nbsp;as&nbsp;before,&nbsp;in&nbsp;particular&nbsp;it&nbsp;uses&nbsp;a&nbsp;different&nbsp;delimiter.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;-&nbsp;It&nbsp;assumes&nbsp;the&nbsp;response&nbsp;is&nbsp;also&nbsp;terminated&nbsp;with&nbsp;an&nbsp;empty&nbsp;line&nbsp;(does&nbsp;it?).&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;-&nbsp;It&nbsp;more&nbsp;than&nbsp;one&nbsp;outstanding&nbsp;response:&nbsp;a&nbsp;different&nbsp;exception&nbsp;should&nbsp;be&nbsp;used.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;-&nbsp;The&nbsp;input&nbsp;processing&nbsp;is&nbsp;very&nbsp;rudimentary&nbsp;and&nbsp;failure-prone.&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;-&nbsp;checkPostfixPolicy&nbsp;could,&nbsp;of&nbsp;course,&nbsp;return&nbsp;instead&nbsp;of&nbsp;printing.&nbsp;:)&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Cheers,&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;--&lt;br&gt; &nbsp;exvito&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
