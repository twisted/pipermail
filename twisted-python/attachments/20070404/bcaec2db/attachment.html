<tt>
&lt;html&gt;&lt;body&gt;Hi&nbsp;甜瓜,&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;On&nbsp;10:11&nbsp;am,&nbsp;littlesweetmelon@gmail.com&nbsp;wrote:&lt;br&nbsp;/&gt;&gt;Q1:&nbsp;How&nbsp;to&nbsp;determine&nbsp;a&nbsp;function&nbsp;is&nbsp;'blocking&nbsp;action'&nbsp;or&nbsp;not?&lt;br&nbsp;/&gt;&gt;Any&nbsp;function&nbsp;needs&nbsp;CPU&nbsp;times.&nbsp;Indeed,&nbsp;a&nbsp;computational-intensive&lt;br&nbsp;/&gt;&gt;function&nbsp;is&nbsp;blocking&nbsp;action.&nbsp;But&nbsp;how&nbsp;small/fast&nbsp;function&nbsp;can&nbsp;be&lt;br&nbsp;/&gt;&gt;classified&nbsp;as&nbsp;non-blocking?&nbsp;Twist&nbsp;requires&nbsp;all&nbsp;user&nbsp;functions&nbsp;to&nbsp;be&lt;br&nbsp;/&gt;&gt;non-blocked.&nbsp;If&nbsp;reactor&nbsp;calls&nbsp;a&nbsp;blocking&nbsp;function,&nbsp;what&nbsp;will&nbsp;happen?&lt;br&nbsp;/&gt;&gt;In&nbsp;my&nbsp;mind,&nbsp;reactor&nbsp;maintains&nbsp;a&nbsp;command&nbsp;queue&nbsp;internally&nbsp;(just&nbsp;like&lt;br&nbsp;/&gt;&gt;windows&nbsp;message&nbsp;queue).&nbsp;The&nbsp;blocking&nbsp;function&nbsp;only&nbsp;postpones&nbsp;the&lt;br&nbsp;/&gt;&gt;execution&nbsp;of&nbsp;other&nbsp;queued&nbsp;functions,&nbsp;but&nbsp;it&nbsp;does&nbsp;not&nbsp;break&nbsp;the&nbsp;logic&lt;br&nbsp;/&gt;&gt;of&nbsp;the&nbsp;program.&nbsp;Is&nbsp;that&nbsp;right?&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;You've&nbsp;basically&nbsp;answered&nbsp;your&nbsp;own&nbsp;question&nbsp;here.&nbsp;&#160;A&nbsp;&quot;blocking&nbsp;action&quot;&nbsp;is&nbsp;one&nbsp;where&nbsp;your&nbsp;users&nbsp;will&nbsp;not&nbsp;want&nbsp;to&nbsp;wait&nbsp;for&nbsp;it&nbsp;:).&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Q2:&nbsp;Today&nbsp;when&nbsp;I&nbsp;go&nbsp;through&nbsp;the&nbsp;twist&nbsp;document,&nbsp;I&nbsp;am&nbsp;confused&nbsp;about&lt;br&nbsp;/&gt;&gt;the&nbsp;threading&nbsp;problem&nbsp;in&nbsp;reactor.&lt;br&nbsp;/&gt;&gt;What&nbsp;is&nbsp;the&nbsp;different&nbsp;between&nbsp;'reactor.callFromThread'&nbsp;and&nbsp;a&nbsp;plain&lt;br&nbsp;/&gt;&gt;call&nbsp;in&nbsp;reactor&nbsp;loop?&lt;br&nbsp;/&gt;&gt;def&nbsp;callFromThread(f):&lt;br&nbsp;/&gt;&gt;&nbsp;&#160;&nbsp;&#160;&nbsp;&#160;&nbsp;&#160;&nbsp;&#160;&nbsp;&#160;self.threadCallQueue.append((f,&nbsp;args,&nbsp;kw))&lt;br&nbsp;/&gt;&gt;&nbsp;&#160;&nbsp;&#160;&nbsp;&#160;&nbsp;&#160;&nbsp;&#160;&nbsp;&#160;self.wakeUp()&lt;br&nbsp;/&gt;&gt;It&nbsp;seems&nbsp;equivalent&nbsp;to&nbsp;reactor.callLater(0,&nbsp;f...).&lt;br&nbsp;/&gt;&gt;What&nbsp;is&nbsp;the&nbsp;real&nbsp;circumstance&nbsp;for&nbsp;calling&nbsp;callFromThread?&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;callLater&nbsp;is&nbsp;not&nbsp;thread-safe.&nbsp;&#160;callFromThread&nbsp;is&nbsp;designed&nbsp;to&nbsp;be&nbsp;called,&nbsp;well,&nbsp;from&nbsp;a&nbsp;thread.&nbsp;&#160;You&nbsp;use&nbsp;callFromThread&nbsp;from&nbsp;threads&nbsp;*other*&nbsp;than&nbsp;the&nbsp;thread&nbsp;where&nbsp;the&nbsp;reactor&nbsp;is&nbsp;running,&nbsp;in&nbsp;order&nbsp;to&nbsp;wake&nbsp;up&nbsp;the&nbsp;reactor&nbsp;thread&nbsp;and&nbsp;have&nbsp;it&nbsp;do&nbsp;something&nbsp;-&nbsp;usually&nbsp;something&nbsp;that&nbsp;involves&nbsp;calling&nbsp;a&nbsp;non-thread-safe&nbsp;Twisted&nbsp;API.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Further&nbsp;more,&nbsp;how&nbsp;to&nbsp;determine&nbsp;a&nbsp;function&nbsp;is&nbsp;thread-safe&nbsp;in&nbsp;python?&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;As&nbsp;in&nbsp;any&nbsp;other&nbsp;language,&nbsp;ask&nbsp;the&nbsp;person&nbsp;who&nbsp;wrote&nbsp;it.&nbsp;&#160;There&nbsp;is&nbsp;no&nbsp;other&nbsp;way&nbsp;to&nbsp;determine&nbsp;if&nbsp;a&nbsp;function&nbsp;is&nbsp;thread-safe.&nbsp;&#160;In&nbsp;any&nbsp;language&nbsp;with&nbsp;dynamic&nbsp;run-time&nbsp;dispatch,&nbsp;determining&nbsp;this&nbsp;without&nbsp;talking&nbsp;to&nbsp;the&nbsp;author&nbsp;of&nbsp;the&nbsp;code&nbsp;in&nbsp;question&nbsp;reduces&nbsp;to&nbsp;the&nbsp;halting&nbsp;problem.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Why&nbsp;the&nbsp;twist&nbsp;doc&nbsp;says:&nbsp;&quot;writing&nbsp;data&nbsp;to&nbsp;a&nbsp;transport&nbsp;from&nbsp;a&nbsp;protocol&lt;br&nbsp;/&gt;&gt;is&nbsp;not&nbsp;thread-safe.&quot;?&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;Nothing&nbsp;in&nbsp;Twisted&nbsp;is&nbsp;thread-safe&nbsp;(other&nbsp;than&nbsp;callFromThread)&nbsp;but&nbsp;this&nbsp;is&nbsp;a&nbsp;particularly&nbsp;common&nbsp;error&nbsp;and&nbsp;we&nbsp;wanted&nbsp;to&nbsp;stress&nbsp;it.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&gt;Q3:&nbsp;In&nbsp;my&nbsp;application,&nbsp;I&nbsp;need&nbsp;a&nbsp;facility&nbsp;to&nbsp;dynamically&nbsp;select&nbsp;a&lt;br&nbsp;/&gt;&gt;protocol&nbsp;to&nbsp;communicate&nbsp;with&nbsp;the&nbsp;server.&lt;br&nbsp;/&gt;&gt;Eg:&nbsp;When&nbsp;connected,&nbsp;the&nbsp;server&nbsp;sent&nbsp;a&nbsp;string&nbsp;to&nbsp;client&nbsp;to&nbsp;indicate&nbsp;the&lt;br&nbsp;/&gt;&gt;version&nbsp;of&nbsp;protocol&nbsp;it&nbsp;used.&nbsp;Then,&nbsp;the&nbsp;client&nbsp;can&nbsp;load&nbsp;the&nbsp;proper&lt;br&nbsp;/&gt;&gt;protocol.&nbsp;But&nbsp;I&nbsp;don't&nbsp;know&nbsp;how&nbsp;to&nbsp;implement&nbsp;this.&nbsp;A&nbsp;'Factory'&nbsp;can&nbsp;only&lt;br&nbsp;/&gt;&gt;create&nbsp;one&nbsp;kind&nbsp;of&nbsp;'Protocol',&nbsp;and&nbsp;it&nbsp;seems&nbsp;the&nbsp;instances&nbsp;of&lt;br&nbsp;/&gt;&gt;'Protocol'&nbsp;cannot&nbsp;share&nbsp;the&nbsp;connection&nbsp;(Transport&nbsp;object)&nbsp;to&nbsp;a&nbsp;server.&lt;br&nbsp;/&gt;&gt;Could&nbsp;you&nbsp;give&nbsp;me&nbsp;some&nbsp;clues?&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;The&nbsp;protocol&nbsp;that&nbsp;you&nbsp;are&nbsp;implementing&nbsp;includes&nbsp;a&nbsp;&quot;version&quot;&nbsp;message.&nbsp;&#160;Unless&nbsp;you&nbsp;have&nbsp;a&nbsp;&quot;Protocol&quot;&nbsp;object&nbsp;connected&nbsp;to&nbsp;receive&nbsp;the&nbsp;data&nbsp;and&nbsp;decode&nbsp;that&nbsp;message,&nbsp;you&nbsp;can't&nbsp;decide&nbsp;which&nbsp;version&nbsp;to&nbsp;use&nbsp;for&nbsp;subsequent&nbsp;messages.&nbsp;&#160;Simply&nbsp;implement&nbsp;a&nbsp;&quot;Protocol&quot;&nbsp;which&nbsp;understands&nbsp;that&nbsp;&quot;version&quot;&nbsp;message&nbsp;and&nbsp;changes&nbsp;its&nbsp;behavior&nbsp;accordingly.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;For&nbsp;an&nbsp;example&nbsp;of&nbsp;how&nbsp;you&nbsp;might&nbsp;switch&nbsp;to&nbsp;a&nbsp;completely&nbsp;different&nbsp;protocol&nbsp;object,&nbsp;see&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;http://twistedmatrix.com/trac/browser/trunk/twisted/protocols/amp.py#L1524&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;The&nbsp;techniques&nbsp;involved&nbsp;are&nbsp;quite&nbsp;nuanced,&nbsp;however,&nbsp;and&nbsp;are&nbsp;probably&nbsp;not&nbsp;appropriate&nbsp;for&nbsp;someone&nbsp;just&nbsp;learning&nbsp;about&nbsp;Twisted.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
