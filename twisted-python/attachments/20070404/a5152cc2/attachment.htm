<tt>
&lt;html&gt;&lt;body&gt;On&nbsp;04:35&nbsp;pm,&nbsp;daniel@keystonewood.com&nbsp;wrote:&lt;br&nbsp;/&gt;&amp;gt;On&nbsp;Apr&nbsp;3,&nbsp;2007,&nbsp;at&nbsp;8:42&nbsp;PM,&nbsp;Itamar&nbsp;Shtull-Trauring&nbsp;wrote:&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;On&nbsp;Tue,&nbsp;2007-04-03&nbsp;at&nbsp;17:07&nbsp;-0400,&nbsp;Daniel&nbsp;Miller&nbsp;wrote:&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;twisted.internet.defer.DeferredLock&nbsp;and&nbsp;some&nbsp;of&nbsp;the&nbsp;related&nbsp;classes&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;are&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;&amp;gt;&amp;gt;what&nbsp;you&nbsp;ought&nbsp;to&nbsp;be&nbsp;using.&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;&amp;gt;&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;&amp;gt;Unfortunately&nbsp;that&nbsp;only&nbsp;gets&nbsp;me&nbsp;half&nbsp;way&nbsp;there.&nbsp;DeferredLock.acquire&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;&amp;gt;()&nbsp;returns&nbsp;a&nbsp;deferred.&nbsp;How&nbsp;do&nbsp;I&nbsp;return&nbsp;the&nbsp;result&nbsp;of&nbsp;a&nbsp;deferred&nbsp;from&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;&amp;gt;a&nbsp;PB&nbsp;remote_xxx()&nbsp;function?&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;&lt;br&nbsp;/&gt;&amp;gt;&amp;gt;Just&nbsp;return&nbsp;the&nbsp;Deferred&nbsp;from&nbsp;the&nbsp;remote_xxx()&nbsp;function.&lt;br&nbsp;/&gt;&amp;gt;&lt;br&nbsp;/&gt;&amp;gt;Thanks,&nbsp;I&nbsp;didn't&nbsp;know&nbsp;I&nbsp;could&nbsp;return&nbsp;a&nbsp;deferred&nbsp;from&nbsp;a&nbsp;PB&nbsp;remote_xxx&nbsp;()&nbsp;&lt;br&nbsp;/&gt;&amp;gt;method.&nbsp;That&nbsp;detail&nbsp;doesn't&nbsp;seem&nbsp;to&nbsp;be&nbsp;documented&nbsp;in&nbsp;the&nbsp;&amp;#160;Perspective&nbsp;Broker&nbsp;&lt;br&nbsp;/&gt;&amp;gt;documentation,&nbsp;which&nbsp;I&nbsp;have&nbsp;read&nbsp;quite&nbsp;a&nbsp;few&nbsp;&amp;#160;times.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;The&nbsp;PB&nbsp;documentation&nbsp;is&nbsp;not&nbsp;too&nbsp;great.&nbsp;&amp;#160;Perhaps&nbsp;this&nbsp;paper&nbsp;would&nbsp;be&nbsp;helpful&nbsp;to&nbsp;you,&nbsp;if&nbsp;you&nbsp;haven't&nbsp;seen&nbsp;it:&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;http://www.lothar.com/tech/papers/PyCon-2003/pb-pycon/pb.html#auto7&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&quot;&quot;&quot;&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;In&nbsp;addition,&nbsp;the&nbsp;remote&nbsp;method&nbsp;can&nbsp;itself&nbsp;return&nbsp;a&nbsp;Deferred&nbsp;instead&nbsp;of&nbsp;an&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;actual&nbsp;return&nbsp;value.&nbsp;When&nbsp;that&nbsp;Deferreds&nbsp;fires,&nbsp;the&nbsp;data&nbsp;given&nbsp;to&nbsp;the&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;callback&nbsp;will&nbsp;be&nbsp;serialized&nbsp;and&nbsp;returned&nbsp;to&nbsp;the&nbsp;original&nbsp;caller.&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&quot;&quot;&quot;&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&amp;gt;&nbsp;Maybe&nbsp;this&nbsp;could&nbsp;be&nbsp;&lt;br&nbsp;/&gt;&amp;gt;highlighted&nbsp;in&nbsp;the&nbsp;&quot;Complete&nbsp;Example&quot;&nbsp;[0]&nbsp;&amp;#160;section&nbsp;of&nbsp;the&nbsp;PB&nbsp;usage&nbsp;&lt;br&nbsp;/&gt;&amp;gt;documentation?&nbsp;The&nbsp;examples&nbsp;use&nbsp;the&nbsp;&amp;#160;TwistedQuotes&nbsp;application,&nbsp;and&nbsp;the&nbsp;&lt;br&nbsp;/&gt;&amp;gt;IQuoter.getQuote()&nbsp;method&nbsp;always&nbsp;&amp;#160;returns&nbsp;a&nbsp;string&nbsp;(at&nbsp;least&nbsp;I&nbsp;couldn't&nbsp;find&nbsp;&lt;br&nbsp;/&gt;&amp;gt;any&nbsp;implementations&nbsp;that&nbsp;&amp;#160;return&nbsp;a&nbsp;deferred).&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;Please&nbsp;feel&nbsp;free&nbsp;to&nbsp;write&nbsp;some&nbsp;patches&nbsp;for&nbsp;the&nbsp;documentation,&nbsp;or&nbsp;open&nbsp;a&nbsp;doc&nbsp;bug&nbsp;describing&nbsp;this&nbsp;issue&nbsp;in&nbsp;more&nbsp;detail.&nbsp;&amp;#160;It's&nbsp;definitely&nbsp;an&nbsp;under-documented&nbsp;feature&nbsp;of&nbsp;PB.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&amp;gt;However,&nbsp;that&nbsp;would&nbsp;require&nbsp;&lt;br&nbsp;/&gt;&amp;gt;rewriting&nbsp;most&nbsp;if&nbsp;not&nbsp;&amp;#160;all&nbsp;implementations&nbsp;of&nbsp;IQuoter&nbsp;to&nbsp;return&nbsp;deferred's&nbsp;&lt;br&nbsp;/&gt;&amp;gt;and/or&nbsp;the&nbsp;code&nbsp;&amp;#160;that&nbsp;calls&nbsp;IQuoter.getQuote(),&nbsp;which&nbsp;demonstrates&nbsp;the&nbsp;viral&nbsp;&lt;br&nbsp;/&gt;&amp;gt;nature&nbsp;of&nbsp;&amp;#160;twisted&nbsp;when&nbsp;used&nbsp;in&nbsp;conjunction&nbsp;with&nbsp;other&nbsp;libraries.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;I&nbsp;don't&nbsp;think&nbsp;that&nbsp;would&nbsp;really&nbsp;be&nbsp;the&nbsp;terrible&nbsp;burden&nbsp;that&nbsp;you&nbsp;suggest,&nbsp;considering&nbsp;the&nbsp;relatively&nbsp;small&nbsp;amount&nbsp;of&nbsp;tutorial&nbsp;documentation&nbsp;that&nbsp;implements&nbsp;or&nbsp;calls&nbsp;IQuoter.&nbsp;&amp;#160;One&nbsp;could&nbsp;also&nbsp;propose&nbsp;a&nbsp;separate&nbsp;interface,&nbsp;IDeferredQuoter,&nbsp;to&nbsp;make&nbsp;the&nbsp;distinction&nbsp;clearer.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&amp;gt;So&nbsp;anyway,&nbsp;I&nbsp;rewrote&nbsp;my&nbsp;server-side&nbsp;library&nbsp;to&nbsp;do&nbsp;it&nbsp;the&nbsp;twisted&nbsp;way&nbsp;&amp;#160;and&nbsp;&lt;br&nbsp;/&gt;&amp;gt;return&nbsp;deferred's&nbsp;instead&nbsp;trying&nbsp;rig&nbsp;up&nbsp;some&nbsp;way&nbsp;of&nbsp;waiting&nbsp;for&nbsp;&amp;#160;them.&nbsp;I&nbsp;&lt;br&nbsp;/&gt;&amp;gt;still&nbsp;think&nbsp;it&nbsp;would&nbsp;be&nbsp;super&nbsp;useful&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;pseudo-&nbsp;block&nbsp;on&nbsp;a&nbsp;&lt;br&nbsp;/&gt;&amp;gt;deferred&nbsp;(i.e.&nbsp;allow&nbsp;the&nbsp;reactor&nbsp;to&nbsp;process&nbsp;other&nbsp;events&nbsp;&amp;#160;while&nbsp;waiting&nbsp;for&nbsp;&lt;br&nbsp;/&gt;&amp;gt;the&nbsp;deferred).&nbsp;It&nbsp;is&nbsp;very&nbsp;annoying&nbsp;to&nbsp;have&nbsp;to&nbsp;&amp;#160;rewrite&nbsp;many&nbsp;layers&nbsp;of&nbsp;code&nbsp;&lt;br&nbsp;/&gt;&amp;gt;when&nbsp;twisted&nbsp;is&nbsp;introduced&nbsp;into&nbsp;a&nbsp;&amp;#160;program.&nbsp;I&nbsp;did&nbsp;find&nbsp;gthreadless.py,&nbsp;and&nbsp;&lt;br&nbsp;/&gt;&amp;gt;maybe&nbsp;that&nbsp;would&nbsp;do&nbsp;it.&nbsp;&amp;#160;Unfortunately&nbsp;discussion&nbsp;on&nbsp;that&nbsp;seems&nbsp;to&nbsp;have&nbsp;been&nbsp;&lt;br&nbsp;/&gt;&amp;gt;dropped&nbsp;some&nbsp;time&nbsp;&amp;#160;ago...&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;I'm&nbsp;afraid&nbsp;that&nbsp;the&nbsp;feature&nbsp;you&nbsp;want&nbsp;doesn't&nbsp;make&nbsp;any&nbsp;sense&nbsp;and&nbsp;is,&nbsp;in&nbsp;a&nbsp;broad&nbsp;sense,&nbsp;impossible.&nbsp;&amp;#160;There&nbsp;are&nbsp;some&nbsp;things&nbsp;like&nbsp;it&nbsp;which&nbsp;might&nbsp;be&nbsp;possible&nbsp;-&nbsp;for&nbsp;example,&nbsp;http://twistedmatrix.com/trac/ticket/2545&nbsp;-&nbsp;but&nbsp;the&nbsp;reactor&nbsp;is&nbsp;not&nbsp;reentrant&nbsp;and&nbsp;in&nbsp;some&nbsp;sense&nbsp;could&nbsp;not&nbsp;be&nbsp;made&nbsp;reentrant.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;Consider&nbsp;this&nbsp;innocuous&nbsp;looking&nbsp;block&nbsp;of&nbsp;code:&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;from&nbsp;twisted.internet.protocol&nbsp;import&nbsp;Protocol&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;from&nbsp;make_believe&nbsp;import&nbsp;magicallyBlockOn&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;class&nbsp;MagicalProtocol(Protocol):&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;def&nbsp;dataReceived(self,&nbsp;data):&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;commands&nbsp;=&nbsp;(self.buf&nbsp;+&nbsp;data).split()&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;self.buf&nbsp;=&nbsp;commands[-1]&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;for&nbsp;command&nbsp;in&nbsp;commands[:-1]:&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;if&nbsp;command&nbsp;==&nbsp;'QUIT':&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;self.transport.loseConnection()&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;return&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;else:&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;#&nbsp;Deferreds&nbsp;are&nbsp;hard,&nbsp;let's&nbsp;go&nbsp;shopping&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;page&nbsp;=&nbsp;magicallyBlockOn(getPage(&quot;http://example.com/%s&quot;&nbsp;%&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;(command,)))&lt;br&nbsp;/&gt;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;&amp;#160;&nbsp;self.transport.write(&quot;SIZE:&quot;+len(page))&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;If&nbsp;you&nbsp;were&nbsp;using&nbsp;Deferreds&nbsp;to&nbsp;track&nbsp;the&nbsp;result&nbsp;of&nbsp;the&nbsp;'getPage'&nbsp;operation,&nbsp;you&nbsp;could&nbsp;cancel&nbsp;the&nbsp;callbacks&nbsp;that&nbsp;write&nbsp;to&nbsp;the&nbsp;transport&nbsp;in&nbsp;connectionLost.&nbsp;&amp;#160;However,&nbsp;with&nbsp;magical&nbsp;blocking,&nbsp;one&nbsp;dataReceived&nbsp;method&nbsp;might&nbsp;be&nbsp;interleaved&nbsp;with&nbsp;another.&nbsp;&amp;#160;That&nbsp;means&nbsp;that&nbsp;every&nbsp;time&nbsp;through&nbsp;the&nbsp;loop,&nbsp;you&nbsp;have&nbsp;to&nbsp;check&nbsp;to&nbsp;see&nbsp;if&nbsp;the&nbsp;transport&nbsp;has&nbsp;already&nbsp;been&nbsp;disconnected&nbsp;-&nbsp;the&nbsp;code&nbsp;as&nbsp;presented&nbsp;here&nbsp;is&nbsp;buggy&nbsp;and&nbsp;will&nbsp;spuriously&nbsp;fail&nbsp;depending&nbsp;on&nbsp;the&nbsp;order&nbsp;of&nbsp;the&nbsp;connection&nbsp;being&nbsp;lost&nbsp;and&nbsp;the&nbsp;remote&nbsp;page&nbsp;being&nbsp;retrieved.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;In&nbsp;this&nbsp;example&nbsp;I've&nbsp;been&nbsp;careful&nbsp;to&nbsp;accumulate&nbsp;all&nbsp;the&nbsp;buffer-management&nbsp;and&nbsp;parsing&nbsp;logic&nbsp;at&nbsp;the&nbsp;top&nbsp;of&nbsp;the&nbsp;method,&nbsp;before&nbsp;any&nbsp;potential&nbsp;re-entrancy&nbsp;can&nbsp;happen,&nbsp;but&nbsp;other&nbsp;code&nbsp;(most&nbsp;everything&nbsp;in&nbsp;Twisted's&nbsp;existing&nbsp;protocol&nbsp;implementations,&nbsp;not&nbsp;to&nbsp;mention&nbsp;just&nbsp;about&nbsp;all&nbsp;application&nbsp;code)&nbsp;would&nbsp;not&nbsp;be&nbsp;so&nbsp;lucky.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;It&nbsp;might&nbsp;be&nbsp;quite&nbsp;feasible&nbsp;to&nbsp;implement&nbsp;a&nbsp;microthreaded&nbsp;runtime&nbsp;environment&nbsp;that&nbsp;lived&nbsp;on&nbsp;_top_&nbsp;of&nbsp;Twisted&nbsp;and&nbsp;explicitly&nbsp;accounted&nbsp;for&nbsp;issues&nbsp;like&nbsp;these,&nbsp;but&nbsp;that&nbsp;would&nbsp;not&nbsp;really&nbsp;be&nbsp;substantially&nbsp;different&nbsp;than&nbsp;2.5+inlineCallbacks.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&amp;gt;For&nbsp;the&nbsp;record,&nbsp;I've&nbsp;included&nbsp;updated&nbsp;versions&nbsp;of&nbsp;the&nbsp;previously&nbsp;&amp;#160;posted&nbsp;&lt;br&nbsp;/&gt;&amp;gt;code&nbsp;below.&nbsp;I'd&nbsp;be&nbsp;happy&nbsp;if&nbsp;someone&nbsp;pointed&nbsp;out&nbsp;if&nbsp;I'm&nbsp;doing&nbsp;&amp;#160;anything&nbsp;wrong&nbsp;&lt;br&nbsp;/&gt;&amp;gt;(with&nbsp;respect&nbsp;to&nbsp;twisted)&nbsp;in&nbsp;this&nbsp;code.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;Nothing&nbsp;immediately&nbsp;jumps&nbsp;out&nbsp;at&nbsp;me.&nbsp;&amp;#160;I've&nbsp;had&nbsp;to&nbsp;write&nbsp;similar&nbsp;code&nbsp;in&nbsp;the&nbsp;past,&nbsp;though,&nbsp;and&nbsp;when&nbsp;I've&nbsp;had&nbsp;to&nbsp;do&nbsp;that,&nbsp;an&nbsp;explicit&nbsp;state&nbsp;machine&nbsp;for&nbsp;the&nbsp;state&nbsp;of&nbsp;the&nbsp;subprocess&nbsp;(or&nbsp;whatever&nbsp;asynchronous&nbsp;resource&nbsp;must&nbsp;be&nbsp;acquired)&nbsp;has&nbsp;been&nbsp;easier&nbsp;to&nbsp;deal&nbsp;with&nbsp;than&nbsp;a&nbsp;lock-oriented&nbsp;approach&nbsp;to&nbsp;it.&lt;br&nbsp;/&gt;&lt;br&nbsp;/&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
