<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;You&nbsp;may&nbsp;want&nbsp;to&nbsp;look&nbsp;at&nbsp;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/documents/18.7.0/api/twisted.application.internet.ClientService.html&quot;&gt;twisted.application.internet.ClientService&lt;/a&gt;. &nbsp;It&nbsp;uses&nbsp;the&nbsp;new&nbsp;endpoints&nbsp;instead&nbsp;of&nbsp;the&nbsp;`connectTCP()`&nbsp;stuff. &nbsp;Not&nbsp;sure&nbsp;if&nbsp;it&nbsp;applies&nbsp;in&nbsp;your&nbsp;situation,&nbsp;but&nbsp;it&nbsp;has&nbsp;all&nbsp;of&nbsp;the&nbsp;retry&nbsp;logic&nbsp;built&nbsp;in,&nbsp;so&nbsp;that&nbsp;may&nbsp;make&nbsp;it&nbsp;easier&nbsp;to&nbsp;work&nbsp;with.&lt;/div&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail_attr&quot;&gt;On&nbsp;Fri,&nbsp;Mar&nbsp;22,&nbsp;2019&nbsp;at&nbsp;10:08&nbsp;AM&nbsp;Chris&nbsp;Satterthwaite&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:chris@cmsconstruct.com&quot;&gt;chris@cmsconstruct.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-style:solid;border-left-color:rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;lang=&quot;EN-US&quot;&gt;&lt;div&nbsp;class=&quot;gmail-m_-1987170580212977818WordSection1&quot;&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Hello&nbsp;community,&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;First&nbsp;of&nbsp;all&nbsp;-&nbsp;thanks&nbsp;for&nbsp;an&nbsp;awesome&nbsp;platform! &nbsp;I’m&nbsp;brand&nbsp;new&nbsp;to&nbsp;this&nbsp;community,&nbsp;but&nbsp;have&nbsp;been&nbsp;using&nbsp;Twisted&nbsp;a&nbsp;couple&nbsp;years.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Reason&nbsp;for&nbsp;posting:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I’ve&nbsp;hit&nbsp;a&nbsp;condition&nbsp;with&nbsp;ReconnectingClientFactory&nbsp;that&nbsp;I’m&nbsp;not&nbsp;sure&nbsp;is&nbsp;per&nbsp;design. &nbsp;I&nbsp;have&nbsp;a&nbsp;work&nbsp;around&nbsp;right&nbsp;now,&nbsp;but&nbsp;need&nbsp;your&nbsp;perspective. &nbsp;Seems&nbsp;like&nbsp;there&nbsp;should&nbsp;be&nbsp;a&nbsp;better/right&nbsp;way&nbsp;to&nbsp;do&nbsp;this.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Attempted&nbsp;design:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I’d&nbsp;like&nbsp;to&nbsp;have&nbsp;long&nbsp;running&nbsp;TCP&nbsp;clients&nbsp;(forever&nbsp;until&nbsp;stopped),&nbsp;with&nbsp;a&nbsp;long&nbsp;running&nbsp;TCP&nbsp;server. &nbsp;When&nbsp;a&nbsp;long&nbsp;running&nbsp;client&nbsp;hits&nbsp;a&nbsp;problem&nbsp;with&nbsp;a&nbsp;dependency&nbsp;(database&nbsp;is&nbsp;down,&nbsp;kafka&nbsp;bus&nbsp;unavailable,&nbsp;external&nbsp;API&nbsp;not&nbsp;responding,&nbsp;etc),&nbsp;I&nbsp;want&nbsp;the&nbsp;client&nbsp;to&nbsp;go&nbsp;offline&nbsp;for&nbsp;a&nbsp;while&nbsp;and&nbsp;then&nbsp;come&nbsp;back&nbsp;online…&nbsp;an&nbsp;automated,&nbsp;self-recovery&nbsp;type&nbsp;action. &nbsp;Since&nbsp;it’s&nbsp;not&nbsp;ok&nbsp;to&nbsp;start/stop/restart&nbsp;the&nbsp;Twisted&nbsp;Reactor,&nbsp;I&nbsp;am&nbsp;letting&nbsp;the&nbsp;client&nbsp;finish&nbsp;whatever&nbsp;it&nbsp;can&nbsp;do,&nbsp;disconnect&nbsp;from&nbsp;the&nbsp;service,&nbsp;destruct&nbsp;the&nbsp;dependencies,&nbsp;wait&nbsp;for&nbsp;a&nbsp;period&nbsp;of&nbsp;time,&nbsp;and&nbsp;then&nbsp;attempt&nbsp;a&nbsp;clean&nbsp;re-initialization&nbsp;of&nbsp;those&nbsp;dependencies&nbsp;along&nbsp;with&nbsp;reconnecting&nbsp;to&nbsp;the&nbsp;Twisted&nbsp;Server.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Problem&nbsp;case:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I’m&nbsp;using&nbsp;the&nbsp;ReconnectingClientFactory&nbsp;in&nbsp;my&nbsp;client. &nbsp;When&nbsp;the&nbsp;client&nbsp;hits&nbsp;a&nbsp;problem,&nbsp;it&nbsp;calls&nbsp;transport.loseConnection(). &nbsp;But&nbsp;whenever&nbsp;the&nbsp;client&nbsp;calls&nbsp;this,&nbsp;after&nbsp;the&nbsp;disconnect&nbsp;–&nbsp;it&nbsp;does&nbsp;not&nbsp;reconnect;&nbsp;stopFactory&nbsp;is&nbsp;called&nbsp;and&nbsp;everything&nbsp;exits.&nbsp;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Work&nbsp;around:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I&nbsp;noticed&nbsp;some&nbsp;Twisted&nbsp;source&nbsp;code&nbsp;that&nbsp;works&nbsp;off&nbsp;factory.numPorts. &nbsp;If&nbsp;numPorts&nbsp;is&nbsp;1&nbsp;and&nbsp;the&nbsp;client&nbsp;loses&nbsp;the&nbsp;connection,&nbsp;it&nbsp;goes&nbsp;to&nbsp;0&nbsp;and&nbsp;calls&nbsp;the&nbsp;cleanup. &nbsp;So&nbsp;I&nbsp;conditionally&nbsp;increase&nbsp;this&nbsp;number&nbsp;right&nbsp;before&nbsp;intentionally&nbsp;disconnecting,&nbsp;and&nbsp;then&nbsp;reset&nbsp;that&nbsp;after&nbsp;reconnecting. &nbsp;This&nbsp;solves&nbsp;the&nbsp;problem,&nbsp;but&nbsp;it’s&nbsp;a&nbsp;hack. &nbsp;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I’ll&nbsp;attach&nbsp;the&nbsp;test&nbsp;scripts&nbsp;to&nbsp;this&nbsp;post&nbsp;(if&nbsp;attachments&nbsp;are&nbsp;allowed),&nbsp;but&nbsp;the&nbsp;main&nbsp;code&nbsp;is&nbsp;with&nbsp;these&nbsp;functions&nbsp;in&nbsp;the&nbsp;factory:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;               &nbsp;def&nbsp;clientConnectionLost(self,&nbsp;connector,&nbsp;reason):&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;print(&#39; &nbsp;factory&nbsp;clientConnectionLost:&nbsp;reason:&nbsp;{}&#39;.format(reason))&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;if&nbsp;self.disconnectedOnPurpose:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;           &nbsp;##&nbsp;Hack&nbsp;to&nbsp;keep&nbsp;reactor&nbsp;alive&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;           &nbsp;print(&#39; &nbsp;factory&nbsp;clientConnectionLost:&nbsp;increasing&nbsp;numPorts&#39;)&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;           &nbsp;self.numPorts&nbsp;+=&nbsp;1&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;           &nbsp;self.numPortsChanged&nbsp;=&nbsp;True&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;           &nbsp;self.disconnectedOnPurpose&nbsp;=&nbsp;False&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;print(&#39; &nbsp;...&nbsp;simulate&nbsp;client&nbsp;going&nbsp;idle&nbsp;before&nbsp;attempting&nbsp;restart...&#39;)&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;time.sleep(5)&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;ReconnectingClientFactory.clientConnectionLost(self,&nbsp;connector,&nbsp;reason)&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;print(&#39; &nbsp;factory&nbsp;clientConnectionLost:&nbsp;end.\n&#39;)&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;               &nbsp;def&nbsp;clientConnectionMade(self):&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;print(&#39; &nbsp;factory&nbsp;clientConnectionMade:&nbsp;starting&nbsp;numPorts:&nbsp;{}&#39;.format(self.numPorts))&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;if&nbsp;self.numPortsChanged&nbsp;:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;           &nbsp;##&nbsp;Resetting&nbsp;from&nbsp;hacked&nbsp;value&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;           &nbsp;print(&#39; &nbsp;factory&nbsp;clientConnectionMade:&nbsp;decreasing&nbsp;numPorts&#39;)&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;           &nbsp;self.numPorts&nbsp;-=&nbsp;1&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;#&nbsp;           &nbsp;self.numPortsChanged&nbsp;=&nbsp;False&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;print(&#39; &nbsp;factory&nbsp;clientConnectionMade:&nbsp;finished&nbsp;numPorts:&nbsp;{}&#39;.format(self.numPorts))&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;               &nbsp;def&nbsp;cleanup(self):&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;print(&#39;factory&nbsp;cleanup:&nbsp;calling&nbsp;loseConnection&#39;)&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                               &nbsp;if&nbsp;self.connectedClient&nbsp;is&nbsp;not&nbsp;None:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                                               &nbsp;self.connectedClient.transport.loseConnection()&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;                                               &nbsp;self.disconnectedOnPurpose&nbsp;=&nbsp;True&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;With&nbsp;the&nbsp;above&nbsp;lines&nbsp;commented&nbsp;out,&nbsp;once&nbsp;the&nbsp;cleanup&nbsp;call&nbsp;does&nbsp;transport.loseConnection(),&nbsp;the&nbsp;factory&nbsp;stops&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;clientConnectionLost.&nbsp;&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;Sample&nbsp;scripts/logs:&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;I’ve&nbsp;tried&nbsp;to&nbsp;create&nbsp;short&nbsp;test&nbsp;scripts&nbsp;and&nbsp;corresponding&nbsp;logs&nbsp;(with&nbsp;the&nbsp;client&nbsp;failing,&nbsp;and&nbsp;then&nbsp;with&nbsp;it&nbsp;restarting&nbsp;when&nbsp;I&nbsp;use&nbsp;the&nbsp;workaround). &nbsp;I’ve&nbsp;cut&nbsp;out&nbsp;several&nbsp;thousand&nbsp;lines&nbsp;to&nbsp;get&nbsp;down&nbsp;to&nbsp;something&nbsp;simple&nbsp;for&nbsp;the&nbsp;example&nbsp;test&nbsp;scripts,&nbsp;but&nbsp;I&nbsp;know&nbsp;the&nbsp;client&nbsp;is&nbsp;still&nbsp;a&nbsp;little&nbsp;long. &nbsp;Again,&nbsp;I’m&nbsp;not&nbsp;sure&nbsp;if&nbsp;attachments&nbsp;work&nbsp;on&nbsp;the&nbsp;mailing&nbsp;list,&nbsp;but&nbsp;I’ll&nbsp;attempt&nbsp;to&nbsp;attach&nbsp;the&nbsp;client/server&nbsp;scripts&nbsp;with&nbsp;the&nbsp;corresponding&nbsp;pass/fail&nbsp;logs.&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;Thanks!&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;-Chris&lt;u&gt;&lt;/u&gt;&lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;p&nbsp;class=&quot;MsoNormal&quot;&gt;&lt;u&gt;&lt;/u&gt; &lt;u&gt;&lt;/u&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;rel=&quot;noreferrer&quot;&nbsp;target=&quot;_blank&quot;&gt;https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;<br>

</tt>
