<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=windows-1252&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Aug&nbsp;9,&nbsp;2012,&nbsp;at&nbsp;7:39&nbsp;PM,&nbsp;Andrew&nbsp;Bennetts&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:andrew@bemusement.org&quot;&gt;andrew@bemusement.org&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Maxim&nbsp;Lacrima&nbsp;wrote:&lt;br&gt;[…]&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;So&nbsp;my&nbsp;conclusions&nbsp;are:&lt;br&gt;1.&nbsp;When&nbsp;I&nbsp;write&nbsp;to&nbsp;stdin&nbsp;of&nbsp;my&nbsp;script&nbsp;from&nbsp;keyboard&nbsp;then&lt;br&gt;`self.transport.write()`&nbsp;works&nbsp;as&nbsp;expected.&lt;br&gt;2.&nbsp;When&nbsp;I&nbsp;use&nbsp;pipes&nbsp;or&nbsp;redirection&nbsp;to&nbsp;my&nbsp;script&nbsp;`self.transport.write()`&lt;br&gt;doesn't&nbsp;produce&nbsp;any&nbsp;output.&lt;br&gt;3.&nbsp;If&nbsp;I&nbsp;replace&nbsp;self.transport.write()&nbsp;with&nbsp;print&nbsp;statements&nbsp;it&nbsp;works.&lt;br&gt;&lt;/blockquote&gt;&lt;br&gt;Buffering,&nbsp;perhaps?&lt;br&gt;&lt;br&gt;As&nbsp;a&nbsp;quick&nbsp;test,&nbsp;try&nbsp;adjusting&nbsp;your&nbsp;callback&nbsp;to&nbsp;loseConnection&nbsp;on&nbsp;the&nbsp;transport&lt;br&gt;after&nbsp;to&nbsp;the&nbsp;write,&nbsp;that&nbsp;should&nbsp;flush&nbsp;the&nbsp;buffers.&nbsp;&nbsp;If&nbsp;buffering&nbsp;turns&nbsp;out&nbsp;to&lt;br&gt;be&nbsp;your&nbsp;problem,&nbsp;and&nbsp;you&nbsp;really&nbsp;do&nbsp;expect&nbsp;your&nbsp;pipes&nbsp;to&nbsp;be&nbsp;at&nbsp;most&lt;br&gt;line-buffered,&nbsp;you'll&nbsp;need&nbsp;to&nbsp;arrange&nbsp;for&nbsp;the&nbsp;buffering&nbsp;on&nbsp;the&nbsp;stdin&nbsp;and&nbsp;stdout&lt;br&gt;file&nbsp;descriptors&nbsp;to&nbsp;be&nbsp;changed.&nbsp;&nbsp;I&nbsp;don't&nbsp;think&nbsp;Twisted&nbsp;has&nbsp;that&nbsp;builtin,&nbsp;so&nbsp;you&lt;br&gt;may&nbsp;need&nbsp;to&nbsp;do&nbsp;that&nbsp;before&nbsp;creating&nbsp;the&nbsp;StandardIO&nbsp;object&nbsp;using&nbsp;the&nbsp;regular&lt;br&gt;Python&nbsp;APIs.&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;It's&nbsp;not&nbsp;this&nbsp;kind&nbsp;of&nbsp;buffering&nbsp;problem.&nbsp;&nbsp;I&nbsp;was&nbsp;actually&nbsp;able&nbsp;to&nbsp;reproduce&nbsp;it&nbsp;by&nbsp;replacing&nbsp;&quot;Item.get()&quot;&nbsp;with&nbsp;a&nbsp;deferLater.&nbsp;&nbsp;(In&nbsp;the&nbsp;future,&nbsp;please&nbsp;perform&nbsp;these&nbsp;types&nbsp;of&nbsp;replacements&nbsp;yourself&nbsp;before&nbsp;posting&nbsp;your&nbsp;examples;&nbsp;it's&nbsp;much&nbsp;easier&nbsp;to&nbsp;help&nbsp;out&nbsp;with&nbsp;complete,&nbsp;runnable&nbsp;programs.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;issue&nbsp;is&nbsp;that&nbsp;twisted.internet.stdio&nbsp;considers&nbsp;your&nbsp;protocol&nbsp;to&nbsp;only&nbsp;know&nbsp;about&nbsp;one&nbsp;kind&nbsp;of&nbsp;connection&nbsp;loss:&nbsp;i.e.&nbsp;that&nbsp;your&nbsp;entire&nbsp;transport&nbsp;has&nbsp;gone&nbsp;away.&nbsp;&nbsp;So,&nbsp;when&nbsp;the&nbsp;input&nbsp;is&nbsp;closed,&nbsp;the&nbsp;output&nbsp;file&nbsp;descriptor&nbsp;is&nbsp;immediately&nbsp;closed&nbsp;as&nbsp;well.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Unfortunately&nbsp;-&nbsp;and&nbsp;I&nbsp;think&nbsp;this&nbsp;is&nbsp;a&nbsp;bug&nbsp;in&nbsp;Twisted&nbsp;-&nbsp;the&nbsp;input&nbsp;connection&nbsp;being&nbsp;lost&nbsp;causes&nbsp;the&nbsp;output&nbsp;connection&nbsp;to&nbsp;be&nbsp;immediately&nbsp;and&nbsp;somewhat&nbsp;aggressively&nbsp;closed.&nbsp;&nbsp;The&nbsp;difference&nbsp;between&nbsp;&quot;echo&quot;&nbsp;and&nbsp;typing&nbsp;interactively&nbsp;is&nbsp;that&nbsp;you&nbsp;send&nbsp;&quot;test_item_id\n&quot;,&nbsp;but&nbsp;echo&nbsp;sends&nbsp;&quot;test_item_id\n&quot;&nbsp;*EOF*.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Luckily&nbsp;you&nbsp;can&nbsp;work&nbsp;around&nbsp;this,&nbsp;by&nbsp;explicitly&nbsp;asking&nbsp;Twisted&nbsp;for&nbsp;notifications&nbsp;about&nbsp;half&nbsp;of&nbsp;the&nbsp;connection&nbsp;being&nbsp;closed.&nbsp;&nbsp;You&nbsp;do&nbsp;this&nbsp;by&nbsp;implementing&nbsp;IHalfCloseableProtocol.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Although&nbsp;Twisted&nbsp;should&nbsp;be&nbsp;better&nbsp;about&nbsp;how&nbsp;it&nbsp;handles&nbsp;shutting&nbsp;down&nbsp;stdout,&nbsp;this&nbsp;nuance&nbsp;&lt;i&gt;does&lt;/i&gt;&nbsp;reveal&nbsp;some&nbsp;logic&nbsp;that&nbsp;your&nbsp;code&nbsp;is&nbsp;missing:&nbsp;once&nbsp;your&nbsp;input&nbsp;is&nbsp;done,&nbsp;you&nbsp;don't&nbsp;have&nbsp;any&nbsp;concept&nbsp;of&nbsp;waiting&nbsp;for&nbsp;your&nbsp;&lt;i&gt;output&nbsp;&lt;/i&gt;to&nbsp;be&nbsp;done&nbsp;before&nbsp;shutting&nbsp;everything&nbsp;down.&nbsp;&nbsp;So,&nbsp;if&nbsp;you&nbsp;add&nbsp;both&nbsp;the&nbsp;IHalfCloseableProtocol&nbsp;implements&nbsp;declaration&nbsp;to&nbsp;receive&nbsp;the&nbsp;relevant&nbsp;notifications,&nbsp;and&nbsp;some&nbsp;logic&nbsp;to&nbsp;keep&nbsp;track&nbsp;of&nbsp;when&nbsp;all&nbsp;the&nbsp;output&nbsp;has&nbsp;been&nbsp;written,&nbsp;you&nbsp;can&nbsp;get&nbsp;exactly&nbsp;the&nbsp;behavior&nbsp;that&nbsp;I&nbsp;assume&nbsp;you&nbsp;want.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I've&nbsp;attached&nbsp;an&nbsp;example&nbsp;that&nbsp;does&nbsp;all&nbsp;of&nbsp;these&nbsp;things&nbsp;with&nbsp;a&nbsp;simple&nbsp;timer,&nbsp;since&nbsp;this&nbsp;is&nbsp;something&nbsp;that&nbsp;Twisted&nbsp;probably&nbsp;needs&nbsp;to&nbsp;document&nbsp;a&nbsp;bit&nbsp;better.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
