<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&gt;On&nbsp;Aug&nbsp;11,&nbsp;2014,&nbsp;at&nbsp;6:51&nbsp;AM,&nbsp;&lt;a&nbsp;href=&quot;mailto:ccx@webprojekty.cz&quot;&gt;ccx@webprojekty.cz&lt;/a&gt;&nbsp;wrote:&lt;br&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Hello,&nbsp;I've&nbsp;been&nbsp;playing&nbsp;with&nbsp;the&nbsp;new&nbsp;tubes&nbsp;that&nbsp;are&nbsp;being&nbsp;implemented:&lt;br&gt;&lt;a&nbsp;href=&quot;http://comments.gmane.org/gmane.comp.python.twisted/27248&quot;&gt;http://comments.gmane.org/gmane.comp.python.twisted/27248&lt;/a&gt;&lt;br&gt;https://twistedmatrix.com/trac/ticket/1956&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;so&nbsp;much&nbsp;for&nbsp;taking&nbsp;the&nbsp;time&nbsp;to&nbsp;play&nbsp;with&nbsp;it,&nbsp;and&nbsp;taking&nbsp;some&nbsp;time&nbsp;to&nbsp;write&nbsp;feedback.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Here&nbsp;are&nbsp;few&nbsp;things&nbsp;that&nbsp;I&nbsp;did&nbsp;with&nbsp;it.&nbsp;I&nbsp;won't&nbsp;publish&nbsp;the&nbsp;full&nbsp;code&nbsp;now,&lt;br&gt;as&nbsp;in&nbsp;it's&nbsp;current&nbsp;shape&nbsp;it&nbsp;could&nbsp;implode&nbsp;eyeballs&nbsp;of&nbsp;twisted&nbsp;devs&nbsp;and&lt;br&gt;possibly&nbsp;make&nbsp;them&nbsp;summon&nbsp;some&nbsp;of&nbsp;the&nbsp;elder&nbsp;gods,&nbsp;but&nbsp;I'll&nbsp;see&nbsp;if&nbsp;I&nbsp;can&lt;br&gt;produce&nbsp;something&nbsp;less&nbsp;vile&nbsp;as&nbsp;I&nbsp;merge&nbsp;the&nbsp;ongoing&nbsp;changes&nbsp;to&nbsp;the&nbsp;tubes&lt;br&gt;branch.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I'd&nbsp;be&nbsp;interested&nbsp;to&nbsp;see&nbsp;the&nbsp;code&nbsp;nevertheless.&nbsp;&nbsp;If&nbsp;you&nbsp;had&nbsp;to&nbsp;do&nbsp;eyeball-imploding&nbsp;antics&nbsp;to&nbsp;get&nbsp;Tubes&nbsp;to&nbsp;work&nbsp;well&nbsp;for&nbsp;your&nbsp;use-case,&nbsp;being&nbsp;able&nbsp;to&nbsp;have&nbsp;a&nbsp;look&nbsp;at&nbsp;that&nbsp;would&nbsp;help&nbsp;us&nbsp;evaluate&nbsp;whether&nbsp;those&nbsp;antics&nbsp;were&nbsp;required&nbsp;by&nbsp;the&nbsp;code,&nbsp;encouraged&nbsp;by&nbsp;misfeatures&nbsp;of&nbsp;the&nbsp;API&nbsp;design,&nbsp;or&nbsp;just&nbsp;issues&nbsp;with&nbsp;lack&nbsp;of&nbsp;documentation.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;So&nbsp;far&nbsp;I&nbsp;wrote&nbsp;relatively&nbsp;simple&nbsp;app&nbsp;that&nbsp;read&nbsp;logfiles,&nbsp;parse&nbsp;them&nbsp;and&lt;br&gt;insert&nbsp;what&nbsp;they&nbsp;got&nbsp;out&nbsp;of&nbsp;them&nbsp;into&nbsp;a&nbsp;database.&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;it's&nbsp;actually&nbsp;reading&nbsp;a&nbsp;file,&nbsp;another&nbsp;nice&nbsp;to-do&nbsp;would&nbsp;be&nbsp;an&nbsp;IFount&nbsp;provider&nbsp;that&nbsp;provides&nbsp;the&nbsp;contents&nbsp;of&nbsp;a&nbsp;file&nbsp;with&nbsp;appropriate&nbsp;flow&nbsp;control,&nbsp;and&nbsp;maybe&nbsp;a&nbsp;thread&nbsp;or&nbsp;process&nbsp;in&nbsp;the&nbsp;background&nbsp;to&nbsp;do&nbsp;the&nbsp;file&nbsp;I/O.&nbsp;&nbsp;Another&nbsp;thing&nbsp;you&nbsp;could&nbsp;contribute&nbsp;to&nbsp;the&nbsp;branch,&nbsp;possibly?&nbsp;&nbsp;:-)&nbsp;&nbsp;How&nbsp;did&nbsp;you&nbsp;implement&nbsp;this?&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;First&nbsp;issue&nbsp;that&nbsp;I've&lt;br&gt;dealt&nbsp;with&nbsp;is&nbsp;stopping&nbsp;the&nbsp;tubes.&nbsp;When&nbsp;I&nbsp;read&nbsp;the&nbsp;whole&nbsp;of&nbsp;the&nbsp;input&nbsp;I&nbsp;want&lt;br&gt;to&nbsp;wait&nbsp;until&nbsp;all&nbsp;of&nbsp;it&nbsp;was&nbsp;parsed&nbsp;(atm&nbsp;synchronous&nbsp;code,&nbsp;but&nbsp;I&nbsp;can&nbsp;imagine&lt;br&gt;eg.&nbsp;some&nbsp;expensive&nbsp;processing&nbsp;being&nbsp;done&nbsp;in&nbsp;thread&nbsp;/&nbsp;external&nbsp;process)&nbsp;and&lt;br&gt;then&nbsp;wait&nbsp;until&nbsp;it's&nbsp;commited&nbsp;to&nbsp;the&nbsp;database&nbsp;before&nbsp;shutting&nbsp;the&nbsp;reactor&lt;br&gt;down&nbsp;cleanly.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;To&nbsp;translate&nbsp;this&nbsp;into&nbsp;Tubes&nbsp;terminology,&nbsp;what&nbsp;it&nbsp;sounds&nbsp;like&nbsp;you&nbsp;want&nbsp;is&nbsp;a&nbsp;way&nbsp;for&nbsp;a&nbsp;&lt;i&gt;drain&lt;/i&gt;&nbsp;(in&nbsp;this&nbsp;case,&nbsp;the&nbsp;drain&nbsp;representing&nbsp;the&nbsp;database&nbsp;transaction)&nbsp;to&nbsp;authoritatively&nbsp;signal&nbsp;that&nbsp;it&nbsp;has&nbsp;completed&nbsp;consuming&nbsp;all&nbsp;of&nbsp;the&nbsp;inputs&nbsp;that&nbsp;it&nbsp;has&nbsp;received&nbsp;from&nbsp;its&nbsp;fount.&nbsp;&nbsp;But&nbsp;the&nbsp;only&nbsp;notification&nbsp;that&nbsp;you&nbsp;can&nbsp;get&nbsp;now&nbsp;is&nbsp;stopFlow,&nbsp;which&nbsp;just&nbsp;means&nbsp;&quot;cut&nbsp;it&nbsp;out&quot;&nbsp;and&nbsp;not&nbsp;&quot;I'm&nbsp;done&quot;&nbsp;-&nbsp;not&nbsp;to&nbsp;mention&nbsp;that&nbsp;&quot;stopFlow&quot;&nbsp;is&nbsp;unnecessary&nbsp;after&nbsp;&quot;flowStopped&quot;&nbsp;which&nbsp;makes&nbsp;it&nbsp;meaningless&nbsp;in&nbsp;the&nbsp;current&nbsp;idiom.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;As&nbsp;of&nbsp;#42908&nbsp;which&nbsp;I&nbsp;pulled&nbsp;for&nbsp;experimenting&nbsp;the&nbsp;support&nbsp;for&nbsp;passing&lt;br&gt;flowStopped(reason)&nbsp;through&nbsp;pipeline&nbsp;(or&nbsp;series&nbsp;if&nbsp;you&nbsp;want)&nbsp;was&nbsp;not&lt;br&gt;working,&nbsp;an&nbsp;issue&nbsp;with&nbsp;None&nbsp;being&nbsp;returned&nbsp;from&nbsp;stopped()&nbsp;ended&nbsp;the&lt;br&gt;processing&nbsp;prematurely,&nbsp;which&nbsp;I&nbsp;fixed&nbsp;with:&lt;br&gt;&lt;br&gt;===&nbsp;modified&nbsp;file&nbsp;'tubes7/tube.py'&lt;br&gt;---&nbsp;tubes7/tube.py&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;2014-08-01&nbsp;18:32:48&nbsp;+0000&lt;br&gt;+++&nbsp;tubes7/tube.py&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;2014-08-01&nbsp;21:20:44&nbsp;+0000&lt;br&gt;@@&nbsp;-441,6&nbsp;+446,8&nbsp;@@&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;downstream.flowStopped(f)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;iterableOrNot&nbsp;is&nbsp;None:&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._flowStoppingReason&nbsp;is&nbsp;not&nbsp;None:&lt;br&gt;+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._tfount.drain.flowStopped(self._flowStoppingReason)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self._pendingIterator&nbsp;=&nbsp;iter(iterableOrNot)&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self._tfount.drain&nbsp;is&nbsp;None:&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I'm&nbsp;not&nbsp;sure&nbsp;I&nbsp;totally&nbsp;understand&nbsp;the&nbsp;case&nbsp;that&nbsp;you're&nbsp;describing&nbsp;right&nbsp;now.&nbsp;&nbsp;Can&nbsp;you&nbsp;perhaps&nbsp;contribute&nbsp;a&nbsp;unit&nbsp;test&nbsp;which&nbsp;demonstrates&nbsp;why&nbsp;this&nbsp;line&nbsp;of&nbsp;code&nbsp;is&nbsp;necessary?&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Also&nbsp;the&nbsp;ProtocolFount&nbsp;didn't&nbsp;really&nbsp;do&nbsp;what&nbsp;it&nbsp;should,&nbsp;so&nbsp;I&nbsp;made&nbsp;it&lt;br&gt;implement&nbsp;IHalfCloseableProtocol&nbsp;and&nbsp;made&nbsp;it&nbsp;call&nbsp;flowStopped()&nbsp;accordingly.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yeah&nbsp;that&nbsp;is&nbsp;definitely&nbsp;a&nbsp;known&nbsp;issue&nbsp;on&nbsp;our&nbsp;to-do&nbsp;list.&nbsp;&nbsp;I&nbsp;think&nbsp;it's&nbsp;even&nbsp;in&nbsp;the&nbsp;notes.rst&nbsp;in&nbsp;the&nbsp;branch.&nbsp;&nbsp;Can&nbsp;we&nbsp;have&nbsp;your&nbsp;patch?&nbsp;&nbsp;(You&nbsp;wrote&nbsp;tests,&nbsp;too,&nbsp;right?&nbsp;;-))&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;One&nbsp;more&nbsp;thing&nbsp;about&nbsp;it&nbsp;I&nbsp;did&nbsp;is&nbsp;that&nbsp;I&nbsp;made&nbsp;it&nbsp;invoke&nbsp;flowStopped()&nbsp;on&nbsp;any&lt;br&gt;drain&nbsp;that&nbsp;is&nbsp;newly&nbsp;attached&nbsp;to&nbsp;it&nbsp;-&nbsp;apparently&nbsp;when&nbsp;I&nbsp;used&nbsp;the&nbsp;stdio&lt;br&gt;endpoint&nbsp;it&nbsp;managed&nbsp;to&nbsp;close&nbsp;it&nbsp;when&nbsp;reading&nbsp;from&nbsp;/dev/null&nbsp;even&nbsp;before&nbsp;I&lt;br&gt;managed&nbsp;to&nbsp;set&nbsp;up&nbsp;the&nbsp;series/pipeline.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Are&nbsp;you&nbsp;running&nbsp;into&nbsp;&lt;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/trac/ticket/7546&quot;&gt;https://twistedmatrix.com/trac/ticket/7546&lt;/a&gt;&gt;?&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;That&nbsp;still&nbsp;didn't&nbsp;make&nbsp;it&nbsp;possible&nbsp;for&nbsp;me&nbsp;to&nbsp;wait&nbsp;on&nbsp;DB&nbsp;being&nbsp;written&nbsp;to&lt;br&gt;properly.&nbsp;What&nbsp;I&nbsp;had&nbsp;to&nbsp;do&nbsp;is&nbsp;to&nbsp;implement&nbsp;CloseableDrain&nbsp;that&nbsp;has&lt;br&gt;waitDone()&nbsp;method&nbsp;that&nbsp;emits&nbsp;a&nbsp;Deferred&nbsp;that&nbsp;fires&nbsp;when&nbsp;the&nbsp;drain's&lt;br&gt;flowStopped()&nbsp;was&nbsp;called&nbsp;and&nbsp;all&nbsp;it&nbsp;should&nbsp;do&nbsp;has&nbsp;been&nbsp;done.&nbsp;This&nbsp;makes&nbsp;it&lt;br&gt;quite&nbsp;handy&nbsp;to&nbsp;use&nbsp;from&nbsp;react()-style&nbsp;setup&nbsp;since&nbsp;I&nbsp;can&nbsp;just&nbsp;return&nbsp;this&lt;br&gt;Deferred,&nbsp;or&nbsp;DeferredList&nbsp;of&nbsp;all&nbsp;ongoing&nbsp;pipelines.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;There&nbsp;are&nbsp;some&nbsp;thoughts&nbsp;I&nbsp;have&nbsp;about&nbsp;the&nbsp;database&nbsp;transaction&nbsp;thing:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;ol&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&gt;Maybe&nbsp;this&nbsp;&lt;i&gt;should&lt;/i&gt;&nbsp;be&nbsp;done&nbsp;out&nbsp;of&nbsp;band?&nbsp;&nbsp;Right&nbsp;before&nbsp;I&nbsp;read&nbsp;this&nbsp;paragraph&nbsp;I&nbsp;was&nbsp;thinking&nbsp;of&nbsp;something&nbsp;like&nbsp;this;&nbsp;a&nbsp;database&nbsp;transaction&nbsp;is&nbsp;a&nbsp;separate&nbsp;thing.&nbsp;&nbsp;The&nbsp;data&nbsp;has&nbsp;in&nbsp;fact&nbsp;flowed&nbsp;to&nbsp;the&nbsp;appropriate&nbsp;point.&lt;/li&gt;&lt;li&gt;Rather&nbsp;than&nbsp;having&nbsp;an&nbsp;&quot;I'm&nbsp;completely&nbsp;done&quot;&nbsp;notification&nbsp;as&nbsp;I&nbsp;proposed&nbsp;above,&nbsp;we&nbsp;could&nbsp;have&nbsp;an&nbsp;explicit&nbsp;notion&nbsp;of&nbsp;application-level&nbsp;acknowledgements&nbsp;of&nbsp;each&nbsp;receive(...)&nbsp;call?&lt;/li&gt;&lt;li&gt;Maybe&nbsp;those&nbsp;acknowledgements&nbsp;could&nbsp;themselves&nbsp;be&nbsp;coming&nbsp;from&nbsp;a&nbsp;Fount&nbsp;in&nbsp;the&nbsp;reverse&nbsp;direction&nbsp;of&nbsp;the&nbsp;data,&nbsp;rather&nbsp;than&nbsp;trying&nbsp;to&nbsp;put&nbsp;in&nbsp;actual&nbsp;bi-directional&nbsp;data&nbsp;flow&nbsp;into&nbsp;the&nbsp;core&nbsp;interfaces?&nbsp;&nbsp;A&nbsp;recipe&nbsp;in&nbsp;terms&nbsp;of&nbsp;the&nbsp;existing&nbsp;abstraction,&nbsp;rather&nbsp;than&nbsp;an&nbsp;extension?&nbsp;&nbsp;This&nbsp;is&nbsp;sort&nbsp;of&nbsp;how&nbsp;real&nbsp;app-level&nbsp;acknowledgements&nbsp;work:&nbsp;the&nbsp;recipient&nbsp;has&nbsp;to&nbsp;send&nbsp;its&nbsp;own&nbsp;message&nbsp;to&nbsp;indicate&nbsp;receipt&nbsp;of&nbsp;the&nbsp;message&nbsp;it&nbsp;received.&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;For&nbsp;the&nbsp;next&nbsp;pipeline&nbsp;I&nbsp;had&nbsp;one&nbsp;more&nbsp;issue:&nbsp;this&nbsp;pipeline&nbsp;can&nbsp;be&nbsp;run&nbsp;either&lt;br&gt;as&nbsp;a&nbsp;log&nbsp;reader,&nbsp;or&nbsp;as&nbsp;essential&nbsp;part&nbsp;of&nbsp;running&nbsp;program&nbsp;that&nbsp;emits&nbsp;such&lt;br&gt;logs.&nbsp;In&nbsp;the&nbsp;latter&nbsp;case&nbsp;I&nbsp;need&nbsp;to&nbsp;generate&nbsp;confirmation&nbsp;messages&nbsp;for&lt;br&gt;specific&nbsp;entries&nbsp;that&nbsp;are&nbsp;being&nbsp;inserted&nbsp;and&nbsp;send&nbsp;them&nbsp;back&nbsp;to&nbsp;the&lt;br&gt;originator,&nbsp;after&nbsp;they&nbsp;has&nbsp;been&nbsp;safely&nbsp;written&nbsp;to&nbsp;the&nbsp;DB.&nbsp;This&nbsp;I&nbsp;resolved&nbsp;by&lt;br&gt;adding&nbsp;another&nbsp;field&nbsp;into&nbsp;the&nbsp;values&nbsp;I&nbsp;pass&nbsp;into&nbsp;PostgreSQLDrain&nbsp;-&nbsp;deferred&lt;br&gt;that&nbsp;will&nbsp;be&nbsp;fired&nbsp;as&nbsp;txpostgres's&nbsp;runOperation&nbsp;finishes.&nbsp;This&nbsp;resolution&lt;br&gt;works&nbsp;pretty&nbsp;well&nbsp;but&nbsp;it&nbsp;took&nbsp;me&nbsp;quite&nbsp;a&nbsp;while&nbsp;to&nbsp;come&nbsp;up&nbsp;with&nbsp;it,&nbsp;so&nbsp;I'm&lt;br&gt;not&nbsp;sure&nbsp;if&nbsp;it's&nbsp;intuitive&nbsp;design&nbsp;pattern&nbsp;or&nbsp;if&nbsp;we&nbsp;could&nbsp;come&nbsp;up&nbsp;with&lt;br&gt;something&nbsp;better.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I'm&nbsp;glad&nbsp;I&nbsp;didn't&nbsp;read&nbsp;ahead&nbsp;in&nbsp;this&nbsp;message&nbsp;as&nbsp;I'm&nbsp;replying&nbsp;to&nbsp;it,&nbsp;because&nbsp;I&nbsp;can&nbsp;see&nbsp;that&nbsp;we're&nbsp;thinking&nbsp;along&nbsp;very&nbsp;convergent&nbsp;lines&nbsp;:-).&nbsp;&nbsp;This&nbsp;sounds&nbsp;just&nbsp;like&nbsp;the&nbsp;the&nbsp;3rd&nbsp;point&nbsp;in&nbsp;the&nbsp;proposal&nbsp;I&nbsp;was&nbsp;saying&nbsp;before:&nbsp;we&nbsp;should&nbsp;have&nbsp;a&nbsp;recipe&nbsp;present&nbsp;for&nbsp;acknowledgements&nbsp;somewhere.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Then&nbsp;I&nbsp;had&nbsp;to&nbsp;run&nbsp;both&nbsp;pipelines&nbsp;in&nbsp;parallel,&nbsp;after&nbsp;implementing&nbsp;the&nbsp;fan-in&lt;br&gt;pattern&nbsp;(fan-out&nbsp;was&nbsp;already&nbsp;done&nbsp;by&nbsp;glyph),&nbsp;I&nbsp;wrote&nbsp;this&nbsp;helper&nbsp;function:&lt;br&gt;&lt;br&gt;def&nbsp;parallel(*tubes):&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;out&nbsp;=&nbsp;Out()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;in_&nbsp;=&nbsp;In()&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;out._drain.nextFount&nbsp;=&nbsp;in_&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;tube&nbsp;in&nbsp;tubes:&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;out.newFount().flowTo(series(tube,&nbsp;in_.newDrain()))&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;in_.stop_on_empty&nbsp;=&nbsp;True&lt;br&gt;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;out.drain&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;actually&nbsp;started&nbsp;working&nbsp;on&nbsp;twisted.tubes.fan&nbsp;to&nbsp;implement&nbsp;something&nbsp;very&nbsp;much&nbsp;like&nbsp;this&nbsp;that&nbsp;we&nbsp;hadn't&nbsp;gotten&nbsp;to&nbsp;yet!&nbsp;&nbsp;David&nbsp;was&nbsp;calling&nbsp;this&nbsp;pattern&nbsp;&quot;fork/join&quot;&nbsp;and&nbsp;we&nbsp;were&nbsp;debating&nbsp;whether&nbsp;we&nbsp;needed&nbsp;infrastructure&nbsp;code&nbsp;to&nbsp;do&nbsp;this.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;The&nbsp;nextFount&nbsp;attribute&nbsp;on&nbsp;_OutDrain&nbsp;is&nbsp;what&nbsp;is&nbsp;returned&nbsp;from&nbsp;flowingFrom()&lt;br&gt;so&nbsp;this&nbsp;function&nbsp;can&nbsp;be&nbsp;used&nbsp;as&nbsp;a&nbsp;part&nbsp;of&nbsp;series.&nbsp;What&nbsp;I'm&nbsp;unsure&nbsp;about&nbsp;is&lt;br&gt;how&nbsp;to&nbsp;handle&nbsp;stopping&nbsp;of&nbsp;the&nbsp;fan-in.&nbsp;Currently&nbsp;I&nbsp;don't&nbsp;make&nbsp;it&nbsp;stop&nbsp;until&lt;br&gt;the&nbsp;stop_on_empty&nbsp;is&nbsp;set&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;That&nbsp;...&nbsp;definitely&nbsp;sounds&nbsp;kind&nbsp;of&nbsp;gross.&nbsp;&nbsp;As&nbsp;does&nbsp;actually&nbsp;setting&nbsp;the&nbsp;nextFount&nbsp;attribute&nbsp;directly&nbsp;on&nbsp;the&nbsp;fan.Out.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;(so&nbsp;I&nbsp;can&nbsp;add/remove&nbsp;things&nbsp;during&nbsp;it's&lt;br&gt;initialization)&nbsp;and&nbsp;then&nbsp;I&nbsp;make&nbsp;it&nbsp;stop&nbsp;when&nbsp;the&nbsp;last&nbsp;fount&nbsp;that's&nbsp;flowing&lt;br&gt;in&nbsp;has&nbsp;stopped&nbsp;(and&nbsp;removed&nbsp;from&nbsp;input&nbsp;founts&nbsp;set)&nbsp;and&nbsp;I&nbsp;use&nbsp;the&nbsp;reason&nbsp;it&lt;br&gt;passes&nbsp;into&nbsp;flowStopped()&nbsp;to&nbsp;propagate&nbsp;along&nbsp;to&nbsp;the&nbsp;rest&nbsp;of&nbsp;series,&lt;br&gt;effectively&nbsp;discarding&nbsp;any&nbsp;reason&nbsp;objects&nbsp;passed&nbsp;to&nbsp;all&nbsp;the&nbsp;founts&nbsp;except&lt;br&gt;the&nbsp;last&nbsp;one.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;twisted.web.client.Agent&nbsp;has&nbsp;a&nbsp;solution&nbsp;to&nbsp;this&nbsp;where&nbsp;there's&nbsp;a&nbsp;multi-failure&nbsp;object&nbsp;that&nbsp;aggregates&nbsp;multiple&nbsp;errors&nbsp;into&nbsp;one&nbsp;thing.&nbsp;&nbsp;I&nbsp;think&nbsp;we&nbsp;have&nbsp;to&nbsp;do&nbsp;something&nbsp;similar.&nbsp;&nbsp;Unfortunately&nbsp;this&nbsp;is&nbsp;a&nbsp;&lt;i&gt;very&lt;/i&gt;&nbsp;confusing&nbsp;interface&nbsp;in&nbsp;addition&nbsp;to&nbsp;being&nbsp;poorly&nbsp;documented&nbsp;and&nbsp;relies&nbsp;on&nbsp;private&nbsp;classes&nbsp;that&nbsp;expose&nbsp;ostensibly&nbsp;public&nbsp;attributes.&nbsp;&nbsp;We&nbsp;need&nbsp;to&nbsp;very&nbsp;carefully&nbsp;document&nbsp;this&nbsp;within&nbsp;fan.In.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;What&nbsp;I'll&nbsp;have&nbsp;to&nbsp;deal&nbsp;with&nbsp;is&nbsp;a&nbsp;lack&nbsp;of&nbsp;sensible&nbsp;flow&nbsp;control&nbsp;in&nbsp;some&nbsp;parts&lt;br&gt;of&nbsp;the&nbsp;code.&nbsp;For&nbsp;example&nbsp;the&nbsp;part&nbsp;that&nbsp;generates&nbsp;the&nbsp;log&nbsp;files&nbsp;should&nbsp;not&nbsp;be&lt;br&gt;stopped&nbsp;just&nbsp;because&nbsp;there's&nbsp;some&nbsp;delay&nbsp;in&nbsp;writing&nbsp;the&nbsp;logs.&nbsp;This&nbsp;made&nbsp;me&lt;br&gt;wonder&nbsp;if&nbsp;the&nbsp;flow&nbsp;control&nbsp;and&nbsp;perhaps&nbsp;processing&nbsp;confirmation&nbsp;should&nbsp;not&nbsp;be&lt;br&gt;run&nbsp;not&nbsp;as&nbsp;a&nbsp;part&nbsp;of&nbsp;the&nbsp;main&nbsp;interface&nbsp;but&nbsp;instead&nbsp;something&nbsp;that&nbsp;runs&lt;br&gt;alongside,&nbsp;where&nbsp;applicable,&nbsp;in&nbsp;the&nbsp;opposite&nbsp;direction.&nbsp;But&nbsp;I&nbsp;don't&nbsp;have&nbsp;any&lt;br&gt;specific&nbsp;API&nbsp;in&nbsp;my&nbsp;mind&nbsp;at&nbsp;the&nbsp;moment.&nbsp;On&nbsp;the&nbsp;other&nbsp;hand,&nbsp;both&nbsp;are&nbsp;perfectly&lt;br&gt;solvable&nbsp;with&nbsp;current&nbsp;design&nbsp;-&nbsp;implementing&nbsp;FIFO&nbsp;buffers&nbsp;or&nbsp;message&nbsp;droppers&lt;br&gt;for&nbsp;flow&nbsp;control&nbsp;and&nbsp;the&nbsp;above&nbsp;mentioned&nbsp;deferred&nbsp;passing&nbsp;for&nbsp;confirmations.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So,&nbsp;at&nbsp;some&nbsp;level,&nbsp;yes&nbsp;it&nbsp;&lt;i&gt;should&lt;/i&gt;&nbsp;be&nbsp;stopped&nbsp;because&nbsp;there's&nbsp;a&nbsp;delay&nbsp;in&nbsp;writing&nbsp;the&nbsp;logs.&nbsp;&nbsp;By&nbsp;which&nbsp;I&nbsp;mean&nbsp;that&nbsp;if&nbsp;you&nbsp;don't&nbsp;want&nbsp;to&nbsp;stop&nbsp;it,&nbsp;you&nbsp;have&nbsp;to&nbsp;choose&nbsp;an&nbsp;explicit,&nbsp;&lt;i&gt;finite&lt;/i&gt;&nbsp;amount&nbsp;of&nbsp;memory&nbsp;or&nbsp;disk&nbsp;to&nbsp;use&nbsp;for&nbsp;buffering.&nbsp;&nbsp;FIFO&nbsp;buffers&nbsp;and&nbsp;message&nbsp;droppers&nbsp;are&nbsp;(obviously)&nbsp;very&nbsp;important&nbsp;flow-control&nbsp;intermediaries,&nbsp;but&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;day&nbsp;you&nbsp;have&nbsp;a&nbsp;finite&nbsp;amount&nbsp;of&nbsp;resources&nbsp;and&nbsp;the&nbsp;idea&nbsp;that&nbsp;flow-control&nbsp;should&nbsp;be&nbsp;&quot;optional&quot;&nbsp;means&nbsp;that&nbsp;sometimes&nbsp;(read:&nbsp;&quot;usually&quot;)&nbsp;you&nbsp;have&nbsp;an&nbsp;infinite&nbsp;amount&nbsp;of&nbsp;RAM&nbsp;and&nbsp;disk&nbsp;and&nbsp;you're&nbsp;perfectly&nbsp;happy&nbsp;to&nbsp;put&nbsp;it&nbsp;all&nbsp;to&nbsp;work&nbsp;whenever&nbsp;you&nbsp;experience&nbsp;a&nbsp;network&nbsp;partition&nbsp;that&nbsp;stalls&nbsp;your&nbsp;TCP&nbsp;stack.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;As&nbsp;for&nbsp;data&nbsp;representation&nbsp;that&nbsp;I&nbsp;choose&nbsp;to&nbsp;pass&nbsp;between&nbsp;each&nbsp;tube&nbsp;I've&lt;br&gt;started&nbsp;with&nbsp;simple&nbsp;namedtuples&nbsp;and&nbsp;following&nbsp;that&nbsp;I've&nbsp;built&nbsp;a&nbsp;simple&lt;br&gt;&quot;datatype&quot;&nbsp;class&nbsp;somewhat&nbsp;reminiscent&nbsp;of&lt;br&gt;&lt;a&nbsp;href=&quot;https://github.com/hynek/characteristic&quot;&gt;https://github.com/hynek/characteristic&lt;/a&gt;&lt;br&gt;which&nbsp;I&nbsp;learned&nbsp;of&nbsp;few&nbsp;moments&nbsp;after&nbsp;I&nbsp;finished&nbsp;polishing&nbsp;my&nbsp;own&lt;br&gt;implementation.&nbsp;What&nbsp;I&nbsp;have&nbsp;there&nbsp;is&nbsp;added&nbsp;layer&nbsp;above&nbsp;namedtuples&nbsp;that&lt;br&gt;autogenerate&nbsp;zope&nbsp;Interfaces&nbsp;(so&nbsp;I&nbsp;can&nbsp;have&nbsp;adaptation),&nbsp;do&nbsp;field&nbsp;type&nbsp;and&lt;br&gt;value&nbsp;validation/adaptation&nbsp;and&nbsp;possibly&nbsp;(as&nbsp;a&nbsp;future&nbsp;extension)&nbsp;provide&lt;br&gt;easy&nbsp;way&nbsp;to&nbsp;make&nbsp;them&nbsp;into&nbsp;AMP&nbsp;commands&nbsp;so&nbsp;the&nbsp;series&nbsp;can&nbsp;be&nbsp;split&nbsp;into&lt;br&gt;communicating&nbsp;processes&nbsp;as&nbsp;needed.&nbsp;(What&nbsp;would&nbsp;be&nbsp;interesting&nbsp;imo&nbsp;is&lt;br&gt;something&nbsp;like&nbsp;ampoule&nbsp;for&nbsp;tubes,&nbsp;or&nbsp;perhaps&nbsp;a&nbsp;ThreadTube&nbsp;and&nbsp;SubprocessTube&lt;br&gt;for&nbsp;performing&nbsp;blocking&nbsp;operations)&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think&nbsp;it's&nbsp;likely&nbsp;we'll&nbsp;acquire&nbsp;a&nbsp;dependency&nbsp;on&nbsp;Characteristic&nbsp;sometime&nbsp;soon,&nbsp;I&nbsp;have&nbsp;promised&nbsp;to&nbsp;look&nbsp;at&nbsp;the&nbsp;issues&nbsp;on&nbsp;&lt;&lt;a&nbsp;href=&quot;https://github.com/hynek/characteristic/pull/13&quot;&gt;https://github.com/hynek/characteristic/pull/13&lt;/a&gt;&gt;&nbsp;and&nbsp;try&nbsp;to&nbsp;address&nbsp;them&nbsp;already&nbsp;:).&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Also&nbsp;maybe&nbsp;of&nbsp;note&nbsp;is&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Pipes&nbsp;in&nbsp;Async&nbsp;library&nbsp;for&nbsp;OCaml&lt;br&gt;which&nbsp;I've&nbsp;been&nbsp;examining&nbsp;lately.&nbsp;What&nbsp;they&nbsp;seem&nbsp;to&nbsp;do&nbsp;there&nbsp;is&nbsp;that&nbsp;they&lt;br&gt;push&nbsp;values&nbsp;downstream&nbsp;and&nbsp;the&nbsp;function&nbsp;called&nbsp;in&nbsp;each&nbsp;processing&nbsp;step&nbsp;may&lt;br&gt;return&nbsp;deferred&nbsp;signifying&nbsp;a&nbsp;pause&nbsp;is&nbsp;requested&nbsp;until&nbsp;this&nbsp;deferred&nbsp;is&lt;br&gt;fired.&nbsp;For&nbsp;those&nbsp;interested&nbsp;in&nbsp;the&nbsp;details&nbsp;you&nbsp;can&nbsp;refer&nbsp;to:&lt;br&gt;&lt;a&nbsp;href=&quot;https://ocaml.janestreet.com/ocaml-core/111.25.00/doc/async/#Std.Pipe&quot;&gt;https://ocaml.janestreet.com/ocaml-core/111.25.00/doc/async/#Std.Pipe&lt;/a&gt;&lt;br&gt;and&nbsp;the&nbsp;relevant&nbsp;section&nbsp;of&nbsp;Real&nbsp;World&nbsp;OCaml&nbsp;book&nbsp;(available&nbsp;online).&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Creating&nbsp;a&nbsp;token&nbsp;for&nbsp;every&nbsp;single&nbsp;call&nbsp;to&nbsp;.receive()&nbsp;makes&nbsp;life&nbsp;hard.&nbsp;&nbsp;Deferred&nbsp;could&nbsp;go&nbsp;to&nbsp;some&nbsp;trouble&nbsp;to&nbsp;be&nbsp;a&nbsp;cheaper&nbsp;token&nbsp;to&nbsp;pass&nbsp;around&nbsp;(especially&nbsp;on&nbsp;PyPy)&nbsp;but&nbsp;doing&nbsp;it&nbsp;this&nbsp;way&nbsp;is&nbsp;also&nbsp;error-prone&nbsp;as&nbsp;a&nbsp;mistaken&nbsp;error-handler&nbsp;in&nbsp;the&nbsp;Deferred&nbsp;chain&nbsp;means&nbsp;that&nbsp;the&nbsp;&lt;i&gt;default&lt;/i&gt;&nbsp;behavior&nbsp;of&nbsp;buggy&nbsp;code&nbsp;un-hooks&nbsp;your&nbsp;loop&nbsp;and&nbsp;leaves&nbsp;idle&nbsp;data&nbsp;sources&nbsp;that&nbsp;will&nbsp;never&nbsp;be&nbsp;cleaned&nbsp;up.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;(The&nbsp;fact&nbsp;that&nbsp;each&nbsp;call&nbsp;to&nbsp;.pauseFlow&nbsp;returns&nbsp;a&nbsp;token&nbsp;is&nbsp;me&nbsp;trying&nbsp;to&nbsp;rehabilitate&nbsp;myself&nbsp;from&nbsp;worrying&nbsp;about&nbsp;the&nbsp;performance&nbsp;side&nbsp;of&nbsp;this&nbsp;argument&nbsp;and&nbsp;worry&nbsp;more&nbsp;about&nbsp;the&nbsp;correctness&nbsp;/&nbsp;error-prone-ness&nbsp;part.&nbsp;&nbsp;The&nbsp;PyPy&nbsp;developers,&nbsp;especially&nbsp;Alex&nbsp;Gaynor,&nbsp;have&nbsp;almost&nbsp;convinced&nbsp;me&nbsp;that&nbsp;it&nbsp;is&nbsp;OK&nbsp;to&nbsp;malloc&nbsp;things,&nbsp;sometimes.&nbsp;&nbsp;Sometimes.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;worked&nbsp;quite&nbsp;a&nbsp;bit&nbsp;with&nbsp;the&nbsp;'Streams'&nbsp;interface&nbsp;in&nbsp;web2&nbsp;on&nbsp;Calendar&nbsp;Server,&nbsp;and&nbsp;my&nbsp;conclusion&nbsp;there&nbsp;is&nbsp;that&nbsp;while&nbsp;this&nbsp;is&nbsp;better&nbsp;than&nbsp;nothing&nbsp;(it&nbsp;was&nbsp;very&nbsp;nice&nbsp;to&nbsp;be&nbsp;able&nbsp;to&nbsp;just&nbsp;return&nbsp;a&nbsp;Stream&nbsp;rather&nbsp;than&nbsp;cobble&nbsp;together&nbsp;something&nbsp;that&nbsp;returned&nbsp;NOT_DONE_YET&nbsp;every&nbsp;time)&nbsp;it&nbsp;was&nbsp;(A)&nbsp;slow&nbsp;and&nbsp;(B)&nbsp;error&nbsp;prone.&nbsp;&nbsp;Tubes&nbsp;are&nbsp;designed&nbsp;specifically&nbsp;to&nbsp;avoid&nbsp;this&nbsp;error.&nbsp;&nbsp;Although&nbsp;you&nbsp;can&nbsp;return&nbsp;Deferreds&nbsp;internally,&nbsp;no&nbsp;consumer&nbsp;ever&nbsp;needs&nbsp;to&nbsp;write&nbsp;the&nbsp;callback-loop&nbsp;that&nbsp;calls&nbsp;.read()&nbsp;again&nbsp;from&nbsp;a&nbsp;callback&nbsp;on&nbsp;.read().&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;Looking&nbsp;forward&nbsp;to&nbsp;further&nbsp;tubes&nbsp;development&nbsp;:-)&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;As&nbsp;am&nbsp;I.&nbsp;&nbsp;Thanks&nbsp;for&nbsp;all&nbsp;the&nbsp;feedback&nbsp;and&nbsp;encouragement!&nbsp;&nbsp;This&nbsp;was&nbsp;&lt;i&gt;very&lt;/i&gt;&nbsp;useful.&nbsp;&nbsp;My&nbsp;main&nbsp;takeaway&nbsp;is&nbsp;that&nbsp;we&nbsp;definitely&nbsp;have&nbsp;some&nbsp;missing&nbsp;utility&nbsp;classes&nbsp;(file&nbsp;fount,&nbsp;FIFO&nbsp;queue,&nbsp;message&nbsp;dropper,&nbsp;fan.In,&nbsp;an&nbsp;idiom&nbsp;and&nbsp;supporting&nbsp;code&nbsp;for&nbsp;processing&nbsp;message&nbsp;acknowledgements&nbsp;at&nbsp;the&nbsp;application&nbsp;level),&nbsp;some&nbsp;bugs&nbsp;(something&nbsp;about&nbsp;flowStopped&nbsp;not&nbsp;propagating&nbsp;correctly?),&nbsp;but&nbsp;that&nbsp;the&nbsp;interfaces&nbsp;as&nbsp;they&nbsp;stand&nbsp;are&nbsp;largely&nbsp;on&nbsp;the&nbsp;right&nbsp;track.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-glyph&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
