<tt>
Hi&nbsp;All&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;A&nbsp;few&nbsp;months&nbsp;ago,&nbsp;I&nbsp;reported&nbsp;a&nbsp;bug&nbsp;about&nbsp;IOCP.&nbsp;Last&nbsp;night&nbsp;I&nbsp;spent&nbsp;several&nbsp;hours&nbsp;on&nbsp;its&nbsp;implementation&nbsp;and&nbsp;finally&nbsp;found&nbsp;out&nbsp;a&nbsp;possible&nbsp;solution&nbsp;for&nbsp;that.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;when&nbsp;sending&nbsp;some&nbsp;small&nbsp;chunks&nbsp;data&nbsp;continuously,&nbsp;the&nbsp;buffer&nbsp;will&nbsp;pile&nbsp;them&nbsp;up&nbsp;and&nbsp;send&nbsp;to&nbsp;IOCP;&nbsp;however&nbsp;there&nbsp;is&nbsp;a&nbsp;SEND_LIMIT&nbsp;(128K)&nbsp;that&nbsp;means&nbsp;only&nbsp;128K&nbsp;will&nbsp;be&nbsp;handled.&nbsp;Now&nbsp;the&nbsp;problem&nbsp;is&nbsp;when&nbsp;we&nbsp;try&nbsp;to&nbsp;trigger&nbsp;the&nbsp;next&nbsp;writing,&nbsp;IOCP&nbsp;will&nbsp;raise&nbsp;ERROR_IO_PENDING&nbsp;immediately&nbsp;and&nbsp;then&nbsp;connection&nbsp;Lost.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;So&nbsp;I&nbsp;got&nbsp;a&nbsp;idea:&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;data&nbsp;is&nbsp;larger&nbsp;than&nbsp;SEND_LIMIT,&nbsp;we&nbsp;can&nbsp;wait&nbsp;a&nbsp;little&nbsp;bit&nbsp;time&nbsp;for&nbsp;the&nbsp;next&nbsp;writing&nbsp;instead&nbsp;of&nbsp;do&nbsp;it&nbsp;immediately. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;in&nbsp;twisted\internet\iocpreactor\abstract.py&nbsp;there&nbsp;is&nbsp;a&nbsp;method&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;def&nbsp;_cbWrite(self,&nbsp;rc,&nbsp;bytes,&nbsp;evt):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;self._handleWrite(rc,&nbsp;bytes,&nbsp;evt):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.doWrite()&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;now&nbsp;I&nbsp;modified&nbsp;a&nbsp;bit,&lt;/div&gt;&lt;div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;div&gt;&lt;div&gt;def&nbsp;_cbWrite(self,&nbsp;rc,&nbsp;bytes,&nbsp;evt):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;self._handleWrite(rc,&nbsp;bytes,&nbsp;evt):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;len(evt.buff)&nbsp;&lt;&nbsp;self.SEND_LIMIT:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.doWrite()&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else:&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.reactor.callLater(0.8,self.doWrite)&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;0.8&nbsp;is&nbsp;a&nbsp;silly&nbsp;trial&nbsp;but&nbsp;I&nbsp;have&nbsp;no&nbsp;idea&nbsp;what&nbsp;is&nbsp;the&nbsp;right&nbsp;number&nbsp;for&nbsp;this&nbsp;place.&nbsp;After&nbsp;this&nbsp;modification,&nbsp;previous&nbsp;problematic&nbsp;scripts&nbsp;can&nbsp;pass.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Maybe&nbsp;the&nbsp;better&nbsp;solution&nbsp;is&nbsp;to&nbsp;find&nbsp;a&nbsp;way&nbsp;to&nbsp;poll&nbsp;the&nbsp;complete&nbsp;port&nbsp;status&nbsp;when&nbsp;read/write&nbsp;will&nbsp;be&nbsp;recovered&nbsp;from&nbsp;IO&nbsp;PENDING.&nbsp;Simply&nbsp;wait&nbsp;a&nbsp;little&nbsp;is&nbsp;risky.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Regards&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;gelin&nbsp;yan&lt;/div&gt;<br>

</tt>
