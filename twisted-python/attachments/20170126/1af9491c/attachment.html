<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Tue,&nbsp;Jan&nbsp;24,&nbsp;2017&nbsp;at&nbsp;12:48&nbsp;PM,&nbsp;Craig&nbsp;Rodrigues&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rodrigc@crodrigues.org&quot;&nbsp;target=&quot;_blank&quot;&gt;rodrigc@crodrigues.org&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;span&nbsp;class=&quot;gmail-&quot;&gt;On&nbsp;Mon,&nbsp;Jan&nbsp;23,&nbsp;2017&nbsp;at&nbsp;5:10&nbsp;PM,&nbsp;Jean-Paul&nbsp;Calderone&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:exarkun@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&gt;exarkun@twistedmatrix.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;/span&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;span&nbsp;class=&quot;gmail-m_7255707783778812175gmail-&quot;&gt;&lt;span&nbsp;class=&quot;gmail-&quot;&gt;On&nbsp;Mon,&nbsp;Jan&nbsp;23,&nbsp;2017&nbsp;at&nbsp;7:08&nbsp;PM,&nbsp;Craig&nbsp;Rodrigues&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:rodrigc@crodrigues.org&quot;&nbsp;target=&quot;_blank&quot;&gt;rodrigc@crodrigues.org&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-&quot;&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;gmail-m_7255707783778812175gmail-m_-4866087461406899210gmail-h5&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;I&nbsp;did&nbsp;some&nbsp;more&nbsp;debugging. &nbsp;The&nbsp;callstack&nbsp;is&nbsp;quite&nbsp;deep.&nbsp;:/&lt;br&gt;I&nbsp;used&nbsp;this&nbsp;command&nbsp;to&nbsp;trigger&nbsp;the&nbsp;error:&lt;br&gt;&lt;br&gt;trial&nbsp; buildbot.test.unit.test_proce&lt;wbr&gt;ss_buildrequestdistributor.Tes&lt;wbr&gt;tMaybeStartBuilds.test_slow_db&lt;br&gt;&lt;br&gt;I&nbsp;found&nbsp;in&nbsp;this&nbsp;function&nbsp;in&nbsp;buildbot&#39;s&nbsp;BuildRequestsEndpoint.get()&nbsp;function&nbsp;(&nbsp;&lt;a&nbsp;href=&quot;https://github.com/buildbot/buildbot/blob/master/master/buildbot/data/buildrequests.py#L146&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/buildbot/bu&lt;wbr&gt;ildbot/blob/master/master/buil&lt;wbr&gt;dbot/data/buildrequests.py#L14&lt;wbr&gt;6&lt;/a&gt;&nbsp;)&nbsp;there&nbsp;is&nbsp;this&nbsp;line:&lt;br&gt;&lt;br&gt;&lt;b&gt; &nbsp; &nbsp; &nbsp; &nbsp;defer.returnValue(&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[(yield&nbsp;self.db2data(br))&nbsp;for&nbsp;br&nbsp;in&nbsp;buildrequests])&lt;br&gt;&lt;/b&gt;&lt;br&gt;On&nbsp;Python&nbsp;2,&nbsp;this&nbsp;line&nbsp;returns:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt; &nbsp;an&nbsp;object&nbsp;list&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt; &nbsp;each&nbsp;list&nbsp;entry&nbsp;is&nbsp;a&nbsp;dictionary&nbsp;of&nbsp;name/value&nbsp;pairs&nbsp;that&nbsp;looks&nbsp;like:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
&lt;p&nbsp;class=&quot;gmail-m_7255707783778812175gmail-m_-4866087461406899210gmail-m_920830734858214402gmail-p1&quot;&gt;&lt;span&nbsp;class=&quot;gmail-m_7255707783778812175gmail-m_-4866087461406899210gmail-m_920830734858214402gmail-s1&quot;&gt;[{&#39;buildrequestid&#39;:&nbsp;10,&nbsp;&#39;complete&#39;:&nbsp;False,&nbsp;&#39;waited_for&#39;:&nbsp;False,&nbsp;&#39;claimed_at&#39;:&nbsp;None,&nbsp;&#39;results&#39;:&nbsp;-1,&nbsp;&#39;claimed&#39;:&nbsp;False,&nbsp;&#39;buildsetid&#39;:&nbsp;11,&nbsp;&#39;complete_at&#39;:&nbsp;None,&nbsp;&#39;submitted_at&#39;:&nbsp;datetime.datetime(1970,&nbsp;1,&nbsp;2,&nbsp;12,&nbsp;6,&nbsp;40,&nbsp;tzinfo=tzutc()),&nbsp;&#39;builderid&#39;:&nbsp;77,&nbsp;&#39;claimed_by_masterid&#39;:&nbsp;None,&nbsp;&#39;priority&#39;:&nbsp;0},&nbsp;{&#39;buildrequestid&#39;:&nbsp;11,&nbsp;&#39;complete&#39;:&nbsp;False,&nbsp;&#39;waited_for&#39;:&nbsp;False,&nbsp;&#39;claimed_at&#39;:&nbsp;None,&nbsp;&#39;results&#39;:&nbsp;-1,&nbsp;&#39;claimed&#39;:&nbsp;False,&nbsp;&#39;buildsetid&#39;:&nbsp;11,&nbsp;&#39;complete_at&#39;:&nbsp;None,&nbsp;&#39;submitted_at&#39;:&nbsp;datetime.datetime(1970,&nbsp;1,&nbsp;2,&nbsp;13,&nbsp;30,&nbsp;tzinfo=tzutc()),&nbsp;&#39;builderid&#39;:&nbsp;77,&nbsp;&#39;claimed_by_masterid&#39;:&nbsp;None,&nbsp;&#39;priority&#39;:&nbsp;0}]&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Python&nbsp;3,&nbsp;this&nbsp;returns:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt; &nbsp;an&nbsp;object &lt;generator&nbsp;object&nbsp;BuildRequestsEndpoint.get.&lt;loc&lt;wbr&gt;als&gt;.&lt;listcomp&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt; &nbsp;of&nbsp;type&nbsp;&lt;class&nbsp;&#39;generator&#39;&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/span&gt;&lt;span&nbsp;class=&quot;gmail-&quot;&gt;&lt;div&gt;Yep.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;Python&nbsp;2,&nbsp;[(yield&nbsp;self.db2data(br))&nbsp;for&nbsp;br&nbsp;in&nbsp;buildrequests]&nbsp;is&nbsp;a&nbsp;list&nbsp;comprehension. &nbsp;It&nbsp;will&nbsp;have&nbsp;len(buildrequests)&nbsp;elements&nbsp;and&nbsp;each&nbsp;will&nbsp;be&nbsp;the&nbsp;value&nbsp;sent&nbsp;back&nbsp;in&nbsp;to&nbsp;the&nbsp;generator&nbsp;via&nbsp;the&nbsp;yield&nbsp;expression.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;On&nbsp;Python&nbsp;3,&nbsp;the&nbsp;same&nbsp;expression&nbsp;is&nbsp;a&nbsp;list&nbsp;of&nbsp;one&nbsp;element&nbsp;which&nbsp;is&nbsp;a&nbsp;generator&nbsp;expression.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;form&nbsp;is&nbsp;much&nbsp;clearer,&nbsp;I&nbsp;think,&nbsp;and&nbsp;behaves&nbsp;as&nbsp;intended&nbsp;on&nbsp;both&nbsp;versions&nbsp;of&nbsp;Python:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;results&nbsp;=&nbsp;[]&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;for&nbsp;br&nbsp;in&nbsp;buildrequests:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;results.append((yield&nbsp;self.db2data(br)))&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;defer.returnValue(results)&lt;/div&gt;&lt;span&nbsp;class=&quot;gmail-m_7255707783778812175gmail-HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Wow,&nbsp;thanks! &nbsp;That&nbsp;fixed&nbsp;it. &nbsp;I&nbsp;submitted&nbsp;those&nbsp;fixes&nbsp;upstream&nbsp;to&nbsp;buildbot.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; I&#39;m&nbsp;not&nbsp;so&nbsp;familiar&nbsp;with&nbsp;generator&nbsp;expressions&nbsp;and&nbsp;Deferred&#39;s&nbsp;so&nbsp;have&nbsp;been&nbsp;playing&lt;/div&gt;&lt;div&gt;around&nbsp;with&nbsp;things&nbsp;to&nbsp;try&nbsp;to&nbsp;understand.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;went&nbsp;back&nbsp;to&nbsp;the&nbsp;problem&nbsp;code,&nbsp;and&nbsp;changed:&lt;/div&gt;&lt;span&nbsp;class=&quot;gmail-&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt; &nbsp; &nbsp; &nbsp; &nbsp;defer.returnValue(&lt;br&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;[(yield&nbsp;self.db2data(br))&nbsp;for&nbsp;br&nbsp;in&nbsp;buildrequests])&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;div&gt;to:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt; &nbsp; &nbsp; &nbsp; defer.returnValue(&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; list([&lt;/b&gt;&lt;b&gt;(yield&nbsp;self.db2data(br))&nbsp;for&nbsp;br&nbsp;in&nbsp;buildrequests])&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;and&nbsp;ran&nbsp;the&nbsp;code&nbsp;under&nbsp;Python&nbsp;3&nbsp;and&nbsp;got&nbsp;a&nbsp;return&nbsp;value&nbsp;of:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&nbsp;Deferred&nbsp;]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;instead&nbsp;of:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; [&nbsp;{......}&nbsp;]&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;where&nbsp;the&nbsp;Deferred.results&nbsp;value&nbsp;was&nbsp;the&nbsp;dictionary.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;How&nbsp;does&nbsp;Python&nbsp;2&nbsp;directly&nbsp;go&nbsp;to&nbsp;returning&nbsp;the&nbsp;dictionary&nbsp;out&nbsp;of&nbsp;the&nbsp;Deferred,&lt;/div&gt;&lt;div&gt;while&nbsp;Python&nbsp;3&nbsp;returns&nbsp;the&nbsp;Deferred&nbsp;inside&nbsp;the&nbsp;list?&nbsp; self.db2data()&nbsp;returns&nbsp;a&nbsp;Deferred.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;--&lt;/div&gt;&lt;div&gt;Craig&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;On&nbsp;the&nbsp;python-dev&nbsp;mailing&nbsp;list,&nbsp;Joe&nbsp;Jevnik&nbsp;gave&nbsp;a&nbsp;really&nbsp;excellent&nbsp;explanation&nbsp;of&nbsp;what&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;is&nbsp;going&nbsp;on&nbsp;here,&nbsp;down&nbsp;to&nbsp;the&nbsp;Python&nbsp;bytecode&nbsp;level:&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;a&nbsp;href=&quot;https://mail.python.org/pipermail/python-dev/2017-January/147244.html&quot;&gt;https://mail.python.org/pipermail/python-dev/2017-January/147244.html&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;--&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;Craig&lt;/div&gt;&lt;/div&gt;<br>

</tt>
