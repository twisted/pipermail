<tt>
&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;Dear&nbsp;List:&lt;br&gt;&lt;br&gt;I&nbsp;am&nbsp;having&nbsp;a&nbsp;heck&nbsp;of&nbsp;a&nbsp;time&nbsp;trying&nbsp;to&nbsp;figure&nbsp;out&nbsp;why&nbsp;this&nbsp;traceback&nbsp;is&nbsp;happening,&nbsp;and&nbsp;I&nbsp;was&nbsp;hoping&nbsp;that&nbsp;you&nbsp;could&nbsp;shed&nbsp;some&nbsp;light&nbsp;on&nbsp;the&nbsp;situation.&nbsp;I&nbsp;am&nbsp;sorry&nbsp;for&nbsp;bothering&nbsp;you&nbsp;with&nbsp;this&nbsp;simple&nbsp;thing,&nbsp;but&nbsp;I&nbsp;can&#39;t&nbsp;seem&nbsp;to&nbsp;figure&nbsp;it&nbsp;out!<br>
&lt;br&gt;&lt;br&gt;The&nbsp;code&nbsp;and&nbsp;traceback&nbsp;are&nbsp;below.&nbsp;The&nbsp;traceback&nbsp;only&nbsp;happens&nbsp;when&nbsp;I&nbsp;call&nbsp;&lt;/span&gt;&lt;/font&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;httprequest.writeResponse(httpresponse)&nbsp;from&nbsp;a&nbsp;callback.&nbsp;When&nbsp;the&nbsp;same&nbsp;code&nbsp;is&nbsp;called&nbsp;inline&nbsp;and&nbsp;not&nbsp;in&nbsp;a&nbsp;deferred,&nbsp;it&nbsp;works&nbsp;just&nbsp;fine.&nbsp;Even&nbsp;stranger&nbsp;is&nbsp;that&nbsp;the&nbsp;response&nbsp;is&nbsp;written&nbsp;to&nbsp;the&nbsp;client&nbsp;even&nbsp;though&nbsp;the&nbsp;traceback&nbsp;occurs.&nbsp;<br>
&lt;br&gt;&lt;br&gt;An&nbsp;explanation&nbsp;of&nbsp;what&nbsp;I&nbsp;am&nbsp;trying&nbsp;to&nbsp;do:&nbsp;&lt;br&gt;&lt;br&gt;A&nbsp;consumer&nbsp;requests&nbsp;data.&nbsp;&lt;/span&gt;&lt;/font&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;If&nbsp;there&nbsp;is&nbsp;data&nbsp;in&nbsp;the&nbsp;queue&nbsp;when&nbsp;the&nbsp;consumer&nbsp;first&nbsp;checks,&nbsp;return&nbsp;the&nbsp;result&nbsp;right&nbsp;away.&nbsp;<br>
&lt;/span&gt;&lt;/font&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;If&nbsp;there&nbsp;is&nbsp;no&nbsp;data&nbsp;present,&nbsp;return&nbsp;a&nbsp;deferred&nbsp;and&nbsp;wait.&nbsp;When&nbsp;the&nbsp;producer&nbsp;inserts&nbsp;data&nbsp;into&nbsp;the&nbsp;queue,&nbsp;check&nbsp;if&nbsp;there&nbsp;is&nbsp;a&nbsp;consumer&nbsp;waiting.&nbsp;If&nbsp;so,&nbsp;begin&nbsp;callback&nbsp;chain&nbsp;on&nbsp;consumer.&nbsp;<br>
&lt;br&gt;&lt;br&gt;The&nbsp;code&nbsp;works&nbsp;fine&nbsp;(no&nbsp;traceback)&nbsp;in&nbsp;the&nbsp;case&nbsp;where&nbsp;there&nbsp;is&nbsp;no&nbsp;deferred&nbsp;needed&nbsp;(in&nbsp;QueueCache.maybedefer).&nbsp;When&nbsp;there&nbsp;is&nbsp;a&nbsp;deferred,&nbsp;the&nbsp;traceback&nbsp;happens&nbsp;during&nbsp;the&nbsp;callback&nbsp;(in&nbsp;QueueCache.put).&nbsp;Again,&nbsp;the&nbsp;consumer&nbsp;actually&nbsp;gets&nbsp;the&nbsp;correct&nbsp;result,&nbsp;but&nbsp;the&nbsp;traceback&nbsp;still&nbsp;occurs!<br>
&lt;br&gt;&lt;br&gt;&lt;/span&gt;&lt;/font&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;Any&nbsp;ideas?&lt;/span&gt;&lt;/font&gt;&lt;br&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&gt;Thanks&nbsp;in&nbsp;advance!&lt;br&gt;&lt;br&gt;~P&nbsp;&nbsp;&nbsp;&lt;/span&gt;<br>
&lt;/font&gt;&lt;br&gt;&lt;font&nbsp;size=&quot;2&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&gt;&lt;br&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;reactor,&nbsp;defer&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
from&nbsp;twisted.web2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;import&nbsp;http,&nbsp;responsecode&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;import&nbsp;Queue&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;TIMEOUT&nbsp;=&nbsp;10&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;def&nbsp;respond(result,&nbsp;httprequest):<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;httpresponse&nbsp;=&nbsp;http.Response(responsecode.OK,&nbsp;{},&nbsp;stream=result)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;httprequest.writeResponse(httpresponse)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
class&nbsp;QueueCache(object):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.queue&nbsp;=&nbsp;{}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.defer&nbsp;=&nbsp;{}&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_data(self,&nbsp;xSig):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.get_queue(xSig).get_nowait()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;push_data(self,&nbsp;xSig,&nbsp;value):<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.get_queue(xSig).put(value)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;get_queue(self,&nbsp;xSig):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.queue[xSig]&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;KeyError:&lt;/span&gt;<br>
&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;q&nbsp;=&nbsp;Queue.Queue()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.queue[xSig]&nbsp;=&nbsp;q&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;q&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;defer_request(self,&nbsp;xSig,&nbsp;httprequest):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.defer.has_key<br>
(xSig):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;Exception(&quot;Client&nbsp;%s&nbsp;already&nbsp;has&nbsp;a&nbsp;deferred&nbsp;request!&quot;&nbsp;%(xSig))&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;timeout(deferred,&nbsp;request):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xSig&nbsp;=&nbsp;request.args[&#39;X-Signature&#39;][0]&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.defer.pop(xSig)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;KeyError:&lt;/span&gt;<br>
&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&#39;Timeout&nbsp;called&nbsp;and&nbsp;xSig&nbsp;`%s`&nbsp;was&nbsp;not&nbsp;in&nbsp;cache!&#39;&nbsp;%&nbsp;xSig&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;respond(&#39;ACK&#39;,request)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;defer.Deferred()&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d.addCallback(respond,&nbsp;httprequest)<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d.setTimeout(TIMEOUT,&nbsp;timeout,&nbsp;httprequest)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.defer[xSig]&nbsp;=&nbsp;d&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;d&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;put(self,&nbsp;data):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xSig&nbsp;=&nbsp;data[&#39;X-Signature&#39;]<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d&nbsp;=&nbsp;self.defer.pop(xSig)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d.callback(data[&#39;message&#39;])&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;KeyError:&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.push_data(xSig,data)&lt;/span&gt;<br>
&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;maybedefer(self,&nbsp;httprequest):<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xSig&nbsp;=&nbsp;httprequest.args[&#39;X-Signature&#39;][0]&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data&nbsp;=&nbsp;self.get_data(xSig)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;http.Response(&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;responsecode.OK,&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{},&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stream=data[&#39;message&#39;]&lt;/span&gt;<br>
&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;<br>
Queue.Empty:&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;self.defer_request(xSig,&nbsp;httprequest)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
-----------------------------------------------------------------------------------------------------&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;2007-09-25&nbsp;18:38:38-0700&nbsp;[-]&nbsp;Original&nbsp;exception:<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;2007-09-25&nbsp;18:38:38-0700&nbsp;[-]&nbsp;Unhandled&nbsp;Error&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\internet\defer.py&quot;,&nbsp;line&nbsp;304,&nbsp;in&nbsp;_startRunCallbacks<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\internet\defer.py&quot;,&nbsp;line&nbsp;317,&nbsp;in&nbsp;_runCallbacks<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\internet\defer.py&quot;,&nbsp;line&nbsp;281,&nbsp;in&nbsp;_continue<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\internet\defer.py&quot;,&nbsp;line&nbsp;277,&nbsp;in&nbsp;unpause<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---&nbsp;&lt;exception&nbsp;caught&nbsp;here&gt;&nbsp;---&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\internet\defer.py&quot;,&nbsp;line&nbsp;317,&nbsp;in&nbsp;_runCallbacks&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\web2\server.py&quot;,&nbsp;line&nbsp;518,&nbsp;in&nbsp;_cbFinishRender&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptions.TypeError:&nbsp;html&nbsp;is&nbsp;not&nbsp;a&nbsp;resource&nbsp;or&nbsp;a&nbsp;response&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
2007-09-25&nbsp;18:38:39-0700&nbsp;[-]&nbsp;Unhandled&nbsp;error&nbsp;in&nbsp;Deferred:&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;2007-09-25&nbsp;18:38:39-0700&nbsp;[-]&nbsp;Unhandled&nbsp;Error&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\internet\defer.py&quot;,&nbsp;line&nbsp;317,&nbsp;in&nbsp;_runCallbacks<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\web2\server.py&quot;,&nbsp;line&nbsp;476,&nbsp;in&nbsp;_processingFailed<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\internet\defer.py&quot;,&nbsp;line&nbsp;200,&nbsp;in&nbsp;addErrback<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\internet\defer.py&quot;,&nbsp;line&nbsp;182,&nbsp;in&nbsp;addCallbacks<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---&nbsp;&lt;exception&nbsp;caught&nbsp;here&gt;&nbsp;---&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\internet\defer.py&quot;,&nbsp;line&nbsp;317,&nbsp;in&nbsp;_runCallbacks&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\web2\server.py&quot;,&nbsp;line&nbsp;492,&nbsp;in&nbsp;_processingReallyFailed&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Python24\lib\site-packages\twisted\web2\http.py&quot;,&nbsp;line&nbsp;446,&nbsp;in&nbsp;writeResponse&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.chanRequest.writeHeaders(response.code,&nbsp;response.headers)&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\web2\channel\http.py&quot;,&nbsp;line&nbsp;431,&nbsp;in&nbsp;writeHeaders<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;&quot;C:\Projects\PyServer\twisted\web2\channel\http.py&quot;,&nbsp;line&nbsp;466,&nbsp;in&nbsp;_writeHeaders<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;span&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exceptions.AttributeError:&nbsp;&#39;HTTPChannelRequest&#39;&nbsp;object&nbsp;has&nbsp;no&nbsp;attribute&nbsp;&#39;transport&#39;<br>
&lt;/span&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;br&nbsp;style=&quot;font-family:&nbsp;courier&nbsp;new,monospace;&quot;&gt;&lt;/font&gt;<br>

</tt>
