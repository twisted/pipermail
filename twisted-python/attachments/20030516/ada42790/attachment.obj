--- smtp.py	Wed Apr 23 01:31:18 2003
+++ smtp.new.py	Sat May 17 10:02:02 2003
@@ -539,6 +539,9 @@
         chunk = self.mailFile.read(8192)
         if not chunk:
             self.transport.unregisterProducer()
+            if self.mailFile:
+                self.mailFile.close()
+                self.mailFile = None
             if self.lastsent != '\n':
                 line = '\r\n.'
             else:
@@ -556,7 +559,9 @@
         pass
 
     def stopProducing(self):
-        self.mailFile.close()
+        if self.mailFile:
+            self.mailFile.close()
+            self.mailFile = None
 
 
     # these methods should be overriden in subclasses
