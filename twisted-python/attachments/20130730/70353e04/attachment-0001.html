<tt>
&lt;html&gt;<br>
&lt;head&gt;<br>
&lt;style&gt;&lt;!--<br>
.hmmessage&nbsp;P<br>
{<br>
margin:0px;<br>
padding:0px<br>
}<br>
body.hmmessage<br>
{<br>
font-size:&nbsp;12pt;<br>
font-family:Î¢ÈíÑÅºÚ<br>
}<br>
--&gt;&lt;/style&gt;&lt;/head&gt;<br>
&lt;body&nbsp;class='hmmessage'&gt;&lt;div&nbsp;dir='ltr'&gt;&lt;div&gt;A&nbsp;simple&nbsp;TCP&nbsp;echo&nbsp;server&nbsp;using&nbsp;epoll&nbsp;reactor:&lt;/div&gt;&lt;div&gt;this&nbsp;server&nbsp;process&nbsp;take&nbsp;60%&nbsp;cpu&nbsp;on&nbsp;4000&nbsp;request/s.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;use&nbsp;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&nbsp;&quot;&gt;self.transport.getHandle().send&nbsp;instead&nbsp;of&nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&nbsp;&quot;&gt;self.transport.write,&lt;/span&gt;&lt;/div&gt;&lt;div&gt;it&nbsp;take&nbsp;30%&nbsp;cpu&nbsp;on&nbsp;4000&nbsp;request/s.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Why&nbsp;transport.write&nbsp;take&nbsp;more&nbsp;user&nbsp;cpu?&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&nbsp;&quot;&gt;Why&nbsp;twisted&nbsp;performance&nbsp;so&nbsp;poor?&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&nbsp;&quot;&gt;(echosvr.c&nbsp;using&nbsp;libevent&nbsp;only&nbsp;take&nbsp;12%&nbsp;cpu&nbsp;on&nbsp;4000&nbsp;request/s)&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;tsvr.py&lt;/div&gt;&lt;div&gt;-----------------------------------------------------------&lt;/div&gt;&lt;div&gt;import&nbsp;sys,&nbsp;time,&nbsp;random,&nbsp;socket,&nbsp;traceback&lt;/div&gt;&lt;div&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;epollreactor&lt;/div&gt;&lt;div&gt;epollreactor.install()&lt;/div&gt;&lt;div&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;defer,&nbsp;reactor,&nbsp;task&lt;/div&gt;&lt;div&gt;from&nbsp;twisted.internet.protocol&nbsp;import&nbsp;Protocol,&nbsp;Factory&lt;/div&gt;&lt;div&gt;from&nbsp;protocol&nbsp;import&nbsp;TCPServerProtocol&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;def&nbsp;main():&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tcpprotocol&nbsp;=&nbsp;TCPServerProtocol&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory&nbsp;=&nbsp;Factory()&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;factory.protocol&nbsp;=&nbsp;tcpprotocol&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reactor.listenTCP(9976,&nbsp;factory)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reactor.run()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;if&nbsp;__name__&nbsp;==&nbsp;'__main__':&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;main()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;protocol.py&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;font-size:&nbsp;12pt;&nbsp;&quot;&gt;---------------------------------------------------------&nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;import&nbsp;socket&lt;/div&gt;&lt;div&gt;import&nbsp;datetime&lt;/div&gt;&lt;div&gt;import&nbsp;traceback&lt;/div&gt;&lt;div&gt;from&nbsp;twisted.protocols.basic&nbsp;import&nbsp;LineReceiver&lt;/div&gt;&lt;div&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;protocol&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;class&nbsp;TCPServerProtocol(LineReceiver):&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;req_count&nbsp;=&nbsp;0&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;req_time&nbsp;=&nbsp;datetime.datetime.now()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;lineReceived(self,&nbsp;data):&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCPServerProtocol.req_count+=1&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;TCPServerProtocol.req_count%10000==0:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ct&nbsp;=&nbsp;datetime.datetime.now()&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dt&nbsp;=&nbsp;ct-TCPServerProtocol.req_time&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pps&nbsp;=&nbsp;10000/(dt.seconds+dt.microseconds/1000000.0)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TCPServerProtocol.req_time=ct&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print('RPS='+str(pps))&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#self.transport.write(data)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.getHandle().send(data)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;traceback.print_exc()&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;tcli.py&nbsp;&lt;/div&gt;&lt;div&gt;-----------------------------------------------------------------&lt;/div&gt;&lt;div&gt;import&nbsp;sys&lt;/div&gt;&lt;div&gt;import&nbsp;socket&lt;/div&gt;&lt;div&gt;import&nbsp;traceback&lt;/div&gt;&lt;div&gt;import&nbsp;time&lt;/div&gt;&lt;div&gt;import&nbsp;datetime&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;host&nbsp;=&nbsp;'localhost'&lt;/div&gt;&lt;div&gt;port&nbsp;=&nbsp;9976&lt;/div&gt;&lt;div&gt;loopcount&nbsp;=&nbsp;300&lt;/div&gt;&lt;div&gt;sockcount&nbsp;=&nbsp;5000&lt;/div&gt;&lt;div&gt;RPS&nbsp;=&nbsp;4000&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;ss=[]&lt;/div&gt;&lt;div&gt;for&nbsp;x&nbsp;in&nbsp;xrange(sockcount):&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss.append(socket.socket(socket.AF_INET,&nbsp;socket.SOCK_STREAM))&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss[x].connect((host,&nbsp;port))&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss[x].settimeout(120)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;for&nbsp;x&nbsp;in&nbsp;xrange(10000000):&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;st&nbsp;=&nbsp;datetime.datetime.now()&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;y&nbsp;in&nbsp;xrange(loopcount):&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;ss[x%sockcount]!=None:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss[x%sockcount].sendall('1234567890\r\n')&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss[x%sockcount].recv(1024)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;except:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;y&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit()&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;time.sleep(0.1)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dt&nbsp;=&nbsp;(datetime.datetime.now()-st)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;plc&nbsp;=&nbsp;loopcount/(dt.seconds+dt.microseconds/1000000.0)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;loopcount/(dt.seconds+dt.microseconds/1000000.0)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#auto&nbsp;adjust&nbsp;RPS&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;plc&lt;RPS:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;RPS-plc&gt;50:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loopcount+=10&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;plc-RPS&gt;50:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loopcount-=10&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;echosvr.c&nbsp;&lt;/div&gt;&lt;div&gt;----------------------------------------------------------------------&lt;/div&gt;&lt;div&gt;#include&nbsp;&lt;stdio.h&gt;&lt;/div&gt;&lt;div&gt;#include&nbsp;&lt;stdlib.h&gt;&lt;/div&gt;&lt;div&gt;#include&nbsp;&lt;errno.h&gt;&lt;/div&gt;&lt;div&gt;#include&nbsp;&lt;assert.h&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#include&nbsp;&lt;event2/event.h&gt;&lt;/div&gt;&lt;div&gt;#include&nbsp;&lt;event2/bufferevent.h&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#define&nbsp;LISTEN_PORT&nbsp;9976&lt;/div&gt;&lt;div&gt;#define&nbsp;LISTEN_BACKLOG&nbsp;32&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;#ifdef&nbsp;FD_SETSIZE&lt;/div&gt;&lt;div&gt;#undef&nbsp;FD_SETSIZE&lt;/div&gt;&lt;div&gt;#endif&lt;/div&gt;&lt;div&gt;#define&nbsp;FD_SETSIZE&nbsp;65536&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;void&nbsp;do_accept(evutil_socket_t&nbsp;listener,&nbsp;short&nbsp;event,&nbsp;void&nbsp;*arg);&lt;/div&gt;&lt;div&gt;void&nbsp;read_cb(struct&nbsp;bufferevent&nbsp;*bev,&nbsp;void&nbsp;*arg);&lt;/div&gt;&lt;div&gt;void&nbsp;error_cb(struct&nbsp;bufferevent&nbsp;*bev,&nbsp;short&nbsp;event,&nbsp;void&nbsp;*arg);&lt;/div&gt;&lt;div&gt;void&nbsp;write_cb(struct&nbsp;bufferevent&nbsp;*bev,&nbsp;void&nbsp;*arg);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;int&nbsp;main(int&nbsp;argc,&nbsp;char&nbsp;*argv[])&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;ret;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;evutil_socket_t&nbsp;listener;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;listener&nbsp;=&nbsp;socket(AF_INET,&nbsp;SOCK_STREAM,&nbsp;0);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;assert(listener&nbsp;&gt;&nbsp;0);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;evutil_make_listen_socket_reuseable(listener);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;sockaddr_in&nbsp;sin;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;sin.sin_family&nbsp;=&nbsp;AF_INET;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;sin.sin_addr.s_addr&nbsp;=&nbsp;0;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;sin.sin_port&nbsp;=&nbsp;htons(LISTEN_PORT);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(bind(listener,&nbsp;(struct&nbsp;sockaddr&nbsp;*)&amp;sin,&nbsp;sizeof(sin))&nbsp;&lt;&nbsp;0)&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perror(&quot;bind&quot;);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(listen(listener,&nbsp;LISTEN_BACKLOG)&nbsp;&lt;&nbsp;0)&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perror(&quot;listen&quot;);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;printf&nbsp;(&quot;Listening...\n&quot;);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;evutil_make_socket_nonblocking(listener);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;event_base&nbsp;*base&nbsp;=&nbsp;event_base_new();&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;assert(base&nbsp;!=&nbsp;NULL);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;event&nbsp;*listen_event;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;listen_event&nbsp;=&nbsp;event_new(base,&nbsp;listener,&nbsp;EV_READ|EV_PERSIST,&nbsp;do_accept,&nbsp;(void*)base);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;event_add(listen_event,&nbsp;NULL);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;event_base_dispatch(base);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;The&nbsp;End.&quot;);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;void&nbsp;do_accept(evutil_socket_t&nbsp;listener,&nbsp;short&nbsp;event,&nbsp;void&nbsp;*arg)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;event_base&nbsp;*base&nbsp;=&nbsp;(struct&nbsp;event_base&nbsp;*)arg;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;evutil_socket_t&nbsp;fd;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;sockaddr_in&nbsp;sin;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;socklen_t&nbsp;slen;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;fd&nbsp;=&nbsp;accept(listener,&nbsp;(struct&nbsp;sockaddr&nbsp;*)&amp;sin,&nbsp;&amp;slen);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fd&nbsp;&lt;&nbsp;0)&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perror(&quot;accept&quot;);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(fd&nbsp;&gt;&nbsp;FD_SETSIZE)&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perror(&quot;fd&nbsp;&gt;&nbsp;FD_SETSIZE\n&quot;);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;ACCEPT:&nbsp;fd&nbsp;=&nbsp;%u\n&quot;,&nbsp;fd);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;struct&nbsp;bufferevent&nbsp;*bev&nbsp;=&nbsp;bufferevent_socket_new(base,&nbsp;fd,&nbsp;BEV_OPT_CLOSE_ON_FREE);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;bufferevent_setcb(bev,&nbsp;read_cb,&nbsp;NULL,&nbsp;error_cb,&nbsp;arg);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;bufferevent_enable(bev,&nbsp;EV_READ|EV_WRITE|EV_PERSIST);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;void&nbsp;read_cb(struct&nbsp;bufferevent&nbsp;*bev,&nbsp;void&nbsp;*arg)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;#define&nbsp;MAX_LINE&nbsp;&nbsp;&nbsp;&nbsp;256&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;line[MAX_LINE+1];&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;n;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;evutil_socket_t&nbsp;fd&nbsp;=&nbsp;bufferevent_getfd(bev);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(n&nbsp;=&nbsp;bufferevent_read(bev,&nbsp;line,&nbsp;MAX_LINE),&nbsp;n&nbsp;&gt;&nbsp;0)&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;line[n]&nbsp;=&nbsp;'\0';&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//printf(&quot;fd=%u,&nbsp;read&nbsp;line:&nbsp;%s\n&quot;,&nbsp;fd,&nbsp;line);&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bufferevent_write(bev,&nbsp;line,&nbsp;n);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;void&nbsp;write_cb(struct&nbsp;bufferevent&nbsp;*bev,&nbsp;void&nbsp;*arg)&nbsp;{}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;void&nbsp;error_cb(struct&nbsp;bufferevent&nbsp;*bev,&nbsp;short&nbsp;event,&nbsp;void&nbsp;*arg)&lt;/div&gt;&lt;div&gt;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;evutil_socket_t&nbsp;fd&nbsp;=&nbsp;bufferevent_getfd(bev);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;fd&nbsp;=&nbsp;%u,&nbsp;&quot;,&nbsp;fd);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(event&nbsp;&amp;&nbsp;BEV_EVENT_TIMEOUT)&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Timed&nbsp;out\n&quot;);&nbsp;//if&nbsp;bufferevent_set_timeouts()&nbsp;called&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;(event&nbsp;&amp;&nbsp;BEV_EVENT_EOF)&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;connection&nbsp;closed\n&quot;);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;(event&nbsp;&amp;&nbsp;BEV_EVENT_ERROR)&nbsp;{&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;some&nbsp;other&nbsp;error\n&quot;);&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;}&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;bufferevent_free(bev);&lt;/div&gt;&lt;div&gt;}&lt;/div&gt;&lt;/div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/div&gt;&lt;/body&gt;<br>
&lt;/html&gt;
</tt>
