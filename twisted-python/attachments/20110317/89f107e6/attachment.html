<tt>
Thanks&nbsp;Drew&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Yes,&nbsp;you&nbsp;spotted&nbsp;an&nbsp;error&nbsp;in&nbsp;my&nbsp;email,&nbsp;which&nbsp;is&nbsp;not&nbsp;replicated&nbsp;in&nbsp;my&nbsp;code.&nbsp;ie&nbsp;My&nbsp;AdapterQueue&nbsp;in&nbsp;the&nbsp;code&nbsp;inherits&nbsp;from&nbsp;Service.&nbsp;It&nbsp;in&nbsp;turn&nbsp;is&nbsp;a&nbsp;service&nbsp;of&nbsp;a&nbsp;parent&nbsp;which&nbsp;&lt;i&gt;is&lt;/i&gt; a&nbsp;MultiService&nbsp;instance.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;tests&nbsp;are&nbsp;Integration&nbsp;tests,&nbsp;not&nbsp;unit&nbsp;tests,&nbsp;and&nbsp;as&nbsp;such&nbsp;run&nbsp;up&nbsp;an&nbsp;instance&nbsp;of&nbsp;our&nbsp;entire&nbsp;messaging&nbsp;gateway.&nbsp;To&nbsp;date&nbsp;we&nbsp;have&nbsp;run&nbsp;it&nbsp;up&nbsp;once&nbsp;at&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;test&nbsp;run,&nbsp;run&nbsp;all&nbsp;test&nbsp;suites,&nbsp;then&nbsp;torn&nbsp;down&nbsp;(with&nbsp;unclean&nbsp;reactor).&nbsp;The&nbsp;Integration&nbsp;tests&nbsp;have&nbsp;been&nbsp;notoriously&nbsp;brittle,&nbsp;so&nbsp;am&nbsp;hoping&nbsp;that&nbsp;tearing&nbsp;down&nbsp;the&nbsp;gateway&nbsp;after&nbsp;&lt;i&gt;each&lt;/i&gt; individual&nbsp;test&nbsp;will&nbsp;help&nbsp;with&nbsp;that.&nbsp;To&nbsp;that&nbsp;end,&nbsp;I&nbsp;have&nbsp;refactored&nbsp;the&nbsp;code&nbsp;to&nbsp;better&nbsp;utilise&nbsp;services,&nbsp;so&nbsp;that&nbsp;teardown&nbsp;(without&nbsp;just&nbsp;stopping&nbsp;the&nbsp;reactor)&nbsp;is&nbsp;possible.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;in&nbsp;the&nbsp;setUp()&nbsp;of&nbsp;each&nbsp;trial.unittest.TestCase,&nbsp;is&nbsp;a&nbsp;call&nbsp;to&nbsp;test_utils.startGateway().&nbsp;This&nbsp;returns&nbsp;the&nbsp;result&nbsp;of&nbsp;gateway_svc.startService()&nbsp;(starts&nbsp;the&nbsp;parent&nbsp;MultiService&nbsp;of&nbsp;all&nbsp;child&nbsp;services).&nbsp;Each&nbsp;of&nbsp;these&nbsp;setUp&nbsp;methods&nbsp;uses&nbsp;@inlineCallbacks&nbsp;and&nbsp;yields&nbsp;the&nbsp;deferred&nbsp;returned&nbsp;from&nbsp;this&nbsp;top-level&nbsp;startService().&lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt;@inlineCallbacks&lt;/div&gt;&lt;div&gt;def&nbsp;setUp(self):&lt;/div&gt;&lt;div&gt;  &nbsp;yield&nbsp;test_utils.startGateway()&lt;/div&gt;&lt;/div&gt;&lt;div&gt;  &nbsp;{do&nbsp;other&nbsp;set&nbsp;up}&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;By&nbsp;the&nbsp;same&nbsp;token,&nbsp;the&nbsp;tearDown()&nbsp;in&nbsp;each&nbsp;test&nbsp;class&nbsp;calls&nbsp;test_utils.tearDown(),&nbsp;which&nbsp;looks&nbsp;like:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;class&nbsp;SomeTests(TestCase):&lt;/div&gt;&lt;div&gt;&lt;div&gt;  &nbsp; def&nbsp;tearDown(self):&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; self.extra_svc.stopService()&lt;/div&gt;&lt;div&gt;  &nbsp; &nbsp; &nbsp; test_utils.tearDown()&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Haha!&nbsp;In&nbsp;writing&nbsp;this&nbsp;I&#39;ve&nbsp;realised&nbsp;what&nbsp;I&nbsp;believe&nbsp;was&nbsp;the&nbsp;problem&nbsp;(and&nbsp;my&nbsp;repeat&nbsp;testing&nbsp;just&nbsp;now&nbsp;has&nbsp;failed&nbsp;to&nbsp;show&nbsp;the&nbsp;intermittent&nbsp;failure).&nbsp;Each&nbsp;test&nbsp;class&#39;s&nbsp;tearDown()&nbsp;was&nbsp;&lt;i&gt;not&lt;/i&gt; &lt;i&gt;returning&lt;/i&gt; the&nbsp;deferred&nbsp;returned&nbsp;from&nbsp;stopService().&nbsp;Changing&nbsp;the&nbsp;final&nbsp;line&nbsp;above&nbsp;seems&nbsp;to&nbsp;solve&nbsp;the&nbsp;issue:&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;return test_utils.tearDown()&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;the&nbsp;sounding&nbsp;board,&nbsp;Drew.&lt;/div&gt;&lt;div&gt;Cheers&lt;/div&gt;&lt;div&gt;Brad&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;17&nbsp;March&nbsp;2011&nbsp;05:06,&nbsp;Drew&nbsp;Smathers&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:drew.smathers@gmail.com&quot;&gt;drew.smathers@gmail.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex;&quot;&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;On&nbsp;Tue,&nbsp;Mar&nbsp;15,&nbsp;2011&nbsp;at&nbsp;9:55&nbsp;PM,&nbsp;Brad&nbsp;Milne&lt;br&gt;<br>
&lt;&lt;a&nbsp;href=&quot;mailto:brad.milne@devx.runthered.com&quot;&gt;brad.milne@devx.runthered.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;have&nbsp;a&nbsp;series&nbsp;of&nbsp;MultiService&nbsp;objects,&nbsp;with&nbsp;child&nbsp;Services.&nbsp;Some&nbsp;of&nbsp;these&lt;br&gt;<br>
&gt;&nbsp;services&nbsp;are&nbsp;TCPServers,&nbsp;for&nbsp;example,&nbsp;and&nbsp;others&nbsp;are&nbsp;my&nbsp;own&nbsp;objects&lt;br&gt;<br>
&gt;&nbsp;(extending&nbsp;from&nbsp;Service).&lt;br&gt;<br>
&gt;&nbsp;In&nbsp;the&nbsp;instance&nbsp;that&nbsp;I&nbsp;have&nbsp;a&nbsp;Service&nbsp;which&nbsp;controls&nbsp;a&nbsp;LoopingCall,&nbsp;I&nbsp;am&lt;br&gt;<br>
&gt;&nbsp;getting&nbsp;intermittent&nbsp;&#39;unclean&nbsp;reactor&#39;&nbsp;errors&nbsp;during&nbsp;tests.&nbsp;I&nbsp;feel&nbsp;I&nbsp;might&lt;br&gt;<br>
&gt;&nbsp;be&nbsp;missing&nbsp;some&nbsp;handling&nbsp;of&nbsp;deferreds,&nbsp;perhaps.&lt;br&gt;<br>
&gt;&nbsp;(using&nbsp;8.2.0&nbsp;-&nbsp;looking&nbsp;to&nbsp;migrate&nbsp;to&nbsp;10.2.0&nbsp;soon)&lt;br&gt;<br>
&gt;&nbsp;Here&nbsp;is&nbsp;an&nbsp;example&nbsp;of&nbsp;the&nbsp;approach&nbsp;being&nbsp;used:&lt;br&gt;<br>
&gt;&nbsp;class AdapterQueue(service.MultiService):&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; def&nbsp;startService(self):&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; &nbsp; service.Service.startService(self)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; &nbsp; self._looping_controller&nbsp;=&nbsp;LoopingCall(self._action)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; &nbsp; d&nbsp;=&nbsp;self._looping_controller.start(self.delay,&nbsp;False)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; &nbsp; d.addErrback(self._errorInScheduler)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; def&nbsp;stopService(self):&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; &nbsp; service.Service.stopService(self)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; &nbsp; d&nbsp;=&nbsp;self._looping_controller.deferred&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; &nbsp; self._looping_controller.stop()&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; &nbsp; return&nbsp;d&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;I&#39;m&nbsp;not&nbsp;sure&nbsp;if&nbsp;this&nbsp;is&nbsp;part&nbsp;of&nbsp;the&nbsp;issue&nbsp;or&nbsp;not,&nbsp;but&nbsp;it&nbsp;seems&nbsp;odd&lt;br&gt;<br>
that&nbsp;you&nbsp;may&nbsp;have&nbsp;accidentally&nbsp;inherited&nbsp;from&nbsp;MultiService&nbsp;instead&nbsp;of&lt;br&gt;<br>
Service.&lt;br&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&gt;&nbsp;And&nbsp;an&nbsp;example&nbsp;error&nbsp;(happens&nbsp;about&nbsp;1/3&nbsp;of&nbsp;the&nbsp;time):&lt;br&gt;<br>
&gt;&nbsp;DirtyReactorAggregateError:&nbsp;Reactor&nbsp;was&nbsp;unclean.&lt;br&gt;<br>
&gt;&nbsp;DelayedCalls:&nbsp;(set&nbsp;twisted.internet.base.DelayedCall.debug&nbsp;=&nbsp;True&nbsp;to&nbsp;debug)&lt;br&gt;<br>
&gt;&nbsp;&lt;DelayedCall&nbsp;30800112&nbsp;[0.0189974308014s]&nbsp;called=0&nbsp;cancelled=0&lt;br&gt;<br>
&gt;&nbsp;LoopingCall&lt;0.033333333333333333&gt;(AdapterQueue._action,&nbsp;*(),&nbsp;**{})()&lt;br&gt;<br>
&gt;&nbsp;traceback&nbsp;at&nbsp;creation:&lt;br&gt;<br>
&gt;&nbsp;  File&nbsp;&quot;C:\Python26\lib\threading.py&quot;,&nbsp;line&nbsp;497,&nbsp;in&nbsp;__bootstrap&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; self.__bootstrap_inner()&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&nbsp;&quot;C:\Python26\lib\threading.py&quot;,&nbsp;line&nbsp;525,&nbsp;in&nbsp;__bootstrap_inner&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; self.run()&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&nbsp;&quot;C:\Python26\lib\threading.py&quot;,&nbsp;line&nbsp;477,&nbsp;in&nbsp;run&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; self.__target(*self.__args,&nbsp;**self.__kwargs)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&nbsp;&quot;D:\dev\eggs\nose-0.11.3-py2.6.egg\nose\twistedtools.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;57,&nbsp;in&nbsp;&lt;lambda&gt;&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; installSignalHandlers=False))&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&lt;br&gt;<br>
&gt;&nbsp;&quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\base.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;1128,&nbsp;in&nbsp;run&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; self.mainLoop()&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&lt;br&gt;<br>
&gt;&nbsp;&quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\base.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;1137,&nbsp;in&nbsp;mainLoop&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; self.runUntilCurrent()&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&lt;br&gt;<br>
&gt;&nbsp;&quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\base.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;757,&nbsp;in&nbsp;runUntilCurrent&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; call.func(*call.args,&nbsp;**&lt;a&nbsp;href=&quot;http://call.kw&quot;&nbsp;target=&quot;_blank&quot;&gt;call.kw&lt;/a&gt;)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&lt;br&gt;<br>
&gt;&nbsp;&quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\task.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;115,&nbsp;in&nbsp;__call__&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; d.addCallback(cb)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&lt;br&gt;<br>
&gt;&nbsp;&quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\defer.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;195,&nbsp;in&nbsp;addCallback&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; callbackKeywords=kw)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&lt;br&gt;<br>
&gt;&nbsp;&quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\defer.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;186,&nbsp;in&nbsp;addCallbacks&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; self._runCallbacks()&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&lt;br&gt;<br>
&gt;&nbsp;&quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\defer.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;328,&nbsp;in&nbsp;_runCallbacks&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; self.result&nbsp;=&nbsp;callback(self.result,&nbsp;*args,&nbsp;**kw)&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&lt;br&gt;<br>
&gt;&nbsp;&quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\task.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;103,&nbsp;in&nbsp;cb&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; self._reschedule()&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; &nbsp; File&lt;br&gt;<br>
&gt;&nbsp;&quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\task.py&quot;,&nbsp;line&lt;br&gt;<br>
&gt;&nbsp;139,&nbsp;in&nbsp;_reschedule&lt;br&gt;<br>
&gt;&nbsp;  &nbsp; self.call&nbsp;=&nbsp;self.clock.callLater(nextTime&nbsp;-&nbsp;currentTime,&nbsp;self)&lt;br&gt;<br>
&gt;&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;Can&nbsp;you&nbsp;post&nbsp;code&nbsp;for&nbsp;the&nbsp;test?&nbsp; This&nbsp;means&nbsp;generally&nbsp;(as&nbsp;you&lt;br&gt;<br>
suggested)&nbsp;that&nbsp;you&nbsp;haven&#39;t&nbsp;waited&nbsp;for&nbsp;all&nbsp;related&nbsp;deferreds&nbsp;to&nbsp;fire&lt;br&gt;<br>
before&nbsp;ending&nbsp;the&nbsp;test.&nbsp;Return&nbsp;the&nbsp;deferred&nbsp;returned&nbsp;by&nbsp;stopService(),&lt;br&gt;<br>
for&nbsp;example,&nbsp;and&nbsp;make&nbsp;final&nbsp;assertions&nbsp;in&nbsp;a&nbsp;callback;&nbsp;but&nbsp;I&#39;m&nbsp;guessing&lt;br&gt;<br>
you&nbsp;already&nbsp;know&nbsp;this.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
-Drew&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;target=&quot;_blank&quot;&gt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;br&gt;--&nbsp;&lt;br&gt;&lt;span&nbsp;style=&quot;font-family:arial,&nbsp;sans-serif;font-size:13px;border-collapse:collapse;color:rgb(136,&nbsp;136,&nbsp;136)&quot;&gt;Brad&nbsp;Milne&nbsp;|&nbsp;Run&nbsp;The&nbsp;Red&nbsp;| &lt;span&nbsp;style=&quot;font-family:arial,&nbsp;sans-serif;font-size:13px;white-space:nowrap&quot;&gt;&lt;b&gt;&lt;a&nbsp;href=&quot;mailto:brad.milne@devx.runthered.com&quot;&nbsp;style=&quot;color:rgb(42,&nbsp;93,&nbsp;176)&quot;&nbsp;target=&quot;_blank&quot;&gt;brad.milne@devx.runthered.com&lt;/a&gt;&lt;/b&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;<br>
<br>
&lt;/div&gt;<br>

</tt>
