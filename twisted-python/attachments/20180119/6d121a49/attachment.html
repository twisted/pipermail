<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&gt;&nbsp;Protocols&nbsp;and&nbsp;transports&nbsp;have&nbsp;a&nbsp;fairly&nbsp;defined&nbsp;lifecycle,&nbsp;and&nbsp;as&nbsp;L.&nbsp;Daniel&nbsp;Burr&nbsp;already&nbsp;pointed&nbsp;out,&nbsp;it&nbsp;would&nbsp;probably&nbsp;be&nbsp;appropriate&nbsp;to&nbsp;explicitly&nbsp;break&nbsp;these&nbsp;reference&nbsp;cycles&nbsp;in&nbsp;connectionLost.&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Explicitly&nbsp;breaking&nbsp;cycle&nbsp;in&nbsp;ProtocolWrapper.connectionLost&nbsp;by&nbsp;any&nbsp;of:&lt;/div&gt;&lt;div&gt;•&nbsp;self.wrappedProtocol&nbsp;=&nbsp;None&lt;/div&gt;&lt;div&gt;•&nbsp;self.wrappedProtocol.transport&nbsp;=&nbsp;None&lt;/div&gt;&lt;div&gt;•&nbsp;self.wrappedProtocol&nbsp;=&nbsp;weakref.proxy(self.wrappedProtocol)&lt;/div&gt;&lt;div&gt;•&nbsp;self.wrappedProtocol.transport&nbsp;=&nbsp;weakref.proxy(self)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;...&nbsp;breaks&nbsp;some&nbsp;existing&nbsp;tests&nbsp;:(&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Seems&nbsp;like&nbsp;these&nbsp;tests&nbsp;do&nbsp;some&nbsp;post-run&nbsp;checks&nbsp;against&nbsp;protocol&nbsp;instances&nbsp;and&nbsp;their&nbsp;transports.&nbsp;Not&nbsp;sure&nbsp;whether&nbsp;it&nbsp;is&nbsp;relevant&nbsp;to&nbsp;real-life&nbsp;usage.&lt;/div&gt;&lt;div&gt;Will&nbsp;investigate&nbsp;more...&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-&nbsp;Ilya&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;чт,&nbsp;18&nbsp;янв.&nbsp;2018&nbsp;г.&nbsp;в&nbsp;0:09,&nbsp;Ilya&nbsp;Skriblovsky&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:ilyaskriblovsky@gmail.com&quot;&gt;ilyaskriblovsky@gmail.com&lt;/a&gt;&gt;:&lt;br&gt;&lt;/div&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;the&nbsp;Twisted&nbsp;app&nbsp;that&nbsp;serves&nbsp;tons&nbsp;of&nbsp;short-lived&nbsp;TLS&nbsp;connections&nbsp;using&nbsp;TLSMemoryBIOFactory.&nbsp;I&nbsp;usually&nbsp;set&nbsp;loosened&nbsp;garbage&nbsp;collector&nbsp;thresholds&nbsp;in&nbsp;production&nbsp;environment&nbsp;for&nbsp;the&nbsp;sake&nbsp;of&nbsp;performance.&nbsp;But&nbsp;I&#39;ve&nbsp;noticed&nbsp;that&nbsp;this&nbsp;app&#39;s&nbsp;RAM&nbsp;usage&nbsp;quickly&nbsp;grows&nbsp;up&nbsp;to&nbsp;unreasonable&nbsp;values.&nbsp;Digging&nbsp;into&nbsp;the&nbsp;issue&nbsp;using&nbsp;pdb&nbsp;and&nbsp;objgraph&nbsp;showed&nbsp;that&nbsp;protocol&nbsp;instances&nbsp;are&nbsp;still&nbsp;living&nbsp;long&nbsp;after&nbsp;they&nbsp;were&nbsp;closed.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;found&nbsp;two&nbsp;circular&nbsp;dependencies&nbsp;which&nbsp;are&nbsp;created&nbsp;for&nbsp;each&nbsp;TLS&nbsp;connection:&lt;/div&gt;&lt;div&gt;1.&nbsp;Between&nbsp;twisted.protocols.policies.ProtocolWrapper&nbsp;and&nbsp;its&nbsp;self.wrappedProtocol&lt;/div&gt;&lt;div&gt;2.&nbsp;Between&nbsp;twisted.protocols.tls.TLSMemoryBIOProtocol&nbsp;and&nbsp;its&nbsp;self._tlsConnection&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Both&nbsp;of&nbsp;them&nbsp;cause&nbsp;protocol&nbsp;instance&nbsp;to&nbsp;not&nbsp;be&nbsp;deleted&nbsp;when&nbsp;the&nbsp;connection&nbsp;is&nbsp;closed.&nbsp;So&nbsp;all&nbsp;OpenSSL-related&nbsp;objects&nbsp;and&nbsp;all&nbsp;business-related&nbsp;data&nbsp;attached&nbsp;to&nbsp;that&nbsp;protocol&nbsp;instance&nbsp;are&nbsp;still&nbsp;living&nbsp;untill&nbsp;the&nbsp;next&nbsp;GC&nbsp;collection.&nbsp;This&nbsp;affects&nbsp;both&nbsp;RAM&nbsp;usage&nbsp;and&nbsp;performance&nbsp;(due&nbsp;to&nbsp;much&nbsp;more&nbsp;often&nbsp;GC&nbsp;collections)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;tried&nbsp;to&nbsp;fix&nbsp;both&nbsp;circular&nbsp;dependencies:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;replaced &lt;a&nbsp;href=&quot;https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/policies.py#L75&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/policies.py#L75&lt;/a&gt; by&lt;br&gt;&lt;/div&gt;&lt;div&gt;self.wrappedProtocol.makeConnection(weakref.proxy(self))&lt;br&gt;&lt;/div&gt;&lt;div&gt;and&nbsp;replaced &lt;a&nbsp;href=&quot;https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/tls.py#L199&quot;&nbsp;target=&quot;_blank&quot;&gt;https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/tls.py#L199&lt;/a&gt; by:&lt;br&gt;&lt;/div&gt;&lt;div&gt;self._tlsConnection&nbsp;=&nbsp;self.factory._createConnection(weakref.proxy(self))&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Memory&nbsp;usage&nbsp;pattern&nbsp;changed&nbsp;drastically&nbsp;after&nbsp;this&nbsp;change.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;created&nbsp;demo&nbsp;script&nbsp;that&nbsp;makes&nbsp;10k&nbsp;TLS&nbsp;loopback&nbsp;connections&nbsp;with&nbsp;GC&nbsp;disabled&nbsp;and&nbsp;measures&nbsp;the&nbsp;number&nbsp;of&nbsp;objects&nbsp;are&nbsp;still&nbsp;living&nbsp;after&nbsp;the&nbsp;work&nbsp;is&nbsp;done&nbsp;and&nbsp;total&nbsp;resident&nbsp;RAM&nbsp;consumption:&lt;/div&gt;&lt;div&gt;&lt;a&nbsp;href=&quot;https://gist.github.com/IlyaSkriblovsky/4dd3abfd5f67c64b13f1c673f56466f9&quot;&nbsp;target=&quot;_blank&quot;&gt;https://gist.github.com/IlyaSkriblovsky/4dd3abfd5f67c64b13f1c673f56466f9&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Output&nbsp;without&nbsp;the&nbsp;fix:&lt;/div&gt;&lt;div&gt;&lt;div&gt; &nbsp; &nbsp;N&nbsp;=&nbsp;10000&nbsp;,&nbsp;K&nbsp;=&nbsp;100&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;objects&nbsp;before&nbsp;50136&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;DummyServerProtocols&nbsp;still&nbsp;living&nbsp;10000&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;objects&nbsp;after&nbsp;439919&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;mem&nbsp;778&nbsp;mb&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Output&nbsp;with&nbsp;the&nbsp;fix:&lt;/div&gt;&lt;div&gt;&lt;div&gt; &nbsp; &nbsp;N&nbsp;=&nbsp;10000&nbsp;,&nbsp;K&nbsp;=&nbsp;100&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;objects&nbsp;before&nbsp;50133&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;DummyServerProtocols&nbsp;still&nbsp;living&nbsp;0&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;objects&nbsp;after&nbsp;159919&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;mem&nbsp;96&nbsp;mb&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;So&nbsp;using&nbsp;weakrefs&nbsp;makes&nbsp;all&nbsp;protocol&nbsp;instances&nbsp;and&nbsp;instances&nbsp;of&nbsp;TLSMemoryBIOProtocol&nbsp;to&nbsp;be&nbsp;deleted&nbsp;right&nbsp;after&nbsp;a&nbsp;connection&nbsp;is&nbsp;closed.&nbsp;Less&nbsp;circular-dependent&nbsp;objects&nbsp;→&nbsp;less&nbsp;GC&nbsp;invocations&nbsp;→&nbsp;better&nbsp;performance.&nbsp;And&nbsp;I&nbsp;see&nbsp;much&nbsp;nicer&nbsp;RAM&nbsp;usage&nbsp;pattern&nbsp;in&nbsp;my&nbsp;app.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;it&nbsp;possible&nbsp;to&nbsp;fix&nbsp;circular&nbsp;deps&nbsp;in&nbsp;some&nbsp;more&nbsp;clean&nbsp;way?&nbsp;Can&nbsp;this&nbsp;be&nbsp;solved&nbsp;at&nbsp;all&nbsp;while&nbsp;user&#39;s&nbsp;code&nbsp;is&nbsp;able&nbsp;to&nbsp;try&nbsp;to&nbsp;touch&nbsp;both&nbsp;sides&nbsp;of&nbsp;circular&nbsp;dep&nbsp;after&nbsp;connection&nbsp;is&nbsp;closed?&nbsp;Please&nbsp;advice&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;consideration&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Best&nbsp;regards,&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;Ilya&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
