<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;Apr&nbsp;28,&nbsp;2015,&nbsp;at&nbsp;10:55&nbsp;AM,&nbsp;Brian&nbsp;Costlow&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:brian.costlow@gmail.com&quot;&nbsp;class=&quot;&quot;&gt;brian.costlow@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;Okay,&nbsp;figured&nbsp;this&nbsp;out.&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Glad&nbsp;to&nbsp;hear&nbsp;it!&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Abstract&nbsp;of&nbsp;the&nbsp;issue:&nbsp;I&nbsp;am&nbsp;a&nbsp;dumbass.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;all&nbsp;make&nbsp;mistakes.&nbsp;&nbsp;And&nbsp;a&nbsp;lot&nbsp;of&nbsp;people&nbsp;make&nbsp;this&nbsp;specific&nbsp;one&nbsp;:-).&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;First,&nbsp;Itamar&nbsp;gets&nbsp;to&nbsp;thrash&nbsp;me&nbsp;soundly,&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;No&nbsp;need&nbsp;for&nbsp;violence!&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;as&nbsp;there&nbsp;was&nbsp;a&nbsp;bug&nbsp;in&nbsp;some&nbsp;code&nbsp;(not&nbsp;shown&nbsp;in&nbsp;my&nbsp;example)&nbsp;that&nbsp;is&nbsp;not&nbsp;properly&nbsp;tested.&nbsp;That&nbsp;code&nbsp;was&nbsp;responsible&nbsp;for&nbsp;&quot;turning&nbsp;off&quot;&nbsp;the&nbsp;protocol&nbsp;instance&nbsp;if&nbsp;&nbsp;connectionLost&nbsp;method&nbsp;was&nbsp;called,&nbsp;by&nbsp;doing&nbsp;some&nbsp;cleanup&nbsp;then&nbsp;redefining&nbsp;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&nbsp;class=&quot;&quot;&gt;check_for_send&nbsp;in&nbsp;the&nbsp;instance&nbsp;as&nbsp;a&nbsp;no-op&nbsp;to&nbsp;stop&nbsp;it&nbsp;from&nbsp;pushing&nbsp;itself&nbsp;back&nbsp;on&nbsp;the&nbsp;reactor&nbsp;loop.&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Ain't&nbsp;it&nbsp;always&nbsp;the&nbsp;way.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;always&nbsp;say&nbsp;&quot;please&nbsp;simplify&nbsp;the&nbsp;test&nbsp;case&quot;&nbsp;and&nbsp;then&nbsp;the&nbsp;asker&nbsp;always&nbsp;says&nbsp;&quot;but&nbsp;it&nbsp;only&nbsp;happens&nbsp;when&nbsp;it's&nbsp;super&nbsp;complex&quot;.&nbsp;&nbsp;The&nbsp;act&nbsp;of&nbsp;simplifying&nbsp;the&nbsp;test&nbsp;case&nbsp;itself&nbsp;often&nbsp;pinpoints&nbsp;the&nbsp;problem&nbsp;(as&nbsp;it&nbsp;appears&nbsp;to&nbsp;have&nbsp;done&nbsp;in&nbsp;your&nbsp;case).&nbsp;&nbsp;Honestly&nbsp;this&nbsp;was&nbsp;a&nbsp;pretty&nbsp;quick&nbsp;turnaround&nbsp;and&nbsp;I&nbsp;appreciate&nbsp;the&nbsp;&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Question:&nbsp;I'm&nbsp;assuming&nbsp;there's&nbsp;a&nbsp;good&nbsp;reason&nbsp;transport.write&nbsp;is&nbsp;written&nbsp;so&nbsp;it&nbsp;doesn't&nbsp;error&nbsp;and&nbsp;fails&nbsp;silently&nbsp;even&nbsp;though&nbsp;its&nbsp;underlying&nbsp;connection&nbsp;is&nbsp;not&nbsp;connected&nbsp;anymore.&nbsp;As&nbsp;part&nbsp;of&nbsp;grokking&nbsp;the&nbsp;guts&nbsp;of&nbsp;this&nbsp;thing&nbsp;I've&nbsp;been&nbsp;using&nbsp;for&nbsp;a&nbsp;decade...I'm&nbsp;curious&nbsp;to&nbsp;know&nbsp;why.&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;main&nbsp;reason&nbsp;is&nbsp;&quot;predictability&quot;.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;First,&nbsp;consider&nbsp;this&nbsp;function:&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;def&nbsp;sendSomeCommand(self):&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.write(b&quot;DO-SOMETHING\r\n&quot;)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.write(b&quot;DO-SOMETHING-ELSE\r\n&quot;)&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Simple&nbsp;enough,&nbsp;right?&nbsp;&nbsp;Sends&nbsp;two&nbsp;commands?&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;We&nbsp;could&nbsp;easily&nbsp;find&nbsp;out&nbsp;between&nbsp;the&nbsp;first&nbsp;call&nbsp;to&nbsp;write()&nbsp;and&nbsp;the&nbsp;second&nbsp;one&nbsp;that&nbsp;the&nbsp;connection&nbsp;has&nbsp;dropped.&nbsp;&nbsp;Twisted&nbsp;optimistically&nbsp;invokes&nbsp;the&nbsp;send()&nbsp;syscall&nbsp;when&nbsp;it&nbsp;can&nbsp;(if&nbsp;the&nbsp;write&nbsp;buffer&nbsp;is&nbsp;empty&nbsp;when&nbsp;write()&nbsp;is&nbsp;called).&nbsp;&nbsp;This&nbsp;means&nbsp;that&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;if&nbsp;&lt;/i&gt;the&nbsp;buffer&nbsp;happens&nbsp;to&nbsp;be&nbsp;empty&nbsp;when&nbsp;this&nbsp;method&nbsp;is&nbsp;called&nbsp;and&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;if&lt;/i&gt;&nbsp;the&nbsp;underlying&nbsp;OS&nbsp;already&nbsp;knows&nbsp;that&nbsp;the&nbsp;connection&nbsp;is&nbsp;closed,&nbsp;we&nbsp;might&nbsp;be&nbsp;able&nbsp;to&nbsp;invoke&nbsp;connectionLost&nbsp;between&nbsp;the&nbsp;first&nbsp;and&nbsp;second&nbsp;write()&nbsp;invocation.&nbsp;&nbsp;Since&nbsp;you&nbsp;can&nbsp;never&nbsp;really&nbsp;know&nbsp;whether&nbsp;those&nbsp;invocations&nbsp;are&nbsp;happening&nbsp;in&nbsp;isolation&nbsp;or&nbsp;together,&nbsp;this&nbsp;apparently&nbsp;simple&nbsp;function&nbsp;needs&nbsp;to&nbsp;turn&nbsp;into&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;def&nbsp;sendSomeCommand(self):&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;self.transport.disconnected:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.write(b&quot;DO-SOMETHING\r\n&quot;)&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;not&nbsp;self.transport.disconnected:&lt;/div&gt;&lt;div&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.write(b&quot;DO-SOMETHING-ELSE\r\n&quot;)&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Also,&nbsp;if&nbsp;we&nbsp;were&nbsp;to&nbsp;aggressively&nbsp;report&nbsp;errors&nbsp;like&nbsp;this,&nbsp;users&nbsp;of&nbsp;Twisted&nbsp;might&nbsp;get&nbsp;the&nbsp;impression&nbsp;that&nbsp;a&nbsp;successful&nbsp;return&nbsp;from&nbsp;write()&nbsp;means&nbsp;that&nbsp;the&nbsp;bytes&nbsp;were&nbsp;actually&nbsp;sent.&nbsp;&nbsp;What&nbsp;does&nbsp;&quot;actually&nbsp;sent&quot;&nbsp;mean?&nbsp;&nbsp;This&nbsp;is&nbsp;a&nbsp;surprisingly&nbsp;complicated&nbsp;question&nbsp;with&nbsp;a&nbsp;correspondingly&nbsp;complicated&nbsp;answer.&nbsp;&nbsp;Sent&nbsp;to&nbsp;the&nbsp;ethernet&nbsp;card?&nbsp;To&nbsp;the&nbsp;local&nbsp;network?&nbsp;Acknowledged&nbsp;by&nbsp;the&nbsp;router&nbsp;on&nbsp;the&nbsp;other&nbsp;side?&nbsp;By&nbsp;the&nbsp;kernel&nbsp;of&nbsp;the&nbsp;OS&nbsp;on&nbsp;the&nbsp;other&nbsp;side?&nbsp;By&nbsp;the&nbsp;application&nbsp;container&nbsp;on&nbsp;the&nbsp;other&nbsp;side?&nbsp;And&nbsp;so&nbsp;on&nbsp;and&nbsp;so&nbsp;forth.&nbsp;&nbsp;Since&nbsp;you&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;already&lt;/i&gt;&nbsp;have&nbsp;no&nbsp;idea&nbsp;exactly&nbsp;where&nbsp;in&nbsp;your&nbsp;stream&nbsp;of&nbsp;write()&nbsp;calls&nbsp;the&nbsp;other&nbsp;side's&nbsp;idea&nbsp;of&nbsp;the&nbsp;stream&nbsp;has&nbsp;terminated&nbsp;unless&nbsp;you&nbsp;have&nbsp;application-level&nbsp;acknowledgement,&nbsp;forcing&nbsp;users&nbsp;to&nbsp;handle&nbsp;exceptions&nbsp;for&nbsp;the&nbsp;case&nbsp;where&nbsp;it&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;definitely&lt;/i&gt;&nbsp;wasn't&nbsp;received,&nbsp;while&nbsp;still&nbsp;not&nbsp;giving&nbsp;them&nbsp;any&nbsp;indication&nbsp;that&nbsp;it&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;might&lt;/i&gt;&nbsp;not&nbsp;have&nbsp;been&nbsp;received,&nbsp;is&nbsp;a&nbsp;misleading&nbsp;and&nbsp;inconvenient&nbsp;API.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;So&nbsp;if&nbsp;you&nbsp;want&nbsp;to&nbsp;stop&nbsp;sending&nbsp;data&nbsp;to&nbsp;a&nbsp;transport&nbsp;that&nbsp;you&nbsp;have&nbsp;been&nbsp;notified&nbsp;about&nbsp;in&nbsp;connectionLost,&nbsp;just&nbsp;stop&nbsp;calling&nbsp;write()&nbsp;:).&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Hopefully&nbsp;this&nbsp;sheds&nbsp;some&nbsp;light&nbsp;onto&nbsp;transport.write's&nbsp;design.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;-glyph&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
