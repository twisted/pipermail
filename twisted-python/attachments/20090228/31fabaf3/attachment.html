<tt>
&lt;html&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;Hi&nbsp;all,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;&nbsp;am&nbsp;writing&nbsp;a&nbsp;restful&nbsp;twisted&nbsp;(8.1.0)&nbsp;server&nbsp;and&nbsp;am&nbsp;trying&nbsp;to&nbsp;return&nbsp;useful&nbsp;error&nbsp;statuses&nbsp;from&nbsp;requests.&nbsp;The&nbsp;problem&nbsp;is&nbsp;that&nbsp;even&nbsp;following&nbsp;the&nbsp;documentation&nbsp;extremely&nbsp;carefully&nbsp;I&nbsp;am&nbsp;getting&nbsp;an&nbsp;AlreadyCalled&nbsp;Error&nbsp;every&nbsp;time&nbsp;I&nbsp;generate&nbsp;a&nbsp;failure.&nbsp;Here&nbsp;is&nbsp;my&nbsp;main&nbsp;class&nbsp;(leaving&nbsp;out&nbsp;code&nbsp;that&nbsp;I&nbsp;feel&nbsp;is&nbsp;not&nbsp;relevant&nbsp;to&nbsp;the&nbsp;question:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;b&gt;from&nbsp;xml.dom&nbsp;import&nbsp;minidom&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;from&nbsp;twisted.web&nbsp;import&nbsp;server,&nbsp;resource&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;from&nbsp;FWGException&nbsp;import&nbsp;FWGException&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;class&nbsp;DeferredPostHandler(resource.Resource,minidom.Document):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;NOT_IMPLEMENTED&nbsp;=&nbsp;501&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;BAD_REQUEST&nbsp;=&nbsp;400&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;class=&quot;Apple-tab-span&quot;&nbsp;style=&quot;white-space:pre&quot;&gt;&lt;b&gt;&nbsp;&nbsp;&lt;/b&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;writeError(self,&nbsp;failure,&nbsp;request,&nbsp;*args,&nbsp;**kw):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failure.trap(FWGException)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.setResponseCode(self.errorCode)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.write(&quot;Error&nbsp;handling&nbsp;request:&nbsp;%s&quot;&nbsp;%&nbsp;failure.getErrorMessage())&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.finish()&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;writeResult(self,&nbsp;result,&nbsp;request,&nbsp;*args,&nbsp;**kw):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.writexml(request)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request.finish()&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;render_GET(self,&nbsp;request):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.process=self.db.runInteraction(self.processForm,request)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.process.addCallbacks(self.writeResult,&nbsp;self.writeError,&nbsp;[request],&nbsp;{},&nbsp;[request],&nbsp;{})&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;server.NOT_DONE_YET&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;a&nbsp;handler&nbsp;that&nbsp;extends&nbsp;this&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;from&nbsp;DeferredPostHandler&nbsp;import&nbsp;DeferredPostHandler&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;b&gt;from&nbsp;twisted.web&nbsp;import&nbsp;http&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;from&nbsp;twisted.python.failure&nbsp;import&nbsp;Failure&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;from&nbsp;FWGException&nbsp;import&nbsp;FWGException&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;class&nbsp;CollectionAdminHandler(DeferredPostHandler):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;task,&nbsp;db,&nbsp;config):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DeferredPostHandler.__init__(self,db)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.config&nbsp;=&nbsp;config&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.task&nbsp;=&nbsp;task&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.errorCode&nbsp;=&nbsp;http.OK&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;processForm(self,&nbsp;cursor,&nbsp;request):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.task&nbsp;==&nbsp;'add':&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.addCollection(cursor,&nbsp;request)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;self.task&nbsp;==&nbsp;'delete':&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.deleteCollection(cursor,&nbsp;request)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.errorCode&nbsp;=&nbsp;DeferredPostHandler.NOT_IMPLEMENTED&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail&nbsp;=&nbsp;Failure(FWGException(&quot;Unsupported&nbsp;Task&quot;))&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.process.errback(fail)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;addCollection(self,&nbsp;cursor,&nbsp;request):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail&nbsp;=&nbsp;None&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;self.isValidAddRequest(request):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.errorCode&nbsp;=&nbsp;DeferredPostHandler.BAD_REQUEST&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail&nbsp;=&nbsp;Failure(FWGException(&quot;Missing&nbsp;Parameter&quot;))&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;fail:&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.process.errback(fail);&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;deleteCollection(self,&nbsp;cursor,&nbsp;request):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;'Delete&nbsp;Collection'&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;isValidAddRequest(self,&nbsp;request):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;'title'&nbsp;in&nbsp;request.args&nbsp;and&nbsp;'category'&nbsp;in&nbsp;request.args&nbsp;and&nbsp;'date'&nbsp;in&nbsp;request.args&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Unfortunately&nbsp;whenever&nbsp;I&nbsp;call&nbsp;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;self.process.errback(fail)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;get&nbsp;the&nbsp;following&nbsp;stack&nbsp;trace&nbsp;in&nbsp;my&nbsp;log&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;&lt;b&gt;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;File&nbsp;&quot;startserver.py&quot;,&nbsp;line&nbsp;23,&nbsp;in&nbsp;&lt;module&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;reactor.run()&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;File&nbsp;&quot;/Library/Python/2.5/site-packages/Twisted-8.1.0-py2.5-macosx-10.5-i386.egg/twisted/internet/base.py&quot;,&nbsp;line&nbsp;1048,&nbsp;in&nbsp;run&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;self.mainLoop()&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;File&nbsp;&quot;/Library/Python/2.5/site-packages/Twisted-8.1.0-py2.5-macosx-10.5-i386.egg/twisted/internet/base.py&quot;,&nbsp;line&nbsp;1057,&nbsp;in&nbsp;mainLoop&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;self.runUntilCurrent()&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;---&nbsp;&lt;exception&nbsp;caught&nbsp;here&gt;&nbsp;---&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;File&nbsp;&quot;/Library/Python/2.5/site-packages/Twisted-8.1.0-py2.5-macosx-10.5-i386.egg/twisted/internet/base.py&quot;,&nbsp;line&nbsp;677,&nbsp;in&nbsp;runUntilCurrent&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;f(*a,&nbsp;**kw)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;File&nbsp;&quot;/Library/Python/2.5/site-packages/Twisted-8.1.0-py2.5-macosx-10.5-i386.egg/twisted/internet/defer.py&quot;,&nbsp;line&nbsp;243,&nbsp;in&nbsp;callback&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;self._startRunCallbacks(result)&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;File&nbsp;&quot;/Library/Python/2.5/site-packages/Twisted-8.1.0-py2.5-macosx-10.5-i386.egg/twisted/internet/defer.py&quot;,&nbsp;line&nbsp;298,&nbsp;in&nbsp;_startRunCallbacks&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&nbsp;&nbsp;&nbsp;&nbsp;raise&nbsp;AlreadyCalledError&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;twisted.internet.defer.AlreadyCalledError:&nbsp;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;can&nbsp;not&nbsp;understand&nbsp;why&nbsp;this&nbsp;is&nbsp;happening&nbsp;:-(&nbsp;Can&nbsp;anybody&nbsp;help?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;BTW&nbsp;I&nbsp;am&nbsp;using&nbsp;POST&nbsp;instead&nbsp;of&nbsp;PUT&nbsp;because&nbsp;my&nbsp;client&nbsp;can't&nbsp;do&nbsp;PUT&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Conrad&nbsp;Winchester&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
