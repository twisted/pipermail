<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html&nbsp;charset=utf-8&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;Nov&nbsp;19,&nbsp;2015,&nbsp;at&nbsp;3:50&nbsp;AM,&nbsp;Cory&nbsp;Benfield&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:cory@lukasa.co.uk&quot;&nbsp;class=&quot;&quot;&gt;cory@lukasa.co.uk&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;On&nbsp;18&nbsp;Nov&nbsp;2015,&nbsp;at&nbsp;12:18,&nbsp;Glyph&nbsp;Lefkowitz&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:glyph@twistedmatrix.com&quot;&nbsp;class=&quot;&quot;&gt;glyph@twistedmatrix.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Sorry&nbsp;about&nbsp;the&nbsp;delay&nbsp;in&nbsp;responding&nbsp;to&nbsp;this,&nbsp;but&nbsp;I&nbsp;wanted&nbsp;to&nbsp;make&nbsp;sure&nbsp;I&nbsp;knew&nbsp;at&nbsp;least&nbsp;a&nbsp;bit&nbsp;about&nbsp;what&nbsp;I&nbsp;was&nbsp;talking&nbsp;about&nbsp;before&nbsp;I&nbsp;responded!&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Clearly&nbsp;this&nbsp;is&nbsp;a&nbsp;challenging&nbsp;topic&nbsp;that&nbsp;requires&nbsp;lots&nbsp;of&nbsp;thought&nbsp;on&nbsp;the&nbsp;part&nbsp;of&nbsp;each&nbsp;interlocutor,&nbsp;and&nbsp;may&nbsp;require&nbsp;long&nbsp;rounds&nbsp;of&nbsp;consideration&nbsp;before&nbsp;each&nbsp;reply.&nbsp;&nbsp;No&nbsp;need&nbsp;to&nbsp;apologize.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;What&nbsp;do&nbsp;people&nbsp;think&nbsp;of&nbsp;this&nbsp;approach?&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;So&nbsp;I&nbsp;think&nbsp;you're&nbsp;roughly&nbsp;on&nbsp;the&nbsp;right&nbsp;track&nbsp;but&nbsp;there&nbsp;are&nbsp;probably&nbsp;some&nbsp;Twisted-level&nbsp;gaps&nbsp;to&nbsp;fill&nbsp;in.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;I've&nbsp;already&nbsp;gestured&nbsp;in&nbsp;the&nbsp;direction&nbsp;of&nbsp;Tubes&nbsp;(as&nbsp;have&nbsp;others)&nbsp;and&nbsp;it's&nbsp;something&nbsp;to&nbsp;think&nbsp;about.&nbsp;&nbsp;But&nbsp;before&nbsp;we&nbsp;get&nbsp;to&nbsp;that,&nbsp;let's&nbsp;talk&nbsp;about&nbsp;a&nbsp;much&nbsp;more&nbsp;basic&nbsp;deficiency&nbsp;in&nbsp;the&nbsp;API:&nbsp;although&nbsp;there's&nbsp;an&nbsp;&quot;IRequest&quot;,&nbsp;and&nbsp;an&nbsp;&quot;IResource&quot;,&nbsp;there's&nbsp;no&nbsp;such&nbsp;thing&nbsp;as&nbsp;an&nbsp;&quot;IResponse&quot;.&nbsp;&nbsp;Instead,&nbsp;&quot;IRequest&quot;&nbsp;stands&nbsp;in&nbsp;for&nbsp;both&nbsp;the&nbsp;request&nbsp;and&nbsp;the&nbsp;response,&nbsp;because&nbsp;you&nbsp;write&nbsp;directly&nbsp;to&nbsp;a&nbsp;request&nbsp;(implicitly&nbsp;filling&nbsp;out&nbsp;its&nbsp;response&nbsp;as&nbsp;you&nbsp;do&nbsp;so).&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;So,&nbsp;I&nbsp;think&nbsp;in&nbsp;general&nbsp;this&nbsp;is&nbsp;interesting.&nbsp;One&nbsp;of&nbsp;the&nbsp;big&nbsp;difficulties&nbsp;I’m&nbsp;having&nbsp;right&nbsp;now&nbsp;is&nbsp;that&nbsp;I’m&nbsp;trying&nbsp;to&nbsp;combine&nbsp;this&nbsp;“streaming&nbsp;HTTP”&nbsp;work&nbsp;with&nbsp;the&nbsp;implementation&nbsp;of&nbsp;HTTP/2,&nbsp;which&nbsp;means&nbsp;that&nbsp;I&nbsp;need&nbsp;to&nbsp;keep&nbsp;the&nbsp;HTTP/2&nbsp;work&nbsp;in&nbsp;mind&nbsp;whenever&nbsp;I&nbsp;talk&nbsp;about&nbsp;this&nbsp;*and*&nbsp;update&nbsp;the&nbsp;HTTP/2&nbsp;design&nbsp;in&nbsp;response&nbsp;to&nbsp;decisions&nbsp;we&nbsp;make&nbsp;here.&nbsp;This&nbsp;means&nbsp;I’ve&nbsp;got&nbsp;quite&nbsp;a&nbsp;lot&nbsp;of&nbsp;balls&nbsp;in&nbsp;the&nbsp;air&nbsp;right&nbsp;now,&nbsp;and&nbsp;I&nbsp;am&nbsp;confident&nbsp;I’ll&nbsp;drop&nbsp;quite&nbsp;a&nbsp;few.&nbsp;One&nbsp;thing&nbsp;I’m&nbsp;deliberately&nbsp;not&nbsp;doing&nbsp;here&nbsp;is&nbsp;considering&nbsp;Tubes,&nbsp;in&nbsp;part&nbsp;because&nbsp;I’m&nbsp;extremely&nbsp;concerned&nbsp;about&nbsp;backward&nbsp;compatibility,&nbsp;and&nbsp;want&nbsp;the&nbsp;HTTP/2&nbsp;work&nbsp;to&nbsp;function&nbsp;in&nbsp;the&nbsp;same&nbsp;environment.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Unfortunately,&nbsp;this&nbsp;means&nbsp;this&nbsp;conversation&nbsp;is&nbsp;blending&nbsp;into&nbsp;the&nbsp;HTTP/2&nbsp;one,&nbsp;so&nbsp;I’m&nbsp;going&nbsp;to&nbsp;hijack&nbsp;this&nbsp;thread&nbsp;and&nbsp;bring&nbsp;in&nbsp;some&nbsp;concrete&nbsp;discussion&nbsp;of&nbsp;what&nbsp;I’m&nbsp;working&nbsp;on&nbsp;with&nbsp;the&nbsp;HTTP/2&nbsp;stuff.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Hijack&nbsp;away.&nbsp;&nbsp;I&nbsp;think&nbsp;we&nbsp;should&nbsp;be&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;primarily&lt;/i&gt;&nbsp;concerned&nbsp;with&nbsp;getting&nbsp;HTTP/2&nbsp;integrated&nbsp;for&nbsp;the&nbsp;moment.&nbsp;&nbsp;The&nbsp;reason&nbsp;this&nbsp;raises&nbsp;so&nbsp;many&nbsp;concerns&nbsp;related&nbsp;to&nbsp;the&nbsp;streaming&nbsp;stuff&nbsp;is&nbsp;that&nbsp;the&nbsp;internal&nbsp;implementation&nbsp;of&nbsp;HTTP/2&nbsp;ought&nbsp;to&nbsp;be&nbsp;more&nbsp;amenable&nbsp;to&nbsp;pulling&nbsp;apart&nbsp;to&nbsp;fit&nbsp;into&nbsp;an&nbsp;actually&nbsp;good&nbsp;interface&nbsp;to&nbsp;the&nbsp;HTTP&nbsp;protocol.&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;think&nbsp;that&nbsp;twisted._threads&nbsp;points&nbsp;in&nbsp;a&nbsp;promising&nbsp;direction&nbsp;for&nbsp;this&nbsp;sort&nbsp;of&nbsp;work:&nbsp;let's&nbsp;make&nbsp;the&nbsp;old,&nbsp;crappy&nbsp;HTTP&nbsp;APIs&nbsp;work&nbsp;as-is,&nbsp;but&nbsp;with&nbsp;a&nbsp;new,&nbsp;private&nbsp;implementation&nbsp;that&nbsp;is&nbsp;better-factored&nbsp;but&nbsp;not&nbsp;fully&nbsp;documented.&nbsp;&nbsp;We&nbsp;have&nbsp;the&nbsp;old&nbsp;interface&nbsp;as&nbsp;a&nbsp;proof-of-concept,&nbsp;so&nbsp;the&nbsp;new&nbsp;stuff&nbsp;needs&nbsp;to&nbsp;at&nbsp;least&nbsp;be&nbsp;good&nbsp;enough&nbsp;to&nbsp;be&nbsp;an&nbsp;internal&nbsp;implementation&nbsp;detail&nbsp;for&nbsp;that;&nbsp;we&nbsp;don't&nbsp;have&nbsp;to&nbsp;commit&nbsp;to&nbsp;a&nbsp;new&nbsp;public&nbsp;API&nbsp;to&nbsp;land&nbsp;it,&nbsp;and&nbsp;hopefully&nbsp;with&nbsp;some&nbsp;minor&nbsp;edits&nbsp;we&nbsp;can&nbsp;just&nbsp;make&nbsp;it&nbsp;public&nbsp;as&nbsp;the&nbsp;&quot;good&quot;&nbsp;interface&nbsp;(and&nbsp;then&nbsp;backport&nbsp;HTTP/1.1&nbsp;over&nbsp;it,&nbsp;since&nbsp;we&nbsp;will&nbsp;probably&nbsp;be&nbsp;dealing&nbsp;with&nbsp;legacy&nbsp;HTTP/1.1&nbsp;clients&nbsp;and&nbsp;servers&nbsp;until&nbsp;we're&nbsp;all&nbsp;dead).&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;I&nbsp;was&nbsp;having&nbsp;a&nbsp;conversation&nbsp;about&nbsp;the&nbsp;HTTP/2&nbsp;architecture&nbsp;on&nbsp;#twisted-dev&nbsp;yesterday,&nbsp;which&nbsp;has&nbsp;led&nbsp;towards&nbsp;my&nbsp;current&nbsp;working&nbsp;approach&nbsp;for&nbsp;HTTP/2,&nbsp;which&nbsp;will&nbsp;be&nbsp;to&nbsp;have&nbsp;two&nbsp;underlying&nbsp;objects.&nbsp;We’ll&nbsp;have&nbsp;H2Connection,&nbsp;which&nbsp;implements&nbsp;IProtocol,&nbsp;and&nbsp;H2Stream,&nbsp;which&nbsp;implements&nbsp;ITransport.&nbsp;These&nbsp;two&nbsp;objects&nbsp;will&nbsp;be&nbsp;*extremely*&nbsp;tightly&nbsp;coupled:&nbsp;H2Stream&nbsp;cannot&nbsp;meaningfully&nbsp;run&nbsp;over&nbsp;an&nbsp;arbitrary&nbsp;transport&nbsp;mechanism,&nbsp;and&nbsp;knows&nbsp;a&nbsp;great&nbsp;deal&nbsp;about&nbsp;how&nbsp;H2Connections&nbsp;work.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;seems&nbsp;good,&nbsp;except&nbsp;for&nbsp;the&nbsp;&quot;extreme&quot;&nbsp;tight&nbsp;coupling.&nbsp;&nbsp;IProtocol&nbsp;and&nbsp;ITransport&nbsp;aren't&nbsp;that&nbsp;tightly&nbsp;coupled.&nbsp;&nbsp;Why&nbsp;do&nbsp;H2Stream&nbsp;and&nbsp;H2Connection&nbsp;need&nbsp;to&nbsp;be?&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;The&nbsp;reason&nbsp;we&nbsp;need&nbsp;to&nbsp;take&nbsp;this&nbsp;approach&nbsp;is&nbsp;because&nbsp;IConsumer&nbsp;doesn’t&nbsp;allow&nbsp;for&nbsp;us&nbsp;to&nbsp;have&nbsp;correlators,&nbsp;so&nbsp;even&nbsp;if&nbsp;we&nbsp;only&nbsp;had&nbsp;H2Connection&nbsp;it&nbsp;wouldn’t&nbsp;be&nbsp;able&nbsp;to&nbsp;identify&nbsp;a&nbsp;given&nbsp;producer&nbsp;with&nbsp;the&nbsp;stream&nbsp;it&nbsp;holds.&nbsp;By&nbsp;extension,&nbsp;IConsumer&nbsp;cannot&nbsp;consume&nbsp;multiple&nbsp;producers&nbsp;at&nbsp;once.&nbsp;For&nbsp;this&nbsp;reason,&nbsp;we&nbsp;need&nbsp;an&nbsp;interface&nbsp;between&nbsp;H2Connection&nbsp;and&nbsp;H2Stream&nbsp;that&nbsp;is&nbsp;similar&nbsp;to&nbsp;ITransport&nbsp;and&nbsp;IConsumer,&nbsp;but&nbsp;more&nbsp;featureful.&nbsp;Basically,&nbsp;H2Stream&nbsp;is&nbsp;a&nbsp;thin&nbsp;shim&nbsp;between&nbsp;a&nbsp;producer&nbsp;and&nbsp;H2Connection&nbsp;that&nbsp;adds&nbsp;a&nbsp;stream&nbsp;ID&nbsp;to&nbsp;a&nbsp;few&nbsp;function&nbsp;calls.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;is&nbsp;basically&nbsp;a&nbsp;good&nbsp;pattern.&nbsp;&nbsp;It&nbsp;exposes&nbsp;a&nbsp;hard-to-screw-up&nbsp;interface&nbsp;to&nbsp;the&nbsp;next&nbsp;layer&nbsp;up,&nbsp;because&nbsp;you&nbsp;can't&nbsp;forget&nbsp;to&nbsp;include&nbsp;a&nbsp;(mandatory)&nbsp;stream&nbsp;ID.&nbsp;&nbsp;I've&nbsp;implemented&nbsp;several&nbsp;multiplexing&nbsp;things&nbsp;that&nbsp;work&nbsp;more&nbsp;or&nbsp;less&nbsp;like&nbsp;this.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Luckily&nbsp;we&nbsp;have&nbsp;an&nbsp;existing&nbsp;interface&nbsp;that&nbsp;might&nbsp;point&nbsp;the&nbsp;way&nbsp;to&nbsp;a&nbsp;better&nbsp;solution,&nbsp;both&nbsp;for&nbsp;requests&nbsp;and&nbsp;responses:&nbsp;specifically,&nbsp;the&nbsp;client&nbsp;IResponse:&nbsp;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/documents/15.4.0/api/twisted.web.iweb.IResponse.html&quot;&nbsp;class=&quot;&quot;&gt;https://twistedmatrix.com/documents/15.4.0/api/twisted.web.iweb.IResponse.html&lt;/a&gt;.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;This&nbsp;interface&nbsp;is&nbsp;actually&nbsp;pretty&nbsp;close&nbsp;to&nbsp;what&nbsp;we&nbsp;want&nbsp;for&nbsp;a&nbsp;server&nbsp;IResponse&nbsp;as&nbsp;well.&nbsp;&nbsp;Perhaps&nbsp;even&nbsp;identical.&nbsp;&nbsp;Its&nbsp;static&nbsp;data&nbsp;is&nbsp;all&nbsp;exposed&nbsp;as&nbsp;attributes&nbsp;which&nbsp;can&nbsp;be&nbsp;relatively&nbsp;simply&nbsp;inspected,&nbsp;and&nbsp;the&nbsp;way&nbsp;it&nbsp;delivers&nbsp;a&nbsp;streaming&nbsp;response&nbsp;is&nbsp;that&nbsp;it&nbsp;delivers&nbsp;its&nbsp;body&nbsp;to&nbsp;an&nbsp;IProtocol&nbsp;implementation&nbsp;(via&nbsp;.deliverBody(aProtocol)).&nbsp;&nbsp;This&nbsp;is&nbsp;not&nbsp;quite&nbsp;as&nbsp;graceful&nbsp;as&nbsp;having&nbsp;a&nbsp;.bodyFount()&nbsp;method&nbsp;that&nbsp;returns&nbsp;an&nbsp;IFount&nbsp;from&nbsp;the&nbsp;tubes&nbsp;package;&nbsp;however,&nbsp;the&nbsp;tubes&nbsp;package&nbsp;is&nbsp;still&nbsp;not&nbsp;exactly&nbsp;mature&nbsp;software,&nbsp;so&nbsp;we&nbsp;may&nbsp;not&nbsp;want&nbsp;to&nbsp;block&nbsp;on&nbsp;depending&nbsp;on&nbsp;it.&nbsp;&nbsp;Importantly&nbsp;though,&nbsp;this&nbsp;delivers&nbsp;all&nbsp;the&nbsp;events&nbsp;you&nbsp;need&nbsp;as&nbsp;a&nbsp;primitive&nbsp;for&nbsp;interfacing&nbsp;with&nbsp;such&nbsp;a&nbsp;high-level&nbsp;interface;&nbsp;it&nbsp;would&nbsp;definitely&nbsp;be&nbsp;better&nbsp;to&nbsp;add&nbsp;this&nbsp;sort&nbsp;of&nbsp;interface&nbsp;Real&nbsp;Soon&nbsp;Now,&nbsp;because&nbsp;then&nbsp;the&nbsp;tubes&nbsp;package&nbsp;could&nbsp;simply&nbsp;have&nbsp;a&nbsp;method,&nbsp;responseToFount&nbsp;(which&nbsp;it&nbsp;will&nbsp;need&nbsp;anyway&nbsp;to&nbsp;work&nbsp;with&nbsp;Agent)&nbsp;that&nbsp;calls&nbsp;deliverBody&nbsp;internally.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;This&nbsp;works&nbsp;as&nbsp;a&nbsp;primitive&nbsp;because&nbsp;you&nbsp;have&nbsp;all&nbsp;the&nbsp;hooks&nbsp;you&nbsp;need&nbsp;for&nbsp;flow-control.&nbsp;&nbsp;This&nbsp;protocol&nbsp;receives,&nbsp;to&nbsp;its&nbsp;'makeConnection'&nbsp;method,&nbsp;an&nbsp;ITransport&nbsp;which&nbsp;can&nbsp;provide&nbsp;the&nbsp;IProducer&nbsp;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IProducer.html&quot;&nbsp;class=&quot;&quot;&gt;https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IProducer.html&lt;/a&gt;&nbsp;and&nbsp;IConsumer&nbsp;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IConsumer.html&quot;&nbsp;class=&quot;&quot;&gt;https://twistedmatrix.com/documents/15.4.0/api/twisted.internet.interfaces.IConsumer.html&lt;/a&gt;&nbsp;interfaces&nbsp;for&nbsp;flow-control.&nbsp;&nbsp;It&nbsp;receives&nbsp;dataReceived&nbsp;to&nbsp;tell&nbsp;it&nbsp;a&nbsp;chunk&nbsp;has&nbsp;arrived&nbsp;and&nbsp;connectionLost&nbsp;to&nbsp;tell&nbsp;it&nbsp;the&nbsp;stream&nbsp;has&nbsp;terminated.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Just&nbsp;let&nbsp;me&nbsp;clarify&nbsp;how&nbsp;this&nbsp;is&nbsp;expected&nbsp;to&nbsp;work.&nbsp;Somewhere&nbsp;we&nbsp;have&nbsp;a&nbsp;t.w.s.Site,&nbsp;which&nbsp;builds&nbsp;some&nbsp;kind&nbsp;of&nbsp;HTTP&nbsp;protocol&nbsp;(currently&nbsp;HTTPChannel,&nbsp;in&nbsp;future&nbsp;some&nbsp;object&nbsp;that&nbsp;can&nbsp;transparently&nbsp;swap&nbsp;between&nbsp;HTTPChannel&nbsp;and&nbsp;H2Connection)&nbsp;when&nbsp;connections&nbsp;are&nbsp;received.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Another&nbsp;option&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;could&lt;/i&gt;&nbsp;also&nbsp;be&nbsp;having&nbsp;a&nbsp;t.w.s.NewSite&nbsp;(with&nbsp;that&nbsp;name&nbsp;hopefully&nbsp;obviously&nbsp;being&nbsp;a&nbsp;straw&nbsp;man)&nbsp;so&nbsp;that&nbsp;Site&nbsp;can&nbsp;simply&nbsp;be&nbsp;deprecated&nbsp;in&nbsp;favor&nbsp;of&nbsp;the&nbsp;new&nbsp;thing.&nbsp;&nbsp;Making&nbsp;Site&nbsp;itself&nbsp;be&nbsp;able&nbsp;to&nbsp;accommodate&nbsp;the&nbsp;new&nbsp;stuff&nbsp;would&nbsp;be&nbsp;nice&nbsp;but&nbsp;is&nbsp;definitely&nbsp;not&nbsp;mandatory.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;These&nbsp;two&nbsp;protocols&nbsp;each&nbsp;build&nbsp;an&nbsp;IGoodRequest,&nbsp;which&nbsp;is&nbsp;very&nbsp;similar&nbsp;to&nbsp;IRequest&nbsp;but&nbsp;has&nbsp;a&nbsp;deliverBody&nbsp;method.&nbsp;The&nbsp;consumer&nbsp;of&nbsp;this&nbsp;(whether&nbsp;IResource&nbsp;or&nbsp;some&nbsp;other&nbsp;thing).&nbsp;These&nbsp;objects,&nbsp;if&nbsp;they&nbsp;want&nbsp;to&nbsp;consume&nbsp;a&nbsp;stream,&nbsp;register&nbsp;a&nbsp;protocol&nbsp;via&nbsp;deliverBody.&nbsp;At&nbsp;this&nbsp;point,&nbsp;H2Connection&nbsp;(via&nbsp;H2Stream)&nbsp;provides&nbsp;itself&nbsp;as&nbsp;the&nbsp;transport&nbsp;to&nbsp;that&nbsp;protocol,&nbsp;and&nbsp;calls&nbsp;deliverBody&nbsp;when&nbsp;chunks&nbsp;of&nbsp;data&nbsp;are&nbsp;received.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;sounds&nbsp;great.&nbsp;&nbsp;One&nbsp;thing&nbsp;to&nbsp;maybe&nbsp;watch&nbsp;out&nbsp;for:&nbsp;what&nbsp;if&nbsp;nobody&nbsp;calls&nbsp;deliverBody?&nbsp;&nbsp;This&nbsp;can&nbsp;sometimes&nbsp;be&nbsp;a&nbsp;little&nbsp;annoying&nbsp;in&nbsp;client&nbsp;code,&nbsp;to&nbsp;debug&nbsp;why&nbsp;a&nbsp;channel&nbsp;is&nbsp;never&nbsp;closed.&nbsp;&nbsp;Having&nbsp;a&nbsp;nice&nbsp;error&nbsp;in&nbsp;this&nbsp;case&nbsp;would&nbsp;be&nbsp;a&nbsp;cherry&nbsp;on&nbsp;top.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;When&nbsp;the&nbsp;object&nbsp;receiving&nbsp;the&nbsp;request&nbsp;is&nbsp;ready&nbsp;to&nbsp;send&nbsp;a&nbsp;response,&nbsp;it&nbsp;calls…something&nbsp;(sendResponse?)&nbsp;and&nbsp;provides&nbsp;an&nbsp;object&nbsp;implementing&nbsp;a&nbsp;server&nbsp;IResponse.&nbsp;The&nbsp;code&nbsp;in&nbsp;the&nbsp;H2Stream/H2Connection&nbsp;sends&nbsp;the&nbsp;headers,&nbsp;then&nbsp;calls&nbsp;deliverBody&nbsp;on&nbsp;the&nbsp;IResponse,&nbsp;passing&nbsp;H2Connection&nbsp;(again&nbsp;via&nbsp;H2Stream)&nbsp;as&nbsp;the&nbsp;protocol&nbsp;that&nbsp;gets&nbsp;called.&nbsp;In&nbsp;this&nbsp;world,&nbsp;H2Stream&nbsp;actually&nbsp;would&nbsp;need&nbsp;to&nbsp;implement&nbsp;IProtocol&nbsp;as&nbsp;well&nbsp;as&nbsp;ITransport.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;minor&nbsp;bit&nbsp;of&nbsp;critique&nbsp;here:&nbsp;the&nbsp;&lt;a&nbsp;href=&quot;https://en.wikipedia.org/wiki/Single_responsibility_principle&quot;&nbsp;class=&quot;&quot;&gt;Single&nbsp;Responsibility&nbsp;Principle&lt;/a&gt;&nbsp;dictates&nbsp;that&nbsp;we&nbsp;ought&nbsp;not&nbsp;to&nbsp;have&nbsp;H2Stream&nbsp;literally&nbsp;implement&nbsp;both&nbsp;IProtocol&nbsp;and&nbsp;ITransport;&nbsp;rather,&nbsp;we&nbsp;should&nbsp;have&nbsp;an&nbsp;_H2StreamProtocol&nbsp;and&nbsp;an&nbsp;_H2StreamTransport,&nbsp;since&nbsp;the&nbsp;thing&nbsp;talking&nbsp;to&nbsp;the&nbsp;IProtocol&nbsp;implementation&nbsp;really&nbsp;ought&nbsp;to&nbsp;be&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;wholly&nbsp;distinct&lt;/i&gt;&nbsp;from&nbsp;the&nbsp;thing&nbsp;talking&nbsp;to&nbsp;the&nbsp;ITransport&nbsp;implementation,&nbsp;and&nbsp;this&nbsp;kind&nbsp;of&nbsp;duality&nbsp;makes&nbsp;it&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;very&lt;/i&gt;&nbsp;easy&nbsp;for&nbsp;users&nbsp;-&nbsp;especially&nbsp;programmers&nbsp;new&nbsp;to&nbsp;Twisted&nbsp;-&nbsp;to&nbsp;get&nbsp;confused.&nbsp;&nbsp;As&nbsp;Nathaniel&nbsp;Manista&nbsp;and&nbsp;Augie&nbsp;Fackler&nbsp;put&nbsp;it&nbsp;in&nbsp;&lt;a&nbsp;href=&quot;https://www.youtube.com/watch?v=3MNVP9-hglc&quot;&nbsp;class=&quot;&quot;&gt;The&nbsp;Talk&lt;/a&gt;,&nbsp;we&nbsp;want&nbsp;to&nbsp;express&nbsp;ourselves&nbsp;&quot;structurally&quot;,&nbsp;if&nbsp;you&nbsp;only&nbsp;want&nbsp;application&nbsp;code&nbsp;to&nbsp;talk&nbsp;to&nbsp;the&nbsp;transport&nbsp;implementation&nbsp;and&nbsp;it's&nbsp;an&nbsp;error&nbsp;to&nbsp;talk&nbsp;to&nbsp;the&nbsp;protocol&nbsp;implementation,&nbsp;pass&nbsp;only&nbsp;the&nbsp;transport&nbsp;implementation.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Is&nbsp;my&nbsp;understand&nbsp;of&nbsp;that&nbsp;correct?&nbsp;If&nbsp;so,&nbsp;I&nbsp;think&nbsp;this&nbsp;design&nbsp;can&nbsp;work:&nbsp;essentially,&nbsp;H2Stream&nbsp;becomes&nbsp;the&nbsp;weird&nbsp;intermediary&nbsp;layer&nbsp;that&nbsp;appears&nbsp;as&nbsp;both&nbsp;a&nbsp;transport&nbsp;and&nbsp;a&nbsp;protocol&nbsp;to&nbsp;the&nbsp;request/response&nbsp;layer.&nbsp;Underneath&nbsp;the&nbsp;covers&nbsp;it&nbsp;mostly&nbsp;delegates&nbsp;to&nbsp;H2Connection,&nbsp;which&nbsp;implements&nbsp;a&nbsp;slightly&nbsp;weirdo&nbsp;version&nbsp;of&nbsp;IConsumer&nbsp;(and&nbsp;in&nbsp;fact&nbsp;IProducer)&nbsp;that&nbsp;can&nbsp;only&nbsp;be&nbsp;consumed&nbsp;by&nbsp;H2Stream.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;don't&nbsp;quite&nbsp;get&nbsp;why&nbsp;it&nbsp;needs&nbsp;to&nbsp;be&nbsp;slightly&nbsp;weirdo&nbsp;(hopefully&nbsp;IPushProducer&nbsp;is&nbsp;sufficient?)&nbsp;but&nbsp;yes,&nbsp;this&nbsp;all&nbsp;sounds&nbsp;right&nbsp;to&nbsp;me.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Unfortunately&nbsp;the&nbsp;client&nbsp;IRequest&nbsp;&lt;a&nbsp;href=&quot;https://twistedmatrix.com/documents/15.4.0/api/twisted.web.iweb.IClientRequest.html&quot;&nbsp;class=&quot;&quot;&gt;https://twistedmatrix.com/documents/15.4.0/api/twisted.web.iweb.IClientRequest.html&lt;/a&gt;&nbsp;isn't&nbsp;quite&nbsp;as&nbsp;useful&nbsp;(although&nbsp;its&nbsp;relative&nbsp;minimalism&nbsp;should&nbsp;be&nbsp;an&nbsp;inspiration&nbsp;to&nbsp;anyone&nbsp;designing&nbsp;a&nbsp;next-generation&nbsp;IRequest&nbsp;more&nbsp;than&nbsp;the&nbsp;current&nbsp;IRequest's&nbsp;sprawling&nbsp;kitchen-sink&nbsp;aesthetic).&nbsp;&nbsp;However,&nbsp;IResponse.deliverBody&nbsp;could&nbsp;be&nbsp;applied&nbsp;to&nbsp;IGoodRequest&nbsp;as&nbsp;well.&nbsp;&nbsp;If&nbsp;we&nbsp;have&nbsp;a&nbsp;very&nbsp;similar-to-IResponse&nbsp;shaped&nbsp;IRequest&nbsp;object,&nbsp;say&nbsp;with&nbsp;'method',&nbsp;'uri'&nbsp;and&nbsp;'headers',&nbsp;and&nbsp;then&nbsp;a&nbsp;'deliverBody'&nbsp;that&nbsp;delivers&nbsp;the&nbsp;request&nbsp;body&nbsp;in&nbsp;much&nbsp;the&nbsp;same&nbsp;way,&nbsp;we&nbsp;could&nbsp;get&nbsp;a&nbsp;gracefully&nbsp;structured&nbsp;streaming&nbsp;request&nbsp;with&nbsp;works&nbsp;with&nbsp;a&nbsp;lot&nbsp;of&nbsp;existing&nbsp;code&nbsp;within&nbsp;Twisted.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Then&nbsp;the&nbsp;question&nbsp;is:&nbsp;what&nbsp;to&nbsp;do&nbsp;with&nbsp;IResource?&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Right&nbsp;now&nbsp;the&nbsp;flow&nbsp;of&nbsp;processing&nbsp;a&nbsp;request&nbsp;is,&nbsp;roughly:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;-&gt;&nbsp;wait&nbsp;for&nbsp;full&nbsp;request&nbsp;to&nbsp;arrive&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;-&gt;&nbsp;have&nbsp;HTTPChannel&nbsp;fill&nbsp;out&nbsp;IRequest&nbsp;object&lt;br&nbsp;class=&quot;&quot;&gt;-&gt;&nbsp;look&nbsp;at&nbsp;request.site.resource&nbsp;for&nbsp;the&nbsp;root&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;*-&gt;&nbsp;call&nbsp;getChildWithDefault&nbsp;repeatedly,&nbsp;mutating&nbsp;&quot;cursor&quot;&nbsp;state&nbsp;on&nbsp;the&nbsp;IRequest&nbsp;as&nbsp;you&nbsp;move&nbsp;(specifically:&nbsp;&quot;prepath&quot;&nbsp;and&nbsp;&quot;postpath&quot;&nbsp;attributes)&lt;br&nbsp;class=&quot;&quot;&gt;&nbsp;&nbsp;-&gt;&nbsp;eventually&nbsp;reach&nbsp;the&nbsp;leaf&nbsp;Resource,&nbsp;or&nbsp;one&nbsp;with&nbsp;'isLeaf'&nbsp;set&nbsp;on&nbsp;it,&nbsp;and&nbsp;delegate&nbsp;producing&nbsp;the&nbsp;response&nbsp;to&nbsp;that&nbsp;resource&lt;br&nbsp;class=&quot;&quot;&gt;*-&gt;&nbsp;call&nbsp;resource.render(request)&lt;br&nbsp;class=&quot;&quot;&gt;-&gt;&nbsp;examine&nbsp;the&nbsp;return&nbsp;value;&nbsp;if&nbsp;it's&nbsp;bytes,&nbsp;deliver&nbsp;them&nbsp;and&nbsp;close&nbsp;the&nbsp;connection;&nbsp;NOT_DONE_YET,&nbsp;just&nbsp;leave&nbsp;the&nbsp;connection&nbsp;open,&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Instead,&nbsp;I&nbsp;think&nbsp;a&nbsp;good&nbsp;flow&nbsp;would&nbsp;be:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;[snip&nbsp;long&nbsp;discussion&nbsp;of&nbsp;how&nbsp;to&nbsp;write&nbsp;locateChild]&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Agreed&nbsp;that&nbsp;these&nbsp;proposed&nbsp;approaches&nbsp;would&nbsp;work&nbsp;well.&nbsp;I&nbsp;have&nbsp;no&nbsp;concrete&nbsp;feedback&nbsp;on&nbsp;them,&nbsp;they&nbsp;seem&nbsp;good&nbsp;to&nbsp;me.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;-&gt;&nbsp;finally,&nbsp;call&nbsp;.responseForRequest(request)&nbsp;-&gt;&nbsp;IResponse&nbsp;on&nbsp;the&nbsp;final&nbsp;Resource&nbsp;and&nbsp;deliver&nbsp;the&nbsp;IResponse&nbsp;to&nbsp;the&nbsp;network.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;The&nbsp;way&nbsp;compatibility&nbsp;could&nbsp;be&nbsp;achieved&nbsp;here&nbsp;is&nbsp;to&nbsp;write&nbsp;a&nbsp;wrapper&nbsp;that&nbsp;would&nbsp;implement&nbsp;.responseForRequest&nbsp;to&nbsp;first&nbsp;collect&nbsp;the&nbsp;entire&nbsp;body,&nbsp;then&nbsp;synthesize&nbsp;a&nbsp;gross&nbsp;old-style-IRequest-like&nbsp;object&nbsp;out&nbsp;of&nbsp;the&nbsp;combination&nbsp;of&nbsp;that&nbsp;body&nbsp;and&nbsp;the&nbsp;other&nbsp;information&nbsp;about&nbsp;the&nbsp;resource,&nbsp;then&nbsp;call&nbsp;.getChildWithDefault&nbsp;on&nbsp;it&nbsp;a&nbsp;few&nbsp;times,&nbsp;then&nbsp;call&nbsp;the&nbsp;old-style&nbsp;.render_GET,&nbsp;et.&nbsp;al.&nbsp;&nbsp;The&nbsp;IResponse&nbsp;returned&nbsp;from&nbsp;this&nbsp;compatibility&nbsp;.responseForRequest&nbsp;would&nbsp;wrap&nbsp;up&nbsp;calls&nbsp;like&nbsp;request.write&nbsp;and&nbsp;turn&nbsp;them&nbsp;into&nbsp;write()&nbsp;calls.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;This&nbsp;seems&nbsp;super-gross&nbsp;but&nbsp;vaguely&nbsp;do-able,&nbsp;and&nbsp;we’ll&nbsp;need&nbsp;to&nbsp;write&nbsp;it&nbsp;in&nbsp;order&nbsp;to&nbsp;get&nbsp;the&nbsp;new&nbsp;H2Connection/H2Stream&nbsp;objects&nbsp;working&nbsp;with&nbsp;the&nbsp;old&nbsp;paradigm&nbsp;anyway.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;&quot;super-gross&nbsp;but&nbsp;vaguely&nbsp;do-able&quot;&nbsp;is&nbsp;what&nbsp;we're&nbsp;shooting&nbsp;for&nbsp;in&nbsp;the&nbsp;compatibility&nbsp;layer&nbsp;:).&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;All&nbsp;of&nbsp;this&nbsp;approach&nbsp;sounds&nbsp;reasonable&nbsp;modulo&nbsp;some&nbsp;careful&nbsp;thinking&nbsp;about&nbsp;how&nbsp;exactly&nbsp;we&nbsp;tie&nbsp;this&nbsp;in&nbsp;with&nbsp;the&nbsp;old&nbsp;paradigm.&nbsp;I’m&nbsp;particularly&nbsp;concerned&nbsp;about&nbsp;H2Channel,&nbsp;which&nbsp;I&nbsp;suspect&nbsp;many&nbsp;applications&nbsp;may&nbsp;know&nbsp;a&nbsp;great&nbsp;deal&nbsp;about.&nbsp;Changing&nbsp;its&nbsp;interface&nbsp;is&nbsp;likely&nbsp;to&nbsp;be&nbsp;slightly&nbsp;tricky,&nbsp;but&nbsp;we’ll&nbsp;see&nbsp;how&nbsp;it&nbsp;goes.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;It&nbsp;might&nbsp;be&nbsp;useful&nbsp;to&nbsp;think&nbsp;about&nbsp;a&nbsp;parent&nbsp;interface,&nbsp;IHTTPChannel&nbsp;with&nbsp;all&nbsp;the&nbsp;least-common-denominator&nbsp;stuff&nbsp;on&nbsp;it,&nbsp;and&nbsp;sub-interfaces&nbsp;IHTTP1_1Channel&nbsp;and&nbsp;IHTTP2_0Channel&nbsp;which&nbsp;each&nbsp;derive&nbsp;from&nbsp;that&nbsp;and&nbsp;provide&nbsp;additional&nbsp;version-specific&nbsp;stuff.&nbsp;&nbsp;I&nbsp;don't&nbsp;have&nbsp;enough&nbsp;protocol-specific&nbsp;knowledge&nbsp;to&nbsp;hand&nbsp;in&nbsp;short-term&nbsp;memory&nbsp;to&nbsp;comment&nbsp;on&nbsp;what&nbsp;that&nbsp;functionality&nbsp;might&nbsp;be&nbsp;though.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;-glyph&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
