<tt>
&lt;html&gt;&lt;head&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;-webkit-line-break:&nbsp;after-white-space;&nbsp;&quot;&gt;&lt;br&gt;&lt;div&gt;&lt;div&gt;On&nbsp;Jul&nbsp;27,&nbsp;2011,&nbsp;at&nbsp;5:41&nbsp;PM,&nbsp;&lt;a&nbsp;href=&quot;mailto:exarkun@twistedmatrix.com&quot;&gt;exarkun@twistedmatrix.com&lt;/a&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;font-family:&nbsp;Menlo;&nbsp;font-style:&nbsp;normal;&nbsp;font-variant:&nbsp;normal;&nbsp;font-weight:&nbsp;normal;&nbsp;letter-spacing:&nbsp;normal;&nbsp;line-height:&nbsp;normal;&nbsp;orphans:&nbsp;2;&nbsp;text-align:&nbsp;-webkit-auto;&nbsp;text-indent:&nbsp;0px;&nbsp;text-transform:&nbsp;none;&nbsp;white-space:&nbsp;normal;&nbsp;widows:&nbsp;2;&nbsp;word-spacing:&nbsp;0px;&nbsp;-webkit-border-horizontal-spacing:&nbsp;0px;&nbsp;-webkit-border-vertical-spacing:&nbsp;0px;&nbsp;-webkit-text-decorations-in-effect:&nbsp;none;&nbsp;-webkit-text-size-adjust:&nbsp;auto;&nbsp;-webkit-text-stroke-width:&nbsp;0px;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;&lt;div&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;My&nbsp;main&nbsp;thought&nbsp;here&nbsp;is&nbsp;that&nbsp;protocol&nbsp;reentrancy&nbsp;is&nbsp;bad,&nbsp;and&nbsp;nobody&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;really&nbsp;expects&nbsp;it&nbsp;even&nbsp;if&nbsp;they&nbsp;think&nbsp;it&nbsp;should&nbsp;be&nbsp;fine.&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;However,&nbsp;I&nbsp;do&nbsp;believe&nbsp;it&nbsp;would&nbsp;be&nbsp;best&nbsp;(easier&nbsp;to&nbsp;test,&nbsp;in&nbsp;particular)&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;to&nbsp;immediately&nbsp;call&nbsp;connectionLost&nbsp;within&nbsp;doRead&nbsp;(or&nbsp;doWrite)&nbsp;after&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;dataReceived&nbsp;exits,&nbsp;rather&nbsp;than&nbsp;callLater(0)-ing&nbsp;it&nbsp;or&nbsp;otherwise&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;&lt;/blockquote&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;placing&nbsp;it&nbsp;into&nbsp;a&nbsp;global&nbsp;call&nbsp;queue.&lt;br&gt;&lt;/blockquote&gt;&lt;br&gt;Probably&nbsp;not&nbsp;easier&nbsp;to&nbsp;test,&nbsp;nor&nbsp;easier&nbsp;to&nbsp;get&nbsp;right.&nbsp;&amp;nbsp;A&nbsp;single&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;generalized&nbsp;solution&nbsp;to&nbsp;avoid&nbsp;re-entrancy&nbsp;is&nbsp;probably&nbsp;the&nbsp;only&nbsp;way&nbsp;to&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;avoid&nbsp;a&nbsp;perpetual&nbsp;sequence&nbsp;of&nbsp;accidental&nbsp;re-entrant&nbsp;calls&nbsp;in&nbsp;obscure&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;untested&nbsp;cases&nbsp;in&nbsp;each&nbsp;different&nbsp;reactor&nbsp;implementation.&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Fair&nbsp;point;&nbsp;upon&nbsp;reflection&nbsp;of&nbsp;all&nbsp;the&nbsp;previous&nbsp;ad-hoc&nbsp;non-reentrancy&nbsp;stuff&nbsp;I've&nbsp;seen&nbsp;in&nbsp;the&nbsp;reactor,&nbsp;I&nbsp;retract&nbsp;my&nbsp;suggestion.&nbsp;&amp;nbsp;For&nbsp;testing,&nbsp;it's&nbsp;easy&nbsp;enough&nbsp;to&nbsp;plug&nbsp;a&nbsp;Clock()&nbsp;in&nbsp;there&nbsp;and&nbsp;iterate&nbsp;it&nbsp;once.&lt;/div&gt;&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;font-family:&nbsp;Menlo;&nbsp;font-style:&nbsp;normal;&nbsp;font-variant:&nbsp;normal;&nbsp;font-weight:&nbsp;normal;&nbsp;letter-spacing:&nbsp;normal;&nbsp;line-height:&nbsp;normal;&nbsp;orphans:&nbsp;2;&nbsp;text-align:&nbsp;-webkit-auto;&nbsp;text-indent:&nbsp;0px;&nbsp;text-transform:&nbsp;none;&nbsp;white-space:&nbsp;normal;&nbsp;widows:&nbsp;2;&nbsp;word-spacing:&nbsp;0px;&nbsp;-webkit-border-horizontal-spacing:&nbsp;0px;&nbsp;-webkit-border-vertical-spacing:&nbsp;0px;&nbsp;-webkit-text-decorations-in-effect:&nbsp;none;&nbsp;-webkit-text-size-adjust:&nbsp;auto;&nbsp;-webkit-text-stroke-width:&nbsp;0px;&nbsp;font-size:&nbsp;medium;&nbsp;&quot;&gt;&lt;div&gt;Perhaps&nbsp;the&nbsp;solution&nbsp;doesn't&nbsp;need&nbsp;to&nbsp;be&nbsp;`reactor.callLater(0,&nbsp;...)`,&nbsp;but&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;I&nbsp;think&nbsp;various&nbsp;implementations&nbsp;will&nbsp;be&nbsp;better&nbsp;if&nbsp;they&nbsp;put&nbsp;tasks&nbsp;into&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;some&nbsp;kind&nbsp;of&nbsp;queue,&nbsp;perhaps&nbsp;checked&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;iteration&nbsp;instead&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;of&nbsp;in&nbsp;the&nbsp;next&nbsp;iteration,&nbsp;rather&nbsp;than&nbsp;special&nbsp;casing&nbsp;each&nbsp;possible&nbsp;re-&lt;span&nbsp;class=&quot;Apple-converted-space&quot;&gt;&amp;nbsp;&lt;/span&gt;&lt;br&gt;entrant&nbsp;event&nbsp;in&nbsp;each&nbsp;possible&nbsp;event&nbsp;dispatcher.&lt;br&gt;&lt;/div&gt;&lt;/span&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;What&nbsp;would&nbsp;be&nbsp;the&nbsp;point&nbsp;of&nbsp;adding&nbsp;another&nbsp;task&nbsp;queue&nbsp;to&nbsp;the&nbsp;reactor?&nbsp;&amp;nbsp;This&nbsp;sounds&nbsp;like&nbsp;a&nbsp;solution&nbsp;to&nbsp;a&nbsp;non-problem.&nbsp;&amp;nbsp;(Although&nbsp;I&nbsp;might&nbsp;have&nbsp;suggested&nbsp;the&nbsp;same&nbsp;thing&nbsp;myself&nbsp;if&nbsp;I&nbsp;hadn't&nbsp;thought&nbsp;about&nbsp;it&nbsp;too&nbsp;much&nbsp;first.)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;answer&nbsp;that&nbsp;comes&nbsp;to&nbsp;mind&nbsp;when&nbsp;I&nbsp;think&nbsp;about&nbsp;this&nbsp;question&nbsp;is&nbsp;that&nbsp;an&nbsp;end-of-iteration&nbsp;queue&nbsp;would&nbsp;avoid&nbsp;unnecessary&nbsp;additional&nbsp;invocations&nbsp;of&nbsp;whatever&nbsp;multiplexing&nbsp;system&nbsp;call&nbsp;the&nbsp;reactor&nbsp;needs&nbsp;to&nbsp;make.&nbsp;&amp;nbsp;But&nbsp;there&nbsp;are&nbsp;several&nbsp;points&nbsp;on&nbsp;the&nbsp;down&nbsp;side:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;ol&nbsp;class=&quot;MailOutline&quot;&gt;&lt;li&gt;it's&nbsp;more&nbsp;code&nbsp;to&nbsp;maintain&lt;/li&gt;&lt;li&gt;it's&nbsp;more&nbsp;interfaces&nbsp;for&nbsp;users,&nbsp;or&nbsp;at&nbsp;least&nbsp;maintainers,&nbsp;to&nbsp;learn&lt;/li&gt;&lt;li&gt;it's&nbsp;an&nbsp;optimization,&nbsp;and&nbsp;so&nbsp;we&nbsp;should&nbsp;produce&nbsp;a&nbsp;benchmark&nbsp;indicating&nbsp;that&nbsp;the&nbsp;optimization&nbsp;makes&nbsp;sense&nbsp;and&nbsp;is&nbsp;effective&nbsp;before&nbsp;doing&nbsp;it&lt;/li&gt;&lt;li&gt;the&nbsp;optimization&nbsp;could&nbsp;be&nbsp;applied&nbsp;to&nbsp;callLater&nbsp;as&nbsp;it&nbsp;stands;&nbsp;any&nbsp;callLater(0)&nbsp;calls&nbsp;could&nbsp;be&nbsp;executed&nbsp;before&nbsp;the&nbsp;next&nbsp;reactor&nbsp;tick&lt;/li&gt;&lt;/ol&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Mostly&nbsp;though,&nbsp;an&nbsp;additional&nbsp;queue&nbsp;for&nbsp;non-reentrancy&nbsp;would&nbsp;be&nbsp;an&nbsp;ad-hoc&nbsp;special-case&nbsp;solution&nbsp;to&nbsp;one&nbsp;tiny&nbsp;part&nbsp;of&nbsp;the&nbsp;more&nbsp;general&nbsp;problem&nbsp;that&nbsp;reactor&nbsp;event&nbsp;ordering&nbsp;is&nbsp;a&nbsp;complete&nbsp;accident&nbsp;with&nbsp;unforseen&nbsp;consequences.&nbsp;&amp;nbsp;If&nbsp;there&nbsp;were&nbsp;a&nbsp;more&nbsp;general&nbsp;scheduling&nbsp;mechanism,&nbsp;we&nbsp;could&nbsp;schedule&nbsp;events&nbsp;in&nbsp;a&nbsp;better&nbsp;order&nbsp;overall.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-glyph&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
