<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.01&nbsp;Transitional//EN&quot;&gt;<br>
&lt;html&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=ISO-8859-1&quot;<br>
&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
&lt;br&gt;<br>
&lt;blockquote<br>
&nbsp;cite=&quot;mid:2ACA618E-A238-4B64-8C13-4E17521C1C49@twistedmatrix.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;div&gt;<br>
&nbsp;&nbsp;&lt;div&gt;First,&nbsp;generally:&nbsp;the&nbsp;most&nbsp;important&nbsp;thing&nbsp;to&nbsp;provide&nbsp;here&nbsp;are<br>
unit&nbsp;tests&nbsp;with&nbsp;very&nbsp;clear&nbsp;documentation&nbsp;expressing&nbsp;why&nbsp;you&nbsp;would&nbsp;want<br>
these&nbsp;things&nbsp;to&nbsp;work.&nbsp;&nbsp;The&nbsp;test&nbsp;code&nbsp;you&nbsp;provided&nbsp;is&nbsp;unclear&nbsp;because&nbsp;it<br>
does&nbsp;not&nbsp;succeed&nbsp;or&nbsp;fail,&nbsp;it&nbsp;just&nbsp;does&nbsp;some&nbsp;things,&nbsp;and&nbsp;then&nbsp;does&nbsp;some<br>
other&nbsp;things,&nbsp;without&nbsp;explaining&nbsp;&lt;i&gt;why&lt;/i&gt;&nbsp;I&nbsp;would&nbsp;want&nbsp;to&nbsp;do&nbsp;those<br>
things.&nbsp;&nbsp;Given&nbsp;that&nbsp;the&nbsp;implementation&nbsp;of&nbsp;Deferred&nbsp;is&nbsp;changing&nbsp;a&nbsp;lot<br>
now&nbsp;(see&nbsp;&lt;&lt;a&nbsp;moz-do-not-send=&quot;true&quot;<br>
&nbsp;href=&quot;http://twistedmatrix.com/trac/ticket/411&quot;&gt;http://twistedmatrix.com/trac/ticket/411&lt;/a&gt;&gt;),<br>
if&nbsp;we&nbsp;agree&nbsp;with&nbsp;your&nbsp;features,&nbsp;the&nbsp;implementation&nbsp;may&nbsp;have&nbsp;to&nbsp;change<br>
completely.&nbsp;&nbsp;So,&nbsp;it&nbsp;is&nbsp;important&nbsp;to&nbsp;have&nbsp;tests&nbsp;that&nbsp;describe&nbsp;just&nbsp;the<br>
behavior&nbsp;change,&nbsp;not&nbsp;the&nbsp;implementation.&lt;/div&gt;<br>
&nbsp;&nbsp;&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
Agree!&nbsp;I&lt;span&nbsp;id=&quot;result_box&quot;&nbsp;class=&quot;short_text&quot;&gt;&lt;span<br>
&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&nbsp;title=&quot;&quot;&gt;&nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span<br>
&nbsp;id=&quot;result_box&quot;&nbsp;class=&quot;short_text&quot;&gt;&lt;span<br>
&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&nbsp;title=&quot;&quot;&gt;precisely&nbsp;&lt;/span&gt;&lt;/span&gt;&lt;span<br>
&nbsp;id=&quot;result_box&quot;&nbsp;class=&quot;short_text&quot;&gt;&lt;span<br>
&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&nbsp;title=&quot;&quot;&gt;trying&nbsp;to<br>
suggest&nbsp;&lt;/span&gt;&lt;/span&gt;behavior,&nbsp;not&nbsp;the&nbsp;implementation&nbsp;:)&lt;br&gt;<br>
&lt;blockquote<br>
&nbsp;cite=&quot;mid:2ACA618E-A238-4B64-8C13-4E17521C1C49@twistedmatrix.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;div&gt;<br>
&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;<br>
&nbsp;style=&quot;border-collapse:&nbsp;separate;&nbsp;font-family:&nbsp;'Bitstream&nbsp;Vera&nbsp;Sans&nbsp;Mono';&nbsp;font-style:&nbsp;normal;&nbsp;font-variant:&nbsp;normal;&nbsp;font-weight:&nbsp;normal;&nbsp;letter-spacing:&nbsp;normal;&nbsp;line-height:&nbsp;normal;&nbsp;orphans:&nbsp;2;&nbsp;text-indent:&nbsp;0px;&nbsp;text-transform:&nbsp;none;&nbsp;white-space:&nbsp;normal;&nbsp;widows:&nbsp;2;&nbsp;word-spacing:&nbsp;0px;&nbsp;font-size:&nbsp;medium;&quot;&gt;&lt;span<br>
&nbsp;class=&quot;Apple-style-span&quot;&nbsp;style=&quot;font-family:&nbsp;monospace;&quot;&gt;Wanted<br>
features:&lt;br&gt;<br>
1.&nbsp;Ability&nbsp;to&nbsp;delete&nbsp;callbacks&nbsp;(delCallbacks)&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/span&gt;&lt;/span&gt;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;div&gt;Can&nbsp;you&nbsp;please&nbsp;explain&nbsp;*why*&nbsp;you&nbsp;would&nbsp;want&nbsp;this?&nbsp;&nbsp;Deleting<br>
callbacks&nbsp;from&nbsp;a&nbsp;Deferred&nbsp;would&nbsp;break&nbsp;a&nbsp;lot&nbsp;of&nbsp;assumptions&nbsp;about&nbsp;the<br>
way&nbsp;that&nbsp;Deferreds&nbsp;are&nbsp;used&nbsp;(at&nbsp;any&nbsp;particular&nbsp;point&nbsp;in&nbsp;the&nbsp;callback<br>
chain,&nbsp;you&nbsp;should&nbsp;be&nbsp;able&nbsp;to&nbsp;infer&nbsp;what&nbsp;the&nbsp;return&nbsp;type&nbsp;should&nbsp;be&nbsp;just<br>
by&nbsp;looking&nbsp;at&nbsp;the&nbsp;code,&nbsp;not&nbsp;running&nbsp;it).&lt;/div&gt;<br>
&nbsp;&nbsp;&lt;div&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&lt;div&gt;So,&nbsp;it&nbsp;is&nbsp;very&nbsp;unlikely&nbsp;that&nbsp;we&nbsp;will&nbsp;add&nbsp;the&nbsp;ability&nbsp;to&nbsp;delete<br>
arbitrary&nbsp;callbacks.&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
&lt;blockquote<br>
&nbsp;cite=&quot;mid:2ACA618E-A238-4B64-8C13-4E17521C1C49@twistedmatrix.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;div&gt;<br>
&nbsp;&nbsp;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;span&nbsp;class=&quot;Apple-style-span&quot;<br>
&nbsp;style=&quot;font-family:&nbsp;monospace;&quot;&gt;3.&nbsp;Ability&nbsp;to&nbsp;add/del&nbsp;hooks&nbsp;on<br>
deferred's&nbsp;finishing&nbsp;with&nbsp;errback&nbsp;or&nbsp;callback<br>
(addFinalizer/delFinalizer)&lt;/span&gt;&lt;/blockquote&gt;<br>
&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&lt;div&gt;&lt;br&gt;<br>
&nbsp;&nbsp;&lt;/div&gt;<br>
&nbsp;&nbsp;&lt;div&gt;You&nbsp;can&nbsp;already&nbsp;do&nbsp;this&nbsp;with&nbsp;weakref&nbsp;callbacks.&nbsp;&nbsp;Why&nbsp;would&nbsp;you<br>
need&nbsp;Deferred&nbsp;to&nbsp;provide&nbsp;an&nbsp;alternate&nbsp;mechanism?&lt;/div&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
I&nbsp;will&nbsp;try&nbsp;to&nbsp;explain&nbsp;why&nbsp;i&nbsp;want&nbsp;this&nbsp;features&nbsp;with&nbsp;example.&lt;br&gt;<br>
My&nbsp;task&nbsp;is&nbsp;about&nbsp;telephony.&lt;br&gt;<br>
Some&nbsp;user&nbsp;makes&nbsp;call&nbsp;and&nbsp;we&nbsp;want&nbsp;to&nbsp;acquire&nbsp;some&nbsp;TextToSpeach&nbsp;resource<br>
and&nbsp;AutomaticSpeachRecognition&nbsp;resource&nbsp;to&nbsp;do&nbsp;some&nbsp;automatic<br>
conversation&nbsp;with&nbsp;user.&lt;br&gt;<br>
We&nbsp;start&nbsp;playing&nbsp;music&nbsp;to&nbsp;user,&nbsp;launch&nbsp;long&nbsp;process&nbsp;to&nbsp;acquire&nbsp;this<br>
(expensive!)&nbsp;resources.&nbsp;After&nbsp;they&nbsp;have&nbsp;acquired,&nbsp;we&nbsp;establish&nbsp;audio<br>
links.&nbsp;After&nbsp;they&nbsp;established&nbsp;we&nbsp;speak&nbsp;something&nbsp;to&nbsp;user&nbsp;and&nbsp;start<br>
recognition.&nbsp;See&nbsp;NOTE&nbsp;in&nbsp;code.&lt;br&gt;<br>
&lt;br&gt;<br>
@inlineCallbacks&lt;br&gt;<br>
def&nbsp;incoming_call(self,&nbsp;call):&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;call.start_play('music')&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tts,&nbsp;asr&nbsp;=&nbsp;yield&nbsp;self.acquire_tts_for(call),<br>
self.acquire_asr_for(call)&nbsp;#&nbsp;tuple&nbsp;yield&nbsp;feature!&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;except&nbsp;TimeoutError:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;this&nbsp;occurs&nbsp;if&nbsp;TimeoutError&nbsp;raises&nbsp;in&nbsp;`self.acquire_tts_for`<br>
or&nbsp;`self.acquire_asr_for`&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;i.e.&nbsp;DeferredList(...,&nbsp;fireOnOneErrback=1)&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call.transfer_to('operator')&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;NOTE:&nbsp;at&nbsp;this&nbsp;point&nbsp;I&nbsp;want&nbsp;to&nbsp;automatically&lt;span<br>
&nbsp;id=&quot;result_box&quot;&nbsp;class=&quot;short_text&quot;&gt;&lt;span<br>
&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&nbsp;title=&quot;&quot;&gt;&nbsp;_recursively_<br>
(to&nbsp;deep)&nbsp;&lt;/span&gt;&lt;/span&gt;stop&nbsp;all&nbsp;deferred&nbsp;processes&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;starting&nbsp;inside&nbsp;`self.acquire_tts_for`&nbsp;and<br>
`self.acquire_asr_for`&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;because&nbsp;I&nbsp;don't&nbsp;need&nbsp;their&nbsp;results&nbsp;(and&nbsp;expensive&nbsp;resources!)<br>
any&nbsp;more&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;else:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;tts.speak('what&nbsp;you&nbsp;want?&nbsp;say&nbsp;me&nbsp;after&nbsp;signal')&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;asr.start_recognition()&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call.start_play('signal')&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;yield&nbsp;asr.wait_recognition_result()&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;do&nbsp;something&nbsp;with&nbsp;result&nbsp;...&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finally:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tts.release()&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;asr.release()&lt;br&gt;<br>
&lt;br&gt;<br>
@inlineCallbacks&lt;br&gt;<br>
def&nbsp;acquire_tts_for(self,&nbsp;call):&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;tts_connection&nbsp;=&nbsp;yield&nbsp;self.tts.acquire_connection(timeout=10)&nbsp;#<br>
may&nbsp;raise&nbsp;TimeoutError&nbsp;inside&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;call.make_audio_link_with(tts_connection,&nbsp;'in',&nbsp;timeout=10)&nbsp;#<br>
may&nbsp;raise&nbsp;TimeoutError&nbsp;inside&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;tts_connection&lt;br&gt;<br>
&lt;br&gt;<br>
@inlineCallbacks&lt;br&gt;<br>
def&nbsp;acquire_asr_for(self,&nbsp;call):&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;asr_connection&nbsp;=&nbsp;yield&nbsp;self.asr.acquire_connection(timeout=10)&nbsp;#<br>
may&nbsp;raise&nbsp;TimeoutError&nbsp;inside&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;yield&nbsp;call.make_audio_link_with(asr_connection,&nbsp;'out',&nbsp;timeout=10)<br>
#&nbsp;may&nbsp;raise&nbsp;TimeoutError&nbsp;inside&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;asr_connection&lt;br&gt;<br>
&lt;br&gt;<br>
To&nbsp;do&nbsp;this&nbsp;code&nbsp;to&nbsp;work:&lt;br&gt;<br>
1.&nbsp;Deferred()s&nbsp;must&nbsp;have&nbsp;feature&nbsp;to&nbsp;be&nbsp;informed&nbsp;that&nbsp;somebody&nbsp;does't<br>
need&nbsp;their&nbsp;result&nbsp;any&nbsp;more&nbsp;(delCallbacks)&lt;br&gt;<br>
2.&nbsp;Deferred()s&nbsp;must&nbsp;track&nbsp;their&nbsp;usage,&nbsp;and&nbsp;automatically&nbsp;cancels&nbsp;(and<br>
therefore&nbsp;calls&nbsp;their&nbsp;finalizers,&nbsp;see&nbsp;below)&nbsp;when&nbsp;they&nbsp;not&nbsp;used&nbsp;any<br>
more&nbsp;(nobody&nbsp;needs&nbsp;their&nbsp;result&nbsp;any&nbsp;more)&lt;br&gt;<br>
3.&nbsp;inlineCallbacks&nbsp;must&nbsp;release&nbsp;(delCallbacks)&nbsp;their&nbsp;child&nbsp;Defered()s<br>
when&nbsp;it&nbsp;doesn't&nbsp;need&nbsp;their&nbsp;result&nbsp;any&nbsp;more,&nbsp;this&nbsp;allows&nbsp;them&nbsp;to<br>
autimatically&nbsp;cancelling&nbsp;(if&nbsp;they&nbsp;dont&nbsp;needed&nbsp;somebody&nbsp;else).&nbsp;To&nbsp;do<br>
this&nbsp;inlineCallbacks&nbsp;must&nbsp;add&nbsp;some&nbsp;hook&nbsp;(addFinalizer)&nbsp;to&nbsp;parent<br>
Deferred&nbsp;and&nbsp;release&nbsp;child&nbsp;Deferreds&nbsp;when&nbsp;parent&nbsp;Deferred&nbsp;finished<br>
(callbacked/errbacked&nbsp;and&nbsp;therefore&nbsp;cancelled&nbsp;due&nbsp;cancel&nbsp;call&nbsp;errback).<br>
Why&nbsp;we&nbsp;need&nbsp;addFinalizer&nbsp;mechanism?&nbsp;Because&nbsp;addCallbacks&lt;span<br>
&nbsp;id=&quot;result_box&quot;&nbsp;class=&quot;short_text&quot;&gt;&lt;span<br>
&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&quot;&nbsp;title=&quot;&quot;&gt;&nbsp;means&lt;/span&gt;&lt;/span&gt;<br>
that&nbsp;Deferred&nbsp;is&nbsp;used,&nbsp;that&nbsp;somebody&nbsp;needs&nbsp;their&nbsp;result.&nbsp;But<br>
addFinalizer&nbsp;means&nbsp;that&nbsp;we&nbsp;don't&nbsp;neeed&nbsp;result,&nbsp;we&nbsp;just&nbsp;want&nbsp;to&nbsp;know<br>
when&nbsp;Deferred&nbsp;finished&nbsp;(to&nbsp;release&nbsp;our&nbsp;child&nbsp;resources&nbsp;for&nbsp;example).&lt;br&gt;<br>
&lt;br&gt;<br>
One&nbsp;more&nbsp;thing&nbsp;we&nbsp;may&nbsp;do&nbsp;with&nbsp;this&nbsp;features.&nbsp;What&nbsp;if&nbsp;our&nbsp;User&nbsp;hangs&nbsp;up<br>
call?&nbsp;What&nbsp;if&nbsp;our&nbsp;tcp&nbsp;connection&nbsp;lost&nbsp;(with&nbsp;that&nbsp;we&nbsp;have&nbsp;receive<br>
incoming&nbsp;call)?&nbsp;All&nbsp;resources&nbsp;(ASR&nbsp;and&nbsp;TTS)&nbsp;must&nbsp;be&nbsp;released&nbsp;as&nbsp;soon&nbsp;as<br>
possible!&nbsp;yields&nbsp;inside&nbsp;incoming_call&nbsp;must&nbsp;raise&nbsp;some&nbsp;ShuttingdownError<br>
for&nbsp;example.&nbsp;We&nbsp;may&nbsp;do&nbsp;this&nbsp;with&nbsp;above&nbsp;features.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote<br>
&nbsp;cite=&quot;mid:2ACA618E-A238-4B64-8C13-4E17521C1C49@twistedmatrix.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;&lt;fieldset&nbsp;class=&quot;mimeAttachmentHeader&quot;&gt;&lt;/fieldset&gt;<br>
_______________________________________________<br>
Twisted-Python&nbsp;mailing&nbsp;list<br>
&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;<br>
&lt;a&nbsp;class=&quot;moz-txt-link-freetext&quot;&nbsp;href=&quot;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&gt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
