<tt>
&lt;!DOCTYPE&nbsp;HTML&nbsp;PUBLIC&nbsp;&quot;-//W3C//DTD&nbsp;HTML&nbsp;4.01&nbsp;Transitional//EN&quot;&gt;<br>
&lt;html&gt;<br>
&lt;head&gt;<br>
&nbsp;&nbsp;&lt;meta&nbsp;content=&quot;text/html;&nbsp;charset=windows-1252&quot;<br>
&nbsp;http-equiv=&quot;Content-Type&quot;&gt;<br>
&lt;/head&gt;<br>
&lt;body&nbsp;bgcolor=&quot;#ffffff&quot;&nbsp;text=&quot;#000000&quot;&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;cite=&quot;mid:1B323C5E-54F3-4EFC-9911-460C22068DC6@gmail.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;You&nbsp;are&nbsp;currently&nbsp;considering&nbsp;your&nbsp;task&nbsp;from&nbsp;the&nbsp;viewpoint&nbsp;“let's&nbsp;make&nbsp;a&nbsp;callback&nbsp;chain&nbsp;for&nbsp;the&nbsp;perfect&nbsp;workflow&nbsp;and&nbsp;alter&nbsp;this&nbsp;chain&nbsp;in&nbsp;case&nbsp;of&nbsp;anything&nbsp;going&nbsp;wrong.”&nbsp;I&nbsp;think&nbsp;the&nbsp;flaw&nbsp;with&nbsp;this&nbsp;approach&nbsp;is&nbsp;that&nbsp;you&nbsp;are&nbsp;trying&nbsp;to&nbsp;make&nbsp;your&nbsp;“ideal”&nbsp;flow&nbsp;work&nbsp;at&nbsp;all&nbsp;in&nbsp;situations&nbsp;where&nbsp;it&nbsp;would,&nbsp;in&nbsp;fact,&nbsp;fail&nbsp;for&nbsp;the&nbsp;most&nbsp;of&nbsp;the&nbsp;time.<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
I&nbsp;am&nbsp;not&nbsp;sure&nbsp;I&nbsp;&lt;span&nbsp;id=&quot;result_box&quot;&nbsp;class=&quot;short_text&quot;&gt;&lt;span<br>
&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;<br>
&nbsp;title=&quot;&quot;&gt;understand&nbsp;you&nbsp;correct...&lt;br&gt;<br>
&lt;/span&gt;&lt;/span&gt;In&nbsp;my&nbsp;case&nbsp;when&nbsp;ASR&nbsp;or&nbsp;TTS&nbsp;resource&nbsp;aquiring&nbsp;fails&nbsp;I&nbsp;must<br>
transfer&nbsp;call&nbsp;to&nbsp;operator&nbsp;but&nbsp;not&nbsp;fail.&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;blockquote&nbsp;cite=&quot;mid:1B323C5E-54F3-4EFC-9911-460C22068DC6@gmail.com&quot;<br>
&nbsp;type=&quot;cite&quot;&gt;<br>
&nbsp;&nbsp;&lt;pre&nbsp;wrap=&quot;&quot;&gt;Instead&nbsp;of&nbsp;this,&nbsp;you&nbsp;could&nbsp;try&nbsp;to&nbsp;reconsider&nbsp;the&nbsp;task&nbsp;from&nbsp;the&nbsp;viewpoint&nbsp;of&nbsp;“Let's&nbsp;not&nbsp;add&nbsp;any&nbsp;further&nbsp;callbacks&nbsp;until&nbsp;this&nbsp;is&nbsp;absolutely&nbsp;necessary”.&nbsp;For&nbsp;me,&nbsp;this&nbsp;approach&nbsp;rather&nbsp;works.&nbsp;Moreover,&nbsp;you&nbsp;have&nbsp;the&nbsp;means&nbsp;to&nbsp;do&nbsp;it&nbsp;—&nbsp;a&nbsp;callback&nbsp;can&nbsp;return&nbsp;a&nbsp;Deferred,&nbsp;and&nbsp;so&nbsp;on.<br>
&nbsp;&nbsp;&lt;/pre&gt;<br>
&lt;/blockquote&gt;<br>
&lt;br&gt;<br>
Good.&nbsp;But&nbsp;I&nbsp;need&nbsp;to&nbsp;start&nbsp;acquiring&nbsp;ASR&nbsp;and&nbsp;TTS&nbsp;resources&nbsp;at&nbsp;one&nbsp;time<br>
(in&nbsp;parallel)&nbsp;because&nbsp;this&nbsp;is&nbsp;very&nbsp;long&nbsp;operations&nbsp;and&nbsp;they&nbsp;can&nbsp;be&nbsp;good<br>
performed&nbsp;in&nbsp;parallel&nbsp;because&nbsp;physically&nbsp;this&nbsp;is&nbsp;other&nbsp;and&nbsp;different<br>
machines&nbsp;(computers).&nbsp;Why&nbsp;we&nbsp;can't&nbsp;do&nbsp;that&nbsp;way?&nbsp;Why&nbsp;user&nbsp;have&nbsp;to&nbsp;wait<br>
double&nbsp;time?&lt;br&gt;<br>
&lt;br&gt;<br>
But&nbsp;it&nbsp;doesn't&nbsp;matter,&nbsp;because&nbsp;there&nbsp;is&nbsp;one&nbsp;more&nbsp;thing.&nbsp;Ok.&nbsp;Let's&nbsp;do&nbsp;it<br>
sequentially.&nbsp;But&nbsp;what&nbsp;if&nbsp;user&nbsp;hangs&nbsp;up&nbsp;call?&nbsp;I&nbsp;want&nbsp;to&nbsp;&lt;span<br>
&nbsp;id=&quot;result_box&quot;&nbsp;class=&quot;short_text&quot;&gt;&lt;span<br>
&nbsp;style=&quot;background-color:&nbsp;rgb(255,&nbsp;255,&nbsp;255);&nbsp;color:&nbsp;rgb(0,&nbsp;0,&nbsp;0);&quot;<br>
&nbsp;title=&quot;&quot;&gt;immediately&nbsp;stop&nbsp;all&nbsp;deferred&nbsp;processes&nbsp;due&nbsp;I&nbsp;don't&nbsp;need<br>
their&nbsp;results&nbsp;any&nbsp;more.&nbsp;All&nbsp;yields&nbsp;inside&nbsp;inlineCallbacks&nbsp;must&nbsp;raise<br>
some&nbsp;exception.&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;code&nbsp;shows&nbsp;how&nbsp;we&nbsp;can&nbsp;solve&nbsp;this&nbsp;with&nbsp;feautures&nbsp;described&lt;br&gt;<br>
&lt;br&gt;<br>
class&nbsp;DestroyingError(Exception):&lt;br&gt;<br>
   &nbsp;pass&lt;br&gt;<br>
&lt;br&gt;<br>
class&nbsp;DestroySupport(object):&lt;br&gt;<br>
   &nbsp;__destroying_deferreds&nbsp;=&nbsp;None&lt;br&gt;<br>
&lt;br&gt;<br>
   &nbsp;def&nbsp;__get_destroying_deferred(self):&lt;br&gt;<br>
       &nbsp;if&nbsp;self.__destroying_deferreds&nbsp;is&nbsp;None:&lt;br&gt;<br>
           &nbsp;self.__destroying_deferreds&nbsp;=&nbsp;{}&lt;br&gt;<br>
       &nbsp;deferred&nbsp;=&nbsp;defer.Deferred()&lt;br&gt;<br>
       &nbsp;self.__destroying_deferreds[deferred]&nbsp;=&nbsp;1&lt;br&gt;<br>
       &nbsp;#&nbsp;delete&nbsp;&quot;destroying&quot;&nbsp;`deferred`&nbsp;when&nbsp;it&nbsp;finished&lt;br&gt;<br>
       &nbsp;deferred.addFinalizer(self.__destroying_deferreds.pop,&nbsp;deferred)&lt;br&gt;<br>
       &nbsp;return&nbsp;deferred&lt;br&gt;<br>
&lt;br&gt;<br>
   &nbsp;def&nbsp;wait_destroying(self):&lt;br&gt;<br>
       &nbsp;return&nbsp;self.__get_destroying_deferred()&lt;br&gt;<br>
&lt;br&gt;<br>
   &nbsp;def&nbsp;destroy(self):&lt;br&gt;<br>
       &nbsp;if&nbsp;self.__destroying_deferreds&nbsp;is&nbsp;not&nbsp;None:&lt;br&gt;<br>
           &nbsp;#&nbsp;errback&nbsp;all&nbsp;&quot;destroying&quot;&nbsp;deferreds&lt;br&gt;<br>
           &nbsp;for&nbsp;deferred&nbsp;in&nbsp;self.__destroying_deferreds.keys():&lt;br&gt;<br>
               &nbsp;try:&lt;br&gt;<br>
                   &nbsp;raise&nbsp;DestroyingError('destroying')&lt;br&gt;<br>
               &nbsp;except&nbsp;DestroyingError:&lt;br&gt;<br>
                   &nbsp;deferred.errback()&lt;br&gt;<br>
           &nbsp;self.__destroying_deferreds&nbsp;=&nbsp;None&lt;br&gt;<br>
&lt;br&gt;<br>
#&nbsp;See&nbsp;InlineCallbacksManager&nbsp;in&nbsp;my&nbsp;first&nbsp;message&nbsp;in&nbsp;current&nbsp;discussion<br>
thread&lt;br&gt;<br>
class<br>
InlineCallbacksWithDestroySupportManager(defer.InlineCallbacksManager):&lt;br&gt;<br>
   &nbsp;def&nbsp;__init__(self,&nbsp;instance,&nbsp;*args,&nbsp;**kw):&lt;br&gt;<br>
       &nbsp;defer.InlineCallbacksManager.__init__(self,&nbsp;instance,&nbsp;*args,<br>
**kw)&lt;br&gt;<br>
       &nbsp;#&nbsp;chain&nbsp;Deferred&nbsp;with&nbsp;&quot;destroying&quot;&nbsp;deferred&lt;br&gt;<br>
       &nbsp;#&nbsp;therefore&nbsp;if&nbsp;destroy&nbsp;occurs&nbsp;Deferred&nbsp;errbacked&nbsp;with<br>
DestroyingError&lt;br&gt;<br>
       &nbsp;destroying_deferred&nbsp;=&nbsp;instance.wait_destroying()&lt;br&gt;<br>
       &nbsp;destroying_deferred.chainDeferred(self.deferred)&lt;br&gt;<br>
       &nbsp;#&nbsp;unchain&nbsp;if&nbsp;deferred&nbsp;finished&nbsp;(&lt;br&gt;<br>
       &nbsp;#    &nbsp;&quot;destroying&quot;&nbsp;deferred&nbsp;will&nbsp;be&nbsp;cancelled&nbsp;also&nbsp;due&nbsp;not&nbsp;used<br>
any&nbsp;more&lt;br&gt;<br>
       &nbsp;#    &nbsp;and&nbsp;deletes&nbsp;from&nbsp;DestroySupport.__destroying_deferreds<br>
due&nbsp;to&nbsp;its&nbsp;finalizer&lt;br&gt;<br>
       &nbsp;#    &nbsp;we&nbsp;add&nbsp;in&nbsp;DestroySupport.__get_destroying_deferred&lt;br&gt;<br>
       &nbsp;#&nbsp;)&lt;br&gt;<br>
       <br>
self.deferred.addFinalizer(destroying_deferred.unchainDeferredSafe,<br>
self.deferred)&lt;br&gt;<br>
&lt;br&gt;<br>
inlineCallbacksWithDestroySupport&nbsp;=<br>
defer.create_inline_callbacks_decorator(&lt;br&gt;<br>
   &nbsp;InlineCallbacksWithDestroySupportManager&lt;br&gt;<br>
)&lt;br&gt;<br>
&lt;br&gt;<br>
class&nbsp;CallService(DestroySupport):&lt;br&gt;<br>
   &nbsp;def&nbsp;on_connection_lost(self):&lt;br&gt;<br>
       &nbsp;#&nbsp;launch&nbsp;cascade&nbsp;destroying&nbsp;when&nbsp;connection&nbsp;lost!!!&lt;br&gt;<br>
       &nbsp;#&nbsp;all&nbsp;yields&nbsp;will&nbsp;raise&nbsp;DestroyingError&lt;br&gt;<br>
       &nbsp;#&nbsp;therefore&nbsp;all&nbsp;resources&nbsp;will&nbsp;be&nbsp;released&lt;br&gt;<br>
       &nbsp;self.destroy()&lt;br&gt;<br>
&lt;br&gt;<br>
   &nbsp;@inlineCallbacksWithDestroySupport&lt;br&gt;<br>
   &nbsp;def&nbsp;incoming_call(self,&nbsp;call):&lt;br&gt;<br>
       &nbsp;call.start_play('music')&lt;br&gt;<br>
       &nbsp;try:&lt;br&gt;<br>
           &nbsp;#&nbsp;tuple&nbsp;yield&nbsp;feature!&lt;br&gt;<br>
           &nbsp;tts,&nbsp;asr&nbsp;=&nbsp;yield&nbsp;self.acquire_tts_for(call),<br>
self.acquire_asr_for(call)&lt;br&gt;<br>
       &nbsp;except&nbsp;TimeoutError:&lt;br&gt;<br>
           &nbsp;#&nbsp;this&nbsp;occurs&nbsp;if&nbsp;TimeoutError&nbsp;raises&nbsp;in<br>
`self.acquire_tts_for`&nbsp;or&nbsp;`self.acquire_asr_for`&lt;br&gt;<br>
           &nbsp;#&nbsp;i.e.&nbsp;DeferredList(...,&nbsp;fireOnOneErrback=1)&lt;br&gt;<br>
           &nbsp;call.transfer_to('operator')&lt;br&gt;<br>
           &nbsp;#&nbsp;NOTE:&nbsp;at&nbsp;this&nbsp;point&nbsp;I&nbsp;want&nbsp;to&nbsp;automatically&nbsp;_recursively_<br>
(in&nbsp;deep)&lt;br&gt;<br>
           &nbsp;#&nbsp;stop&nbsp;all&nbsp;deferred&nbsp;processes&lt;br&gt;<br>
           &nbsp;#&nbsp;starting&nbsp;inside&nbsp;`self.acquire_tts_for`&nbsp;and<br>
`self.acquire_asr_for`&lt;br&gt;<br>
           &nbsp;#&nbsp;because&nbsp;I&nbsp;don't&nbsp;need&nbsp;their&nbsp;results&nbsp;(and&nbsp;expensive<br>
resources!)&nbsp;any&nbsp;more&lt;br&gt;<br>
       &nbsp;except&nbsp;DestroyingError:&lt;br&gt;<br>
           &nbsp;log('Destroying&nbsp;detected')&lt;br&gt;<br>
           &nbsp;raise&lt;br&gt;<br>
       &nbsp;else:&lt;br&gt;<br>
           &nbsp;try:&lt;br&gt;<br>
               &nbsp;try:&lt;br&gt;<br>
                   &nbsp;yield&nbsp;tts.speak('what&nbsp;you&nbsp;want?&nbsp;say&nbsp;me&nbsp;after<br>
signal')&lt;br&gt;<br>
                   &nbsp;yield&nbsp;asr.start_recognition()&lt;br&gt;<br>
                   &nbsp;call.start_play('signal')&lt;br&gt;<br>
                   &nbsp;result&nbsp;=&nbsp;yield&nbsp;asr.wait_recognition_result()&lt;br&gt;<br>
                   &nbsp;...&nbsp;do&nbsp;something&nbsp;with&nbsp;result&nbsp;...&lt;br&gt;<br>
               &nbsp;except&nbsp;DestroyingError:&lt;br&gt;<br>
                   &nbsp;log('Destroying&nbsp;detected')&lt;br&gt;<br>
                   &nbsp;raise&lt;br&gt;<br>
           &nbsp;finally:&lt;br&gt;<br>
               &nbsp;tts.release()&lt;br&gt;<br>
               &nbsp;asr.release()&lt;br&gt;<br>
&lt;br&gt;<br>
   &nbsp;@inlineCallbacksWithDestroySupport&lt;br&gt;<br>
   &nbsp;def&nbsp;acquire_tts_for(self,&nbsp;call):&lt;br&gt;<br>
       &nbsp;#&nbsp;may&nbsp;raise&nbsp;TimeoutError&nbsp;inside&lt;br&gt;<br>
       &nbsp;tts_connection&nbsp;=&nbsp;yield&nbsp;self.tts.acquire_connection(timeout=10)&lt;br&gt;<br>
       &nbsp;try:&lt;br&gt;<br>
           &nbsp;#&nbsp;may&nbsp;raise&nbsp;TimeoutError&nbsp;inside&lt;br&gt;<br>
           &nbsp;yield&nbsp;call.make_audio_link_with(tts_connection,&nbsp;'in',<br>
timeout=10)&lt;br&gt;<br>
       &nbsp;except&nbsp;Exception:&lt;br&gt;<br>
           &nbsp;#&nbsp;we&nbsp;MAY&nbsp;receive&nbsp;this&nbsp;Exception&nbsp;when&nbsp;cascading&nbsp;cancellation<br>
occurs&lt;br&gt;<br>
           &nbsp;tts_connection.release()&lt;br&gt;<br>
           &nbsp;raise&lt;br&gt;<br>
       &nbsp;else:&lt;br&gt;<br>
           &nbsp;return&nbsp;tts_connection&lt;br&gt;<br>
&lt;br&gt;<br>
   &nbsp;@inlineCallbacksWithDestroySupport&lt;br&gt;<br>
   &nbsp;def&nbsp;acquire_asr_for(self,&nbsp;call):&lt;br&gt;<br>
       &nbsp;#&nbsp;may&nbsp;raise&nbsp;TimeoutError&nbsp;inside&lt;br&gt;<br>
       &nbsp;asr_connection&nbsp;=&nbsp;yield&nbsp;self.asr.acquire_connection(timeout=10)&lt;br&gt;<br>
       &nbsp;try:&lt;br&gt;<br>
           &nbsp;#&nbsp;may&nbsp;raise&nbsp;TimeoutError&nbsp;inside&lt;br&gt;<br>
           &nbsp;yield&nbsp;call.make_audio_link_with(asr_connection,&nbsp;'out',<br>
timeout=10)&lt;br&gt;<br>
       &nbsp;except&nbsp;Exception:&lt;br&gt;<br>
           &nbsp;#&nbsp;we&nbsp;MAY&nbsp;receive&nbsp;this&nbsp;Exception&nbsp;when&nbsp;cascading&nbsp;cancellation<br>
occurs&lt;br&gt;<br>
           &nbsp;asr_connection.release()&lt;br&gt;<br>
           &nbsp;raise&lt;br&gt;<br>
       &nbsp;else:&lt;br&gt;<br>
           &nbsp;return&nbsp;asr_connection&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/span&gt;&lt;/span&gt;<br>
&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
