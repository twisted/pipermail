<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Summary:&nbsp;I&nbsp;am&nbsp;having&nbsp;an&nbsp;issue&nbsp;writing&nbsp;data&nbsp;from&nbsp;an&nbsp;object&nbsp;based&nbsp;on&nbsp;twisted&#39;s&nbsp;LineReceiver.&nbsp;Calling&nbsp;self.transport.write&nbsp;from&nbsp;the&nbsp;protocol,&nbsp;some&nbsp;data&nbsp;makes&nbsp;it&nbsp;through,&nbsp;some&nbsp;does&nbsp;not.&nbsp;Using&nbsp;tcpdump,&nbsp;I&nbsp;am&nbsp;not&nbsp;seeing&nbsp;the&nbsp;missing&nbsp;data&nbsp;cross&nbsp;the&nbsp;network&nbsp;interface. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Ubuntu&nbsp;LTS&nbsp;14.04&lt;/div&gt;&lt;div&gt;Python&nbsp;2.7.6&lt;/div&gt;&lt;div&gt;Twisted&nbsp;15.0.0&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;app&nbsp;recieves&nbsp;a&nbsp;bunch&nbsp;of&nbsp;messages&nbsp;from&nbsp;various&nbsp;upstream&nbsp;servers&nbsp;(not&nbsp;mine)&nbsp;and&nbsp;either&nbsp;discards—or&nbsp;bends,&nbsp;folds,&nbsp;spindles&nbsp;and&nbsp;muilates&nbsp;and&nbsp;sends&nbsp;the&nbsp;modified&nbsp;message&nbsp;to&nbsp;a&nbsp;downstream&nbsp;server.&nbsp;The&nbsp;message&nbsp;format&nbsp;is&nbsp;text-based,&nbsp;proprietary&nbsp;and&nbsp;not&nbsp;mine. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;way&nbsp;it&nbsp;works:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1.&nbsp;The&nbsp;app&nbsp;puts&nbsp;messages,&nbsp;consisting&nbsp;of&nbsp;a&nbsp;tuple&nbsp;of&nbsp;two&nbsp;strings:&nbsp;an&nbsp;id&nbsp;and&nbsp;the&nbsp;message&nbsp;data,&nbsp;on&nbsp;a&nbsp;queue.&nbsp;The&nbsp;queue&nbsp;is&nbsp;actually&nbsp;a&nbsp;deque&nbsp;on&nbsp;the&nbsp;factory. &lt;/div&gt;&lt;div&gt;2.&nbsp;There&#39;s&nbsp;one&nbsp;client&nbsp;protocol&nbsp;instance&nbsp;for&nbsp;sending,&nbsp;it&nbsp;holds&nbsp;a&nbsp;connection&nbsp;to&nbsp;downstream&nbsp;server.&nbsp;The&nbsp;factory&nbsp;is&nbsp;a&nbsp;reconnecting&nbsp;one,&nbsp;but&nbsp;only&nbsp;if&nbsp;the&nbsp;connection&nbsp;drops.&nbsp;(I&#39;m&nbsp;not&nbsp;creating&nbsp;a&nbsp;new&nbsp;protocol&nbsp;instance/connection&nbsp;per&nbsp;message)&lt;/div&gt;&lt;div&gt;3.&nbsp;There&#39;s&nbsp;a&nbsp;method&nbsp;on&nbsp;the&nbsp;protocol&nbsp;that&nbsp;checks&nbsp;for&nbsp;messages&nbsp;in&nbsp;the&nbsp;factory&#39;s&nbsp;queue,&nbsp;and&nbsp;sends&nbsp;them,&nbsp;one&nbsp;at&nbsp;a&nbsp;time.&nbsp;It&nbsp;waits&nbsp;for&nbsp;a&nbsp;short&nbsp;ack&nbsp;text&nbsp;message&nbsp;back&nbsp;from&nbsp;the&nbsp;receiving&nbsp;end,&nbsp;or&nbsp;times&nbsp;out&nbsp;(my&nbsp;app&#39;s&nbsp;timeout,&nbsp;not&nbsp;a&nbsp;network&nbsp;stack&nbsp;one)&nbsp;before&nbsp;sending&nbsp;the&nbsp;next&nbsp;message,&nbsp;if&nbsp;any.&nbsp;Code&nbsp;for&nbsp;the&nbsp;sending&nbsp;piece&nbsp;is&nbsp;below.&lt;/div&gt;&lt;div&gt;4.&nbsp;The&nbsp;downstream&nbsp;end&nbsp;(an&nbsp;app&nbsp;not&nbsp;under&nbsp;my&nbsp;control)&nbsp;is&nbsp;not&nbsp;getting&nbsp;all&nbsp;the&nbsp;messages.&nbsp;If&nbsp;my&nbsp;timeout&nbsp;check&nbsp;runs,&nbsp;and&nbsp;there&#39;s&nbsp;not&nbsp;been&nbsp;a&nbsp;returned&nbsp;ack&nbsp;message&nbsp;yet,&nbsp;invariably&nbsp;the&nbsp;sysadmins&nbsp;for&nbsp;the&nbsp;downstream&nbsp;system&nbsp;report&nbsp;they&nbsp;never&nbsp;got&nbsp;that&nbsp;message.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;def&nbsp;check_for_send(self):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;if&nbsp;not&nbsp;self.in_send_message:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;try:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.in_send_message&nbsp;=&nbsp;True&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;msg&nbsp;=&nbsp;self.factory.queue.popleft()&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;try:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.waiting_id&nbsp;=&nbsp;msg[0]&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;log.msg(&quot;Sending&nbsp;Message:&nbsp;{0}&quot;.format(msg[0]))&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;raw_msg&nbsp;=&nbsp;&quot;&quot;.join([self.MSG_START,&nbsp;msg[1],&nbsp;self.MSG_END,&nbsp;self.delimiter])&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;threads.deferToThread(self._dump_raw_message,&nbsp;msg[0],&nbsp;raw_msg)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.transport.write(raw_msg)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reactor.callLater(30,&nbsp;self.check_for_timeout,&nbsp;msg[0])&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;except:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;log.msg(&quot;Error&nbsp;sending&nbsp;Message:&nbsp;{0}&quot;.format(msg[0]))&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;log.err()&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.factory.add_message(msg)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.waiting_id&nbsp;=&nbsp;&quot;&quot;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.in_send_message&nbsp;=&nbsp;False&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;except&nbsp;IndexError:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.in_send_message&nbsp;=&nbsp;False&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;finally:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;reactor.callLater(0,&nbsp;self.check_for_send)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;else:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;reactor.callLater(1,&nbsp;self.check_for_send)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Mostly&nbsp;looking&nbsp;for&nbsp;some&nbsp;advice&nbsp;on&nbsp;further&nbsp;debugging&nbsp;this,&nbsp;as&nbsp;whenever&nbsp;I&#39;ve&nbsp;called&nbsp;self.transport.write&nbsp;on&nbsp;a&nbsp;lineReceiver&nbsp;over&nbsp;tcp&nbsp;before,&nbsp;it&nbsp;&quot;just&nbsp;worked.&quot;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Observations.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1.&nbsp;The&nbsp;event&nbsp;loop&nbsp;doesn&#39;t&nbsp;appear&nbsp;to&nbsp;be&nbsp;getting&nbsp;stuck.&nbsp;Messages&nbsp;that&nbsp;don&#39;t&nbsp;arrive&nbsp;downstream&nbsp;are&nbsp;interleaved&nbsp;with&nbsp;those&nbsp;that&nbsp;do.&nbsp;And&nbsp;the&nbsp;other&nbsp;part&nbsp;of&nbsp;the&nbsp;app&nbsp;that&nbsp;is&nbsp;receiving&nbsp;messages&nbsp;from&nbsp;upstream&nbsp;keeps&nbsp;right&nbsp;on&nbsp;trucking.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;2.&nbsp;I&nbsp;am&nbsp;now&nbsp;writing&nbsp;copies&nbsp;of&nbsp;the&nbsp;messages&nbsp;to&nbsp;disk,&nbsp;that&nbsp;call&nbsp;is&nbsp;right&nbsp;before&nbsp;the&nbsp;transport.write&nbsp;call,&nbsp;and&nbsp;all&nbsp;the&nbsp;&quot;missing&quot;&nbsp;messages&nbsp;do&nbsp;end&nbsp;up&nbsp;on&nbsp;disk.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;3.&nbsp;I&nbsp;also&nbsp;fire&nbsp;the&nbsp;callLater&nbsp;for&nbsp;the&nbsp;timeout&nbsp;function&nbsp;on&nbsp;each&nbsp;message.&nbsp;The&nbsp;disk&nbsp;write&nbsp;and&nbsp;the&nbsp;callLater&nbsp;both&nbsp;happen&nbsp;for&nbsp;missing&nbsp;messages.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;4.&nbsp;I&nbsp;ran&nbsp;tcpdump&nbsp;on&nbsp;the&nbsp;interface&nbsp;for&nbsp;about&nbsp;30&nbsp;minutes&nbsp;and&nbsp;matched&nbsp;up&nbsp;with&nbsp;log&nbsp;statements.&nbsp;If&nbsp;I&nbsp;see&nbsp;my&nbsp;protocol&nbsp;timed&nbsp;out&nbsp;waiting&nbsp;for&nbsp;an&nbsp;ack&nbsp;message&nbsp;in&nbsp;my&nbsp;app&#39;s&nbsp;log,&nbsp;I&nbsp;can&#39;t&nbsp;find&nbsp;the&nbsp;outgoing&nbsp;message&nbsp;on&nbsp;the&nbsp;interface. &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;5.&nbsp;I&nbsp;am&nbsp;not&nbsp;seeing&nbsp;any&nbsp;errors&nbsp;in&nbsp;my&nbsp;logs.&lt;/div&gt;&lt;/div&gt;<br>

</tt>
