<tt>
&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sun,&nbsp;Oct&nbsp;21,&nbsp;2012&nbsp;at&nbsp;3:35&nbsp;AM,&nbsp;Glyph&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&amp;lt;&lt;a&nbsp;href=&quot;mailto:glyph@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&gt;glyph@twistedmatrix.com&lt;/a&gt;&amp;gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;<br>
I&amp;#39;m&nbsp;top-posting&nbsp;just&nbsp;for&nbsp;consistency&nbsp;in&nbsp;this&nbsp;thread,&nbsp;but&nbsp;in&nbsp;the&nbsp;future&nbsp;please&nbsp;comment&nbsp;inline&nbsp;with&nbsp;trimming&nbsp;:).&nbsp; It&amp;#39;s&nbsp;easier&nbsp;to&nbsp;follow&nbsp;for&nbsp;future&nbsp;readers;&nbsp;if&nbsp;they&nbsp;find&nbsp;a&nbsp;post&nbsp;stand-alone&nbsp;in&nbsp;some&nbsp;web&nbsp;archive,&nbsp;the&nbsp;question&nbsp;will&nbsp;come&nbsp;before&nbsp;the&nbsp;answer.&lt;br&gt;<br>
<br>
&lt;br&gt;<br>
Anyhow;&nbsp;Mike,&nbsp;you&amp;#39;re&nbsp;definitely&nbsp;closer&nbsp;to&nbsp;the&nbsp;answer;&nbsp;a&nbsp;callLater&nbsp;is&nbsp;unnecessary,&nbsp;the&nbsp;callback&nbsp;should&nbsp;be&nbsp;called&nbsp;on&nbsp;demand.&nbsp; But,&nbsp;given&nbsp;that&nbsp;a&nbsp;queue&nbsp;of&nbsp;write&nbsp;operations&nbsp;is&nbsp;just&nbsp;that&nbsp;-&nbsp;a&nbsp;queue&nbsp;-&nbsp;we&nbsp;don&amp;#39;t&nbsp;need&nbsp;a&nbsp;Deferred&nbsp;for&nbsp;every&nbsp;write;&nbsp;the&nbsp;callback&nbsp;to&nbsp;the&nbsp;write&nbsp;operation&nbsp;can&nbsp;just&nbsp;pick&nbsp;up&nbsp;the&nbsp;next&nbsp;queued&nbsp;item.&lt;br&gt;<br>
<br>
&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;br&gt;<br>
-g&lt;br&gt;<br>
&lt;/font&gt;&lt;/span&gt;&lt;div&nbsp;class=&quot;im&nbsp;HOEnZb&quot;&gt;&lt;br&gt;<br>
On&nbsp;Oct&nbsp;20,&nbsp;2012,&nbsp;at&nbsp;9:07&nbsp;AM,&nbsp;Mike&nbsp;Winter&nbsp;&amp;lt;&lt;a&nbsp;href=&quot;mailto:miwinter@cisco.com&quot;&gt;miwinter@cisco.com&lt;/a&gt;&amp;gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;gt;&nbsp;This&nbsp;looks&nbsp;like&nbsp;the&nbsp;kind&nbsp;of&nbsp;thing&nbsp;that&nbsp;could&nbsp;involve&nbsp;using&nbsp;Deferred&nbsp;as&nbsp;part&nbsp;of&nbsp;solution.&nbsp;Instead&nbsp;of&nbsp;callLater(0.8,doWrite),&nbsp;design&nbsp;the&nbsp;mechanism&nbsp;to&nbsp;wire&nbsp;up&nbsp;event-source&nbsp;to&nbsp;fire&nbsp;the&nbsp;deferred&nbsp;and&nbsp;make&nbsp;doWrite&nbsp;be&nbsp;the&nbsp;callback.&lt;br&gt;<br>
<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&nbsp;On&nbsp;Oct&nbsp;20,&nbsp;2012,&nbsp;at&nbsp;8:29:10AM,&nbsp;gelin&nbsp;yan&nbsp;wrote:&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;Hi&nbsp;All&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; A&nbsp;few&nbsp;months&nbsp;ago,&nbsp;I&nbsp;reported&nbsp;a&nbsp;bug&nbsp;about&nbsp;IOCP.&nbsp;Last&nbsp;night&nbsp;I&nbsp;spent&nbsp;several&nbsp;hours&nbsp;on&nbsp;its&nbsp;implementation&nbsp;and&nbsp;finally&nbsp;found&nbsp;out&nbsp;a&nbsp;possible&nbsp;solution&nbsp;for&nbsp;that.&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; when&nbsp;sending&nbsp;some&nbsp;small&nbsp;chunks&nbsp;data&nbsp;continuously,&nbsp;the&nbsp;buffer&nbsp;will&nbsp;pile&nbsp;them&nbsp;up&nbsp;and&nbsp;send&nbsp;to&nbsp;IOCP;&nbsp;however&nbsp;there&nbsp;is&nbsp;a&nbsp;SEND_LIMIT&nbsp;(128K)&nbsp;that&nbsp;means&nbsp;only&nbsp;128K&nbsp;will&nbsp;be&nbsp;handled.&nbsp;Now&nbsp;the&nbsp;problem&nbsp;is&nbsp;when&nbsp;we&nbsp;try&nbsp;to&nbsp;trigger&nbsp;the&nbsp;next&nbsp;writing,&nbsp;IOCP&nbsp;will&nbsp;raise&nbsp;ERROR_IO_PENDING&nbsp;immediately&nbsp;and&nbsp;then&nbsp;connection&nbsp;Lost.&lt;br&gt;<br>
<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; So&nbsp;I&nbsp;got&nbsp;a&nbsp;idea:&nbsp;if&nbsp;the&nbsp;size&nbsp;of&nbsp;data&nbsp;is&nbsp;larger&nbsp;than&nbsp;SEND_LIMIT,&nbsp;we&nbsp;can&nbsp;wait&nbsp;a&nbsp;little&nbsp;bit&nbsp;time&nbsp;for&nbsp;the&nbsp;next&nbsp;writing&nbsp;instead&nbsp;of&nbsp;do&nbsp;it&nbsp;immediately.&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;in&nbsp;twisted\internet\iocpreactor\abstract.py&nbsp;there&nbsp;is&nbsp;a&nbsp;method&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;def&nbsp;_cbWrite(self,&nbsp;rc,&nbsp;bytes,&nbsp;evt):&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;self._handleWrite(rc,&nbsp;bytes,&nbsp;evt):&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.doWrite()&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;now&nbsp;I&nbsp;modified&nbsp;a&nbsp;bit,&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;def&nbsp;_cbWrite(self,&nbsp;rc,&nbsp;bytes,&nbsp;evt):&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;self._handleWrite(rc,&nbsp;bytes,&nbsp;evt):&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if&nbsp;len(evt.buff)&nbsp;&amp;lt;&nbsp;self.SEND_LIMIT:&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.doWrite()&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else:&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; self.reactor.callLater(0.8,self.doWrite)&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;0.8&nbsp;is&nbsp;a&nbsp;silly&nbsp;trial&nbsp;but&nbsp;I&nbsp;have&nbsp;no&nbsp;idea&nbsp;what&nbsp;is&nbsp;the&nbsp;right&nbsp;number&nbsp;for&nbsp;this&nbsp;place.&nbsp;After&nbsp;this&nbsp;modification,&nbsp;previous&nbsp;problematic&nbsp;scripts&nbsp;can&nbsp;pass.&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;Maybe&nbsp;the&nbsp;better&nbsp;solution&nbsp;is&nbsp;to&nbsp;find&nbsp;a&nbsp;way&nbsp;to&nbsp;poll&nbsp;the&nbsp;complete&nbsp;port&nbsp;status&nbsp;when&nbsp;read/write&nbsp;will&nbsp;be&nbsp;recovered&nbsp;from&nbsp;IO&nbsp;PENDING.&nbsp;Simply&nbsp;wait&nbsp;a&nbsp;little&nbsp;is&nbsp;risky.&lt;br&gt;<br>
&amp;gt;&amp;gt;&lt;br&gt;<br>
&amp;gt;&amp;gt;&nbsp;Regards&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;target=&quot;_blank&quot;&gt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;4&quot;&gt;Hi&nbsp;All&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;4&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/div&gt;&lt;div&gt;&lt;font&nbsp;size=&quot;4&quot;&gt; &nbsp; Thanks&nbsp;for&nbsp;reply.&nbsp;According&nbsp;to&nbsp;MSDN&nbsp;(link&nbsp;here: &lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/windows/desktop/ms683209(v=vs.85).aspx&quot;&gt;http://msdn.microsoft.com/en-us/library/windows/desktop/ms683209(v=vs.85).aspx&lt;/a&gt;)&lt;/font&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;quot;&lt;font&nbsp;face=&quot;arial,&nbsp;helvetica,&nbsp;sans-serif&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;A&nbsp;pending&nbsp;operation&nbsp;is&nbsp;indicated&nbsp;when&nbsp;the&nbsp;function&nbsp;that&nbsp;started&nbsp;the&nbsp;operation&nbsp;returns &lt;/span&gt;&lt;strong&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;FALSE&lt;/strong&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;,&nbsp;and&nbsp;the &lt;/span&gt;&lt;a&nbsp;href=&quot;http://msdn.microsoft.com/en-us/library/windows/desktop/ms679360(v=vs.85).aspx&quot;&nbsp;style=&quot;text-decoration:none;color:rgb(3,105,122);font-size:12px;line-height:18px&quot;&gt;&lt;strong&gt;GetLastError&lt;/strong&gt;&lt;/a&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt; function&nbsp;returns &lt;/span&gt;&lt;strong&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;ERROR_IO_PENDING&lt;/strong&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;.&nbsp;When&nbsp;an&nbsp;I/O&nbsp;operation&nbsp;is&nbsp;pending,&nbsp;the&nbsp;function&nbsp;that&nbsp;started&nbsp;the&nbsp;operation&nbsp;resets&nbsp;the &lt;/span&gt;&lt;strong&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;hEvent&lt;/strong&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt; member&nbsp;of&nbsp;the &lt;/span&gt;&lt;strong&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt;OVERLAPPED&lt;/strong&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-size:12px;line-height:18px&quot;&gt; structure&nbsp;to&nbsp;the&nbsp;nonsignaled&nbsp;state.&nbsp;Then&nbsp;when&nbsp;the&nbsp;pending&nbsp;operation&nbsp;has&nbsp;been&nbsp;completed,&nbsp;the&nbsp;system&nbsp;sets&nbsp;the&nbsp;event&nbsp;object&nbsp;to&nbsp;the&nbsp;signaled&nbsp;state&lt;/span&gt;&lt;/font&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt;.&amp;quot;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt; &nbsp;&lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;line-height:18px&quot;&gt;&lt;font&nbsp;size=&quot;4&quot;&gt;If&nbsp;we&nbsp;can&nbsp;know&nbsp;when&nbsp;event&nbsp;object&nbsp;is&nbsp;in&nbsp;the&nbsp;signaled&nbsp;state&nbsp;we&nbsp;definitely&nbsp;can&nbsp;use&nbsp;a&nbsp;queue&nbsp;directly.&nbsp;Any&nbsp;idea?&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;line-height:18px&quot;&gt;&lt;font&nbsp;size=&quot;4&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;line-height:18px&quot;&gt;&lt;font&nbsp;size=&quot;4&quot;&gt;Regards&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;line-height:18px&quot;&gt;&lt;font&nbsp;size=&quot;4&quot;&gt;&lt;br&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;line-height:18px&quot;&gt;&lt;font&nbsp;size=&quot;4&quot;&gt;gelin&nbsp;yan&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt;  &lt;/span&gt;&lt;/div&gt;<br>
&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span&nbsp;style=&quot;color:rgb(42,42,42);font-family:&amp;#39;Segoe&nbsp;UI&amp;#39;,&amp;#39;Lucida&nbsp;Grande&amp;#39;,Verdana,Arial,Helvetica,sans-serif;font-size:12px;line-height:18px&quot;&gt;&lt;br&gt;<br>
&lt;/span&gt;&lt;/div&gt;<br>

</tt>
