<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;I&nbsp;have&nbsp;some&nbsp;Klein&nbsp;code&nbsp;that&nbsp;uses&nbsp;deferToThread&nbsp;for&nbsp;I/O.&nbsp;It&nbsp;looks&nbsp;something&nbsp;like&nbsp;this:&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;@app.route(&#39;/&#39;,&nbsp;methods=[&#39;GET&#39;]&lt;/div&gt;&lt;div&gt;def&nbsp;index(request,&nbsp;*args,&nbsp;**kwargs):&lt;/div&gt;&lt;div&gt;<br>
 &nbsp; &nbsp;d&nbsp;=&nbsp;deferToThread(some_blocking_db_select_function)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;def&nbsp;serialize(db_object):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;return&nbsp;json.dumps({&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&#39;id&#39;:&nbsp;db_object,&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;})&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp;d.addCallback(serialize)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;return&nbsp;d&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;a&nbsp;test&nbsp;that&nbsp;executes&nbsp;this&nbsp;function,&nbsp;and&nbsp;the&nbsp;deferToThread&nbsp;returns&nbsp;a&nbsp;Deferred,&nbsp;but&nbsp;that&nbsp;deferred&nbsp;never&nbsp;fires&nbsp;its&nbsp;callback,&nbsp;and&nbsp;so&nbsp;when&nbsp;I&nbsp;use&nbsp;successResultOf&nbsp;expecting&nbsp;a&nbsp;success&nbsp;result,&nbsp;no&nbsp;result&nbsp;is&nbsp;found.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;When&nbsp;I&nbsp;use&nbsp;twistd&nbsp;to&nbsp;run&nbsp;the&nbsp;Klein&nbsp;application,&nbsp;everything&nbsp;works&nbsp;fine&nbsp;(the&nbsp;deferred&nbsp;fires&nbsp;and&nbsp;I&nbsp;get&nbsp;a&nbsp;json&nbsp;string&nbsp;in&nbsp;the&nbsp;body&nbsp;of&nbsp;the&nbsp;response).&nbsp;What&#39;s&nbsp;different&nbsp;about&nbsp;the&nbsp;trial&nbsp;environment&nbsp;that&nbsp;deferToThread&nbsp;might&nbsp;not&nbsp;fire&nbsp;its&nbsp;callback?&nbsp;Do&nbsp;I&nbsp;need&nbsp;to&nbsp;explicitly&nbsp;set&nbsp;up&nbsp;a&nbsp;thread&nbsp;pool&nbsp;in&nbsp;trial&nbsp;that&nbsp;I&nbsp;don&#39;t&nbsp;have&nbsp;to&nbsp;set&nbsp;up&nbsp;using&nbsp;twistd?&nbsp; Any&nbsp;help&nbsp;would&nbsp;be&nbsp;appreciated.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;-Piper&lt;/div&gt;&lt;/div&gt;<br>

</tt>
