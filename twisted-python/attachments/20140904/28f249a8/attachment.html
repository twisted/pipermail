<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello&nbsp;list,&lt;/div&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;need&nbsp;to&nbsp;implement&nbsp;a&nbsp;graceful&nbsp;shutdown&nbsp;procedure&nbsp;for&nbsp;a&nbsp;twistd&nbsp;application.&lt;/div&gt;&lt;div&gt;The&nbsp;application&nbsp;is&nbsp;made&nbsp;up&nbsp;of&nbsp;two&nbsp;services:&nbsp;an internet.TCPClient&nbsp;and&nbsp;an internet.TCPServer.&lt;/div&gt;<br>
&lt;div&gt;They&#39;re&nbsp;glued&nbsp;together&nbsp;with&nbsp;a&nbsp;MultiService&nbsp;instance,&nbsp;which&nbsp;is&nbsp;in&nbsp;turn&nbsp;set&nbsp;to&nbsp;have&nbsp;&#39;application&#39;&nbsp;as&nbsp;parent.&lt;/div&gt;&lt;div&gt;The&nbsp;server&nbsp;and&nbsp;the&nbsp;client&nbsp;work&nbsp;together,&nbsp;making&nbsp;a&nbsp;proxy&nbsp;(SMTP&nbsp;server&nbsp;and&nbsp;AMQP&nbsp;client).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;My&nbsp;goal&nbsp;is&nbsp;the&nbsp;following:&lt;/div&gt;&lt;div&gt;-&nbsp;intercept&nbsp;a&nbsp;SIGTERM&nbsp;signal&lt;/div&gt;&lt;div&gt;-&nbsp;&#39;block&#39;&nbsp;on&nbsp;the&nbsp;server&nbsp;side:&nbsp;since&nbsp;it&#39;s&nbsp;SMTP&nbsp;I&nbsp;get&nbsp;this&nbsp;by&nbsp;setting&nbsp;a&nbsp;variable&nbsp;that&nbsp;makes&nbsp;the&nbsp;server&nbsp;return&nbsp;tempfails&nbsp;(4xx)&nbsp;for&nbsp;new&nbsp;messages,&nbsp;while&nbsp;keeping&nbsp;current&nbsp;sessions&nbsp;active&lt;/div&gt;<br>
&lt;div&gt;-&nbsp;wait&nbsp;until&nbsp;current&nbsp;requests&nbsp;are&nbsp;satisfied&nbsp;(I&nbsp;keep&nbsp;a&nbsp;dictionary&nbsp;of&nbsp;current&nbsp;pending&nbsp;messages)&lt;/div&gt;&lt;div&gt;-&nbsp;shut&nbsp;the&nbsp;whole&nbsp;thing&nbsp;down&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;What&nbsp;is&nbsp;the&nbsp;best&nbsp;solution&nbsp;for&nbsp;this&nbsp;use&nbsp;case?&nbsp;It&#39;s&nbsp;not&nbsp;really&nbsp;clear&nbsp;to&nbsp;me&nbsp;how&nbsp;to&nbsp;catch&nbsp;SIGTERM&nbsp;and&nbsp;handle&nbsp;pending&nbsp;requests&nbsp;*before*&nbsp;the&nbsp;underlying&nbsp;services&nbsp;start&nbsp;to&nbsp;shutdown&nbsp;(i.e.&nbsp;even addSystemEventTrigger(&#39;before&#39;,&nbsp;&#39;shutdown&#39;,&nbsp;callable)&nbsp;is&nbsp;called&nbsp;too&nbsp;late&nbsp;for&nbsp;my&nbsp;needs).&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thank&nbsp;you&nbsp;very&nbsp;much&nbsp;for&nbsp;your&nbsp;help!&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Fabio&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
