<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Thu,&nbsp;Sep&nbsp;4,&nbsp;2014&nbsp;at&nbsp;2:02&nbsp;PM,&nbsp;&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:exarkun@twistedmatrix.com&quot;&nbsp;target=&quot;_blank&quot;&gt;exarkun@twistedmatrix.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left-width:1px;border-left-color:rgb(204,204,204);border-left-style:solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;br&gt;<br>
You&nbsp;said&nbsp;before&nbsp;shutdown&nbsp;triggers&nbsp;are&nbsp;too&nbsp;late&nbsp;but&nbsp;you&nbsp;didn&#39;t&nbsp;say&nbsp;why.&nbsp;I&nbsp;think&nbsp;that&#39;s&nbsp;based&nbsp;on&nbsp;a&nbsp;misunderstanding&nbsp;-&nbsp;but&nbsp;if&nbsp;not,&nbsp;then&nbsp;explain&nbsp;why&nbsp;it&nbsp;doesn&#39;t&nbsp;work&nbsp;for&nbsp;your&nbsp;scenario.&lt;br&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;Hi,&nbsp;thanks&nbsp;for&nbsp;your&nbsp;reply.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve&nbsp;tried&nbsp;the&nbsp;following:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;def&nbsp;sleep(secs):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;log.msg(&#39;from&nbsp;within&nbsp;trigger&#39;)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;d&nbsp;=&nbsp;defer.Deferred()&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp;reactor.callLater(secs,&nbsp;d.callback,&nbsp;None)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;return&nbsp;d &lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;reactor.addSystemEventTrigger(&#39;before&#39;,&nbsp;&#39;shutdown&#39;,&nbsp;sleep,&nbsp;10)&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;div&gt;This&nbsp;is&nbsp;what&nbsp;I&nbsp;can&nbsp;see&nbsp;in&nbsp;the&nbsp;logs:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:06&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[-]&nbsp;Received&nbsp;SIGTERM,&nbsp;shutting&nbsp;down.&lt;/div&gt;&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:06&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[-]&nbsp;from&nbsp;within&nbsp;trigger&lt;/div&gt;<br>
&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:06&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[TwistedProtocolConnection,client]&nbsp;&lt;twisted.internet.tcp.Connector&nbsp;instance&nbsp;at&nbsp;0x0000000005717be0&gt;&nbsp;will&nbsp;retry&nbsp;in&nbsp;2&nbsp;seconds&lt;/div&gt;&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:06&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[TwistedProtocolConnection,client]&nbsp;Stopping&nbsp;factory&nbsp;&lt;__builtin__.RabbitMQClientFactory&nbsp;instance&nbsp;at&nbsp;0x00000000057172c0&gt;&lt;/div&gt;<br>
&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:06&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[-]&nbsp;(TCP&nbsp;Port&nbsp;10025&nbsp;Closed)&lt;/div&gt;&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:06&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[-]&nbsp;Stopping&nbsp;factory&nbsp;&lt;__builtin__.TempfailingESMTPFactory&nbsp;instance&nbsp;at&nbsp;0x00000000057172a0&gt;&lt;/div&gt;<br>
&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:09&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[-]&nbsp;Starting&nbsp;factory&nbsp;&lt;__builtin__.RabbitMQClientFactory&nbsp;instance&nbsp;at&nbsp;0x00000000057172c0&gt;&lt;/div&gt;&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:09&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[TwistedProtocolConnection,client]&nbsp;[rmq01]&nbsp;RabbitMQ&nbsp;connection&nbsp;established&lt;/div&gt;<br>
&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:16&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[TwistedProtocolConnection,client]&nbsp;&lt;twisted.internet.tcp.Connector&nbsp;instance&nbsp;at&nbsp;0x0000000005717be0&gt;&nbsp;will&nbsp;retry&nbsp;in&nbsp;2&nbsp;seconds&lt;/div&gt;&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:16&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[TwistedProtocolConnection,client]&nbsp;Stopping&nbsp;factory&nbsp;&lt;__builtin__.RabbitMQClientFactory&nbsp;instance&nbsp;at&nbsp;0x00000000057172c0&gt;&lt;/div&gt;<br>
&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:16&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[-]&nbsp;Main&nbsp;loop&nbsp;terminated.&lt;/div&gt;&lt;div&gt;Sep&nbsp; 4&nbsp;14:25:16&nbsp;prepyproxy01&nbsp;proxy&nbsp;[4924]:&nbsp;[-]&nbsp;Server&nbsp;Shut&nbsp;Down.&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&nbsp;seems&nbsp;to&nbsp;me&nbsp;that&nbsp;the&nbsp;shutdown&nbsp;phase&nbsp;doesn&#39;t&nbsp;wait&nbsp;for&nbsp;the&nbsp;deferred&nbsp;to&nbsp;fire&nbsp;before&nbsp;stopping&nbsp;my&nbsp;client&nbsp;and&nbsp;server. &lt;/div&gt;<br>
&lt;div&gt;To&nbsp;be&nbsp;clear:&nbsp;my&nbsp;expected&nbsp;result&nbsp;is:&lt;/div&gt;&lt;div&gt;-&nbsp;SIGTERM&lt;/div&gt;&lt;div&gt;-&nbsp;pause&nbsp;10s&lt;/div&gt;&lt;div&gt;-&nbsp;client/server&nbsp;shutdown&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;am&nbsp;surely&nbsp;missing&nbsp;something,&nbsp;but&nbsp;I&nbsp;really&nbsp;can&#39;t&nbsp;figure&nbsp;out&nbsp;what.&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Oh,&nbsp;for&nbsp;the&nbsp;records:&nbsp;I&#39;m&nbsp;using&nbsp;Twisted&nbsp;13.2.0&nbsp;on&nbsp;Pypy.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks!&lt;/div&gt;&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
