<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hey&nbsp;&lt;br&gt;&lt;br&gt;&lt;/div&gt;I&nbsp;raised&nbsp;a&nbsp;similar&nbsp;question&nbsp;a&nbsp;while&nbsp;ago:&nbsp;&lt;br&gt;&lt;a&nbsp;href=&quot;http://twistedmatrix.com/pipermail/twisted-python/2013-July/027241.html&quot;&gt;http://twistedmatrix.com/pipermail/twisted-python/2013-July/027241.html&lt;/a&gt;&lt;br&gt;&lt;br&gt;&lt;/div&gt;Since&nbsp;then,&nbsp;our&nbsp;approach&nbsp;has&nbsp;evolved&nbsp;into&nbsp;the&nbsp;below,&nbsp;which&nbsp;may&nbsp;be&nbsp;useful.&lt;br&gt;&lt;a&nbsp;href=&quot;https://github.com/jamesbroadhead/bttrtwisted/blob/master/bttrtwisted/testing.py&quot;&gt;https://github.com/jamesbroadhead/bttrtwisted/blob/master/bttrtwisted/testing.py&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Usage:&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;expected&nbsp;=&nbsp;Foo()&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;remote_result&nbsp;=&nbsp;Result()&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;thing&nbsp;=&nbsp;Thing()&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;thing.call_external_service&nbsp;=&nbsp;dmockfunc(remote_result)&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;d&nbsp;=&nbsp;thing.function_under_test(..)&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;d.addCallback(self.assertEqual,&nbsp;expected)&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp;return&nbsp;d&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;You&nbsp;can&nbsp;use&nbsp;the&nbsp;func_dict&nbsp;param&nbsp;to&nbsp;gen_nondeferred_mock&nbsp;to&nbsp;have&nbsp;it&nbsp;stand&nbsp;in-place-of&nbsp;an&nbsp;object&nbsp;&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;As&nbsp;always&nbsp;with&nbsp;mocks,&nbsp;a&nbsp;little&nbsp;can&nbsp;be&nbsp;helpful,&nbsp;but&nbsp;if&nbsp;you&nbsp;find&nbsp;you&#39;re&nbsp;instantiating&nbsp;a&nbsp;lot&nbsp;of&nbsp;them,&nbsp;you&nbsp;may&nbsp;want&nbsp;to&nbsp;reconsider&nbsp;your&nbsp;approach.&nbsp;&lt;br&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Feedback&nbsp;welcome!&nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[&nbsp;the&nbsp;repo&nbsp;is&nbsp;for&nbsp;experiments,&nbsp;so&nbsp;use&nbsp;with&nbsp;care&nbsp;]&nbsp;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;James&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;27&nbsp;January&nbsp;2015&nbsp;at&nbsp;13:00,&nbsp;Patryk&nbsp;Ściborek&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:patryk@sciborek.com&quot;&nbsp;target=&quot;_blank&quot;&gt;patryk@sciborek.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;Hi!&lt;/span&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;I&#39;ve&nbsp;just&nbsp;started&nbsp;a&nbsp;new&nbsp;project&nbsp;using&nbsp;Twisted&nbsp;and&nbsp;I&nbsp;want&nbsp;to&nbsp;write&nbsp;unit&nbsp;tests&nbsp;since&nbsp;the&nbsp;beginning.&nbsp;Unfortunately&nbsp;I&#39;ve&nbsp;got&nbsp;some&nbsp;trouble&nbsp;understanding&nbsp;how&nbsp;should&nbsp;I&nbsp;do&nbsp;it.&nbsp;I&nbsp;read&nbsp;&#39;Test-driven&nbsp;development&nbsp;with&nbsp;Twisted&#39;,&nbsp;read&nbsp;some&nbsp;articles&nbsp;on&nbsp;the&nbsp;web&nbsp;and&nbsp;searched&nbsp;on&nbsp;the&nbsp;mailing&nbsp;list&nbsp;but&nbsp;I&nbsp;couldn&#39;t&nbsp;find&nbsp;anything&nbsp;which&nbsp;make&nbsp;it&nbsp;clear&nbsp;for&nbsp;me.&lt;br&gt;&lt;br&gt;I&#39;ve&nbsp;got&nbsp;a&nbsp;class:&lt;br&gt;&lt;br&gt;&lt;div&gt;class&nbsp;SessionCleaner(object):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;def&nbsp;__init__(self,&nbsp;session_db,&nbsp;interval=10):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.session_db&nbsp;=&nbsp;session_db&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp;  &lt;a&nbsp;href=&quot;http://self.lc/&quot;&nbsp;target=&quot;_blank&quot;&gt;self.lc&lt;/a&gt; =&nbsp;task.LoopingCall(self.check_old_sessions)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.lc.start(interval)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;@defer.inlineCallbacks&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;def&nbsp;check_old_sessions(self):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;log.msg(&#39;check_old_sessions()&#39;,&nbsp;logLevel=logging.DEBUG)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;try:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_sessions&nbsp;=&nbsp;yield&nbsp;self.session_db.get_old_sessions()&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for&nbsp;s&nbsp;in&nbsp;old_sessions:&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;yield&nbsp;self.session_db.process_stopped(s)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;except&nbsp;txredisapi.ConnectionError&nbsp;as&nbsp;e:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;log.msg(&#39;check_old_sessions&nbsp;-&nbsp;connection&nbsp;error&nbsp;{}&#39;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.format(e),&nbsp;logLevel=logging.WARNING)&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;session_db&nbsp;is&nbsp;a&nbsp;object&nbsp;with&nbsp;methods&nbsp;which&nbsp;makes&nbsp;some&nbsp;calls&nbsp;to&nbsp;Redis.&lt;br&gt;&lt;br&gt;Testing&nbsp;if&nbsp;__init__&nbsp;works&nbsp;correctly&nbsp;is&nbsp;easy&nbsp;-&nbsp;I&nbsp;can&nbsp;mock&nbsp;task.LoopingCall&nbsp;and&nbsp;check&nbsp;if&nbsp;it&nbsp;was&nbsp;called&nbsp;with&nbsp;correct&nbsp;attributes.&lt;br&gt;&lt;br&gt;I&#39;ve&nbsp;got&nbsp;trouble&nbsp;testing&nbsp;check_old_sessions.&nbsp;Since&nbsp;I&#39;m&nbsp;writing&nbsp;unit&nbsp;tests&nbsp;I&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;call&nbsp;real&nbsp;session_db&nbsp;methods&nbsp;and&nbsp;make&nbsp;real&nbsp;Redis&nbsp;queries.&nbsp;I&#39;d&nbsp;like&nbsp;to&nbsp;mock&nbsp;them&nbsp;and&nbsp;test&nbsp;just&nbsp;few&nbsp;things:&lt;br&gt;-&nbsp;is&nbsp;the&nbsp;method&nbsp;get_old_sessions&nbsp;called?&lt;br&gt;-&nbsp;is&nbsp;the&nbsp;method&nbsp;process_stopped&nbsp;called&nbsp;N&nbsp;times&nbsp;with&nbsp;the&nbsp;arguments&nbsp;returned&nbsp;by&nbsp;mocked&nbsp;get_old_sessions?&lt;br&gt;-&nbsp;is&nbsp;txredisapi.ConnectionError&nbsp;handled&nbsp;correctly?&lt;br&gt;&lt;br&gt;So&nbsp;is&nbsp;there&nbsp;any&nbsp;&quot;right&quot;&nbsp;way&nbsp;of&nbsp;mocking&nbsp;functions&nbsp;which&nbsp;returns&nbsp;deferreds?&nbsp;Or&nbsp;maybe&nbsp;I&nbsp;should&nbsp;test&nbsp;this&nbsp;method&nbsp;differently?&lt;br&gt;&lt;br&gt;Best&nbsp;regards,&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;Patryk&lt;/div&gt;&lt;/div&gt;<br>
&lt;br&gt;_______________________________________________&lt;br&gt;<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;target=&quot;_blank&quot;&gt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
