<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;span&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;Hi!&lt;/span&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;I&#39;ve&nbsp;just&nbsp;started&nbsp;a&nbsp;new&nbsp;project&nbsp;using&nbsp;Twisted&nbsp;and&nbsp;I&nbsp;want&nbsp;to&nbsp;write&nbsp;unit&nbsp;tests&nbsp;since&nbsp;the&nbsp;beginning.&nbsp;Unfortunately&nbsp;I&#39;ve&nbsp;got&nbsp;some&nbsp;trouble&nbsp;understanding&nbsp;how&nbsp;should&nbsp;I&nbsp;do&nbsp;it.&nbsp;I&nbsp;read&nbsp;&#39;Test-driven&nbsp;development&nbsp;with&nbsp;Twisted&#39;,&nbsp;read&nbsp;some&nbsp;articles&nbsp;on&nbsp;the&nbsp;web&nbsp;and&nbsp;searched&nbsp;on&nbsp;the&nbsp;mailing&nbsp;list&nbsp;but&nbsp;I&nbsp;couldn&#39;t&nbsp;find&nbsp;anything&nbsp;which&nbsp;make&nbsp;it&nbsp;clear&nbsp;for&nbsp;me.&lt;br&gt;&lt;br&gt;I&#39;ve&nbsp;got&nbsp;a&nbsp;class:&lt;br&gt;&lt;br&gt;&lt;div&gt;class&nbsp;SessionCleaner(object):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;def&nbsp;__init__(self,&nbsp;session_db,&nbsp;interval=10):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.session_db&nbsp;=&nbsp;session_db&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp;  &lt;a&nbsp;href=&quot;http://self.lc/&quot;&nbsp;target=&quot;_blank&quot;&gt;self.lc&lt;/a&gt; =&nbsp;task.LoopingCall(self.check_old_sessions)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.lc.start(interval)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;@defer.inlineCallbacks&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;def&nbsp;check_old_sessions(self):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;log.msg(&#39;check_old_sessions()&#39;,&nbsp;logLevel=logging.DEBUG)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;try:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;old_sessions&nbsp;=&nbsp;yield&nbsp;self.session_db.get_old_sessions()&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for&nbsp;s&nbsp;in&nbsp;old_sessions:&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;yield&nbsp;self.session_db.process_stopped(s)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;except&nbsp;txredisapi.ConnectionError&nbsp;as&nbsp;e:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;log.msg(&#39;check_old_sessions&nbsp;-&nbsp;connection&nbsp;error&nbsp;{}&#39;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.format(e),&nbsp;logLevel=logging.WARNING)&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;&lt;br&gt;session_db&nbsp;is&nbsp;a&nbsp;object&nbsp;with&nbsp;methods&nbsp;which&nbsp;makes&nbsp;some&nbsp;calls&nbsp;to&nbsp;Redis.&lt;br&gt;&lt;br&gt;Testing&nbsp;if&nbsp;__init__&nbsp;works&nbsp;correctly&nbsp;is&nbsp;easy&nbsp;-&nbsp;I&nbsp;can&nbsp;mock&nbsp;task.LoopingCall&nbsp;and&nbsp;check&nbsp;if&nbsp;it&nbsp;was&nbsp;called&nbsp;with&nbsp;correct&nbsp;attributes.&lt;br&gt;&lt;br&gt;I&#39;ve&nbsp;got&nbsp;trouble&nbsp;testing&nbsp;check_old_sessions.&nbsp;Since&nbsp;I&#39;m&nbsp;writing&nbsp;unit&nbsp;tests&nbsp;I&nbsp;don&#39;t&nbsp;want&nbsp;to&nbsp;call&nbsp;real&nbsp;session_db&nbsp;methods&nbsp;and&nbsp;make&nbsp;real&nbsp;Redis&nbsp;queries.&nbsp;I&#39;d&nbsp;like&nbsp;to&nbsp;mock&nbsp;them&nbsp;and&nbsp;test&nbsp;just&nbsp;few&nbsp;things:&lt;br&gt;-&nbsp;is&nbsp;the&nbsp;method&nbsp;get_old_sessions&nbsp;called?&lt;br&gt;-&nbsp;is&nbsp;the&nbsp;method&nbsp;process_stopped&nbsp;called&nbsp;N&nbsp;times&nbsp;with&nbsp;the&nbsp;arguments&nbsp;returned&nbsp;by&nbsp;mocked&nbsp;get_old_sessions?&lt;br&gt;-&nbsp;is&nbsp;txredisapi.ConnectionError&nbsp;handled&nbsp;correctly?&lt;br&gt;&lt;br&gt;So&nbsp;is&nbsp;there&nbsp;any&nbsp;&quot;right&quot;&nbsp;way&nbsp;of&nbsp;mocking&nbsp;functions&nbsp;which&nbsp;returns&nbsp;deferreds?&nbsp;Or&nbsp;maybe&nbsp;I&nbsp;should&nbsp;test&nbsp;this&nbsp;method&nbsp;differently?&lt;br&gt;&lt;br&gt;Best&nbsp;regards,&lt;/div&gt;&lt;div&nbsp;style=&quot;font-size:12.8000001907349px&quot;&gt;Patryk&lt;/div&gt;&lt;/div&gt;<br>

</tt>
