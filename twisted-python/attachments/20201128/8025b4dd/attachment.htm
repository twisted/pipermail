<tt>
&lt;html&gt;&lt;head&gt;&lt;meta&nbsp;http-equiv=&quot;Content-Type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=us-ascii&quot;&gt;&lt;/head&gt;&lt;body&nbsp;style=&quot;word-wrap:&nbsp;break-word;&nbsp;-webkit-nbsp-mode:&nbsp;space;&nbsp;line-break:&nbsp;after-white-space;&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;Oct&nbsp;21,&nbsp;2020,&nbsp;at&nbsp;10:34&nbsp;AM,&nbsp;Jonathan&nbsp;Bastien-Filiatrault&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:joe@x2a.org&quot;&nbsp;class=&quot;&quot;&gt;joe@x2a.org&lt;/a&gt;&gt;&nbsp;wrote:&lt;/div&gt;&lt;br&nbsp;class=&quot;Apple-interchange-newline&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;On&nbsp;2020-10-20&nbsp;04&nbsp;h&nbsp;57,&nbsp;adi&nbsp;at&nbsp;&lt;a&nbsp;href=&quot;http://roiban.ro&quot;&nbsp;class=&quot;&quot;&gt;roiban.ro&lt;/a&gt;&nbsp;(Adi&nbsp;Roiban)&nbsp;wrote:&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;Just&nbsp;my&nbsp;2&nbsp;cents&lt;br&nbsp;class=&quot;&quot;&gt;I&nbsp;think&nbsp;that&nbsp;whether&nbsp;this&nbsp;should&nbsp;be&nbsp;reverted&nbsp;or&nbsp;reworked&nbsp;should&nbsp;be&nbsp;between&lt;br&nbsp;class=&quot;&quot;&gt;the&nbsp;person&nbsp;raising&nbsp;this&nbsp;issue&nbsp;(Glyph)&nbsp;and&nbsp;the&nbsp;author&nbsp;of&nbsp;the&nbsp;PR&nbsp;(Jonathan).&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;Glyph&nbsp;has&nbsp;asked&nbsp;me&nbsp;to&nbsp;submit&nbsp;the&nbsp;type&nbsp;annotation&nbsp;work&nbsp;on&nbsp;AMP,&nbsp;I&nbsp;will&nbsp;do&lt;br&nbsp;class=&quot;&quot;&gt;this.&nbsp;I&nbsp;also&nbsp;plan&nbsp;on&nbsp;resubmitting&nbsp;a&nbsp;reworked&nbsp;patch&nbsp;that&nbsp;addresses&nbsp;the&lt;br&nbsp;class=&quot;&quot;&gt;issues&nbsp;that&nbsp;glyph&nbsp;raised.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;I&nbsp;see&nbsp;that&nbsp;Jonathan&nbsp;has&nbsp;responded&nbsp;to&nbsp;the&nbsp;feedback&nbsp;inside&nbsp;the&nbsp;merged&nbsp;PR.I&lt;br&nbsp;class=&quot;&quot;&gt;hope&nbsp;it&nbsp;can&nbsp;be&nbsp;reworked.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Since&nbsp;AMP&nbsp;v2&nbsp;is&nbsp;not&nbsp;standardized&nbsp;maybe&nbsp;is&nbsp;ok&nbsp;to&nbsp;have&nbsp;it&nbsp;as&nbsp;a&nbsp;separate&lt;br&nbsp;class=&quot;&quot;&gt;experimental&nbsp;top&nbsp;level&nbsp;name.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;I&nbsp;have&nbsp;never&nbsp;used&nbsp;AMP&nbsp;...I&nbsp;tried&nbsp;to&nbsp;use&nbsp;it&nbsp;via&nbsp;ampoule&nbsp;but&nbsp;ended&nbsp;up&nbsp;using&lt;br&nbsp;class=&quot;&quot;&gt;the&nbsp;stdlib&nbsp;process&nbsp;pool&nbsp;as&nbsp;I&nbsp;was&nbsp;not&nbsp;able&nbsp;see&nbsp;any&nbsp;performance&nbsp;difference.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Since&nbsp;`amp`&nbsp;is&nbsp;used&nbsp;by&nbsp;`trial&nbsp;-j`&nbsp;&nbsp;we&nbsp;need&nbsp;to&nbsp;keep&nbsp;it&nbsp;inside&nbsp;twisted.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;But&nbsp;since&nbsp;AMP&nbsp;v2&nbsp;is&nbsp;experimental,&nbsp;I&nbsp;think&nbsp;that&nbsp;is&nbsp;best&nbsp;to&nbsp;have&nbsp;it&nbsp;as&nbsp;a&lt;br&nbsp;class=&quot;&quot;&gt;separate&nbsp;txamp2&nbsp;project.&lt;br&nbsp;class=&quot;&quot;&gt;In&nbsp;this&nbsp;way,&nbsp;the&nbsp;twisted&nbsp;AMP&nbsp;v2&nbsp;project&nbsp;can&nbsp;follow&nbsp;its&nbsp;own&nbsp;rules.&lt;br&nbsp;class=&quot;&quot;&gt;Once&nbsp;AMP&nbsp;v2&nbsp;is&nbsp;&quot;mature&quot;&nbsp;it&nbsp;can&nbsp;be&nbsp;moved&nbsp;to&nbsp;core&nbsp;twisted&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;So&nbsp;my&nbsp;take&nbsp;is&nbsp;to&nbsp;revert&nbsp;it&nbsp;and&nbsp;move&nbsp;it&nbsp;to&nbsp;twisted/txamp2.&lt;/blockquote&gt;&lt;br&nbsp;class=&quot;&quot;&gt;I&nbsp;have&nbsp;no&nbsp;issue&nbsp;with&nbsp;changing&nbsp;the&nbsp;name&nbsp;or&nbsp;if&nbsp;this&nbsp;patch&nbsp;lives&nbsp;as&nbsp;a&lt;br&nbsp;class=&quot;&quot;&gt;project&nbsp;besides&nbsp;twisted.&nbsp;I&nbsp;might&nbsp;even&nbsp;rework&nbsp;it&nbsp;into&nbsp;something&nbsp;more&lt;br&nbsp;class=&quot;&quot;&gt;forward-compatible&nbsp;as&nbsp;suggested&nbsp;by&nbsp;glyph.&nbsp;I&nbsp;think&nbsp;netstrings&nbsp;are&nbsp;a&lt;br&nbsp;class=&quot;&quot;&gt;decent&nbsp;option&nbsp;as&nbsp;it&nbsp;would&nbsp;make&nbsp;long&nbsp;value&nbsp;handling&nbsp;easier&nbsp;since&nbsp;values&lt;br&nbsp;class=&quot;&quot;&gt;would&nbsp;always&nbsp;be&nbsp;contiguous&nbsp;without&nbsp;&quot;continuation&nbsp;markers&quot;&nbsp;interspersed.&lt;br&nbsp;class=&quot;&quot;&gt;The&nbsp;main&nbsp;thing&nbsp;I&nbsp;dislike&nbsp;about&nbsp;netstrings&nbsp;are&nbsp;the&nbsp;variable-length&nbsp;ASCII&lt;br&nbsp;class=&quot;&quot;&gt;numbers,&nbsp;but&nbsp;that&nbsp;is&nbsp;not&nbsp;a&nbsp;big&nbsp;complexity.&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;originally&nbsp;didn't&nbsp;like&nbsp;this&nbsp;either,&nbsp;but&nbsp;since&nbsp;I&nbsp;designed&nbsp;AMP&nbsp;I've&nbsp;come&nbsp;around:&lt;/div&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;thing&nbsp;about&nbsp;variable-length&nbsp;ASCII&nbsp;numbers&nbsp;is&nbsp;that&nbsp;they&nbsp;give&nbsp;you&nbsp;a&nbsp;lot&nbsp;of&nbsp;leeway&nbsp;to&nbsp;error&nbsp;out&nbsp;in&nbsp;case&nbsp;the&nbsp;protocol&nbsp;is&nbsp;not&nbsp;being&nbsp;respected.&nbsp;&nbsp;With&nbsp;packed&nbsp;binary&nbsp;values,&nbsp;any&nbsp;2-byte&nbsp;sequence&nbsp;is&nbsp;a&nbsp;valid&nbsp;length,&nbsp;so&nbsp;if&nbsp;something&nbsp;opens&nbsp;a&nbsp;socket&nbsp;and&nbsp;says&nbsp;&quot;EHLO&quot;,&nbsp;it&nbsp;starts&nbsp;waiting&nbsp;for&nbsp;17734&nbsp;more&nbsp;bytes&nbsp;which&nbsp;it&nbsp;will&nbsp;never&nbsp;receive.&nbsp;&nbsp;By&nbsp;contrast,&nbsp;netstrings&nbsp;have&nbsp;built-in&nbsp;redudancy;&nbsp;for&nbsp;a&nbsp;very&nbsp;low&nbsp;overhead&nbsp;(most&nbsp;length&nbsp;prefixes&nbsp;end&nbsp;up&nbsp;being&nbsp;2-3&nbsp;bytes&nbsp;rather&nbsp;than&nbsp;2)&nbsp;you&nbsp;get&nbsp;the&nbsp;ability&nbsp;to&nbsp;&lt;i&nbsp;class=&quot;&quot;&gt;immediately&lt;/i&gt;&nbsp;error&nbsp;out&nbsp;with&nbsp;a&nbsp;clear&nbsp;exception&nbsp;as&nbsp;soon&nbsp;as&nbsp;you&nbsp;see&nbsp;&quot;E&quot;.&nbsp;&nbsp;Anyone&nbsp;implementing&nbsp;this&nbsp;in&nbsp;a&nbsp;static&nbsp;context&nbsp;where&nbsp;they&nbsp;don't&nbsp;want&nbsp;heap&nbsp;allocations&nbsp;for&nbsp;the&nbsp;length&nbsp;prefix&nbsp;itself&nbsp;should&nbsp;not&nbsp;allocate&nbsp;arbitrary&nbsp;data,&nbsp;but&nbsp;rather,&nbsp;allocate&nbsp;a&nbsp;very&nbsp;small&nbsp;fixed&nbsp;buffer&nbsp;(6&nbsp;bytes&nbsp;will&nbsp;get&nbsp;you&nbsp;considerably&nbsp;beyond&nbsp;the&nbsp;built-in&nbsp;limitations&nbsp;of&nbsp;AMP&nbsp;already)&nbsp;and&nbsp;again,&nbsp;immediately&nbsp;error&nbsp;out&nbsp;if&nbsp;that&nbsp;is&nbsp;exceeded.&nbsp;&nbsp;Similarly&nbsp;the&nbsp;trailing&nbsp;comma&nbsp;provides&nbsp;an&nbsp;in-band&nbsp;sanity&nbsp;check&nbsp;where&nbsp;buggy&nbsp;applications&nbsp;will&nbsp;promptly&nbsp;crash&nbsp;rather&nbsp;than&nbsp;bleeding&nbsp;into&nbsp;the&nbsp;next&nbsp;message.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Could&nbsp;the&nbsp;next&nbsp;AMP&nbsp;version&lt;br&nbsp;class=&quot;&quot;&gt;use&nbsp;values&nbsp;framed&nbsp;using&nbsp;32&nbsp;bit&nbsp;or&nbsp;64&nbsp;bit&nbsp;integers&nbsp;?&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;I'd&nbsp;really&nbsp;rather&nbsp;go&nbsp;with&nbsp;netstrings&nbsp;for&nbsp;all&nbsp;the&nbsp;reasons&nbsp;listed&nbsp;above.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Transmitting&nbsp;long-ish&nbsp;values&nbsp;is&nbsp;a&nbsp;real&nbsp;use&nbsp;case&nbsp;and&nbsp;whatever&nbsp;extension&lt;br&nbsp;class=&quot;&quot;&gt;we&nbsp;do&nbsp;must&nbsp;retain&nbsp;the&nbsp;dead-simple,&nbsp;easy&nbsp;to&nbsp;implement&nbsp;nature&nbsp;of&nbsp;the&lt;br&nbsp;class=&quot;&quot;&gt;current&nbsp;AMP&nbsp;protocol.&nbsp;I&nbsp;now&nbsp;realise&nbsp;that&nbsp;I&nbsp;somewhat&nbsp;hijacked&nbsp;the&lt;br&nbsp;class=&quot;&quot;&gt;&quot;streaming&nbsp;values&quot;&nbsp;bug&nbsp;(2529).&nbsp;IMHO,&nbsp;streaming&nbsp;should&nbsp;be&nbsp;handled&nbsp;at&nbsp;the&lt;br&nbsp;class=&quot;&quot;&gt;application&nbsp;level,&nbsp;but&nbsp;I&nbsp;digress.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&gt;Yeah,&nbsp;that&nbsp;bug&nbsp;is&nbsp;more&nbsp;about&nbsp;making&nbsp;it&nbsp;easy&nbsp;to&nbsp;do&nbsp;the&nbsp;application-level&nbsp;stuff&nbsp;than&nbsp;implementing&nbsp;something&nbsp;implicit&nbsp;within&nbsp;the&nbsp;protocol.&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&nbsp;class=&quot;&quot;&gt;----&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;BTW&nbsp;this&nbsp;is&nbsp;also&nbsp;my&nbsp;suggestion&nbsp;for&nbsp;the&nbsp;PR&nbsp;trying&nbsp;to&nbsp;introduce&nbsp;support&nbsp;for&lt;br&nbsp;class=&quot;&quot;&gt;SMB....&nbsp;have&nbsp;twisted&nbsp;SMB&nbsp;implementation&nbsp;in&nbsp;a&nbsp;separate&nbsp;project.&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/blockquote&gt;All&nbsp;the&nbsp;best,&lt;br&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;Jonathan&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;div&nbsp;class=&quot;&quot;&gt;Same&nbsp;to&nbsp;you.&nbsp;&nbsp;Thanks&nbsp;for&nbsp;your&nbsp;contributions,&nbsp;and&nbsp;sorry&nbsp;for&nbsp;the&nbsp;slow&nbsp;pace&nbsp;of&nbsp;communication&nbsp;here;&nbsp;2020&nbsp;is&nbsp;a&nbsp;heck&nbsp;of&nbsp;a&nbsp;year.&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;&lt;br&nbsp;class=&quot;&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;&quot;&gt;-g&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
</tt>
