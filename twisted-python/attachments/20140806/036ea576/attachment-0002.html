<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Hello,&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;I&nbsp;have&nbsp;been&nbsp;trying&nbsp;to&nbsp;create&nbsp;a&nbsp;widget&nbsp;that&nbsp;encloses&nbsp;manhole&nbsp;interpreter.&nbsp;Here&nbsp;is&nbsp;somewhat&nbsp;hacky&nbsp;implementation&nbsp;that&nbsp;I&nbsp;came&nbsp;up&nbsp;with&nbsp;at&nbsp;this&nbsp;moment:&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt; &nbsp;1&nbsp;from&nbsp;twisted.conch.insults&nbsp;import&nbsp;insults&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp;2&nbsp;from&nbsp;twisted.conch.insults&nbsp;import&nbsp;window&lt;/div&gt;&lt;div&gt; &nbsp;3&nbsp;from&nbsp;twisted.conch.insults&nbsp;import&nbsp;helper&lt;/div&gt;&lt;div&gt; &nbsp;4&nbsp;from&nbsp;twisted.conch&nbsp;import&nbsp;manhole &lt;/div&gt;&lt;div&gt; &nbsp;5 &lt;/div&gt;&lt;div&gt; &nbsp;6 &lt;/div&gt;&lt;div&gt; &nbsp;7&nbsp;class&nbsp;TerminalBufferLastWrite(helper.TerminalBuffer):&lt;/div&gt;<br>
<br>
&lt;div&gt; &nbsp;8 &lt;/div&gt;&lt;div&gt; &nbsp;9&nbsp; &nbsp; &nbsp;lastWrite&nbsp;=&nbsp;&#39;&#39;&lt;/div&gt;&lt;div&gt; 10&nbsp; &nbsp;  &lt;/div&gt;&lt;div&gt; 11&nbsp; &nbsp; &nbsp;def&nbsp;write(self,&nbsp;bytes):&lt;/div&gt;&lt;div&gt; 12&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.lastWrite&nbsp;=&nbsp;bytes&lt;/div&gt;&lt;div&gt; 13&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;helper.TerminalBuffer.write(self,&nbsp;bytes)&lt;/div&gt;<br>
<br>
&lt;div&gt; 14&nbsp; &nbsp; &nbsp; &nbsp;  &lt;/div&gt;&lt;div&gt; 15&nbsp;for&nbsp;name,&nbsp;const&nbsp;in&nbsp;zip(insults._KEY_NAMES,&nbsp;insults.FUNCTION_KEYS):&lt;/div&gt;&lt;div&gt; 16&nbsp; &nbsp; &nbsp;setattr(TerminalBufferLastWrite,&nbsp;name,&nbsp;const)&lt;/div&gt;&lt;div&gt; 17&nbsp; &nbsp;  &lt;/div&gt;&lt;div&gt; 18 &lt;/div&gt;&lt;div&gt; 19&nbsp;class&nbsp;ManholeWidget(window.Widget):&lt;/div&gt;<br>
<br>
&lt;div&gt; 20 &lt;/div&gt;&lt;div&gt; 21&nbsp; &nbsp; &nbsp;def&nbsp;__init__(self,&nbsp;namespace,&nbsp;width,&nbsp;height):&lt;/div&gt;&lt;div&gt; 22&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._buf&nbsp;=&nbsp;TerminalBufferLastWrite()&lt;/div&gt;&lt;div&gt; 23&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._buf.width&nbsp;=&nbsp;width&lt;/div&gt;&lt;div&gt; 24&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._buf.height&nbsp;=&nbsp;height&lt;/div&gt;<br>
<br>
&lt;div&gt; 25&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self._buf.connectionMade()&lt;/div&gt;&lt;div&gt; 26&nbsp; &nbsp; &nbsp; &nbsp;  &lt;/div&gt;&lt;div&gt; 27&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.manholeProto&nbsp;=&nbsp;manhole.Manhole(namespace)&lt;/div&gt;&lt;div&gt; 28&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.manholeProto.makeConnection(self._buf)&lt;/div&gt;&lt;div&gt; 29&nbsp; &nbsp; &nbsp; &nbsp;  &lt;/div&gt;<br>
<br>
&lt;div&gt; 30&nbsp; &nbsp; &nbsp;def&nbsp;keystrokeReceived(self,&nbsp;keyID,&nbsp;modifier):&lt;/div&gt;&lt;div&gt; 31&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;super(ManholeWidget,&nbsp;self).keystrokeReceived(keyID,&nbsp;modifier)&lt;/div&gt;&lt;div&gt; 32&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.manholeProto.keystrokeReceived(keyID,&nbsp;modifier)&lt;/div&gt;<br>
<br>
&lt;div&gt; 33&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.repaint()&lt;/div&gt;&lt;div&gt; 34&nbsp; &nbsp; &nbsp; &nbsp;  &lt;/div&gt;&lt;div&gt; 35&nbsp; &nbsp; &nbsp;def&nbsp;render(self,&nbsp;width,&nbsp;height,&nbsp;terminal):&lt;/div&gt;&lt;div&gt; 36&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for&nbsp;y,&nbsp;line&nbsp;in&nbsp;enumerate(self._buf.lines[0:height]):&lt;/div&gt;&lt;div&gt; 37&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;terminal.cursorPosition(0,&nbsp;y)&lt;/div&gt;<br>
<br>
&lt;div&gt; 38&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;n&nbsp;=&nbsp;0&lt;/div&gt;&lt;div&gt; 39&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;for&nbsp;n,&nbsp;(ch,&nbsp;attr)&nbsp;in&nbsp;enumerate(line[0:width]):&lt;/div&gt;&lt;div&gt; 40&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;ch&nbsp;is&nbsp;self._buf.void:&lt;/div&gt;&lt;div&gt; 41&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ch&nbsp;=&nbsp;&#39;&nbsp;&#39;&lt;/div&gt;&lt;div&gt; 42&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;else:&lt;/div&gt;<br>
<br>
&lt;div&gt; 43&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cursorRow&nbsp;=&nbsp;y&lt;/div&gt;&lt;div&gt; 44&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;terminal.write(ch)&lt;/div&gt;&lt;div&gt; 45&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;n&nbsp;&lt;&nbsp;width:&lt;/div&gt;&lt;div&gt; 46&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;terminal.write(&#39;&nbsp;&#39;&nbsp;*&nbsp;(width&nbsp;-&nbsp;n&nbsp;-&nbsp;1))&lt;/div&gt;&lt;div&gt;<br>
<br>
 47&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;terminal.cursorPosition(self.manholeProto.lineBufferIndex&nbsp;+&nbsp;4,&lt;/div&gt;&lt;div&gt; 48&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cursorRow)&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Basically,&nbsp;I&nbsp;substitute&nbsp;real&nbsp;terminal&nbsp;(`insults.ServerProtocol`)&nbsp;with&nbsp;slightly&nbsp;extended&nbsp;`TerminalBuffer`,&nbsp;which&nbsp;is&nbsp;used&nbsp;by&nbsp;manhole&nbsp;interpreter&nbsp;to&nbsp;write&nbsp;its&nbsp;output.&nbsp;`ManholeWidget.render`&nbsp;method&nbsp;is&nbsp;almost&nbsp;entirely&nbsp;reuses&nbsp;code&nbsp;from&nbsp;`window.Viewport`.&lt;/div&gt;<br>
<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;This&nbsp;widget&nbsp;appears&nbsp;to&nbsp;work.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;However,&nbsp;here&nbsp;is&nbsp;the&nbsp;problem:&nbsp;if&nbsp;terminal&nbsp;size&nbsp;is&nbsp;large&nbsp;enough&nbsp;(say,&nbsp;200x50),&nbsp;then&nbsp;there&nbsp;are&nbsp;some&nbsp;io&nbsp;lags&nbsp;(similar&nbsp;to&nbsp;ssh&nbsp;session&nbsp;over&nbsp;slow&nbsp;internet&nbsp;connection).&lt;br&gt;<br>
&lt;br&gt;The&nbsp;reason&nbsp;is&nbsp;that&nbsp;on&nbsp;each&nbsp;keystroke,&nbsp;the&nbsp;whole&nbsp;terminal&nbsp;buffer&nbsp;is&nbsp;redrawn.&nbsp;I&nbsp;wonder&nbsp;how&nbsp;I&nbsp;can&nbsp;optimize&nbsp;this.&nbsp;Currently&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;a&nbsp;solution.&nbsp;Also&nbsp;I&nbsp;am&nbsp;wondering&nbsp;if&nbsp;I&nbsp;took&nbsp;right&nbsp;approach&nbsp;to&nbsp;embed&nbsp;manhole&nbsp;interpreter&nbsp;into&nbsp;a&nbsp;widget&nbsp;in&nbsp;the&nbsp;first&nbsp;place,&nbsp;but&nbsp;I&nbsp;don&#39;t&nbsp;see&nbsp;a&nbsp;solution,&nbsp;except&nbsp;using&nbsp;`TerminalBuffer`&nbsp;to&nbsp;capture&nbsp;manhole&nbsp;output.&lt;br&gt;<br>
&lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Thanks.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Regards,&lt;br&gt;Maxim&lt;/div&gt;<br>
&lt;/div&gt;&lt;/div&gt;<br>

</tt>
