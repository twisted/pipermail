<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;Thanks&nbsp;for&nbsp;both&nbsp;those&nbsp;suggestions.&lt;br&gt;I&#39;ll&nbsp;be&nbsp;taking&nbsp;a&nbsp;closer&nbsp;look&nbsp;at&nbsp;txLoadbabancer&nbsp;when&nbsp;I&nbsp;get&nbsp;time&nbsp;as&nbsp;it&nbsp;looks&nbsp;like&nbsp;it&#39;ll&nbsp;take&nbsp;care&nbsp;of&nbsp;a&nbsp;lot&nbsp;of&nbsp;my&nbsp;desired&nbsp;functionality&nbsp;out&nbsp;the&nbsp;box.&lt;br&gt;To&nbsp;get&nbsp;started&nbsp;tho&nbsp;I&#39;ll&nbsp;move&nbsp;my&nbsp;async&nbsp;routing&nbsp;decision&nbsp;call&nbsp;into&nbsp;the&nbsp;protocol&nbsp;as&nbsp;suggested.&lt;br&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;Is&nbsp;there&nbsp;any&nbsp;reason&nbsp;why&nbsp;the&nbsp;internal&nbsp;calls&nbsp;to&nbsp;buildProtocol&nbsp;shouldn&#39;t&nbsp;be&nbsp;wrapped&nbsp;in&nbsp;a&nbsp;maybeDeferred?&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Sat,&nbsp;Nov&nbsp;16,&nbsp;2013&nbsp;at&nbsp;7:05&nbsp;PM,&nbsp;Lucas&nbsp;Taylor&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:ltaylor.volks@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;ltaylor.volks@gmail.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;<br>
&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;style=&quot;word-wrap:break-word&quot;&gt;&lt;br&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;im&quot;&gt;&lt;div&gt;On&nbsp;Nov&nbsp;16,&nbsp;2013,&nbsp;at&nbsp;7:09&nbsp;AM,&nbsp;Tom&nbsp;van&nbsp;Neerijnen&nbsp;wrote:&lt;/div&gt;<br>
&lt;br&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;div&gt;Hi&nbsp;all&lt;br&gt;&lt;br&gt;&lt;/div&gt;I&#39;m&nbsp;building&nbsp;a&nbsp;simple&nbsp;TCP&nbsp;load&nbsp;balancer&nbsp;based&nbsp;on&nbsp;a&nbsp;code&nbsp;snippet&nbsp;from&nbsp;Glyph&nbsp;on&nbsp;SO:&nbsp;&lt;a&nbsp;href=&quot;http://stackoverflow.com/questions/4096061/general-question-regarding-wether-or-not-use-twisted-in-tcp-proxy-project&quot;&nbsp;target=&quot;_blank&quot;&gt;http://stackoverflow.com/questions/4096061/general-question-regarding-wether-or-not-use-twisted-in-tcp-proxy-project&lt;/a&gt;&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;It&#39;s&nbsp;served&nbsp;me&nbsp;well&nbsp;but&nbsp;I&nbsp;can&#39;t&nbsp;work&nbsp;out&nbsp;how&nbsp;to&nbsp;convert&nbsp;Glyphs&nbsp;round&nbsp;robin&nbsp;retrieval&nbsp;of&nbsp;the&nbsp;server&nbsp;endpoint&nbsp;into&nbsp;an&nbsp;async&nbsp;balancing&nbsp;decision&nbsp;in&nbsp;the&nbsp;buildProtocol&nbsp;method&nbsp;of&nbsp;the&nbsp;Factory.&nbsp;If&nbsp;I&nbsp;return&nbsp;a&nbsp;deferred&nbsp;here&nbsp;it&nbsp;fails&nbsp;with&nbsp;an&nbsp;AttributeError:&nbsp;Deferred&nbsp;instance&nbsp;has&nbsp;no&nbsp;attribute&nbsp;&#39;makeConnection&#39;.&lt;br&gt;<br>
<br>
&lt;br&gt;Currently&nbsp;I&#39;m&nbsp;working&nbsp;around&nbsp;this&nbsp;by&nbsp;running&nbsp;a&nbsp;separate&nbsp;management&nbsp;loop&nbsp;that&nbsp;periodically&nbsp;updates&nbsp;a&nbsp;dictionary&nbsp;with&nbsp;all&nbsp;the&nbsp;data&nbsp;necessary&nbsp;to&nbsp;make&nbsp;my&nbsp;routing&nbsp;decision&nbsp;so&nbsp;that&nbsp;I&nbsp;can&nbsp;do&nbsp;it&nbsp;without&nbsp;a&nbsp;deferred.&nbsp;This&nbsp;worries&nbsp;me&nbsp;because&nbsp;I&nbsp;may&nbsp;be&nbsp;making&nbsp;my&nbsp;decision&nbsp;on&nbsp;slightly&nbsp;stale&nbsp;data&nbsp;and&nbsp;I&#39;d&nbsp;really&nbsp;like&nbsp;this&nbsp;to&nbsp;be&nbsp;a&nbsp;real&nbsp;time&nbsp;decision&nbsp;as&nbsp;the&nbsp;connection&nbsp;comes&nbsp;in.&nbsp;Does&nbsp;anyone&nbsp;have&nbsp;a&nbsp;clever&nbsp;way&nbsp;of&nbsp;doing&nbsp;this?&lt;br&gt;<br>
<br>
&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;Hi&nbsp;Tom,&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;One&nbsp;possibly&nbsp;unexpected&nbsp;aspect&nbsp;of&nbsp;using&nbsp;@inlineCallbacks&nbsp;is&nbsp;that&nbsp;the&nbsp;decorated&nbsp;function&nbsp;itself&nbsp;returns&nbsp;a&nbsp;Deferred.&nbsp;This&nbsp;is&nbsp;why&nbsp;you&nbsp;see&nbsp;the&nbsp;AttributeError...the&nbsp;machinery&nbsp;calling&nbsp;buildProtocol&nbsp;expects&nbsp;an&nbsp;IProtocol&nbsp;instance&nbsp;(or&nbsp;None),&nbsp;and&nbsp;the&nbsp;function&nbsp;is&nbsp;returning&nbsp;a&nbsp;Deferred.&nbsp; &nbsp;`defer.returnValue()`&nbsp;is&nbsp;provided&nbsp;to&nbsp;the&nbsp;callback&nbsp;on&nbsp;that&nbsp;Deferred,&nbsp;not&nbsp;as&nbsp;a&nbsp;direct&nbsp;return&nbsp;value&nbsp;from&nbsp;the&nbsp;decorated&nbsp;function.&lt;/div&gt;<br>
&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;you&nbsp;want&nbsp;to&nbsp;make&nbsp;the&nbsp;routing&nbsp;decision&nbsp;when&nbsp;the&nbsp;client&nbsp;connects,&nbsp;then&nbsp;you&nbsp;could&nbsp;push&nbsp;the&nbsp;decision-making&nbsp;process&nbsp;down&nbsp;into&nbsp;the&nbsp;Protocol&nbsp;itself.&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Here&#39;s&nbsp;a&nbsp;quick&nbsp;mockup&nbsp;overriding&nbsp;connectionMade&nbsp;in&nbsp;a&nbsp;ProxyServer&nbsp;protocol&nbsp;subclass.&nbsp;It&nbsp;calls&nbsp;the&nbsp;factory&nbsp;routing&nbsp;function&nbsp;(which&nbsp;may&nbsp;or&nbsp;may&nbsp;not&nbsp;return&nbsp;a&nbsp;deferred),&nbsp;and&nbsp;connects&nbsp;the&nbsp;proxy&nbsp;once&nbsp;the&nbsp;decision&nbsp;has&nbsp;been&nbsp;made.&lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;from&nbsp;twisted.internet.protocol&nbsp;import&nbsp;Factory&lt;/div&gt;&lt;div&gt;from&nbsp;twisted.protocols.portforward&nbsp;import&nbsp;ProxyServer&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;div&gt;class&nbsp;Balancer(Factory):&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp;protocol&nbsp;=&nbsp;RoutingProxyServer&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;routing_func&nbsp;=&nbsp;port_routing_decision_async&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;class&nbsp;RoutingProxyServer(ProxyServer):&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp;def&nbsp;connectionMade(self):&lt;/div&gt;<br>
&lt;div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;Don&#39;t&nbsp;read&nbsp;anything&nbsp;from&nbsp;the&nbsp;connecting&nbsp;client&nbsp;until&nbsp;we&nbsp;have&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;#&nbsp;somewhere&nbsp;to&nbsp;send&nbsp;it&nbsp;to.&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;self.transport.pauseProducing()&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;client&nbsp;=&nbsp;self.clientProtocolFactory()&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;client.setServer(self)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp;  &lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;if&nbsp;self.reactor&nbsp;is&nbsp;None:&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;from&nbsp;twisted.internet&nbsp;import&nbsp;reactor&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.reactor&nbsp;=&nbsp;reactor&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp;  &lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;def&nbsp;connectProxy(host,&nbsp;port):&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;self.reactor.connectTCP(host,&nbsp;port,&nbsp;client)&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;d&nbsp;=&nbsp;maybeDeferred(self.factory.routing_func)&lt;/div&gt;&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;d.addCallback(connectProxy)&lt;/div&gt;<br>
&lt;div&gt; &nbsp; &nbsp; &nbsp; &nbsp;d.addErrback(log.err)&lt;/div&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;/div&gt;&lt;span&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;font&nbsp;color=&quot;#888888&quot;&gt;&lt;div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Lucas&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;<br>
&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;/font&gt;&lt;/span&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;&lt;blockquote&nbsp;type=&quot;cite&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;An&nbsp;example&nbsp;is&nbsp;below.&nbsp;The&nbsp;hashed&nbsp;out&nbsp;buildProtocol&nbsp;is&nbsp;a&nbsp;synchronous&nbsp;decision&nbsp;which&nbsp;works.&nbsp;Thanks&nbsp;in&nbsp;advance!&lt;br&gt;<br>
&lt;br&gt;from&nbsp;twisted.internet.protocol&nbsp;import&nbsp;Factory&lt;br&gt;from&nbsp;twisted.protocols.portforward&nbsp;import&nbsp;ProxyFactory&lt;br&gt;<br>
from&nbsp;twisted.internet&nbsp;import&nbsp;reactor,&nbsp;defer&lt;br&gt;import&nbsp;random&lt;br&gt;&lt;br&gt;from&nbsp;twisted.python&nbsp;import&nbsp;log&lt;br&gt;import&nbsp;sys&lt;br&gt;log.startLogging(sys.stderr)&lt;br&gt;&lt;br&gt;local_ports&nbsp;=&nbsp;set([1024,&nbsp;1025])&lt;br&gt;&lt;br&gt;def&nbsp;port_routing_decision_sync():&lt;br&gt;<br>
<br>
   &nbsp;return&nbsp;random.choice(list(local_ports))&lt;br&gt;&lt;br&gt;def&nbsp;port_routing_decision_async():&lt;br&gt;   &nbsp;d&nbsp;=&nbsp;defer.Deferred()&lt;br&gt;   &nbsp;reactor.callLater(1,&nbsp;d.callback,&nbsp;port_routing_decision_sync())&lt;br&gt;   &nbsp;return&nbsp;d&lt;br&gt;&lt;br&gt;class&nbsp;Balancer(Factory):&lt;br&gt;<br>
<br>
   &nbsp;#&nbsp;def&nbsp;buildProtocol(self,&nbsp;addr):&lt;br&gt;   &nbsp;#    &nbsp;port&nbsp;=&nbsp;port_routing_decision_sync()&lt;br&gt;   &nbsp;#    &nbsp;print&nbsp;&quot;connecting&nbsp;to&nbsp;local&nbsp;port&nbsp;{}&quot;.format(port)&lt;br&gt;   &nbsp;#    &nbsp;return&nbsp;ProxyFactory(&quot;127.0.0.1&quot;,&nbsp;port).buildProtocol(addr)&lt;br&gt;<br>
<br>
&lt;br&gt;   &nbsp;@defer.inlineCallbacks&lt;br&gt;   &nbsp;def&nbsp;buildProtocol(self,&nbsp;addr):&lt;br&gt;       &nbsp;port&nbsp;=&nbsp;yield&nbsp;port_routing_decision_async()&lt;br&gt;       &nbsp;print&nbsp;&quot;connecting&nbsp;to&nbsp;local&nbsp;port&nbsp;{}&quot;.format(port)&lt;br&gt;       &nbsp;defer.returnValue(ProxyFactory(&quot;127.0.0.1&quot;,&nbsp;port).buildProtocol(addr))&lt;br&gt;<br>
<br>
&lt;br&gt;def&nbsp;main():&lt;br&gt;   &nbsp;factory&nbsp;=&nbsp;Balancer()&lt;br&gt;   &nbsp;reactor.listenTCP(5678,&nbsp;factory)&lt;br&gt;   &nbsp;reactor.run()&lt;br&gt;&lt;br&gt;if&nbsp;__name__&nbsp;==&nbsp;&quot;__main__&quot;:&lt;br&gt;   &nbsp;main()&lt;br&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;&lt;br&gt;_______________________________________________&lt;br&gt;<br>
<br>
Twisted-Python&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-Python@twistedmatrix.com&quot;&gt;Twisted-Python@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&quot;&nbsp;target=&quot;_blank&quot;&gt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python&lt;/a&gt;&lt;br&gt;<br>
&lt;br&gt;&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;/div&gt;<br>

</tt>
