<tt>
&lt;html&gt;<br>
&nbsp;&nbsp;&lt;head&gt;<br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;&nbsp;charset=ISO-8859-1&quot;&gt;<br>
&nbsp;&nbsp;&lt;/head&gt;<br>
&nbsp;&nbsp;&lt;body&nbsp;text=&quot;#000000&quot;&nbsp;bgcolor=&quot;#FFFFFF&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;We're&nbsp;writing&nbsp;a&nbsp;Twisted&nbsp;14.0.0&nbsp;application&nbsp;(on&nbsp;Python&nbsp;2.7.7,&nbsp;Mac&nbsp;OS<br>
&nbsp;&nbsp;&nbsp;&nbsp;10.9.3)&nbsp;that&nbsp;uses&nbsp;Conch&nbsp;as&nbsp;an&nbsp;SSH&nbsp;client;&nbsp;this&nbsp;is&nbsp;working&nbsp;fine.&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;However,&nbsp;we&nbsp;have&nbsp;the&nbsp;requirement&nbsp;that&nbsp;in&nbsp;an&nbsp;advanced&nbsp;mode&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;operation&nbsp;for&nbsp;power&nbsp;users&nbsp;that&nbsp;the&nbsp;application&nbsp;take&nbsp;advantage&nbsp;of<br>
&nbsp;&nbsp;&nbsp;&nbsp;OpenSSH&nbsp;connection&nbsp;multiplexing&nbsp;over&nbsp;an<br>
&nbsp;&nbsp;&nbsp;&nbsp;already-established-by-the-user&nbsp;OpenSSH&nbsp;ControlMaster&nbsp;session&nbsp;(via<br>
&nbsp;&nbsp;&nbsp;&nbsp;an&nbsp;OpenSSH&nbsp;ControlPath&nbsp;socket)&nbsp;instead&nbsp;of&nbsp;using&nbsp;Conch.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;OpenSSH&nbsp;requires&nbsp;its&nbsp;new&nbsp;session&nbsp;command&nbsp;and&nbsp;forwarded&nbsp;file<br>
&nbsp;&nbsp;&nbsp;&nbsp;descriptors&nbsp;to&nbsp;be&nbsp;sent&nbsp;over&nbsp;the&nbsp;socket&nbsp;in&nbsp;a&nbsp;very&nbsp;particular&nbsp;way:&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;command&nbsp;must&nbsp;be&nbsp;sent&nbsp;first,&nbsp;followed&nbsp;by&nbsp;message&nbsp;with&nbsp;a&nbsp;'\0'&nbsp;byte<br>
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;each&nbsp;forwarded&nbsp;file&nbsp;descriptor.&nbsp;&nbsp;OpenSSH&nbsp;ignores&nbsp;the&nbsp;'\0'&nbsp;for<br>
&nbsp;&nbsp;&nbsp;&nbsp;each&nbsp;file&nbsp;descriptor,&nbsp;extracting&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;themselves<br>
&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;the&nbsp;message's&nbsp;ancillary&nbsp;data.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;The&nbsp;following&nbsp;will&nbsp;not&nbsp;work&nbsp;because&nbsp;none&nbsp;of&nbsp;the&nbsp;calls&nbsp;to&nbsp;write()<br>
&nbsp;&nbsp;&nbsp;&nbsp;send&nbsp;their&nbsp;data&nbsp;until&nbsp;control&nbsp;is&nbsp;returned&nbsp;to&nbsp;the&nbsp;reactor,&nbsp;while<br>
&nbsp;&nbsp;&nbsp;&nbsp;sendFileDescriptor()&nbsp;queues&nbsp;up&nbsp;the&nbsp;descriptors&nbsp;such&nbsp;that&nbsp;they&nbsp;get<br>
&nbsp;&nbsp;&nbsp;&nbsp;sent&nbsp;them&nbsp;with&nbsp;the&nbsp;very&nbsp;next&nbsp;data&nbsp;that&nbsp;is&nbsp;sent&nbsp;--&nbsp;which&nbsp;wind&nbsp;up<br>
&nbsp;&nbsp;&nbsp;&nbsp;being&nbsp;the&nbsp;first&nbsp;three&nbsp;bytes&nbsp;of&nbsp;the&nbsp;command&nbsp;rather&nbsp;than&nbsp;the&nbsp;three<br>
&nbsp;&nbsp;&nbsp;&nbsp;'\0'&nbsp;bytes.&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&gt;class&nbsp;OpenSSHMuxProtocol(&nbsp;protocol.Protocol&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;built&nbsp;via&nbsp;reactor.connectUNIX()<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;sendCommand(&nbsp;self,&nbsp;command&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Does&nbsp;not&nbsp;work:<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.write(&nbsp;command&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.sendFileDescriptor(&nbsp;sys.stdin.fileno()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.write(&nbsp;'\0'&nbsp;)&nbsp;#&nbsp;payload&nbsp;for&nbsp;the&nbsp;stdin&nbsp;file&nbsp;descriptor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.sendFileDescriptor(&nbsp;sys.stdout.fileno()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.write(&nbsp;'\0'&nbsp;)&nbsp;#&nbsp;payload&nbsp;for&nbsp;the&nbsp;stdout&nbsp;file&nbsp;descriptor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.sendFileDescriptor(&nbsp;sys.stdout.fileno()&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.write(&nbsp;'\0'&nbsp;)&nbsp;#&nbsp;payload&nbsp;for&nbsp;the&nbsp;stderr&nbsp;file&nbsp;descriptor<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;^^^&nbsp;Does&nbsp;not&nbsp;work&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;But&nbsp;this&nbsp;next&nbsp;solution&nbsp;&lt;i&gt;does&lt;/i&gt;&nbsp;work:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;charset=ISO-8859-1&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;meta&nbsp;http-equiv=&quot;content-type&quot;&nbsp;content=&quot;text/html;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;charset=ISO-8859-1&quot;&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&gt;from&nbsp;socket&nbsp;import&nbsp;SOL_SOCKET<br>
from&nbsp;twisted.python.sendmsg&nbsp;import&nbsp;SCM_RIGHTS,&nbsp;send1msg<br>
<br>
class&nbsp;OpenSSHMuxProtocol(&nbsp;protocol.Protocol&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;built&nbsp;via&nbsp;reactor.connectUNIX()<br>
&nbsp;&nbsp;&nbsp;&nbsp;def&nbsp;sendCommand(&nbsp;self,&nbsp;command&nbsp;):<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.transport.writeSomeData(&nbsp;command&nbsp;)&nbsp;#&nbsp;data&nbsp;is&nbsp;sent&nbsp;over&nbsp;the&nbsp;socket&nbsp;immediately<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send1msg(&nbsp;self.transport.socket.fileno(),&nbsp;&quot;\0&quot;,&nbsp;0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;(&nbsp;SOL_SOCKET,&nbsp;SCM_RIGHTS,&nbsp;pack(&nbsp;'i',&nbsp;sys.stdin.fileno()&nbsp;)&nbsp;)&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send1msg(&nbsp;self.transport.socket.fileno(),&nbsp;&quot;\0&quot;,&nbsp;0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;(&nbsp;SOL_SOCKET,&nbsp;SCM_RIGHTS,&nbsp;pack(&nbsp;'i',&nbsp;sys.stdout.fileno()&nbsp;)&nbsp;)&nbsp;]&nbsp;)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send1msg(&nbsp;self.transport.socket.fileno(),&nbsp;&quot;\0&quot;,&nbsp;0,<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[&nbsp;(&nbsp;SOL_SOCKET,&nbsp;SCM_RIGHTS,&nbsp;pack(&nbsp;'i',&nbsp;sys.stderr.fileno()&nbsp;)&nbsp;)&nbsp;]&nbsp;)&lt;/pre&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;My&nbsp;questions&nbsp;are:&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Is&nbsp;it&nbsp;bad&nbsp;to&nbsp;bypass&nbsp;the&nbsp;reactor&nbsp;and&nbsp;send&nbsp;data&nbsp;directly/immediately<br>
&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;way&nbsp;using&nbsp;writeSomeData()&nbsp;and&nbsp;send1msg()?&nbsp;&nbsp;Note&nbsp;that<br>
&nbsp;&nbsp;&nbsp;&nbsp;sendCommand()&nbsp;actually&nbsp;gets&nbsp;called&nbsp;in&nbsp;response&nbsp;to&nbsp;a<br>
&nbsp;&nbsp;&nbsp;&nbsp;OpenSSHMuxProtocol.dataReceived()&nbsp;event.&nbsp;&nbsp;If&nbsp;bypassing&nbsp;the&nbsp;reactor<br>
&nbsp;&nbsp;&nbsp;&nbsp;this&nbsp;way&nbsp;is&nbsp;bad,&nbsp;how&nbsp;bad&nbsp;is&nbsp;it&nbsp;and&nbsp;what&nbsp;are&nbsp;the&nbsp;consequences&nbsp;or<br>
&nbsp;&nbsp;&nbsp;&nbsp;effects?&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Is&nbsp;there&nbsp;a&nbsp;better&nbsp;way&nbsp;to&nbsp;get&nbsp;a&nbsp;working&nbsp;solution?&nbsp;&nbsp;I&nbsp;think&nbsp;I'd&nbsp;need<br>
&nbsp;&nbsp;&nbsp;&nbsp;some&nbsp;way&nbsp;to&nbsp;guarantee&nbsp;that&nbsp;the&nbsp;write&nbsp;of&nbsp;the&nbsp;command&nbsp;was&nbsp;actually<br>
&nbsp;&nbsp;&nbsp;&nbsp;sent&nbsp;to&nbsp;the&nbsp;OpenSSH&nbsp;server&nbsp;before&nbsp;the&nbsp;file&nbsp;descriptors&nbsp;are&nbsp;forwarded<br>
&nbsp;&nbsp;&nbsp;&nbsp;--&nbsp;for&nbsp;example,&nbsp;if&nbsp;a&nbsp;Deferred&nbsp;was&nbsp;used&nbsp;whose&nbsp;first&nbsp;callback&nbsp;wrote<br>
&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;command&nbsp;and&nbsp;whose&nbsp;second&nbsp;callback&nbsp;forwarded&nbsp;the&nbsp;descriptors,<br>
&nbsp;&nbsp;&nbsp;&nbsp;would&nbsp;a&nbsp;call&nbsp;to&nbsp;the&nbsp;reactor&nbsp;to&nbsp;actually&nbsp;sent&nbsp;the&nbsp;command&nbsp;be<br>
&nbsp;&nbsp;&nbsp;&nbsp;guaranteed&nbsp;between&nbsp;the&nbsp;two&nbsp;callbacks?&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;Any&nbsp;information&nbsp;and/or&nbsp;advice&nbsp;is&nbsp;appreciated!&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;br&gt;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&lt;pre&nbsp;class=&quot;moz-signature&quot;&nbsp;cols=&quot;72&quot;&gt;--&nbsp;<br>
&nbsp;&nbsp;Mark&nbsp;Montague<br>
&nbsp;&nbsp;&lt;a&nbsp;class=&quot;moz-txt-link-abbreviated&quot;&nbsp;href=&quot;mailto:mark@catseye.org&quot;&gt;mark@catseye.org&lt;/a&gt;&lt;/pre&gt;<br>
&nbsp;&nbsp;&lt;/body&gt;<br>
&lt;/html&gt;<br>

</tt>
