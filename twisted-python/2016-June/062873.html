<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Why deferToThread is so slow?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Why%20deferToThread%20is%20so%20slow%3F&In-Reply-To=%3C57516999.9060009%40fsn.hu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="062871.html">
   <LINK REL="Next"  HREF="062874.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Why deferToThread is so slow?</H1>
    <B>Nagy, Attila</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Why%20deferToThread%20is%20so%20slow%3F&In-Reply-To=%3C57516999.9060009%40fsn.hu%3E"
       TITLE="[Twisted-Python] Why deferToThread is so slow?">bra at fsn.hu
       </A><BR>
    <I>Fri Jun  3 05:27:21 MDT 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="062871.html">[Twisted-Python] Why deferToThread is so slow?
</A></li>
        <LI>Next message (by thread): <A HREF="062874.html">[Twisted-Python] Why deferToThread is so slow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62873">[ date ]</a>
              <a href="thread.html#62873">[ thread ]</a>
              <a href="subject.html#62873">[ subject ]</a>
              <a href="author.html#62873">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06/03/16 10:24, Glyph wrote:
&gt;<i>
</I>&gt;&gt;<i> On Jun 3, 2016, at 01:06, Nagy, Attila &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bra at fsn.hu</A> 
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bra at fsn.hu</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a thread safe synchronous library, which I would like to use 
</I>&gt;&gt;<i> in a threadpool using deferToThread.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Without using (deferTo)threads I get consistent 1-3 ms response 
</I>&gt;&gt;<i> times, with deferring to threadpool, I get 30-300, varying wildly.
</I>&gt;<i>
</I>&gt;<i> Why do you think this is bad performance?
</I>&gt;<i>
</I>&gt;<i> With a direct call, you are doing almost nothing.  Just pushing a 
</I>&gt;<i> stack frame.
</I>&gt;<i>
</I>&gt;<i> With a deferToThread call, you are:
</I>[...]

Sure, this is not the perfect example, I just wanted to measure the 
plain latency which this solution gives.
The whole picture is this:
I have an application which runs in uwsgi in multithreaded mode. It uses 
(the blocking)elasticsearch client.
That app can serve queries with some tens of concurrent requests in 
around 3 ms.

For some reasons I would like to rewrite this app in Twisted. If I use 
the txes2 lib (which is nonblocking), I can achieve around the same 
performance (although it varies a lot more). This is async, no threads 
are involved.

My problem is that this library lacks several features, so I would like 
to use the blocking one, which needs to run in threads.
When I do the requests in threads (with deferToThread, or just 
callInThread the whole handler) the response time is around 10-20 times 
more than uwsgi's threaded and blocking and Twisted's async and becomes 
highly unpredictable.

I haven't looked into the details of Twisted's threadpools, but what I 
would expect here is the same as using a simple python threadpool (like 
something uwsgi does, or just in the standard libraries), which 
according to the results work much faster and predictable than Twisted's.

BTW, I use queues in non-twisted programs and they are nowhere to cause 
several milliseconds(!) of latency.

OK, here's a more realistic example:
<A HREF="https://gist.github.com/bra-fsn/08734197601e5a63d6a2b56d7b048119">https://gist.github.com/bra-fsn/08734197601e5a63d6a2b56d7b048119</A>

This does what is described above: calls an ES query in a Twisted 
threadpool and calls it directly in the thread the whole loop runs.

With one thread the overhead is somewhat acceptable:
deferToThread: avg 2051.00 us, sync: avg 1554.70 us, 1.32x increase
The direct call responds in 1.5 ms, while the deferToThread returns in 2ms.

Things get worse with the concurrency.
With 16 threads the response time is 18 times of the direct call (51 ms 
vs 2.8 ms!):
deferToThread: avg 51515.36 us, sync: avg 2798.19 us, 18.41x increase

With 32 threads:
deferToThread: avg 108222.73 us, sync: avg 2922.28 us, 37.03x increase

I use normal (stdlib) threadpools and I haven't seen this kind of 
performance degradation.

100 ms is a lot of time...
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20160603/18ea4fd2/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="062871.html">[Twisted-Python] Why deferToThread is so slow?
</A></li>
	<LI>Next message (by thread): <A HREF="062874.html">[Twisted-Python] Why deferToThread is so slow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62873">[ date ]</a>
              <a href="thread.html#62873">[ thread ]</a>
              <a href="subject.html#62873">[ subject ]</a>
              <a href="author.html#62873">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
