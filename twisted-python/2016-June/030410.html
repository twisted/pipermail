<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Why deferToThread is so slow?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Why%20deferToThread%20is%20so%20slow%3F&In-Reply-To=%3C6C723C6F-26B4-49D6-89D2-67E9D985B8B3%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030409.html">
   <LINK REL="Next"  HREF="030412.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Why deferToThread is so slow?</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Why%20deferToThread%20is%20so%20slow%3F&In-Reply-To=%3C6C723C6F-26B4-49D6-89D2-67E9D985B8B3%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Why deferToThread is so slow?">glyph at twistedmatrix.com
       </A><BR>
    <I>Fri Jun  3 02:24:55 MDT 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="030409.html">[Twisted-Python] Why deferToThread is so slow?
</A></li>
        <LI>Next message: <A HREF="030412.html">[Twisted-Python] Why deferToThread is so slow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30410">[ date ]</a>
              <a href="thread.html#30410">[ thread ]</a>
              <a href="subject.html#30410">[ subject ]</a>
              <a href="author.html#30410">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Jun 3, 2016, at 01:06, Nagy, Attila &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bra at fsn.hu</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I have a thread safe synchronous library, which I would like to use in a threadpool using deferToThread.
</I>&gt;<i> 
</I>&gt;<i> Without using (deferTo)threads I get consistent 1-3 ms response times, with deferring to threadpool, I get 30-300, varying wildly.
</I>
Why do you think this is bad performance?

With a direct call, you are doing almost nothing.  Just pushing a stack frame.

With a deferToThread call, you are:

acquiring the GIL,
pushing a message into a call queue,
releasing the GIL,
waiting for the worker thread to wake up,
acquiring the GIL,
pulling the work off the queue,
invoking the work in the worker thread,
storing the response on a return queue,
writing a byte into a pipe to wake up the reactor thread,
releasing the GIL,
waiting for the reactor thread to wake up,
acquiring the GIL,
reading the byte from the pipe,
pulling the response work off the queue,
executing it,
then invoking a Deferred's callback chain.

Each of these steps involves a couple of function calls each, and if each takes 3ms like your simple no-op call, you're looking at 48ms just for starters, not taking into account the fact that when you start tossing things into pipes and mutexes the kernel's scheduler gets involved and may (as you noticed) introduce large amounts of non-determinism as other processes and threads run.

While I would certainly like to see this get faster, and I think it probably could be optimized somewhat, it's not reasonable to expect that a single function call could be competitive with this sort of algorithm, when it's made up of so many function calls of its own.

I could definitely be convinced that this is unreasonably slow but it does not seem so from a first reading.

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20160603/52b65832/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20160603/52b65832/attachment-0001.html</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030409.html">[Twisted-Python] Why deferToThread is so slow?
</A></li>
	<LI>Next message: <A HREF="030412.html">[Twisted-Python] Why deferToThread is so slow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30410">[ date ]</a>
              <a href="thread.html#30410">[ thread ]</a>
              <a href="subject.html#30410">[ subject ]</a>
              <a href="author.html#30410">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
