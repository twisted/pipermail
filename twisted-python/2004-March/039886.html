<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] The right way to broadcast to your TCP/IP clients?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20The%20right%20way%20to%20broadcast%20to%20your%20TCP/IP%20clients%3F&In-Reply-To=%3C200403282019.01193.sflist%40ihonk.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="039885.html">
   <LINK REL="Next"  HREF="039887.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] The right way to broadcast to your TCP/IP clients?</H1>
    <B>Steve Freitas</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20The%20right%20way%20to%20broadcast%20to%20your%20TCP/IP%20clients%3F&In-Reply-To=%3C200403282019.01193.sflist%40ihonk.com%3E"
       TITLE="[Twisted-Python] The right way to broadcast to your TCP/IP clients?">sflist at ihonk.com
       </A><BR>
    <I>Sun Mar 28 21:20:17 MST 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="039885.html">[Twisted-Python] Twisted Euphrates (Modified by Glyph Lefkowitz)
</A></li>
        <LI>Next message (by thread): <A HREF="039887.html">[Twisted-Python] The right way to broadcast to your TCP/IP clients?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39886">[ date ]</a>
              <a href="thread.html#39886">[ thread ]</a>
              <a href="subject.html#39886">[ subject ]</a>
              <a href="author.html#39886">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I'm working on a chat server-ish kinda thang, and although the learning curve 
of twisted was a bit much for my last project, I'm back again for more 
punishment. In this case, I'm looking to broadcast a message from one client 
to other connected clients. I came up with a solution, but I wanted to run it 
by you guys to see whether what I'm doing is The Right Way To Do Things.

Here's what I did for my simple prototype that takes any message received from 
a client and sends it to all clients (including the sender):

-----------

factory = Factory()
factory.transports = []

class Chatterbox(Protocol):

    def connectionMade(self):
	# Make a copy of the new connection's transport and
	# stick it somewhere all the Chatterbox instances can
	# get to it.
        self.factory.transports.append(self.transport)

    def dataReceived(self, data):
	# Every time a piece of data comes in, just write it back
	# out to all the transports, ergo, clients.
        for transport in self.factory.transports:
             transport.write(data)

    def connectionLost(self, reason):
	# When a client disconnects, delete the copy of their
	# transport. Bet this'll be slow w/ lotso clients.
        self.factory.transports.remove(self.transport)

factory.protocol = Chatterbox
reactor.listenTCP(8008, factory)
reactor.run()

-----------

What do you think? Is this a properly twisted way to do things? Strike anyone 
as needlessly inefficient? I'm motivated to make it as fast as possible, so 
despite what Knuth said, any proferred optimizations would be great to hear. 
(On a related note, I intend to put the for loop into a map, but I haven't 
yet embarked on language optimizations, and this question's more about 
Twisted.)

Also, I'm obviously, and perhaps incorrectly, assuming that once a transport 
object is created, it never gets changed. If it does, the copy I made won't 
be updated -- is this a problem?

A definite problem with this method is that it sends the data right back to 
the sender, which actually isn't desirable for my application. Trouble is, to 
avoid it I think I'd have to do this...

    def dataReceived(self, data):
        for transport in self.factory.transports:
		if transport != self.transport:
	             transport.write(data)

Seems an inefficient way to do things, as I'd like this server to handle 
thousands of clients.

Anyway, any help would be appreciated. :-)

Thanks,

Steve


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="039885.html">[Twisted-Python] Twisted Euphrates (Modified by Glyph Lefkowitz)
</A></li>
	<LI>Next message (by thread): <A HREF="039887.html">[Twisted-Python] The right way to broadcast to your TCP/IP clients?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39886">[ date ]</a>
              <a href="thread.html#39886">[ thread ]</a>
              <a href="subject.html#39886">[ subject ]</a>
              <a href="author.html#39886">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
