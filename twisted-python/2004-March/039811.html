<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] threads
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20threads&In-Reply-To=%3C20040317222902.Y5687%40bullseye.apana.org.au%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] threads</H1>
    <B>Andrew MacIntyre</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20threads&In-Reply-To=%3C20040317222902.Y5687%40bullseye.apana.org.au%3E"
       TITLE="[Twisted-Python] threads">andymac at bullseye.apana.org.au
       </A><BR>
    <I>Wed Mar 17 05:15:17 MST 2004</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39811">[ date ]</a>
              <a href="thread.html#39811">[ thread ]</a>
              <a href="subject.html#39811">[ subject ]</a>
              <a href="author.html#39811">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm trying to get Twisted 1.2.0 up on the OS/2 EMX port of Python I
maintain.

Most of it appears to be no great drama, but when I run the test suite,
and it hits a threads related test things get awfully out of shape - the
process goes into a runaway state that is unkillable, using all available
CPU, although the system remains generally usable.  A reboot is required
to restore order.

When I started the testing, I had an OS/2 port of SQLite+PySQLite
installed, and the SQLite test triggered the above behaviour.  On the
assumption that my SQLite port could be implicated, I deinstalled SQLite
etc and tried again.

This uncovered a typo in twisted/flow/threads.py:
*** threads.py.orig     Sun Aug 10 13:00:48 2003
--- threads.py  Mon Mar 15 17:12:16 2004
***************
*** 122,128 ****
              except StopIteration:
                  reactor.callFromThread(self._stopping)
              except:
!                 self.failure = Faliure()
                  reactor.callFromThread(self._cooperate)
              self._cooperate.immediate = True

--- 122,128 ----
              except StopIteration:
                  reactor.callFromThread(self._stopping)
              except:
!                 self.failure = Failure()
                  reactor.callFromThread(self._cooperate)
              self._cooperate.immediate = True


With that fixed, I'm now back to the original behaviour.

The test log contains the following:

...
2004/03/15 17:13 est [-] --&gt; twisted.test.test_flow.FlowTest.testProtocolLocalhost &lt;--
2004/03/15 17:13 est [-] twisted.internet.protocol.ServerFactory starting on 0
2004/03/15 17:13 est [-] Starting factory &lt;twisted.internet.protocol.ServerFactory instance at 0x2de70c&gt;
2004/03/15 17:13 est [-] Starting factory &lt;twisted.internet.protocol.ClientFactory instance at 0xb4780c&gt;
2004/03/15 17:13 est [_Protocol,client] Stopping factory &lt;twisted.internet.protocol.ClientFactory instance at 0xb4780c&gt;
2004/03/15 17:13 est [-] --&gt; twisted.test.test_flow.FlowTest.testQueryIterator &lt;--
2004/03/15 17:13 est [-] --&gt; twisted.test.test_flow.FlowTest.testThreaded &lt;--
2004/03/15 17:13 est [-] Traceback (most recent call last):
	  File &quot;Lib/threading.py&quot;, line 436, in __bootstrap
	    self.run()
	  File &quot;Lib/threading.py&quot;, line 416, in run
	    self.__target(*self.__args, **self.__kwargs)
	--- &lt;exception caught here&gt; ---
	  File &quot;F:/dev/Twisted-1.2.0/twisted/python/threadpool.py&quot;, line 157, in _worker
	    context.call(ctx, function, *args, **kwargs)
	  File &quot;F:/dev/Twisted-1.2.0/twisted/python/context.py&quot;, line 53, in callWithContext
	    return self.currentContext().callWithContext(ctx, func, *args, **kw)
	  File &quot;F:/dev/Twisted-1.2.0/twisted/python/context.py&quot;, line 32, in callWithContext
	    return func(*args,**kw)
	  File &quot;F:/dev/Twisted-1.2.0/twisted/flow/threads.py&quot;, line 126, in _process
	    reactor.callFromThread(self._cooperate)
	  File &quot;F:/dev/Twisted-1.2.0/twisted/internet/base.py&quot;, line 200, in callFromThread
	    self.threadCallQueue.append((f, args, kw))
	exceptions.AttributeError: 'NoneType' object has no attribute 'append'

2004/03/15 17:13 est [twisted.internet.protocol.Factory] (Port 0 Closed)
2004/03/15 17:13 est [twisted.internet.protocol.Factory] Stopping factory &lt;twisted.internet.protocol.Factory instance at 0xaad8cc&gt;
2004/03/15 17:13 est [twisted.internet.protocol.ServerFactory] (Port 0 Closed)
2004/03/15 17:13 est [twisted.internet.protocol.ServerFactory] Stopping factory &lt;twisted.internet.protocol.ServerFactory instance at 0x2de70c&gt;
2004/03/15 17:13 est [Foo,client] Stopping factory &lt;twisted.internet.protocol.ClientFactory instance at 0xabc0ac&gt;
2004/03/15 17:13 est [twisted.internet.protocol.ServerFactory] (Port 0 Closed)
2004/03/15 17:13 est [twisted.internet.protocol.ServerFactory] Stopping factory &lt;twisted.internet.protocol.ServerFactory instance at 0xabc26c&gt;
2004/03/15 17:13 est [Foo,client] Stopping factory &lt;twisted.internet.protocol.ClientFactory instance at 0xabcb0c&gt;
2004/03/15 17:13 est [Foo,client] Stopping factory &lt;twisted.internet.protocol.ClientFactory instance at 0xabcd0c&gt;
2004/03/15 17:13 est [twisted.internet.protocol.ServerFactory] (Port 0 Closed)
2004/03/15 17:13 est [twisted.internet.protocol.ServerFactory] Stopping factory &lt;twisted.internet.protocol.ServerFactory instance at 0xabc14c&gt;
&lt;&lt;&lt;log ends&gt;&gt;&gt;

The traceback is identical to that in the log after the SQLite test
failure.

While the threads support in the EMX port of Python passes the Python test
suite, and people are successfully running Zope on OS/2 with this Python
port, I don't know of any other widespread usage which might have
exercised it.  So I won't be surprised if it has problems.

Can anyone give me any hints about what might be missing or working
incorrectly to trigger the above?

I should note that I've never tried to use Twisted before.  The above is
with Python 2.3.3.  I don't have permanent internet connectivity, and the
test was being run without an internet connection.

Regards,
Andrew.

--
Andrew I MacIntyre                     &quot;These thoughts are mine alone...&quot;
E-mail: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andymac at bullseye.apana.org.au</A>  (pref) | Snail: PO Box 370
        <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andymac at pcug.org.au</A>             (alt) |        Belconnen  ACT  2616
Web:    <A HREF="http://www.andymac.org/">http://www.andymac.org/</A>               |        Australia


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39811">[ date ]</a>
              <a href="thread.html#39811">[ thread ]</a>
              <a href="subject.html#39811">[ subject ]</a>
              <a href="author.html#39811">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
