<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] loseConnection should stop the int32/int16	stringReceived too
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20loseConnection%20should%20stop%20the%20int32/int16%0A%09stringReceived%20too&In-Reply-To=20050222171230.GN7247%40opteron.random">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009803.html">
   <LINK REL="Next"  HREF="009815.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] loseConnection should stop the int32/int16	stringReceived too</H1>
    <B>Andrea Arcangeli</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20loseConnection%20should%20stop%20the%20int32/int16%0A%09stringReceived%20too&In-Reply-To=20050222171230.GN7247%40opteron.random"
       TITLE="[Twisted-Python] loseConnection should stop the int32/int16	stringReceived too">andrea at cpushare.com
       </A><BR>
    <I>Sun Mar 13 14:57:09 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="009803.html">[Twisted-Python] Choosing /reactors
</A></li>
        <LI>Next message: <A HREF="009815.html">[Twisted-Python] loseConnection should stop the int32/int16	stringReceived too
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9804">[ date ]</a>
              <a href="thread.html#9804">[ thread ]</a>
              <a href="subject.html#9804">[ subject ]</a>
              <a href="author.html#9804">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This patch adds a check for transport.disconnecting to the int16/32
protocols, so that they don't keep firing stringReceived callbacks after
calling transport.loseConnection (in line with the linereceiver
protocol). This also adds the methods for pauseproducer in line with the
linereceiver protocol (as per previous patch in this thread).

If these two fixes to int32/16 are correct please apply to SVN.

Thanks.

Index: Twisted/twisted/protocols/basic.py
===================================================================
--- Twisted/twisted/protocols/basic.py	(revision 13177)
+++ Twisted/twisted/protocols/basic.py	(working copy)
@@ -166,9 +166,23 @@
         &quot;&quot;&quot;
         return error.ConnectionLost('Line length exceeded')
     
+class PauseProducer(object):
+    paused = False
 
+    def pauseProducing(self):
+        self.paused = True
+        self.transport.pauseProducing()
 
-class LineReceiver(protocol.Protocol):
+    def resumeProducing(self):
+        self.paused = False
+        self.transport.resumeProducing()
+        self.dataReceived('')
+
+    def stopProducing(self):
+        self.paused = True
+        self.transport.stopProducing()
+
+class LineReceiver(protocol.Protocol, PauseProducer):
     &quot;&quot;&quot;A protocol that receives lines and/or raw data, depending on mode.
     
     In line mode, each line that's received becomes a callback to
@@ -188,7 +202,6 @@
     __buffer = ''
     delimiter = '\r\n'
     MAX_LENGTH = 16384
-    paused = False
     
     def clearLineBuffer(self):
         &quot;&quot;&quot;Clear buffered data.&quot;&quot;&quot;
@@ -279,21 +292,8 @@
         &quot;&quot;&quot;
         return self.transport.loseConnection()
 
-    def pauseProducing(self):
-        self.paused = True
-        self.transport.pauseProducing()
 
-    def resumeProducing(self):
-        self.paused = False
-        self.dataReceived('')
-        self.transport.resumeProducing()
-
-    def stopProducing(self):
-        self.paused = True
-        self.transport.stopProducing()
-
-
-class Int32StringReceiver(protocol.Protocol):
+class Int32StringReceiver(protocol.Protocol, PauseProducer):
     &quot;&quot;&quot;A receiver for int32-prefixed strings.
 
     An int32 string is a string prefixed by 4 bytes, the 32-bit length of
@@ -314,7 +314,7 @@
         &quot;&quot;&quot;Convert int32 prefixed strings into calls to stringReceived.
         &quot;&quot;&quot;
         self.recvd = self.recvd + recd
-        while len(self.recvd) &gt; 3:
+        while len(self.recvd) &gt; 3 and not self.paused and not self.transport.disconnecting:
             length ,= struct.unpack(&quot;!i&quot;,self.recvd[:4])
             if length &gt; self.MAX_LENGTH:
                 self.transport.loseConnection()
@@ -331,7 +331,7 @@
         self.transport.write(struct.pack(&quot;!i&quot;,len(data))+data)
 
 
-class Int16StringReceiver(protocol.Protocol):
+class Int16StringReceiver(protocol.Protocol, PauseProducer):
     &quot;&quot;&quot;A receiver for int16-prefixed strings.
 
     An int16 string is a string prefixed by 2 bytes, the 16-bit length of
@@ -351,7 +351,7 @@
         &quot;&quot;&quot;Convert int16 prefixed strings into calls to stringReceived.
         &quot;&quot;&quot;
         self.recvd = self.recvd + recd
-        while len(self.recvd) &gt; 1:
+        while len(self.recvd) &gt; 1 and not self.paused and not self.transport.disconnecting:
             length = (ord(self.recvd[0]) * 256) + ord(self.recvd[1])
             if len(self.recvd) &lt; length+2:
                 break


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009803.html">[Twisted-Python] Choosing /reactors
</A></li>
	<LI>Next message: <A HREF="009815.html">[Twisted-Python] loseConnection should stop the int32/int16	stringReceived too
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9804">[ date ]</a>
              <a href="thread.html#9804">[ thread ]</a>
              <a href="subject.html#9804">[ subject ]</a>
              <a href="author.html#9804">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
