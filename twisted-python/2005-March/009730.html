<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] streaming producer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20streaming%20producer&In-Reply-To=20050303161452.GL8880%40opteron.random">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009680.html">
   <LINK REL="Next"  HREF="009681.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] streaming producer</H1>
    <B>Andrea Arcangeli</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20streaming%20producer&In-Reply-To=20050303161452.GL8880%40opteron.random"
       TITLE="[Twisted-Python] streaming producer">andrea at cpushare.com
       </A><BR>
    <I>Wed Mar  9 03:27:21 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="009680.html">[Twisted-Python] streaming producer
</A></li>
        <LI>Next message: <A HREF="009681.html">[Twisted-Python] Twisted, Threading, Extension Modules and the GIL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9730">[ date ]</a>
              <a href="thread.html#9730">[ thread ]</a>
              <a href="subject.html#9730">[ subject ]</a>
              <a href="author.html#9730">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>It wasn't difficult to throttle the process stdout after
understanding the registerProducer mechanism. This patch did
the trick just fine. I didn't find docs covering the details,
but the transport code was very readable.

I should be ok with the streaming version since I don't need
resumeProducing to be recalled every time the socket returns writeable
(I only need resumeProducing to be recalled if the socket returns
writeable and the process-protocol is in paused state).

Index: cpushare/seccomp.py
===================================================================
RCS file: /home/andrea/crypto/cvs/cpushare/client/cpushare/cpushare/seccomp.py,v
retrieving revision 1.11
diff -u -p -r1.11 seccomp.py
--- cpushare/seccomp.py	3 Mar 2005 05:56:50 -0000	1.11
+++ cpushare/seccomp.py	9 Mar 2005 07:38:01 -0000
@@ -29,6 +29,8 @@ class seccomp_protocol_class(protocol.Pr
 		self.d = deferred
 		self.outReceived = self.enable_seccomp_mode
 	def connectionMade(self):
+		self.seccomp.cpushare_protocol.seccomp_protocols.append(self)
+		self.seccomp.cpushare_protocol.transport.registerProducer(self, 1)
 		self.transport.closeChildFD(2) # close stderr right away
 		self.transport.writeToChild(0, self.seccomp.header + self.seccomp.text_data)
 	def enable_seccomp_mode(self, data):
@@ -50,12 +52,14 @@ class seccomp_protocol_class(protocol.Pr
 		self.outReceived = self.send_to_server
 		self.transport.writeToChild(0, MAGIC_GOT_SECCOMP)
 	def send_to_server(self, data):
-		self.seccomp.state_machine.protocol.sendString(PROTO_SECCOMP_FORWARD + data)
+		self.seccomp.cpushare_protocol.sendString(PROTO_SECCOMP_FORWARD + data)
 	def recv_from_server(self, data):
 		self.transport.writeToChild(0, data)
 	def errReceived(self, data):
 		raise &quot;shouldn't happen&quot;
 	def processEnded(self, status):
+		self.seccomp.cpushare_protocol.seccomp_protocols.remove(self)
+		self.seccomp.cpushare_protocol.transport.unregisterProducer()
 		if status.value.exitCode:
 			if status.value.exitCode == 4:
 				print 'Failure in setting the stack size to %d bytes.' % self.seccomp.stack
@@ -70,11 +74,19 @@ class seccomp_protocol_class(protocol.Pr
 		if self.transport.pid is not None:
 			os.kill(self.transport.pid, signal.SIGKILL)
 
+	def resumeProducing(self):
+		self.transport.resumeProducing()
+	def pauseProducing(self):
+		self.transport.pauseProducing()
+	def stopProducing(self):
+		self.transport.loseConnection()
+
 class seccomp_class(object):
 	header_fmt = 'iiiIIiiI'
 
 	def __init__(self, header, state_machine):
 		self.state_machine = state_machine
+		self.cpushare_protocol = state_machine.protocol
 
 		size = struct.calcsize(self.header_fmt)
 		assert size + struct.calcsize('I') + 16 == len(header), &quot;corrupted header&quot;

&gt;<i> I will probably make the max buffer size configurable dynamically and
</I>
It should be enough to override the bufferSize in the cpushare_protocol
implementation if I want to enlarge the buffer (default is 64k).


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009680.html">[Twisted-Python] streaming producer
</A></li>
	<LI>Next message: <A HREF="009681.html">[Twisted-Python] Twisted, Threading, Extension Modules and the GIL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9730">[ date ]</a>
              <a href="thread.html#9730">[ thread ]</a>
              <a href="subject.html#9730">[ subject ]</a>
              <a href="author.html#9730">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
