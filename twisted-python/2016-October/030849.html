<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Some things I've learned: safer callbacks, better t.p.context
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Some%20things%20I%27ve%20learned%3A%20safer%20callbacks%2C%0A%20better%20t.p.context&In-Reply-To=%3CD7C9C24F-9527-499C-B7C5-149C0F947860%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030848.html">
   <LINK REL="Next"  HREF="030850.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Some things I've learned: safer callbacks, better t.p.context</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Some%20things%20I%27ve%20learned%3A%20safer%20callbacks%2C%0A%20better%20t.p.context&In-Reply-To=%3CD7C9C24F-9527-499C-B7C5-149C0F947860%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Some things I've learned: safer callbacks, better t.p.context">glyph at twistedmatrix.com
       </A><BR>
    <I>Tue Oct 18 18:47:57 MDT 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="030848.html">[Twisted-Python] Some things I've learned: safer callbacks, better t.p.context
</A></li>
        <LI>Next message: <A HREF="030850.html">[Twisted-Python] Some things I've learned: safer callbacks, better t.p.context
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30849">[ date ]</a>
              <a href="thread.html#30849">[ thread ]</a>
              <a href="subject.html#30849">[ subject ]</a>
              <a href="author.html#30849">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Oct 18, 2016, at 4:05 PM, Kevin Conway &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">kevinjacobconway at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; This is why twisted.python.context came to exist in the first place; I always wanted to attach it to Deferred somehow
</I>&gt;<i> 
</I>&gt;<i> Well, it's not something we've announced yet through any official channel, but we had to solve the context propagation problem at Atlassian to instrument our services with traceable logging. We open sourced our solution at <A HREF="https://bitbucket.org/hipchat/txlocal">https://bitbucket.org/hipchat/txlocal</A> &lt;<A HREF="https://bitbucket.org/hipchat/txlocal">https://bitbucket.org/hipchat/txlocal</A>&gt;. The answer for us was an extension for the reactor, thread pool, and inline callbacks that maintain the needed state. There's a readme with some insight into how we tool our services.
</I>&gt;<i> 
</I>This is (A) very cool, and (B) making such aggressive use of private APIs that it could win a contest about how to ensure that you break on every new release of Twisted :).  I'm super impressed that you tracked the introduction of twisted._threads and support both old- and new-style thread pools!
&gt;<i> We've had it on our backlog to address the mailing list and, possibly even, discuss what it would take to put this into Twisted. I guess now is as good if a time as any. Feel free to spin off a another thread or reach out to me off list with any questions or feedback
</I>&gt;<i> 
</I>This seems like as good a time to talk about it as any!  Integrating this into the core in some fashion would be good, but I imagine that it's a non-trivial impact to performance, so it would be worthwhile to track that.

Speaking of performance - I found the long digression on &quot;Don't Switch In The Core&quot; interesting, since we actually _do_ tracking this kind of context already, for logging.  I was a little surprised you didn't integrate with this at all.

To be fair, this is something that our friends over at PyPy have been bugging us about since forever; when you're benchmarking raw wire speed it does tend to show up in profiling.

I also take it from the performance notes that you're not using PyPy?  __slots__ shouldn't make much of a difference there.  (In fact I'm given to believe it's a slight _decrease_ in performance on pypy...)

-glyph

&gt;<i> On Tue, Oct 18, 2016, 14:47 Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i> On Oct 18, 2016, at 5:50 AM, Itamar Turner-Trauring &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A>&gt;&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Not been doing much Twisted lately, but have been doing async stuff
</I>&gt;&gt;<i> elsewhere, and I've learned some useful things.
</I>&gt;<i> 
</I>&gt;<i> Thanks for writing these up, Itamar!  This sort of reflection is rare and it's always helpful :).
</I>&gt;<i> 
</I>&gt;&gt;<i> 1. Callbacks should be sync or async, but never
</I>&gt;&gt;<i> sometimes-one-sometimes-the-other. For details go read
</I>&gt;&gt;<i> <A HREF="http://blog.ometer.com/2011/07/24/callbacks-synchronous-and-asynchronous/">http://blog.ometer.com/2011/07/24/callbacks-synchronous-and-asynchronous/</A> &lt;<A HREF="http://blog.ometer.com/2011/07/24/callbacks-synchronous-and-asynchronous/">http://blog.ometer.com/2011/07/24/callbacks-synchronous-and-asynchronous/</A>&gt;.
</I>&gt;&gt;<i> For example, Deferred.addCallback(f) really should never run f()
</I>&gt;&gt;<i> immediately.
</I>&gt;<i> 
</I>&gt;<i> This has come up a lot in a compare-and-contrast of Twisted vs. asyncio.
</I>&gt;<i> 
</I>&gt;<i> I agree that the problems with synchronous callbacks are not insignificant (reentrancy is a degenerate form of preemption, and as we all know preemption is the corrupt wellspring of all bugs).  However, the benefit, i.e. consistency of behavior with respect to reentrancy, comes with a cost: tight coupling to an event loop.  In asyncio, Future's tight coupling to call_soon is a source of problems; it makes it hard to write a test without setting up an elaborate scheduling trampoline, whereas successResultOf/failureResultOf are quite simple to work with.
</I>&gt;<i> 
</I>&gt;<i> I think Deferred as it is today is a pretty good compromise between the two positions.  On the one hand it is decoupled from the event loop.  On the other - and this is important - no Deferred-returning API will ever call your callbacks synchronously.  Deferred.addCallback will, of course, but savvy Twisted programmers can (and should) do this, if they have dependent state changes:
</I>&gt;<i> 
</I>&gt;<i> self.manipulateSomeStateForSetup()
</I>&gt;<i> d = doSomethingPotentiallySynchronous()
</I>&gt;<i> self.manipulateSomeStateForProcessing()
</I>&gt;<i> d.addCallback(completeOperation)
</I>&gt;<i> 
</I>&gt;<i> As a caller, you can always decide whether you can safely be re-entered or not.  In most cases, simply moving the 'addCallback' to the end of the function (a-la Go's &quot;defer&quot;, oddly enough) is fine.  In more complex cases where you really need to unwind reentrancy completely, you can do your own callLater(0) or callFromThread() from an object with a reference to a reactor.
</I>&gt;<i> 
</I>&gt;&gt;<i> 3.
</I>&gt;<i> 
</I>&gt;<i> What happened to '2'? :)
</I>&gt;<i> 
</I>&gt;&gt;<i> By instrumenting all callbacks it manages, which may or may not
</I>&gt;&gt;<i> require item #1, Twisted can have a context that automatically follows
</I>&gt;&gt;<i> callbacks. Node has this and it is extremely useful.
</I>&gt;&gt;<i> <A HREF="http://fredkschott.com/post/2014/02/conquering-asynchronous-context-with-cls/">http://fredkschott.com/post/2014/02/conquering-asynchronous-context-with-cls/</A> &lt;<A HREF="http://fredkschott.com/post/2014/02/conquering-asynchronous-context-with-cls/">http://fredkschott.com/post/2014/02/conquering-asynchronous-context-with-cls/</A>&gt;
</I>&gt;&gt;<i> is best summary I've found with a bit of searching.
</I>&gt;<i> 
</I>&gt;<i> This was _always_ supposed to be the way that Twisted worked, but frankly I just wasn't smart enough to figure it out.  This is why twisted.python.context came to exist in the first place; I always wanted to attach it to Deferred somehow.  I will watch this talk intently; if #1 really is required to address this, my opinion might change.  A PR would be intensely appreciated.
</I>&gt;<i> 
</I>&gt;<i> -glyph
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>&gt;
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>&gt;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20161018/abe895f6/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20161018/abe895f6/attachment-0001.html</A>&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030848.html">[Twisted-Python] Some things I've learned: safer callbacks, better t.p.context
</A></li>
	<LI>Next message: <A HREF="030850.html">[Twisted-Python] Some things I've learned: safer callbacks, better t.p.context
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30849">[ date ]</a>
              <a href="thread.html#30849">[ thread ]</a>
              <a href="subject.html#30849">[ subject ]</a>
              <a href="author.html#30849">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
