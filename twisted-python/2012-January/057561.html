<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] telnet works, why wont this client/protocol test?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20telnet%20works%2C%20why%20wont%20this%20client/protocol%20test%3F&In-Reply-To=%3C5D82FCEC-8AD5-449E-8EE6-31706D3B1EC5%40cisco.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="057559.html">
   <LINK REL="Next"  HREF="057562.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] telnet works, why wont this client/protocol test?</H1>
    <B>Mike Winter</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20telnet%20works%2C%20why%20wont%20this%20client/protocol%20test%3F&In-Reply-To=%3C5D82FCEC-8AD5-449E-8EE6-31706D3B1EC5%40cisco.com%3E"
       TITLE="[Twisted-Python] telnet works, why wont this client/protocol test?">miwinter at cisco.com
       </A><BR>
    <I>Thu Jan 12 01:40:17 MST 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="057559.html">[Twisted-Python] I see, remote_method can also return a deferred. Perhaps we could document that?
</A></li>
        <LI>Next message (by thread): <A HREF="057562.html">[Twisted-Python] telnet works, why wont this client/protocol test?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57561">[ date ]</a>
              <a href="thread.html#57561">[ thread ]</a>
              <a href="subject.html#57561">[ subject ]</a>
              <a href="author.html#57561">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>i can telnet to the port given in test-code below and it interacts appropriately. The connection is to a regular portforwarder and the server is an Answer-server:

class Answer(LineReceiver):

    answers = {'How are you?': 'Fine',
               'no': 'No!?!',
               None : &quot;I don't know what you mean&quot;,
               'hello': 'hi there',
               'Whats Up': 'not much' }

    def lineReceived(self, line):
        log.debug('line: %s' % line)
        if self.answers.has_key(line):
            self.sendLine(self.answers[line])
        else:
            self.sendLine(self.answers[None])

Its not a unit-test, but it reasonably expresses code that I dont understand 

from twisted.trial.unittest import TestCase
from twisted.internet import reactor, protocol, defer
from twisted.internet.protocol import ClientFactory,ReconnectingClientFactory
from twisted.protocols.policies import WrappingFactory
from twisted.protocols import basic
import localproxy
import settings
from state import State
import engine
from server import Factory, AssertingAnswer, AssertingFactoryMixin
from assertion import URL
import logging
global log

log = logging.getLogger(__name__)
log.setLevel(settings.loglevel)

class Test(TestCase):

    def sendTraffic(self, vip, count = 1,
                    payload = 'Whats Up\n',
                    expectedResponse = 'not much'):
        '''telnet to DUT and post payload'''
        log.debug('vip: %s:%s' % (vip.host, vip.port))
        t = self
        class Hello(basic.LineReceiver):
            def dataReceived(self, data):
                log.debug('trace: %s' % data)
                return basic.LineReceiver.dataReceived(self,data)

            def lineReceived(self, line):
                log.debug('trace: %s' % line)
                t.assertEquals(line, expectedResponse)
                self.transport.loseConnection()

            def connectionMade(self):
                log.debug('trace, writing &quot;%s&quot;' % payload)
                assert self.transport
                self.transport.write(payload)

            def connectionLost(self, reason):
                log.debug('reason: %s' % reason)

        f = ReconnectingClientFactory()
        f.protocol = Hello
        factory = WrappingFactory(f)
        reactor.connectTCP( vip.host, vip.port, factory)
        log.debug('clientFactory: %s' % factory.__dict__)
        return factory

    def killClient(t):
        log.debug('t: %s' % t)

    def testClientConnect(self):
        vip = State(host='127.0.0.1', port = 10040)
        t = self.sendTraffic( vip)
        reactor.callLater(1, self.killClient, t)



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="057559.html">[Twisted-Python] I see, remote_method can also return a deferred. Perhaps we could document that?
</A></li>
	<LI>Next message (by thread): <A HREF="057562.html">[Twisted-Python] telnet works, why wont this client/protocol test?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57561">[ date ]</a>
              <a href="thread.html#57561">[ thread ]</a>
              <a href="subject.html#57561">[ subject ]</a>
              <a href="author.html#57561">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
