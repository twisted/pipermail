<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to correctly run Sqlite with Twisted?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20correctly%20run%20Sqlite%20with%20Twisted%3F&In-Reply-To=%3C3a3c9a0f-9412-e09f-959e-287beebc137c%40thieprojects.ch%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031647.html">
   <LINK REL="Next"  HREF="031649.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to correctly run Sqlite with Twisted?</H1>
    <B>Werner Thie</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20correctly%20run%20Sqlite%20with%20Twisted%3F&In-Reply-To=%3C3a3c9a0f-9412-e09f-959e-287beebc137c%40thieprojects.ch%3E"
       TITLE="[Twisted-Python] How to correctly run Sqlite with Twisted?">werner at thieprojects.ch
       </A><BR>
    <I>Tue Sep 19 15:50:23 MDT 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031647.html">[Twisted-Python] How to correctly run Sqlite with Twisted?
</A></li>
        <LI>Next message (by thread): <A HREF="031649.html">[Twisted-Python] How to correctly run Sqlite with Twisted?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31648">[ date ]</a>
              <a href="thread.html#31648">[ thread ]</a>
              <a href="subject.html#31648">[ subject ]</a>
              <a href="author.html#31648">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Aloha Goffi

I'm using minimal code like the one below for MySQL interaction, should be easy to transition this to SQLite

from twisted.internet   import reactor, task, defer

from store import Store

#debugging func, printing the result on the console
def _transformResult(result):
##  print '####', result
   if result:
       return result[0]  #unpack the list
   else:
       return None

class Somestore(object):
   name = &quot;somestore&quot;

   def __init__(self, dbapiName, **params):
     self.store = Store(dbapiName, **params)
     ka = task.LoopingCall(self.keepAlive)             #db keepalive
     ka.start(307)

   def dbdisconn(self, reason):
     print 'db disconnected for ', reason

   def keepAlive(self):
     try:
       d = self.store.runQuery('SELECT 1')
       d.addErrback(self.dbdisconn)
     except:
       pass
     else:
       pass        #do whatever MUST occur here in all cases

   def getTableCount(self):
     d = self.store.runQuery('SELECT tables FROM user WHERE servername = %s', 'total')
     d.addCallback(_transformResult)
     d.addErrback(self.dbdisconn)
     return d

   def setUserCount(self, waiting, playing, tables):
     d = self.store.runOperation('UPDATE user SET waiting = %s, playing = %s, tables = %s WHERE servername = %s', waiting, playing, tables, self.loggername)
     d.addErrback(self.dbdisconn)
     return d


module store.py
from itertools import izip

from twisted.enterprise import adbapi

using it with canned queries like


class Store(object):
   def __init__(self, dbapiName, **params):
     self.__pool   = adbapi.ConnectionPool(dbapiName, **params)
     print self.__pool.__getstate__()
     self.runOperation('SET autocommit = %s', 1)

   def runQuery(self, query, *args):
     d = self.__pool.runInteraction(self.mapQuery, query, args)
     return d

   def runInsert(self, query, *args):
     def mapQ(curs, query, *args):
       try:
         curs.execute(query, *args)
       except adbapi.ConnectionLost:
         print
         print '++++++++++++ rerunning query'
         print
         curs.execute(query, *args)                    #simply resend query, assuming cp_reconnect=True
         return {'lastrowid': -1}
       return {'lastrowid': curs.lastrowid}
     d = self.__pool.runInteraction(mapQ, query, args)
     return d

   def mapQuery(self, curs, query, *args):
     try:
       curs.execute(query, *args)
     except adbapi.ConnectionLost:
       curs.execute(query, *args)                    #simply resend query, assuming cp_reconnect=True
     result = curs.fetchall()
     columns = [d[0] for d in curs.description]
     return [dict(zip(columns, r)) for r in result]

   def runOperation(self, query, *args):
     d = self.__pool.runOperation(query, args)
     return d


On 9/19/2017 10:59 AM, Goffi wrote:
&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> I'm using Sqlite3 module through Twisted's enterpirse.adbapi, I create the
</I>&gt;<i> ConnectionPool instance like this:
</I>&gt;<i>
</I>&gt;<i>     self.dbpool = ConnectionPool(&quot;sqlite3&quot;, db_filename,
</I>&gt;<i> check_same_thread=False)
</I>&gt;<i>
</I>&gt;<i> You can see the code at <A HREF="https://repos.goffi.org/sat/file/tip/src/memory/sqlite.py">https://repos.goffi.org/sat/file/tip/src/memory/sqlite.py</A>
</I>&gt;<i>
</I>&gt;<i> Sometime, the writing is failing with following exception:
</I>&gt;<i>
</I>&gt;<i>    Failure instance: Traceback: &lt;class 'sqlite3.OperationalError'&gt;: database is
</I>&gt;<i> locked
</I>&gt;<i>
</I>&gt;<i> So I wonder if the database is correctly used, did anybody experienced
</I>&gt;<i> something similar with Twisted and Sqlite ?
</I>&gt;<i>
</I>&gt;<i> Should I just augment timeout as advised at <A HREF="https://stackoverflow.com/a/">https://stackoverflow.com/a/</A>
</I>&gt;<i> 8618328? Looks like more a workaround than a clean solution.
</I>&gt;<i>
</I>&gt;<i> Python 2 documentation doesn't talk about check_same_thread argument, but
</I>&gt;<i> Python 3 at <A HREF="https://docs.python.org/3.5/library/sqlite3.html#sqlite3.connect">https://docs.python.org/3.5/library/sqlite3.html#sqlite3.connect</A>
</I>&gt;<i> says that writing operation should be serialized by the user (I thought it was
</I>&gt;<i> the default as said in <A HREF="https://sqlite.org/threadsafe.html">https://sqlite.org/threadsafe.html</A>), how should I
</I>&gt;<i> achieve that?
</I>&gt;<i>
</I>&gt;<i> Also PRAGMA are not working (specially &quot;PRAGMA foreign_keys = ON&quot;), I guess
</I>&gt;<i> because of multi-threading, what is the good way to activate foreign_keys for
</I>&gt;<i> all following request?
</I>&gt;<i>
</I>&gt;<i> Thanks in advance
</I>&gt;<i>
</I>&gt;<i> Goffi
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031647.html">[Twisted-Python] How to correctly run Sqlite with Twisted?
</A></li>
	<LI>Next message (by thread): <A HREF="031649.html">[Twisted-Python] How to correctly run Sqlite with Twisted?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31648">[ date ]</a>
              <a href="thread.html#31648">[ thread ]</a>
              <a href="subject.html#31648">[ subject ]</a>
              <a href="author.html#31648">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
