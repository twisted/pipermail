<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] DelayedCall enhancements
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20DelayedCall%20enhancements&In-Reply-To=%3CBE9353E3-16B7-11D7-9430-000A95686CD8%40mastersofbranding.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="034962.html">
   <LINK REL="Next"  HREF="034963.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] DelayedCall enhancements</H1>
    <B>Bob Ippolito</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20DelayedCall%20enhancements&In-Reply-To=%3CBE9353E3-16B7-11D7-9430-000A95686CD8%40mastersofbranding.com%3E"
       TITLE="[Twisted-Python] DelayedCall enhancements">bob at mastersofbranding.com
       </A><BR>
    <I>Mon Dec 23 13:47:26 MST 2002</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="034962.html">[Twisted-Python] DelayedCall enhancements
</A></li>
        <LI>Next message (by thread): <A HREF="034963.html">[Twisted-Python] DelayedCall enhancements
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34966">[ date ]</a>
              <a href="thread.html#34966">[ thread ]</a>
              <a href="subject.html#34966">[ subject ]</a>
              <a href="author.html#34966">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Here's a patch that adds two particularly useful methods to the 
IDelayedCall interface and implementation.  It's quite possible to do 
it currently, but it's a kludge.

Essentially what I added were methods to delay a DelayedCall by a 
configurable amount of time, and to reset a DelayedCall to happen a 
configurable amount of time from now.

I also added a test case for each, and they pass.  I can check it in if 
someone gives me the OK.

-bob


Index: twisted/internet/interfaces.py
===================================================================
RCS file: /cvs/Twisted/twisted/internet/interfaces.py,v
retrieving revision 1.57
diff -r1.57 interfaces.py
317a318,319
 &gt;                   It also may be rescheduled by calling its C{delay()}
 &gt;                   or C{reset()} methods.
347a350,370
 &gt;     def delay(self, secondsLater):
 &gt;         &quot;&quot;&quot;Delay the scheduled call.
 &gt;         @param secondsLater: how many seconds from its current firing 
time to delay
 &gt;
 &gt;         @raises twisted.internet.error.AlreadyCalled: if the call has 
already
 &gt;             happened.
 &gt;         @raises twisted.internet.error.AlreadyCancelled: if the call 
has already
 &gt;             been cancelled.
 &gt;         &quot;&quot;&quot;
 &gt;
 &gt;     def reset(self, secondsFromNow):
 &gt;         &quot;&quot;&quot;Reset the scheduled call's timer.
 &gt;         @param secondsLater: how many seconds from now it should 
fire, equivalent
 &gt;                              to C{self.cancel()} and then doing 
another
 &gt;                              C{reactor.callLater(secondsLater, ...)}
 &gt;
 &gt;         @raises twisted.internet.error.AlreadyCalled: if the call has 
already
 &gt;             happened.
 &gt;         @raises twisted.internet.error.AlreadyCancelled: if the call 
has already
 &gt;             been cancelled.
 &gt;         &quot;&quot;&quot;
Index: twisted/internet/base.py
===================================================================
RCS file: /cvs/Twisted/twisted/internet/base.py,v
retrieving revision 1.29
diff -r1.29 base.py
48c48
&lt;     def __init__(self, time, func, args, kw, cancel):
---
 &gt;     def __init__(self, time, func, args, kw, cancel, reset):
49a50
 &gt;         self.resetter = reset
61a63,79
 &gt;     def reset(self, secondsFromNow):
 &gt;         if self.cancelled:
 &gt;             raise error.AlreadyCancelled
 &gt;         elif self.called:
 &gt;             raise error.AlreadyCalled
 &gt;         else:
 &gt;             self.time = time() + secondsFromNow
 &gt;             self.resetter(self)
 &gt;
 &gt;     def delay(self, secondsLater):
 &gt;         if self.cancelled:
 &gt;             raise error.AlreadyCancelled
 &gt;         elif self.called:
 &gt;             raise error.AlreadyCalled
 &gt;         else:
 &gt;             self.time += secondsLater
 &gt;             self.resetter(self)
266c284,290
&lt;         tple = DelayedCall(time() + seconds, f, args, kw, 
self._pendingTimedCalls.remove)
---
 &gt;         tple = DelayedCall(time() + seconds, f, args, kw, 
self._pendingTimedCalls.remove, self._resetCallLater)
 &gt;         insort(self._pendingTimedCalls, tple)
 &gt;         return tple
 &gt;
 &gt;     def _resetCallLater(self, tple):
 &gt;         assert tple in self._pendingTimedCalls
 &gt;         self._pendingTimedCalls.remove(tple)
Index: twisted/test/test_internet.py
===================================================================
RCS file: /cvs/Twisted/twisted/test/test_internet.py,v
retrieving revision 1.13
diff -r1.13 test_internet.py
102a103,128
 &gt;     def _resetcallback(self):
 &gt;         self._resetcallbackTime = time.time()
 &gt;
 &gt;     def _delaycallback(self):
 &gt;         self._delaycallbackTime = time.time()
 &gt;
 &gt;     def testCallLaterDelayAndReset(self):
 &gt;         self._resetcallbackTime = None
 &gt;         self._delaycallbackTime = None
 &gt;         ireset = reactor.callLater(0.5, self._resetcallback)
 &gt;         idelay = reactor.callLater(0.5, self._delaycallback)
 &gt;         start = time.time()
 &gt;         # chug a little before delaying
 &gt;         while time.time() - start &lt; 0.2:
 &gt;             reactor.iterate(0.01)
 &gt;         ireset.reset(0.3)
 &gt;         idelay.delay(0.3)
 &gt;         # both should be called sometime during this
 &gt;         while time.time() - start &lt; 0.9:
 &gt;             reactor.iterate(0.01)
 &gt;         self.assert_(0 &lt; self._resetcallbackTime - start - 0.5 &lt; 0.2)
 &gt;         self.assert_(0 &lt; self._delaycallbackTime - start - 0.8 &lt; 0.2)
 &gt;
 &gt;         del self._resetcallbackTime
 &gt;         del self._delaycallbackTime
 &gt; 



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="034962.html">[Twisted-Python] DelayedCall enhancements
</A></li>
	<LI>Next message (by thread): <A HREF="034963.html">[Twisted-Python] DelayedCall enhancements
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34966">[ date ]</a>
              <a href="thread.html#34966">[ thread ]</a>
              <a href="subject.html#34966">[ subject ]</a>
              <a href="author.html#34966">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
