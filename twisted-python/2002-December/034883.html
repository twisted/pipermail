<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Writing Unittests for Twisted Applications
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Writing%20Unittests%20for%20Twisted%20Applications&In-Reply-To=%3C6qd6ohejnq.fsf%40salmakis.intevation.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="034890.html">
   <LINK REL="Next"  HREF="034884.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Writing Unittests for Twisted Applications</H1>
    <B>Bernhard Herzog</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Writing%20Unittests%20for%20Twisted%20Applications&In-Reply-To=%3C6qd6ohejnq.fsf%40salmakis.intevation.de%3E"
       TITLE="[Twisted-Python] Writing Unittests for Twisted Applications">bh at intevation.de
       </A><BR>
    <I>Wed Dec  4 11:14:17 MST 2002</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="034890.html">[Twisted-Python] apploader patch, take 2
</A></li>
        <LI>Next message (by thread): <A HREF="034884.html">[Twisted-Python] Writing Unittests for Twisted Applications
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34883">[ date ]</a>
              <a href="thread.html#34883">[ thread ]</a>
              <a href="subject.html#34883">[ subject ]</a>
              <a href="author.html#34883">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I've been working on a project using twisted for the last few weeks. In
the process I've written quite a few unittests most of which need to run
a twisted reactor either directly as reactor.run or via an Application
instance's run() method.

It's amazing how difficult that is, given that twisted itself has an
extensive set of unittests. Running only one test with a main loop is
simple but running several tests that need to listen and unlisten the
same ports or that have timeouts, etc. seems much more difficult than it
should be.

How difficult would it be to implement at least one of the following
features?

 1. a way to reset a reactor so that e.g. a new unit test could start
    with a clean state. It's OK for me if the unittest itself has to
    take care to do some things automatically such as disconnecting
    connections or unlistenting.

 2. A base class (derived from unittest.TestCase or as a mix-in class)
    for tests that need to run the main loop. There should perhaps be
    two of them, one for plain reactor usage and for test with
    Application instances. 

    Obviously this would require having 1. to a certain extent. However,
    it's OK if the class knew how to achieve a reset in as far as that
    is necessary for test cases. For instance, the base class could
    require that derived classes don't call the reactor directly to
    listen or to add delayed calls and go through some method instead to
    e.g. keep track of the ids returned by reactor.callLater.


AFAICT neither is currently implemented in twisted. There even seems to
be one unit test (test_sister) that's not implemented because of this.

I have effectively implemented no. 2 as part of my unit-tests but only
as much as I needed it so far. It didn't take much code but there are
some tricky things:

 1. After and unlisten when the loop has already been left, call
    reactor.iterate() to make sure the port is properly freed again.
    This was relatively easy to figure out because some twisted test
    cases do this.

 2. Application.run() will only run the reactor mainloop if main.running
    is not true. Unfortunately, main.running is not unset when
    main.shutdown or main.crash is called, so when trying to enter
    application main loops more than once, even for different
    application instances, once has to explicitly unset main.running.

My code will eventually be available under GPL as part of the
'GREAT-ER'[1] software we're developing, but it's not yet in CVS. 

If there's interest in including my test case base class in twisted I
could make it available sooner and under LGPL.


   Bernhard


[1] <A HREF="http://great-er.intevation.de/">http://great-er.intevation.de/</A>


-- 
Intevation GmbH                                 <A HREF="http://intevation.de/">http://intevation.de/</A>
Sketch                                 <A HREF="http://sketch.sourceforge.net/">http://sketch.sourceforge.net/</A>
MapIt!                                           <A HREF="http://www.mapit.de/">http://www.mapit.de/</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="034890.html">[Twisted-Python] apploader patch, take 2
</A></li>
	<LI>Next message (by thread): <A HREF="034884.html">[Twisted-Python] Writing Unittests for Twisted Applications
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34883">[ date ]</a>
              <a href="thread.html#34883">[ thread ]</a>
              <a href="subject.html#34883">[ subject ]</a>
              <a href="author.html#34883">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
