<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] profiling twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20profiling%20twisted&In-Reply-To=%3C4688BFB8.2040205%40bluegap.ch%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="048177.html">
   <LINK REL="Next"  HREF="048179.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] profiling twisted</H1>
    <B>Markus Schiltknecht</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20profiling%20twisted&In-Reply-To=%3C4688BFB8.2040205%40bluegap.ch%3E"
       TITLE="[Twisted-Python] profiling twisted">markus at bluegap.ch
       </A><BR>
    <I>Mon Jul  2 03:04:56 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="048177.html">[Twisted-Python] Open Source Twisted Email Server
</A></li>
        <LI>Next message (by thread): <A HREF="048179.html">[Twisted-Python] profiling twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48178">[ date ]</a>
              <a href="thread.html#48178">[ thread ]</a>
              <a href="subject.html#48178">[ subject ]</a>
              <a href="author.html#48178">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A> wrote:
&gt;<i> What is 'real load'?  Are you talking about things in process with, but 
</I>&gt;<i> not related to, the web server?
</I>
I should have been more specific, but OTOH, it really didn't matter. 
Anyway: what I meant was: 1 concurrent request =&gt; very small load, 8 
concurrent requests =&gt; real load.

&gt;<i> Maybe your server is slow? :)
</I>
;-)  Probably not that slow...

&gt;&gt;<i> Can I somehow get the reactor's state, i.e. how many deferreds are 
</I>&gt;&gt;<i> waiting in the queue, how many threads are running concurrently, etc?
</I>&gt;<i> 
</I>&gt;<i> There is no queue of Deferreds.  They don't actually have anything to do 
</I>&gt;<i> with the reactor.
</I>
Hm.. good to know.

&gt;&gt;<i> How good is the idea of deferring File I/O to threads, i.e. 
</I>&gt;&gt;<i> threads.deferToThread(self.filehandle.write, data)?
</I>&gt;<i> 
</I>&gt;<i> If you do indeed discover that you are waiting a long time to write your 
</I>&gt;<i> particular stuff to files, then that might help.  It might also randomly 
</I>&gt;<i> interleave the data and corrupt your files, if 'data' is big enough.
</I>
Uh.. I'm taking care, that only one thread writes to a file at any time.

&gt;&gt;<i> Another possibly blocking module might be the database api, but I'm 
</I>&gt;&gt;<i> using twisted's enterprise adbapi, which should be async, AFAICT.
</I>&gt;<i> 
</I>&gt;<i> It does the operations in threads, yes.  However, the threadpool will 
</I>&gt;<i> eventually fill up; the concurrency is fairly limited.  (The default is 
</I>&gt;<i> 10 or so workers, I think).
</I>
Yeah, I've enlarged that to 50 threads, which should be enough.

&gt;&gt;<i> Maybe copying data around takes time. I'm sending around chunks of 64k 
</I>&gt;&gt;<i> size (streaming from the database to an external programm). Reducing 
</I>&gt;&gt;<i> chunk size to 1k helps somewhat (i.e. response time is seldom over 
</I>&gt;&gt;<i> 150ms, but can still climb up to &gt; 0.5 seconds).
</I>&gt;<i> 
</I>&gt;<i> That's a possibility that the &quot;--profile&quot; option to twistd which JP 
</I>&gt;<i> suggested might help you with.  You'll see the functions copying data 
</I>&gt;<i> taking a lot of CPU time in that case.
</I>
Didn't help me much, this time...

&gt;&gt;<i> Hum... external program.... maybe it's the self.transport.write() call 
</I>&gt;&gt;<i> which blocks several 100ms? Is it safe to write:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   d = threads.deferToThread(self.transport.write, dataChunk)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> (i.e. call transport.write from a thread?)
</I>&gt;<i> 
</I>&gt;<i> No.  _All_ Twisted APIs are not thread safe.  This call does not block 
</I>&gt;<i> though, and it is extremely, vanishingly unlikely that it is causing 
</I>&gt;<i> your problems.  It just sticks some data into the outgoing queue and 
</I>&gt;<i> returns immediately.
</I>
Okay, I've removed that deferToThread(). Didn't solve my problem anyway.

&gt;<i> One quick measurement you can do to determine what might be causing this 
</I>&gt;<i> performance loss is to examine the server in 'top' while it is allegedly 
</I>&gt;<i> under load.  Is it taking up 100% CPU?  If not, then it's probably 
</I>&gt;<i> blocked on some kind of I/O in your application, or perhaps writing the 
</I>&gt;<i> log.  If so, then there's some inefficient application code (or Twisted 
</I>&gt;<i> code) that you need to profile and optimize.  The output of &quot;strace -T&quot; 
</I>&gt;<i> on your Twisted server *might* be useful if you discover that you're 
</I>&gt;<i> blocking on some kind of I/O.
</I>
Yup, I did that, but it's hard to tell what's wrong from these things.


Anyway, with very simple timing measures within the twisted server 
itself, I've figured out what was causing the delays: 
reactor.spawnProcess() takes more than a second.  I knew that fork() was 
expensive, but that expensive?


What I'm doing now feels very dirty: I'm calling reactor.spawnProcess() 
from a thread. (Yes, I'm taking care that only one thread can spawn a 
process at any time.) At least on my Linux Dev-Box, that seems to work - 
and resolves my issue. But... calling fork() from a thread???


Are there other ways to start and control external processes? Preferably 
even compatible to Windoze?


Thanks to everybody for your help...


Regards

Markus



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="048177.html">[Twisted-Python] Open Source Twisted Email Server
</A></li>
	<LI>Next message (by thread): <A HREF="048179.html">[Twisted-Python] profiling twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48178">[ date ]</a>
              <a href="thread.html#48178">[ thread ]</a>
              <a href="subject.html#48178">[ subject ]</a>
              <a href="author.html#48178">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
