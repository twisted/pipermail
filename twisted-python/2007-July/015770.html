<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Testing with trial, adbapi questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Testing%20with%20trial%2C%20adbapi%20questions&In-Reply-To=cd8fa6f90706260727l667f3e72we349e32ac40260cf%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015765.html">
   <LINK REL="Next"  HREF="015775.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Testing with trial, adbapi questions</H1>
    <B>Brendon Colby</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Testing%20with%20trial%2C%20adbapi%20questions&In-Reply-To=cd8fa6f90706260727l667f3e72we349e32ac40260cf%40mail.gmail.com"
       TITLE="[Twisted-Python] Testing with trial, adbapi questions">brendoncolby at gmail.com
       </A><BR>
    <I>Fri Jul 20 11:40:45 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015765.html">[Twisted-Python] twisted.plugin
</A></li>
        <LI>Next message: <A HREF="015775.html">[Twisted-Python] Testing with trial, adbapi questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15770">[ date ]</a>
              <a href="thread.html#15770">[ thread ]</a>
              <a href="subject.html#15770">[ subject ]</a>
              <a href="author.html#15770">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/26/07, Christian Simms &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">christian.simms at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Looks like I mis-assumed your problem, sorry.  In the setUp method in your
</I>&gt;<i> tests, you should return a Deferred which fires when all your data is
</I>&gt;<i> loaded.  This can be a pain if you already organized your code into classes
</I>&gt;<i> inheriting from twisted.application.service.Service which have
</I>&gt;<i> startService/stopService calls. It's a pain because trial doesn't create an
</I>&gt;<i> application object like running inside twistd does.  So, in the case of
</I>&gt;<i> writing unit tests for applications, you can abstract out your
</I>&gt;<i> initialization code into a method, and then call that method directly in
</I>&gt;<i> your setUp method.
</I>

I've spent some time working on this, and I see the logic in doing so
(firing a deferred when my data is loaded) but I'm stuck at the point of how
to do this. In my factory, I call this method in __init__ to load data:

  def loadDevelopers(self):
    def cb(results):
      for result in results:
        self.addDeveloper(Developer(result['auth_host'],result['auth_url'],
          result['devid'],self,result['key'],result['post_host'],
          result['post_url']))
    return self.dbPool.runQuery(&quot;select * from developers where active=1&quot;).\
      addCallback(cb).addErrback(printError)

I created a tac file and am using twistd to run this and it works great. But
in my unit tests, what happens is my tests run before my data is loaded (and
fail). I haven't been able to figure out how to tell my tests to run after
this data is loaded. Here's my setUp method:

    def setUp(self):
        self.file = StringIOWithoutClosing()
        self.transport = FileWrapperThatWorks(self.file)
        self.protocol = sserver.SServerProtocol()
        self.protocol.factory = sserver.SServerFactory(self.protocol)
        self.protocol.factory.dbPool.start()
        self.protocol.makeConnection(self.transport)

    def testSendDeveloperID(self):
        print self.protocol.factory.developers # This dictionary prints as
empty - it shouldn't!

I guess I'm not making the connection here. How do I code the deferred in
setUp to fire when my data is loaded? Also, if I abstract out this logic to
an initialization method, how would I have it fire properly when I run under
twistd? Here's my tac file:

factory = SServerFactory(protocol=SServerProtocol)
application = service.Application(&quot;SServer&quot;)
sserverService = internet.TCPServer(4000,factory)
sserverService.setServiceParent(application)

I appreciate the help!

Brendon
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20070720/9fe68afc/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20070720/9fe68afc/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015765.html">[Twisted-Python] twisted.plugin
</A></li>
	<LI>Next message: <A HREF="015775.html">[Twisted-Python] Testing with trial, adbapi questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15770">[ date ]</a>
              <a href="thread.html#15770">[ thread ]</a>
              <a href="subject.html#15770">[ subject ]</a>
              <a href="author.html#15770">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
