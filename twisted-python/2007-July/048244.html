<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Perspective Broker with blocking,	non-thread-safe C api?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Perspective%20Broker%20with%20blocking%2C%0A%09non-thread-safe%20C%20api%3F&In-Reply-To=%3C6ce0ac130707110825tfd4885fs3c20a2cc0485d192%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="048241.html">
   <LINK REL="Next"  HREF="048245.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Perspective Broker with blocking,	non-thread-safe C api?</H1>
    <B>Brian Granger</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Perspective%20Broker%20with%20blocking%2C%0A%09non-thread-safe%20C%20api%3F&In-Reply-To=%3C6ce0ac130707110825tfd4885fs3c20a2cc0485d192%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Perspective Broker with blocking,	non-thread-safe C api?">ellisonbg.net at gmail.com
       </A><BR>
    <I>Wed Jul 11 09:25:38 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="048241.html">[Twisted-Python] Perspective Broker with blocking,	non-thread-safe C api?
</A></li>
        <LI>Next message (by thread): <A HREF="048245.html">[Twisted-Python] Perspective Broker with blocking,	non-thread-safe C api?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48244">[ date ]</a>
              <a href="thread.html#48244">[ thread ]</a>
              <a href="subject.html#48244">[ subject ]</a>
              <a href="author.html#48244">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Things are a bit more complicated that just calling deferToThread.

The reason is that is you call a blocking C api in the thread, the
Python interpreter will not be able to switch threads until the
blocking C calls....unless the C code releases the Global Interpreter
Lock.  Thus you have two choices:

1)  Make sure that the C code releases the GIL and call it using
deferToThread.  This is probably the best solution.

2) If you can't release the GIL - if for instance the C code makes
calls to the Python C API, then you have to do the following.  You can
simply call the block C code in the main thread.  This will block the
Twisted event loop while the C code runs.  To mask this blocking
behavior, you will need to have a client that takes this into account.
 You basically need a way of making sure that while that code is
running no other client makes a call to the server running the C code.
 You also have to make sure that the client that initiated the call
doesn't make any further calls until the first is done.

The way we usually handle this is to make a separate process that
manages a queue of commands to be executed on the server.  Clients
then connect to this manager, which in turns submits them to the
actual PB server at the appropriate time.  This is a pain, but it
works extremely well.

Hope that helps.

Brian
On 7/11/07, Phil Mayers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">p.mayers at imperial.ac.uk</A>&gt; wrote:
&gt;<i> On Wed, 2007-07-11 at 00:34 +0000, s. w. wrote:
</I>&gt;<i> &gt; I'd like to use Perspective Broker to serve a set of objects remotely.
</I>&gt;<i> &gt; However, these objects wrap a non-thread-safe, blocking C api.  I'm new to
</I>&gt;<i> &gt; Twisted, but I believe I understand correctly that the blocking C api needs
</I>&gt;<i> &gt; to be accessed via threads in Twisted.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Given this, the only way I can think to use Perspective Broker would be to
</I>&gt;<i> &gt; use a special PBServerFactory/Protocol that limited the server to one
</I>&gt;<i> &gt; connected client.  For the use I would be putting the server to, this is
</I>&gt;<i> &gt; maybe not as horrible as it sounds, but it is probably as ugly as it sounds.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm hoping there's something in PB that I haven't come across that can solve
</I>&gt;<i> &gt; this problem in a more elegant way.  Any help or pointers would be greatly
</I>&gt;<i> &gt; appreciated.
</I>&gt;<i>
</I>&gt;<i> It's not specific to PB - this applied to all of Twisted, and all of
</I>&gt;<i> Twisted has the same solution.
</I>&gt;<i>
</I>&gt;<i> See &quot;deferToThread&quot; for examples of ways to call blocking APIs inside a
</I>&gt;<i> thread, and when the call returns the deferred will fire.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks,
</I>&gt;<i> &gt; Steve
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _________________________________________________________________
</I>&gt;<i> &gt; <A HREF="http://newlivehotmail.com">http://newlivehotmail.com</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Twisted-Python mailing list
</I>&gt;<i> &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt; <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="048241.html">[Twisted-Python] Perspective Broker with blocking,	non-thread-safe C api?
</A></li>
	<LI>Next message (by thread): <A HREF="048245.html">[Twisted-Python] Perspective Broker with blocking,	non-thread-safe C api?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48244">[ date ]</a>
              <a href="thread.html#48244">[ thread ]</a>
              <a href="subject.html#48244">[ subject ]</a>
              <a href="author.html#48244">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
