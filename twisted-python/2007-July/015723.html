<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] [usage] FTPClient uploading multiple files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20%5Busage%5D%20FTPClient%20uploading%20multiple%20files&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015711.html">
   <LINK REL="Next"  HREF="015724.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] [usage] FTPClient uploading multiple files</H1>
    <B>tarjei</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20%5Busage%5D%20FTPClient%20uploading%20multiple%20files&In-Reply-To="
       TITLE="[Twisted-Python] [usage] FTPClient uploading multiple files">tarjei at nu.no
       </A><BR>
    <I>Mon Jul  9 10:54:06 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015711.html">[Twisted-Python] How to receive a big stream data?
</A></li>
        <LI>Next message: <A HREF="015724.html">[Twisted-Python] file transfers in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15723">[ date ]</a>
              <a href="thread.html#15723">[ thread ]</a>
              <a href="subject.html#15723">[ subject ]</a>
              <a href="author.html#15723">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, after spending a few hours grooking the FTPClient API (with good
help from Exarkun on IRC) I thought I'd post the fruits of my work.

I hope this may help someone. If the code is usefull enough feel free to
add it to the examples in the docs.

If you see errors or got ideas on how this could be done different, feel
free to answer :-)

regards,
Tarjei


class FtpFileSave(object):

    &quot;&quot;&quot;
    A class for uploading multiple files to a ftp host.
    Usage:

    ftp = FtpFileSave(ftpFiles=['/etc/passwd', '/etc/magic'],
_pass=&quot;something&quot;,
    _username = &quot;something&quot;, host=&quot;localhost&quot;)
    ftp.save(somecallback, errorcallback)

    This will upload multiple files to the ftpserver.
    @caveat 1: as it stands the class does not change directory or
anything like that before uploading the files.
    This should be easy to add though.
    &quot;&quot;&quot;

    _pass = &quot;&quot;
    _username = &quot;&quot;
    port = 21
    host = &quot;localhost&quot;

    def __init__(self, **kwargs):
        &quot;&quot;&quot;Create a ftpfilesaver using the ftp client fromtwisted
        @param ftpFiles list of paths to the files to upload.
        &quot;&quot;&quot;
        self.__dict__.update(kwargs)
        self.nextfile = 0

    def save(self, success,error):
        &quot;&quot;&quot;Uploads a set of tiles to the ftpserver.
        @param success: the callback to be called on success
        @param error:   the callback to be called on error
        &quot;&quot;&quot;
        self.success = success

        FTPClient.debug = True
        creator = ClientCreator(reactor, FTPClient, self._username,
                    self._pass, passive=True)
        defer = creator.connectTCP(self.host,self.port)
        self.error = error
        defer.addCallback(self.connectionMade).addErrback(self.error)
        return defer

    def connectionMade(self,ftpClient):
        &quot;Checks if there are more files to upload and uploads them.
        The main point with this method is that you have to collect the
defereds of each command
        and wait until they succeed.
        &quot;
        deffereds = []
        &quot;We'll need the client to do a disconnect later&quot;
        self.client = ftpClient
        &quot; Create defereds for each of the different files to be uploaded&quot;
        for upfile in self.ftpFiles:
            if not os.path.exists(upfile):
                raise Exception(&quot;File %s not found&quot; % upfile)
            store, finish = ftpClient.storeFile(&quot;./%s&quot; %
os.path.basename(upfile))
            finish.addCallback(self.end).addErrback(self.error)
            store.addCallback(self.send_file).addErrback(self.error)
            deffereds.append(store)
            deffereds.append(finish)
        return defer.gatherResults(deffereds)

    def end(self, ftpResult):
        &quot;&quot;&quot;Close the connection when all files have been uploaded.
            @param ftpResult a list of the protocol info we get. Not
very interesting.
            @todo: check the list for errors.
        &quot;&quot;&quot;
        if (len(self.ftpFiles) &lt;= self.nextfile):
            self.client.quit()
            self.client.transport.loseConnection()
            return defer.succeed(self.success())
        return

    def send_file(self, sender):
        &quot;&quot;&quot;Open and send the file
        &quot;&quot;&quot;
        #print &quot;Storefile %d : %s&quot;  % (self.nextfile,
self.ftpFiles[self.nextfile])
        filename = self.ftpFiles[self.nextfile]
        fp = open(filename,'r')
        sender.transport.write(fp.read())
        sender.finish()
        &quot;increase the nextfile count so end() knows when it's done&quot;
        self.nextfile += 1





</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015711.html">[Twisted-Python] How to receive a big stream data?
</A></li>
	<LI>Next message: <A HREF="015724.html">[Twisted-Python] file transfers in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15723">[ date ]</a>
              <a href="thread.html#15723">[ thread ]</a>
              <a href="subject.html#15723">[ subject ]</a>
              <a href="author.html#15723">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
