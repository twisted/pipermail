<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: plus mode was Re: how winnt fileops work and	what to do about it
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20plus%20mode%20was%20Re%3A%20how%20winnt%20fileops%20work%20and%0A%09what%20to%20do%20about%20it&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012282.html">
   <LINK REL="Next"  HREF="012284.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: plus mode was Re: how winnt fileops work and	what to do about it</H1>
    <B>Paul G</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20plus%20mode%20was%20Re%3A%20how%20winnt%20fileops%20work%20and%0A%09what%20to%20do%20about%20it&In-Reply-To="
       TITLE="[Twisted-Python] Re: plus mode was Re: how winnt fileops work and	what to do about it">paul-lists at perforge.com
       </A><BR>
    <I>Sat Dec 31 17:48:29 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012282.html">[Twisted-Python] Re: plus mode was Re: how winnt fileops workand	what to do about it
</A></li>
        <LI>Next message: <A HREF="012284.html">[Twisted-Python] Re: plus mode was Re: how winnt fileops work and	what to do about it
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12281">[ date ]</a>
              <a href="thread.html#12281">[ thread ]</a>
              <a href="subject.html#12281">[ subject ]</a>
              <a href="author.html#12281">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
----- Original Message ----- 
From: &quot;Brian Warner&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">warner at lothar.com</A>&gt;
To: &quot;Twisted general discussion&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt;
Sent: Saturday, December 31, 2005 5:16 PM
Subject: [Twisted-Python] Re: plus mode was Re: how winnt fileops work and 
what to do about it


&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A> writes:
</I>&gt;<i>
</I>&gt;&gt;<i> It seems like we can work around this more easily than that, considering
</I>&gt;&gt;<i> that flush and seek are available from Twisted; the file object causing
</I>&gt;&gt;<i> problems in the tests is being returned from the open() method of a
</I>&gt;&gt;<i> FilePath object, if I understand it correctly. FilePath could include the
</I>&gt;&gt;<i> workaround far in advance of Python deciding to.
</I>&gt;<i>
</I>&gt;<i> I'm pretty sure that the real problem we're trying to solve here is caused 
</I>&gt;<i> by
</I>&gt;<i> a stuck process keeping a .pyd file open. Indeed, if you look at the
</I>&gt;<i> buildslave's logs, you'll see the exception is as follows:
</I>&gt;<i>
</I>&gt;<i> exceptions.OSError: [Errno 13] Permission denied: 
</I>&gt;<i> 'c:\\buildslave\\win32-win32er\\W32-full2.4-win32er\\Twisted\\twisted\\protocols\\_c_urlarg.pyd'
</I>&gt;<i>
</I>&gt;<i> So changing the way Twisted or its unit tests open a file is just not 
</I>&gt;<i> going
</I>&gt;<i> to help. What matters is the way python (or.. pyrex?) opens a file.
</I>&gt;<i>
</I>&gt;<i> (for context: the buildbot is currently configured to do SVN 
</I>&gt;<i> checkout/updates
</I>&gt;<i> into one directory, then copy the tree into a second directory, then run
</I>&gt;<i> tests on that second directory. This mode='copy' approach uses 'svn 
</I>&gt;<i> update'
</I>&gt;<i> to minimizes network bandwidth, but at the expense of doubling the disk 
</I>&gt;<i> usage
</I>&gt;<i> with the extra copy. At the beginning of each build, the buildslave 
</I>&gt;<i> deletes
</I>&gt;<i> the second directory with a function named rmdirRecursive() that bear
</I>&gt;<i> provided, which does a chmod() of any mis-permissioned files before 
</I>&gt;<i> deleting
</I>&gt;<i> them. It was an os.remove() inside this rmdirRecursive which raised the
</I>&gt;<i> exception).
</I>
sysinternals.com should have a utility equivalent to lsof. this is probably 
the best way to figure out who's doing this.

&gt;<i> I've run into a similar problem in the past, under Solaris, using NFS, 
</I>&gt;<i> where
</I>&gt;<i> a test case spawned off a daemon process which then didn't die when it was
</I>&gt;<i> supposed to, somehow held on to a file (I think solaris won't let you 
</I>&gt;<i> delete
</I>&gt;<i> a file that is being used as the backing store for an executable), and 
</I>&gt;<i> that
</I>&gt;<i> prevented the unlink() from succeeding.
</I>
this has to do with how execution works in unices generally. it is *not* a 
lock - there are no compulsory locks - so while the situation is somewhat 
(not very, though) similar wrt effects, it's actually completely different. 
posix semantics dictate that you can not open a file being executed for 
writing and can not execute if it's open for writing; you can, however, 
unlink because the inode doesn't get reaped until the refcount drops to 0. 
this is the case on linux systems. svr4 prohibits the unlink as well, this 
is an svr4 extension to posix. as an interesting piece of trivia to chuckle 
about, the errno for these conditions is ETXTBUSY aka Textfile Busy. (this 
is funny because executables are always binary in practice).

&gt;<i> In that environment, I just renamed the top-level directory to something
</I>&gt;<i> unique, spawned off an 'rm -rf' into the background to delete the old
</I>&gt;<i> directory if it was possible, then continued on with the next build. If 
</I>&gt;<i> the
</I>&gt;<i> code had to try too hard to come up with a unique name, it would flag a
</I>&gt;<i> warning that there might be a stuck process somewhere.
</I>
this is a valid technique, except when you're dealing with windows ;) as i 
mentioned in another post, renames (regardless of how high up in the tree 
you go) are recursive copy + recursive delete. the delete will fail. 
furthermore, SHFileOperation recursive deletes bail on first error, afair.

&gt;<i> Perhaps we could use something similar here?
</I>
no, see above.

&gt;<i> Of course, the real fix would be to find a way to let the testing code 
</I>&gt;<i> kill
</I>&gt;<i> off any stuck processes, but that'll probably be very windows-specific.
</I>
on windows, we probably want to use os.abort() and on *nix os.kill(). 
however, it is probably more interesting to figure out why processes are 
getting stuck ;)

-p 



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012282.html">[Twisted-Python] Re: plus mode was Re: how winnt fileops workand	what to do about it
</A></li>
	<LI>Next message: <A HREF="012284.html">[Twisted-Python] Re: plus mode was Re: how winnt fileops work and	what to do about it
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12281">[ date ]</a>
              <a href="thread.html#12281">[ thread ]</a>
              <a href="subject.html#12281">[ subject ]</a>
              <a href="author.html#12281">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
