<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: plus mode was Re: how winnt fileops work and what to do about it
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20plus%20mode%20was%20Re%3A%20how%20winnt%20fileops%20work%20and%0A%20what%20to%20do%20about%20it&In-Reply-To=0aff01c60df7%24c588adf0%246402a8c0%40dcore">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012258.html">
   <LINK REL="Next"  HREF="012266.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: plus mode was Re: how winnt fileops work and what to do about it</H1>
    <B>Cory Dodt</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20plus%20mode%20was%20Re%3A%20how%20winnt%20fileops%20work%20and%0A%20what%20to%20do%20about%20it&In-Reply-To=0aff01c60df7%24c588adf0%246402a8c0%40dcore"
       TITLE="[Twisted-Python] Re: plus mode was Re: how winnt fileops work and what to do about it">corydodt at twistedmatrix.com
       </A><BR>
    <I>Sat Dec 31 13:46:51 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012258.html">how winnt fileops work and what to do about it (was Re:	[Twisted-Python] Twisted windows hackers - help the tests to pass!)
</A></li>
        <LI>Next message: <A HREF="012266.html">[Twisted-Python] Re: plus mode was Re: how winnt fileops work and	what to do about it
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12262">[ date ]</a>
              <a href="thread.html#12262">[ thread ]</a>
              <a href="subject.html#12262">[ subject ]</a>
              <a href="author.html#12262">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Paul, flush fixes one kind of insanity and seek fixes another:

One ===========
$ echo abcdef &gt; foo
$ python
&gt;&gt;&gt;<i> f = file('foo', 'r+b')
</I>&gt;&gt;&gt;<i> f.write('ghi')
</I>&gt;&gt;&gt;<i> f.flush()
</I>&gt;&gt;&gt;<i> f.read()
</I>'def\n'
&gt;&gt;&gt;<i> # hooray!
</I>

Two ===========
$ echo abcdef &gt; foo
$ python
&gt;&gt;&gt;<i> f = file('foo','r+b')
</I>&gt;&gt;&gt;<i> f.read()
</I>'abcdef\n'
&gt;&gt;&gt;<i> f.seek(7, 0)
</I>&gt;&gt;&gt;<i> f.write('xyz')
</I>&gt;&gt;&gt;<i> ^D
</I>$ cat foo
abcdef
xyz
$ # hooray

Paul - Do you still think this is a Python bug?  Does anyone know if
this has already been discussed on pyml?

C



Paul G wrote:
&gt;<i> 
</I>&gt;<i> ok, i can actually chime in here because i've done filesystems work on
</I>&gt;<i> windows (don't ask ;). now, it's been a while, but i should remember
</I>&gt;<i> things reasonably accurately (i hope). see below for comments:
</I>&gt;<i> 
</I>&gt;<i> ----- Original Message ----- From: Moof
</I>&gt;<i> To: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>
</I>&gt;<i> Sent: Saturday, December 31, 2005 2:15 AM
</I>&gt;<i> Subject: Re: [Twisted-Python] Twisted windows hackers - help the tests
</I>&gt;<i> to pass!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> It's not so much a misconfiguration, as an issue with the fact that
</I>&gt;&gt;<i> trial on Window s is failing to rename its _trial_temp folder,
</I>&gt;&gt;<i> because there are files inside it that are open. I've opened a bug on
</I>&gt;&gt;<i> it over on &lt; <A HREF="http://twistedmatrix.com/bugs/issue1387">http://twistedmatrix.com/bugs/issue1387</A>&gt;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> it is incorrect to state that file deletion will always fail when the
</I>&gt;<i> file is open. let me explain how nt/ntfs/win32 does this, because it's
</I>&gt;<i> highly 'strange' to folks from a posix background. this may be way more
</I>&gt;<i> info than you were looking for, but i'm going to type it out anyway so
</I>&gt;<i> that someone can then make the call on how to deal with the issue.
</I>&gt;<i> 
</I>&gt;<i> for functionality implemented in the kernel, such as ntfs, windows has 2
</I>&gt;<i> api layers: win32 (you see CreateFile() here) and the native nt api.
</I>&gt;<i> win32 is implemented in usermode, while the native api is implemented as
</I>&gt;<i> a kernel service, which is exposed to userspace code with the Zw prefix
</I>&gt;<i> (ie ZwCreateFile()). sometimes the win32 api calls map directly,
</I>&gt;<i> sometimes they are multiplexed (ie one win32 api call may use multiple
</I>&gt;<i> native api calls to do the work). what happens here is undocumented (at
</I>&gt;<i> least officially and without an nda). what is important is that some
</I>&gt;<i> calls allow you to do things which win32 does not expose; most popular
</I>&gt;<i> ones deal with io completion (this is how you cancel async i/o on
</I>&gt;<i> windows nt).
</I>&gt;<i> 
</I>&gt;<i> now, on to the meat: the win32 CreateFile() is actually a
</I>&gt;<i> jack-of-all-trades call (horrible design), used for file creation,
</I>&gt;<i> opening *and authorization*. we're not interested in ACLs in this case,
</I>&gt;<i> but we are interested in locks - locks in nt are compulsory (as opposed
</I>&gt;<i> to purely advisory in posix) and violating one will result in an auth
</I>&gt;<i> failure. now, disregarding the ability to take out range locks (locks on
</I>&gt;<i> a byterange within a file), CreateFile() takes out certain locks based
</I>&gt;<i> on the sharemode (iirc, not sure) parameter. the rules here are funky,
</I>&gt;<i> iirc, but the one we care about is FILE_SHARE_DELETE. *unless* this flag
</I>&gt;<i> is set in sharemode passed to CreateFile(), all attempts to open this
</I>&gt;<i> file for deletion (see, authorization) going forward will fail.
</I>&gt;<i> 
</I>&gt;<i> it will fail when the file is opened exclusively. CreateFile takes a
</I>&gt;<i> parameter called sharemode, iirc, which can be a combination of
</I>&gt;<i> FILE_SHARE_READ, FILE_SHARE_WRITE, and FILE_SHARE_DELETE. *unless*
</I>&gt;<i> FILE_SHARE_DELETE is set in the flag parameter, a lock preventing
</I>&gt;<i> deletion gets taken out and you get to enjoy all the wonders of
</I>&gt;<i> compulsory locking you are hitting.
</I>&gt;<i> 
</I>&gt;<i> here's why i think this happens: win32 DeleteFile() does *not* actually
</I>&gt;<i> use ZwDeleteFile() native call to delete a file. instead, it does a
</I>&gt;<i> CreateFile() (or ZwCreateFile(), could be either) to open the file (and
</I>&gt;<i> get a handle to it), telling it the desired access is DELETE. then it
</I>&gt;<i> does a ZwSetFileInformation(), which it tells it wants to set
</I>&gt;<i> 'disposition' and passes in the appropriate disposition info struct with
</I>&gt;<i> the DELETE disposition set. you can't cheat this, because
</I>&gt;<i> ZwSetInformation() will fail if the handle doesn't have DELETE rights,
</I>&gt;<i> and you won't get them if the file isn't opened with FILE_SHARE_DELETE.
</I>&gt;<i> bummer. the reason this is all so roundabout is that the file whose
</I>&gt;<i> disposition is set to DELETE doesn't actually get deleted until the last
</I>&gt;<i> handle is ZwClose()'d - this is where the deletion takes place. now,
</I>&gt;<i> this is from memory, so don't hold me to it exactly, but the jist of it
</I>&gt;<i> should be correct.
</I>&gt;<i> 
</I>&gt;<i> the interesting, albeit non-obvious, question is: what does
</I>&gt;<i> ZwDeleteFile() do? it takes either a handle *or a path* and deletes it
</I>&gt;<i> *right away*, without waiting for handles to be closed. now, i don't
</I>&gt;<i> know whether it bypasses the ZwCreateFile() and hence the DELETE check,
</I>&gt;<i> but there's a chance that it is the call ZwClose() makes internally when
</I>&gt;<i> it does a delete based on the disposition (this guess would be supported
</I>&gt;<i> by the fact that ZwCreateFile() and a few other fs calls are documented
</I>&gt;<i> in msdn/ddk, but ZwDeleteFile() is not) and hence doesn't hit this
</I>&gt;<i> check. what is even more interesting is that, in win32, the only way to
</I>&gt;<i> remove a directory is using RemoveDirectory(), which requires the
</I>&gt;<i> directory to be empty. you have to recursively delete all contents,
</I>&gt;<i> either by hand or using SHFileOperation, iirc. this is the op that hits
</I>&gt;<i> your open files problem. i remember seeing code (this part i didn't work
</I>&gt;<i> on, but did read brielfy) which deleted directories with ZwDeleteFile()
</I>&gt;<i> and there was no resurive content deletion code, so i suspect that you
</I>&gt;<i> could delete a non-empty directory this way. neither of this is valid
</I>&gt;<i> ntfs usage, so doing it may not be kosher.
</I>&gt;<i> 
</I>&gt;<i> whatever the case may be, those two options are available if you can
</I>&gt;<i> stomach them.
</I>&gt;<i> 
</I>&gt;&gt;<i> It's
</I>&gt;&gt;<i> going to need a rethink on how _trial_temp works, because my instant
</I>&gt;&gt;<i> thought on how to solve was &quot;symlinks&quot; and python
</I>&gt;&gt;<i> doesn't support them on windows, mostly because windows' own support
</I>&gt;&gt;<i> of them is a tad on the &quot;dont' ask, don't tell&quot; side of
</I>&gt;&gt;<i> things, and NTFS-only anyway.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> NTFS and DFS, but yeah, no FAT (if anyone cares). symlinks in ntfs can
</I>&gt;<i> be implemented using what's called 'reparse points'. these are actually
</I>&gt;<i> quite powerful - you can attach either a static transformation or code
</I>&gt;<i> (you need a driver for this, iirc) to a certain dentry  these symlinks
</I>&gt;<i> are called 'junctions', but they work only for directories. currently,
</I>&gt;<i> all of this is extremely hairy to use. there are also hardlinks, which
</I>&gt;<i> you can actually create with the win32 api, but they are only for files 
</I>&gt;<i> moreover, none of this behaves like symlinks and hardlinks in terms of
</I>&gt;<i> finer semantics (ie unlinking). junctions are most closely related to
</I>&gt;<i> mount --bind, rather than symlinks, for example.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> with all of the above said, you've basically got these choices (in no
</I>&gt;<i> particular order) to deal with the issue at hand:
</I>&gt;<i> 
</I>&gt;<i> 1. change the offending code not to do this rename
</I>&gt;<i> 2. instead of a rename, create a new directory, do a recursive copy into
</I>&gt;<i> it from the original and retry removing the original directory
</I>&gt;<i> asynchronously until it succeeds. obviously, the file handles which are
</I>&gt;<i> open at that point will be referencing a different copy of the files
</I>&gt;<i> from the ones which will be opened subsequently.
</I>&gt;<i> 3. test whether the zwDeleteFile() behaves in the way i conjrectured it
</I>&gt;<i> to (wrt files or directories). if so, cause it to be implemented in the
</I>&gt;<i> pywin32 extension and use it to perform the delete.
</I>&gt;<i> 4. test whether you can either use ZwSetFileInformation() to rename
</I>&gt;<i> directories by changing the FILE_NAME attr in the appropriate info
</I>&gt;<i> structure or use it to move by renaming files which are open, again
</I>&gt;<i> using the appropriate (but different) structure.
</I>&gt;<i> if so, implement this or cause this to be implemented in pywin32. it is
</I>&gt;<i> unclear (to me) whether this would result in the pre-move file handles
</I>&gt;<i> being dead, stale or correct.
</I>&gt;<i> 5. instead of opening the files as normal, open them with pywin32's
</I>&gt;<i> implementation of CreateFile(), specifying the appropriate sharemode.
</I>&gt;<i> this will allow the rename (move really) to go through, but it is
</I>&gt;<i> unclear what happens to the preexisting filehandles.
</I>&gt;<i> 6. implement, or cause to be implemented, CreateHardlink() in pywin32.
</I>&gt;<i> create a new directory and recursively hardlink contents of the original
</I>&gt;<i> into the new directory. asynchronously retry recursive deletion of the
</I>&gt;<i> original one.
</I>&gt;<i> 
</I>&gt;<i> that's all i can think of anyway.
</I>&gt;<i> 
</I>&gt;&gt;<i> MFen tracked down an error involving &quot;r+b&quot; mode. Seems windows
</I>&gt;&gt;<i> handling of it is insane. See
</I>&gt;&gt;<i> &gt;&lt;<A HREF="http://twistedmatrix.com/bugs/issue1386">http://twistedmatrix.com/bugs/issue1386</A>&gt;. This could well be a
</I>&gt;&gt;<i> python bug, or a feature of windows.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> i'm not sure how python does file opens and i/o on windows. with that
</I>&gt;<i> said, assuming that it uses fopen() from the visual studio c runtime
</I>&gt;<i> library, there is a quirk in the implementation that might be causing
</I>&gt;<i> this. if you use any of the + modes, ie a+, r+ or w+. when you switch
</I>&gt;<i> between reading and writing you need to do an fflush() or fsetpos()
</I>&gt;<i> (possibly some others like fseek() could work too, don't remember). try
</I>&gt;<i> doing a file.flush() on your file object somewhere in there and see if
</I>&gt;<i> that fixes things for you. if it does, this should probably be reported
</I>&gt;<i> as a python stdlib bug.
</I>&gt;<i> 
</I>&gt;<i> it's really late, so pardon the wordiness and possible inaccuracies due
</I>&gt;<i> to memory lapses.
</I>&gt;<i> 
</I>&gt;<i> hth,
</I>&gt;<i> -p
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.1 (MingW32)
Comment: Using GnuPG with Thunderbird - <A HREF="http://enigmail.mozdev.org">http://enigmail.mozdev.org</A>

iD8DBQFDttEp3A5SrXAiHQcRAq4gAJ4pZQS+vFSlKqS8RvJe8ialmzANEgCfe4BL
G4OrBEocHxEcB3LD3tpr1OY=
=XA5K
-----END PGP SIGNATURE-----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012258.html">how winnt fileops work and what to do about it (was Re:	[Twisted-Python] Twisted windows hackers - help the tests to pass!)
</A></li>
	<LI>Next message: <A HREF="012266.html">[Twisted-Python] Re: plus mode was Re: how winnt fileops work and	what to do about it
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12262">[ date ]</a>
              <a href="thread.html#12262">[ thread ]</a>
              <a href="subject.html#12262">[ subject ]</a>
              <a href="author.html#12262">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
