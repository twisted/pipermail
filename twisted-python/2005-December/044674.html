<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Some beginner questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Some%20beginner%20questions%0A%09about%09%22twisted.names.client%22%20and%20%22.tac%22%20environment&In-Reply-To=%3C20051218005504.1217.2114116549.divmod.quotient.6796%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044673.html">
   <LINK REL="Next"  HREF="044675.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Some beginner questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Some%20beginner%20questions%0A%09about%09%22twisted.names.client%22%20and%20%22.tac%22%20environment&In-Reply-To=%3C20051218005504.1217.2114116549.divmod.quotient.6796%40ohm%3E"
       TITLE="[Twisted-Python] Some beginner questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment">exarkun at divmod.com
       </A><BR>
    <I>Sat Dec 17 17:55:04 MST 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044673.html">[Twisted-Python] Some beginner questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
        <LI>Next message (by thread): <A HREF="044675.html">[Twisted-Python] Some beginner	questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44674">[ date ]</a>
              <a href="thread.html#44674">[ thread ]</a>
              <a href="subject.html#44674">[ subject ]</a>
              <a href="author.html#44674">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 18 Dec 2005 01:05:32 +0100, Jesus Cea &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jcea at argo.es</A>&gt; wrote:
&gt;<i>-----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i>Hash: SHA1
</I>&gt;<i>
</I>&gt;<i>Jean-Paul Calderone wrote:
</I>&gt;&gt;<i> You probably want to move most of your program out if &quot;dns.tac&quot; and into
</I>&gt;&gt;<i> an importable Python module.  Code defined inside .tac files lives in a
</I>&gt;&gt;<i> weird world where some surprising rules apply.
</I>&gt;<i>
</I>&gt;<i>Any documentation about that?
</I>&gt;<i>
</I>
Hmmm, not that I know of.  The problems are all essentially consequences of the fact that .tac files are run using the built-in execfile() function (or equivalent), rather than being loaded as modules.

&gt;&gt;<i> It's best to keep the
</I>&gt;&gt;<i> .tac file as short as possible.  Generally, you just want to create an
</I>&gt;&gt;<i> Application and give it some children, importing from modules the
</I>&gt;&gt;<i> definitions of all classes and functions needed to set this up.
</I>&gt;<i>
</I>&gt;<i>I reduced the &quot;dns3.tac&quot; to:
</I>&gt;<i>
</I>&gt;<i>=====
</I>&gt;<i>
</I>&gt;<i>from twisted.application import service
</I>&gt;<i>
</I>&gt;<i>application = service.Application(&quot;DNS test&quot;)
</I>&gt;<i>
</I>&gt;<i>import sys
</I>&gt;<i>sys.path=[&quot;.&quot;]+sys.path
</I>&gt;<i>import dns3
</I>&gt;<i>
</I>&gt;<i>=====
</I>&gt;<i>
</I>&gt;<i>All logic is in &quot;dns3.tac&quot;. Basically the same code posted in my
</I>&gt;<i>previous message.
</I>&gt;<i>
</I>&gt;<i>I have the very same problem with &quot;reactor.stop()&quot;: repeated exceptions,
</I>&gt;<i>only stoppable using &quot;kill -9&quot;.
</I>&gt;<i>
</I>&gt;<i>I don't get the &quot;give it some children&quot; point. Could you post some
</I>&gt;<i>sample code?.
</I>
You want to tie your application logic to a Service subclass.  To start with, I'd try something like this, in dns3.py:

  from twisted.application import service

  class DomainResolver(service.Service):
      def startService(self):
          # Copied the top-level code from the original dns.tac
          pendientes = []
          redirigidos = []
          f = open(&quot;domain_list&quot;)
          for i in f :
              pendientes.append(i)
          aun_pendientes = len(pendientes)
          concurrencia = 1000
          for i in pendientes[:concurrencia]:
              resolucion(i)
          pendientes=pendientes[concurrencia:]

Then, in dns3.tac after application is defined,

    from dns import DomainResolver
    DomainResolver().setServiceParent(application)

This will delay the execution of your startup code until twistd is totally ready and the reactor is fully initialized.

&gt;<i>
</I>&gt;&gt;<i> Passing (60,) as the timeout might not be the best idea.  This will
</I>&gt;&gt;<i> cause the DNS client to send one request and then wait 60 seconds for a
</I>&gt;&gt;<i> response.  If either the request or the response is dropped (as often
</I>&gt;&gt;<i> happens with UDP traffic), you will never get a result, and you will
</I>&gt;&gt;<i> have to wait 60 seconds to discover this fact.
</I>&gt;<i>
</I>&gt;<i>I'm resolving several thousand of domains, so one minute more or less is
</I>&gt;<i>not an issue. I don't want to retransmit since I'm using 127.0.0.1, so
</I>&gt;<i>losing request (in the same machine) should be rare (udp backlog
</I>&gt;<i>overflow, basically).
</I>&gt;<i>
</I>&gt;<i>Some domains takes a long time to resolve. So if I use an small value I
</I>&gt;<i>load the server and get &quot;Unexpected message (XXXXX) received from
</I>&gt;<i>('127.0.0.1', 53)&quot;, caused because the DNS server gets a late answers
</I>&gt;<i>and my code already give up.
</I>&gt;<i>
</I>
Okay, it sounds like you know what you're doing here :)

&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;&gt;<i> To customize the server used by the resolver, you may want to create
</I>&gt;&gt;<i> your own resolver instance, rather than relying on the defaults guessed
</I>&gt;&gt;<i> by the resolver automatically created in the client module.
</I>&gt;<i>
</I>&gt;<i>Also a good point. Done and working fine.
</I>&gt;<i>
</I>&gt;<i>How can I easily use the cache resolver?. My problem is updating the
</I>&gt;<i>cache when I get a response thru the network. In a long running daemon,
</I>&gt;<i>caching DNS when I'm serving several hundreds of email for day woul dbe
</I>&gt;<i>a big win.
</I>&gt;<i>
</I>&gt;<i>Maybe with my own overloaded cache class, but seems an obvious addition
</I>&gt;<i>to standard twisted.names. :-? Maybe next release :-)
</I>
I think the current caching resolver was a step in the wrong direction.  A cache should probably *wrap* another resolver, not whatever weird thing it is doing now.

If you write such a thing, it'd be great if you could submit it for inclusion :)

&gt;<i>
</I>&gt;&gt;<i> Hmm.  The non-existence of the domain is hidden by the very last step in
</I>&gt;&gt;<i> performing the lookup.  The Resolver class has a method, filterAnswers,
</I>&gt;&gt;<i> which is used to turn a DNS response into the three-tuple of lists which
</I>&gt;&gt;<i> all the lookup* methods return.  You may want to subclass Resolver and
</I>&gt;&gt;<i> override filterAnswers to behave differently when the `message' argument
</I>&gt;&gt;<i> it is given has an `rCode' attribute equal to twisted.names.dns.ENAME,
</I>&gt;&gt;<i> which indicates the name requested does not exist.
</I>&gt;<i>
</I>&gt;<i>That seems doable but an ugly hack :-). Perhaps a future &quot;twisted.named&quot;
</I>&gt;<i>release could include a flag to easily differenciate between missing RR
</I>&gt;<i>and nonexistent domain. Any hope?.
</I>
I think flags like this are ugly hacks as well.  I completely agree that subclass/override is not a great way to get this functionality, but I'd like to think of a cleaner way to offer the new feature while still maintaining backwards compatibility.

&gt;<i>
</I>&gt;&gt;&gt;<i> 3. How can I stop this &quot;.tac&quot;?. If I do &quot;reactor.stop()&quot;, I get an
</I>&gt;&gt;&gt;<i> infinite error, repeated forever:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> reactor.stop() is the correct way to end the program.  If you still have
</I>&gt;&gt;<i> this problem after you have split the program into multiple files,
</I>&gt;&gt;<i> please post again.
</I>&gt;<i>
</I>&gt;<i>Program splitted. Same problem :-/
</I>&gt;<i>
</I>&gt;<i>The dode is basically the same that in my previous email. Moved 99% of
</I>&gt;<i>code to &quot;dns3.py&quot;. The dns3.tac&quot; is trivial:
</I>
Try the service class I used above.  If you still see the exception, it may indicate a bug in Twisted's UDP support.  If this case, could you attach the new version of the whole program?  I'll take a closer look and see if I can nail down the exact cause.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044673.html">[Twisted-Python] Some beginner questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
	<LI>Next message (by thread): <A HREF="044675.html">[Twisted-Python] Some beginner	questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44674">[ date ]</a>
              <a href="thread.html#44674">[ thread ]</a>
              <a href="subject.html#44674">[ subject ]</a>
              <a href="author.html#44674">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
