<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Some beginner	questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Some%20beginner%0A%09questions%09about%09%22twisted.names.client%22%20and%20%22.tac%22%20environment&In-Reply-To=20051218005504.1217.2114116549.divmod.quotient.6796%40ohm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012166.html">
   <LINK REL="Next"  HREF="012168.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Some beginner	questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment</H1>
    <B>Jesus Cea</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Some%20beginner%0A%09questions%09about%09%22twisted.names.client%22%20and%20%22.tac%22%20environment&In-Reply-To=20051218005504.1217.2114116549.divmod.quotient.6796%40ohm"
       TITLE="[Twisted-Python] Some beginner	questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment">jcea at argo.es
       </A><BR>
    <I>Sun Dec 18 10:16:06 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012166.html">[Twisted-Python] Some beginner questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
        <LI>Next message: <A HREF="012168.html">[Twisted-Python] Problem w/ TNPE Example on Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12167">[ date ]</a>
              <a href="thread.html#12167">[ thread ]</a>
              <a href="subject.html#12167">[ subject ]</a>
              <a href="author.html#12167">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Jean-Paul Calderone wrote:

&gt;<i> You want to tie your application logic to a Service subclass.  To start
</I>&gt;<i> with, I'd try something like this, in dns3.py:
</I>
The very same error :-(.

My code for &quot;dns3.tac&quot;:

=====

from twisted.application import service

application = service.Application(&quot;DNS test&quot;)

import sys
sys.path=[&quot;.&quot;]+sys.path

from dns3 import DomainResolver
DomainResolver().setServiceParent(application)

=====

My code for &quot;dns3.py&quot;:

=====

class resolucion(object) :
  def __init__(self,dominio) :
    global myResolver
    d = myResolver.lookupMailExchange(dominio,timeout=(1,))
    d.addCallbacks(self._cbMailExchange, self._ebMailExchange)
    self.dominio=dominio

  def _cbMailExchange(self,results):
    # Callback for MX query
    global aun_pendientes
    aun_pendientes-=1
    if not aun_pendientes :
      import time
      print &quot;OK&quot;,time.time()-t
      #return
      from twisted.internet import reactor
      reactor.stop()
      return
    if not len(pendientes) :
      return

    resolucion(pendientes.pop())
    from twisted.names import dns
    for i in results[0] :
      n=i.payload.name
      tipo=i.payload.TYPE
      if tipo==dns.MX :
        return
        p=i.payload.preference
        print n,p,
        for j in results[2] :
          if n==j.name :
            print j.payload.dottedQuad(),&quot;(%d)&quot; %j.ttl
            break
        else :
          print &quot;???&quot;
      elif tipo==dns.CNAME :
        redirigidos.append((self.dominio,i.payload.name))

  def _ebMailExchange(self,failure):
    # Error callback for MX query
    global aun_pendientes
    aun_pendientes-=1
    if not aun_pendientes :
      import time
      print &quot;ERROR&quot;,time.time()-t
      #return
      from twisted.internet import reactor
      reactor.stop()
      return
    if not len(pendientes) :
      return

    resolucion(pendientes.pop())
    print &quot;XXX&quot;,self.dominio
    print 'Lookup failed:'
    failure.printTraceback()



from twisted.application import service

class DomainResolver(service.Service):
  def startService(self) :
    global pendientes,redirigidos,aun_pendientes,t,myResolver

    from twisted.names import client
    myResolver=client.Resolver(servers=[('127.0.0.1', 53)])

    import time
    t=time.time()

    pendientes=[]
    redirigidos=[]

    f=open(&quot;z1&quot;)
    for i in f :
      pendientes.append(i.split()[0])
    f.close()

    aun_pendientes=len(pendientes)

    concurrencia=1

    for i in pendientes[:concurrencia] :
      resolucion(i)

    pendientes=pendientes[concurrencia:]

=====


&gt;<i> This will delay the execution of your startup code until twistd is
</I>&gt;<i> totally ready and the reactor is fully initialized.
</I>
Done, but not working :-(

[... DNS timeouts ...]
&gt;<i> Okay, it sounds like you know what you're doing here :)
</I>
I like to think so };-)

&gt;<i> I think the current caching resolver was a step in the wrong direction. 
</I>&gt;<i> A cache should probably *wrap* another resolver, not whatever weird
</I>&gt;<i> thing it is doing now.
</I>
I agree. Perhaps a subclass of the network DNS resolver could be fine.
So we could have a &quot;client&quot; class and a &quot;cachingClient&quot; one.

In any case, current code simply doesn't cache anything, but eats CPU
cycles.

&gt;<i> If you write such a thing, it'd be great if you could submit it for
</I>&gt;<i> inclusion :)
</I>
I'm not familiar enough with Twisted internal, yet, to try.
Nevertheless, I would suggest an optional parameter in the caching
resolver constructor, pointing to a callable object to resolve misses.
Sort of. Code changes would be minimal...

[... about differenciatiing DNS misses from RR misses...]
&gt;<i> I think flags like this are ugly hacks as well.  I completely agree that
</I>&gt;<i> subclass/override is not a great way to get this functionality, but I'd
</I>&gt;<i> like to think of a cleaner way to offer the new feature while still
</I>&gt;<i> maintaining backwards compatibility.
</I>
Keep me informed :-p

&gt;<i> Try the service class I used above.  If you still see the exception, it
</I>&gt;<i> may indicate a bug in Twisted's UDP support.  If this case, could you
</I>&gt;<i> attach the new version of the whole program?  I'll take a closer look
</I>&gt;<i> and see if I can nail down the exact cause.
</I>
Not working. Same exception. Code posted.

Thanks a lot for your help, Jean Paul. Greatly appreciated.

- --
Jesus Cea Avion                         _/_/      _/_/_/        _/_/_/
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jcea at argo.es</A> <A HREF="http://www.argo.es/~jcea/">http://www.argo.es/~jcea/</A> _/_/    _/_/  _/_/    _/_/  _/_/
                                      _/_/    _/_/          _/_/_/_/_/
PGP Key Available at KeyServ   _/_/  _/_/    _/_/          _/_/  _/_/
&quot;Things are not so easy&quot;      _/_/  _/_/    _/_/  _/_/    _/_/  _/_/
&quot;My name is Dump, Core Dump&quot;   _/_/_/        _/_/_/      _/_/  _/_/
&quot;El amor es poner tu felicidad en la felicidad de otro&quot; - Leibniz
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.2 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <A HREF="http://enigmail.mozdev.org">http://enigmail.mozdev.org</A>

iQCVAwUBQ6V9Nplgi5GaxT1NAQKAOwP9H251Jjvd/kNPJf7R+S9faHN9YFcSBluL
YgBleuECDUG5WvJV2O+ZJwkHr05+qQ4qGzD13ydWnxdNCG1UMgWmIJ+TNfu2hOKN
L+rQmNKIUKuPFTOHA+tACYqJaE9rkkcJumR7FON81kNJdEShs52aNUlnc1Q6A9IB
iFyfaa9jcVI=
=V82G
-----END PGP SIGNATURE-----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012166.html">[Twisted-Python] Some beginner questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
	<LI>Next message: <A HREF="012168.html">[Twisted-Python] Problem w/ TNPE Example on Windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12167">[ date ]</a>
              <a href="thread.html#12167">[ thread ]</a>
              <a href="subject.html#12167">[ subject ]</a>
              <a href="author.html#12167">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
