<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] threading issues with DB connection pooling and	ReconnectingClientFactory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20threading%20issues%20with%20DB%20connection%20pooling%20and%0A%09ReconnectingClientFactory&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012149.html">
   <LINK REL="Next"  HREF="012151.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] threading issues with DB connection pooling and	ReconnectingClientFactory</H1>
    <B>Andreas Poisel</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20threading%20issues%20with%20DB%20connection%20pooling%20and%0A%09ReconnectingClientFactory&In-Reply-To="
       TITLE="[Twisted-Python] threading issues with DB connection pooling and	ReconnectingClientFactory">a.poisel at acat.cc
       </A><BR>
    <I>Tue Dec 13 18:04:46 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012149.html">[Twisted-Python] How can I keep data integrity in multiple	threads environment
</A></li>
        <LI>Next message: <A HREF="012151.html">[Twisted-Python] threading issues with DB connection pooling and	ReconnectingClientFactory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12150">[ date ]</a>
              <a href="thread.html#12150">[ thread ]</a>
              <a href="subject.html#12150">[ subject ]</a>
              <a href="author.html#12150">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Twisted Experts,

in my application I use ReconnectingClientFactory to handle a TCP
connection which is supposed to be permanent.  The server side (which is
not a twisted application) is very fragile and closes the connection
frequently.

The client has to do database queries on a regular basis and talk to the
server depending on the query results.  The client runs into a problem
with the following application flow:

 - Client and server are up and running, the database is queried
   frequently, server talks to client and vice versa, everything is
   fine.

 - The server closes the connection and the client stops it's database
   queries.

 - The server is reachable again, the client reconnects.

 - A database query on the client side is performed and we find
   something we want to transmit to the server.  But we fail because the
   transport object we use after our database query is not connected
   (transport.connected == 0 and transport.disconnected == 1).


These are my conclusions (maybe that's garbage):

The reconnection of the client works perfectly for the main reactor
thread.  But when we try a database query, we get a cached thread which
doesn't have a working transport object anymore.  Some experiments with
protocol and transport object id()s seem to second this assumption.

I've some ideas how to solve this problem:

 - Empty the thread pool after reconnecting and use &quot;fresh threads&quot; with
   valid transport objects.  I can't find a hint how to do this.

 - Pass a valid transport object to the thread which just did the
   database query.  I'm not sure how to do this properly.

 - Pass the query result back to the main thread.  Hmmm...


I would very much appreciate some hints on how to handle this problem
properly.

Thank you very much!
-- 
Regards, Andi


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012149.html">[Twisted-Python] How can I keep data integrity in multiple	threads environment
</A></li>
	<LI>Next message: <A HREF="012151.html">[Twisted-Python] threading issues with DB connection pooling and	ReconnectingClientFactory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12150">[ date ]</a>
              <a href="thread.html#12150">[ thread ]</a>
              <a href="subject.html#12150">[ subject ]</a>
              <a href="author.html#12150">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
