<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: plus mode was Re: how winnt fileops work and what to do about it
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20plus%20mode%20was%20Re%3A%20how%20winnt%20fileops%20work%20and%0A%20what%20to%20do%20about%20it&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012275.html">
   <LINK REL="Next"  HREF="012280.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: plus mode was Re: how winnt fileops work and what to do about it</H1>
    <B>Brian Warner</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20plus%20mode%20was%20Re%3A%20how%20winnt%20fileops%20work%20and%0A%20what%20to%20do%20about%20it&In-Reply-To="
       TITLE="[Twisted-Python] Re: plus mode was Re: how winnt fileops work and what to do about it">warner at lothar.com
       </A><BR>
    <I>Sat Dec 31 17:16:39 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012275.html">[Twisted-Python] Re: r15451 - Fix test failures under windows	by changing the eventual-send operation to
</A></li>
        <LI>Next message: <A HREF="012280.html">[Twisted-Python] Re: plus mode was Re: how winnt fileops work	and what to do about it
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12277">[ date ]</a>
              <a href="thread.html#12277">[ thread ]</a>
              <a href="subject.html#12277">[ subject ]</a>
              <a href="author.html#12277">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A> writes:

&gt;<i> It seems like we can work around this more easily than that, considering
</I>&gt;<i> that flush and seek are available from Twisted; the file object causing
</I>&gt;<i> problems in the tests is being returned from the open() method of a
</I>&gt;<i> FilePath object, if I understand it correctly. FilePath could include the
</I>&gt;<i> workaround far in advance of Python deciding to.
</I>
I'm pretty sure that the real problem we're trying to solve here is caused by
a stuck process keeping a .pyd file open. Indeed, if you look at the
buildslave's logs, you'll see the exception is as follows:

 exceptions.OSError: [Errno 13] Permission denied: 'c:\\buildslave\\win32-win32er\\W32-full2.4-win32er\\Twisted\\twisted\\protocols\\_c_urlarg.pyd'

So changing the way Twisted or its unit tests open a file is just not going
to help. What matters is the way python (or.. pyrex?) opens a file.

(for context: the buildbot is currently configured to do SVN checkout/updates
into one directory, then copy the tree into a second directory, then run
tests on that second directory. This mode='copy' approach uses 'svn update'
to minimizes network bandwidth, but at the expense of doubling the disk usage
with the extra copy. At the beginning of each build, the buildslave deletes
the second directory with a function named rmdirRecursive() that bear
provided, which does a chmod() of any mis-permissioned files before deleting
them. It was an os.remove() inside this rmdirRecursive which raised the
exception).


I've run into a similar problem in the past, under Solaris, using NFS, where
a test case spawned off a daemon process which then didn't die when it was
supposed to, somehow held on to a file (I think solaris won't let you delete
a file that is being used as the backing store for an executable), and that
prevented the unlink() from succeeding.

In that environment, I just renamed the top-level directory to something
unique, spawned off an 'rm -rf' into the background to delete the old
directory if it was possible, then continued on with the next build. If the
code had to try too hard to come up with a unique name, it would flag a
warning that there might be a stuck process somewhere.

Perhaps we could use something similar here?

Of course, the real fix would be to find a way to let the testing code kill
off any stuck processes, but that'll probably be very windows-specific.


cheers,
 -Brian


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012275.html">[Twisted-Python] Re: r15451 - Fix test failures under windows	by changing the eventual-send operation to
</A></li>
	<LI>Next message: <A HREF="012280.html">[Twisted-Python] Re: plus mode was Re: how winnt fileops work	and what to do about it
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12277">[ date ]</a>
              <a href="thread.html#12277">[ thread ]</a>
              <a href="subject.html#12277">[ subject ]</a>
              <a href="author.html#12277">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
