<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Some%20beginner%20questions%20about%0A%09%22twisted.names.client%22%20and%20%22.tac%22%20environment&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012161.html">
   <LINK REL="Next"  HREF="012163.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment</H1>
    <B>Jesus Cea</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Some%20beginner%20questions%20about%0A%09%22twisted.names.client%22%20and%20%22.tac%22%20environment&In-Reply-To="
       TITLE="[Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment">jcea at argo.es
       </A><BR>
    <I>Sat Dec 17 17:14:10 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012161.html">[Twisted-Python] WSGI Thread-management strategy
</A></li>
        <LI>Next message: <A HREF="012163.html">[Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12162">[ date ]</a>
              <a href="thread.html#12162">[ thread ]</a>
              <a href="subject.html#12162">[ subject ]</a>
              <a href="author.html#12162">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Twisted 2.1, twisted.named 0.2, here.

I'm taking my first steps with Twisted (documentation -inexistence-
nightmare :-), and my first project will be a bulk mailer as the backend
of my mailing list system.

The application would take the message and the subscriber list and a)
resolve the MX for the domains and b) connect to the MX's and send the
message, trying to minimice traffic sending a single envelope for
several recipients sharing the domain or the MX's.

I'm doing currently the DNS stuff. The result are promising, resolving
about 200 domains per second in a 1.4GHz P4, so my biggest mailing list
(about 31500 unique domains, m&#250;ltiple subscribers per domain) is
&quot;resolved&quot; in less than three minutes.

Nice so far. The demo code (2Kbytes) is the following (if I'm violating
the rules posting this code, please tell me):

=====
# File &quot;dns.tac&quot;

from twisted.application import service

application = service.Application(&quot;DNS test&quot;)

import time
t=time.time()

class resolucion(object) :
  def __init__(self,dominio) :
    from twisted.names import client
    d = client.lookupMailExchange(dominio,timeout=(60,))
    d.addCallbacks(self._cbMailExchange, self._ebMailExchange)
    self.dominio=dominio

  def _cbMailExchange(self,results):
    # Callback for MX query
    global aun_pendientes
    aun_pendientes-=1
    if not aun_pendientes :
      print &quot;OK&quot;,time.time()-t
      return
      from twisted.internet import reactor
      reactor.stop()
      return
    if not len(pendientes) :
      return

    resolucion(pendientes.pop())
    from twisted.names.dns import QUERY_TYPES
    for i in results[0] :
      n=i.payload.name
      tipo=QUERY_TYPES[i.payload.TYPE]
      if tipo==&quot;MX&quot; :
        return
        p=i.payload.preference
        print n,p,
        for j in results[2] :
          if n==j.name :
            print j.payload.dottedQuad(),&quot;(%d)&quot; %j.ttl
            break
        else :
          print &quot;???&quot;
      elif tipo==&quot;CNAME&quot; :
        redirigidos.append((self.dominio,i.payload.name))

  def _ebMailExchange(self,failure):
    # Error callback for MX query
    global aun_pendientes
    aun_pendientes-=1
    if not aun_pendientes :
      print &quot;ERROR&quot;,time.time()-t
      return
      from twisted.internet import reactor
      reactor.stop()
      return
    if not len(pendientes) :
      return

    resolucion(pendientes.pop())
    print &quot;XXX&quot;,self.dominio
    print 'Lookup failed:'
    failure.printTraceback()

pendientes=[]
redirigidos=[]

f=open(&quot;domain_list&quot;)
for i in f :
  pendientes.append(i)

aun_pendientes=len(pendientes)

concurrencia=1000

for i in pendientes[:concurrencia] :
  resolucion(i)

from twisted.names import client
client.theResolver.resolvers[-1].dynServers=[('127.0.0.1', 53)]
# client.theResolver.resolvers=[client.theResolver.resolvers[-1]]

pendientes=pendientes[concurrencia:]

=====

I launch the code as &quot;twistd -ny dns.tac&quot;.

The demo does 1000 resolutions in parallel. If you experiment with the
code, reduce the value.

Questions:

1. I get a warning: &quot;[Uninitialized]
/usr/local/lib/python2.4/site-packages/twisted/names/dns.py:1227:
exceptions.DeprecationWarning: Deferred.setTimeout is deprecated.  Look
for timeout support specific to the API you are using instead.&quot;

 I'm using, the native &quot;twisted.names&quot; timeout API, as far as I know...

2. By default &quot;twisted.names.client&quot; uses the &quot;/etc/resolv.conf&quot; file to
know which nameservers to use. I, nevertheless, want to use a particular
nameserver, so:

 2.1. I couldn't to find an appropiate API. I had to do a &quot;hack&quot;,
reading the &quot;twisted.names&quot; core to know implementation details:
&quot;client.theResolver.resolvers[-1].dynServers=[('127.0.0.1', 53)]&quot;

 2.2. The previous &quot;hack&quot; is only effective for future
&quot;twisted.names.client&quot; instances. The previous ones use the
&quot;/etc/resolv.conf&quot; entries. Putting the &quot;hack&quot; code before any instance
creation doesn't work.

 2.3. While reading the framework code, I saw that &quot;client&quot; uses a
resolver chain: host, cache, network. But the cache is initially clear
(of course) and NEVER ever gets populated, so we are not using it but
checking missing entries eats CPU: 155 seconds for the unchanged code,
125 seconds if I drop the host and cache resolvers.

 A caching client would be very nice, if the client is long running (my
original idea).

 2.4. The resolution failure code is only called if the resolution
timeouts. But if the domain doesn't exists, the code called is the
&quot;success&quot; one, with a &quot;nil&quot; answer. So we can't diferenciate between
inexistant domains and inexistant RRs.

3. How can I stop this &quot;.tac&quot;?. If I do &quot;reactor.stop()&quot;, I get an
infinite error, repeated forever:

=====

[twisted.names.dns.DNSDatagramProtocol (UDP)] Traceback (most recent
call last):
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/python/log.py&quot;, line 43,
in callWithContext
            return context.call({ILogContext: newCtx}, func, *args, **kw)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/python/context.py&quot;, line
59, in callWithContext
            return self.currentContext().callWithContext(ctx, func,
*args, **kw)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/python/context.py&quot;, line
37, in callWithContext
            return func(*args,**kw)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/selectreactor.py&quot;,
line 139, in _doReadOrWrite
            why = getattr(selectable, method)()
        --- &lt;exception caught here&gt; ---
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/udp.py&quot;, line
113, in doRead
            data, addr = self.socket.recvfrom(self.maxPacketSize)
        exceptions.AttributeError: 'Port' object has no attribute 'socket'

=====

I must kill -9 the &quot;twistd&quot; process.

Thank you for your time and attention. Help greatly appreciated :-)

- --
Jesus Cea Avion                         _/_/      _/_/_/        _/_/_/
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jcea at argo.es</A> <A HREF="http://www.argo.es/~jcea/">http://www.argo.es/~jcea/</A> _/_/    _/_/  _/_/    _/_/  _/_/
                                      _/_/    _/_/          _/_/_/_/_/
PGP Key Available at KeyServ   _/_/  _/_/    _/_/          _/_/  _/_/
&quot;Things are not so easy&quot;      _/_/  _/_/    _/_/  _/_/    _/_/  _/_/
&quot;My name is Dump, Core Dump&quot;   _/_/_/        _/_/_/      _/_/  _/_/
&quot;El amor es poner tu felicidad en la felicidad de otro&quot; - Leibniz
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.2 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <A HREF="http://enigmail.mozdev.org">http://enigmail.mozdev.org</A>

iQCVAwUBQ6SNsplgi5GaxT1NAQLMQwP/czYFLQ6+olTCvM0jdmMlaBgwxHsHdvxT
/2mhWqtyhIf1Kdh6FioFQq13xqCfZxFIkwuUwTlG+ZmkSYK1iWZEmaS0CGa5YmuA
d7miIFfL9Tfa3OLyV1nvqdCR3YtzH/ws9UuJ2DGnACRI++Of6gBVwGlhFDa7S57o
wZcsYWAS6Sk=
=/Pks
-----END PGP SIGNATURE-----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012161.html">[Twisted-Python] WSGI Thread-management strategy
</A></li>
	<LI>Next message: <A HREF="012163.html">[Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12162">[ date ]</a>
              <a href="thread.html#12162">[ thread ]</a>
              <a href="subject.html#12162">[ subject ]</a>
              <a href="author.html#12162">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
