<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How can a tcp client connect with multi servers?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20a%20tcp%20client%20connect%20with%20multi%20servers%3F&In-Reply-To=f6c194d30512012325lcaa50b8n4c91bf1b0c9fad23%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="012104.html">
   <LINK REL="Next"  HREF="012106.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How can a tcp client connect with multi servers?</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20a%20tcp%20client%20connect%20with%20multi%20servers%3F&In-Reply-To=f6c194d30512012325lcaa50b8n4c91bf1b0c9fad23%40mail.gmail.com"
       TITLE="[Twisted-Python] How can a tcp client connect with multi servers?">andrew-twisted at puzzling.org
       </A><BR>
    <I>Fri Dec  2 02:52:49 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="012104.html">[Twisted-Python] How can a tcp client connect with multi servers?
</A></li>
        <LI>Next message: <A HREF="012106.html">[Twisted-Python] How can a tcp client connect with multi servers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12105">[ date ]</a>
              <a href="thread.html#12105">[ thread ]</a>
              <a href="subject.html#12105">[ subject ]</a>
              <a href="author.html#12105">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Dec 02, 2005 at 03:25:48PM +0800, Xu Ryan wrote:
&gt;<i> But when reactor.run() is called, the program lock here. and the codes
</I>&gt;<i> after &quot;reactor.run()&quot; are not been called until reactor is stop.
</I>
Right.  You generally don't want to have any code after reactor.run().  The idea
is to react to events that occur, like receiving messages off the network.

For example, if you want to make a new connection while the reactor is running,
you do that from within an event handler.

There's some examples of this in Twisted, e.g. look at
twisted/protocols/portforward.py
(<A HREF="http://svn.twistedmatrix.com/cvs/trunk/twisted/protocols/portforward.py?view=auto&amp;rev=12914">http://svn.twistedmatrix.com/cvs/trunk/twisted/protocols/portforward.py?view=auto&amp;rev=12914</A>).
An example of using this module would be:

    from twisted.internet import reactor
    from twisted.protocols.portforward import ProxyFactory
    reactor.listenTCP(1234, ProxyFactory('somewhere.com', 5678))
    reactor.run()

If you run that it will start listening on port 1234, and do nothing else until
you connect to that port.  As soon as a connection is established, a ProxyServer
protocol is made, and its connectionMade handler will call reactor.connectTCP to
establish a connection to somewhere.com's port 5678.

Here's another example of making new connections in response to events that
occur while the program is running.  You may find it simpler to understand,
although I haven't tested it so there may be bugs, and it has essentially no
error handling...:

----
from twisted.protocols import basic
from twisted.internet import reactor, protocol

class MessageReceiver(basic.LineReceiver):
    def lineReceived(self, line):
        # expects lines like &quot;host.somewhere.com 1234 here's a message&quot;.
        host, port, message = line.split(' ', 2)
        sendMessage(host, port, message)

class MessageSender(protocol.Protocol):
    def __init__(self, message):
        self.message = message

    def connectionMade(self):
        # send the message
        self.transport.write(message)
        # close the connection
        self.transport.loseConnection()

def sendMessage(host, port, message):
    cc = protocol.ClientCreator(reactor, MessageSender, message)
    cc.connectTCP(host, port)

f = protocol.ServerFactory()
f.protocol = MessageReceiver
reactor.listenTCP(1234, f)
reactor.run()
----

You may also want to work through the finger tutorial -- it's a bit long, but it
does cover this sort of thing.

-Andrew.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="012104.html">[Twisted-Python] How can a tcp client connect with multi servers?
</A></li>
	<LI>Next message: <A HREF="012106.html">[Twisted-Python] How can a tcp client connect with multi servers?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#12105">[ date ]</a>
              <a href="thread.html#12105">[ thread ]</a>
              <a href="subject.html#12105">[ subject ]</a>
              <a href="author.html#12105">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
