<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Some%20beginner%20questions%20about%0A%09%22twisted.names.client%22%20and%20%22.tac%22%20environment&In-Reply-To=%3C20051217231016.1217.997986057.divmod.quotient.6793%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044670.html">
   <LINK REL="Next"  HREF="044672.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Some%20beginner%20questions%20about%0A%09%22twisted.names.client%22%20and%20%22.tac%22%20environment&In-Reply-To=%3C20051217231016.1217.997986057.divmod.quotient.6793%40ohm%3E"
       TITLE="[Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment">exarkun at divmod.com
       </A><BR>
    <I>Sat Dec 17 16:10:16 MST 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044670.html">[Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
        <LI>Next message (by thread): <A HREF="044672.html">[Twisted-Python] Some beginner questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44671">[ date ]</a>
              <a href="thread.html#44671">[ thread ]</a>
              <a href="subject.html#44671">[ subject ]</a>
              <a href="author.html#44671">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sat, 17 Dec 2005 23:14:10 +0100, Jesus Cea &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jcea at argo.es</A>&gt; wrote:
&gt;<i>-----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i>Hash: SHA1
</I>&gt;<i>
</I>&gt;<i>Twisted 2.1, twisted.named 0.2, here.
</I>&gt;<i>
</I>&gt;<i>I'm taking my first steps with Twisted (documentation -inexistence-
</I>&gt;<i>nightmare :-), and my first project will be a bulk mailer as the backend
</I>&gt;<i>of my mailing list system.
</I>&gt;<i>
</I>&gt;<i>The application would take the message and the subscriber list and a)
</I>&gt;<i>resolve the MX for the domains and b) connect to the MX's and send the
</I>&gt;<i>message, trying to minimice traffic sending a single envelope for
</I>&gt;<i>several recipients sharing the domain or the MX's.
</I>&gt;<i>
</I>&gt;<i>I'm doing currently the DNS stuff. The result are promising, resolving
</I>&gt;<i>about 200 domains per second in a 1.4GHz P4, so my biggest mailing list
</I>&gt;<i>(about 31500 unique domains, m√∫ltiple subscribers per domain) is
</I>&gt;<i>&quot;resolved&quot; in less than three minutes.
</I>&gt;<i>
</I>&gt;<i>Nice so far. The demo code (2Kbytes) is the following (if I'm violating
</I>&gt;<i>the rules posting this code, please tell me):
</I>&gt;<i>
</I>&gt;<i>=====
</I>&gt;<i># File &quot;dns.tac&quot;
</I>&gt;<i>
</I>&gt;<i>from twisted.application import service
</I>&gt;<i>
</I>&gt;<i>application = service.Application(&quot;DNS test&quot;)
</I>&gt;<i>
</I>
You probably want to move most of your program out if &quot;dns.tac&quot; and into an importable Python module.  Code defined inside .tac files lives in a weird world where some surprising rules apply.  It's best to keep the .tac file as short as possible.  Generally, you just want to create an Application and give it some children, importing from modules the definitions of all classes and functions needed to set this up.

&gt;<i>import time
</I>&gt;<i>t=time.time()
</I>&gt;<i>
</I>&gt;<i>class resolucion(object) :
</I>&gt;<i>  def __init__(self,dominio) :
</I>&gt;<i>    from twisted.names import client
</I>&gt;<i>    d = client.lookupMailExchange(dominio,timeout=(60,))
</I>
Passing (60,) as the timeout might not be the best idea.  This will cause the DNS client to send one request and then wait 60 seconds for a response.  If either the request or the response is dropped (as often happens with UDP traffic), you will never get a result, and you will have to wait 60 seconds to discover this fact.

If you don't want retransmission, a value of (15,) or so is probably better.  However, I suspect you really do want retransmissions.  The default timeout is also 60 seconds total, but performs several retransmissions during the interim.

&gt;<i>    d.addCallbacks(self._cbMailExchange, self._ebMailExchange)
</I>&gt;<i>    self.dominio=dominio
</I>&gt;<i>
</I>&gt;<i>  def _cbMailExchange(self,results):
</I>&gt;<i>    # Callback for MX query
</I>&gt;<i>    global aun_pendientes
</I>&gt;<i>    aun_pendientes-=1
</I>&gt;<i>    if not aun_pendientes :
</I>&gt;<i>      print &quot;OK&quot;,time.time()-t
</I>&gt;<i>      return
</I>&gt;<i>      from twisted.internet import reactor
</I>&gt;<i>      reactor.stop()
</I>&gt;<i>      return
</I>&gt;<i>    if not len(pendientes) :
</I>&gt;<i>      return
</I>&gt;<i>
</I>&gt;<i>    resolucion(pendientes.pop())
</I>&gt;<i>    from twisted.names.dns import QUERY_TYPES
</I>&gt;<i>    for i in results[0] :
</I>&gt;<i>      n=i.payload.name
</I>&gt;<i>      tipo=QUERY_TYPES[i.payload.TYPE]
</I>&gt;<i>      if tipo==&quot;MX&quot; :
</I>
You can just use dns.MX here, instead of looking up &quot;MX&quot; in QUERY_TYPES.

&gt;<i>        return
</I>&gt;<i>        p=i.payload.preference
</I>&gt;<i>        print n,p,
</I>&gt;<i>        for j in results[2] :
</I>&gt;<i>          if n==j.name :
</I>&gt;<i>            print j.payload.dottedQuad(),&quot;(%d)&quot; %j.ttl
</I>&gt;<i>            break
</I>&gt;<i>        else :
</I>&gt;<i>          print &quot;???&quot;
</I>&gt;<i>      elif tipo==&quot;CNAME&quot; :
</I>&gt;<i>        redirigidos.append((self.dominio,i.payload.name))
</I>&gt;<i>
</I>&gt;<i>  def _ebMailExchange(self,failure):
</I>&gt;<i>    # Error callback for MX query
</I>&gt;<i>    global aun_pendientes
</I>&gt;<i>    aun_pendientes-=1
</I>&gt;<i>    if not aun_pendientes :
</I>&gt;<i>      print &quot;ERROR&quot;,time.time()-t
</I>&gt;<i>      return
</I>&gt;<i>      from twisted.internet import reactor
</I>&gt;<i>      reactor.stop()
</I>&gt;<i>      return
</I>&gt;<i>    if not len(pendientes) :
</I>&gt;<i>      return
</I>&gt;<i>
</I>&gt;<i>    resolucion(pendientes.pop())
</I>&gt;<i>    print &quot;XXX&quot;,self.dominio
</I>&gt;<i>    print 'Lookup failed:'
</I>&gt;<i>    failure.printTraceback()
</I>&gt;<i>
</I>&gt;<i>pendientes=[]
</I>&gt;<i>redirigidos=[]
</I>&gt;<i>
</I>&gt;<i>f=open(&quot;domain_list&quot;)
</I>&gt;<i>for i in f :
</I>&gt;<i>  pendientes.append(i)
</I>&gt;<i>
</I>&gt;<i>aun_pendientes=len(pendientes)
</I>&gt;<i>
</I>&gt;<i>concurrencia=1000
</I>&gt;<i>
</I>&gt;<i>for i in pendientes[:concurrencia] :
</I>&gt;<i>  resolucion(i)
</I>&gt;<i>
</I>&gt;<i>from twisted.names import client
</I>&gt;<i>client.theResolver.resolvers[-1].dynServers=[('127.0.0.1', 53)]
</I>&gt;<i># client.theResolver.resolvers=[client.theResolver.resolvers[-1]]
</I>
To customize the server used by the resolver, you may want to create your own resolver instance, rather than relying on the defaults guessed by the resolver automatically created in the client module.

&gt;<i>
</I>&gt;<i>pendientes=pendientes[concurrencia:]
</I>&gt;<i>
</I>&gt;<i>=====
</I>&gt;<i>
</I>&gt;<i>I launch the code as &quot;twistd -ny dns.tac&quot;.
</I>&gt;<i>
</I>&gt;<i>The demo does 1000 resolutions in parallel. If you experiment with the
</I>&gt;<i>code, reduce the value.
</I>&gt;<i>
</I>&gt;<i>Questions:
</I>&gt;<i>
</I>&gt;<i>1. I get a warning: &quot;[Uninitialized]
</I>&gt;<i>/usr/local/lib/python2.4/site-packages/twisted/names/dns.py:1227:
</I>&gt;<i>exceptions.DeprecationWarning: Deferred.setTimeout is deprecated.  Look
</I>&gt;<i>for timeout support specific to the API you are using instead.&quot;
</I>&gt;<i>
</I>&gt;<i> I'm using, the native &quot;twisted.names&quot; timeout API, as far as I know...
</I>
This is a problem internal to twisted.names.  Your code isn't doing anything wrong to cause it.  Hopefully this will be fixed by the next release.

&gt;<i>
</I>&gt;<i>2. By default &quot;twisted.names.client&quot; uses the &quot;/etc/resolv.conf&quot; file to
</I>&gt;<i>know which nameservers to use. I, nevertheless, want to use a particular
</I>&gt;<i>nameserver, so:
</I>&gt;<i>
</I>&gt;<i> 2.1. I couldn't to find an appropiate API. I had to do a &quot;hack&quot;,
</I>&gt;<i>reading the &quot;twisted.names&quot; core to know implementation details:
</I>&gt;<i>&quot;client.theResolver.resolvers[-1].dynServers=[('127.0.0.1', 53)]&quot;
</I>&gt;<i>
</I>&gt;<i> 2.2. The previous &quot;hack&quot; is only effective for future
</I>&gt;<i>&quot;twisted.names.client&quot; instances. The previous ones use the
</I>&gt;<i>&quot;/etc/resolv.conf&quot; entries. Putting the &quot;hack&quot; code before any instance
</I>&gt;<i>creation doesn't work.
</I>&gt;<i>
</I>&gt;<i> 2.3. While reading the framework code, I saw that &quot;client&quot; uses a
</I>&gt;<i>resolver chain: host, cache, network. But the cache is initially clear
</I>&gt;<i>(of course) and NEVER ever gets populated, so we are not using it but
</I>&gt;<i>checking missing entries eats CPU: 155 seconds for the unchanged code,
</I>&gt;<i>125 seconds if I drop the host and cache resolvers.
</I>&gt;<i>
</I>&gt;<i> A caching client would be very nice, if the client is long running (my
</I>&gt;<i>original idea).
</I>
All three of these can be addressed by constructing your own resolver:

  from twisted.names import client
  myResolver = client.Resolver(servers=[('127.0.0.1', 53)])

This gives you a resolver which uses only localhost, doesn't involve any nasty hacks, and doesn't have an /etc/hosts resolver or a caching resolver to slow things down.

&gt;<i>
</I>&gt;<i> 2.4. The resolution failure code is only called if the resolution
</I>&gt;<i>timeouts. But if the domain doesn't exists, the code called is the
</I>&gt;<i>&quot;success&quot; one, with a &quot;nil&quot; answer. So we can't diferenciate between
</I>&gt;<i>inexistant domains and inexistant RRs.
</I>
Hmm.  The non-existence of the domain is hidden by the very last step in performing the lookup.  The Resolver class has a method, filterAnswers, which is used to turn a DNS response into the three-tuple of lists which all the lookup* methods return.  You may want to subclass Resolver and override filterAnswers to behave differently when the `message' argument it is given has an `rCode' attribute equal to twisted.names.dns.ENAME, which indicates the name requested does not exist.

&gt;<i>
</I>&gt;<i>3. How can I stop this &quot;.tac&quot;?. If I do &quot;reactor.stop()&quot;, I get an
</I>&gt;<i>infinite error, repeated forever:
</I>
reactor.stop() is the correct way to end the program.  If you still have this problem after you have split the program into multiple files, please post again.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044670.html">[Twisted-Python] Some beginner questions about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
	<LI>Next message (by thread): <A HREF="044672.html">[Twisted-Python] Some beginner questions	about	&quot;twisted.names.client&quot; and &quot;.tac&quot; environment
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44671">[ date ]</a>
              <a href="thread.html#44671">[ thread ]</a>
              <a href="subject.html#44671">[ subject ]</a>
              <a href="author.html#44671">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
