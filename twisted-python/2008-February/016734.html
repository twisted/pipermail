<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] wired problem with deferreds
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20wired%20problem%20with%20deferreds&In-Reply-To=1202067707.9860.27.camel%40localhost">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016733.html">
   <LINK REL="Next"  HREF="016735.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] wired problem with deferreds</H1>
    <B>Petr Mifek</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20wired%20problem%20with%20deferreds&In-Reply-To=1202067707.9860.27.camel%40localhost"
       TITLE="[Twisted-Python] wired problem with deferreds">pm-twisted-python at anapol.cz
       </A><BR>
    <I>Mon Feb  4 16:12:06 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="016733.html">[Twisted-Python] wired problem with deferreds
</A></li>
        <LI>Next message: <A HREF="016735.html">[Twisted-Python] Re: wired problem with deferreds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16734">[ date ]</a>
              <a href="thread.html#16734">[ thread ]</a>
              <a href="subject.html#16734">[ subject ]</a>
              <a href="author.html#16734">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

it looks to me like the chain of deferred callbacks is broken by this. 
At least i think deferreds aren't supposed to return the result of last 
callbacked function in the chain. If that is true, then your code fails 
on this:

You have d1, d2, cd. Before callbacking cd, the callback chains will 
look like this:

xd1 = half-done d1, callback chain: [cb1]
xd2 = half-done d2, callback chain: [cb2]
cd, callback chain: [req3, xd1, xd2]

the cd's chain processing will take req3 and it's return value, 'S' will 
give to the xd1 (_continue method). xd1 will unpause itself and give the 
'S' to cb1. The point is here, that although cb1 returns 'S', it is only 
relevant to xd1 aka d1 chain processing. The d1 deferred does return 
None. So that goes to next in cd's chain, the xd2. xd2 will give None to 
cb2 and there goes your output.

The deferred chaining works, because if some addCallback'ed' function 
returns a deferred, then the current deffered adds it's '_continue' 
method to that deferred's chain. That way it gets the result values and 
can process the chain further then.

The short answer is probably: You can return a deferred(s) from 
addCallbackeds methods and wait for them, but should only wait in one 
place for one deferred. If returning the same deferred in multiple 
places, only the first will get the result of that deferred chain (and i 
thint that this is certainly not the common use case ;) Think about some 
tree-like-pattern, that branches only one way. Otherwise it's really 
twisted ;)

Probably you should use an array of distinct deferreds in req3, although 
I'm not sure of the purpose of the code.

Hope this helps.

Petr



markus espenhain wrote:
&gt;<i> hi
</I>&gt;<i> 
</I>&gt;<i> im stuck with the following deferred construct - the problem is that cb2
</I>&gt;<i> is called with None instead of the expected argument
</I>&gt;<i> 
</I>&gt;<i> from twisted.internet import defer
</I>&gt;<i> 
</I>&gt;<i> cd = None
</I>&gt;<i> 
</I>&gt;<i> def req1():
</I>&gt;<i>     return defer.Deferred().addCallback(req2)
</I>&gt;<i> 
</I>&gt;<i> def req2(a):
</I>&gt;<i>     print 'req2', a
</I>&gt;<i>     global cd
</I>&gt;<i>     if not cd:
</I>&gt;<i>         cd = defer.Deferred().addCallback(req3)
</I>&gt;<i>     return cd
</I>&gt;<i> 
</I>&gt;<i> def req3(a):
</I>&gt;<i>     print 'req3', a
</I>&gt;<i>     return a
</I>&gt;<i> 
</I>&gt;<i> def cb1(a):
</I>&gt;<i>     print 'cb1', a
</I>&gt;<i>     return a
</I>&gt;<i> 
</I>&gt;<i> def cb2(a):
</I>&gt;<i>     print 'cb2', a
</I>&gt;<i>     return a
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> d1 = req1().addCallback(cb1)
</I>&gt;<i> d1.callback('X')
</I>&gt;<i> d2 = req1().addCallback(cb2)
</I>&gt;<i> d2.callback('X')
</I>&gt;<i> cd.callback('S')
</I>&gt;<i> 
</I>&gt;<i> output:
</I>&gt;<i> 
</I>&gt;<i> req2 X
</I>&gt;<i> req2 X
</I>&gt;<i> req3 S
</I>&gt;<i> cb1 S
</I>&gt;<i> cb2 None # &lt;- ?
</I>&gt;<i> 
</I>&gt;<i> req1 fetches a mapping for given arguments - req2 tries to create an
</I>&gt;<i> object + additional resquests by the result of req1 - but these objects
</I>&gt;<i> should only be created once - so far i didn't find an acceptable
</I>&gt;<i> workaround for that - req3 applys some modifications but the problem
</I>&gt;<i> occurs also without the step in req3 
</I>&gt;<i> 
</I>&gt;<i> is there something i overlooked so that cb2 isn't called with the
</I>&gt;<i> required arg?
</I>&gt;<i> 
</I>&gt;<i> thanks
</I>&gt;<i> markus
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016733.html">[Twisted-Python] wired problem with deferreds
</A></li>
	<LI>Next message: <A HREF="016735.html">[Twisted-Python] Re: wired problem with deferreds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16734">[ date ]</a>
              <a href="thread.html#16734">[ thread ]</a>
              <a href="subject.html#16734">[ subject ]</a>
              <a href="author.html#16734">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
