<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Help using XmlStreamFactory	&amp;	XmlStream	:	XPathQuery error?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Help%20using%20XmlStreamFactory%0A%09%26%09XmlStream%09%3A%09XPathQuery%20error%3F&In-Reply-To=47BC2668.1040309%40evotex.ch">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016815.html">
   <LINK REL="Next"  HREF="016819.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Help using XmlStreamFactory	&amp;	XmlStream	:	XPathQuery error?</H1>
    <B>Gabriel Rossetti</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Help%20using%20XmlStreamFactory%0A%09%26%09XmlStream%09%3A%09XPathQuery%20error%3F&In-Reply-To=47BC2668.1040309%40evotex.ch"
       TITLE="[Twisted-Python] Help using XmlStreamFactory	&amp;	XmlStream	:	XPathQuery error?">mailing_lists at evotex.ch
       </A><BR>
    <I>Wed Feb 20 10:19:52 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="016815.html">[Twisted-Python] Help using XmlStreamFactory &amp;	XmlStream	:	XPathQuery error?
</A></li>
        <LI>Next message: <A HREF="016819.html">[Twisted-Python] Help using	XmlStreamFactory	&amp;	XmlStream	:	XPathQuery error?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16817">[ date ]</a>
              <a href="thread.html#16817">[ thread ]</a>
              <a href="subject.html#16817">[ subject ]</a>
              <a href="author.html#16817">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Gabriel Rossetti wrote:
&gt;<i> Ralph Meijer wrote:
</I>&gt;&gt;<i> On Wed, 2008-02-20 at 10:36 +0100, Gabriel Rossetti wrote:
</I>&gt;&gt;<i>  
</I>&gt;&gt;&gt;<i> [..]
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm having some trouble with the XPath I think when trying to react 
</I>&gt;&gt;&gt;<i> on xml messages. I am feeding the 
</I>&gt;&gt;&gt;<i> twisted.words.xish.xmlstream.XmlStream the following :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     &lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
</I>&gt;&gt;&gt;<i>     &lt;test&gt;&lt;feed name='monNom'&gt;toto&lt;/feed&gt;&lt;/test&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> and the callback functions are :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     def onTest(self, element):
</I>&gt;&gt;&gt;<i>         print &quot;got test : &quot;, element
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     def onFeed(self, element):
</I>&gt;&gt;&gt;<i>         print &quot;got feed : &quot;, element
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     def onFeedFilteredByName(self, element):
</I>&gt;&gt;&gt;<i>         print &quot;got feed name : &quot;, element
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     def onWildcard(self, element):
</I>&gt;&gt;&gt;<i>         print &quot;got wildcard : &quot;, element
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> and the bootstrap is added like so :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     f.addBootstrap(xmlstream.STREAM_START_EVENT, connected)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> and the bootstrap callback is :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     def connected(self, xs):
</I>&gt;&gt;&gt;<i>         print 'Connected!'
</I>&gt;&gt;&gt;<i>         xs.addObserver(&quot;/test&quot;, self.onTest)
</I>&gt;&gt;&gt;<i>         xs.addObserver(&quot;/test/feed&quot;, self.onFeed)
</I>&gt;&gt;&gt;<i>         xs.addObserver(&quot;/test/feed[@name]&quot;, self.onFeedFilteredByName)
</I>&gt;&gt;&gt;<i>         xs.addObserver(&quot;/*&quot;, self.onWildcard)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The only one that gets called is &quot;/*&quot;. I tested out the others using 
</I>&gt;&gt;&gt;<i> XPathQuery manually with :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     xpath.XPathQuery(&quot;//feed[@name]&quot;).queryForNodes(root)[0]
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> root being the above xml, and they work, I can even get the 
</I>&gt;&gt;&gt;<i> attributes (which is what  I really need to get) like so :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>     
</I>&gt;&gt;&gt;<i> xpath.XPathQuery(&quot;//feed[@name]&quot;).queryForNodes(root)[0].getAttribute(&quot;name&quot;) 
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What am I doing wrong when adding observers? How can I get them to 
</I>&gt;&gt;&gt;<i> react on attribute names too?
</I>&gt;&gt;&gt;<i>     
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> A somewhat lengthy explanation follows,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> XML Streams are a result of the work on Jabber. As such, the generalized
</I>&gt;&gt;<i> version of XmlStream in xish works similarly, but without the Jabber
</I>&gt;&gt;<i> specifics in terms of namespaces and elements. However, the concept
</I>&gt;&gt;<i> behind XML Streams is that you open the stream with a root element, and
</I>&gt;&gt;<i> after that the units of exchange are the first-level childs of that root
</I>&gt;&gt;<i> element, or so-called XML Stanzas.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> EventDispatcher, a superclass of XmlStream, is responsible for calling
</I>&gt;&gt;<i> back observers upon calls to its dispatch method. For each XML Stanza,
</I>&gt;&gt;<i> XmlStream will dispatch the DOM object at the root of that snippet of
</I>&gt;&gt;<i> XML (domish.Element) for the XML Stanza. Observers are registered to
</I>&gt;&gt;<i> XPath (-like) queries to match those Elements.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now that's out of the way, in your specific example, the &lt;feed/&gt; element
</I>&gt;&gt;<i> would be an XML Stanza. So you can only register an observer to that,
</I>&gt;&gt;<i> like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    xs.addObserver('/feed', self.onFeed)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If some &lt;feed/&gt;'s would have child &lt;title/&gt;, you could add an observer
</I>&gt;&gt;<i> on just those &lt;feed/&gt;'s with a title like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    xs.addObserver('/feed/title', self.onFeedWithTitle)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The observer would still get the whole &lt;feed/&gt; element passed. So, to be
</I>&gt;&gt;<i> clear: the XPath-like queries are for matching against XML Stanzas, and
</I>&gt;&gt;<i> each XML Stanza that matches is then passed to the callbacks registered
</I>&gt;&gt;<i> to that query.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For completeness, ff you want to hook up an event to the start tag of
</I>&gt;&gt;<i> the root element having been received, you'd do this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   xs.addObserver(STREAM_START_EVENT, self.onTest)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In that case, you need to do change the bootstrap registration to this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   f.addBootstrap(xmlstream.STREAM_CONNECTED_EVENT, connected)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hope that clears some things up.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   
</I>&gt;<i> Ralph, Thank you! Your explanation cleared up a lot for me, I had 
</I>&gt;<i> misunderstood the whole thing, this is exactly what I needed.
</I>&gt;<i>
</I>&gt;<i> Thanks again,
</I>&gt;<i> Gabriel
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>Hi, one more question,

I'm trying to do the following :

receive an xml message, run different actions depending on XML Stanzas, 
modify the original message and send it back. I'm starting to wonder if 
XmlStream is really what I need? If I'm not mistaking, I have no way of 
getting the original message as a whole, correct? And if I'm not 
mistaking, if I have multiple connections, then the events get mixed up 
(from my own tests anyways), the processing is not atomic. If I have 
let's say that I have :

client1 : &lt;test&gt;&lt;header  id=&quot;1&quot;/&gt;
client2 : &lt;test&gt;&lt;header  id=&quot;2&quot;/&gt;&lt;feed name=&quot;myName&quot;&gt;toto&lt;/feed&gt;&lt;/test&gt;
client2 : &lt;feed name=&quot;myName2&quot;&gt;lala&lt;/feed&gt;&lt;/test&gt;

my stanzas will get processed in that order, thus I can't even recreate 
the message (without a complicated state machine of some kind).

I'm kind of mixed up, because when using a thread based network 
framework, one tcp connection = one thread, thus the protocol execution 
is atomic, but this doesn't seam to be the case with Twisted (event 
based), is this correct or have I missed something again?

Thanks,
Gabriel


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016815.html">[Twisted-Python] Help using XmlStreamFactory &amp;	XmlStream	:	XPathQuery error?
</A></li>
	<LI>Next message: <A HREF="016819.html">[Twisted-Python] Help using	XmlStreamFactory	&amp;	XmlStream	:	XPathQuery error?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16817">[ date ]</a>
              <a href="thread.html#16817">[ thread ]</a>
              <a href="subject.html#16817">[ subject ]</a>
              <a href="author.html#16817">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
