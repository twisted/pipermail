<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: Reactor is left dirty after calling	twisted.mail.smtp.sendmail via trial
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Reactor%20is%20left%20dirty%20after%20calling%0A%09twisted.mail.smtp.sendmail%20via%20trial&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016862.html">
   <LINK REL="Next"  HREF="016866.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: Reactor is left dirty after calling	twisted.mail.smtp.sendmail via trial</H1>
    <B>Marcin Kasperski</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Reactor%20is%20left%20dirty%20after%20calling%0A%09twisted.mail.smtp.sendmail%20via%20trial&In-Reply-To="
       TITLE="[Twisted-Python] Re: Reactor is left dirty after calling	twisted.mail.smtp.sendmail via trial">Marcin.Kasperski at softax.com.pl
       </A><BR>
    <I>Tue Feb 26 06:26:22 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="016862.html">[Twisted-Python] Reactor is left dirty after calling twisted.mail.smtp.sendmail via trial
</A></li>
        <LI>Next message: <A HREF="016866.html">[Twisted-Python] Re: Reactor is left dirty after calling	twisted.mail.smtp.sendmail via trial
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16865">[ date ]</a>
              <a href="thread.html#16865">[ thread ]</a>
              <a href="subject.html#16865">[ subject ]</a>
              <a href="author.html#16865">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> If I send an e-mail from a Trial testcase - using t.m.smtp.sendmail,
</I>&gt;<i> the reactor is left dirty.
</I>&gt;<i>
</I>&gt;<i> Is it a bug, feature, or... how should we treat this situation? 
</I>
Feature. Email is sent asynchronously, you get deferred and can use it
(for example to acknowledge that the email has already been sent).

I bet you just need to sync with this deferred. The way to do it
is to return the deferred from the test case.

&gt;<i> class Test1(unittest.TestCase):
</I>&gt;<i>    def test_sendmail(self):
</I>&gt;<i>
</I>&gt;<i>       return smtp.sendmail('localhost', '<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">foo at bar.pl</A>', '<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dotz at localhost</A>',
</I>&gt;<i>                            'this leaves reactor dirty :-(').addCallback(evenIfCallbackIsCalled)
</I>
Adding callback should have no meaning here, you need to return deferred
from test to sync with that whether the processing is complicated or simple.

At first sight it seems OK to me. Are you sure you run your tests with
trial?  Syncing with returned deferreds is trial-specific, other test
runners won't do it...

-- 
----------------------------------------------------------------------
|<i> Marcin Kasperski   | The cost of a few uncorrected non-critical
</I>|<i> <A HREF="http://mekk.waw.pl">http://mekk.waw.pl</A> | human errors is less then the cost imposed
</I>|<i>                    |  by a process that tries to prevent them.
</I>|<i>                    |           (Booch,Martin,Newkirk)
</I>----------------------------------------------------------------------



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016862.html">[Twisted-Python] Reactor is left dirty after calling twisted.mail.smtp.sendmail via trial
</A></li>
	<LI>Next message: <A HREF="016866.html">[Twisted-Python] Re: Reactor is left dirty after calling	twisted.mail.smtp.sendmail via trial
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16865">[ date ]</a>
              <a href="thread.html#16865">[ thread ]</a>
              <a href="subject.html#16865">[ subject ]</a>
              <a href="author.html#16865">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
