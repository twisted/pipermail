<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> InlineCallback Friendly ? Re: [Twisted-Python] Question about	Using in ServerProtocol request Handler
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=InlineCallback%20Friendly%20%3F%20Re%3A%20%5BTwisted-Python%5D%20Question%20about%0A%09Using%20in%20ServerProtocol%20request%20Handler&In-Reply-To=177670.19996.qm%40web34210.mail.mud.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016824.html">
   <LINK REL="Next"  HREF="016826.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>InlineCallback Friendly ? Re: [Twisted-Python] Question about	Using in ServerProtocol request Handler</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=InlineCallback%20Friendly%20%3F%20Re%3A%20%5BTwisted-Python%5D%20Question%20about%0A%09Using%20in%20ServerProtocol%20request%20Handler&In-Reply-To=177670.19996.qm%40web34210.mail.mud.yahoo.com"
       TITLE="InlineCallback Friendly ? Re: [Twisted-Python] Question about	Using in ServerProtocol request Handler">exarkun at divmod.com
       </A><BR>
    <I>Wed Feb 20 15:25:14 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="016824.html">InlineCallback Friendly ? Re: [Twisted-Python] Question about Using	in ServerProtocol request Handler
</A></li>
        <LI>Next message: <A HREF="016826.html">[Twisted-Python] How to say &quot;reverted&quot;. (was Re: [Twisted-commits]	r22628 - Revert r22624: regression in test_conch.)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16825">[ date ]</a>
              <a href="thread.html#16825">[ thread ]</a>
              <a href="subject.html#16825">[ subject ]</a>
              <a href="author.html#16825">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 20 Feb 2008 11:50:08 -0800 (PST), Andrew Francis &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrewfr_ice at yahoo.com</A>&gt; wrote:
&gt;<i>Hi Jean-Paul:
</I>&gt;<i>
</I>&gt;&gt;<i>However, how is this done with just deferreds and
</I>&gt;&gt;<i>callbacks without Stackless or inlineCallbacks?
</I>&gt;<i>
</I>&gt;<i>Thanks for the response. And thanks for the
</I>&gt;<i>explanation of inlineCallbacks. Annotating your
</I>&gt;<i>example, I get  the following:
</I>&gt;<i>
</I>&gt;<i> def process(self):
</I>&gt;<i>        def callback(result):
</I>&gt;<i>            print &quot;second&quot;
</I>&gt;<i>            self.setHeader('Content-Type', 'text/html')
</I>&gt;<i>            self.write(result)
</I>&gt;<i>            self.finish()
</I>&gt;<i>        def errback(err):
</I>&gt;<i>            err.trap(Exception)
</I>&gt;<i>            log.err(err, &quot;process getPage call failed&quot;)
</I>&gt;<i>        try:
</I>&gt;<i>            d = client.getPage(&quot;<A HREF="http://www.google.com&quot;">http://www.google.com&quot;</A>)
</I>&gt;<i>        except Exception:
</I>&gt;<i>            d = failure.Failure()
</I>&gt;<i>        d.addCallbacks(callback, errback)
</I>&gt;<i>        print &quot;first&quot;
</I>&gt;<i>
</I>&gt;<i>running this I get what I expected
</I>&gt;<i>
</I>&gt;<i>&quot;first&quot;
</I>&gt;<i>&quot;second&quot;
</I>&gt;<i>
</I>&gt;<i>This example I can follow. The server protocol handler
</I>&gt;<i>terminates. The callback eventually fires. Since the
</I>&gt;<i>callback has a reference to the request, it can write
</I>&gt;<i>back the response.
</I>&gt;<i>
</I>&gt;<i>Bear with me, I am just starting to read up on
</I>&gt;<i>protocols...
</I>&gt;<i>
</I>&gt;<i>What I am unclear on, is why some Server Protocols
</I>&gt;<i>depend on 'return' and others don't (I assume with
</I>&gt;<i>HTTP, you can stream a response). What is the right
</I>&gt;<i>way to design a ServerProtocol? Is there an
</I>&gt;<i>'inclineCallback' friendly protocol
</I>
Depending on the value returned by a method is an API decision made
by whoever implemented the protocol.  They came to the decision, at
some point, that the convenient way for applications to specify the
result is to return it from a method.  Or, they didn't and provided
some other API for specifying results.

Basically, we're talking about how protocol actions get dispatched
and how the result of dispatching them is handled.  You can have a
dispatcher which calls a method and ignores the result, requiring
that the result be handed back through some explicit API.  An example
of this is twisted.web's Request class.  The process method of the
request is called.  The result is specified by calling the write
method (possibly more than once) and then the finish method.  The
return value from process is ignored.  Another kind of dispatcher
might take the return value of the function dispatched to and treat
it as the result.  It might support Deferreds or it might not. An
example of this is twisted.mail's POP3 server implementation (which
happens to support Deferreds in most places, but not all).

The only kind of dispatcher which is really hostile towards
inlineCallbacks is the kind which is hostile towards Deferreds in
general - ie, one which requires a return value and does not support
Deferreds.

&gt;<i>
</I>&gt;<i>Unless I am fundamentally missing something it seems
</I>&gt;<i>that there are advantages to designing a Server
</I>&gt;<i>Protocol not to depend on 'return'
</I>
Not really.  It's just an API.  Unless the return value isn't allowed
to be a Deferred, there's little difference between using the return
value and ignoring it.

&gt;<i>
</I>&gt;<i>As I alluded to in other posts, I get confused over
</I>&gt;<i>this variation.
</I>&gt;<i>
</I>&gt;<i>This is pyAMF
</I>&gt;<i>
</I>&gt;<i>class pyAMFTest(TwistedGateway):
</I>&gt;<i>    def __init__(self):
</I>&gt;<i>        super(TubeTest, self).__init__()
</I>&gt;<i>        return
</I>&gt;<i>
</I>&gt;<i>    def echo(self, x):
</I>&gt;<i>        print x
</I>&gt;<i>        return x
</I>&gt;<i>
</I>&gt;<i>pretend I wish to do a callRemote(...)
</I>&gt;<i>
</I>&gt;<i>def echo(self, x):
</I>&gt;<i>    def callback(result):
</I>&gt;<i>        print &quot;second&quot;
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        How do I return x?
</I>&gt;<i>        &quot;&quot;&quot;
</I>
You return x by returning x.  That is, `return x&#180;. ;)  But see
below.

&gt;<i>
</I>&gt;<i>    def errback(err):
</I>&gt;<i>        err.trap(Exception)
</I>&gt;<i>        log.err(err, &quot;process getPage call failed&quot;)
</I>&gt;<i>    try:
</I>&gt;<i>        proxy = ....
</I>&gt;<i>        d = proxy.callRemote(...)
</I>&gt;<i>    except Exception:
</I>&gt;<i>        d = failure.Failure()
</I>&gt;<i>    d.addCallbacks(callback, errback)
</I>&gt;<i>    print &quot;first&quot;
</I>
The function ends here, and the Deferred which will ultimately have
the result you're interested in has *not* been returned.  It should
have been so that the dispatcher (which, near as I can tell, does
support Deferreds) can get it.  So, `return d&#180; after the print.

&gt;<i>
</I>&gt;<i>In this case, how is 'x' transmitted back to the
</I>&gt;<i>reactor and the client? What is the proper way of
</I>&gt;<i>structuring this code.
</I>
The reactor doesn't care.  This is all pyAMF stuff.  pyAMF accepts
Deferreds (again, near as I can tell) and treats their eventual
result as the response to the request, sending it off in whatever
way is appropriate for AMF.

Hope this helps,

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016824.html">InlineCallback Friendly ? Re: [Twisted-Python] Question about Using	in ServerProtocol request Handler
</A></li>
	<LI>Next message: <A HREF="016826.html">[Twisted-Python] How to say &quot;reverted&quot;. (was Re: [Twisted-commits]	r22628 - Revert r22624: regression in test_conch.)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16825">[ date ]</a>
              <a href="thread.html#16825">[ thread ]</a>
              <a href="subject.html#16825">[ subject ]</a>
              <a href="author.html#16825">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
