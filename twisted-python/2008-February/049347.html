<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Question about writing a server that accepts	multiple clients with independent processing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Question%20about%20writing%20a%20server%20that%20accepts%0A%09multiple%20clients%20with%20independent%20processing&In-Reply-To=%3C47BD9023.9010501%40imperial.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="049346.html">
   <LINK REL="Next"  HREF="049348.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Question about writing a server that accepts	multiple clients with independent processing</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Question%20about%20writing%20a%20server%20that%20accepts%0A%09multiple%20clients%20with%20independent%20processing&In-Reply-To=%3C47BD9023.9010501%40imperial.ac.uk%3E"
       TITLE="[Twisted-Python] Question about writing a server that accepts	multiple clients with independent processing">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Thu Feb 21 07:52:19 MST 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="049346.html">[Twisted-Python] Question about writing a server that accepts	multiple clients with independent processing
</A></li>
        <LI>Next message (by thread): <A HREF="049348.html">[Twisted-Python] Question about writing a server that accepts	multiple clients with independent processing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49347">[ date ]</a>
              <a href="thread.html#49347">[ thread ]</a>
              <a href="subject.html#49347">[ subject ]</a>
              <a href="author.html#49347">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;&gt;<i> You didn't by any chance use a class variable did you e.g.:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class foo(...):
</I>&gt;&gt;<i>   my_data = []
</I>&gt;&gt;<i>   def dataReceived(self, data):
</I>&gt;&gt;<i>     self.my_data.append(data)
</I>&gt;&gt;<i>
</I>&gt;<i> Yes, that must be it :
</I>&gt;<i> 
</I>&gt;<i>    class XmlStreamTestSrv(xmlstream.XmlStream):
</I>&gt;<i> 
</I>&gt;<i>        def __init__(self):
</I>&gt;<i>            xmlstream.XmlStream.__init__(self)
</I>&gt;<i>            self.message = []
</I>
No, this is fine, as you say setting &quot;self.foo&quot; creates an instance 
variable.

I personally don't use __init__ methods of the protocol because I 
believe some protocols make complex use of this, but it should be fine.

&gt;<i>    ...
</I>&gt;<i> 
</I>&gt;<i> even though I though that in python if you put a &quot;self.&quot; in front it was 
</I>&gt;<i> an instance variable and not a class variable. I have been also having 
</I>&gt;<i> some strange problems, like if I overload
</I>&gt;<i> 
</I>&gt;<i>    def connectionMade(self):
</I>&gt;<i> 
</I>&gt;<i> it never gets called, even though the parent class (XmlStream) also has 
</I>&gt;<i> it, and also I can't call self.transport.getPeer() or 
</I>&gt;<i> xmlstream.XmlStream.transport.getPeer(), I get :
</I>&gt;<i> 
</I>&gt;<i>    print 'Connection from %s!' % 
</I>&gt;<i> str(xmlstream.XmlStream.transport.getPeer())
</I>&gt;<i>    exceptions.AttributeError: 'NoneType' object has no attribute 'getPeer'
</I>&gt;<i> 
</I>&gt;<i> so maybe something is wrong somewhere.
</I>
It sounds like the protocol isn't being hooked up to the transport.

&gt;&gt;<i> ...is wrong. &quot;my_data&quot; is shared by all instances of the class and is 
</I>&gt;&gt;<i> mutable. You'll need to create instance variables, usually (I believe) 
</I>&gt;&gt;<i> as part of the factory process.
</I>&gt;<i> Ok, I'll look into that, thanks.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you can write a minimal example showing the problem, someone can 
</I>&gt;&gt;<i> probably tell you what you're doing wrong.
</I>&gt;&gt;<i>
</I>&gt;<i> Ok, thanks, here's a minimal example :
</I>&gt;<i> 
</I>&gt;<i>    from twisted.words.xish import xmlstream, domish
</I>&gt;<i>    from twisted.internet import reactor, protocol
</I>&gt;<i>    from twisted.internet.protocol import Protocol, Factory
</I>&gt;<i>    from twisted.words.xish import xpath
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>    class XmlStreamTestSrv(xmlstream.XmlStream):
</I>&gt;<i> 
</I>&gt;<i>        def __init__(self):
</I>&gt;<i>            xmlstream.XmlStream.__init__(self)
</I>&gt;<i>            self.message = []
</I>&gt;<i> 
</I>&gt;<i>        def connectionMade(self): # never called, why?
</I>&gt;<i>            print 'Connected :' #, string(self.transport.getPeer().host)
</I>&gt;<i> 
</I>&gt;<i>        def _onHeader(self, element):
</I>&gt;<i>            #print &quot;got header from % : %s&quot; % 
</I>&gt;<i> (str(self.transport.getPeer().host), element.toXml())
</I>&gt;<i>            self.message.append(element.toXml())
</I>&gt;<i> 
</I>&gt;<i>        def _connected(self, xs):
</I>&gt;<i>            #print 'Connection from %s!' % 
</I>&gt;<i> str(xmlstream.XmlStream.transport.getPeer().host)
</I>&gt;<i>            xs.addObserver(&quot;/header&quot;, self._onHeader)
</I>&gt;<i> 
</I>&gt;<i>    if __name__ == &quot;__main__&quot;:
</I>&gt;<i> 
</I>&gt;<i>        c = XmlStreamTestSrv()
</I>&gt;<i> 
</I>&gt;<i>        f = xmlstream.XmlStreamFactory()
</I>&gt;<i>        #f.addBootstrap(xmlstream.STREAM_CONNECTED_EVENT, c._connected)
</I>&gt;<i>        f.addBootstrap(xmlstream.STREAM_START_EVENT, c._connected)
</I>&gt;<i> 
</I>&gt;<i>        reactor.listenTCP(4321, f)
</I>&gt;<i>        reactor.run()
</I>
Ah - you need to set the &quot;protocol&quot; attribute on the factory to the 
protocol *class*, and then when a connection is made the class will be 
instantiated and connected to the transport. This is why self.transport 
is None, and because you're using an instance of the protocol, the data 
is getting squashed together. Do this:

f = xmlstream.XmlStreamFactory()
f.protocol = XmlStreamTestSrv
reactor.listenTCP(4321, f)
reactor.run()



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="049346.html">[Twisted-Python] Question about writing a server that accepts	multiple clients with independent processing
</A></li>
	<LI>Next message (by thread): <A HREF="049348.html">[Twisted-Python] Question about writing a server that accepts	multiple clients with independent processing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49347">[ date ]</a>
              <a href="thread.html#49347">[ thread ]</a>
              <a href="subject.html#49347">[ subject ]</a>
              <a href="author.html#49347">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
