<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to make a custom transport based on	sendmsg/recvmsg?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20make%20a%20custom%20transport%20based%20on%0A%09sendmsg/recvmsg%3F&In-Reply-To=47BF2876.2060804%40tuxeo.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016845.html">
   <LINK REL="Next"  HREF="016847.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to make a custom transport based on	sendmsg/recvmsg?</H1>
    <B>Drew Smathers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20make%20a%20custom%20transport%20based%20on%0A%09sendmsg/recvmsg%3F&In-Reply-To=47BF2876.2060804%40tuxeo.org"
       TITLE="[Twisted-Python] How to make a custom transport based on	sendmsg/recvmsg?">drew.smathers at gmail.com
       </A><BR>
    <I>Fri Feb 22 16:35:52 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="016845.html">[Twisted-Python] How to make a custom transport based on	sendmsg/recvmsg?
</A></li>
        <LI>Next message: <A HREF="016847.html">[Twisted-Python] How to make a custom transport based	on	sendmsg/recvmsg?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16846">[ date ]</a>
              <a href="thread.html#16846">[ thread ]</a>
              <a href="subject.html#16846">[ subject ]</a>
              <a href="author.html#16846">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Feb 22, 2008 at 2:54 PM, Philippe Frycia &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">phil-twisted at tuxeo.org</A>&gt; wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i>  I would like to make a custom protocol, based on Unix sockets, that is
</I>&gt;<i>  able to send and receive file descriptors in addition to regular
</I>&gt;<i>  &quot;stream&quot; data.
</I>
You should not make assumptions about the transport layer in your
protocol implementation - be it Unix domain sockets, TCP, etc.

&gt;<i>  At the low level, I can do this with a patched version of eunuchs, that
</I>&gt;<i>  adds sendmsg() and recvmsg() functionality to python.
</I>&gt;<i>
</I>&gt;<i>  I have tried to find my way in the Twisted API documentation and in the
</I>&gt;<i>  sources, and as far as I found out, I have to override the doWrite()
</I>&gt;<i>  method of the abstract.FileDescriptor class, and the doRead() method of
</I>&gt;<i>  one of its subclasses.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  The only way I have found until now is to do this in the Protocol
</I>&gt;<i>  subclass like this:
</I>&gt;<i>
</I>&gt;<i>  class TLVProtocol(Protocol):
</I>&gt;<i>     def doWrite(self):
</I>&gt;<i>         if len(self.tlvstosend)==0:
</I>&gt;<i>             self.transport.stopWriting()
</I>&gt;<i>             return 0
</I>&gt;<i>         tlv=self.tlvstosend.pop(0)
</I>&gt;<i>         (files,ancillary)=tlv.encode()
</I>&gt;<i>         sendmsg(self.transport.socket.fileno(), data, ancillary=ancillary)
</I>&gt;<i>
</I>
If you don't see an attribute documented in the interface for
something (ITransport here for example), and you're referencing it on
the implementation, then you're most definitely doing something bad.
The attribute I'm talking about here is &quot;socket.&quot;

&gt;<i>     def doRead(self):
</I>&gt;<i>         (data, dummy, dummy, ancillary) =
</I>&gt;<i>  recvmsg(self.transport.socket.fileno())
</I>&gt;<i>         if len(data)==0:
</I>&gt;<i>             return 0
</I>&gt;<i>         tlv=encode(data, ancillary)
</I>&gt;<i>         .... # process tlv object
</I>&gt;<i>
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         self.tlvstosend=[]
</I>&gt;<i>         self.transport.doWrite=self.doWrite
</I>&gt;<i>         self.transport.doRead=self.doRead
</I>&gt;<i>         ...
</I>&gt;<i>
</I>&gt;<i>     def sendtlv(self, tlv):
</I>&gt;<i>         self.tlvstosend.append(tlv)
</I>&gt;<i>         self.transport.startWriting()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Some of the return values are not completed yet (EOF, ...).
</I>&gt;<i>  Am I completely on the wrong track here ?
</I>
It sounds like you're trying to do something relatively low-level
(interfacing with eunuchs directly) at a high-level using Protocols.
So to do something that isn't just a hack, you'll need to do a lot
more work - and it might not be worth the effort.  Can you describe
first why you need to use sendmsg/recvmsg in your application?

Cheers,
-- 
\\\\\/\&quot;/\\\\\\\\\\\
\\\\/ // //\/\\\\\\\
\\\/  \\// /\ \/\\\\
\\/ /\/ / /\/ /\ \\\
\/ / /\/ /\  /\\\ \\
/ /\\\  /\\\ \\\\\/\
\/\\\\\/\\\\\/\\\\\\
               d.p.s


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016845.html">[Twisted-Python] How to make a custom transport based on	sendmsg/recvmsg?
</A></li>
	<LI>Next message: <A HREF="016847.html">[Twisted-Python] How to make a custom transport based	on	sendmsg/recvmsg?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16846">[ date ]</a>
              <a href="thread.html#16846">[ thread ]</a>
              <a href="subject.html#16846">[ subject ]</a>
              <a href="author.html#16846">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
