<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: How to make a secure connection between two	computers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20How%20to%20make%20a%20secure%20connection%20between%20two%0A%09computers&In-Reply-To=b348a0850802120336q647c3580uf106155ed5d50a24%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016753.html">
   <LINK REL="Next"  HREF="016757.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: How to make a secure connection between two	computers</H1>
    <B>Noam Raphael</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20How%20to%20make%20a%20secure%20connection%20between%20two%0A%09computers&In-Reply-To=b348a0850802120336q647c3580uf106155ed5d50a24%40mail.gmail.com"
       TITLE="[Twisted-Python] Re: How to make a secure connection between two	computers">noamraph at gmail.com
       </A><BR>
    <I>Tue Feb 12 15:02:00 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="016753.html">[Twisted-Python] Re: How to make a secure connection between	two computers
</A></li>
        <LI>Next message: <A HREF="016757.html">[Twisted-Python] Re: How to make a secure connection between two	computers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16754">[ date ]</a>
              <a href="thread.html#16754">[ thread ]</a>
              <a href="subject.html#16754">[ subject ]</a>
              <a href="author.html#16754">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks all!

I think that at the end, I'll just use Python's plain socket, since I
don't intend to serve more than one request at a time. I also don't
really need to use SSL, since my two computers can have a pre-shared
secret. Here's what I wrote - tell me what you think!

#!/usr/bin/env python

import sys
import socket

from Crypto.Hash import SHA
from Crypto.Cipher import ARC4

RANDOM_LEN = 16

def get_random():
    return open('/dev/urandom').read(RANDOM_LEN)

def recv(sock, n):
    buf = ''
    while len(buf) &lt; n:
        r = sock.recv(n - len(buf))
        if not r:
            raise socket.error(&quot;Couldn't read enough bytes&quot;)
        buf += r
    return buf

def handshake(sock, secret):
    my_random = get_random()
    my_rc4 = ARC4.new(SHA.new(secret + my_random).digest())
    sock.sendall(my_random)
    peer_random = recv(sock, RANDOM_LEN)
    peer_rc4 = ARC4.new(SHA.new(secret + peer_random).digest())
    sock.sendall(peer_rc4.encrypt('\0'*RANDOM_LEN))
    peer_response = recv(sock, RANDOM_LEN)
    if my_rc4.decrypt(peer_response) != '\0' * RANDOM_LEN:
        raise socket.error('Failed peer authentication')
    return my_rc4, peer_rc4

def server(host, port, secret):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.bind((host, port))
    s.listen(1)
    while True:
        conn, addr = s.accept()
        print 'Connected by', addr
        conn.settimeout(1)
        try:
            my_rc4, peer_rc4 = handshake(conn, secret)
            while True:
                data = my_rc4.decrypt(conn.recv(1024))
                if not data: break
                print 'Received', repr(data)
                conn.send(peer_rc4.encrypt(data))
            conn.close()
        except socket.error, e:
            print 'Error:', e
        else:
            print 'Closed connection'

def client(host, port, secret):
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(1)
    s.connect((host, port))
    my_rc4, peer_rc4 = handshake(s, secret)
    s.send(peer_rc4.encrypt('Hello, world'))
    data = my_rc4.decrypt(s.recv(1024))
    s.close()
    print 'Received', repr(data)

def main():
    if len(sys.argv) != 5 or sys.argv[1] not in ('server', 'client'):
        print &quot;Usage: %s server/client host port secret&quot;
        return
    is_server = sys.argv[1] == 'server'
    host = sys.argv[2]
    port = int(sys.argv[3])
    secret = sys.argv[4]
    if is_server:
        server(host, port, secret)
    else:
        client(host, port, secret)

if __name__ == '__main__':
    main()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016753.html">[Twisted-Python] Re: How to make a secure connection between	two computers
</A></li>
	<LI>Next message: <A HREF="016757.html">[Twisted-Python] Re: How to make a secure connection between two	computers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16754">[ date ]</a>
              <a href="thread.html#16754">[ thread ]</a>
              <a href="subject.html#16754">[ subject ]</a>
              <a href="author.html#16754">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
