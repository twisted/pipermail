<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] LoopingCall at a non-idling reactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20LoopingCall%20at%20a%20non-idling%20reactor&In-Reply-To=%3Calpine.LNX.2.00.0907191657320.18108%40cray.glas.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052499.html">
   <LINK REL="Next"  HREF="052502.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] LoopingCall at a non-idling reactor</H1>
    <B>Ilya Etingof</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20LoopingCall%20at%20a%20non-idling%20reactor&In-Reply-To=%3Calpine.LNX.2.00.0907191657320.18108%40cray.glas.net%3E"
       TITLE="[Twisted-Python] LoopingCall at a non-idling reactor">ilya at glas.net
       </A><BR>
    <I>Sun Jul 19 07:20:46 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052499.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
        <LI>Next message (by thread): <A HREF="052502.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52501">[ date ]</a>
              <a href="thread.html#52501">[ thread ]</a>
              <a href="subject.html#52501">[ subject ]</a>
              <a href="author.html#52501">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;&gt;<i> But why main loop does not fire timed events when it has a chance to do
</I>&gt;&gt;<i> that? Note that my data processor takes 0.2 sec on each run, while my
</I>&gt;&gt;<i> timed event period is 1 sec.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In other words, I'd understand this behavior if my data processor
</I>&gt;&gt;<i> would block main loop for a few periods of timed event, but this
</I>&gt;&gt;<i> is not the case.
</I>&gt;<i>
</I>&gt;<i> Because Twisted receives as many datagrams as possible before going back
</I>&gt;<i> round the select loop (I think). So, 10 calls to datagramReceived are
</I>&gt;<i> done (taking 10*0.2 seconds) before twisted gets a chance to schedule
</I>&gt;<i> any other things.
</I>
Perhaps it works that way. And what makes things worse is that if datagram 
input rate is steady and higher than datagram processing time, the 
LoopingCall calls will never be invoked.

&gt;<i> As JP has said, you're not allowed to block the main loop like that, but
</I>&gt;<i> I've seen similar problems with even relatively quick datagramReceived
</I>&gt;<i> handlers (~0.1msec) under very high load (1000pps) resulting in a form
</I>&gt;<i> of starvation. This isn't generally a problem with TCP calls due to flow
</I>&gt;<i> control.
</I>
I do not think I'm blocking the main loop so much. I'd say I create a
condition when data processing time is a little bit longer than the period 
of incoming datagrams arrival.

By way of feedback, it looks to me that if reactor API would give 
user some degree of control on timed versus receiption calls sequencing, 
that would become a more-or-less elegant solution for issues like mine.

&gt;<i> The solution is:
</I>&gt;<i>
</I>&gt;<i>  def datagramReceived(...):
</I>&gt;<i>    reactor.callLater(0, dorealwork, ...)
</I>&gt;<i>
</I>&gt;<i>  def dorealwork(self, ...):
</I>&gt;<i>    ...
</I>&gt;<i>
</I>&gt;<i> This will schedule the &quot;real&quot; work as soon as possible in the next
</I>&gt;<i> reactor loop, but also &quot;fairly&quot; in line with other calls.
</I>
Thanks for the hint!

With this callLater approach, timer function works better, though, still 
not absolutely fair:

timer called 1248008220.19
dorealwork 1248008220.81
dorealwork 1248008221.21
timer called 1248008221.41
dorealwork 1248008221.41
[ 2 dorealwork calls here ]
dorealwork 1248008222.01
timer called 1248008222.21
dorealwork 1248008222.21
[ 7 dorealwork calls here ]
dorealwork 1248008223.81
timer called 1248008224.01
dorealwork 1248008224.01
[ 17 dorealwork calls here ]
dorealwork 1248008227.61
timer called 1248008227.81
dorealwork 1248008227.81
[ 39 dorealwork calls here ]
dorealwork 1248008235.81
timer called 1248008236.02
dorealwork 1248008236.02
[ 87 dorealwork calls here ]
dorealwork 1248008253.62
timer called 1248008253.83

As we can see, timer call period seems to grow over high load.

thanks,
ilya


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052499.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
	<LI>Next message (by thread): <A HREF="052502.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52501">[ date ]</a>
              <a href="thread.html#52501">[ thread ]</a>
              <a href="subject.html#52501">[ subject ]</a>
              <a href="author.html#52501">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
