<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20OT%20-%20adbapi%2C%20connection%20timeouts%2C%20mysql%20-%20OT&In-Reply-To=4A662D80.1060009%40thiengineering.ch">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020018.html">
   <LINK REL="Next"  HREF="020022.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT</H1>
    <B>Clay Gerrard</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20OT%20-%20adbapi%2C%20connection%20timeouts%2C%20mysql%20-%20OT&In-Reply-To=4A662D80.1060009%40thiengineering.ch"
       TITLE="[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT">clay.gerrard at rackspace.com
       </A><BR>
    <I>Tue Jul 21 17:18:08 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020018.html">[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
</A></li>
        <LI>Next message: <A HREF="020022.html">[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20019">[ date ]</a>
              <a href="thread.html#20019">[ thread ]</a>
              <a href="subject.html#20019">[ subject ]</a>
              <a href="author.html#20019">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Regarding the original question:
&quot;how to make mysql's idle timeouts shorter so that I can debug my code?&quot;

You should be able to do that in the mysql shell:
mysql&gt; show variables like '%timeout%';
+----------------------------+-------+
|<i> Variable_name              | Value |
</I>+----------------------------+-------+
|<i> connect_timeout            | 5     |
</I>|<i> delayed_insert_timeout     | 300   |
</I>|<i> innodb_lock_wait_timeout   | 50    |
</I>|<i> innodb_rollback_on_timeout | OFF   |
</I>|<i> interactive_timeout        | 600   |
</I>|<i> net_read_timeout           | 30    |
</I>|<i> net_write_timeout          | 60    |
</I>|<i> slave_net_timeout          | 3600  |
</I>|<i> table_lock_wait_timeout    | 50    |
</I>|<i> wait_timeout               | 600   |
</I>+----------------------------+-------+
10 rows in set (0.00 sec)

&gt;<i> set global variable interactive_timeout = 5;
</I>
But in my experience MySQLdb makes the idle connection timeout very difficult to debug effectively.

Will twisted.adbapi.ConnectionPool ever offer a pool_recycle kw like sqlalchemy?

Clay Gerrard
Office: 210-312-3443
Mobile: 210-788-9431
-----Original Message-----
From: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> [mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] On Behalf Of Werner Thie
Sent: Tuesday, July 21, 2009 4:05 PM
To: Twisted general discussion
Subject: Re: [Twisted-Python] OT - adbapi, connection timeouts, mysql - OT

Hi Gabriel

had the same problem, solved it by having keepalive() called in a
LoopingCall(), MySQL sitting at defaults timingwise.

DB_DRIVER = &quot;MySQLdb&quot;

USERDB_ARGS = {
   'host': '',
   'db': '',
   'user': '',
   'passwd': '',
   'cp_reconnect': True
}

storekeeper = StoreKeeper(DB_DRIVER, **USERDB_ARGS)

ka = task.LoopingCall(storekeeper.store.keepAlive)
ka.start(300)

class StoreKeeper(object):
   def __init__(self, dbapiName, **params):
     self.store = Store(dbapiName, **params)

   def dbdisconn(self, reason):
     print 'db disconnected for ', reason

   def keepAlive(self):
     d = self.store.runQuery('SELECT 1')
     d.addErrback(self.dbdisconn)


#with store being something like:

class Store(object):
   def __init__(self, dbapiName, **params):
     self.__pool   = adbapi.ConnectionPool(dbapiName, **params)
     print self.__pool.__getstate__()
     self.runOperation('SET autocommit = %s', 1)

   def runQuery(self, query, *args):
     d = self.__pool.runInteraction(self.mapQuery, query, args)
     return d

   def mapQuery(self, curs, query, *args):
     try:
       curs.execute(query, *args)
     except adbapi.ConnectionLost:
       print
       print '++++++++++++ rerunning query'
       print
       curs.execute(query, *args)                    #simply resend
query, assuming cp_reconnect=True
     result = curs.fetchall()
     columns = [d[0] for d in curs.description]
     return [dict(zip(columns, r)) for r in result]

   def runOperation(self, query, *args):
     d = self.__pool.runOperation(query, args)
     return d

   def runInteraction(self, fun, queries=(), args=()):
     d = self.__pool.runInteraction(fun, queries, args)
     return d


HTH, Werner

Gabriel Rossetti wrote:
&gt;<i> Hello everyone,
</I>&gt;<i>
</I>&gt;<i> I have been experiencing the ConnectionError with adbapi &amp;
</I>&gt;<i> cp_reconnect=True. I know that because of the cp_reconnect=True param
</I>&gt;<i> tha is reconnects and that the query is not re-run. I have written some
</I>&gt;<i> code that should re-run the query in that case (if I get a Failure back
</I>&gt;<i> because of a ConnectionError), but it doesn't seem to work. My question
</I>&gt;<i> is if anyone knows how to make mysql's idle timeouts shorter so that I
</I>&gt;<i> can debug my code? I searched google and the mysql site with no luck.
</I>&gt;<i>
</I>&gt;<i> thank you,
</I>&gt;<i> Gabriel
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>

_______________________________________________
Twisted-Python mailing list
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>


Confidentiality Notice: This e-mail message (including any attached or
embedded documents) is intended for the exclusive and confidential use of the
individual or entity to which this message is addressed, and unless otherwise
expressly indicated, is confidential and privileged information of Rackspace. 
Any dissemination, distribution or copying of the enclosed material is prohibited.
If you receive this transmission in error, please notify us immediately by e-mail
at <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">abuse at rackspace.com</A>, and delete the original message. 
Your cooperation is appreciated.


</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020018.html">[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
</A></li>
	<LI>Next message: <A HREF="020022.html">[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20019">[ date ]</a>
              <a href="thread.html#20019">[ thread ]</a>
              <a href="subject.html#20019">[ subject ]</a>
              <a href="author.html#20019">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
