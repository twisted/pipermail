<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to debug an AMP connection?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20debug%20an%20AMP%20connection%3F&In-Reply-To=1248448348.7691.1326625921%40webmail.messagingengine.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020033.html">
   <LINK REL="Next"  HREF="020036.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to debug an AMP connection?</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20debug%20an%20AMP%20connection%3F&In-Reply-To=1248448348.7691.1326625921%40webmail.messagingengine.com"
       TITLE="[Twisted-Python] How to debug an AMP connection?">exarkun at divmod.com
       </A><BR>
    <I>Fri Jul 24 12:01:19 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020033.html">[Twisted-Python] How to debug an AMP connection?
</A></li>
        <LI>Next message: <A HREF="020036.html">[Twisted-Python] How to debug an AMP connection?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20034">[ date ]</a>
              <a href="thread.html#20034">[ thread ]</a>
              <a href="subject.html#20034">[ subject ]</a>
              <a href="author.html#20034">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 24 Jul 2009 16:12:28 +0100, Peter Westlake &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">peter.westlake at pobox.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i>
</I>&gt;<i>On Fri, 24 Jul 2009 10:44 -0400, &quot;Drew Smathers&quot;
</I>&gt;<i>&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">drew.smathers at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> On Fri, Jul 24, 2009 at 9:35 AM, Peter Westlake&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">peter.westlake at pobox.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i> &gt; Hello,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I'm having trouble with an AMP connection that doesn't fire
</I>&gt;&gt;<i> &gt; the Deferred returned by callRemote. The AMP command copies
</I>&gt;&gt;<i> &gt; files from the client (called a &quot;worker&quot; in the code below)
</I>&gt;&gt;<i> &gt; to a server (&quot;controller&quot;). It sends a chunk of text at a
</I>&gt;&gt;<i> &gt; time - 16K originally, but I tried smaller amounts too.
</I>&gt;&gt;<i> &gt; The server appends the text to a queue to be written;
</I>&gt;&gt;<i> &gt; it shouldn't take long, because it doesn't do the I/O
</I>&gt;&gt;<i> &gt; synchronously, just starts a thread.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;justs starts a thread&quot;? Where are you starting a thread in the code
</I>&gt;&gt;<i> example you've posted?
</I>&gt;<i>
</I>&gt;&gt;<i> Please post a complete example; I don't see methods on client code
</I>&gt;&gt;<i> below such as send_next() or next_or_retry().  It's hard to help
</I>&gt;&gt;<i> without a complete example.
</I>&gt;<i>
</I>&gt;<i>Sorry - I was trying to avoid clogging everyone's inboxes with too
</I>&gt;<i>much code. So far I haven't been able to reproduce the bug in a
</I>&gt;<i>simple way. In the meantime, here's the code that starts the thread.
</I>&gt;<i>It's one of the very first bits of code I wrote with either Twisted
</I>&gt;<i>or Python, so it may do things in quite the wrong way. It serialises
</I>&gt;<i>writes to a file by storing requests in a queue, and it gets called
</I>&gt;<i>by the line
</I>&gt;<i>
</I>&gt;<i>       ac.instances[number].logfile[stream].write(data)
</I>&gt;<i>
</I>&gt;<i>in the command handler.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>from twisted.internet import defer, threads
</I>&gt;<i>import os, errno
</I>&gt;<i>
</I>&gt;<i>class FileMan(object):
</I>&gt;<i>    def __init__(self, filename):
</I>&gt;<i>        self.filename = filename
</I>&gt;<i>        self.queue = []
</I>&gt;<i>        self.started = False
</I>&gt;<i>
</I>&gt;<i>    def check_file(self):
</I>&gt;<i>        self.started = os.path.exists(self.filename)
</I>&gt;<i>        return self.started
</I>&gt;<i>
</I>&gt;<i>    def makedir(self):
</I>&gt;<i>        dirname = os.path.dirname(self.filename)
</I>&gt;<i>        if not os.path.isdir(dirname):
</I>&gt;<i>            os.makedirs(dirname)
</I>&gt;<i>
</I>&gt;<i>    def add(self, op, *a, **kw):
</I>&gt;<i>        def getnext(result):
</I>&gt;<i>            del(self.queue[0])
</I>&gt;<i>            if len(self.queue) &gt; 0:
</I>&gt;<i>                self.queue[0].callback('unused')
</I>&gt;<i>            return result
</I>&gt;<i>
</I>&gt;<i>        d = defer.Deferred()
</I>&gt;<i>        d.addCallback(op, *a, **kw)
</I>&gt;<i>        d.addBoth(getnext)
</I>&gt;<i>        self.queue.append(d)
</I>&gt;<i>        if len(self.queue) == 1:
</I>&gt;<i>            d.callback('unused')
</I>&gt;<i>        return d
</I>&gt;<i>
</I>&gt;<i>    def write(self, data, mode='a'):
</I>&gt;<i>        def do_write(result, filename, data):
</I>&gt;<i>            def write_in_thread(filename, data):
</I>&gt;<i>                f = open(filename, mode)
</I>&gt;<i>                try:
</I>&gt;<i>                    f.write(data)
</I>&gt;<i>                finally:
</I>&gt;<i>                    f.close()
</I>&gt;<i>                self.started = True
</I>&gt;<i>            d = threads.deferToThread(write_in_thread, filename, data)
</I>&gt;<i>            return d
</I>&gt;<i>        return self.add(do_write, self.filename, data)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>  In general, though, if you're trying to
</I>&gt;&gt;<i> debug Deferreds you might try setting debugging with
</I>&gt;&gt;<i> defer.setDebugging(1).
</I>&gt;<i>
</I>&gt;<i>What kind of output does that produce? I did try it,
</I>&gt;<i>but didn't see anything out of the ordinary.
</I>
It makes Deferreds keep track of the call stack when they are created and
when they are invoked.  This can be helpful tracking down Deferred failures
that don't otherwise identify themselves very well.  If you're not seeing
any failures being logged, then this probably won't help much, since there
won't be anything to increase the verbosity of. :)

Another thing to check out would be a network capture, to see if the server
is actually sending back a response.  If not, then you know you should look
at the server code more carefully.  If so, then the client code is probably
at fault.

Jean-Paul

</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020033.html">[Twisted-Python] How to debug an AMP connection?
</A></li>
	<LI>Next message: <A HREF="020036.html">[Twisted-Python] How to debug an AMP connection?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20034">[ date ]</a>
              <a href="thread.html#20034">[ thread ]</a>
              <a href="subject.html#20034">[ subject ]</a>
              <a href="author.html#20034">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
