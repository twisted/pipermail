<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] LoopingCall at a non-idling reactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20LoopingCall%20at%20a%20non-idling%20reactor&In-Reply-To=alpine.LNX.2.00.0907191152010.17866%40cray.glas.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019990.html">
   <LINK REL="Next"  HREF="019994.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] LoopingCall at a non-idling reactor</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20LoopingCall%20at%20a%20non-idling%20reactor&In-Reply-To=alpine.LNX.2.00.0907191152010.17866%40cray.glas.net"
       TITLE="[Twisted-Python] LoopingCall at a non-idling reactor">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Sun Jul 19 07:27:46 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019990.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
        <LI>Next message: <A HREF="019994.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19992">[ date ]</a>
              <a href="thread.html#19992">[ thread ]</a>
              <a href="subject.html#19992">[ subject ]</a>
              <a href="author.html#19992">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, Jul 19, 2009 at 09:01:34AM +0100, Ilya Etingof wrote:
&gt;<i>
</I>&gt;<i>[ skipped ]
</I>&gt;<i>
</I>&gt;&gt;<i> The above is something which you're more or less not allowed to do in a
</I>&gt;&gt;<i> Twisted application.  That simulated data processing is blocking the
</I>&gt;&gt;<i> main event loop.  Nothing else happens until it finishes - that includes
</I>&gt;&gt;<i> handling more UDP packets and it includes running timed events like the
</I>&gt;&gt;<i> ones LoopingCall sets up.
</I>&gt;<i>
</I>&gt;<i>But why main loop does not fire timed events when it has a chance to do 
</I>&gt;<i>that? Note that my data processor takes 0.2 sec on each run, while my 
</I>&gt;<i>timed event period is 1 sec.
</I>&gt;<i>
</I>&gt;<i>In other words, I'd understand this behavior if my data processor
</I>&gt;<i>would block main loop for a few periods of timed event, but this
</I>&gt;<i>is not the case.
</I>
Because Twisted receives as many datagrams as possible before going back 
round the select loop (I think). So, 10 calls to datagramReceived are 
done (taking 10*0.2 seconds) before twisted gets a chance to schedule 
any other things.

As JP has said, you're not allowed to block the main loop like that, but 
I've seen similar problems with even relatively quick datagramReceived 
handlers (~0.1msec) under very high load (1000pps) resulting in a form 
of starvation. This isn't generally a problem with TCP calls due to flow 
control.

The solution is:

  def datagramReceived(...):
    reactor.callLater(0, dorealwork, ...)

  def dorealwork(self, ...):
    ...

This will schedule the &quot;real&quot; work as soon as possible in the next 
reactor loop, but also &quot;fairly&quot; in line with other calls.


You still shouldn't block the reactor for a &quot;long&quot; time (the exact value 
is dependent on your app)


</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019990.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
	<LI>Next message: <A HREF="019994.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19992">[ date ]</a>
              <a href="thread.html#19992">[ thread ]</a>
              <a href="subject.html#19992">[ subject ]</a>
              <a href="author.html#19992">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
