<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20OT%20-%20adbapi%2C%20connection%20timeouts%2C%20mysql%20-%20OT&In-Reply-To=%3C31852_1248271614_n6ME6ltX011910_5DA4635225CBE24FB33D34EFB6C5304714B0BD38E2%40DFW1MXM01.RACKSPACE.CORP%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052532.html">
   <LINK REL="Next"  HREF="052531.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT</H1>
    <B>Clay Gerrard</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20OT%20-%20adbapi%2C%20connection%20timeouts%2C%20mysql%20-%20OT&In-Reply-To=%3C31852_1248271614_n6ME6ltX011910_5DA4635225CBE24FB33D34EFB6C5304714B0BD38E2%40DFW1MXM01.RACKSPACE.CORP%3E"
       TITLE="[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT">clay.gerrard at rackspace.com
       </A><BR>
    <I>Wed Jul 22 08:06:35 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052532.html">[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
</A></li>
        <LI>Next message (by thread): <A HREF="052531.html">[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52535">[ date ]</a>
              <a href="thread.html#52535">[ thread ]</a>
              <a href="subject.html#52535">[ subject ]</a>
              <a href="author.html#52535">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In my experience &quot;re-running the query&quot; has not been sufficient.

All of the connections in the pool time out around the same time.

Using cp_reconnect just forces the &quot;idle&quot; connection (cursor) to be removed from the pool before raising the generic &quot;ConnectionLost&quot;:

    def rollback(self):
        if not self._pool.reconnect:
            self._connection.rollback()
            return

        try:
            self._connection.rollback()
            curs = self._connection.cursor()
            curs.execute(self._pool.good_sql)
            curs.close()
            self._connection.commit()
            return
        except:
            log.err(None, &quot;Rollback failed&quot;)

        self._pool.disconnect(self._connection)

        if self._pool.noisy:
            log.msg(&quot;Connection lost.&quot;)

        raise ConnectionLost()

But when I go to re-run the query it's very unlikely that I'll get that same thread id again (and therefore a fresh connection).  More than likely I'll get another stale connection which will also get dropped.  Repeat ad infinitum

I'm fairly sure the right thing to do is to make adbapi.Connection objects aware of their created time, and allow adbapi.ConnectionPool.connect to potentially refresh &quot;old&quot; connections based on an optional kwarg when creating the connection pool:

&quot;pool_recycle&quot;

That's what I'm working on anyway...

Clay Gerrard
Office: 210-312-3443
Mobile: 210-788-9431
-----Original Message-----
From: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> [mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] On Behalf Of Gabriel Rossetti
Sent: Wednesday, July 22, 2009 1:34 AM
To: Twisted general discussion
Subject: Re: [Twisted-Python] OT - adbapi, connection timeouts, mysql - OT

Hello Garret,

yes, I finally did did something like that, I am currently testing the code.

Thanks,
Gabriel

Garret Heaton wrote:
&gt;<i> Instead of trying to keep the connection alive you can also just
</I>&gt;<i> reconnect when necessary. Example code here:
</I>&gt;<i> <A HREF="http://stackoverflow.com/questions/207981/how-to-enable-mysql-client-auto-re-connect-with-mysqldb/982873#982873">http://stackoverflow.com/questions/207981/how-to-enable-mysql-client-auto-re-connect-with-mysqldb/982873#982873</A>
</I>&gt;<i>
</I>&gt;<i> On Tue, Jul 21, 2009 at 2:18 PM, Clay Gerrard
</I>&gt;<i> &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">clay.gerrard at rackspace.com</A> &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">clay.gerrard at rackspace.com</A>&gt;&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>     Regarding the original question:
</I>&gt;<i>     &quot;how to make mysql's idle timeouts shorter so that I can debug my
</I>&gt;<i>     code?&quot;
</I>&gt;<i>
</I>&gt;<i>     You should be able to do that in the mysql shell:
</I>&gt;<i>     mysql&gt; show variables like '%timeout%';
</I>&gt;<i>     +----------------------------+-------+
</I>&gt;<i>     | Variable_name              | Value |
</I>&gt;<i>     +----------------------------+-------+
</I>&gt;<i>     | connect_timeout            | 5     |
</I>&gt;<i>     | delayed_insert_timeout     | 300   |
</I>&gt;<i>     | innodb_lock_wait_timeout   | 50    |
</I>&gt;<i>     | innodb_rollback_on_timeout | OFF   |
</I>&gt;<i>     | interactive_timeout        | 600   |
</I>&gt;<i>     | net_read_timeout           | 30    |
</I>&gt;<i>     | net_write_timeout          | 60    |
</I>&gt;<i>     | slave_net_timeout          | 3600  |
</I>&gt;<i>     | table_lock_wait_timeout    | 50    |
</I>&gt;<i>     | wait_timeout               | 600   |
</I>&gt;<i>     +----------------------------+-------+
</I>&gt;<i>     10 rows in set (0.00 sec)
</I>&gt;<i>
</I>&gt;<i>     &gt; set global variable interactive_timeout = 5;
</I>&gt;<i>
</I>&gt;<i>     But in my experience MySQLdb makes the idle connection timeout
</I>&gt;<i>     very difficult to debug effectively.
</I>&gt;<i>
</I>&gt;<i>     Will twisted.adbapi.ConnectionPool ever offer a pool_recycle kw
</I>&gt;<i>     like sqlalchemy?
</I>&gt;<i>
</I>&gt;<i>     Clay Gerrard
</I>&gt;<i>     Office: 210-312-3443
</I>&gt;<i>     Mobile: 210-788-9431
</I>&gt;<i>     -----Original Message-----
</I>&gt;<i>     From: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>&gt;
</I>&gt;<i>     [mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>&gt;] On Behalf Of
</I>&gt;<i>     Werner Thie
</I>&gt;<i>     Sent: Tuesday, July 21, 2009 4:05 PM
</I>&gt;<i>     To: Twisted general discussion
</I>&gt;<i>     Subject: Re: [Twisted-Python] OT - adbapi, connection timeouts,
</I>&gt;<i>     mysql - OT
</I>&gt;<i>
</I>&gt;<i>     Hi Gabriel
</I>&gt;<i>
</I>&gt;<i>     had the same problem, solved it by having keepalive() called in a
</I>&gt;<i>     LoopingCall(), MySQL sitting at defaults timingwise.
</I>&gt;<i>
</I>&gt;<i>     DB_DRIVER = &quot;MySQLdb&quot;
</I>&gt;<i>
</I>&gt;<i>     USERDB_ARGS = {
</I>&gt;<i>       'host': '',
</I>&gt;<i>       'db': '',
</I>&gt;<i>       'user': '',
</I>&gt;<i>       'passwd': '',
</I>&gt;<i>       'cp_reconnect': True
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     storekeeper = StoreKeeper(DB_DRIVER, **USERDB_ARGS)
</I>&gt;<i>
</I>&gt;<i>     ka = task.LoopingCall(storekeeper.store.keepAlive)
</I>&gt;<i>     ka.start(300)
</I>&gt;<i>
</I>&gt;<i>     class StoreKeeper(object):
</I>&gt;<i>       def __init__(self, dbapiName, **params):
</I>&gt;<i>         self.store = Store(dbapiName, **params)
</I>&gt;<i>
</I>&gt;<i>       def dbdisconn(self, reason):
</I>&gt;<i>         print 'db disconnected for ', reason
</I>&gt;<i>
</I>&gt;<i>       def keepAlive(self):
</I>&gt;<i>         d = self.store.runQuery('SELECT 1')
</I>&gt;<i>         d.addErrback(self.dbdisconn)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     #with store being something like:
</I>&gt;<i>
</I>&gt;<i>     class Store(object):
</I>&gt;<i>       def __init__(self, dbapiName, **params):
</I>&gt;<i>         self.__pool   = adbapi.ConnectionPool(dbapiName, **params)
</I>&gt;<i>         print self.__pool.__getstate__()
</I>&gt;<i>         self.runOperation('SET autocommit = %s', 1)
</I>&gt;<i>
</I>&gt;<i>       def runQuery(self, query, *args):
</I>&gt;<i>         d = self.__pool.runInteraction(self.mapQuery, query, args)
</I>&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i>       def mapQuery(self, curs, query, *args):
</I>&gt;<i>         try:
</I>&gt;<i>           curs.execute(query, *args)
</I>&gt;<i>         except adbapi.ConnectionLost:
</I>&gt;<i>           print
</I>&gt;<i>           print '++++++++++++ rerunning query'
</I>&gt;<i>           print
</I>&gt;<i>           curs.execute(query, *args)                    #simply resend
</I>&gt;<i>     query, assuming cp_reconnect=True
</I>&gt;<i>         result = curs.fetchall()
</I>&gt;<i>         columns = [d[0] for d in curs.description]
</I>&gt;<i>         return [dict(zip(columns, r)) for r in result]
</I>&gt;<i>
</I>&gt;<i>       def runOperation(self, query, *args):
</I>&gt;<i>         d = self.__pool.runOperation(query, args)
</I>&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i>       def runInteraction(self, fun, queries=(), args=()):
</I>&gt;<i>         d = self.__pool.runInteraction(fun, queries, args)
</I>&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     HTH, Werner
</I>&gt;<i>
</I>&gt;<i>     Gabriel Rossetti wrote:
</I>&gt;<i>     &gt; Hello everyone,
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; I have been experiencing the ConnectionError with adbapi &amp;
</I>&gt;<i>     &gt; cp_reconnect=True. I know that because of the cp_reconnect=True
</I>&gt;<i>     param
</I>&gt;<i>     &gt; tha is reconnects and that the query is not re-run. I have
</I>&gt;<i>     written some
</I>&gt;<i>     &gt; code that should re-run the query in that case (if I get a
</I>&gt;<i>     Failure back
</I>&gt;<i>     &gt; because of a ConnectionError), but it doesn't seem to work. My
</I>&gt;<i>     question
</I>&gt;<i>     &gt; is if anyone knows how to make mysql's idle timeouts shorter so
</I>&gt;<i>     that I
</I>&gt;<i>     &gt; can debug my code? I searched google and the mysql site with no
</I>&gt;<i>     luck.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; thank you,
</I>&gt;<i>     &gt; Gabriel
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; _______________________________________________
</I>&gt;<i>     &gt; Twisted-Python mailing list
</I>&gt;<i>     &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>&gt;
</I>&gt;<i>     &gt; <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     Twisted-Python mailing list
</I>&gt;<i>     <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>&gt;
</I>&gt;<i>     <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     Confidentiality Notice: This e-mail message (including any attached or
</I>&gt;<i>     embedded documents) is intended for the exclusive and confidential
</I>&gt;<i>     use of the
</I>&gt;<i>     individual or entity to which this message is addressed, and
</I>&gt;<i>     unless otherwise
</I>&gt;<i>     expressly indicated, is confidential and privileged information of
</I>&gt;<i>     Rackspace.
</I>&gt;<i>     Any dissemination, distribution or copying of the enclosed
</I>&gt;<i>     material is prohibited.
</I>&gt;<i>     If you receive this transmission in error, please notify us
</I>&gt;<i>     immediately by e-mail
</I>&gt;<i>     at <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">abuse at rackspace.com</A> &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">abuse at rackspace.com</A>&gt;, and delete
</I>&gt;<i>     the original message.
</I>&gt;<i>     Your cooperation is appreciated.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     Twisted-Python mailing list
</I>&gt;<i>     <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>&gt;
</I>&gt;<i>     <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>
_______________________________________________
Twisted-Python mailing list
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>


Confidentiality Notice: This e-mail message (including any attached or
embedded documents) is intended for the exclusive and confidential use of the
individual or entity to which this message is addressed, and unless otherwise
expressly indicated, is confidential and privileged information of Rackspace.
Any dissemination, distribution or copying of the enclosed material is prohibited.
If you receive this transmission in error, please notify us immediately by e-mail
at <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">abuse at rackspace.com</A>, and delete the original message.
Your cooperation is appreciated.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052532.html">[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
</A></li>
	<LI>Next message (by thread): <A HREF="052531.html">[Twisted-Python] OT - adbapi, connection timeouts, mysql - OT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52535">[ date ]</a>
              <a href="thread.html#52535">[ thread ]</a>
              <a href="subject.html#52535">[ subject ]</a>
              <a href="author.html#52535">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
