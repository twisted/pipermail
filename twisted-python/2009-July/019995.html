<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] LoopingCall at a non-idling reactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20LoopingCall%20at%20a%20non-idling%20reactor&In-Reply-To=alpine.LNX.2.00.0907191657320.18108%40cray.glas.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019994.html">
   <LINK REL="Next"  HREF="019996.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] LoopingCall at a non-idling reactor</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20LoopingCall%20at%20a%20non-idling%20reactor&In-Reply-To=alpine.LNX.2.00.0907191657320.18108%40cray.glas.net"
       TITLE="[Twisted-Python] LoopingCall at a non-idling reactor">exarkun at divmod.com
       </A><BR>
    <I>Sun Jul 19 09:58:40 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019994.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
        <LI>Next message: <A HREF="019996.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19995">[ date ]</a>
              <a href="thread.html#19995">[ thread ]</a>
              <a href="subject.html#19995">[ subject ]</a>
              <a href="author.html#19995">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 19 Jul 2009 17:20:46 +0400 (MSD), Ilya Etingof &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ilya at glas.net</A>&gt; wrote:
&gt;<i>
</I>&gt;&gt;&gt;<i> But why main loop does not fire timed events when it has a chance to do
</I>&gt;&gt;&gt;<i> that? Note that my data processor takes 0.2 sec on each run, while my
</I>&gt;&gt;&gt;<i> timed event period is 1 sec.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In other words, I'd understand this behavior if my data processor
</I>&gt;&gt;&gt;<i> would block main loop for a few periods of timed event, but this
</I>&gt;&gt;&gt;<i> is not the case.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Because Twisted receives as many datagrams as possible before going back
</I>&gt;&gt;<i> round the select loop (I think). So, 10 calls to datagramReceived are
</I>&gt;&gt;<i> done (taking 10*0.2 seconds) before twisted gets a chance to schedule
</I>&gt;&gt;<i> any other things.
</I>&gt;<i>
</I>&gt;<i>Perhaps it works that way. And what makes things worse is that if datagram
</I>&gt;<i>input rate is steady and higher than datagram processing time, the
</I>&gt;<i>LoopingCall calls will never be invoked.
</I>
It will eventually stop reading datagrams and go do something else.  The
exact way it decides when to stop is completely arbitrary and I don't
think anyone has ever demonstrated that it's clever or appropriate in the
general case (it stops after reading 256k of datagrams).

&gt;<i>
</I>&gt;&gt;<i> As JP has said, you're not allowed to block the main loop like that, but
</I>&gt;&gt;<i> I've seen similar problems with even relatively quick datagramReceived
</I>&gt;&gt;<i> handlers (~0.1msec) under very high load (1000pps) resulting in a form
</I>&gt;&gt;<i> of starvation. This isn't generally a problem with TCP calls due to flow
</I>&gt;&gt;<i> control.
</I>&gt;<i>
</I>&gt;<i>I do not think I'm blocking the main loop so much. I'd say I create a
</I>&gt;<i>condition when data processing time is a little bit longer than the period
</I>&gt;<i>of incoming datagrams arrival.
</I>&gt;<i>
</I>&gt;<i>By way of feedback, it looks to me that if reactor API would give
</I>&gt;<i>user some degree of control on timed versus receiption calls sequencing,
</I>&gt;<i>that would become a more-or-less elegant solution for issues like mine.
</I>
One possibility is that we could document the limit I described above and
tell people to adjust it upwards or downwards as they so desire.

&gt;<i>
</I>&gt;&gt;<i> The solution is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  def datagramReceived(...):
</I>&gt;&gt;<i>    reactor.callLater(0, dorealwork, ...)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  def dorealwork(self, ...):
</I>&gt;&gt;<i>    ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This will schedule the &quot;real&quot; work as soon as possible in the next
</I>&gt;&gt;<i> reactor loop, but also &quot;fairly&quot; in line with other calls.
</I>&gt;<i>
</I>&gt;<i>Thanks for the hint!
</I>&gt;<i>
</I>&gt;<i>With this callLater approach, timer function works better, though, still
</I>&gt;<i>not absolutely fair:
</I>&gt;<i>
</I>&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>As we can see, timer call period seems to grow over high load.
</I>&gt;<i>
</I>
reactor.callLater(0, f) isn't magic.  I probably wouldn't have suggested
it as a solution here.  All it means (more or less) is &quot;do this work after
all current i/o events have been dispatched.&quot;  You still might end up with
more than one second of processing bunched up together, and so you'll still
miss a LoopingCall iteration.

Jean-Paul

</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019994.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
	<LI>Next message: <A HREF="019996.html">[Twisted-Python] LoopingCall at a non-idling reactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19995">[ date ]</a>
              <a href="thread.html#19995">[ thread ]</a>
              <a href="subject.html#19995">[ subject ]</a>
              <a href="author.html#19995">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
