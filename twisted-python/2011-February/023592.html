<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Error (and response) handling in protocols
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Error%20%28and%20response%29%20handling%20in%20protocols&In-Reply-To=AANLkTin-VH%3DMvFsmLywqHqYdqhqcSQrAj8W9OO_OgmOO%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023589.html">
   <LINK REL="Next"  HREF="023593.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Error (and response) handling in protocols</H1>
    <B>Jason Heeris</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Error%20%28and%20response%29%20handling%20in%20protocols&In-Reply-To=AANLkTin-VH%3DMvFsmLywqHqYdqhqcSQrAj8W9OO_OgmOO%40mail.gmail.com"
       TITLE="[Twisted-Python] Error (and response) handling in protocols">jason.heeris at gmail.com
       </A><BR>
    <I>Mon Feb 21 21:23:13 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023589.html">[Twisted-Python] Error (and response) handling in protocols
</A></li>
        <LI>Next message: <A HREF="023593.html">[Twisted-Python] Twisted Cred using network connections to check	credentials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23592">[ date ]</a>
              <a href="thread.html#23592">[ thread ]</a>
              <a href="subject.html#23592">[ subject ]</a>
              <a href="author.html#23592">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21 February 2011 22:45, Jason Rennie &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jrennie at gmail.com</A>&gt; wrote:
&gt;<i> Sounds like you just need a queue of pending commands and a state object for
</I>&gt;<i> the currently executing command.
</I>
Just for the sake of completeness, this is what I've ended up with. No
explicit queues, and the state is kept with a lock:

--------
class CommandProtocol(LineOnlyReceiver, TimeoutMixin):

    def __init__(self):
        self.lock = defer.DeferredLock()
        self.deferred = None

    def runCommand(self, command, payload=None):
        result = self.lock.run(self.sendCommand, command, payload)
        return result

    def sendCommand(self, command, payload=None):
        assert self.deferred is None, &quot;Already waiting for reply!&quot;

        # The parser uses these
        self.command = command
        self.sent = msg

        self.deferred = defer.Deferred()
        self.deferred.addCallback(self.parseReply)
        self.deferred.addBoth(self.cleanup)
        self.setTimeout(self.DEFAULT_TIMEOUT)
        self.sendLine(msg)
        return self.deferred

    def cleanup(self, res):
        self.deferred = None
        del self.command
        del self.sent
        return res

    def lineReceived(self, line):
        if self.deferred:
            self.setTimeout(None)
            self.deferred.callback(line)
        # If not, we've timed out or this is a spurious line

    def timeoutConnection(self):
        self.deferred.errback(
            Timeout(&quot;The device took too long to respond&quot;))

    def parseReply(self, line):
        # Do parsing, raise synchronous errors if bad
        return reply
--------

Technically, things like self.command, self.sent, self.deferred etc.
could be closed over by nested functions, which could be set as the
callbacks, but that's just down to where and how you prefer to store
state. Besides, we all know that flat &gt; nested ;)

Thanks for everyone's help!

&#8212; Jason

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023589.html">[Twisted-Python] Error (and response) handling in protocols
</A></li>
	<LI>Next message: <A HREF="023593.html">[Twisted-Python] Twisted Cred using network connections to check	credentials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23592">[ date ]</a>
              <a href="thread.html#23592">[ thread ]</a>
              <a href="subject.html#23592">[ subject ]</a>
              <a href="author.html#23592">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
