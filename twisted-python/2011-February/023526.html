<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Conch SFTP client help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Conch%20SFTP%20client%20help&In-Reply-To=AANLkTinwMBwe1Qi-wBktwp3UgUk6%2BjTWzkCS7fJXK0x3%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023524.html">
   <LINK REL="Next"  HREF="023525.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Conch SFTP client help</H1>
    <B>Brad Milne</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Conch%20SFTP%20client%20help&In-Reply-To=AANLkTinwMBwe1Qi-wBktwp3UgUk6%2BjTWzkCS7fJXK0x3%40mail.gmail.com"
       TITLE="[Twisted-Python] Conch SFTP client help">brad.milne at devx.runthered.com
       </A><BR>
    <I>Tue Feb  8 22:45:31 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023524.html">[Twisted-Python] Conch SFTP client help
</A></li>
        <LI>Next message: <A HREF="023525.html">[Twisted-Python] Announcing txMySQL - native async Twisted MySQL	protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23526">[ date ]</a>
              <a href="thread.html#23526">[ thread ]</a>
              <a href="subject.html#23526">[ subject ]</a>
              <a href="author.html#23526">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Nevermind. I was missing 'self.dataReceived =
self.interface_handler.dataReceived' in the __init__ of SSHSession
and self.dataReceived = self._client.dataReceived in the __init__ of
SftpClient. Maybe I need to reduce the abstraction a bit here, hmm.

Well hopefully this helps someone sometime....


On 9 February 2011 10:00, Brad Milne &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">brad.milne at devx.runthered.com</A>&gt; wrote:

&gt;<i> Hi all
</I>&gt;<i>
</I>&gt;<i> I've looked around for SFTP client doco, but it's come up pretty thin on
</I>&gt;<i> the ground. I've seen <A HREF="http://twistedmatrix.com/trac/wiki/TwistedConch">http://twistedmatrix.com/trac/wiki/TwistedConch</A> and
</I>&gt;<i> everything under it. With it I've been able to connect via SSH to a server
</I>&gt;<i> and run a command (*a la* the 'cat' example from tutorial page and from
</I>&gt;<i> sshsimpleclient.py&lt;<A HREF="http://twistedmatrix.com/documents/current/conch/examples/sshsimpleclient.py">http://twistedmatrix.com/documents/current/conch/examples/sshsimpleclient.py</A>&gt;
</I>&gt;<i> ).
</I>&gt;<i>
</I>&gt;<i> On the other hand, plenty of posts recommend checking out cftp.py in
</I>&gt;<i> scripts/. That uses the FileTransferClient, and appears to be more along the
</I>&gt;<i> lines of what is needed for a persistent SFTP connection and file transfers.
</I>&gt;<i>
</I>&gt;<i> What seems to be happening with the below is that the connection is being
</I>&gt;<i> created OK, but I haven't been able to utilise the _remoteGlob method (taken
</I>&gt;<i> from cftp.py). It simply hangs.
</I>&gt;<i>
</I>&gt;<i> My sandbox code is below.
</I>&gt;<i>
</I>&gt;<i> Any help greatly appreciated.
</I>&gt;<i> Brad
</I>&gt;<i>
</I>&gt;<i> &lt;code&gt;
</I>&gt;<i> import os
</I>&gt;<i> from twisted.python import failure
</I>&gt;<i> from twisted.internet import reactor, protocol, defer
</I>&gt;<i> from twisted.conch.ssh import transport, connection, userauth, channel,
</I>&gt;<i> common, filetransfer
</I>&gt;<i> import logging
</I>&gt;<i> from twisted.python import log
</I>&gt;<i> import sys
</I>&gt;<i>
</I>&gt;<i> class SimpleTransport(transport.SSHClientTransport):
</I>&gt;<i>     def verifyHostKey(self, hostKey, fingerprint):
</I>&gt;<i>         print 'host key fingerprint: %s' % fingerprint
</I>&gt;<i>         return defer.succeed(1)
</I>&gt;<i>
</I>&gt;<i>     def connectionSecure(self):
</I>&gt;<i>         '''
</I>&gt;<i>         called when the encryption is set up and other services can be run
</I>&gt;<i>         '''
</I>&gt;<i>         self.requestService(SimpleUserAuth(USERNAME,SimpleConnection()))
</I>&gt;<i>
</I>&gt;<i> class SimpleConnection(connection.SSHConnection):
</I>&gt;<i>     def serviceStarted(self):
</I>&gt;<i>         self.openChannel(SSHSession())
</I>&gt;<i>
</I>&gt;<i> class SimpleUserAuth(userauth.SSHUserAuthClient):
</I>&gt;<i>     def getPassword(self):
</I>&gt;<i>         return defer.succeed(PASS)
</I>&gt;<i>
</I>&gt;<i> class SSHSession(channel.SSHChannel):
</I>&gt;<i>     '''
</I>&gt;<i>     Things to do within the active SSH session.
</I>&gt;<i>     '''
</I>&gt;<i>     name = 'session'
</I>&gt;<i>
</I>&gt;<i>     def __init__(self, interface_handler=None, *args, **kwargs):
</I>&gt;<i>         channel.SSHChannel.__init__(self, *args, **kwargs)
</I>&gt;<i>         self.interface_handler = interface_handler or SftpClient(self)
</I>&gt;<i>
</I>&gt;<i>     def channelOpen(self, ignoredData):
</I>&gt;<i>         self.data = ''
</I>&gt;<i>         # Create an sftp connection (stays open)
</I>&gt;<i>         d = self.conn.sendRequest(self, 'subsystem', common.NS('sftp'),
</I>&gt;<i> wantReply=1)
</I>&gt;<i>         d.addCallback(self._cbSubsystem)
</I>&gt;<i>
</I>&gt;<i>     def _cbSubsystem(self, result):
</I>&gt;<i>         self.interface_handler.getDirectoryContents('/tmp')
</I>&gt;<i>
</I>&gt;<i>     def closeReceived(self):
</I>&gt;<i>         logging.info('remote side closed %s' % self)
</I>&gt;<i>         self.conn.sendClose(self)
</I>&gt;<i>         reactor.stop()
</I>&gt;<i>
</I>&gt;<i> class SftpClient(object):
</I>&gt;<i>
</I>&gt;<i>     def __init__(self, transport, *args, **kwargs):
</I>&gt;<i>         super(SftpClient, self).__init__(*args, **kwargs)
</I>&gt;<i>         self.transport = transport
</I>&gt;<i>         self._client = filetransfer.FileTransferClient()
</I>&gt;<i>
</I>&gt;<i>     @property
</I>&gt;<i>     def client(self):
</I>&gt;<i>         if not self._client.connected:
</I>&gt;<i>             self._client.makeConnection(self.transport)
</I>&gt;<i>             logging.debug(&quot;Made 'connection' with transport class&quot;)
</I>&gt;<i>         return self._client
</I>&gt;<i>
</I>&gt;<i>     def getDirectoryContents(self, path):
</I>&gt;<i>         d = self._remoteGlob(path)
</I>&gt;<i>
</I>&gt;<i>         def gotit(files):
</I>&gt;<i>             print &quot;Got %s: %s&quot; % (type(files), files)
</I>&gt;<i>         d.addCallback(gotit)
</I>&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i>     # Accessory methods.
</I>&gt;<i>     # These are stolen from twisted.conch.scripts.cftp.py. We can't
</I>&gt;<i>     # import that module as it contains unix-dependent imports.
</I>&gt;<i>     def _remoteGlob(self, fullPath):
</I>&gt;<i>         logging.debug('looking up %s' % fullPath)
</I>&gt;<i>         head, tail = os.path.split(fullPath)
</I>&gt;<i>         if '*' in tail or '?' in tail:
</I>&gt;<i>             glob = 1
</I>&gt;<i>         else:
</I>&gt;<i>             glob = 0
</I>&gt;<i>         if tail and not glob: # could be file or directory
</I>&gt;<i>             # try directory first
</I>&gt;<i>             logging.debug(&quot;Opening dir&quot;)
</I>&gt;<i>             d = self.client.openDirectory(fullPath)
</I>&gt;<i>             d.addCallback(self._cbOpenList, '')
</I>&gt;<i>             d.addErrback(self._ebNotADirectory, head, tail)
</I>&gt;<i>         else:
</I>&gt;<i>             d = self.client.openDirectory(head)
</I>&gt;<i>             d.addCallback(self._cbOpenList, tail)
</I>&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i>     def _cbOpenList(self, directory, glob):
</I>&gt;<i>         logging.debug(&quot;Got dir&quot;)
</I>&gt;<i>         files = []
</I>&gt;<i>         d = directory.read()
</I>&gt;<i>         d.addBoth(self._cbReadFile, files, directory, glob)
</I>&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i>     def _ebNotADirectory(self, reason, path, glob):
</I>&gt;<i>         logging.debug(&quot;Not a dir&quot;)
</I>&gt;<i>         d = self.client.openDirectory(path)
</I>&gt;<i>         d.addCallback(self._cbOpenList, glob)
</I>&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i>     def _cbReadFile(self, files, l, directory, glob):
</I>&gt;<i>         logging.debug(&quot;Reading file&quot;)
</I>&gt;<i>         if not isinstance(files, failure.Failure):
</I>&gt;<i>             if glob:
</I>&gt;<i>                 raise NotImplementedError(&quot;don't have fnmatch available to
</I>&gt;<i> use on Windows so have commented this bit out&quot;)
</I>&gt;<i> #                l.extend([f for f in files if fnmatch.fnmatch(f[0],
</I>&gt;<i> glob)])
</I>&gt;<i>             else:
</I>&gt;<i>                 l.extend(files)
</I>&gt;<i>             d = directory.read()
</I>&gt;<i>             d.addBoth(self._cbReadFile, l, directory, glob)
</I>&gt;<i>             return d
</I>&gt;<i>         else:
</I>&gt;<i>             reason = files
</I>&gt;<i>             reason.trap(EOFError)
</I>&gt;<i>             directory.close()
</I>&gt;<i>             return l
</I>&gt;<i>
</I>&gt;<i> if __name__=='__main__':
</I>&gt;<i>     protocol.ClientCreator(reactor, SimpleTransport).connectTCP(HOST, 22)
</I>&gt;<i>     log.startLogging(sys.stdout, setStdout=0)
</I>&gt;<i>     reactor.run()
</I>&gt;<i>
</I>&gt;<i> &lt;/code&gt;
</I>&gt;<i>
</I>


-- 
Brad Milne | Run The Red | *<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">brad.milne at devx.runthered.com</A>*
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20110209/531636b3/attachment-0001.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20110209/531636b3/attachment-0001.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023524.html">[Twisted-Python] Conch SFTP client help
</A></li>
	<LI>Next message: <A HREF="023525.html">[Twisted-Python] Announcing txMySQL - native async Twisted MySQL	protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23526">[ date ]</a>
              <a href="thread.html#23526">[ thread ]</a>
              <a href="subject.html#23526">[ subject ]</a>
              <a href="author.html#23526">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
