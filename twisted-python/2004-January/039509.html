<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] mktap/twistd make 2 copies of some objects?  (was Re: [Twisted-web] subtle copying in woven driving me crazy.)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20mktap/twistd%20make%202%20copies%20of%20some%20objects%3F%20%20%28was%20Re%3A%20%5BTwisted-web%5D%0A%20subtle%20copying%20in%20woven%20driving%20me%20crazy.%29&In-Reply-To=%3C40067B3A.3050309%40paradise.net.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="039507.html">
   <LINK REL="Next"  HREF="039511.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] mktap/twistd make 2 copies of some objects?  (was Re: [Twisted-web] subtle copying in woven driving me crazy.)</H1>
    <B>Douglas Bagnall</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20mktap/twistd%20make%202%20copies%20of%20some%20objects%3F%20%20%28was%20Re%3A%20%5BTwisted-web%5D%0A%20subtle%20copying%20in%20woven%20driving%20me%20crazy.%29&In-Reply-To=%3C40067B3A.3050309%40paradise.net.nz%3E"
       TITLE="[Twisted-Python] mktap/twistd make 2 copies of some objects?  (was Re: [Twisted-web] subtle copying in woven driving me crazy.)">douglas at paradise.net.nz
       </A><BR>
    <I>Thu Jan 15 04:36:26 MST 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="039507.html">[Twisted-Python] Adding pb users online
</A></li>
        <LI>Next message (by thread): <A HREF="039511.html">[Twisted-Python] mktap/twistd make 2 copies of some objects? 	(was Re: [Twisted-web] subtle copying in woven driving me crazy.)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39509">[ date ]</a>
              <a href="thread.html#39509">[ thread ]</a>
              <a href="subject.html#39509">[ subject ]</a>
              <a href="author.html#39509">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A while ago in twisted-web, in a thread beginning here:

<A HREF="http://twistedmatrix.com/pipermail/twisted-web/2003-December/000061.html">http://twistedmatrix.com/pipermail/twisted-web/2003-December/000061.html</A>

I was complaining about twisted making a spare copy of an object used 
for guard credentials (meaning you can't add users on the fly).  I now 
think it stems from the pickling of objects between mktap and twistd. 
The checker is instantiated and pickled in mktap, because the guard code 
is called directly from updateApplication. But then when twistd runs, it 
is instantiated again for the rest of the app.

This makes two copies of my checker:

#!/bin/sh
kill `cat twistd.pid`
mktap2.3 upstage
twistd2.3  -f upstage.tap

and this doesn't:

#!/usr/bin/python
from upstage import app
from twisted.internet import reactor
app.updateApplication(reactor, {'webport':8083,'port':7232 })
reactor.run()


The code called in updateApplication goes a bit like this:

def updateApplication(app, options):
     docroot = website()
     app.listenTCP(webport, server.Site(docroot))

def website():
     docroot = static.File(config.HTDOCS)
     admin = adminWrapper(config.ADMIN)
     docroot.putChild('admin', admin)
     return docroot

class Checker(dict):
     __implements__ = checkers.ICredentialsChecker
     credentialInterfaces = (IUsernamePassword,)
     def requestAvatarId(self, credentials):
         player = self.get(credentials.username)
         if player and player.password == credentials.password:
             return credentials.username
         return failure.Failure(error.UnauthorizedLogin())

myCheckerThatGetsCopied = Checker({'p1': player1})

def adminWrapper(admin_dir):
     p = Portal(AdminRealm(admin_dir))
     p.registerChecker(AllowAnonymousAccess(), IAnonymous)
     p.registerChecker(myCheckerThatGetsCopied, IUsernamePassword)
     upw = guard.UsernamePasswordWrapper(p, callback=dumbRedirect)
     r = guard.SessionWrapper(upw)
     r.sessionLifetime = 12 * 3600
     return r


One workaround is wrapping the true checker in one that has no data:

class CheckerThatGetsCopiedWrapper:
     __implements__ = checkers.ICredentialsChecker
     credentialInterfaces = (credentials.IUsernamePassword,)

     def requestAvatarId(self, credentials):
         return myCheckerThatGetsCopied.requestAvatarId(credentials)


which is what I'm actually using now.  Is my diagnosis plausible?

regards,

douglas bagnall




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="039507.html">[Twisted-Python] Adding pb users online
</A></li>
	<LI>Next message (by thread): <A HREF="039511.html">[Twisted-Python] mktap/twistd make 2 copies of some objects? 	(was Re: [Twisted-web] subtle copying in woven driving me crazy.)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39509">[ date ]</a>
              <a href="thread.html#39509">[ thread ]</a>
              <a href="subject.html#39509">[ subject ]</a>
              <a href="author.html#39509">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
