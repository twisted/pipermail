<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: Where is best place to put my custom code?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Where%20is%20best%20place%20to%20put%20my%20custom%20code%3F&In-Reply-To=71D2DB39-3D92-11D8-B76A-0030656C6B9E%40webcrunchers.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006903.html">
   <LINK REL="Next"  HREF="006907.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: Where is best place to put my custom code?</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Where%20is%20best%20place%20to%20put%20my%20custom%20code%3F&In-Reply-To=71D2DB39-3D92-11D8-B76A-0030656C6B9E%40webcrunchers.com"
       TITLE="[Twisted-Python] Re: Where is best place to put my custom code?">andrew-twisted at puzzling.org
       </A><BR>
    <I>Fri Jan  2 22:20:31 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="006903.html">[Twisted-Python] Re: Where is best place to put my custom code?
</A></li>
        <LI>Next message: <A HREF="006907.html">[Twisted-Python] Re: Where is best place to put my custom code?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6904">[ date ]</a>
              <a href="thread.html#6904">[ thread ]</a>
              <a href="subject.html#6904">[ subject ]</a>
              <a href="author.html#6904">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Jan 02, 2004 at 06:13:39PM -0800, JD wrote:
&gt;<i> On Jan 1, 2004, at 6:52 PM, Andrew Bennetts wrote:
</I>&gt;<i> &gt;On Thu, Jan 01, 2004 at 11:25:37AM -0800, JD wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;do I use:    testIRC.sendLine('signedOn')  to send the command to the
</I>&gt;<i> &gt;&gt;IRC server
</I>&gt;<i> &gt;&gt;to signon?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;No.  IRCClient is a LineReceiver subclass, because that's how the 
</I>&gt;<i> &gt;low-level
</I>&gt;<i> &gt;protocol works.
</I>&gt;<i> 
</I>&gt;<i> I think I understand.   what is needed in the docs,   is a better
</I>&gt;<i> description of just what the roles of these objects are supposed to do,
</I>&gt;<i> and where we,  as users of Twisted,  would have a much better chance to
</I>&gt;<i> use Twisted in the way it is intended.    So the usage of 'sendLine' in a
</I>&gt;<i> 'lineReceiver' would be inappropriate?  but if that's true,  then how does
</I>&gt;<i> one send a command to the IRC server?
</I>
No, using sendLine in a LineReceiver is fine -- that's why LineReceiver
defines sendLine.

What isn't so good is using sendLine in an IRCClient subclass.  While
IRCClient subclasses LineReceiver, in general you should be using the
abstractions IRCClient provides to send commands to and receive responses
from the server (if you don't want to use them, then why not just use a
plain LineReceiver?).

The only reason you should have for calling sendLine in an IRCClient
subclass is to extend its functionality to support more of the protocol than
it already does.  IRCClient already has support for signing on (the
'register' method and the 'signedOn' handler), so you shouldn't use sendLine
for that.  IRCClient currently lacks some IRC features, such as WHO, so to
do those you do need sendLine.

Also, good style suggests that you probably shouldn't mix your application
code with your IRCClient extensions, i.e. subclass IRCClient for WHO support
(and other other unimplemented commands you need), and then subclass that
for your application.

&gt;<i> By the way,   I've chosen this as a simple test application,  not unlike
</I>&gt;<i> what I want to really do,   so I have chosen a relatively simple
</I>&gt;<i> application,  where I just extract all the users of a specified IRC
</I>&gt;<i> server,  and return the data.
</I>&gt;<i> 
</I>&gt;<i> I have not specified the form of the data,  that's not important,  but
</I>&gt;<i> what's important to me,  is the understand how to use Twisted in the way
</I>&gt;<i> it was intended.
</I>&gt;<i> 
</I>&gt;<i> I have this:
</I>&gt;<i> 
</I>&gt;<i> class IRC_test(irc.IRCClient):
</I>&gt;<i> 
</I>&gt;<i>     def whois_on(self):
</I>&gt;<i>     	&quot;&quot;&quot;
</I>&gt;<i>     	This method issues a 'WHO' command to see who is on the server.
</I>&gt;<i>     	&quot;&quot;&quot;
</I>&gt;<i>     	self.sendLine(&quot;WHO&quot;)
</I>&gt;<i> 
</I>&gt;<i>     def signedOn(self):
</I>&gt;<i>         &quot;&quot;&quot;Called after sucessfully signing on to the server.   So we
</I>&gt;<i>         immediately issue the 'whois_on' message to let the server go and
</I>&gt;<i>         do it's stuff.
</I>&gt;<i>         &quot;&quot;&quot;
</I>&gt;<i>         self.whois_on(self)
</I>&gt;<i> 
</I>&gt;<i>     def whois_result(self, prefix,  info):
</I>&gt;<i> 		&quot;&quot;&quot;
</I>&gt;<i> 		This is the code the IRC is somehow going to call.   Then,
</I>&gt;<i> 		after it is called,  it stores the info in the factory
</I>&gt;<i> 		and returns by calling 'reactor.stop()' to exit the 
</I>&gt;<i> 		reactor.run()
</I>&gt;<i> 		&quot;&quot;&quot;
</I>&gt;<i> 		self.result = extract_whois_data(info)
</I>&gt;<i> 		reactor.stop()
</I>
(This identation is really painful.)

&gt;<i>     def irc_RPL_WHOISSERVER(self, prefix, params):
</I>&gt;<i>     	&quot;&quot;&quot;
</I>&gt;<i>     	This was not included in the parent class IRCClient,
</I>&gt;<i>     	So I add it here.  'lineReceived' gets the
</I>&gt;<i>     	command = numeric_to_symbolic[command],  which is now
</I>&gt;<i>     	the string 'RPL_WHOISSERVER'.   To get THIS method to call,
</I>&gt;<i>     	the 'handleCommand' method first generates a key to the
</I>&gt;<i>     	class's 'attribute' dictionary,  by pre-pending 'irc_'
</I>&gt;<i>     	in front of it to get this method,  which is then called.
</I>&gt;<i>     	'params' would then have the result data.   We need to
</I>&gt;<i>     	hack around to see what form it's in.
</I>&gt;<i>     	&quot;&quot;&quot;
</I>&gt;<i>         self.whois_result(params[1])
</I>
(This identation won't even work!)

But creating a method called 'irc_RPL_WHOISSERVER' will do what you want
here.  Handler methods with a common prefix that are dispatched with a
getattr call are a common, and very nice, idiom in Twisted.

&gt;<i> def test_irc(host, port):
</I>&gt;<i> 	&quot;&quot;&quot;
</I>&gt;<i> 	This function scans a particular IRC server,  and returns a
</I>&gt;<i> 	dictionary of all the nicks and IP addresses.  Nick is the key,  the
</I>&gt;<i> 	IP or reverse dns is the value.
</I>&gt;<i> 	&quot;&quot;&quot;
</I>&gt;<i> 	my_nick = &quot;jd6969&quot;
</I>&gt;<i> 	data_dict = {}		# place where I want my IRC data
</I>&gt;<i> 	myTestFactory = IRC_test(data_dict,  my_nick)
</I>&gt;<i> 	reactor.connectTCP(host, port, myTestFactory)
</I>&gt;<i> 	reactor.run()		# I just wait for the server to respond
</I>&gt;<i> 	return data_dict	# when it does, I just want to return with the data
</I>
(Ugh, and now you're using tabs...)

IRC_test is a protocol, but you're passing it as a factory to connectTCP.
See <A HREF="http://twistedmatrix.com/documents/howto/clients.">http://twistedmatrix.com/documents/howto/clients.</A>

&gt;<i> I know this is a pretty stupid and useless application,  but this is very
</I>&gt;<i> close to what I want it to do,  without revealing anything.    I haven't
</I>&gt;<i> tested this yet,  because I just want to be sure I'm doing it right,
</I>&gt;<i> rather then to spend weeks down a particular path to nowhere.
</I>
This code is short.  Why didn't you run it yourself to get some idea of how
close it is to working?  Working code is usually a good sign that you're
close to the right path, if not already on it...

&gt;<i> &gt;However, you're not using the low-level protocol, you're
</I>&gt;<i> &gt;using an abstraction on top of it -- IRCClient.  Don't break the 
</I>&gt;<i> &gt;abstraction
</I>&gt;<i> &gt;(by calling LineReceiver's sendLine method) unless you have a good 
</I>&gt;<i> &gt;reason to
</I>&gt;<i> &gt;and you know the protocol spec well enough to know what you're doing 
</I>&gt;<i> &gt;(which
</I>&gt;<i> &gt;would be RFC 2812 in this case, I think).
</I>&gt;<i> 
</I>&gt;<i> I believe I do,  because I still have to tell the IRC server what I want
</I>&gt;<i> it to do.  And the only way I can see,  is with the sendLine command.
</I>
Only because you need to extend it to cover parts of the protocol that
aren't implemented.  You started off talking about 'signedOn', which is
already covered by IRCClient, and only later mentioned trying to do a WHO
command, which isn't.  Confusing issues like this makes it hard to figure
out what you're trying to do.

&gt;<i> &gt;As far as I'm aware, sending a line saying 'signedOn' to the server 
</I>&gt;<i> &gt;doesn't
</I>&gt;<i> &gt;make any sense in the IRC protocol, so this definitely wouldn't achieve
</I>&gt;<i> &gt;anything useful, except causing an error from the server that the 
</I>&gt;<i> &gt;IRCClient
</I>&gt;<i> &gt;instance probably won't expect (because you broke the abstraction and 
</I>&gt;<i> &gt;snuck
</I>&gt;<i> &gt;behind its back to do it).
</I>&gt;<i> 
</I>&gt;<i> Ok,   so it is clear I'm doing this wrong.  If that's the case,  then what
</I>&gt;<i> is the RIGHT way of doing it?
</I>
Calling register, of course.  Where in the RFC does it say 'signedOn' is a
recognised command?

&gt;<i> &gt;&gt;or do I:   testIRC.register('mynick', 'myhost', 'irc.debian.com')
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;That looks much saner.  And noticeably more full of information than
</I>&gt;<i> &gt;testIRC.sendLine('signedOn')...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;then,   when I want to do the &quot;who&quot; command,  would I do:
</I>&gt;<i> &gt;&gt;testIRC.sendLine('who')
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Well, I believe the WHO command requires an argument, so it would be 
</I>&gt;<i> &gt;more
</I>&gt;<i> &gt;like testIRC.sendLine('WHO ' + name)... but see my next answer.
</I>&gt;<i> 
</I>&gt;<i> hmmm - in checking the RFC it mentions I can either &quot;WHO &lt;channel&gt;&quot; or
</I>&gt;<i> &quot;WHO&quot; without specifying a channel,  in which it gets the names of ALL the
</I>&gt;<i> users of the IRC server not hidden.
</I>
Fair enough.  Believe it or not, but I actually know very very little about
IRC, I mainly figured it out for that email to you by skimming irc.py and
one or two brief google searches to confirm e.g. that 'signedOn' doesn't
appear in the RFC.

&gt;<i> &gt;The right way to do this is implemented in sandbox/exarkun/irc2.py -- 
</I>&gt;<i> &gt;see
</I>&gt;<i> &gt;the AdvancedClient.who method.  I'd follow JP's earlier suggestion and 
</I>&gt;<i> &gt;use
</I>&gt;<i> &gt;it.
</I>&gt;<i> 
</I>&gt;<i> I was NOT aware that anything in &quot;sandbox&quot; had anything to do with IRC.
</I>&gt;<i> Expecially when words like this are chosen.   One can interpret 'sandbox'
</I>&gt;<i> in many zillion ways,  so how would I even know this.
</I>
Because of a mail from earlier in the thread from JP:
    <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2004-January/006893.html">http://twistedmatrix.com/pipermail/twisted-python/2004-January/006893.html</A>

Which part of

    &quot;WHO is one of the commands I did manage to improve, but I never moved
    any of the work out of my sandbox.  You can find it in
    Twisted/sandbox/exarkun/irc2.py.&quot;

was unclear?

&gt;<i> I took a look at this,  and WOW - this might be just what I need.   I'm
</I>&gt;<i> going to have to spend a lot of time studying this.    I had no clue this
</I>&gt;<i> even existed, primarily because the name 'sandbox' really had nothing to
</I>&gt;<i> do with IRC, and I just couldn't make the connection.
</I>
Hence the email.

&gt;<i> &gt;The answer is of course none of those.  You should've already noticed 
</I>&gt;<i> &gt;that
</I>&gt;<i> &gt;IRCClient doesn't implement a who() method, so it's hardly surprising 
</I>&gt;<i> &gt;it
</I>&gt;<i> &gt;hasn't implemented a command to deal with its response.
</I>&gt;<i> 
</I>&gt;<i> yes - as it also doesn't implement a LOT of things,  and yet they are
</I>&gt;<i> defined as overrideable functions.
</I>
I don't understand what you're saying here.  You mean things like
irc_RPL_WHOISSERVER?  That's just the way the prefixed getattr idiom works;
all you need to do support a new command define a handler method for it, and
that's it.  No explicit registration or anything like that needed.  Python's
a dynamic language, and Twisted uses that to its advantage.

&gt;<i> &gt;I thought you wanted to use the WHO command not WHOIS?  Please try to 
</I>&gt;<i> &gt;be
</I>&gt;<i> &gt;precise.
</I>&gt;<i> 
</I>&gt;<i> I thought they were almost the same....  at least that's what I read in
</I>&gt;<i> the RFC's.  What is the difference?
</I>
No idea.  Again, I don't know IRC very well :)

I notice that irc2.py implements both WHO and WHOIS seperately, though, so I
figure there are some differences, which is why you saying WHO and then
later WHOIS confused me.

&gt;<i> &gt;&gt;Could I add this to my IRCClient's subclass?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;IE:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;    def irc_RPL_WHOISSERVER(self, prefix, params):
</I>&gt;<i> &gt;&gt;        self.whois(params[1])
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;If you look at irc2.py, you'll see it does override this method.  Note 
</I>&gt;<i> &gt;that
</I>&gt;<i> &gt;'whois' is a bad name for the response handler -- the existing 
</I>&gt;<i> &gt;convention in
</I>&gt;<i> &gt;IRCClient is that 'join', 'nick', etc, are the methods that *issue* the
</I>&gt;<i> &gt;command, not that handle the response.
</I>&gt;<i> 
</I>&gt;<i> I haven't seen any mention of naming conventions,  but if there is one,
</I>&gt;<i> I certainly would want to know where it is.
</I>
It's not explicitly written anywhere that I know of.  It was just obvious to
me from skimming the code of irc.py and irc2.py that that's what the
convention was, because that's what the existing code *does*.  I generally
try to follow the conventions of code I'm using to avoid getting horribly
confused.

&gt;<i> &gt;I think the biggest critical step you're missing is that you're busily
</I>&gt;<i> &gt;trying to reinvent a wheel that's already been made in
</I>&gt;<i> &gt;sandbox/exarkun/irc2.py, though.
</I>&gt;<i> 
</I>&gt;<i> that is obviously true....  I explained above why I just didn't even know
</I>&gt;<i> of it's existance until it was pointed out to me.
</I>
Yes, but it was pointed out to you before this...

-Andrew.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006903.html">[Twisted-Python] Re: Where is best place to put my custom code?
</A></li>
	<LI>Next message: <A HREF="006907.html">[Twisted-Python] Re: Where is best place to put my custom code?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6904">[ date ]</a>
              <a href="thread.html#6904">[ thread ]</a>
              <a href="subject.html#6904">[ subject ]</a>
              <a href="author.html#6904">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
