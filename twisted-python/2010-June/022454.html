<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Creating a COM object in a thread
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Creating%20a%20COM%20object%20in%20a%20thread&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022464.html">
   <LINK REL="Next"  HREF="022455.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Creating a COM object in a thread</H1>
    <B>Don Dwiggins</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Creating%20a%20COM%20object%20in%20a%20thread&In-Reply-To="
       TITLE="[Twisted-Python] Creating a COM object in a thread">ddwiggins at advpubtech.com
       </A><BR>
    <I>Mon Jun 28 20:43:14 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022464.html">[Twisted-Python] runInteraction function returning a deferred
</A></li>
        <LI>Next message: <A HREF="022455.html">[Twisted-Python] Creating a COM object in a thread
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22454">[ date ]</a>
              <a href="thread.html#22454">[ thread ]</a>
              <a href="subject.html#22454">[ subject ]</a>
              <a href="author.html#22454">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I need to create a COM object in a Windows application, and call it. 
Since the call will take some time to execute, I wrap it in a deferToThread.

I've found that, when I create the object inline, it works.  However, 
when I defer it, it hangs up in the win32com.client.Dispatch call.  I've 
tried several things, including digging into the guts of Dispatch -- the 
hangup occurs during the creation of the object.

I've discussed this with Mark Hammond, who suggests one lead:

&quot;The Windows message loop is used by the COM marshalling process.  IIRC, 
the first thread to initialize COM in a process is the thread in which 
single-threaded objects will always end up being called in.  If a 
different thread creates the object, COM uses Windows messages to 
marshall all calls back to that main thread.  IOW, your second thread 
makes a call - even to create the object - which results in that thread 
sending a windows message to the main thread to act on the request.

What this probably means in practice is that twisted needs to use a 
reactor which calls MsgWaitForMultipleObjects() and runs a message loop 
when the function detects a new message is in the queue.  I'm not sure 
if there is an existing reactor which does this.&quot;

I'm posting this on the off chance that someone else has wandered into 
this corner of Windows arcana, and has come up with something useful.

I'm about to give up on doing this &quot;inside&quot; the twisted app, and running 
it in a separate app that I'll call from the thread.

TIA,
-- 
Don Dwiggins
Advanced Publishing Technology


</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022464.html">[Twisted-Python] runInteraction function returning a deferred
</A></li>
	<LI>Next message: <A HREF="022455.html">[Twisted-Python] Creating a COM object in a thread
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22454">[ date ]</a>
              <a href="thread.html#22454">[ thread ]</a>
              <a href="subject.html#22454">[ subject ]</a>
              <a href="author.html#22454">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
