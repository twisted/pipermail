<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Creating a COM object in a thread
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Creating%20a%20COM%20object%20in%20a%20thread&In-Reply-To=%3CAANLkTimmN32VcbJG22mAYkmL5drZ-orVEeLdwtk9zIFM%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="054957.html">
   <LINK REL="Next"  HREF="054967.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Creating a COM object in a thread</H1>
    <B>Mark Wright</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Creating%20a%20COM%20object%20in%20a%20thread&In-Reply-To=%3CAANLkTimmN32VcbJG22mAYkmL5drZ-orVEeLdwtk9zIFM%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Creating a COM object in a thread">markscottwright at gmail.com
       </A><BR>
    <I>Tue Jun 29 08:01:54 MDT 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="054957.html">[Twisted-Python] Creating a COM object in a thread
</A></li>
        <LI>Next message (by thread): <A HREF="054967.html">[Twisted-Python] Creating a COM object in a thread
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54953">[ date ]</a>
              <a href="thread.html#54953">[ thread ]</a>
              <a href="subject.html#54953">[ subject ]</a>
              <a href="author.html#54953">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm sure you've already checked the simple things like this, but have
you called CoInitialize() in your thread?  If you're using the win32
extensions, it'll be called for you in the main thread, but any new
thread needs to call it before attempting to do any COM work.

On Mon, Jun 28, 2010 at 7:43 PM, Don Dwiggins &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ddwiggins at advpubtech.com</A>&gt; wrote:
&gt;<i> I need to create a COM object in a Windows application, and call it.
</I>&gt;<i> Since the call will take some time to execute, I wrap it in a deferToThread.
</I>&gt;<i>
</I>&gt;<i> I've found that, when I create the object inline, it works.  However,
</I>&gt;<i> when I defer it, it hangs up in the win32com.client.Dispatch call.  I've
</I>&gt;<i> tried several things, including digging into the guts of Dispatch -- the
</I>&gt;<i> hangup occurs during the creation of the object.
</I>&gt;<i>
</I>&gt;<i> I've discussed this with Mark Hammond, who suggests one lead:
</I>&gt;<i>
</I>&gt;<i> &quot;The Windows message loop is used by the COM marshalling process.  IIRC,
</I>&gt;<i> the first thread to initialize COM in a process is the thread in which
</I>&gt;<i> single-threaded objects will always end up being called in.  If a
</I>&gt;<i> different thread creates the object, COM uses Windows messages to
</I>&gt;<i> marshall all calls back to that main thread.  IOW, your second thread
</I>&gt;<i> makes a call - even to create the object - which results in that thread
</I>&gt;<i> sending a windows message to the main thread to act on the request.
</I>&gt;<i>
</I>&gt;<i> What this probably means in practice is that twisted needs to use a
</I>&gt;<i> reactor which calls MsgWaitForMultipleObjects() and runs a message loop
</I>&gt;<i> when the function detects a new message is in the queue.  I'm not sure
</I>&gt;<i> if there is an existing reactor which does this.&quot;
</I>&gt;<i>
</I>&gt;<i> I'm posting this on the off chance that someone else has wandered into
</I>&gt;<i> this corner of Windows arcana, and has come up with something useful.
</I>&gt;<i>
</I>&gt;<i> I'm about to give up on doing this &quot;inside&quot; the twisted app, and running
</I>&gt;<i> it in a separate app that I'll call from the thread.
</I>&gt;<i>
</I>&gt;<i> TIA,
</I>&gt;<i> --
</I>&gt;<i> Don Dwiggins
</I>&gt;<i> Advanced Publishing Technology
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>


-- 
Mark Wright
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">markscottwright at gmail.com</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="054957.html">[Twisted-Python] Creating a COM object in a thread
</A></li>
	<LI>Next message (by thread): <A HREF="054967.html">[Twisted-Python] Creating a COM object in a thread
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54953">[ date ]</a>
              <a href="thread.html#54953">[ thread ]</a>
              <a href="subject.html#54953">[ subject ]</a>
              <a href="author.html#54953">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
