<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Flow-control for Pipes / Unix Domains Sockets?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Flow-control%20for%20Pipes%20/%20Unix%20Domains%20Sockets%3F&In-Reply-To=%3C634914A010D0B943A035D226786325D44469DC5EFD%40EXVMBX020-12.exch020.serverdata.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027602.html">
   <LINK REL="Next"  HREF="027612.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Flow-control for Pipes / Unix Domains Sockets?</H1>
    <B>Tobias Oberstein</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Flow-control%20for%20Pipes%20/%20Unix%20Domains%20Sockets%3F&In-Reply-To=%3C634914A010D0B943A035D226786325D44469DC5EFD%40EXVMBX020-12.exch020.serverdata.net%3E"
       TITLE="[Twisted-Python] Flow-control for Pipes / Unix Domains Sockets?">tobias.oberstein at tavendo.de
       </A><BR>
    <I>Wed Oct 23 04:55:59 MDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027602.html">[Twisted-Python] Flow-control for Pipes / Unix Domains Sockets?
</A></li>
        <LI>Next message: <A HREF="027612.html">[Twisted-Python] Flow-control for Pipes / Unix Domains Sockets?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27609">[ date ]</a>
              <a href="thread.html#27609">[ thread ]</a>
              <a href="subject.html#27609">[ subject ]</a>
              <a href="author.html#27609">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok, I've pimped up the test

<A HREF="https://github.com/oberstet/scratchbox/blob/master/python/twisted/masterchild/streaming_master.py">https://github.com/oberstet/scratchbox/blob/master/python/twisted/masterchild/streaming_master.py</A>
<A HREF="https://github.com/oberstet/scratchbox/blob/master/python/twisted/masterchild/streaming_child.py">https://github.com/oberstet/scratchbox/blob/master/python/twisted/masterchild/streaming_child.py</A>

and running on Ubuntu LTS 12.04, 64 Bit, Core i7 3.4GHz, epoll reactor, I was able to get it up to

Master =&gt; Child : 450MB/s
[94%/100% CPU load)

Master &lt;=&gt; Child (full-duplex echo): 200MB/s
[95%/100% CPU load)

Nifty.


Now, it might be that I can push even higher by adjusting the pipe buffer sizes (there is a Linux fcntl for that .. F_SETPIPE_SZ).

Q: How do I get at the FDs of the underlying pipes to the spawned process in the parent?

reactor.spawnProcess returns an object implementing IProcessTransport
However, that does not seem to provide access to the underlying pipes (and their FDs in the parent)

Looking at
<A HREF="http://twistedmatrix.com/trac/browser/tags/releases/twisted-13.1.0/twisted/internet/process.py">http://twistedmatrix.com/trac/browser/tags/releases/twisted-13.1.0/twisted/internet/process.py</A>
I can get it, but not via official API, right?

===

Windows: It does not work at all. Tested &quot;select&quot; and &quot;iocp&quot; reactors. It just hangs doing nothing.



Von: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> [mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] Im Auftrag von Tobias Oberstein
Gesendet: Mittwoch, 23. Oktober 2013 00:58
An: Twisted discussion
Betreff: Re: [Twisted-Python] Flow-control for Pipes / Unix Domains Sockets?

Hi Itamar,

once again Twisted surprises me: it just works!

I have tested a master/child combo over pipe (both Twisted) with a push producer on the sending leg.

It can push around 70MB/s raw binary (16k write size) to the child. Load is evenly on 2 CPU cores each at 80% and stays roughly constant. Memory is flat for both.

This is on some years old Macbook (kqueue reactor .. a little faster than select) - tomorrow I repeat on a beefy system/OS.

I will do more systematic throughput and also latency measurements .. but this is already not bad at all.

Moreso: I really am curious now how that works under the hood, since the pausing/resuming seems to be upper/lower watermark controlled .. it'll resume the producer before the consumer starves. As it should be;)

Background: this is part of experiments in preparation for a multi-core capable Autobahn based message broker ..

Takeaway: Next time I don't waste time on the internet reading half-baked posts, but just hack away;)

/Tobias

PS: The following is actually slower than above master/slave pair .. which I also didn't expect:

tobias-obersteins-macbook-pro-2:masterchild oberstet$ time dd if=/dev/zero bs=1k count=1000000 | wc -c
1000000+0 records in
1000000+0 records out
1024000000 bytes transferred in 17.454178 secs (58667902 bytes/sec)
 1024000000

real    0m17.460s
user    0m18.389s
sys    0m7.729s



On 22.10.13 02:00, &quot;Itamar Turner-Trauring&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A>&gt; wrote:

On 10/21/2013 04:48 PM, Tobias Oberstein wrote:


Flow-control for Pipes / Unix Domains Sockets? Hi,

 with TCP (either remote or loopback) I can have flow-control using the producer-consumer machinery that Twisted provides.

 Is that (flow-control / producer-consumer) also available (and practically usable/recommended) with:

 a) Unix Domain sockets
 b) Pipes (spawnProcess)


 I would expect transport.registerProducer to work with both.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20131023/225fe338/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20131023/225fe338/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027602.html">[Twisted-Python] Flow-control for Pipes / Unix Domains Sockets?
</A></li>
	<LI>Next message: <A HREF="027612.html">[Twisted-Python] Flow-control for Pipes / Unix Domains Sockets?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27609">[ date ]</a>
              <a href="thread.html#27609">[ thread ]</a>
              <a href="subject.html#27609">[ subject ]</a>
              <a href="author.html#27609">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
