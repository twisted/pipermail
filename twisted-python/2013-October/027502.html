<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted linux netfilter_log protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20linux%20netfilter_log%20protocol&In-Reply-To=%3C524BCA9C.7030601%40imperial.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027501.html">
   <LINK REL="Next"  HREF="027504.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted linux netfilter_log protocol</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20linux%20netfilter_log%20protocol&In-Reply-To=%3C524BCA9C.7030601%40imperial.ac.uk%3E"
       TITLE="[Twisted-Python] twisted linux netfilter_log protocol">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Wed Oct  2 01:26:20 MDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027501.html">[Twisted-Python] twisted linux netfilter_log protocol
</A></li>
        <LI>Next message: <A HREF="027504.html">[Twisted-Python] twisted linux netfilter_log protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27502">[ date ]</a>
              <a href="thread.html#27502">[ thread ]</a>
              <a href="subject.html#27502">[ subject ]</a>
              <a href="author.html#27502">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/02/2013 07:14 AM, David Stainton wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I am wondering how I should combine various twisted interfaces
</I>&gt;<i> in a way that makes sense. It probably shows here... that I'm new to
</I>&gt;<i> twisted.
</I>&gt;<i>
</I>&gt;<i> The Linux iptables can log packets to the netfilter_log which can give
</I>&gt;<i> access to user space.
</I>&gt;<i> I wrote a simple twisted Reader (IReadDescriptor implementation) that is
</I>&gt;<i> working functional code...
</I>&gt;<i> <A HREF="https://gist.github.com/david415/6789612">https://gist.github.com/david415/6789612</A>
</I>&gt;<i>
</I>&gt;<i> But since these are packets it returns... should I implement a &quot;read
</I>&gt;<i> only Protocol&quot;?
</I>
Well, if your transport is not writable, just don't implement that - 
Exceptions will be raised if you mistakenly try to write, so nothing bad 
will happen.

&gt;<i> The protocol's dataReceive() method could be called from the
</I>&gt;<i> NFLogReader's doRead() method.
</I>
Since they're packets it should really be a DatagramProtocol and call 
datagramReceived.

&gt;<i> Does this mean that NFLogReader would be responsible for calling
</I>&gt;<i> buildProtocol to construct the NFLogProtocol?
</I>
Typically a factory is responsible for calling buildProtocol, but in 
most datagram uses, there is only one protocol instance per port, so you 
just instantiate it. See e.g.

<A HREF="http://twistedmatrix.com/documents/current/core/howto/udp.html">http://twistedmatrix.com/documents/current/core/howto/udp.html</A>

&gt;<i> In the normal Twisted examples the buildProtocol seems to be called from
</I>&gt;<i> the react loop..
</I>&gt;<i> Should I pass the protocol factory and the reader to the service?
</I>
Sorry I don't know what this means.

&gt;<i>
</I>&gt;<i> If I want to drop privileges right after retrieving the filedescriptor
</I>&gt;<i> for netfilter_log, shall I use a Twisted Service/Application to drop the
</I>&gt;<i> root privs to a non-superuser?
</I>
That would be the &quot;Twisted&quot; way of doing it, yes.

&gt;<i> Should the privileges be dropped by the privilegedStartService() method?
</I>&gt;<i> The manual says that method is for preparing to drop services...
</I>&gt;<i>
</I>&gt;<i> What I want out of all of this is the most high performance and general
</I>&gt;<i> solution to utilizing netfilter_log in twisted...
</I>
Couple of general points:

The nflog_cffi code is... hard to read. But it's not obvious to me that 
it sets the FD to nonblocking anywhere, or that it's (frankly weird) 
generator construct will actually yield the &quot;nonblock&quot; marker object at 
the right times. You might want to test this.

On a different note, a colleague wrote some code to process the IPQUEUE 
target of iptables a while back. This code did something similar to your 
example above, but it didn't bother integrating with the 
protocol/factory machinery, and you could consider whether it makes 
sense to do so - unlike a TCP or UDP port, you're unlikely to ever have 
 &gt;1 nflog &quot;connection&quot; per-process, so it's not obvious that using the 
full generality of the factory/protocol machinery is appropriate.

However if you do that, I would just copy what Twisted does for UDP; 
don't model it on TCP.

</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027501.html">[Twisted-Python] twisted linux netfilter_log protocol
</A></li>
	<LI>Next message: <A HREF="027504.html">[Twisted-Python] twisted linux netfilter_log protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27502">[ date ]</a>
              <a href="thread.html#27502">[ thread ]</a>
              <a href="subject.html#27502">[ subject ]</a>
              <a href="author.html#27502">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
