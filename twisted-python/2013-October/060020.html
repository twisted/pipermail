<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Setting source address of outgoing datagrams
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Setting%20source%20address%20of%20outgoing%20datagrams&In-Reply-To=%3CCAFUtXGz2tgg6Cf346t3c04vCYkrxZ0yRQAEhuZhXdAPN_VEkZg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Setting source address of outgoing datagrams</H1>
    <B>Maciej Wasilak</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Setting%20source%20address%20of%20outgoing%20datagrams&In-Reply-To=%3CCAFUtXGz2tgg6Cf346t3c04vCYkrxZ0yRQAEhuZhXdAPN_VEkZg%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Setting source address of outgoing datagrams">wasilak at gmail.com
       </A><BR>
    <I>Sat Oct 12 08:27:59 MDT 2013</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60020">[ date ]</a>
              <a href="thread.html#60020">[ thread ]</a>
              <a href="subject.html#60020">[ subject ]</a>
              <a href="author.html#60020">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I've got a problem when using Twisted UDP-based app with IPv6. I know UDP
IPv6 is not yet officially supported, I am using the unoffcial hack found
somewhere on the net.

----------------UNOFFICIAL HACK----------------------
In twisted/internet/udp.py:

(...)
    def __init__(self, port, proto, interface='', maxPacketSize=8192,
reactor=None):
        &quot;&quot;&quot;
        Initialize with a numeric port to listen on.
        &quot;&quot;&quot;
        base.BasePort.__init__(self, reactor)
        self.port = port
        self.protocol = proto
        self.maxPacketSize = maxPacketSize
        self.interface = interface
        self.setLogStr()
        self._connectedAddr = None
+       if interface and abstract.isIPv6Address(interface): ###
+          self.addressFamily = socket.AF_INET6 ###

(...)
    def doRead(self):
        &quot;&quot;&quot;
        Called when my socket is ready for reading.
        &quot;&quot;&quot;
        read = 0
        while read &lt; self.maxThroughput:
            try:
                data, addr = self.socket.recvfrom(self.maxPacketSize)
            except socket.error as se:
                no = se.args[0]
                if no in _sockErrReadIgnore:
                    return
                if no in _sockErrReadRefuse:
                    if self._connectedAddr:
                        self.protocol.connectionRefused()
                    return
                raise
            else:
                read += len(data)
                try:
+                 addr = (addr[0], addr[1]) ###
                    self.protocol.datagramReceived(data, addr)
                except:
                    log.err()
--------------END OF UNOFFICIAL HACK------------------------

I deploy my protocol like that:

reactor.listenUDP(5683, myapp.MyProtocol(), interface=&quot;::&quot;)
reactor.run()

The problem is:
1. My server receives a request from remote client (with destination
address being valid global IPv6 address)
2. The server sends a response, but uses different source address (which is
also valid and assigned to local wlan0 interface).
3. Remote host drops the response (destination address of the request and
source address of the response do not match).

It is common for IPv6 interfaces to have multiple global IPv6 addresses -
because of privacy reasons (both on Windows and Linux).

My question is - can I read manually the destination address from the
incoming request datagram, and set it as a source address manually in the
outgoing response datagram?

Best Regards
Maciej Wasilak
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20131012/c623f869/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60020">[ date ]</a>
              <a href="thread.html#60020">[ thread ]</a>
              <a href="subject.html#60020">[ subject ]</a>
              <a href="author.html#60020">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
