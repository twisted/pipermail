<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Bytes vs unicode in twisted.python.logfile's python3 porting
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Bytes%20vs%20unicode%20in%20twisted.python.logfile%27s%0A%20python3%20porting&In-Reply-To=%3C20131027011900.8627.1582817547.divmod.xquotient.144%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027650.html">
   <LINK REL="Next"  HREF="027653.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Bytes vs unicode in twisted.python.logfile's python3 porting</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Bytes%20vs%20unicode%20in%20twisted.python.logfile%27s%0A%20python3%20porting&In-Reply-To=%3C20131027011900.8627.1582817547.divmod.xquotient.144%40top%3E"
       TITLE="[Twisted-Python] Bytes vs unicode in twisted.python.logfile's python3 porting">exarkun at twistedmatrix.com
       </A><BR>
    <I>Sat Oct 26 19:19:00 MDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027650.html">[Twisted-Python] Bytes vs unicode in twisted.python.logfile's	python3 porting
</A></li>
        <LI>Next message: <A HREF="027653.html">[Twisted-Python] Bytes vs unicode in twisted.python.logfile's python3 porting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27651">[ date ]</a>
              <a href="thread.html#27651">[ thread ]</a>
              <a href="subject.html#27651">[ subject ]</a>
              <a href="author.html#27651">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26 Oct, 09:49 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">_ at lvh.io</A> wrote:
&gt;<i>Hi everyone,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>I'm working on #6749 for porting t.p.logfile to python3. I'm dealing 
</I>&gt;<i>with
</I>&gt;<i>some test failures, which you can see from the buildbot here:
</I>&gt;<i>
</I>&gt;<i><A HREF="http://buildbot.twistedmatrix.com/builders/python-3.3-tests/builds/1602/steps/shell/logs/stdio">http://buildbot.twistedmatrix.com/builders/python-3.3-tests/builds/1602/steps/shell/logs/stdio</A>
</I>&gt;<i>
</I>&gt;<i>I have pasted the relevant bit into a gist here:
</I>&gt;<i>
</I>&gt;<i><A HREF="https://gist.github.com/lvh/7174766">https://gist.github.com/lvh/7174766</A>
</I>&gt;<i>
</I>&gt;<i>I think what's happening is that LogFile.write should take native 
</I>&gt;<i>strings
</I>&gt;<i>(since that's what log.msg takes). However, I'm opening all files in 
</I>&gt;<i>binary
</I>&gt;<i>mode, since that's on the reviewer checklist (point 8) for the Python 3
</I>&gt;<i>porting plan.
</I>
Argh.  I was all set up to object to the &quot;...should take native strings&quot; 
bit but then I reviewed some history.

If you haven't already, read 
&lt;<A HREF="https://twistedmatrix.com/trac/ticket/5932">https://twistedmatrix.com/trac/ticket/5932</A>&gt;.  In hindsight, it would 
have been nice if this branch had come with documentation of some kind.

 From what I can tell, this means:

  1. yep, `log.msg` takes native strings
  2. LogPublisher doesn't do anything with encoding or decoding
  3. a log observer can choose to do whatever it wants with what it gets
     (but it should be prepared to handle bytes on python 2 and unicode 
on python 3)

So... invent some policy.  What encoding does Twisted's built-in file 
log observer use for the files it writes?  Up until now the answer has 
been ASCII because it doesn't try to handle unicode so anything non- 
ASCII results in exceptions (unless you're using PyGTK... let's not go 
there).

UTF-8 is obviously the only possible correct answer, I guess.  This 
needs to be documented, of course.

And I predict that next someone will come along with a feature request 
for a command-line option to twistd to make it write logs with a 
different encoding. :(

Whether you open the file in binary mode or not is up to you in this 
case, I think.  You could do that and handle the encoding yourself or 
you could open it in text mode with the right encoding and let it handle 
the encoding.

The blanket statement on 
<A HREF="https://twistedmatrix.com/trac/wiki/Plan/Python3">https://twistedmatrix.com/trac/wiki/Plan/Python3</A> about open calls is 
perhaps slightly too general.  It seems like that should apply to cases 
where the behavior is not supposed to be changing - which should be the 
case for the majority of porting work.  However, `log.msg` has already 
changed behavior as part of the port.

*Or*, it now occurs to me, just stick with the ASCII-only policy that's 
already in place.  I'd even say this is more correct since porting isn't 
supposed to change behavior.  Leave support for some other codec for 
another ticket (perhaps #989).  Apart from being simpler (I hope) and 
avoiding breaching the documented porting guidelines, this also means 
someone will actually have to think about unicode support on Python 2 as 
well.  Saying we support unicode in the logging system is a lot better 
than saying we support unicode in the logging system on Python 3 only.

Jean-Paul

</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027650.html">[Twisted-Python] Bytes vs unicode in twisted.python.logfile's	python3 porting
</A></li>
	<LI>Next message: <A HREF="027653.html">[Twisted-Python] Bytes vs unicode in twisted.python.logfile's python3 porting
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27651">[ date ]</a>
              <a href="thread.html#27651">[ thread ]</a>
              <a href="subject.html#27651">[ subject ]</a>
              <a href="author.html#27651">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
