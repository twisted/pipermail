<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted linux netfilter_log protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20linux%20netfilter_log%20protocol&In-Reply-To=%3CCAFN1edoOEygbByRZ1WW%2BtCS%3Dhf8wceYK-FGmL%2Bmyu%3DSS3A1jpA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="059963.html">
   <LINK REL="Next"  HREF="059966.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted linux netfilter_log protocol</H1>
    <B>David Stainton</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20linux%20netfilter_log%20protocol&In-Reply-To=%3CCAFN1edoOEygbByRZ1WW%2BtCS%3Dhf8wceYK-FGmL%2Bmyu%3DSS3A1jpA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] twisted linux netfilter_log protocol">dstainton415 at gmail.com
       </A><BR>
    <I>Wed Oct  2 02:25:26 MDT 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="059963.html">[Twisted-Python] twisted linux netfilter_log protocol
</A></li>
        <LI>Next message (by thread): <A HREF="059966.html">[Twisted-Python] twisted linux netfilter_log protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59965">[ date ]</a>
              <a href="thread.html#59965">[ thread ]</a>
              <a href="subject.html#59965">[ subject ]</a>
              <a href="author.html#59965">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In examples of Twisted UDP clients they all do this:

reactor.listenUDP(3000, MyProtocol())

What would I do instead?
reactor.addReader makes sense to me since what I have is a file descriptor,
and the reactor loop and use select or epoll find out when there is data to
read...
and call our doRead() method of the Reader.

I don't know about implementing this as a Protocol because I do not have any
equivalent to ReactorUDP. ReactorUDP's listenUDP returns a ListeningPort.
And I'm not sure how a Transport is related to my Reader... but it seems to
me
that there is some abstraction which sets callbacks for io and also calls
buildProtocol...

Would a NFLogProtocol and factory like this be usable?
Sorta like this?
<A HREF="https://gist.github.com/david415/6790543">https://gist.github.com/david415/6790543</A>

If I am going to be using a Twisted Service to drop privileges after
gaining access to the fd...
How would I do this? Would I have startService() instantiate a Protocol
instance?

I don't know about the nflog file descriptor...
but the nflog generator interface is non-blocking if used like this:

    def doRead(self):
        pkt = self.nflog.next()
        while True:
            self.handlePacket(pkt)
            pkt = self.nflog.send(True)
            if pkt is NFWouldBlock: break

My nflog reader seems to work great.


On Wed, Oct 2, 2013 at 12:26 AM, Phil Mayers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">p.mayers at imperial.ac.uk</A>&gt;wrote:

&gt;<i> On 10/02/2013 07:14 AM, David Stainton wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am wondering how I should combine various twisted interfaces
</I>&gt;&gt;<i> in a way that makes sense. It probably shows here... that I'm new to
</I>&gt;&gt;<i> twisted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The Linux iptables can log packets to the netfilter_log which can give
</I>&gt;&gt;<i> access to user space.
</I>&gt;&gt;<i> I wrote a simple twisted Reader (IReadDescriptor implementation) that is
</I>&gt;&gt;<i> working functional code...
</I>&gt;&gt;<i> <A HREF="https://gist.github.com/**david415/6789612&lt;https://gist.github.com/david415/6789612">https://gist.github.com/**david415/6789612&lt;https://gist.github.com/david415/6789612</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But since these are packets it returns... should I implement a &quot;read
</I>&gt;&gt;<i> only Protocol&quot;?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Well, if your transport is not writable, just don't implement that -
</I>&gt;<i> Exceptions will be raised if you mistakenly try to write, so nothing bad
</I>&gt;<i> will happen.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  The protocol's dataReceive() method could be called from the
</I>&gt;&gt;<i> NFLogReader's doRead() method.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Since they're packets it should really be a DatagramProtocol and call
</I>&gt;<i> datagramReceived.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Does this mean that NFLogReader would be responsible for calling
</I>&gt;&gt;<i> buildProtocol to construct the NFLogProtocol?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Typically a factory is responsible for calling buildProtocol, but in most
</I>&gt;<i> datagram uses, there is only one protocol instance per port, so you just
</I>&gt;<i> instantiate it. See e.g.
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/**documents/current/core/howto/**udp.html&lt;http://twistedmatrix.com/documents/current/core/howto/udp.html">http://twistedmatrix.com/**documents/current/core/howto/**udp.html&lt;http://twistedmatrix.com/documents/current/core/howto/udp.html</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  In the normal Twisted examples the buildProtocol seems to be called from
</I>&gt;&gt;<i> the react loop..
</I>&gt;&gt;<i> Should I pass the protocol factory and the reader to the service?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Sorry I don't know what this means.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> If I want to drop privileges right after retrieving the filedescriptor
</I>&gt;&gt;<i> for netfilter_log, shall I use a Twisted Service/Application to drop the
</I>&gt;&gt;<i> root privs to a non-superuser?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That would be the &quot;Twisted&quot; way of doing it, yes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  Should the privileges be dropped by the privilegedStartService() method?
</I>&gt;&gt;<i> The manual says that method is for preparing to drop services...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What I want out of all of this is the most high performance and general
</I>&gt;&gt;<i> solution to utilizing netfilter_log in twisted...
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Couple of general points:
</I>&gt;<i>
</I>&gt;<i> The nflog_cffi code is... hard to read. But it's not obvious to me that it
</I>&gt;<i> sets the FD to nonblocking anywhere, or that it's (frankly weird) generator
</I>&gt;<i> construct will actually yield the &quot;nonblock&quot; marker object at the right
</I>&gt;<i> times. You might want to test this.
</I>&gt;<i>
</I>&gt;<i> On a different note, a colleague wrote some code to process the IPQUEUE
</I>&gt;<i> target of iptables a while back. This code did something similar to your
</I>&gt;<i> example above, but it didn't bother integrating with the protocol/factory
</I>&gt;<i> machinery, and you could consider whether it makes sense to do so - unlike
</I>&gt;<i> a TCP or UDP port, you're unlikely to ever have &gt;1 nflog &quot;connection&quot;
</I>&gt;<i> per-process, so it's not obvious that using the full generality of the
</I>&gt;<i> factory/protocol machinery is appropriate.
</I>&gt;<i>
</I>&gt;<i> However if you do that, I would just copy what Twisted does for UDP; don't
</I>&gt;<i> model it on TCP.
</I>&gt;<i>
</I>&gt;<i> ______________________________**_________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.</A>**com &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>&gt;
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-**bin/mailman/listinfo/twisted-**python&lt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-**bin/mailman/listinfo/twisted-**python&lt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>&gt;
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20131002/d93e31d8/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="059963.html">[Twisted-Python] twisted linux netfilter_log protocol
</A></li>
	<LI>Next message (by thread): <A HREF="059966.html">[Twisted-Python] twisted linux netfilter_log protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59965">[ date ]</a>
              <a href="thread.html#59965">[ thread ]</a>
              <a href="subject.html#59965">[ subject ]</a>
              <a href="author.html#59965">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
