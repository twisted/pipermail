<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] epoll keep sharing state between process even after fork.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20epoll%20keep%20sharing%20state%20between%20process%20even%0A%20after%20fork.&In-Reply-To=%3C20131024120746.8627.1193742102.divmod.xquotient.98%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="060101.html">
   <LINK REL="Next"  HREF="060105.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] epoll keep sharing state between process even after fork.</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20epoll%20keep%20sharing%20state%20between%20process%20even%0A%20after%20fork.&In-Reply-To=%3C20131024120746.8627.1193742102.divmod.xquotient.98%40top%3E"
       TITLE="[Twisted-Python] epoll keep sharing state between process even after fork.">exarkun at twistedmatrix.com
       </A><BR>
    <I>Thu Oct 24 06:07:46 MDT 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="060101.html">[Twisted-Python] epoll keep sharing state between process even after fork.
</A></li>
        <LI>Next message (by thread): <A HREF="060105.html">[Twisted-Python] epoll keep sharing state between process even after fork.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60103">[ date ]</a>
              <a href="thread.html#60103">[ thread ]</a>
              <a href="subject.html#60103">[ subject ]</a>
              <a href="author.html#60103">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11:19 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A> wrote:
&gt;<i>On 10/23/2013 12:50 PM, Phil Mayers wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>This is a multiprocessing bug IMHO.
</I>&gt;<i>
</I>&gt;<i>This issue with multiprocessing appears in other places too. E.g. if 
</I>&gt;<i>you're using stdlib logging, child processes will try to rotate the 
</I>&gt;<i>parent process logs.
</I>&gt;<i>
</I>&gt;<i>Basically multiprocessing on Unix is utterly broken and should never be 
</I>&gt;<i>used (except in the fork+exec form in Python 3.4).
</I>
To expand on that just a bit, the form of sharing that you get when you 
fork() but you don't exec() is very difficult to use correctly (I think 
it's an open question whether it's *possible* to use correctly in a 
Python program).

The argument here is similar to the argument against shared-everything 
multithreading.  While memory (and some other per-process state) is no 
longer shared after fork(), *some* per-process state is still shared. 
And all of the state that isn't shared is still a potential source of 
bugs since it's almost certainly the case that none of it cooperated 
with the fork() call - a call which happened at some arbitrary time and 
captured a snapshot of all the state in memory at an arbitrary point.

Consider a simple implementation of a lock file, used to prevent 
multiple instances of a program from starting.  There are several ways 
fork() could break such code.  Perhaps it is partway through acquiring a 
lock on the lock file when the fork() occurs.  Perhaps the result is 
that the file ends up locked but no process thinks it is holding the 
lock.  Now no instances of the program are running.  Or perhaps the lock 
is held when fork() happens and the problem only surfaces at unlock 
time.  Perhaps one of the processes exits and releases the lock.  Now 
the program is still running but the lock isn't held.

And that's just one of the simplest possible examples of how things can 
go wrong.

The nearly uncountable different ways for failures to creep in and the 
resulting impracticality (if not impossibility) of being able to test 
that Twisted (or any Python library) actually works when fork() is used 
means that it's not likely Twisted will ever be declared compatible with 
any fork()-without-exec() usage.

You can find some examples of Twisted-using applications that run 
multiple processes, though.  Apple CalendarServer does it by passing 
file descriptors to worker processes and sends them the location of a 
configuration file describing how they should behave.  Divmod Mantissa 
does it by inserting self-describing work into a SQLite3 database.  When 
the worker process finds one of these, it knows what code to load and 
run by looking at the fields in the row.  These are variations on a 
theme - RPC, not shared (or duplicated) memory.

Hope this helps,
Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="060101.html">[Twisted-Python] epoll keep sharing state between process even after fork.
</A></li>
	<LI>Next message (by thread): <A HREF="060105.html">[Twisted-Python] epoll keep sharing state between process even after fork.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60103">[ date ]</a>
              <a href="thread.html#60103">[ thread ]</a>
              <a href="subject.html#60103">[ subject ]</a>
              <a href="author.html#60103">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
