<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] doPoll timeout problems
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20doPoll%20timeout%20problems&In-Reply-To=%3C3532952.vhGpKmxsgq%40barry-scott-desktop%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] doPoll timeout problems</H1>
    <B>Scott, Barry</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20doPoll%20timeout%20problems&In-Reply-To=%3C3532952.vhGpKmxsgq%40barry-scott-desktop%3E"
       TITLE="[Twisted-Python] doPoll timeout problems">barry.scott at forcepoint.com
       </A><BR>
    <I>Tue Oct  2 04:42:11 MDT 2018</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64533">[ date ]</a>
              <a href="thread.html#64533">[ thread ]</a>
              <a href="subject.html#64533">[ subject ]</a>
              <a href="author.html#64533">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We are seeing a problem with poll being called very often and think that the 
problem is in the timeout calculation.

The code look like this:

    def doPoll(self, timeout):
        &quot;&quot;&quot;Poll the poller for new events.&quot;&quot;&quot;
        if timeout is not None:
            timeout = int(timeout * 1000) # convert seconds to milliseconds

What this does is round down the timeout.

We are experimenting with this:

    def doPoll(self, timeout):
        &quot;&quot;&quot;Poll the poller for new events.&quot;&quot;&quot;
        if timeout is not None:
            timeout = int(math.ceil(timeout * 1000)) # convert seconds to 
milliseconds

This rounds up the timeout.

With this we see that the poll() is called far less often.

The reason being that if the timeout is 0.0009 the code uses 0ms timeout.
And if your CPU is fast enough it will do many 0ms timeout calls to poll 
before the timer is removed from the _pendingTimedCalls list.

And if the timeout is 0.0019 the time is 1ms and when the _pendingTimedCalls
is check its first element has not expired yet. So keep doing calls with 1ms.

Typically we see that the first element in the _pendingTimedCalls is a call to 
_updateLogDateTime in HTTPFactory. We use a HTTPFactory many times and also 
NevowSite. That causes a callLater for _updateLogDateTime for each factory.

These _updateLogDateTime call seems to be a lot of complexity for no benefit. 
After all time.time() is very fast on Linux, why cache the log time strings? 
Especially when in our app we never write an access log file. 

We are working on stubbing out all that code for our app to bring our 
performance back up compared to old twisted 2.0.

Barry




</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64533">[ date ]</a>
              <a href="thread.html#64533">[ thread ]</a>
              <a href="subject.html#64533">[ subject ]</a>
              <a href="author.html#64533">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
