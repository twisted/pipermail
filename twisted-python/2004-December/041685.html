<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] M2Crypto+Twisted, part 2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20M2Crypto%2BTwisted%2C%20part%202&In-Reply-To=%3C41B65D0C.9080705%40osafoundation.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="041684.html">
   <LINK REL="Next"  HREF="041692.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] M2Crypto+Twisted, part 2</H1>
    <B>Heikki Toivonen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20M2Crypto%2BTwisted%2C%20part%202&In-Reply-To=%3C41B65D0C.9080705%40osafoundation.org%3E"
       TITLE="[Twisted-Python] M2Crypto+Twisted, part 2">heikki at osafoundation.org
       </A><BR>
    <I>Tue Dec  7 18:46:52 MST 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="041684.html">[Twisted-Python] concurrent terminals and telnet
</A></li>
        <LI>Next message (by thread): <A HREF="041692.html">[Twisted-Python] M2Crypto+Twisted, part 2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41685">[ date ]</a>
              <a href="thread.html#41685">[ thread ]</a>
              <a href="subject.html#41685">[ subject ]</a>
              <a href="author.html#41685">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A while back I integrated M2Crypto into Twisted, but the architecture 
was not deemed good then (it was adding more of the SSL cruft in tcp.py 
etc.).

James Knight pointed me to TLS Lite, which had achieved similar 
functionality by using ProtocolWrapper and WrappingFactory and all the 
code was outside of Twisted. (Thanks James!)

I've now got an implementation of M2Crypto + Twisted integration using 
the TLS Lite approach - no changes in Twisted required. (Client only for 
now and not yet fully cleaned up, but all the important pieces should be 
there.)

However, I've run into some problems and I am not sure if they are bugs 
in Twisted or if I am using these interfaces wrong. Maybe you can help.

The most interesting piece of the code is my TLSProtocolWrapper that 
inherits from ProtocolWrapper. See 
<A HREF="http://lxr.osafoundation.org/source/internal/m2crypto/M2Crypto/SSL/TwistedProtocolWrapper.py">http://lxr.osafoundation.org/source/internal/m2crypto/M2Crypto/SSL/TwistedProtocolWrapper.py</A>

Now, this seems to works perfectly with the echoclient samples when the 
SSL connection has no errors.

When there is an error in the SSL connection, and I call 
connectionLost(), I end up with a traceback that feels like it might be 
a Twisted bug. Or if I am not allowed to call that, how do I signal that 
I want to break the connection? Here's the traceback:

Traceback (most recent call last):
   File &quot;twisted_ssl/real.py&quot;, line 71, in main
     reactor.run()
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\intern
et\default.py&quot;, line 123, in run
     self.mainLoop()
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\intern
et\default.py&quot;, line 134, in mainLoop
     self.doIteration(t)
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\intern
et\default.py&quot;, line 529, in doSelect
     _logrun(selectable, _drdw, selectable, method, dict)
--- &lt;exception caught here&gt; ---
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\python
\log.py&quot;, line 65, in callWithLogger
     return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\python
\log.py&quot;, line 52, in callWithContext
     return context.call({ILogContext: newCtx}, func, *args, **kw)
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\python
\context.py&quot;, line 43, in callWithContext
     return func(*args,**kw)
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\intern
et\default.py&quot;, line 552, in _doReadOrWrite
     selectable.connectionLost(f)
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\intern
et\tcp.py&quot;, line 452, in connectionLost
     Connection.connectionLost(self, reason)
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\intern
et\tcp.py&quot;, line 295, in connectionLost
     protocol.connectionLost(reason)
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\M2Crypto\SSL\T
wistedProtocolWrapper.py&quot;, line 207, in connectionLost
     ProtocolWrapper.connectionLost(self, reason)
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\protoc
ols\policies.py&quot;, line 88, in connectionLost
     self.factory.unregisterProtocol(self)
   File 
&quot;c:\builds\chandler\chandler\release\bin\lib\site-packages\twisted\protoc
ols\policies.py&quot;, line 127, in unregisterProtocol
     del self.protocols[p]
exceptions.KeyError: &lt;twisted.internet.tcp.Client to 
('www.verisign.com', 443) a
t 10fa800&gt;


When I try to hook this up into an IMAP4 client, it seems like my 
wrapper is getting bypassed somewhere. With debug on, I see:

MyProtocolWrapper.__init__
MyProtocolWrapper.makeConnection
MyProtocolWrapper.connectionMade

then nothing, until the connection finally times out. I haven't looked 
much into this one yet. Any guesses as to where I should be looking at? 
Or is it not possible to use the ProtocolWrapper here?

I can upload full source packages as well if anyone needs them.

-- 
   Heikki Toivonen


-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 249 bytes
Desc: OpenPGP digital signature
URL: &lt;/pipermail/twisted-python/attachments/20041207/d4c3545a/attachment.sig&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="041684.html">[Twisted-Python] concurrent terminals and telnet
</A></li>
	<LI>Next message (by thread): <A HREF="041692.html">[Twisted-Python] M2Crypto+Twisted, part 2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41685">[ date ]</a>
              <a href="thread.html#41685">[ thread ]</a>
              <a href="subject.html#41685">[ subject ]</a>
              <a href="author.html#41685">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
