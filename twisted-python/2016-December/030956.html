<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20ITransport.write%20after%0A%20IProtocol.connectionLost%20--%20no%20failure/exception%3F&In-Reply-To=%3C55DA0155-4365-4D25-B915-145BE1583440%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030955.html">
   <LINK REL="Next"  HREF="030961.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20ITransport.write%20after%0A%20IProtocol.connectionLost%20--%20no%20failure/exception%3F&In-Reply-To=%3C55DA0155-4365-4D25-B915-145BE1583440%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?">glyph at twistedmatrix.com
       </A><BR>
    <I>Sat Dec 17 16:18:54 MST 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="030955.html">[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?
</A></li>
        <LI>Next message: <A HREF="030961.html">[Twisted-Python] ITransport.write after	IProtocol.connectionLost -- no failure/exception?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30956">[ date ]</a>
              <a href="thread.html#30956">[ thread ]</a>
              <a href="subject.html#30956">[ subject ]</a>
              <a href="author.html#30956">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Dec 17, 2016, at 6:11 AM, exvito here &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ex.vitorino at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On Fri, Dec 16, 2016 at 8:27 PM, Glyph Lefkowitz
</I>&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On Dec 16, 2016, at 5:22 AM, Cory Benfield &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">cory at lukasa.co.uk</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> On 15 Dec 2016, at 12:07, exvito here &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ex.vitorino at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Dear all,
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> The subject says most of it. While diagnosing a behavior on a somewhat
</I>&gt;&gt;&gt;&gt;<i> large codebase, I found out something somewhat surprising -- see
</I>&gt;&gt;&gt;&gt;<i> subject -- which is replicated with the minimal code example below.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> It is a LineReceiver client that:
</I>&gt;&gt;&gt;&gt;<i> 1. Connects to 127.0.0.1:10000.
</I>&gt;&gt;&gt;&gt;<i> 2. Sends a line of text.
</I>&gt;&gt;&gt;&gt;<i> 3. Disconnects one second later.
</I>&gt;&gt;&gt;&gt;<i> 4. Tries to send another line of text, one second after disconnection.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> I expected step 4 to fail somehow, given that Twisted promptly
</I>&gt;&gt;&gt;&gt;<i> detected that the connection closed and IProtocol.connectionLost was
</I>&gt;&gt;&gt;&gt;<i> called, as documented. Nevertheless, it does not fail.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I can&#8217;t speak for the design of Twisted, but this is definitely an intended implementation behaviour: because twisted&#8217;s write method is non-blocking, it is generally nicer to avoid write exploding in your face when disconnected.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I can! The main design feature of this approach is that if you have a loop like this:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> for x in messages:
</I>&gt;&gt;<i>    self.transport.write(self.encode(x))
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> you should not have to write it to be:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> for x in messages:
</I>&gt;&gt;<i>    if self._flagISetInConnectionLost:
</I>&gt;&gt;<i>        break
</I>&gt;&gt;<i>    self.transport.write(self.encode(x))
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> just to avoid seeing tracebacks in your logs.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> If you care about the disconnection event, implement connectionLost to do the thing that needs to be done (in this case, stop your LoopingCall).  That's what that callback is there for!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thanks for your input Cory and Glyph.
</I>&gt;<i> 
</I>&gt;<i> I do agree that a well written protocol should not
</I>&gt;<i> self.transport.write after connectionLost -- it does not make any kind
</I>&gt;<i> of sense to do that. It's just that the one I was debugging was doing
</I>&gt;<i> it in its app-level keep alive messages triggered by
</I>&gt;<i> IReactorTime.callLater which wasn't properly cancelled on
</I>&gt;<i> connectionLost. This, in turn, lead to unpexpected app-level keep
</I>&gt;<i> alive timeouts after disconnection which, while acceptable (depending
</I>&gt;<i> on app/protocol design), were having a negative impact on the overall
</I>&gt;<i> connection/protocol teardown and cleanup.
</I>&gt;<i> 
</I>&gt;<i> Having said this, the fact that self.transport.write does not complain
</I>&gt;<i> after connectionLost just made my analysis and debugging more
</I>&gt;<i> difficult (yes, I was aware that it is non-blocking -- thanks Cory --
</I>&gt;<i> and that when talking to the network the only confirmation of delivery
</I>&gt;<i> must be obtained from a received message stating that fact).
</I>&gt;<i> 
</I>&gt;<i> All in all, I was just looking for confirmation from a conceptual /
</I>&gt;<i> design standpoint. That was my purpose and it is now clear. Thanks.
</I>&gt;<i> 
</I>&gt;<i> Going a little bit further, in this context, I wonder if my
</I>&gt;<i> understanding of the Protocol / Transport objects lifecycle is 100%
</I>&gt;<i> clear. I think there is a one to one relationship in the sense that,
</I>&gt;<i> simply put, on an incoming connection the underlying machinery
</I>&gt;<i> instantiates a Protocol via the Factory's buildProtocol method,
</I>&gt;<i> instantiates a Transport object and then calls Protocol.makeConnection
</I>&gt;<i> to &quot;attach&quot; the transport to the protocol; when the connection is
</I>&gt;<i> closed, the Transport calls connectionLost on the Protocol and, at
</I>&gt;<i> some point, those two objects are no longer &quot;usable&quot; -- they've done
</I>&gt;<i> their job and will be destroyed if no app level references are kept to
</I>&gt;<i> them.
</I>
They're not &quot;destroyed&quot;, exactly.

The way to think about this is that the reactor, while running, is always on the stack.  The stack is the root of what's currently 'active' in the garbage collector.  The reactor then has references to various things - in this case, TCP transports and timed DelayedCall objects.  The transport has a reference to the protocol, which is what keeps both of them &quot;usable&quot;.  The DelayedCall has a reference to your function, and your function to anything it needs to do its work.

Things can be removed from and added back to the reactor at any time - for example, a transport may be removed without being closed by calling .stopReading() and .stopWriting() on it.  If it gets garbage collected, its socket will be closed, but because the reactor didn't close it, you won't get a normal connectionLost notification.

So rather than thinking of a Transport as having a precisely-defined lifecycle - although it does have certain states it goes through; connecting/connected/disconnecting/disconnected - the best way to think about it is as a graph of objects that the reactor is doing stuff to.

&gt;<i> If this is correct, in particular the fact that a given Transport
</I>&gt;<i> instance is not reusable after disconnection (if it is, could you
</I>&gt;<i> please point out such a case?), wouldn't it be valuable to log a
</I>&gt;<i> warning when write after disconnect is called? (agreed, raising an
</I>&gt;<i> Exception would be too much and break compatiblity). I find two
</I>&gt;<i> reasons for that: on one hand, given that it would have made my
</I>&gt;<i> debugging easier, it may help other developers pin point such cases;
</I>&gt;<i> on the other, the fact that Twisted itself logs messages on several
</I>&gt;<i> occasions, such as, for example, the default noisy Factory on doStart
</I>&gt;<i> / doStop. Adding to that, the fact that, if I'm reading the code
</I>&gt;<i> correctly, ITransport.write just throws away the data for TCP
</I>&gt;<i> transports since it falls back to FileDescriptor.write that simply
</I>&gt;<i> returns if &quot;not self.connected or self._writeDisconnected&quot; in
</I>&gt;<i> src/twisted/internet/abstract.py.
</I>
If you start logging a warning when write is called on a closed transport, then that means any code that wants to be warnings-clean needs to check to see if the transport is writable before writing to it.  This adds a lot of complexity to that sort of message-formatting code, and potentially makes it less efficient. After all, if you have to check each write() call, that will strongly encourage you to make your message-formatting happen entirely in memory, so you always have a big string that represents the whole message, just in case a transport.write() in the middle would encounter an error.

More importantly, when users start seeing a warning like this, they often develop an incorrect intuition about what's going on with the bytes; one of the _most_ frequently asked questions about how to write Twisted protocols is &quot;how do I tell if my bytes got to the other end without sending an application-level acknowledgement&quot;.  The answer, of course, is &quot;that's impossible&quot; but if users see that sometimes it warns them when the connection's closed, it reinforces the idea that there must be a way.

If you call .write, there is always the possibility that the connection _looks_ open to Twisted, but in fact is closed on the wire, and those bytes will be lost.  So it's important to me that we behave the same way in both cases.

That said, it's not like there's no room for improvement here!  The solution _I'd_ really like to see for this problem is improved visualization of what the reactor is doing.  Something that drew a graph of the reactor, and open connections, and pending timed calls would allow you to instantly see that your timed call was not connected to an active connection, and correct your code.

&gt;<i> Thoughts? (or corrections, of course?)
</I>&gt;<i> 
</I>&gt;<i> Again, thanks for your time and input.
</I>&gt;<i> Regards,
</I>&gt;<i> 
</I>&gt;<i> PS: I don't mean to start a huge discussion on the topic or question
</I>&gt;<i> the current design. It is very nice as it is, thank you! I'm just
</I>&gt;<i> looking for improving my understanding and, humbly, contributing back.
</I>

Don't worry, the design is pretty fixed - and if you managed to provoke such a discussion, then maybe it does need to change!  But I doubt it :)

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20161217/06753011/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20161217/06753011/attachment-0001.html</A>&gt;
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030955.html">[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?
</A></li>
	<LI>Next message: <A HREF="030961.html">[Twisted-Python] ITransport.write after	IProtocol.connectionLost -- no failure/exception?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30956">[ date ]</a>
              <a href="thread.html#30956">[ thread ]</a>
              <a href="subject.html#30956">[ subject ]</a>
              <a href="author.html#30956">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
