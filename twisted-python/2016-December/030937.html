<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] memory leaks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20memory%20leaks&In-Reply-To=%3C3744C3D1-5932-4C27-ABB3-17AF8B908364%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030936.html">
   <LINK REL="Next"  HREF="030938.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] memory leaks</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20memory%20leaks&In-Reply-To=%3C3744C3D1-5932-4C27-ABB3-17AF8B908364%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] memory leaks">glyph at twistedmatrix.com
       </A><BR>
    <I>Mon Dec  5 23:58:08 MST 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="030936.html">[Twisted-Python] memory leaks
</A></li>
        <LI>Next message: <A HREF="030938.html">[Twisted-Python] memory leaks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30937">[ date ]</a>
              <a href="thread.html#30937">[ thread ]</a>
              <a href="subject.html#30937">[ subject ]</a>
              <a href="author.html#30937">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Dec 5, 2016, at 10:18 PM, Amber Hawkie Brown &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">hawkowl at atleastfornow.net</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> On 6 Dec. 2016, at 17:09, Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> twisted.logger._initialBuffer can consume a surprisingly large amount of memory if logging is not initialized
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The way that `twisted.logger` is supposed to work is that at process startup time, the global log observer has a ring buffer for any messages emitted before logging is initialized, and emit those messages to the initial set of log observers passed to `globalLogBeginner.beginLoggingTo`.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The size of this buffer (in `twisted.logger._buffer._DEFAULT_BUFFER_MAXIMUM` is 65535.  This value was selected arbitrarily, probably because somebody (me or wsanchez) thought &quot;huh, yeah, 64k, that's probably a fine number); but of course, that's 64k ''bytes''.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> If this were a buffer of actual formatted log messages, of say 200 bytes each, that would be about 13 megabytes, which is maybe an acceptable amount of RAM to spend on a log buffer.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> However, it isn't that.  It's a buffer of 64k log ''events'', each of which probably has a `log_logger` and `log_source` set, each of which is an object attached to potentially arbitrary data.  For example, every `Factory` that starts up logs something, which means you're holding on to an instance, and an instance dictionary, and the protocol instance, and the protocol instance dictionary.  Worse yet, any logged ''failures'' might hold on to all the stuff on their stack.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Add it all up and you end up with a log buffer totaling in the hundreds of megabytes, or even gigabytes, once it's full.  In an application that naively uses Twisted without ever initializing logging, this hangs around forever.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> This buffer should probably be a ''lot'' smaller, and we might want to emit a warning when it fills up, reminding people that it is ''only polite'' to start up the logging subsystem, even just to explicitly throw logs away.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I fixed trac: <A HREF="https://twistedmatrix.com/trac/ticket/8936#ticket">https://twistedmatrix.com/trac/ticket/8936#ticket</A> &lt;<A HREF="https://twistedmatrix.com/trac/ticket/8936#ticket">https://twistedmatrix.com/trac/ticket/8936#ticket</A>&gt;
</I>Thanks!

By &quot;Fixed&quot; I take it you mean rolled back, via:

<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">trac at dornkirk</A>:~$ ./virtualenv/bin/pip freeze | grep Trac==
Trac==1.0.13

and
<A HREF="https://github.com/twisted-infra/braid/commit/c2d393fd501c6464b1b475eff214cab64f13ee2a">https://github.com/twisted-infra/braid/commit/c2d393fd501c6464b1b475eff214cab64f13ee2a</A>

Don't get me wrong, I'm not complaining :). This is certainly the right thing to do for now.  But I'm wondering if you know what's wrong with 1.2 so we can upgrade soonish?

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20161205/9f7bbeb1/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20161205/9f7bbeb1/attachment.html</A>&gt;
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030936.html">[Twisted-Python] memory leaks
</A></li>
	<LI>Next message: <A HREF="030938.html">[Twisted-Python] memory leaks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30937">[ date ]</a>
              <a href="thread.html#30937">[ thread ]</a>
              <a href="subject.html#30937">[ subject ]</a>
              <a href="author.html#30937">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
