<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20ITransport.write%20after%0A%20IProtocol.connectionLost%20--%20no%20failure/exception%3F&In-Reply-To=%3CCADtv4OBv8iqHK8eAOwoLBW2sJMtFTvEPEyGDdG8KgoFp0VtEaQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030954.html">
   <LINK REL="Next"  HREF="030956.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?</H1>
    <B>exvito here</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20ITransport.write%20after%0A%20IProtocol.connectionLost%20--%20no%20failure/exception%3F&In-Reply-To=%3CCADtv4OBv8iqHK8eAOwoLBW2sJMtFTvEPEyGDdG8KgoFp0VtEaQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?">ex.vitorino at gmail.com
       </A><BR>
    <I>Sat Dec 17 07:11:22 MST 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="030954.html">[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?
</A></li>
        <LI>Next message: <A HREF="030956.html">[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30955">[ date ]</a>
              <a href="thread.html#30955">[ thread ]</a>
              <a href="subject.html#30955">[ subject ]</a>
              <a href="author.html#30955">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Dec 16, 2016 at 8:27 PM, Glyph Lefkowitz
&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
&gt;<i>
</I>&gt;&gt;<i> On Dec 16, 2016, at 5:22 AM, Cory Benfield &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">cory at lukasa.co.uk</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 15 Dec 2016, at 12:07, exvito here &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ex.vitorino at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Dear all,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The subject says most of it. While diagnosing a behavior on a somewhat
</I>&gt;&gt;&gt;<i> large codebase, I found out something somewhat surprising -- see
</I>&gt;&gt;&gt;<i> subject -- which is replicated with the minimal code example below.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It is a LineReceiver client that:
</I>&gt;&gt;&gt;<i> 1. Connects to 127.0.0.1:10000.
</I>&gt;&gt;&gt;<i> 2. Sends a line of text.
</I>&gt;&gt;&gt;<i> 3. Disconnects one second later.
</I>&gt;&gt;&gt;<i> 4. Tries to send another line of text, one second after disconnection.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I expected step 4 to fail somehow, given that Twisted promptly
</I>&gt;&gt;&gt;<i> detected that the connection closed and IProtocol.connectionLost was
</I>&gt;&gt;&gt;<i> called, as documented. Nevertheless, it does not fail.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I can&#8217;t speak for the design of Twisted, but this is definitely an intended implementation behaviour: because twisted&#8217;s write method is non-blocking, it is generally nicer to avoid write exploding in your face when disconnected.
</I>&gt;<i>
</I>&gt;<i> I can! The main design feature of this approach is that if you have a loop like this:
</I>&gt;<i>
</I>&gt;<i> for x in messages:
</I>&gt;<i>     self.transport.write(self.encode(x))
</I>&gt;<i>
</I>&gt;<i> you should not have to write it to be:
</I>&gt;<i>
</I>&gt;<i> for x in messages:
</I>&gt;<i>     if self._flagISetInConnectionLost:
</I>&gt;<i>         break
</I>&gt;<i>     self.transport.write(self.encode(x))
</I>&gt;<i>
</I>&gt;<i> just to avoid seeing tracebacks in your logs.
</I>&gt;<i>
</I>&gt;<i> If you care about the disconnection event, implement connectionLost to do the thing that needs to be done (in this case, stop your LoopingCall).  That's what that callback is there for!
</I>

Thanks for your input Cory and Glyph.

I do agree that a well written protocol should not
self.transport.write after connectionLost -- it does not make any kind
of sense to do that. It's just that the one I was debugging was doing
it in its app-level keep alive messages triggered by
IReactorTime.callLater which wasn't properly cancelled on
connectionLost. This, in turn, lead to unpexpected app-level keep
alive timeouts after disconnection which, while acceptable (depending
on app/protocol design), were having a negative impact on the overall
connection/protocol teardown and cleanup.

Having said this, the fact that self.transport.write does not complain
after connectionLost just made my analysis and debugging more
difficult (yes, I was aware that it is non-blocking -- thanks Cory --
and that when talking to the network the only confirmation of delivery
must be obtained from a received message stating that fact).

All in all, I was just looking for confirmation from a conceptual /
design standpoint. That was my purpose and it is now clear. Thanks.

Going a little bit further, in this context, I wonder if my
understanding of the Protocol / Transport objects lifecycle is 100%
clear. I think there is a one to one relationship in the sense that,
simply put, on an incoming connection the underlying machinery
instantiates a Protocol via the Factory's buildProtocol method,
instantiates a Transport object and then calls Protocol.makeConnection
to &quot;attach&quot; the transport to the protocol; when the connection is
closed, the Transport calls connectionLost on the Protocol and, at
some point, those two objects are no longer &quot;usable&quot; -- they've done
their job and will be destroyed if no app level references are kept to
them.

If this is correct, in particular the fact that a given Transport
instance is not reusable after disconnection (if it is, could you
please point out such a case?), wouldn't it be valuable to log a
warning when write after disconnect is called? (agreed, raising an
Exception would be too much and break compatiblity). I find two
reasons for that: on one hand, given that it would have made my
debugging easier, it may help other developers pin point such cases;
on the other, the fact that Twisted itself logs messages on several
occasions, such as, for example, the default noisy Factory on doStart
/ doStop. Adding to that, the fact that, if I'm reading the code
correctly, ITransport.write just throws away the data for TCP
transports since it falls back to FileDescriptor.write that simply
returns if &quot;not self.connected or self._writeDisconnected&quot; in
src/twisted/internet/abstract.py.

Thoughts? (or corrections, of course?)

Again, thanks for your time and input.
Regards,

PS: I don't mean to start a huge discussion on the topic or question
the current design. It is very nice as it is, thank you! I'm just
looking for improving my understanding and, humbly, contributing back.
--
exvito

</PRE>














<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030954.html">[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?
</A></li>
	<LI>Next message: <A HREF="030956.html">[Twisted-Python] ITransport.write after IProtocol.connectionLost -- no failure/exception?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30955">[ date ]</a>
              <a href="thread.html#30955">[ thread ]</a>
              <a href="subject.html#30955">[ subject ]</a>
              <a href="author.html#30955">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
