<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] memory leaks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20memory%20leaks&In-Reply-To=%3CCA%2BLhZ98g4CnXFcUEfgt%2B_-cC1ofwgX1vvOjVbG32cr4oR%3DyUhQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030937.html">
   <LINK REL="Next"  HREF="030944.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] memory leaks</H1>
    <B>bret curtis</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20memory%20leaks&In-Reply-To=%3CCA%2BLhZ98g4CnXFcUEfgt%2B_-cC1ofwgX1vvOjVbG32cr4oR%3DyUhQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] memory leaks">psi29a at gmail.com
       </A><BR>
    <I>Tue Dec  6 04:17:16 MST 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="030937.html">[Twisted-Python] memory leaks
</A></li>
        <LI>Next message: <A HREF="030944.html">[Twisted-Python] memory leaks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30938">[ date ]</a>
              <a href="thread.html#30938">[ thread ]</a>
              <a href="subject.html#30938">[ subject ]</a>
              <a href="author.html#30938">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Isn't this a duplicate of my &quot;memory leak&quot; bug report from about 11 months ago?
<A HREF="https://twistedmatrix.com/trac/ticket/8164">https://twistedmatrix.com/trac/ticket/8164</A>

Glype's last comment on the ticket was:
Now, again, I want to be clear that the buffer size here is still a
bug, and we vastly mis-estimated a reasonable size.

The end result was that Hawkie indicated that there was a 64K buffer
of variable length logs. Because they are variable in length means
they use either almost no memory to potentially causing the OOM to
come along. What wasn't clear was if you reached the 64K limit, does
Twisted then just drop the rest of the logs are is the buffer a
circular one and drops the first entry to accommodate the last entry
or something else entirely?

Cheers,
Bret


On Tue, Dec 6, 2016 at 7:58 AM, Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On Dec 5, 2016, at 10:18 PM, Amber Hawkie Brown &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">hawkowl at atleastfornow.net</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 6 Dec. 2016, at 17:09, Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> twisted.logger._initialBuffer can consume a surprisingly large amount of
</I>&gt;<i> memory if logging is not initialized
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The way that `twisted.logger` is supposed to work is that at process startup
</I>&gt;<i> time, the global log observer has a ring buffer for any messages emitted
</I>&gt;<i> before logging is initialized, and emit those messages to the initial set of
</I>&gt;<i> log observers passed to `globalLogBeginner.beginLoggingTo`.
</I>&gt;<i>
</I>&gt;<i> The size of this buffer (in `twisted.logger._buffer._DEFAULT_BUFFER_MAXIMUM`
</I>&gt;<i> is 65535.  This value was selected arbitrarily, probably because somebody
</I>&gt;<i> (me or wsanchez) thought &quot;huh, yeah, 64k, that's probably a fine number);
</I>&gt;<i> but of course, that's 64k ''bytes''.
</I>&gt;<i>
</I>&gt;<i> If this were a buffer of actual formatted log messages, of say 200 bytes
</I>&gt;<i> each, that would be about 13 megabytes, which is maybe an acceptable amount
</I>&gt;<i> of RAM to spend on a log buffer.
</I>&gt;<i>
</I>&gt;<i> However, it isn't that.  It's a buffer of 64k log ''events'', each of which
</I>&gt;<i> probably has a `log_logger` and `log_source` set, each of which is an object
</I>&gt;<i> attached to potentially arbitrary data.  For example, every `Factory` that
</I>&gt;<i> starts up logs something, which means you're holding on to an instance, and
</I>&gt;<i> an instance dictionary, and the protocol instance, and the protocol instance
</I>&gt;<i> dictionary.  Worse yet, any logged ''failures'' might hold on to all the
</I>&gt;<i> stuff on their stack.
</I>&gt;<i>
</I>&gt;<i> Add it all up and you end up with a log buffer totaling in the hundreds of
</I>&gt;<i> megabytes, or even gigabytes, once it's full.  In an application that
</I>&gt;<i> naively uses Twisted without ever initializing logging, this hangs around
</I>&gt;<i> forever.
</I>&gt;<i>
</I>&gt;<i> This buffer should probably be a ''lot'' smaller, and we might want to emit
</I>&gt;<i> a warning when it fills up, reminding people that it is ''only polite'' to
</I>&gt;<i> start up the logging subsystem, even just to explicitly throw logs away.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I fixed trac: <A HREF="https://twistedmatrix.com/trac/ticket/8936#ticket">https://twistedmatrix.com/trac/ticket/8936#ticket</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i> By &quot;Fixed&quot; I take it you mean rolled back, via:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">trac at dornkirk</A>:~$ ./virtualenv/bin/pip freeze | grep Trac==
</I>&gt;<i> Trac==1.0.13
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> and
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/twisted-infra/braid/commit/c2d393fd501c6464b1b475eff214cab64f13ee2a">https://github.com/twisted-infra/braid/commit/c2d393fd501c6464b1b475eff214cab64f13ee2a</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Don't get me wrong, I'm not complaining :). This is certainly the right
</I>&gt;<i> thing to do for now.  But I'm wondering if you know what's wrong with 1.2 so
</I>&gt;<i> we can upgrade soonish?
</I>&gt;<i>
</I>&gt;<i> -glyph
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>
</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030937.html">[Twisted-Python] memory leaks
</A></li>
	<LI>Next message: <A HREF="030944.html">[Twisted-Python] memory leaks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30938">[ date ]</a>
              <a href="thread.html#30938">[ thread ]</a>
              <a href="subject.html#30938">[ subject ]</a>
              <a href="author.html#30938">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
