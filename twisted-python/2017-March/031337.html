<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Regarding the SHA 512 support in twisted.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Regarding%20the%20SHA%20512%20support%20in%20twisted.&In-Reply-To=%3CCAFycZ9cL5k%3DHu-S0_ucaK_ZEjDtUMw822ZUmyqsGV2b1wZRwFg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031336.html">
   <LINK REL="Next"  HREF="031339.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Regarding the SHA 512 support in twisted.</H1>
    <B>Adi Roiban</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Regarding%20the%20SHA%20512%20support%20in%20twisted.&In-Reply-To=%3CCAFycZ9cL5k%3DHu-S0_ucaK_ZEjDtUMw822ZUmyqsGV2b1wZRwFg%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Regarding the SHA 512 support in twisted.">adi at roiban.ro
       </A><BR>
    <I>Mon Mar 27 04:36:47 MDT 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031336.html">[Twisted-Python] Regarding the SHA 512 support in twisted.
</A></li>
        <LI>Next message (by thread): <A HREF="031339.html">[Twisted-Python] Regarding the SHA 512 support in twisted.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31337">[ date ]</a>
              <a href="thread.html#31337">[ thread ]</a>
              <a href="subject.html#31337">[ subject ]</a>
              <a href="author.html#31337">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jarib,

Thanks for the details.

On 27 March 2017 at 10:33, jabir Mohammed (jamohamm) &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jamohamm at cisco.com</A>&gt; wrote:
&gt;<i> Hi Team,
</I>&gt;<i>
</I>&gt;<i> Wanted to bring one code changes which is really required from twisted side
</I>&gt;<i> otherwise it is not behaving  as per RFC (rfc4253 Section 7.2), twisted is
</I>&gt;<i> failing when we negotiate any kex algorithm based on SHA1 and we have MAC as
</I>&gt;<i> hmac-sha2-512. The reason for the failure was the below code
</I>&gt;<i>
</I>&gt;<i> hashProcessor = _kex.getHashProcessor(self.kexAlg)
</I>&gt;<i>         k1 = hashProcessor(sharedSecret + exchangeHash + c + self.sessionID)
</I>&gt;<i>         k1 = k1.digest()
</I>&gt;<i>         k2 = hashProcessor(sharedSecret + exchangeHash + k1).digest()
</I>&gt;<i> return k1 + k2
</I>&gt;<i>
</I>&gt;<i> For SHA512 we need 64 byte key and if the Kex is based on SHA1 then it will
</I>&gt;<i> only generate 40 byte key and that induce a failure. So we need to modify
</I>&gt;<i> the code as below to make it generic and make it comply with RFC (rfc4253
</I>&gt;<i> Section 7.2). So that twisted can work irrespective of what kex is been
</I>&gt;<i> used. Actual code should plot in is like below
</I>&gt;<i>
</I>&gt;<i> hashProcessor = _kex.getHashProcessor(self.kexAlg)
</I>&gt;<i>         k1 = hashProcessor(sharedSecret + exchangeHash + c + self.sessionID)
</I>&gt;<i>         k1 = k1.digest()
</I>&gt;<i>         k2 = hashProcessor(sharedSecret + exchangeHash + k1).digest()
</I>&gt;<i> k3 = hashProcessor(sharedSecret + exchangeHash + k1 + k2).digest()
</I>&gt;<i> k4 = hashProcessor(sharedSecret + exchangeHash + k1 + k2 + k3).digest()
</I>&gt;<i> return k1 + k2 + k3 + k4
</I>&gt;<i>
</I>&gt;<i> Can somebody help me to plot this fix so that twisted will work fine with
</I>&gt;<i> all the other servers out there and even make it comply to the RFC. Thanks
</I>&gt;<i> in advance and this will be my first findings on twisted code ;). Please let
</I>&gt;<i> me know in case of any doubt on the same. Code changes should be plotted in
</I>&gt;<i> to  the routine _getKey,  file name is src/twisted/conch/ssh/transport.py .
</I>&gt;<i> Please help me with this commit team.
</I>
Happy to help.

Here should be the documentation for contributing  (hopefully is up to date)

<A HREF="http://twistedmatrix.com/trac/wiki/TwistedDevelopment">http://twistedmatrix.com/trac/wiki/TwistedDevelopment</A>

The first thing is to fork twisted/twisted, apply the change on the
branch and then create a PR.

By creating the PR, you will trigger some of the automated tests and
you can get a quick feedback.
.. for example to see if your changes are not introducing any regressions.

In an ideal world before making the changes and creating a simple
example so that we can manually check the changes you start by
updating the existing automated test to make sure that we don't
introduce regressions in the feature (as a non exhaustive list of
reasons)

You can use this file
<A HREF="https://github.com/twisted/twisted/blob/trunk/docs/conch/examples/sshsimpleserver.py">https://github.com/twisted/twisted/blob/trunk/docs/conch/examples/sshsimpleserver.py</A>
as the foundation for a simple example.
In the PR you can provide the client-side command use for the manual test

Looking forward for you PR.
I can help with the review and/or writing the automated tests.

You can also find me on #twisted-dev

Thanks,
Adi

&gt;<i> From: Alex Gaynor &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alex.gaynor at gmail.com</A>&gt;
</I>&gt;<i> Date: Wednesday, 1 March 2017 9:26 am
</I>&gt;<i> To: jabir mohammed &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jamohamm at cisco.com</A>&gt;
</I>&gt;<i> Cc: Itamar Turner-Trauring &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A>&gt;,
</I>&gt;<i> &quot;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">security at twistedmatrix.com</A>&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">security at twistedmatrix.com</A>&gt;
</I>&gt;<i> Subject: Re: Regarding the SHA 512 support in twisted.
</I>&gt;<i>
</I>&gt;<i> This doesn't appear to be a security issue. You can file an issue on the
</I>&gt;<i> public tracker.
</I>&gt;<i>
</I>&gt;<i> Alex
</I>&gt;<i>
</I>&gt;<i> On Tue, Feb 28, 2017 at 10:54 PM, jabir Mohammed (jamohamm)
</I>&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jamohamm at cisco.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks Alex for the response. In our server we added support of
</I>&gt;&gt;<i> HMAC-SHA-512 and HMAC-SHA-256 support for MAC. When we try to negotiate this
</I>&gt;&gt;<i> hmac with most of the other client like Paramiko, OpenSSH and other flavours
</I>&gt;&gt;<i> of SSH its working fine. But we are seeing a problem with twisted client
</I>&gt;&gt;<i> that too only with HMAC-SHA-512. We have a limitation from our side to debug
</I>&gt;&gt;<i> this since we donâ€™t know what is happening from the client side. We have
</I>&gt;&gt;<i> taken our derived key for the HMAC and as well as the input to derive the
</I>&gt;&gt;<i> MAC using online tools and it matches with whatever we have generated but
</I>&gt;&gt;<i> whatever is been sent across the other Twisted side differs and we are
</I>&gt;&gt;<i> closing the session. This is been tagged critical since most of the
</I>&gt;&gt;<i> customers are migrating to Twisted and will be a deployment blocker for us.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What we suspect is the key or the algorithm itself. Please see the snippet
</I>&gt;&gt;<i> below
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is our inmac Key
</I>&gt;&gt;<i> ----------------------------
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: ssh_integrity_check:
</I>&gt;&gt;<i> inmac.key
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: 0000 - a5 cb a5 bb 4c
</I>&gt;&gt;<i> 34 a7 bf-95 e9 00 23 1e 09 17 0c   ....L4.....#....
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: 0010 - 1c e1 3f d9 a7
</I>&gt;&gt;<i> 42 d9 87-54 23 64 16 e5 e2 c3 76   ..?..B..T#d....v
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: 0020 - 2a bc 53 c6 85
</I>&gt;&gt;<i> 78 81 eb-e4 3e fb f7 cc a3 1f 6e   *.S..x...&gt;.....n
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: 0030 - d9 a5 0e 73 d0
</I>&gt;&gt;<i> 44 79 a9-d3 19 32 3b 26 92 bb 70   ...s.Dy...2;&amp;..p
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is our input data to the hmac-sha-512
</I>&gt;&gt;<i> -----------------------------------------------------
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: ssh_integrity_check:
</I>&gt;&gt;<i> input.data to HMAC API
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: 0000 - 00 00 00 03 00
</I>&gt;&gt;<i> 00 00 1c-0a 05 00 00 00 0c 73 73   ..............ss
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: 0010 - 68 2d 75 73 65
</I>&gt;&gt;<i> 72 61 75-74 68 64 de 66 fb ab 31   h-userauthd.f..1
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: 0020 - ba 7e 56 e5
</I>&gt;&gt;<i> .~V.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The digest which is been sent from the twisted client side(Red)
</I>&gt;&gt;<i> -----------------------------------------------------------------------
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: ssh_integrity_check:
</I>&gt;&gt;<i> digest
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.895 : SSHD_[65795]: 0000 - 95 f7 99 27 48
</I>&gt;&gt;<i> 28 35 da-62 92 0e 51 0f af 62 b1   ...'H(5.b..Q..b.
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.896 : SSHD_[65795]: 0010 - 93 d1 4d 46 5f
</I>&gt;&gt;<i> d9 21 7a-b9 fb 86 b6 6e 00 a3 aa   ..MF_.!z....n...
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.896 : SSHD_[65795]: 0020 - 84 a9 58 60 5e
</I>&gt;&gt;<i> 1c 86 98-b4 1f 00 40 d5 72 aa cf   ..X`^<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">...... at .r..</A>
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.896 : SSHD_[65795]: 0030 - 4b 1d 05 2d a4
</I>&gt;&gt;<i> 68 96 9c-7b c7 9d 83 1d c2 1d 5b   K..-.h..{â€¦â€¦[
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The digest which got created from our side using the same key and input
</I>&gt;&gt;<i> data mentioned above(Green)
</I>&gt;&gt;<i> â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.896 : SSHD_[65795]: 0000 - 36 36 5c 6e 2d
</I>&gt;&gt;<i> be f1 d8-ae 4f 5a 72 30 2d 25 c0   66\n-....OZr0-%.
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.896 : SSHD_[65795]: 0010 - 0e e8 d6 96 6e
</I>&gt;&gt;<i> 10 38 af-65 15 51 ff a7 ca 7d b4   ....n.8.e.Q...}.
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.896 : SSHD_[65795]: 0020 - 7c c8 15 b8 5a
</I>&gt;&gt;<i> 9b 5e c4-b5 ac 4c 51 7e de 77 41   |...Z.^...LQ~.wA
</I>&gt;&gt;<i> RP/0/RSP0/CPU0:Feb 23 18:12:43.896 : SSHD_[65795]: 0030 - 32 63 61 5e f5
</I>&gt;&gt;<i> 1a 31 d1-f7 89 d0 0b 11 3c 48 f6   2ca^..1......&lt;H.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you see the details this is the useauth first packet and we are not
</I>&gt;&gt;<i> able to proceed because of the failure. We used online tool to do this
</I>&gt;&gt;<i> calculation and we are getting the same output as what we generated so the
</I>&gt;&gt;<i> one marked as red is creating problem.So the root cause could be either the
</I>&gt;&gt;<i> key which is been derived or the algorithm so to debug that we need to
</I>&gt;&gt;<i> enable details logging from client side. We can share the details with
</I>&gt;&gt;<i> respective engineer and show what we are facing. Please help.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Online tool which we used to check our algorithm is: which result in same
</I>&gt;&gt;<i> MAC marked as green.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://www.liavaag.org/English/SHA-Generator/HMAC/">https://www.liavaag.org/English/SHA-Generator/HMAC/</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Jabir
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      \|/
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     -------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    (  o o  )
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> oooO---O---Oooonull
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> From: Alex Gaynor &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alex.gaynor at gmail.com</A>&gt;
</I>&gt;&gt;<i> Date: Wednesday, 1 March 2017 6:39 am
</I>&gt;&gt;<i> To: Itamar Turner-Trauring &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A>&gt;
</I>&gt;&gt;<i> Cc: jabir mohammed &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jamohamm at cisco.com</A>&gt;, &quot;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">security at twistedmatrix.com</A>&quot;
</I>&gt;&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">security at twistedmatrix.com</A>&gt;
</I>&gt;&gt;<i> Subject: Re: FW: Regarding the SHA 512 support in twisted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think I'm missing some context here, what part of twisted are you trying
</I>&gt;&gt;<i> to use SHA-512 for a MAC with? It sounds like Conch? Can you show how I
</I>&gt;&gt;<i> could reproduce the problem?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Tue, Feb 28, 2017 at 8:06 PM, Itamar Turner-Trauring
</I>&gt;&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Forwarding on to security contact to see if they think it's a security
</I>&gt;&gt;&gt;<i> problem; otherwise you can probably just file a normal ticket.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Tue, Feb 28, 2017, at 05:01 AM, jabir Mohammed (jamohamm) wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi Team,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Wanted to cross check on SHA 512 algorithm as MAC while using twisted.
</I>&gt;&gt;&gt;<i> Few of our customers started using Twisted and even we are trying to
</I>&gt;&gt;&gt;<i> incorporate some scripts via twisted client. But what we have noticed is
</I>&gt;&gt;&gt;<i> that when we negotiate SHA 512 MAC with twisted we always get a failure and
</I>&gt;&gt;&gt;<i> other MAC algorithms are working fine with twisted. So wanted to cross check
</I>&gt;&gt;&gt;<i> do we have any bug or any issue with SHA 512 and twisted and how we can
</I>&gt;&gt;&gt;<i> debug this from twisted side.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We checked the same with other OpenSSH client and even paramiko things
</I>&gt;&gt;&gt;<i> work perfectly fine so wanted to debug further from the twisted side. We
</I>&gt;&gt;&gt;<i> checked with the same derived key and the output whatever we got from SHA
</I>&gt;&gt;&gt;<i> 512 is what we are getting from the online tool so we suspect something to
</I>&gt;&gt;&gt;<i> do with the key or hash algorithm from the other side.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We used the twisted 16.6.0 version for testing, thanks in advance for
</I>&gt;&gt;&gt;<i> looking in to this email.
</I>&gt;&gt;&gt;<i>
</I>


-- 
Adi Roiban

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031336.html">[Twisted-Python] Regarding the SHA 512 support in twisted.
</A></li>
	<LI>Next message (by thread): <A HREF="031339.html">[Twisted-Python] Regarding the SHA 512 support in twisted.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31337">[ date ]</a>
              <a href="thread.html#31337">[ thread ]</a>
              <a href="subject.html#31337">[ subject ]</a>
              <a href="author.html#31337">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
