<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] HTTP Agent persistent connections not closed for some HTTPS sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20HTTP%20Agent%20persistent%20connections%20not%20closed%0A%20for%20some%20HTTPS%20sites&In-Reply-To=%3CCAFycZ9eBMKQHXDyyT4YBunPbWeD%2B%2BzBUj48PoX26qb%2BK2rf3MA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031296.html">
   <LINK REL="Next"  HREF="031303.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] HTTP Agent persistent connections not closed for some HTTPS sites</H1>
    <B>Adi Roiban</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20HTTP%20Agent%20persistent%20connections%20not%20closed%0A%20for%20some%20HTTPS%20sites&In-Reply-To=%3CCAFycZ9eBMKQHXDyyT4YBunPbWeD%2B%2BzBUj48PoX26qb%2BK2rf3MA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] HTTP Agent persistent connections not closed for some HTTPS sites">adi at roiban.ro
       </A><BR>
    <I>Mon Mar  6 02:05:09 MST 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031296.html">[Twisted-Python] HTTP Agent persistent connections not closed for some HTTPS sites
</A></li>
        <LI>Next message (by thread): <A HREF="031303.html">[Twisted-Python] HTTP Agent persistent connections not closed for some HTTPS sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31297">[ date ]</a>
              <a href="thread.html#31297">[ thread ]</a>
              <a href="subject.html#31297">[ subject ]</a>
              <a href="author.html#31297">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6 March 2017 at 08:17, Cory Benfield &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">cory at lukasa.co.uk</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On 5 Mar 2017, at 14:25, Tristan Seligmann &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mithrandi at mithrandi.net</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> On Sun, 5 Mar 2017 at 15:36 Adi Roiban &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have observed this while running some end to end tests in which the
</I>&gt;&gt;<i> pool.closeCachedConnections() deferred was not called, even after a
</I>&gt;&gt;<i> generous amount of seconds :)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The code to abort an HTTP client connection is here:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/twisted/twisted/blob/twisted-17.1.0/src/twisted/web/_newclient.py#L1657">https://github.com/twisted/twisted/blob/twisted-17.1.0/src/twisted/web/_newclient.py#L1657</A>
</I>&gt;<i>
</I>&gt;<i> This calls loseConnection which for a TLS connection will try to do a TLS
</I>&gt;<i> shutdown under most circumstances (in some cases it can't, and will
</I>&gt;<i> abortConnection on the underlying transport instead). If the remote end has
</I>&gt;<i> stopped responding to the connection, I think this may end up hanging
</I>&gt;<i> forever.
</I>&gt;<i>
</I>&gt;<i> I think this code should either call abortConnection directly, or set a
</I>&gt;<i> timer which will abort the connection after a little while if a clean
</I>&gt;<i> shutdown from loseConnection has not completed yet. I&#8217;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Yeah, this looks right. We hit it in the server side code too: it&#8217;s a very
</I>&gt;<i> unintuitive API in that sense.
</I>
I am not sure about which code are we talking here.
The specific HTTP11ClientProtocol which will fix only the HTTP client
part or the generic TLSMemoryBIOProtocol code which might fix any TLS
connection?

I have observed this issue on the server side for the case in which a
TLS connection is opened and then closed  without transferring any
data ... and then the handshake will not have the chance to complete.

I think that this is the same issue which was reported for Scrapy

-- 
Adi Roiban

</PRE>


















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031296.html">[Twisted-Python] HTTP Agent persistent connections not closed for some HTTPS sites
</A></li>
	<LI>Next message (by thread): <A HREF="031303.html">[Twisted-Python] HTTP Agent persistent connections not closed for some HTTPS sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31297">[ date ]</a>
              <a href="thread.html#31297">[ thread ]</a>
              <a href="subject.html#31297">[ subject ]</a>
              <a href="author.html#31297">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
