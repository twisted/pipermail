<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] HTTP Agent persistent connections not closed for	some HTTPS sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20HTTP%20Agent%20persistent%20connections%20not%20closed%20for%0A%09some%20HTTPS%20sites&In-Reply-To=%3CCAFycZ9cVFYDXCf_pqrAL_EA9NyGv8Ya26gNi1Fp3w0v1g%3DWENg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="063796.html">
   <LINK REL="Next"  HREF="063752.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] HTTP Agent persistent connections not closed for	some HTTPS sites</H1>
    <B>Adi Roiban</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20HTTP%20Agent%20persistent%20connections%20not%20closed%20for%0A%09some%20HTTPS%20sites&In-Reply-To=%3CCAFycZ9cVFYDXCf_pqrAL_EA9NyGv8Ya26gNi1Fp3w0v1g%3DWENg%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] HTTP Agent persistent connections not closed for	some HTTPS sites">adi at roiban.ro
       </A><BR>
    <I>Sun Mar  5 06:35:44 MST 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="063796.html">[Twisted-Python] Weekly Bug Summary
</A></li>
        <LI>Next message (by thread): <A HREF="063752.html">[Twisted-Python] HTTP Agent persistent connections not closed for some HTTPS sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31290">[ date ]</a>
              <a href="thread.html#31290">[ thread ]</a>
              <a href="subject.html#31290">[ subject ]</a>
              <a href="author.html#31290">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

It looks like when connected to some  HTTPS servers, the TLS
connection is not successfully closed.

With sites like google.com, the connection is successfully closed.

But with Office365 sharepoint.com sites the TLS shutdown is not completed.

Has anyone else observed this behaviour ?

I have observed this while running some end to end tests in which the
pool.closeCachedConnections() deferred was not called, even after a
generous amount of seconds :)

--------

the TLSMemoryBIOProtocol._tlsConnection.shutdown() will return False
and the connection is left open.

Future calls to tlsConnection will result in WantReadError

&gt;<i>From my understanding WantReadError means that more data needs to be
</I>read and passed to the protocol.

And If I try to read from the raw socket I get this

data = TLSMemoryBIOProtocol.transport.socket.recv(1000)
*** error: [Errno 11] Resource temporarily unavailable

and the socket is never made available  and in the end it is closed with

data = TLSMemoryBIOProtocol.transport.socket.recv(100)
*** error: [Errno 104] Connection reset by peer

-----------

Here is a gits with the example code and some example output
<A HREF="https://gist.github.com/adiroiban/346dd455094d1762f0e69e9812309ad6">https://gist.github.com/adiroiban/346dd455094d1762f0e69e9812309ad6</A>

The gist also contains a patched TLSMemoryBIOProtocol._shutdownTLS
which will close the connection after some time.

PS: TLSMemoryBIOProtocol._tlsConnection.shutdown() make reference to
this issue <A HREF="https://github.com/pyca/pyopenssl/issues/91...">https://github.com/pyca/pyopenssl/issues/91...</A> but the
issue is now closed

Thanks!
-- 
Adi Roiban

</PRE>



















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="063796.html">[Twisted-Python] Weekly Bug Summary
</A></li>
	<LI>Next message (by thread): <A HREF="063752.html">[Twisted-Python] HTTP Agent persistent connections not closed for some HTTPS sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31290">[ date ]</a>
              <a href="thread.html#31290">[ thread ]</a>
              <a href="subject.html#31290">[ subject ]</a>
              <a href="author.html#31290">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
