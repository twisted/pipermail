<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] txsni + alpn + acme (letsencrypt)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20txsni%20%2B%20alpn%20%2B%20acme%20%28letsencrypt%29&In-Reply-To=%3CCAG8k2%2B7Vmn89b%2BQML3JPRRiVyhQtjkdrDaWEN%3DARgKAXuSkBFw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032268.html">
   <LINK REL="Next"  HREF="032269.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] txsni + alpn + acme (letsencrypt)</H1>
    <B>Daniel Holth</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20txsni%20%2B%20alpn%20%2B%20acme%20%28letsencrypt%29&In-Reply-To=%3CCAG8k2%2B7Vmn89b%2BQML3JPRRiVyhQtjkdrDaWEN%3DARgKAXuSkBFw%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] txsni + alpn + acme (letsencrypt)">dholth at gmail.com
       </A><BR>
    <I>Tue Apr 23 20:21:59 MDT 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032268.html">[Twisted-Python] txsni + alpn + acme (letsencrypt)
</A></li>
        <LI>Next message (by thread): <A HREF="032269.html">[Twisted-Python] A Proposal for reducing the burden of developing on Twisted by dropping Python 2 support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64753">[ date ]</a>
              <a href="thread.html#64753">[ thread ]</a>
              <a href="subject.html#64753">[ subject ]</a>
              <a href="author.html#64753">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I was able to figure out the tests, and improve coverage in txsni.

On Tue, Apr 2, 2019 at 10:29 AM Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Let me know if you're able to try getting a https certificate in this way:
</I>&gt;<i>
</I>&gt;<i> Using tls-alpn-01 negotiation with txsni (acme branch) and the
</I>&gt;<i> dehydrated letsencrypt client:
</I>&gt;<i>
</I>&gt;<i> Install txsni (acme branch):
</I>&gt;<i>
</I>&gt;<i> pip install git+<A HREF="https://github.com/dholth/txsni@acme#egg=txsni">https://github.com/dholth/txsni@acme#egg=txsni</A>
</I>&gt;<i>
</I>&gt;<i> Unpack dehydrated acme client shell script from <A HREF="https://dehydrated.io/">https://dehydrated.io/</A>
</I>&gt;<i>
</I>&gt;<i> Make and enter config directory:
</I>&gt;<i>
</I>&gt;<i> mkdir -p ~/etc/dehydrated
</I>&gt;<i>
</I>&gt;<i> cd ~/etc/dyhydrated
</I>&gt;<i>
</I>&gt;<i> Use acmesni to listen on port 443:
</I>&gt;<i>
</I>&gt;<i> authbind twist web --listen acmesni:~/etc/dehydrated:tcp6:443 &amp;
</I>&gt;<i>
</I>&gt;<i> Make config file:
</I>&gt;<i>
</I>&gt;<i> echo CHALLENGETYPE=&quot;tls-alpn-01&quot; &gt; config
</I>&gt;<i>
</I>&gt;<i> Create letsencrypt account:
</I>&gt;<i>
</I>&gt;<i> dehydrated --register --accept-terms
</I>&gt;<i>
</I>&gt;<i> Request certificate (replace example.com with your fqnd):
</I>&gt;<i>
</I>&gt;<i> dehydrated -c -d example.com
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Letsencrypt should request a special certificate from the twisted web
</I>&gt;<i> server to prove domain control, and then dehydrated installs the new
</I>&gt;<i> certificate for 'example.com' in ~/etc/dehydrated/certs/...
</I>&gt;<i> <A HREF="https://example.com">https://example.com</A> will be ready to go.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Authbind, to listen on privileged ports in linux without root:
</I>&gt;<i>
</I>&gt;<i> (install authbind); touch /etc/authbind/byport/{80,443}; chown
</I>&gt;<i> &lt;username&gt; /etc/authbind/byport/*; chmod u+x /etc/authbind/byport/*
</I>&gt;<i>
</I>&gt;<i> On Sun, Mar 24, 2019 at 9:17 PM Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Do move it to twisted. I was surprised it wasn't already there.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Sun, Mar 24, 2019, 17:39 Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Thanks! I put some review comments on it.  I would encourage others with interest in this area to have a look; I might not get back to this for a couple of weeks, but I'd be happy to give people collaborator permissions on the repo if they'd like to help out.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; (Frankly it's probably time that this project grew up and moved over to the Twisted org anyway, given that txacme depends on it...)
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; -g
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On Mar 24, 2019, at 1:59 PM, Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Pull request for txsni acme <A HREF="https://github.com/glyph/txsni/pull/28">https://github.com/glyph/txsni/pull/28</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On Sun, Mar 24, 2019, 16:33 Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Any chance you could include a link to the relevant PR?  Pulling this out of the raging tire-fire of my Github notifications would take an unfortunately non-trivial amount of time - and I imagine that not everyone subscribed might even be on the appropriate repos :).
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; -g
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; On Mar 24, 2019, at 9:26 AM, Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; The cleaned up pull request should be really easy to try, with a dehydrated:(basedir) string port. Go get some certs people!
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; On Sun, Mar 24, 2019, 00:55 Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; I think ACME_TLS_1 is a sufficiently high-entropy string that the likelihood of brokenness from this approach is basically zero.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; -g
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; On Mar 23, 2019, at 9:20 PM, Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; All we have to do is have some kind of per connection certificate store or flag. If acme is in the first packet and the special certificate exists, send it. Otherwise send the normal certificate, for a very short window of possible brokenness. Letsencrypt may or may not require correct alpn negotiation. Should be simple.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; I'm happy running the acme client separately and listing my domain instead of doing it all on demand inside twisted.
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; On Sat, Mar 23, 2019, 23:59 Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt; On Mar 23, 2019, at 4:06 PM, Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt; HOLY REGEX BATMAN
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt; class _ConnectionProxy(object):
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt;    def bio_write(self, buf):
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt;        if ACME_TLS_1 in buf:
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt;            self.acme_tls_1 = True
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt;        self.bio_write = self._obj.bio_write
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt;        return self._obj.bio_write(buf)
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt; Now we can choose the acme certificate store in the sni callback and
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; &gt; make letsencrypt happy!
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; 1. Gross
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; 2. Hooray!
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; -g
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt;&gt;&gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt;&gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt;&gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt;&gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt;&gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt;&gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt;&gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032268.html">[Twisted-Python] txsni + alpn + acme (letsencrypt)
</A></li>
	<LI>Next message (by thread): <A HREF="032269.html">[Twisted-Python] A Proposal for reducing the burden of developing on Twisted by dropping Python 2 support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64753">[ date ]</a>
              <a href="thread.html#64753">[ thread ]</a>
              <a href="subject.html#64753">[ subject ]</a>
              <a href="author.html#64753">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
