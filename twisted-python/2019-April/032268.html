<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] txsni + alpn + acme (letsencrypt)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20txsni%20%2B%20alpn%20%2B%20acme%20%28letsencrypt%29&In-Reply-To=%3CCAG8k2%2B4LUzbC36reZGSRLi2K6bVu0Nfe5d7Z0YPhPLwgKLssMA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064746.html">
   <LINK REL="Next"  HREF="064753.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] txsni + alpn + acme (letsencrypt)</H1>
    <B>Daniel Holth</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20txsni%20%2B%20alpn%20%2B%20acme%20%28letsencrypt%29&In-Reply-To=%3CCAG8k2%2B4LUzbC36reZGSRLi2K6bVu0Nfe5d7Z0YPhPLwgKLssMA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] txsni + alpn + acme (letsencrypt)">dholth at gmail.com
       </A><BR>
    <I>Tue Apr  2 08:29:15 MDT 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064746.html">[Twisted-Python] ws(s):// urls and host/port duplication in twisted/autobahn code
</A></li>
        <LI>Next message (by thread): <A HREF="064753.html">[Twisted-Python] txsni + alpn + acme (letsencrypt)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32268">[ date ]</a>
              <a href="thread.html#32268">[ thread ]</a>
              <a href="subject.html#32268">[ subject ]</a>
              <a href="author.html#32268">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Let me know if you're able to try getting a https certificate in this way:

Using tls-alpn-01 negotiation with txsni (acme branch) and the
dehydrated letsencrypt client:

Install txsni (acme branch):

pip install git+<A HREF="https://github.com/dholth/txsni@acme#egg=txsni">https://github.com/dholth/txsni@acme#egg=txsni</A>

Unpack dehydrated acme client shell script from <A HREF="https://dehydrated.io/">https://dehydrated.io/</A>

Make and enter config directory:

mkdir -p ~/etc/dehydrated

cd ~/etc/dyhydrated

Use acmesni to listen on port 443:

authbind twist web --listen acmesni:~/etc/dehydrated:tcp6:443 &amp;

Make config file:

echo CHALLENGETYPE=&quot;tls-alpn-01&quot; &gt; config

Create letsencrypt account:

dehydrated --register --accept-terms

Request certificate (replace example.com with your fqnd):

dehydrated -c -d example.com


Letsencrypt should request a special certificate from the twisted web
server to prove domain control, and then dehydrated installs the new
certificate for 'example.com' in ~/etc/dehydrated/certs/...
<A HREF="https://example.com">https://example.com</A> will be ready to go.


Authbind, to listen on privileged ports in linux without root:

(install authbind); touch /etc/authbind/byport/{80,443}; chown
&lt;username&gt; /etc/authbind/byport/*; chmod u+x /etc/authbind/byport/*

On Sun, Mar 24, 2019 at 9:17 PM Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Do move it to twisted. I was surprised it wasn't already there.
</I>&gt;<i>
</I>&gt;<i> On Sun, Mar 24, 2019, 17:39 Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks! I put some review comments on it.  I would encourage others with interest in this area to have a look; I might not get back to this for a couple of weeks, but I'd be happy to give people collaborator permissions on the repo if they'd like to help out.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> (Frankly it's probably time that this project grew up and moved over to the Twisted org anyway, given that txacme depends on it...)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -g
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mar 24, 2019, at 1:59 PM, Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Pull request for txsni acme <A HREF="https://github.com/glyph/txsni/pull/28">https://github.com/glyph/txsni/pull/28</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Sun, Mar 24, 2019, 16:33 Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Any chance you could include a link to the relevant PR?  Pulling this out of the raging tire-fire of my Github notifications would take an unfortunately non-trivial amount of time - and I imagine that not everyone subscribed might even be on the appropriate repos :).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -g
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Mar 24, 2019, at 9:26 AM, Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The cleaned up pull request should be really easy to try, with a dehydrated:(basedir) string port. Go get some certs people!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Sun, Mar 24, 2019, 00:55 Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I think ACME_TLS_1 is a sufficiently high-entropy string that the likelihood of brokenness from this approach is basically zero.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> -g
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On Mar 23, 2019, at 9:20 PM, Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> All we have to do is have some kind of per connection certificate store or flag. If acme is in the first packet and the special certificate exists, send it. Otherwise send the normal certificate, for a very short window of possible brokenness. Letsencrypt may or may not require correct alpn negotiation. Should be simple.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I'm happy running the acme client separately and listing my domain instead of doing it all on demand inside twisted.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On Sat, Mar 23, 2019, 23:59 Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt; On Mar 23, 2019, at 4:06 PM, Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt; HOLY REGEX BATMAN
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt; class _ConnectionProxy(object):
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt;    def bio_write(self, buf):
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt;        if ACME_TLS_1 in buf:
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt;            self.acme_tls_1 = True
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt;        self.bio_write = self._obj.bio_write
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt;        return self._obj.bio_write(buf)
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt; Now we can choose the acme certificate store in the sni callback and
</I>&gt;&gt;&gt;&gt;&gt;<i> &gt; make letsencrypt happy!
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> 1. Gross
</I>&gt;&gt;&gt;&gt;&gt;<i> 2. Hooray!
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> -g
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064746.html">[Twisted-Python] ws(s):// urls and host/port duplication in twisted/autobahn code
</A></li>
	<LI>Next message (by thread): <A HREF="064753.html">[Twisted-Python] txsni + alpn + acme (letsencrypt)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32268">[ date ]</a>
              <a href="thread.html#32268">[ thread ]</a>
              <a href="subject.html#32268">[ subject ]</a>
              <a href="author.html#32268">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
