<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Advice on Writing a Custom Twisted Reactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Advice%20on%20Writing%20a%20Custom%20Twisted%20Reactor&In-Reply-To=%3C20070110233243.11447.1076809328.divmod.quotient.12503%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="047092.html">
   <LINK REL="Next"  HREF="047094.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Advice on Writing a Custom Twisted Reactor</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Advice%20on%20Writing%20a%20Custom%20Twisted%20Reactor&In-Reply-To=%3C20070110233243.11447.1076809328.divmod.quotient.12503%40ohm%3E"
       TITLE="[Twisted-Python] Advice on Writing a Custom Twisted Reactor">exarkun at divmod.com
       </A><BR>
    <I>Wed Jan 10 16:32:43 MST 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="047092.html">[Twisted-Python] Advice on Writing a Custom Twisted Reactor
</A></li>
        <LI>Next message (by thread): <A HREF="047094.html">[Twisted-Python] Moonfallen's ntsvc code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47093">[ date ]</a>
              <a href="thread.html#47093">[ thread ]</a>
              <a href="subject.html#47093">[ subject ]</a>
              <a href="author.html#47093">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 10 Jan 2007 14:44:16 -0800 (PST), Andrew Francis &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrewfr_ice at yahoo.com</A>&gt; wrote:
&gt;<i>Hello Colleagues:
</I>&gt;<i>
</I>&gt;<i>I am a first time poster...
</I>
Welcome to the list. :)

&gt;<i>
</I>&gt;<i>For the past few months I have been experimenting with
</I>&gt;<i>using Stackless Python with Twisted. I still consider
</I>&gt;<i>myself very much a Twisted newbie. Currently my
</I>&gt;<i>problems involve deferreds.
</I>
Okay.  Hopefully this will be easy to straighten out:
Deferreds are quite simple.

&gt;<i>
</I>&gt;&gt;<i>From doing online searches, I have run across
</I>&gt;<i>customized reactors for Twisted. Consequently I am
</I>&gt;<i>looking at the custom reactors that come with Twisted.
</I>&gt;<i>Like Stackless, many GUIs have a hard time working
</I>&gt;<i>with Twisted which blocks. Based on the
</I>&gt;<i>ThreadedSelectReactor, most of the reactors are for
</I>&gt;<i>GUIs. The general idea is that custom reactor's event
</I>&gt;<i>loop calls Twisted in its own thread. This approach
</I>&gt;<i>seems like it would work for Stackless and provide a
</I>&gt;<i>decent general solution. However there are a few
</I>&gt;<i>places where I am not quite clear.
</I>
The split is pretty even, actually.  There's are GUI
reactors for Gtk, Gtk2, wxPython, and Qt.  There are
non-GUI reactors for select, poll, epoll, KQ, and IOCP.
There's also a Win32 event reactor, which is kind of
for GUI integration and kind of for other stuff.

Threaded select reactor actually isn't the same kind of
reactor as the rest of these, since it isn't intended
to be used via the normal reactor API (ie, run).  In
Twisted 2.5, we've renamed it to try to make this more
apparent: it's now in a &quot;private&quot; module which doesn't
have &quot;reactor&quot; in its name.  It still works in the
same way as it always did, though.

For most reactors, the behavior is actually to monitor
event sources and then dispatch received events to code
interested in them.  Whether these events are for GUI
elements or file descriptors doesn't really matter much.
Whether the monitoring is done in one thread or many is
also more or less irrelevant, as far as the external API
is concerned.  It _is_ important that all event dispatching
happens to a single thread, since this is what programs
written with Twisted expect to happen, and doing otherwise
would typically introduce bugs into these applications.

I'm not sure what &quot;general solution&quot; you have in mind, so
this may or may not be relevant to the problem you're
tackling.

&gt;<i>
</I>&gt;<i>Most of my Stackless programmes have the following
</I>&gt;<i>form (think of this as a MainLoop):
</I>&gt;<i>
</I>&gt;<i>~
</I>&gt;<i>
</I>&gt;<i>set up stuff
</I>&gt;<i>
</I>&gt;<i>while (stackless.getruncount() &gt; 1):
</I>&gt;<i>   stackless.schedule()
</I>&gt;<i>
</I>&gt;<i>~
</I>&gt;<i>
</I>&gt;<i>Since it seems my custom reactor has to call Twisted
</I>&gt;<i>as often as possible. I would wrap
</I>&gt;<i>stackless.schedule() (since this is often called):
</I>
All of the currently implemented Twisted reactors need
to wake up under two circumstances:

  * a network event has occurred and needs to be reacted to
  * a timing event has occurred and needs to be reacted to

The most correct integration will account for these two facts
and only wake up as often as is necessary to deal with the
relevant events.

Of course, waking up more often isn't necessarily incorrect,
but it is wasteful.  Also, if the scheduling strategy is &quot;as
fast as possible&quot;, then the accuracy of timed event processing
typically suffers.

&gt;<i>
</I>&gt;<i>stacklessReactor.schedule():
</I>&gt;<i>    __hook__() # some method that would call Twisted
</I>&gt;<i>    stackless.schedule()
</I>&gt;<i>
</I>&gt;<i>Where I start to get a bit confused is:
</I>&gt;<i>
</I>&gt;<i>1) In the Custom reactor.run() method, do I call
</I>&gt;<i>self.__hook__() in the interleave() method? Is there
</I>&gt;<i>anything more I have to do in the run() method? Can I
</I>&gt;<i>avoid signal handler issues by passing False to
</I>&gt;<i>Twisted's reactor.run() ?
</I>&gt;<i>
</I>&gt;<i>2) From my Stackless code, do I have to use
</I>&gt;<i>self.callFromThread() to call Twisted methods that
</I>&gt;<i>involve deferreds?
</I>&gt;<i>
</I>
Okay.  I see that you're writing stackless integration
using TSR.  I'm not sure what the point of this is.  Can
you explain the functionality that's gained by doing this,
rather than using something like what's in Chris Armstrong's
sandbox in threadless.py?

&gt;<i>Again, any advice would be welcomed.
</I>
I don't think I've completely understood your goals, but I
hope this is a good starting point.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="047092.html">[Twisted-Python] Advice on Writing a Custom Twisted Reactor
</A></li>
	<LI>Next message (by thread): <A HREF="047094.html">[Twisted-Python] Moonfallen's ntsvc code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47093">[ date ]</a>
              <a href="thread.html#47093">[ thread ]</a>
              <a href="subject.html#47093">[ subject ]</a>
              <a href="author.html#47093">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
