<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Advice on Writing a Custom Twisted Stackless	Reactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Advice%20on%20Writing%20a%20Custom%20Twisted%20Stackless%0A%09Reactor&In-Reply-To=408744.8368.qm%40web34213.mail.mud.yahoo.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014596.html">
   <LINK REL="Next"  HREF="014597.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Advice on Writing a Custom Twisted Stackless	Reactor</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Advice%20on%20Writing%20a%20Custom%20Twisted%20Stackless%0A%09Reactor&In-Reply-To=408744.8368.qm%40web34213.mail.mud.yahoo.com"
       TITLE="[Twisted-Python] Advice on Writing a Custom Twisted Stackless	Reactor">exarkun at divmod.com
       </A><BR>
    <I>Thu Jan 11 17:35:36 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="014596.html">[Twisted-Python] Advice on Writing a Custom Twisted Stackless	Reactor
</A></li>
        <LI>Next message: <A HREF="014597.html">[Twisted-Python] A PyCon BoF about content repository in Python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14598">[ date ]</a>
              <a href="thread.html#14598">[ thread ]</a>
              <a href="subject.html#14598">[ subject ]</a>
              <a href="author.html#14598">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 11 Jan 2007 13:46:17 -0800 (PST), Andrew Francis &gt;&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">20070110233243.11447.1076809328.divmod.quotient.12503 at ohm</A>&gt;
&gt;&gt;<i>Okay.  I see that you're writing stackless
</I>&gt;<i>integration
</I>&gt;&gt;<i>using TSR.  I'm not sure what the point of this is.
</I>&gt;&gt;<i>Can you explain the functionality that's gained by
</I>&gt;&gt;<i>doing this, rather than using something like what's
</I>&gt;<i>in &gt;Chris Armstrong's sandbox in threadless.py?
</I>&gt;<i>
</I>&gt;<i>Thank you Jean-Paul for your response. My goal is to
</I>&gt;<i>write a custom Twisted reactor for Stackless Python.
</I>&gt;<i>Although I have had success writing programmes that
</I>&gt;<i>use deferred (for client HTTP calls) and HTTP request
</I>&gt;<i>handlers, I have had problems doing both
</I>&gt;<i>simultaneously in one programme.
</I>&gt;<i>
</I>&gt;<i>Some context : I am prototyping WS-BPEL (Web services
</I>&gt;<i>Business Process Execution Language) processors. In
</I>&gt;<i>the WS-BPEL language, it is possible for some
</I>&gt;<i>process's &quot;threads&quot; to act as a server and other
</I>&gt;<i>&quot;threads&quot; to act as a client simultaneously.
</I>
This is possible without involving ThreadedSelectReactor
or Stackless Python, of course.  There may be a reason to
bring Stackless Python in to simplify the expression of
some ideas, but I'm still not sure I understand the reason
to bring in ThreadedSelectReactor.  This may just be due
to the fact that I haven't written a lot of code using
Stackless Python.  Some examples would be helpful here.

&gt;<i>
</I>&gt;<i>The problem that I have found is that when Twisted
</I>&gt;<i>blocks waiting for a server request, Stackless will
</I>&gt;<i>also block, hence no progress on other tasklets that
</I>&gt;<i>could execute.
</I>
Twisted will block while there are no events to process.
As soon as there is an event, though, it will wake up.  So,
if your tasklets are I/O bound, as soon as there is a network
event, Twisted will tell you about it and you can schedule
the next one to run.  If your tasklets are based on timing
events, as soon as the time comes for one of these to fire,
Twisted will also wake up and you can schedule one.  If there
is some other kind of event source, it may be a little more
challenging, but it sounds like that's not the case here.

&gt;<i>I thought I got around this problem by
</I>&gt;<i>using task.LoopingCall/() that would issue a
</I>&gt;<i>stackless.schedule() at regular intervals. However
</I>&gt;<i>this approach turns out to be problematic. 
</I>
What problems did you face?  It certainly doesn't sound ideal,
but it does sound like it should give you something which does
more or less work.  Better would be to associate network and
timing events with specific tasklets and wake them up when the
reactor fires those events.

&gt;<i>I thought I
</I>&gt;<i>could solve the problem by placing Twisted in a thread
</I>&gt;<i>but no. The main problem with placing Twisted in a
</I>&gt;<i>thread is that I seem to lose the deferred (and I
</I>&gt;<i>don't believe I am getting deadlock).
</I>
Most Twisted APIs aren't threadsafe, so most likely what is
happening here is that you are using a Twisted API from the
wrong thread and it just isn't working right, which often
manifests as an event which never fires.

However, I still suspect bringing in a native thread is not
necessary to accomplish your goals.

&gt;<i>
</I>&gt;&gt;<i>Can you explain the functionality that's gained by
</I>&gt;&gt;<i>doing this,
</I>&gt;<i>
</I>&gt;<i>1. I solve my problem in a clean fashion.
</I>
Always a bonus. :)

&gt;<i>
</I>&gt;<i>2. If I write a custom Stackless Reactor, then I have
</I>&gt;<i>a solution that conforms to the way Twisted does
</I>&gt;<i>stuff. I think would make it easier for others to use
</I>&gt;<i>my stuff.
</I>
Possibly.  On the other hand, it may just introduce the
need for other people to be careful about threadsafety.

&gt;<i>
</I>&gt;&gt;<i>rather than using something like what's in Chris
</I>&gt;&gt;<i>Armstrong's sandbox in threadless.py?
</I>&gt;<i>
</I>&gt;<i>Chris's approach looks like the approach I currently
</I>&gt;<i>use.
</I>
Unfortunately I still haven't managed to grasp why this
is undesirable. :(

&gt;<i>
</I>&gt;&gt;<i>Threaded select reactor actually isn't the same kind
</I>&gt;&gt;<i>of reactor as the rest of these, since it isn't
</I>&gt;&gt;<i>intended to be used via the normal reactor API (ie,
</I>&gt;&gt;<i>run).
</I>&gt;<i>
</I>&gt;<i>Right now I am using Twisted 2.4 with Stackless 2.4.3.
</I>&gt;<i>
</I>&gt;<i>For now, I would like to build on top of
</I>&gt;<i>ThreadedSelectReactor.
</I>&gt;<i>
</I>&gt;<i>Back to my original question, given my previous
</I>&gt;<i>example's &quot;main loop&quot;, do I simply use interleave() to
</I>&gt;<i>get my processor to call Twisted?
</I>
Roughly, yes.  blockingdemo.py in the examples directory
gives a fairly short, self-contained example of integrating
another loop using TSR.  If you haven't seen it yet, it'll
probably help or help verify your understanding.  If you have,
it might be a good basis to guide further questions.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014596.html">[Twisted-Python] Advice on Writing a Custom Twisted Stackless	Reactor
</A></li>
	<LI>Next message: <A HREF="014597.html">[Twisted-Python] A PyCon BoF about content repository in Python
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14598">[ date ]</a>
              <a href="thread.html#14598">[ thread ]</a>
              <a href="subject.html#14598">[ subject ]</a>
              <a href="author.html#14598">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
