<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How do I gracefully handle losing a connection?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20do%20I%20gracefully%20handle%20losing%20a%20connection%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014557.html">
   <LINK REL="Next"  HREF="014562.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How do I gracefully handle losing a connection?</H1>
    <B>fritz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20do%20I%20gracefully%20handle%20losing%20a%20connection%3F&In-Reply-To="
       TITLE="[Twisted-Python] How do I gracefully handle losing a connection?">twisted-python at milkpotato.org
       </A><BR>
    <I>Wed Jan  3 14:54:39 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="014557.html">[Twisted-Python] a question ablout DeferredList
</A></li>
        <LI>Next message: <A HREF="014562.html">[Twisted-Python] Twisted Adapter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14558">[ date ]</a>
              <a href="thread.html#14558">[ thread ]</a>
              <a href="subject.html#14558">[ subject ]</a>
              <a href="author.html#14558">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all,
I'm building off of the ssh client example in the excellent O'Reilly
book on Twisted by Abe Fettig but I've run into some problems and I'm
not sure how I should proceed.

Basically, I've implemented additional methods in order to handle
connection issues with the client. The goal being, exiting of the
program and printing out an error message detailing why the connection
failed:

class ClientCommandFactory(protocol.ClientFactory):

    ...

    def clientConnectionFailed(self, connector, reason):
        print reason.getErrorMessage()
        reactor.stop()

class CommandChannel(channel.SSHChannel):

    ...

    def closed(self):
        reactor.stop()

    def openFailed(self, reason):
        print reason.getErrorMessage()
        reactor.stop()

class ClientCommandTransport(transport.SSHClientTransport):

    ...

    def connectionFailed(self, reason):
        print reason.getErrorMessage()
        reactor.stop()

    def connectionLost(self, reason):
        print reason.getErrorMessage()
        reactor.stop()



The problem I'm currently facing is that. The connection properly ends
and the program exits when bad data is supplied on the command line but
when the program exits cleanly CommandChannel.closed() forces a call to
ClientCommandTransport.connectionLost() and we see an exception thrown
on a connection that I thought should end cleanly:

Connection to the other side was lost in a non-clean fashion: Connection
lost.
Traceback (most recent call last):
  File &quot;/usr/lib/python2.3/site-packages/twisted/internet/posixbase.py&quot;,
line 226, in mainLoop
    self.runUntilCurrent()
  File &quot;/usr/lib/python2.3/site-packages/twisted/internet/base.py&quot;, line
555, in runUntilCurrent
    call.func(*call.args, **call.kw)
  File &quot;/usr/lib/python2.3/site-packages/twisted/internet/base.py&quot;, line
414, in _continueSystemEvent
    callable(*args, **kw)
  File &quot;/usr/lib/python2.3/site-packages/twisted/internet/base.py&quot;, line
375, in disconnectAll
    failure.Failure(main.CONNECTION_LOST))
--- &lt;exception caught here&gt; ---
  File &quot;/usr/lib/python2.3/site-packages/twisted/python/log.py&quot;, line
53, in callWithLogger
    return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
  File &quot;/usr/lib/python2.3/site-packages/twisted/python/log.py&quot;, line
38, in callWithContext
    return context.call({ILogContext: newCtx}, func, *args, **kw)
  File &quot;/usr/lib/python2.3/site-packages/twisted/python/context.py&quot;,
line 59, in callWithContext
    return self.currentContext().callWithContext(ctx, func, *args, **kw)
  File &quot;/usr/lib/python2.3/site-packages/twisted/python/context.py&quot;,
line 37, in callWithContext
    return func(*args,**kw)
  File &quot;/usr/lib/python2.3/site-packages/twisted/internet/tcp.py&quot;, line
554, in connectionLost
    Connection.connectionLost(self, reason)
  File &quot;/usr/lib/python2.3/site-packages/twisted/internet/tcp.py&quot;, line
402, in connectionLost
    protocol.connectionLost(reason)
  File &quot;code/python/sshclient/sshclient.py&quot;, line 33, in connectionLost
    reactor.stop()
  File &quot;/usr/lib/python2.3/site-packages/twisted/internet/base.py&quot;, line
342, in stop
    raise RuntimeError, &quot;can't stop reactor that isn't running&quot;
exceptions.RuntimeError: can't stop reactor that isn't running


If I remove reactor.stop() from ClientCommandTransport.connectionLost()
I then face the issue of some connection problems not being handled
correctly and the program will go idle on some bad connections.

So my question is, how can I fix my code to handle these exceptions and
all cases of bad connections and connections terminating abnormally?
Where should I implement connectionLost() and connectionFailed() and
how can I cleanly disconnect from the SSH server without seeing ugly
errors like the one above?

Thanks in advance,
Fritz



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014557.html">[Twisted-Python] a question ablout DeferredList
</A></li>
	<LI>Next message: <A HREF="014562.html">[Twisted-Python] Twisted Adapter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14558">[ date ]</a>
              <a href="thread.html#14558">[ thread ]</a>
              <a href="subject.html#14558">[ subject ]</a>
              <a href="author.html#14558">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
