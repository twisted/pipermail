<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] signal handlers and threads
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20signal%20handlers%20and%20threads&In-Reply-To=55D12038-C5E0-4839-8C9C-528334F16CC0%40slamb.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013114.html">
   <LINK REL="Next"  HREF="013116.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] signal handlers and threads</H1>
    <B>Manlio Perillo</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20signal%20handlers%20and%20threads&In-Reply-To=55D12038-C5E0-4839-8C9C-528334F16CC0%40slamb.org"
       TITLE="[Twisted-Python] signal handlers and threads">manlio_perillo at libero.it
       </A><BR>
    <I>Fri May 12 17:30:49 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="013114.html">[Twisted-Python] signal handlers and threads
</A></li>
        <LI>Next message: <A HREF="013116.html">[Twisted-Python] signal handlers and threads
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13115">[ date ]</a>
              <a href="thread.html#13115">[ thread ]</a>
              <a href="subject.html#13115">[ subject ]</a>
              <a href="author.html#13115">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Scott Lamb ha scritto:
&gt;<i> [...]
</I>&gt;&gt;<i> This works by creating a thread on the remote process (yes, Windows
</I>&gt;&gt;<i> allow this...) and let it call the function &quot;raise&quot; from the MSVCR71 DLL.
</I>&gt;<i> 
</I>&gt;<i> Wow, that is sick! I thought _I_ did weird stuff with signals!
</I>&gt;<i> 
</I>&gt;<i> So Windows provides signal(), raise(), and the usual signal numbers, but
</I>&gt;<i> no kill()? 
</I>
Yes!
<A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vclib/html/_crt_raise.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vclib/html/_crt_raise.asp</A>
<A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vclib/html/_CRT_signal.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/vclib/html/_CRT_signal.asp</A>

Note that it is supported also SIGBREAK (but not documented on msdn).

&gt;<i> Weird! Does it have pthread_kill()? sigprocmask()?
</I>&gt;<i> pthread_sigprocmask()? sigaction()? Do the semantics differ from the
</I>&gt;<i> usual ones?
</I>&gt;<i> 
</I>
No, Windows support signals because they are required by ISO C.

I have found this document:
<A HREF="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnucmg/html/ucmglp.asp">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/dnucmg/html/ucmglp.asp</A>


&gt;<i> Interesting when compared to the Cygwin stuff:
</I>&gt;<i> &lt;<A HREF="http://cygwin.com/cgi-bin/cvsweb.cgi/src/winsup/cygwin/sigproc.cc?cvsroot=src">http://cygwin.com/cgi-bin/cvsweb.cgi/src/winsup/cygwin/sigproc.cc?cvsroot=src</A>&gt;
</I>&gt;<i> 
</I>
Pass.

&gt;<i> 
</I>&gt;&gt;<i> This seems to work fine, and now I can stop a Twisted process with
</I>&gt;&gt;<i> kill.py TERM pid
</I>&gt;&gt;<i> (does twistd save the pid in a file on Windows?)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> but I'm not sure if signal handlers are thread safe.
</I>&gt;<i> 
</I>&gt;<i> In Twisted's case, it sure looks to be. See twisted/internet/base.py:
</I>&gt;<i> 
</I>&gt;<i>     def sigTerm(self, *args):
</I>&gt;<i>         &quot;&quot;&quot;Handle a SIGTERM interrupt.
</I>&gt;<i>         &quot;&quot;&quot;
</I>&gt;<i>         log.msg(&quot;Received SIGTERM, shutting down.&quot;)
</I>&gt;<i>         self.callFromThread(self.stop)
</I>&gt;<i> 
</I>
Ok, fine!

&gt;<i> Actually, &lt;<A HREF="http://docs.python.org/lib/module-signal.html">http://docs.python.org/lib/module-signal.html</A>&gt; says this:
</I>&gt;<i> 
</I>&gt;<i>     &quot;Some care must be taken if both signals and threads are used in the
</I>&gt;<i> same program. The fundamental thing to remember in using signals and
</I>&gt;<i> threads simultaneously is: always perform signal() operations in the
</I>&gt;<i> main thread of execution. Any thread can perform an alarm(),
</I>&gt;<i> getsignal(), or pause(); only the main thread can set a new signal
</I>&gt;<i> handler, and the main thread will be the only one to receive signals
</I>&gt;<i> (this is enforced by the Python signal module, even if the underlying
</I>&gt;<i> thread implementation supports sending signals to individual threads).
</I>&gt;<i> This means that signals can't be used as a means of inter-thread
</I>&gt;<i> communication. Use locks instead.&quot;
</I>&gt;<i> 
</I>
I have read this and it seems to allow what I'm doing.

&gt;<i> so the self.callFromThread() only matters if the reactor thread is not
</I>&gt;<i> Python's main thread.
</I>&gt;<i> 
</I>
There is someone who run the reactor in a child thread?

&gt;<i> And Python does seem to provide this guarantee even with your thing. See
</I>&gt;<i> signal_handler in
</I>&gt;<i> &lt;<A HREF="http://svn.python.org/projects/python/trunk/Modules/signalmodule.c">http://svn.python.org/projects/python/trunk/Modules/signalmodule.c</A>&gt;. It
</I>&gt;<i> just sets a flag to be picked up later, and only the main thread does
</I>&gt;<i> that apparently.
</I>&gt;<i> 
</I>&gt;<i> Now, I don't see any guarantee that signals always handled before
</I>&gt;<i> entering blocking calls, so they can be delayed forever if nothing else
</I>&gt;<i> wakes it up. 
</I>
But this should not be a problem in Twisted, since there are no blocking
calls.

&gt;<i> (This is like their documented note about long computations
</I>&gt;<i> but worse.) It does the &quot;normal syscall + flag handler&quot; stuff I describe
</I>&gt;<i> at &lt;<A HREF="http://www.slamb.org/projects/sigsafe/api/">http://www.slamb.org/projects/sigsafe/api/</A>&gt;. That's a problem with
</I>&gt;<i> Python's signal handling everywhere, not with your thing or Twisted.
</I>&gt;<i> 
</I>
Well, thanks!

Just to add more informations:
when killing a normal Python process with TERM, the Interpreter
terminates without calling the functions registered with atexit.

Now this is strange because the MSDN says that, by default, SIGTERM is
ignored and the Python documentation says that only an handler for
SIGINT is installed.



Regards  Manlio Perillo


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013114.html">[Twisted-Python] signal handlers and threads
</A></li>
	<LI>Next message: <A HREF="013116.html">[Twisted-Python] signal handlers and threads
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13115">[ date ]</a>
              <a href="thread.html#13115">[ thread ]</a>
              <a href="subject.html#13115">[ subject ]</a>
              <a href="author.html#13115">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
