<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Synchronous Code Fishbowl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Synchronous%20Code%20Fishbowl&In-Reply-To=447C655E.2060400%40pollenation.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013264.html">
   <LINK REL="Next"  HREF="013248.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Synchronous Code Fishbowl</H1>
    <B>Matt Goodall</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Synchronous%20Code%20Fishbowl&In-Reply-To=447C655E.2060400%40pollenation.net"
       TITLE="[Twisted-Python] Synchronous Code Fishbowl">matt at pollenation.net
       </A><BR>
    <I>Wed May 31 10:10:43 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="013264.html">[Twisted-Python] Synchronous Code Fishbowl
</A></li>
        <LI>Next message: <A HREF="013248.html">[Twisted-Python] Re: [Twisted-commits] r16956 - Branch for 2518bis	updates.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13286">[ date ]</a>
              <a href="thread.html#13286">[ thread ]</a>
              <a href="subject.html#13286">[ subject ]</a>
              <a href="author.html#13286">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Matt Goodall wrote:
&gt;<i> Ed Suominen wrote:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>Well of course, Glyph's &quot;interesting module&quot; comment was just enough of
</I>&gt;&gt;<i>a table scrap to get me running, tail wagging furiously. The result
</I>&gt;&gt;<i>(unit testing in progress) is a full-fledged SynchronousTasks object
</I>&gt;&gt;<i>that runs a priority queue of synchronous tasks with niceness
</I>&gt;&gt;<i>scheduling. See
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>* <A HREF="http://foss.eepatents.com/sAsync/browser/trunk/sasync/syncbridge.py">http://foss.eepatents.com/sAsync/browser/trunk/sasync/syncbridge.py</A>
</I>&gt;&gt;<i>* <A HREF="http://foss.eepatents.com/sAsync/browser/trunk/test/syncbridge.py">http://foss.eepatents.com/sAsync/browser/trunk/test/syncbridge.py</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I was going to post again last night about how the PriorityQueue.get()
</I>&gt;<i> would never block once something had been put() into it, but I see
</I>&gt;<i> you've fixed that bug by clearing the event semaphore. Unfortunately,
</I>&gt;<i> the code now has a race condition.
</I>&gt;<i> 
</I>&gt;<i> If the SynchronousQueue._workOnTasks thread is pre-empted in
</I>&gt;<i> PriorityQueue.get() between &quot;if self.empty():&quot; and &quot;self.event.clear()&quot;,
</I>&gt;<i> and another thread calls PriorityQueue.put() then the event semaphore
</I>&gt;<i> set during put() will be cleared when get() continues.
</I>&gt;<i> 
</I>&gt;<i> OK, that was horrible to write so here's a picture instead ;-) ...
</I>&gt;<i> 
</I>&gt;<i> Thread 1                                Thread 2
</I>&gt;<i> 
</I>&gt;<i> # Calls get()
</I>&gt;<i> self.event.wait()
</I>&gt;<i> result = heapq.heappop(self.list)
</I>&gt;<i> if self.empty():
</I>&gt;<i> 
</I>&gt;<i> &lt;------------------ Thread 2 preempts Thread 1 ----------------------&gt;
</I>&gt;<i> 
</I>&gt;<i>                                        # Calls put()
</I>&gt;<i>                                        heapq.heappush(self.list, item)
</I>&gt;<i>                                        self.event.set()
</I>&gt;<i> 
</I>&gt;<i> &lt;---------------------- Thread 1 continues --------------------------&gt;
</I>&gt;<i> 
</I>&gt;<i>     self.event.clear()
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> PriorityQueue should probably be using a Condition to protect access to
</I>&gt;<i> the heapq list *and* wait for something to be posted to it. See
</I>&gt;<i> &lt;<A HREF="http://docs.python.org/lib/condition-objects.html">http://docs.python.org/lib/condition-objects.html</A>&gt;.
</I>
I notice you've updated syncbridge to use a Condition now. Looks better
to me, although there's another bug and an improvement suggestion.

First up is that it should be &quot;while self.empty(): self.cv.wait()&quot;.

Whenever something is put on the queue notify() is always called to wake
a consumer thread. However, there may already be a consumer thread
tearing around a loop taking items from the queue and, critically, never
waiting until the queue is empty.

By the time the newly woken consumer thread actually calls heappop to
take an item the existing consumer thread may have emptied the queue.

Ths improvement suggestion is to put the conditional's release() in a
finally block to ensure it actually happens. (Why isn't the Condition
example in the documentation written expecting exceptions?)

Anyway, this all makes get() and put() look something like:


    def get(self):
        self.cv.acquire()
        try:
            while self.empty():
                self.cv.wait()
            return heapq.heappop(self.list)
        finally:
            self.cv.release()

    def put(self, item):
        self.cv.acquire()
        try:
            heapq.heappush(self.list, item)
            self.cv.notify()
        finally:
            self.cv.release()


After that, I think the queue implementation is ok.


And some people insist that threading is easy ;-).


- Matt


-- 
     __
    /  \__     Matt Goodall, Pollenation Internet Ltd
    \__/  \    w: <A HREF="http://www.pollenation.net">http://www.pollenation.net</A>
  __/  \__/    e: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">matt at pollenation.net</A>
 /  \__/  \    t: +44 (0)113 2252500
 \__/  \__/
 /  \          Any views expressed are my own and do not necessarily
 \__/          reflect the views of my employer.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013264.html">[Twisted-Python] Synchronous Code Fishbowl
</A></li>
	<LI>Next message: <A HREF="013248.html">[Twisted-Python] Re: [Twisted-commits] r16956 - Branch for 2518bis	updates.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13286">[ date ]</a>
              <a href="thread.html#13286">[ thread ]</a>
              <a href="subject.html#13286">[ subject ]</a>
              <a href="author.html#13286">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
