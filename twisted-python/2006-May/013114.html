<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] signal handlers and threads
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20signal%20handlers%20and%20threads&In-Reply-To=4464DA57.3090205%40libero.it">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013113.html">
   <LINK REL="Next"  HREF="013115.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] signal handlers and threads</H1>
    <B>Scott Lamb</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20signal%20handlers%20and%20threads&In-Reply-To=4464DA57.3090205%40libero.it"
       TITLE="[Twisted-Python] signal handlers and threads">slamb at slamb.org
       </A><BR>
    <I>Fri May 12 16:33:46 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="013113.html">[Twisted-Python] signal handlers and threads
</A></li>
        <LI>Next message: <A HREF="013115.html">[Twisted-Python] signal handlers and threads
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13114">[ date ]</a>
              <a href="thread.html#13114">[ thread ]</a>
              <a href="subject.html#13114">[ subject ]</a>
              <a href="author.html#13114">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On May 12, 2006, at 11:56 AM, Manlio Perillo wrote:
&gt;<i> Hi.
</I>&gt;<i>
</I>&gt;<i> I have written a small module for sending signals to a &quot;foreign&quot;  
</I>&gt;<i> Python
</I>&gt;<i> process on Windows 2000/XP.
</I>&gt;<i>
</I>&gt;<i> The trunk is on
</I>&gt;<i> <A HREF="http://svn.berlios.de/svnroot/repos/pykill32/trunk">http://svn.berlios.de/svnroot/repos/pykill32/trunk</A>
</I>&gt;<i>
</I>&gt;<i> In this way I can send KILL, TERM and so, like in a POSIX system.
</I>&gt;<i>
</I>&gt;<i> This works by creating a thread on the remote process (yes, Windows
</I>&gt;<i> allow this...) and let it call the function &quot;raise&quot; from the  
</I>&gt;<i> MSVCR71 DLL.
</I>
Wow, that is sick! I thought _I_ did weird stuff with signals!

So Windows provides signal(), raise(), and the usual signal numbers,  
but no kill()? Weird! Does it have pthread_kill()? sigprocmask()?  
pthread_sigprocmask()? sigaction()? Do the semantics differ from the  
usual ones?

Interesting when compared to the Cygwin stuff: &lt;<A HREF="http://cygwin.com/cgi-">http://cygwin.com/cgi-</A> 
bin/cvsweb.cgi/src/winsup/cygwin/sigproc.cc?cvsroot=src&gt;

&gt;<i> This seems to work fine, and now I can stop a Twisted process with
</I>&gt;<i> kill.py TERM pid
</I>&gt;<i> (does twistd save the pid in a file on Windows?)
</I>&gt;<i>
</I>&gt;<i> but I'm not sure if signal handlers are thread safe.
</I>
In Twisted's case, it sure looks to be. See twisted/internet/base.py:

     def sigTerm(self, *args):
         &quot;&quot;&quot;Handle a SIGTERM interrupt.
         &quot;&quot;&quot;
         log.msg(&quot;Received SIGTERM, shutting down.&quot;)
         self.callFromThread(self.stop)

Actually, &lt;<A HREF="http://docs.python.org/lib/module-signal.html">http://docs.python.org/lib/module-signal.html</A>&gt; says this:

     &quot;Some care must be taken if both signals and threads are used in  
the same program. The fundamental thing to remember in using signals  
and threads simultaneously is: always perform signal() operations in  
the main thread of execution. Any thread can perform an alarm(),  
getsignal(), or pause(); only the main thread can set a new signal  
handler, and the main thread will be the only one to receive signals  
(this is enforced by the Python signal module, even if the underlying  
thread implementation supports sending signals to individual  
threads). This means that signals can't be used as a means of inter- 
thread communication. Use locks instead.&quot;

so the self.callFromThread() only matters if the reactor thread is  
not Python's main thread.

And Python does seem to provide this guarantee even with your thing.  
See signal_handler in &lt;<A HREF="http://svn.python.org/projects/python/trunk/">http://svn.python.org/projects/python/trunk/</A> 
Modules/signalmodule.c&gt;. It just sets a flag to be picked up later,  
and only the main thread does that apparently.

Now, I don't see any guarantee that signals always handled before  
entering blocking calls, so they can be delayed forever if nothing  
else wakes it up. (This is like their documented note about long  
computations but worse.) It does the &quot;normal syscall + flag handler&quot;  
stuff I describe at &lt;<A HREF="http://www.slamb.org/projects/sigsafe/api/">http://www.slamb.org/projects/sigsafe/api/</A>&gt;.  
That's a problem with Python's signal handling everywhere, not with  
your thing or Twisted.

Regards,
Scott

-- 
Scott Lamb &lt;<A HREF="http://www.slamb.org/">http://www.slamb.org/</A>&gt;




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013113.html">[Twisted-Python] signal handlers and threads
</A></li>
	<LI>Next message: <A HREF="013115.html">[Twisted-Python] signal handlers and threads
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13114">[ date ]</a>
              <a href="thread.html#13114">[ thread ]</a>
              <a href="subject.html#13114">[ subject ]</a>
              <a href="author.html#13114">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
