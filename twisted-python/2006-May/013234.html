<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Synchronous Code Fishbowl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Synchronous%20Code%20Fishbowl&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="013233.html">
   <LINK REL="Next"  HREF="013242.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Synchronous Code Fishbowl</H1>
    <B>Ed Suominen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Synchronous%20Code%20Fishbowl&In-Reply-To="
       TITLE="[Twisted-Python] Synchronous Code Fishbowl">general at eepatents.com
       </A><BR>
    <I>Sat May 27 21:48:59 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="013233.html">[Twisted-Python] Twisted 2.4.0 released
</A></li>
        <LI>Next message: <A HREF="013242.html">[Twisted-Python] Synchronous Code Fishbowl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13234">[ date ]</a>
              <a href="thread.html#13234">[ thread ]</a>
              <a href="subject.html#13234">[ subject ]</a>
              <a href="author.html#13234">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The dialogue copied below shows yet another example of the frustrations
that arise when trying to bridge the chasm between Twisted and the
synchronous rest of the world.

This latest episode inspired the idea of a synchronous code fishbowl
that offers well-behaved Twisted code a deferToQueue() method for
running badly-behaved blocking code.

See <A HREF="http://foss.eepatents.com/sAsync/browser/branches/syncbridge.py">http://foss.eepatents.com/sAsync/browser/branches/syncbridge.py</A>

Comments?

- Ed Suominen


-------- Original Message --------
Michael Bayer wrote:
&gt;<i> why are you using twisted *with* threads ?  didnt we all agree that was
</I>&gt;<i> sort of unnecessary ?
</I>
Twisted operates without needing to run *in* a thread by doing
everything asynchronously. Every call made via the Twisted event loop
must either return (synchronous) results very quickly or return an
immediate reference to an eventual result (thus operating
asynchronously). The objects that hold those immediate references are
called &quot;deferreds&quot; in TWisted parlance.

Twisted runs most all of its internal operations with appropriate
chunking and use of select() to keep the asynchronous event loop humming
along nicely, but it has no control over how other libraries do things.
When an external library like SQLAlchemy presents a blocking call like
select(...).execute.fetchall(), the only way to make that call &quot;play
nice&quot; with Twisted by immediately returning a deferred to the eventual
result is by having TWisted run it in a thread. It includes the
deferToThread() function for that express purpose.

&gt;<i> (this goes to my point that twisted is a pain in the butt...)
</I>
Perhaps, but asynchronous code is a whole different way of thinking that
some of us actually find cleaner and more intuitive than blocking +
threads. What I'm trying to do with sAsync is put the &quot;pain in the butt&quot;
associated with making synchronous and asynchronous code work together
firmly behind the scenes for Twisted users, at least as far as
interacting with SQLAlchemy is concerned.

&gt;<i> anyway, SA 0.2 uses the same idea for sqlite threading as 0.1....it
</I>&gt;<i> maintains each connection thread locally since you cant share a sqlite
</I>&gt;<i> connection between threads.   im also not sure what youre talking about
</I>&gt;<i> with a &quot;thread local copy of the engine&quot;, if thats something youre doing
</I>&gt;<i> on your end, you might want to not do that.  use Connection objects
</I>&gt;<i> instead theyre much more portable.
</I>
Mike, I remember you telling me a while ago that SA somehow figures out
how to make things work with the engine. That was after I spent a lot of
time trying to re-engineer the wheel, to great frustration on my part. I
followed your advice, ditched my thread-local code, and got SA
transactions just fine (based on the engine) to run in arbitrary
threads. Now it's not working in SA 0.2. Could you point out what's
changed in regard to the engine vs. threads vs. sqlite?

I'd rather not change everything under the hood (e.g., using connections
somehow) if I don't have to. The lesson of not trying to re-engineer
what SA handled fine on its own is still with me. :-)

Best regards, Ed

&gt;<i> On May 27, 2006, at 6:57 PM, Ed Suominen wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> My sAsync project relies on Twisted to maintain a thread pool. It runs
</I>&gt;&gt;<i> database transactions in some available thread via Twisted's
</I>&gt;&gt;<i> deferToThread() function. See the transact function in
</I>&gt;&gt;<i> <A HREF="http://foss.eepatents.com/sAsync/browser/trunk/sasync/database.py">http://foss.eepatents.com/sAsync/browser/trunk/sasync/database.py</A> for
</I>&gt;&gt;<i> details.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That arrangement created no problem with SQLite and SA 0.1, even though
</I>&gt;&gt;<i> SQLite does not allow sharing of connections between threads. Somehow,
</I>&gt;&gt;<i> SA 0.1 made the transaction run in its thread with a thread-local copy
</I>&gt;&gt;<i> of the engine and table that was created in the main thread. I never
</I>&gt;&gt;<i> figured out how, but it just worked.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It doesn't work in SA 0.2, however. I either get the error when trying
</I>&gt;&gt;<i> to use the main-thread table in the threaded transaction, or have no
</I>&gt;&gt;<i> table available in the thread because it wasn't created there. Now I'm
</I>&gt;&gt;<i> trying to figure out how to put humpty dumpty back together again. Any
</I>&gt;&gt;<i> suggestions?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Best regards, Ed
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="013233.html">[Twisted-Python] Twisted 2.4.0 released
</A></li>
	<LI>Next message: <A HREF="013242.html">[Twisted-Python] Synchronous Code Fishbowl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#13234">[ date ]</a>
              <a href="thread.html#13234">[ thread ]</a>
              <a href="subject.html#13234">[ subject ]</a>
              <a href="author.html#13234">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
