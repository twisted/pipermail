<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] SMTPConnectError as a side effect on connection	lost
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SMTPConnectError%20as%20a%20side%20effect%20on%20connection%0A%09lost&In-Reply-To=%3CCAFycZ9eK%2BSVGfuM-pT7XydeQZDF90Hhy5_77wU%2BJxuu93vWr-g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064199.html">
   <LINK REL="Next"  HREF="064204.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] SMTPConnectError as a side effect on connection	lost</H1>
    <B>Adi Roiban</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SMTPConnectError%20as%20a%20side%20effect%20on%20connection%0A%09lost&In-Reply-To=%3CCAFycZ9eK%2BSVGfuM-pT7XydeQZDF90Hhy5_77wU%2BJxuu93vWr-g%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] SMTPConnectError as a side effect on connection	lost">adi at roiban.ro
       </A><BR>
    <I>Sat Nov 25 21:52:20 MST 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064199.html">[Twisted-Python] Need help fixing txkube unit test with	latest	Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="064204.html">[Twisted-Python] SMTPConnectError as a side effect on	connection	lost
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31741">[ date ]</a>
              <a href="thread.html#31741">[ thread ]</a>
              <a href="subject.html#31741">[ subject ]</a>
              <a href="author.html#31741">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I hit a strange behavior in which the clone connection error from one
test is raised as the error for another test.

The tests are not written using trial, but I have thousands of other
tests and I have never seen this behaviour.

I tried to put a self-contained example at

<A HREF="https://gist.github.com/adiroiban/edc0776e3337d0bd3f093aa0f2819deb#file-test-py">https://gist.github.com/adiroiban/edc0776e3337d0bd3f093aa0f2819deb#file-test-py</A>

you will need to run it in a virtulenv as it will pull quite a few of
dependencies.

I have traced the error to this code
<A HREF="https://github.com/twisted/twisted/blob/03dcdfb5933c4f83ce6aad3f4bdf080cda65584c/src/twisted/mail/smtp.py#L1943">https://github.com/twisted/twisted/blob/03dcdfb5933c4f83ce6aad3f4bdf080cda65584c/src/twisted/mail/smtp.py#L1943</A>

            if err.check(error.ConnectionDone):
                err.value = smtp.SMTPConnectError(
                    -1, &quot;Unable to connect to server.&quot;)
            self.result.errback(err.value)

It looks to me like the initial failure (err) is hijacked here and its
errors will never be cleared.

If I am doing something like

            if err.check(error.ConnectionDone):
                value = smtp.SMTPConnectError(
                    -1, &quot;Unable to connect to server.&quot;)
            else:
                value = err.value
            err.cleanFailure()
            self.result.errback(value)

then the test will pass.
But I still don't understand how the error from one client request is
passed to another client request when they are using different
servers.

Do you see anything suspicious with this code?

Thanks!
-- 
Adi Roiban

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064199.html">[Twisted-Python] Need help fixing txkube unit test with	latest	Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="064204.html">[Twisted-Python] SMTPConnectError as a side effect on	connection	lost
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31741">[ date ]</a>
              <a href="thread.html#31741">[ thread ]</a>
              <a href="subject.html#31741">[ subject ]</a>
              <a href="author.html#31741">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
