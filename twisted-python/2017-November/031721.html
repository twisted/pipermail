<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] conch server can't git clone
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20conch%20server%20can%27t%20git%20clone&In-Reply-To=%3C1509950249.534493.1162732928.57358C84%40webmail.messagingengine.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031720.html">
   <LINK REL="Next"  HREF="031722.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] conch server can't git clone</H1>
    <B>Mark Williams</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20conch%20server%20can%27t%20git%20clone&In-Reply-To=%3C1509950249.534493.1162732928.57358C84%40webmail.messagingengine.com%3E"
       TITLE="[Twisted-Python] conch server can't git clone">mrw at enotuniq.org
       </A><BR>
    <I>Sun Nov  5 23:37:29 MST 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031720.html">[Twisted-Python] conch server can't git clone
</A></li>
        <LI>Next message (by thread): <A HREF="031722.html">[Twisted-Python] conch server can't git clone
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31721">[ date ]</a>
              <a href="thread.html#31721">[ thread ]</a>
              <a href="subject.html#31721">[ subject ]</a>
              <a href="author.html#31721">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, Nov 5, 2017, at 08:48 PM, Glyph wrote:
&gt;<i> I tried to `git clone` a repository on said server, and I saw these logs on the server:
</I>&gt;<i>
</I>&gt;&gt;<i> 2017-11-06T04:45:49+0000 [SSHChannel session (0) on SSHService 'ssh-connection' on SSHServerTransport,817,1.2.3.4] channel open
</I>&gt;&gt;<i> 2017-11-06T04:45:49+0000 [SSHChannel session (0) on SSHService 'ssh-connection' on SSHServerTransport,817,1.2.3.4] unhandled request for env
</I>&gt;&gt;<i> 2017-11-06T04:45:49+0000 [SSHChannel session (0) on SSHService 'ssh-connection' on SSHServerTransport,817,1.2.3.4] executing command &quot;git-upload-pack '/site'&quot;
</I>&gt;&gt;<i> 2017-11-06T04:45:51+0000 [-] sending eof
</I>&gt;&gt;<i> 2017-11-06T04:45:51+0000 [-] exitCode: 0
</I>&gt;&gt;<i> 2017-11-06T04:45:51+0000 [-] sending request 'exit-status'
</I>&gt;&gt;<i> 2017-11-06T04:45:51+0000 [SSHChannel session (0) on SSHService 'ssh-connection' on SSHServerTransport,817,1.2.3.4] sending close 0
</I>&gt;&gt;<i> 2017-11-06T04:45:51+0000 [SSHChannel session (0) on SSHService 'ssh-connection' on SSHServerTransport,817,1.2.3.4] remote close
</I>&gt;&gt;<i> 2017-11-06T04:45:51+0000 [SSHChannel session (0) on SSHService 'ssh-connection' on SSHServerTransport,817,1.2.3.4] shell closed
</I>&gt;&gt;<i> 2017-11-06T04:45:51+0000 [SSHServerTransport,817,1.2.3.4] Got remote error, code 11
</I>&gt;&gt;<i> reason: disconnected by user
</I>&gt;&gt;<i> 2017-11-06T04:45:51+0000 [SSHServerTransport,817,1.2.3.4] avatar user logging out (0)
</I>&gt;&gt;<i> 2017-11-06T04:45:51+0000 [SSHServerTransport,817,1.2.3.4] connection lost
</I>
This looks normal.  I see the same output from a Conch server against
which all git clone calls succeed.

Unfortunately, normal is confusing, so I'll explain my reading of your
log.  The most important part of this is that the 'sending eof' just
means the 'git-upload-pack' process closed stdout and err.  In other
words, I think 'git-upload-pack' is the problem.

The server creates an SSHChanel (&quot;channel open&quot;), then complains that it
cannot answer the client's request for environment variables
(<A HREF="https://tools.ietf.org/html/rfc4254.html#section-6.4">https://tools.ietf.org/html/rfc4254.html#section-6.4</A>) because Conch
doesn't implement that channel request type.  
Conch should probably support it:
<A HREF="https://twistedmatrix.com/trac/ticket/9315">https://twistedmatrix.com/trac/ticket/9315</A>

The 'git-upload-pack' command appears to execute successfully: its exit
status is 0 and  SSHSessionProcessProtocol send that back to the client,
per
<A HREF="https://github.com/twisted/twisted/blob/twisted-17.9.0/src/twisted/conch/ssh/session.py#L276-L279">https://github.com/twisted/twisted/blob/twisted-17.9.0/src/twisted/conch/ssh/session.py#L276-L279</A>

The &quot;sending eof&quot; message you identified as a smoking gun occurs because
'git-upload-pack' closed both stdout and stderr:
<A HREF="https://github.com/twisted/twisted/blob/twisted-17.9.0/src/twisted/conch/ssh/session.py#L220-L221">https://github.com/twisted/twisted/blob/twisted-17.9.0/src/twisted/conch/ssh/session.py#L220-L221</A>

The server's claim that a 'remote error' occurred is misleading; Conch
calls the SSH transport's receiveError method for all DISCONNECT
messages:

<A HREF="https://github.com/twisted/twisted/blob/twisted-17.9.0/src/twisted/conch/ssh/transport.py#L909-L924">https://github.com/twisted/twisted/blob/twisted-17.9.0/src/twisted/conch/ssh/transport.py#L909-L924</A>

including 11, SSH_DISCONNECT_BY_APPLICATION, which means that the
application willingly terminated the connection:

<A HREF="https://tools.ietf.org/html/rfc4253.html#section-11.1">https://tools.ietf.org/html/rfc4253.html#section-11.1</A> 

OpenSSH's own logging does not consider SSH_DISCONNECT_BY_APPLICATION to
be an error:

<A HREF="https://github.com/openssh/openssh-portable/blob/V_7_6_P1/packet.c#L1703-L1708">https://github.com/openssh/openssh-portable/blob/V_7_6_P1/packet.c#L1703-L1708</A>

Maybe Conch should also filter this:
<A HREF="https://twistedmatrix.com/trac/ticket/9316">https://twistedmatrix.com/trac/ticket/9316</A>

&gt;<i> Anyone have any idea how I could debug this?  
</I>
You can export the GIT_TRACE_PACKET environment variable on the client
side, which makes git emit packet-level logs:

<A HREF="https://git-scm.com/book/gr/v2/Git-Internals-Environment-Variables">https://git-scm.com/book/gr/v2/Git-Internals-Environment-Variables</A>

Maybe that will help us figure out why git-pack-upload is terminating
early.

--
  Mark Williams
  <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mrw at enotuniq.org</A>

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031720.html">[Twisted-Python] conch server can't git clone
</A></li>
	<LI>Next message (by thread): <A HREF="031722.html">[Twisted-Python] conch server can't git clone
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31721">[ date ]</a>
              <a href="thread.html#31721">[ thread ]</a>
              <a href="subject.html#31721">[ subject ]</a>
              <a href="author.html#31721">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
