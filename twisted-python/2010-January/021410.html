<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Many connections and TIME_WAIT
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Many%20connections%20and%20TIME_WAIT&In-Reply-To=634095dc1001262050t5b5e54eayd2de93afa013f3b2%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021408.html">
   <LINK REL="Next"  HREF="021414.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Many connections and TIME_WAIT</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Many%20connections%20and%20TIME_WAIT&In-Reply-To=634095dc1001262050t5b5e54eayd2de93afa013f3b2%40mail.gmail.com"
       TITLE="[Twisted-Python] Many connections and TIME_WAIT">exarkun at twistedmatrix.com
       </A><BR>
    <I>Wed Jan 27 08:05:16 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021408.html">[Twisted-Python] Many connections and TIME_WAIT
</A></li>
        <LI>Next message: <A HREF="021414.html">[Twisted-Python] understanding deferreds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21410">[ date ]</a>
              <a href="thread.html#21410">[ thread ]</a>
              <a href="subject.html#21410">[ subject ]</a>
              <a href="author.html#21410">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04:50 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">donal.mcmullan at gmail.com</A> wrote:
&gt;<i>I've been prototyping a client that connects to thousands of servers 
</I>&gt;<i>and
</I>&gt;<i>calls some method. It's not real important to me at this stage whether
</I>&gt;<i>that's via xmlrpc, perspective broker, or something else.
</I>&gt;<i>
</I>&gt;<i>What seems to happen on the client machine is that each network 
</I>&gt;<i>connection
</I>&gt;<i>that gets opened and then closed goes into a TIME_WAIT state, and 
</I>&gt;<i>eventually
</I>&gt;<i>there are so many connections in that state that it's impossible to 
</I>&gt;<i>create
</I>&gt;<i>any more.
</I>
Yep.  That's what happens to a TCP connection when you close it.
&gt;<i>
</I>&gt;<i>I'm keeping an eye on the output of
</I>&gt;<i>netstat -an | wc -l
</I>&gt;<i>Initially I've got 569 entries there. When I run my test client, that 
</I>&gt;<i>ramps
</I>&gt;<i>up really quickly and peaks at about 2824. At that point, the client 
</I>&gt;<i>reports
</I>&gt;<i>a callRemoteFailure:
</I>
Presumably these numbers have something to do with how quickly you're 
opening and closing new connections.  TIME_WAIT lasts for 2MSL (4 
minutes) to ensure that a future connection doesn't receive data 
intended for a previous connection (clearly a bad thing).

However... 2824 is a pretty low number at which to run out of sockets. 
Perhaps you're running this software on Windows?  I think Windows has a 
ridiculously small number of &quot;client sockets&quot; allocated by default.  I 
seem to recall this being something you can change with a registry edit 
or something like that.

Another option would be to switch to a POSIX-platform instead.

If you're *not* on Windows, then this is odd and perhaps bears further 
scrutiny.
&gt;<i>
</I>&gt;<i>callRemoteFailure [Failure instance: Traceback (failure with no 
</I>&gt;<i>frames):
</I>&gt;<i>&lt;class 'twisted.internet.error.ConnectionLost'&gt;: Connection to the 
</I>&gt;<i>other
</I>&gt;<i>side was lost in a non-clean fashion: Connection lost.
</I>
This isn't exactly how I'd expect it to fail, but I also don't know what 
&quot;callRemoteFailure&quot; is or where it comes from, so maybe that's not too 
surprising.
&gt;<i>Increasing the file descriptor limits doesn't seem to have any effect 
</I>&gt;<i>on
</I>&gt;<i>this.
</I>
Quite so.  The process has, after all, already closed these sockets. 
They no longer count towards the process's file descriptor limit (oh 
dear, I suppose you're not using Windows if you have a file descriptor 
limit to raise).
&gt;<i>
</I>&gt;<i>Is there an established Twisted sanctioned canonical way to free up 
</I>&gt;<i>this
</I>&gt;<i>resource? Or am I doing something wrong? I'm looking into tweaking
</I>&gt;<i>SO_REUSEADDR and SO_LINGER - that sound sane?
</I>&gt;<i>
</I>&gt;<i>Just tapping the lazywebs to see if anyone's already seen this in the 
</I>&gt;<i>wild.
</I>
On most reasonably configured Linux machines, you shouldn't run into 
this problem until you're doing at least an order of magnitude more 
work.  Many times, I have run clients that do many thousands of new 
connections per second, resulting in tens of thousands of TIME_WAIT 
sockets on the system with no problem.  So, I'm not sure why you're 
running into this after only a few thousand.

Jean-Paul

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021408.html">[Twisted-Python] Many connections and TIME_WAIT
</A></li>
	<LI>Next message: <A HREF="021414.html">[Twisted-Python] understanding deferreds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21410">[ date ]</a>
              <a href="thread.html#21410">[ thread ]</a>
              <a href="subject.html#21410">[ subject ]</a>
              <a href="author.html#21410">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
