<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] A pseudo-deferred class that can be canceled
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20pseudo-deferred%20class%20that%20can%20be%20canceled&In-Reply-To=%3C19267.13558.486114.470310%40jon.es%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053821.html">
   <LINK REL="Next"  HREF="053814.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] A pseudo-deferred class that can be canceled</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20pseudo-deferred%20class%20that%20can%20be%20canceled&In-Reply-To=%3C19267.13558.486114.470310%40jon.es%3E"
       TITLE="[Twisted-Python] A pseudo-deferred class that can be canceled">terry at jon.es
       </A><BR>
    <I>Tue Jan  5 05:47:50 MST 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053821.html">[Twisted-Python] A pseudo-deferred class that can be canceled
</A></li>
        <LI>Next message (by thread): <A HREF="053814.html">[Twisted-Python] A pseudo-deferred class that can be canceled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53813">[ date ]</a>
              <a href="thread.html#53813">[ thread ]</a>
              <a href="subject.html#53813">[ subject ]</a>
              <a href="author.html#53813">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again Glyph, Andrew

Below is a simpler and more flexible ControllableDeferred class.

The idea is simple: you want a deferred that you can call/errback yourself,
and which you can also deactivate so that it never fires.  This is done by
manipulating two normal deferreds (self, and a deferred received from
maybeDeferred). This ControllableDeferred class sits in the middle and will
(a) pass on the normal result (via chainDeferred) if it arrives first, or
(b) if called by the user, fire with the user-supplied value, or (c) if
deactivated by the user, never fire. In cases b and c it will ignore the
result (if any ever arrives) from the function originally called.

In summary, this provides two things you can't ordinarily do when you get a
deferred (d) back from calling a function:

  - Call d yourself, thereby firing it immediately.
  - Deactivate d, so that it never fires.

The code below could be a bit more sophisticated. E.g., it could tell you
if you try to call a deferred you've deactivated. It should probably use an
attribute name other than _called.  I've kept it sparse for now though so
the general idea is clearer.  I changed its name to reflect that the
deferred is more controllable.

Terry

---

from twisted.internet import defer


class ControllableDeferred(defer.Deferred):    
    def __init__(self, f, *args, **kw):
        defer.Deferred.__init__(self)
        self._called = False
        self._calld = defer.maybeDeferred(f, *args, **kw).addBoth(self._fire)

    def _fire(self, ign):
        if not self._called:
            self._called = True
            self._calld.chainDeferred(self)

    def callback(self, result):
        if not self._called:
            self._called = True
            defer.Deferred.callback(self, result)

    def errback(self, fail=None):
        if not self._called:
            self._called = True
            defer.Deferred.callback(self, fail)

    def deactivate(self):
        self._called = True


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053821.html">[Twisted-Python] A pseudo-deferred class that can be canceled
</A></li>
	<LI>Next message (by thread): <A HREF="053814.html">[Twisted-Python] A pseudo-deferred class that can be canceled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53813">[ date ]</a>
              <a href="thread.html#53813">[ thread ]</a>
              <a href="subject.html#53813">[ subject ]</a>
              <a href="author.html#53813">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
