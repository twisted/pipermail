<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted hangs when using pyapns
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20hangs%20when%20using%20pyapns&In-Reply-To=%3CCACL3mTBT%3DkzRTEE%3DoaQSohFphGFB3ttw-tKM2k3AxcY%3DrRpZyA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028885.html">
   <LINK REL="Next"  HREF="028889.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted hangs when using pyapns</H1>
    <B>Ni Wesley</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20hangs%20when%20using%20pyapns&In-Reply-To=%3CCACL3mTBT%3DkzRTEE%3DoaQSohFphGFB3ttw-tKM2k3AxcY%3DrRpZyA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Twisted hangs when using pyapns">nispray at gmail.com
       </A><BR>
    <I>Tue Oct 14 19:27:18 MDT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="028885.html">[Twisted-Python] Twisted hangs when using pyapns
</A></li>
        <LI>Next message: <A HREF="028889.html">[Twisted-Python] Twisted hangs when using pyapns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28888">[ date ]</a>
              <a href="thread.html#28888">[ thread ]</a>
              <a href="subject.html#28888">[ subject ]</a>
              <a href="author.html#28888">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
   The code is from our partner, so currently I won't change their code
until I address this issue.
The used pyapns code is here:  <A HREF="https://github.com/samuraisam/pyapns">https://github.com/samuraisam/pyapns</A>
And start twisted service by command :  twistd -r epoll web
--class=pyapns.server.APNSServer --port=7077

And start twisted service by command :  twistd -r epoll web
--class=pyapns.server.APNSServer --port=7077

And here is function of our code to do push action:
def __send_push(push_app_id, org_apns_cert, device_apns_token, payload):
    &quot;&quot;&quot;
    This method will send the actual push to the device, it will first try
to send assuming we already have
    provisioned this org cert, if it fails if will provision, this way we
don't create too many connections
    &quot;&quot;&quot;
    pyapns.configure({'HOST': MDM_PYAPNS_HOST})
    try:
        pyapns.notify(push_app_id, device_apns_token, payload)
    except UnknownAppID as e:
        # this is an expected exception where connection to this cert is
killed or we are sending this push
        # for the first time, in this case we need to provision first and
then try notify again
        current_app.logger.info(u&quot;Couldn't find app_id for this push, retry
&quot;)
        try:
            pyapns.provision(push_app_id, org_apns_cert, 'production')
            pyapns.notify(push_app_id, device_apns_token, payload)
        except Exception as exc:
            current_app.logger.exception(exc)
    except Exception as exc:
        current_app.logger.exception(exc)

Could you please help have a look?

Thanks.
Wesley

2014-10-15 6:38 GMT+08:00 Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;:

&gt;<i>
</I>&gt;<i> On Oct 14, 2014, at 1:06 AM, Ni Wesley &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">nispray at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> Hi all,
</I>&gt;<i>    I don't know if here is the right place.
</I>&gt;<i> I hit a problem with pyapns which is based on twisted.
</I>&gt;<i>
</I>&gt;<i> So, I get code from our parter and setup up env involving interacting with
</I>&gt;<i> APNS for IOS pushing work.
</I>&gt;<i>
</I>&gt;<i> I hit the problem that twisted hangs after a while's idle, I mean, when I
</I>&gt;<i> start twisted with command:
</I>&gt;<i> twistd -r epoll web --class=pyapns.server.APNSServer --port=7077
</I>&gt;<i>
</I>&gt;<i> Then, raise an notification to IOS device by pyapns(
</I>&gt;<i> <A HREF="https://github.com/samuraisam/pyapns">https://github.com/samuraisam/pyapns</A>),it's OK.
</I>&gt;<i>
</I>&gt;<i> However, if I let the system alone for a while, then, new raised
</I>&gt;<i> notifications are all failed, what's more, if now I kill twisted process,
</I>&gt;<i> and restart with the above command again, push operations are successful
</I>&gt;<i> again.
</I>&gt;<i>
</I>&gt;<i> I use python2.7 and twisted 14.0.0 on Redhat6.4.
</I>&gt;<i>
</I>&gt;<i> So, anyone has hit this problem?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> pyapns uses threads very heavily, and so my guess would be most likely
</I>&gt;<i> that you're calling a Twisted API from a non-main thread.  Without seeing
</I>&gt;<i> the code it's impossible to say.
</I>&gt;<i>
</I>&gt;<i> There's some Twisted-based apache2-licensed APNS integration code
</I>&gt;<i> available here: &lt;
</I>&gt;<i> <A HREF="https://trac.calendarserver.org/browser/CalendarServer/trunk/calendarserver/push/applepush.py">https://trac.calendarserver.org/browser/CalendarServer/trunk/calendarserver/push/applepush.py</A>&gt;.
</I>&gt;<i> Unfortunately it is a little bound up with internal implementation details
</I>&gt;<i> of calendar server, but it's *almost* generic and it might be worth the
</I>&gt;<i> effort to extract, since it will almost certainly give you more robust
</I>&gt;<i> behavior than integrating pyapns and Twisted.
</I>&gt;<i>
</I>&gt;<i> -glyph
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
&#25105;&#26159;nispray&#20808;&#29983;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20141015/9da4b907/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20141015/9da4b907/attachment-0001.html</A>&gt;
</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028885.html">[Twisted-Python] Twisted hangs when using pyapns
</A></li>
	<LI>Next message: <A HREF="028889.html">[Twisted-Python] Twisted hangs when using pyapns
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28888">[ date ]</a>
              <a href="thread.html#28888">[ thread ]</a>
              <a href="subject.html#28888">[ subject ]</a>
              <a href="author.html#28888">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
