<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Dealing with an intermittent PB server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Dealing%20with%20an%20intermittent%20PB%20server&In-Reply-To=%3C20050217010522.GA3084%40wildfire.net.ic.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="042093.html">
   <LINK REL="Next"  HREF="042100.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Dealing with an intermittent PB server</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Dealing%20with%20an%20intermittent%20PB%20server&In-Reply-To=%3C20050217010522.GA3084%40wildfire.net.ic.ac.uk%3E"
       TITLE="[Twisted-Python] Dealing with an intermittent PB server">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Wed Feb 16 18:05:22 MST 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="042093.html">[Twisted-Python] Dealing with an intermittent PB server
</A></li>
        <LI>Next message (by thread): <A HREF="042100.html">[Twisted-Python] Dealing with an intermittent PB server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42098">[ date ]</a>
              <a href="thread.html#42098">[ thread ]</a>
              <a href="subject.html#42098">[ subject ]</a>
              <a href="author.html#42098">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Feb 16, 2005 at 04:28:32AM +0000, Jp Calderone wrote:
&gt;<i>On Tue, 15 Feb 2005 19:56:15 -0800, Dave Cook &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">daverz at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>I'm rendering the results of a remote method call:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>     def data_tableList(self, ctx, data):
</I>&gt;&gt;<i>         ...
</I>&gt;&gt;<i>         d =   self.pbClientFactory.login(creds)
</I>&gt;&gt;<i>         d.addCallback(lambda object: object.callRemote(&quot;foo&quot;))
</I>&gt;&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i>  Always always always use errbacks.  *Especially* for Deferreds that can 
</I>&gt;<i>fail due to transient network conditions.
</I>
See, that depends. I ran into this just today in fact, and found that if 
the server has gone away, then you'll get an exception *right then*, not 
via the errback:

def do_stop(self):
  try:
    self.root.callRemote('stop', self).addCallbacks(self.stop, self.err)
  except pb.DeadReferenceError, re:
    self.stale()

Why, why, why why why doesn't the DeadReferenceError go down the 
errback? As it is, the code has to be littered with both synchronous and 
asynchronous error handling, which is needlessly irritating, surely?

The original poster may find his problem was a DeadReferenceError that's 
getting silently eaten (or just not GCed right away) by the framework, 
as I did.

For the original poster, here's what I've got:

class Thing:
  def __init__(self):
    self.root = None
    self.connect()
    
  def connect(self):
    f = pb.PBClientFactory()
    reactor.connectTCP(host, port, f)
    f.getRootObject().addCallbacks(self.connect_ok, self.connect_fail)

  def connect_ok(self, root):
    self.root = root

  def connect_fail(self, f):
    self.banner(f.getErrorMessage())
    reactor.callLater(1, self.connect)

  def stale(self):
    self.root = None
    self.connect()

  def start(self):
    if not self.root:
      self.banner(&quot;Connection in progress, please wait&quot;)
      return

    try:
      self.root.callRemote('start').addCallbacks(self.start2, self.err)
      self.banner(&quot;sent...&quot;)
    except pb.DeadReferenceError, re:
      self.stale()
      self.banner(&quot;Connection dropped, reconnecting&quot;)

  def start2(self, dummy):
    self.banner(&quot;started&quot;)

  def err(self, f):
    self.banner(f.getErrorMessage())



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="042093.html">[Twisted-Python] Dealing with an intermittent PB server
</A></li>
	<LI>Next message (by thread): <A HREF="042100.html">[Twisted-Python] Dealing with an intermittent PB server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42098">[ date ]</a>
              <a href="thread.html#42098">[ thread ]</a>
              <a href="subject.html#42098">[ subject ]</a>
              <a href="author.html#42098">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
