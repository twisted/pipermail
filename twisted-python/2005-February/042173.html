<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] linux kernel 2.6.11-rc broke twisted process	pipes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20linux%20kernel%202.6.11-rc%20broke%20twisted%20process%0A%09pipes&In-Reply-To=%3C844f3b9c24c0a8dbcc86e8903e9627dd%40fuhm.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="042169.html">
   <LINK REL="Next"  HREF="042174.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] linux kernel 2.6.11-rc broke twisted process	pipes</H1>
    <B>James Y Knight</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20linux%20kernel%202.6.11-rc%20broke%20twisted%20process%0A%09pipes&In-Reply-To=%3C844f3b9c24c0a8dbcc86e8903e9627dd%40fuhm.net%3E"
       TITLE="[Twisted-Python] linux kernel 2.6.11-rc broke twisted process	pipes">foom at fuhm.net
       </A><BR>
    <I>Mon Feb 28 15:52:05 MST 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="042169.html">[Twisted-Python] linux kernel 2.6.11-rc broke twisted process pipes
</A></li>
        <LI>Next message (by thread): <A HREF="042174.html">[Twisted-Python] linux kernel 2.6.11-rc broke twisted process	pipes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42173">[ date ]</a>
              <a href="thread.html#42173">[ thread ]</a>
              <a href="subject.html#42173">[ subject ]</a>
              <a href="author.html#42173">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Feb 28, 2005, at 3:14 PM, Andrea Arcangeli wrote:
&gt;<i> I would like to understand exactly what broke twisted, so that we're
</I>&gt;<i> sure the new 2.6.11 kernel will work reliably with twisted.
</I>&gt;<i>
</I>&gt;<i> This code especially will never trigger with 2.6.11 because we'll never
</I>&gt;<i> set POLLIN|POLLOUT at the same time for writeable fd.
</I>&gt;<i>
</I>&gt;<i>     def doRead(self):
</I>&gt;<i>         &quot;&quot;&quot;The only way this pipe can become readable is at EOF, 
</I>&gt;<i> because the
</I>&gt;<i>         child has closed it.
</I>&gt;<i>         &quot;&quot;&quot;
</I>&gt;<i>         fd = self.fd
</I>&gt;<i>         r, w, x = select.select([fd], [fd], [], 0)
</I>&gt;<i>         if r and w:
</I>&gt;<i>             return CONNECTION_LOST
</I>&gt;<i>
</I>&gt;<i> Could you answer why anybody should call doRead on a writeable fd?
</I>&gt;<i>
</I>&gt;<i> Where is it written that at EOF a _write_ pipe channel becomes 
</I>&gt;<i> readable?
</I>&gt;<i>
</I>&gt;<i> Is it ok that &quot;r and w&quot; will never trigger at the same time anymore,
</I>&gt;<i> right? Was just that a superflous assumptions?
</I>&gt;<i>
</I>&gt;<i> Note that with 2.6.8 and all previous linux kernels, &quot;r and w&quot; could be
</I>&gt;<i> == True in normal conditions too if the pipe write buffer was empty 
</I>&gt;<i> (old
</I>&gt;<i> kernel was setting pollin always for no good reason).
</I>&gt;<i>
</I>&gt;<i> What I suspect is that the above is a superflous check that was working
</I>&gt;<i> by luck with older kernels (becasue we could set in and out at the same
</I>&gt;<i> time even without a disconnect event), and that all you care about is 
</I>&gt;<i> to
</I>&gt;<i> get the wakeup from the write or disconnect events. And in turn the new
</I>&gt;<i> linux 2.6.11-rc should not work by luck anymore.
</I>
I agree this code is somewhat suboptimal. However, I do not agree that 
it works only by luck.

In response to your main question of &quot;why is it checking for 
readability at all&quot;, there is a good answer: to get the disconnect 
event without trying to write data. Select doesn't have a &quot;err&quot; fdset, 
so you have to select for either readability or writability. You can't 
select for writability when you have no data to write, or else you'll 
be continuously waking up. On all UNIX OSes that I know of, write pipes 
show up as readable in select when the other side has closed, for just 
this reason. I don't know if it's documented in any specs, but as far 
as I can tell, it's universally true.

Breaking this would be a Bad Thing, for I suspect more apps than just 
Twisted.

Of course, if it were that simple, doRead would just be implemented as 
&quot;return CONNECTION_LOST&quot;. From my testing, that'd even work on BSDs. 
However, linux adds its own little wrinkle to the problem.

On linux, the observed behavior seems to be that only one write can be 
outstanding at a time -- if there is data in the buffer, writable will 
be false and readable will be true. Otherwise, the inverse. This is 
quite silly...but it's what happens. As far as I can tell, at no time 
are both true, except when the pipe is disconnected. On BSD, a write 
pipe is simply never readable until the reader is closed, which is a 
lot more sensible.

Also note, that bit of code is unnecessary if you're using pollreactor 
rather than selectreactor. That is, I think it should be fine with 
twisted if the pipe is just POLLHUP when it is disconnected rather than 
POLLHUP|POLLIN|POLLOUT.

James



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="042169.html">[Twisted-Python] linux kernel 2.6.11-rc broke twisted process pipes
</A></li>
	<LI>Next message (by thread): <A HREF="042174.html">[Twisted-Python] linux kernel 2.6.11-rc broke twisted process	pipes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42173">[ date ]</a>
              <a href="thread.html#42173">[ thread ]</a>
              <a href="subject.html#42173">[ subject ]</a>
              <a href="author.html#42173">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
