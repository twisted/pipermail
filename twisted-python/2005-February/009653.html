<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Patch to support DNS updates
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Patch%20to%20support%20DNS%20updates&In-Reply-To=H0000065000015a3.1109327814.moses%40MHS">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009645.html">
   <LINK REL="Next"  HREF="009654.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Patch to support DNS updates</H1>
    <B>Tommi Virtanen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Patch%20to%20support%20DNS%20updates&In-Reply-To=H0000065000015a3.1109327814.moses%40MHS"
       TITLE="[Twisted-Python] Patch to support DNS updates">tv at twistedmatrix.com
       </A><BR>
    <I>Mon Feb 28 03:32:46 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="009645.html">[Twisted-Python] Patch to support DNS updates
</A></li>
        <LI>Next message: <A HREF="009654.html">[Twisted-Python] Patch to support DNS updates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9653">[ date ]</a>
              <a href="thread.html#9653">[ thread ]</a>
              <a href="subject.html#9653">[ subject ]</a>
              <a href="author.html#9653">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jeff Silver wrote:
&gt;<i> --- names/authority.py	2004-02-07 17:57:11.000000000 +0000
</I>&gt;<i> +++ names/authority.py.new	2005-02-25 09:34:02.725600288 +0000
</I>&gt;<i> @@ -161,6 +161,78 @@
</I>&gt;<i>                  add.extend(res[1][2])
</I>&gt;<i>          return ans, auth, add
</I>&gt;<i>  
</I>&gt;<i> +    def _trySaveToOriginalFile(self):
</I>&gt;<i> +        '''Called after an update.'''
</I>&gt;<i> +        soa_rec = self.soa[1]
</I>&gt;<i> +        new_serial = int(time.strftime('%Y%m%d%H%M')) - 200000000000
</I>&gt;<i> +        if new_serial &lt;= soa_rec.serial:
</I>&gt;<i> +            new_serial = soa_rec.serial + 1
</I>&gt;<i> +        old_serial = soa_rec.serial
</I>&gt;<i> +        soa_rec.serial = new_serial
</I>&gt;<i> +        if hasattr(self, 'filename'):
</I>&gt;<i> +            tmp_filename = self.filename + '.new'
</I>&gt;<i> +            save_filename = '%s.%d' % (self.filename, old_serial)
</I>&gt;<i> +            self.saveFile(tmp_filename)
</I>&gt;<i> +            os.rename(self.filename, save_filename)
</I>&gt;<i> +            os.rename(tmp_filename, self.filename)
</I>
While I am not going to comment on the rest of the patch (the feature
does sound nice, altough lack of authentication makes using it pretty
pointless IMHO), this is just unacceptable.

If an exception is raised, the app crashes, or the machine loses power
between those two renames, your original zone file has been renamed
and your DNS server won't start.

Do something like

 &gt;&gt;&gt; f=open('foo', 'w')
 &gt;&gt;&gt; f.write('foo')
 &gt;&gt;&gt; f.close()
 &gt;&gt;&gt; import os
 &gt;&gt;&gt; os.link('foo', 'foo.old')
 &gt;&gt;&gt; f=open('bar', 'w')
 &gt;&gt;&gt; f.write('bar')
 &gt;&gt;&gt; os.fsync(f)
 &gt;&gt;&gt; f.close()
 &gt;&gt;&gt; os.rename('bar', 'foo')
 &gt;&gt;&gt;


Also, nice y2.043k trap there, I don't think many have been able to
write ones targeting that exact date.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009645.html">[Twisted-Python] Patch to support DNS updates
</A></li>
	<LI>Next message: <A HREF="009654.html">[Twisted-Python] Patch to support DNS updates
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9653">[ date ]</a>
              <a href="thread.html#9653">[ thread ]</a>
              <a href="subject.html#9653">[ subject ]</a>
              <a href="author.html#9653">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
