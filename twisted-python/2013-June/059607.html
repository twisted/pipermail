<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20deferToThread%20and%20thrown%20exceptions%20break%20gc%20-%0A%20ticket%203853&In-Reply-To=%3CCAMWA1_pC%3DKLMsRj-kDhvjPEm0tp-zRGPd6UfeNsUVg5-h8qOhw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="059606.html">
   <LINK REL="Next"  HREF="059608.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853</H1>
    <B>Benjamin Rutt</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20deferToThread%20and%20thrown%20exceptions%20break%20gc%20-%0A%20ticket%203853&In-Reply-To=%3CCAMWA1_pC%3DKLMsRj-kDhvjPEm0tp-zRGPd6UfeNsUVg5-h8qOhw%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853">rutt.4 at osu.edu
       </A><BR>
    <I>Wed Jun 26 14:15:23 MDT 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="059606.html">[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853
</A></li>
        <LI>Next message (by thread): <A HREF="059608.html">[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59607">[ date ]</a>
              <a href="thread.html#59607">[ thread ]</a>
              <a href="subject.html#59607">[ subject ]</a>
              <a href="author.html#59607">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am not sure that that trac issue contains a patch that will fix it.  The
most recent patch on that trac issue is for twisted 8.1, and it does not
apply cleanly to twisted 12.3.0.  When I tried to place the 2 lines that
form the patch in the most obvious place in the 12.3.0 codebase (before the
code 'self.waiters.append(ct)') I could not get it to fix the repro I have.
 Here's my repro:

from twisted.internet import reactor
from twisted.internet.threads import deferToThread

class SomeClass(object):
    def __del__(self):
        print 'SomeClass\'s destructor was called!'

def foo():
    sc = SomeClass()
    raise RuntimeError('bah')

def shutmedown(data):
    print 'reactor shutdown happening now'
    reactor.stop()

def go():
    d = deferToThread(foo)
    d.addCallbacks(shutmedown, shutmedown)
reactor.callWhenRunning(go)
reactor.run()

and running it:

$ ./twisted-defertothread-bug.py
reactor shutdown happening now
SomeClass's destructor was called!

The bug is present, as the instance of SomeClass only gets gc'd once the
reactor shuts down (taking the thread pool with it), not when the foo()
function terminates.  Obviously I'm using CPython, which uses reference
counting gc, so there is no reason to delay the reclaim of the SomeClass
instance until after the function exit.


On Wed, Jun 26, 2013 at 1:03 PM, Christopher Armstrong &lt;
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">radix at twistedmatrix.com</A>&gt; wrote:

&gt;<i> On Wed, Jun 26, 2013 at 9:15 AM, Benjamin Rutt &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">rutt.4 at osu.edu</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I believe I hit <A HREF="http://twistedmatrix.com/trac/ticket/3853">http://twistedmatrix.com/trac/ticket/3853</A> in production
</I>&gt;&gt;<i> this week, in the form of what looked like a resource leak, but turned out
</I>&gt;&gt;<i> to be a case of a resource held for much longer than expected.  (I'm using
</I>&gt;&gt;<i> python 2.7, and twisted 12.3.0).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That is, I had a function invoked by deferToThread, that searched a file
</I>&gt;&gt;<i> by memory mapping it using the 'mmap' module.  And if my function could not
</I>&gt;&gt;<i> find what it was looking for in the file, it raised an exception at the
</I>&gt;&gt;<i> end.  I observed that my process was still hanging on to the mmap, due to
</I>&gt;&gt;<i> my local variable representing the mmap (which I presumed would have been
</I>&gt;&gt;<i> gc'd as it went out of scope as part of the throw) not being gc'd when the
</I>&gt;&gt;<i> function ended.  I can work around it in my function by setting that local
</I>&gt;&gt;<i> variable to None right before I throw, but this is python, not C, and in
</I>&gt;&gt;<i> python automatic memory management is assumed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, +1 for that issue getting fixed.   From the issue it looks like there
</I>&gt;&gt;<i> is a deeper issue in python itself that could fix this, but as the fix
</I>&gt;&gt;<i> discussion is moving at a glacial pace, I say +1 for a twisted workaround,
</I>&gt;&gt;<i> which from the trac discussion, sounds possible.  Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Like you said, it looks like there's already a patch that can solve the
</I>&gt;<i> problem. All it needs before it can be reviewed is tests. If you could
</I>&gt;<i> spare some time to write one (or however many are needed) then that would
</I>&gt;<i> increase the ticket's chances for resolution quite a bit :)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Christopher Armstrong
</I>&gt;<i> <A HREF="http://radix.twistedmatrix.com/">http://radix.twistedmatrix.com/</A>
</I>&gt;<i> <A HREF="http://planet-if.com/">http://planet-if.com/</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

-- 
Benjamin Rutt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20130626/b23c0eff/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="059606.html">[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853
</A></li>
	<LI>Next message (by thread): <A HREF="059608.html">[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59607">[ date ]</a>
              <a href="thread.html#59607">[ thread ]</a>
              <a href="subject.html#59607">[ subject ]</a>
              <a href="author.html#59607">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
