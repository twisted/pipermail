<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Testing AMP-based code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Testing%20AMP-based%20code&In-Reply-To=%3C20130612231612.5484.1361672252.divmod.xquotient.46%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="027030.html">
   <LINK REL="Next"  HREF="059515.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Testing AMP-based code</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Testing%20AMP-based%20code&In-Reply-To=%3C20130612231612.5484.1361672252.divmod.xquotient.46%40top%3E"
       TITLE="[Twisted-Python] Testing AMP-based code">exarkun at twistedmatrix.com
       </A><BR>
    <I>Wed Jun 12 17:16:12 MDT 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027030.html">[Twisted-Python] Testing AMP-based code
</A></li>
        <LI>Next message (by thread): <A HREF="059515.html">[Twisted-Python] Testing AMP-based code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59514">[ date ]</a>
              <a href="thread.html#59514">[ thread ]</a>
              <a href="subject.html#59514">[ subject ]</a>
              <a href="author.html#59514">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5 Jun, 07:13 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">free at 64studio.com</A> wrote:
&gt;<i>Hi,
</I>&gt;<i>
</I>&gt;<i>following up from ticket #6502, I'm looking for recommendations/best
</I>&gt;<i>practices for writing unit-tests for AMP-based code.
</I>&gt;<i>
</I>&gt;<i>As described in the ticket, the issue I'm currently facing is that the
</I>&gt;<i>AMP implementation is subtly not re-entrant safe and doesn't work with 
</I>&gt;<i>a
</I>&gt;<i>synchronous transport, for example this code raises an exception:
</I>&gt;<i>
</I>&gt;<i><A HREF="http://twistedmatrix.com/trac/attachment/ticket/6502/example.py">http://twistedmatrix.com/trac/attachment/ticket/6502/example.py</A>
</I>&gt;<i>
</I>&gt;<i>I'm starting to think that the most appropriate testing strategy would
</I>&gt;<i>be to mock/stub AMP.callRemote (or the protocol class altogether)
</I>&gt;<i>instead of trying to use a fake transport.
</I>&gt;<i>
</I>&gt;<i>Thoughts?
</I>
I think this is thinking in the right direction.  Twisted generally 
tries to be responsible for testing its own code, and the serialization 
from commands to bytes (and the reverse) that AMP does is part of 
Twisted, so you should really be free from the burden of testing that 
that stuff works.

One thing it's worth noticing is that the AMP class itself contains very 
little code.  Instead, it inherits most functionality from a few base 
classes.  It's worth learning about the division of responsibility 
between these classes because they can be helpful in writing cleaner AMP 
code and - relevant to this topic - writing AMP unit tests.

One of the base classes, BinaryBoxProtocol, is almost entirely concerned 
with serialization logic.  You can probably ignore this one entirely to 
begin with (although consider the consequences of 
serialization/deserialization living in this one class, independent of 
the rest of the protocol logic: perhaps you want to exchange AMP 
commands with a web browser and would find JSON an easier format to work 
with than AMP's int16 string scheme... etc).

Next, BoxDispatcher.  This one is what actually implements `callRemote` 
and the reverse - ampBoxReceived, turning an AMP box (already parsed), 
into an incoming method call or the result of a previous outgoing method 
call.  It operates on locator (to look up how to handle incoming method 
calls) and a box sender (to send out boxes representing method calls or 
responses).  It doesn't know about the network, so your box sender can 
be a purely in-memory thing, implementing some box handling logic purely 
as Python code and no I/O.

As far as the locator goes, if you want the standard 
`@SomeCommand.responder` functionality, then you can easily get this by 
re-using the next base class of AMP, CommandLocator.  This one's pretty 
straight-forward: subclass it and those decorators will work for you.

Ignore the last one, SimpleStringLocator, it's for extremely old-style 
AMP code that no one should be writing anymore.

So this all means that your application logic can all live on a 
CommandLocator subclass.  When you really want to put this on an AMP 
server, you can hook an AMP instance up to your CommandLocator subclass 
(AMP takes a locator as an __init__ argument).  When you want to test 
your command implementations, you can hook the CommandLocator up to a 
BoxDispatcher and a box sender and throw boxes straight at it with no 
network interation.

Some pieces are probably still missing from the public API - for 
example, you do want to test that your objects all get properly 
serialized and deserialized through AMP, particularly if you're 
implementing custom Argument types.  There are some private APIs, 
_objectsToStrings and _stringsToObjects mostly, that really help with 
testing this, and we should think about how to expose this functionality 
publically.  Also, we should document this whole pile of stuff.  Maybe 
you'd be interested in writing something up after you've had a chance to 
play with these ideas?

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027030.html">[Twisted-Python] Testing AMP-based code
</A></li>
	<LI>Next message (by thread): <A HREF="059515.html">[Twisted-Python] Testing AMP-based code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59514">[ date ]</a>
              <a href="thread.html#59514">[ thread ]</a>
              <a href="subject.html#59514">[ subject ]</a>
              <a href="author.html#59514">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
