<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] deferToThread and thrown exceptions break gc -	ticket 3853
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20deferToThread%20and%20thrown%20exceptions%20break%20gc%20-%0A%09ticket%203853&In-Reply-To=%3CCAMWA1_oYZNNP2nhtAoEsaFAH4iuFXB%2B%3DO-mQrDYmAigak%2BVk9g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] deferToThread and thrown exceptions break gc -	ticket 3853</H1>
    <B>Benjamin Rutt</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20deferToThread%20and%20thrown%20exceptions%20break%20gc%20-%0A%09ticket%203853&In-Reply-To=%3CCAMWA1_oYZNNP2nhtAoEsaFAH4iuFXB%2B%3DO-mQrDYmAigak%2BVk9g%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] deferToThread and thrown exceptions break gc -	ticket 3853">rutt.4 at osu.edu
       </A><BR>
    <I>Wed Jun 26 08:15:23 MDT 2013</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59605">[ date ]</a>
              <a href="thread.html#59605">[ thread ]</a>
              <a href="subject.html#59605">[ subject ]</a>
              <a href="author.html#59605">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I believe I hit <A HREF="http://twistedmatrix.com/trac/ticket/3853">http://twistedmatrix.com/trac/ticket/3853</A> in production
this week, in the form of what looked like a resource leak, but turned out
to be a case of a resource held for much longer than expected.  (I'm using
python 2.7, and twisted 12.3.0).

That is, I had a function invoked by deferToThread, that searched a file by
memory mapping it using the 'mmap' module.  And if my function could not
find what it was looking for in the file, it raised an exception at the
end.  I observed that my process was still hanging on to the mmap, due to
my local variable representing the mmap (which I presumed would have been
gc'd as it went out of scope as part of the throw) not being gc'd when the
function ended.  I can work around it in my function by setting that local
variable to None right before I throw, but this is python, not C, and in
python automatic memory management is assumed.

So, +1 for that issue getting fixed.   From the issue it looks like there
is a deeper issue in python itself that could fix this, but as the fix
discussion is moving at a glacial pace, I say +1 for a twisted workaround,
which from the trac discussion, sounds possible.  Thanks,
-- 
Benjamin
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20130626/eecc0ff8/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59605">[ date ]</a>
              <a href="thread.html#59605">[ thread ]</a>
              <a href="subject.html#59605">[ subject ]</a>
              <a href="author.html#59605">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
