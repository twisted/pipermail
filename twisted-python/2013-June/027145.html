<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20deferToThread%20and%20thrown%20exceptions%20break%20gc%20-%0A%20ticket%203853&In-Reply-To=%3CCAPkRfUQ5JJswMPseum7X%3DMJFq6UVhPN4vcLK40NBFxgHRaczig%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027144.html">
   <LINK REL="Next"  HREF="027146.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853</H1>
    <B>Christopher Armstrong</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20deferToThread%20and%20thrown%20exceptions%20break%20gc%20-%0A%20ticket%203853&In-Reply-To=%3CCAPkRfUQ5JJswMPseum7X%3DMJFq6UVhPN4vcLK40NBFxgHRaczig%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853">radix at twistedmatrix.com
       </A><BR>
    <I>Wed Jun 26 11:03:36 MDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027144.html">[Twisted-Python] deferToThread and thrown exceptions break gc -	ticket 3853
</A></li>
        <LI>Next message: <A HREF="027146.html">[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27145">[ date ]</a>
              <a href="thread.html#27145">[ thread ]</a>
              <a href="subject.html#27145">[ subject ]</a>
              <a href="author.html#27145">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Jun 26, 2013 at 9:15 AM, Benjamin Rutt &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">rutt.4 at osu.edu</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I believe I hit <A HREF="http://twistedmatrix.com/trac/ticket/3853">http://twistedmatrix.com/trac/ticket/3853</A> in production
</I>&gt;<i> this week, in the form of what looked like a resource leak, but turned out
</I>&gt;<i> to be a case of a resource held for much longer than expected.  (I'm using
</I>&gt;<i> python 2.7, and twisted 12.3.0).
</I>&gt;<i>
</I>&gt;<i> That is, I had a function invoked by deferToThread, that searched a file
</I>&gt;<i> by memory mapping it using the 'mmap' module.  And if my function could not
</I>&gt;<i> find what it was looking for in the file, it raised an exception at the
</I>&gt;<i> end.  I observed that my process was still hanging on to the mmap, due to
</I>&gt;<i> my local variable representing the mmap (which I presumed would have been
</I>&gt;<i> gc'd as it went out of scope as part of the throw) not being gc'd when the
</I>&gt;<i> function ended.  I can work around it in my function by setting that local
</I>&gt;<i> variable to None right before I throw, but this is python, not C, and in
</I>&gt;<i> python automatic memory management is assumed.
</I>&gt;<i>
</I>&gt;<i> So, +1 for that issue getting fixed.   From the issue it looks like there
</I>&gt;<i> is a deeper issue in python itself that could fix this, but as the fix
</I>&gt;<i> discussion is moving at a glacial pace, I say +1 for a twisted workaround,
</I>&gt;<i> which from the trac discussion, sounds possible.  Thanks,
</I>&gt;<i>
</I>&gt;<i>
</I>Like you said, it looks like there's already a patch that can solve the
problem. All it needs before it can be reviewed is tests. If you could
spare some time to write one (or however many are needed) then that would
increase the ticket's chances for resolution quite a bit :)


-- 
Christopher Armstrong
<A HREF="http://radix.twistedmatrix.com/">http://radix.twistedmatrix.com/</A>
<A HREF="http://planet-if.com/">http://planet-if.com/</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20130626/d0c46f5f/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20130626/d0c46f5f/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027144.html">[Twisted-Python] deferToThread and thrown exceptions break gc -	ticket 3853
</A></li>
	<LI>Next message: <A HREF="027146.html">[Twisted-Python] deferToThread and thrown exceptions break gc - ticket 3853
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27145">[ date ]</a>
              <a href="thread.html#27145">[ thread ]</a>
              <a href="subject.html#27145">[ subject ]</a>
              <a href="author.html#27145">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
