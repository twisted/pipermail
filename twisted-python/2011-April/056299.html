<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] @inlinecallbacks and AlreadyCalledError in test	cases
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%40inlinecallbacks%20and%20AlreadyCalledError%20in%20test%0A%09cases&In-Reply-To=%3CBANLkTimYX0T%3DoQ_DZqvxAhrw9TbOM7WK_A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="056312.html">
   <LINK REL="Next"  HREF="056300.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] @inlinecallbacks and AlreadyCalledError in test	cases</H1>
    <B>Brad Milne</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%40inlinecallbacks%20and%20AlreadyCalledError%20in%20test%0A%09cases&In-Reply-To=%3CBANLkTimYX0T%3DoQ_DZqvxAhrw9TbOM7WK_A%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] @inlinecallbacks and AlreadyCalledError in test	cases">brad.milne at devx.runthered.com
       </A><BR>
    <I>Mon Apr  4 19:39:05 MDT 2011</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="056312.html">[Twisted-Python] [Twisted-web] Creating a hybrid server in	Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="056300.html">[Twisted-Python] @inlinecallbacks and AlreadyCalledError in	test	cases
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#56299">[ date ]</a>
              <a href="thread.html#56299">[ thread ]</a>
              <a href="subject.html#56299">[ subject ]</a>
              <a href="author.html#56299">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all

I have recently started switching to trial.unittest from python's own. The
trouble I'm experiencing is when a timeout occurs in my test, it errbacks().
Then the @inlineCallbacks decorator sees the error and errbacks(). But then
a second @inlineCallback in the chain subsequently sees *that* errback and
tries to errback itself. This results in AlreadyCalledError.

In the test setup, various services are started. These are tracked and then
shutdown again in the teardown. Also, there is some polling that happens as
part of the tests (waiting on db activities, for example). These use
deferLater calls, which are also tracked and torn down in the teardown.

I've tried _suppressAlreadyCalled in various places to no avail.

Below is a simple example that shows the problem.

Many thanks
Brad


&lt;code&gt;

from twisted.trial.unittest import TestCase

from twisted.internet import task, reactor

from twisted.internet.defer import inlineCallbacks


#import twisted

#twisted.internet.base.DelayedCall.debug = True

#twisted.internet.defer.setDebugging(True)


class Test1(TestCase):



    def setUp(self):

        # timeout test in 1 second

        self.timeout = 1

        self.jobs = []

        self.addCleanup(self._tearDown)



    def _tearDown(self):

        for d in self.jobs:

            if d and not d.called:

                d.cancel()



    @inlineCallbacks

    def _waitForChange(self):

        # do stuff

        d = task.deferLater(reactor, 0.5, lambda : None)

        self.jobs.append(d)

        yield d

        self.jobs.remove(d)

        # do more stuff



    @inlineCallbacks

    def testHere(self):

        # do stuff

        yield self._waitForChange()

        # do more stuff


    # This one passes OK

    #def testHere(self):

    #   return self._waitForChange()


if __name__ == &quot;__main__&quot;:

    import sys

    from twisted.scripts import trial

    sys.argv.extend([sys.argv[0]])

    trial.run()

&lt;/code&gt;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20110405/cd2f964c/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="056312.html">[Twisted-Python] [Twisted-web] Creating a hybrid server in	Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="056300.html">[Twisted-Python] @inlinecallbacks and AlreadyCalledError in	test	cases
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#56299">[ date ]</a>
              <a href="thread.html#56299">[ thread ]</a>
              <a href="subject.html#56299">[ subject ]</a>
              <a href="author.html#56299">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
