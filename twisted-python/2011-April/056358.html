<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted Plugins - Implementation Discussion
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20Plugins%20-%20Implementation%20Discussion&In-Reply-To=%3C2F66AFB0-94C4-4E8D-A52D-79B7414573AF%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="056354.html">
   <LINK REL="Next"  HREF="056356.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted Plugins - Implementation Discussion</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20Plugins%20-%20Implementation%20Discussion&In-Reply-To=%3C2F66AFB0-94C4-4E8D-A52D-79B7414573AF%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Twisted Plugins - Implementation Discussion">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Apr  7 13:27:19 MDT 2011</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="056354.html">[Twisted-Python] Twisted Plugins - Implementation Discussion
</A></li>
        <LI>Next message (by thread): <A HREF="056356.html">[Twisted-Python] Twisted Plugins - Implementation Discussion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#56358">[ date ]</a>
              <a href="thread.html#56358">[ thread ]</a>
              <a href="subject.html#56358">[ subject ]</a>
              <a href="author.html#56358">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Apr 7, 2011, at 9:19 AM, Andrew Bennetts wrote:

&gt;<i> Itamar Turner-Trauring wrote:
</I>&gt;<i> […]
</I>&gt;&gt;<i> So, the design has to *not* rely on caching working.
</I>&gt;<i> 
</I>&gt;<i> FWIW: this is an achievable goal.  I have 32 different bzr plugins
</I>&gt;<i> currently installed, and here's the difference they make:
</I>&gt;<i> 
</I>&gt;<i>   $ time bzr --no-plugins rocks
</I>&gt;<i>   It sure does!
</I>&gt;<i> 
</I>&gt;<i>   real	0m0.075s
</I>&gt;<i> 
</I>&gt;<i>   $ time bzr rocks
</I>&gt;<i>   It sure does!
</I>&gt;<i> 
</I>&gt;<i>   real	0m0.119s
</I>&gt;<i> 
</I>&gt;<i> So that's about 1.5ms per plugin, on average.  With a hot disk cache, at
</I>&gt;<i> least…
</I>
Is your cache as hot for Twisted as for bzr?  Have you replicated these results in a randomized, double-blind clinical trial? ;-)

I'm not surprised that bzr has faster startup though; twistd has not been (and doubtful will ever be) nearly so ruthlessly optimized.  Maybe it's time to put a startup benchmark on &lt;<A HREF="http://speed.twistedmatrix.com/">http://speed.twistedmatrix.com/</A>&gt;, at least that way we could keep track.

&gt;<i> For comparison, 'twistd --version' takes 116ms, with a dropin.cache and
</I>&gt;<i> (I think, although how can I tell?) no plugins installed.
</I>
Twisted itself installs 22 dropins (python files which each define at least one plugin), which comprise 48 plugins of various types, so there are always some.  You should be able to tell, though.  It's pathetic that we don't have a command-line tool to inspect the available plugins and what they're doing.  Independent of the other issues under discussion here: &lt;<A HREF="http://twistedmatrix.com/trac/ticket/5039">http://twistedmatrix.com/trac/ticket/5039</A>&gt;.

But this is all moot.  'twistd --version' doesn't scan for plugins, so that's all just the normal startup time; apparently we import too much in the first place.  The thing to compare with is 'twistd --help' or even just 'twistd [some-plugin]' (since invoking one plugin actually loads all of them).  Plus - this is really the genesis for this thread - the dropin.cache isn't really saving us much work at all right now, because all the plugins get loaded anyway for all practical uses of plugin scanning.

&gt;<i> In part, we achieve this via the bzrlib.lazy_import hack, which plugins
</I>&gt;<i> can and often do use, and by encouraging plugin authors to put as little
</I>&gt;<i> code into their __init__.py files as possible.  A typical plugin's
</I>&gt;<i> __init__ might do just:
</I>&gt;<i> 
</I>&gt;<i>    # This is example_plugin/__init__.py
</I>&gt;<i>    # The actual command implementation is in
</I>&gt;<i>    # example_plugin/example_commands.py
</I>&gt;<i>    from bzrlib import commands
</I>&gt;<i>    commands.plugin_cmds.register_lazy('cmd_class_name', [],
</I>&gt;<i>        'bzrlib.plugins.example_plugin.example_commands')
</I>
This looks very similar to ServiceMaker.

&gt;<i> Glyph's expressed scepticism that plugin authors and maintainers will
</I>&gt;<i> know to keep their __init__.py files cheap to import.  Bazaar's
</I>&gt;<i> experience is different.  Partly that's probably because the Bazaar
</I>&gt;<i> community has paid a fair bit of attention to start up time and I
</I>&gt;<i> suppose Twisted doesn't have that.
</I>
Yeah, bzr's audience makes this easier.  For one thing, the audience is much bigger :), but more importantly, bzr is a user-facing tool which users are running _constantly_ at the command line.  The only visible consequence of a rogue twistd plugin is that your server which runs for days at a time takes 0.2s longer to start; the real problem sets in later, where your 25 subprocesses are suddenly consuming an additional 50meg each because of the extra plugin they loaded.  You do find this eventually, it's just rare to find it while you're writing the plugin.

&gt;<i> But I think also it's partly because
</I>&gt;<i> we've provided tools to help people diagnose what/who to blame for bzr
</I>&gt;<i> being slow to start, like 'bzr --profile-imports', and even the crude
</I>&gt;<i> 'time bzr rocks'.
</I>

Yes.  These are a great idea, and there's no excuse that Twisted's plugin system is so difficult to inspect and debug.  A couple of good tools would address a wide range of plugin issues, many of them much more interesting than performance, like the ever-popular &quot;why isn't my plugin getting loaded&quot;.  Thanks for the impetus to file the ticket above.  (I kinda hope it's a dup, but I couldn't find one.)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20110407/264d4da8/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="056354.html">[Twisted-Python] Twisted Plugins - Implementation Discussion
</A></li>
	<LI>Next message (by thread): <A HREF="056356.html">[Twisted-Python] Twisted Plugins - Implementation Discussion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#56358">[ date ]</a>
              <a href="thread.html#56358">[ thread ]</a>
              <a href="subject.html#56358">[ subject ]</a>
              <a href="author.html#56358">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
