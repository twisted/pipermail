<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] need help for twisted FTPClient
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20need%20help%20for%20twisted%20FTPClient&In-Reply-To=b486cc990902101943h4c1790c8m58c1f9caa8cab74d%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019163.html">
   <LINK REL="Next"  HREF="019166.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] need help for twisted FTPClient</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20need%20help%20for%20twisted%20FTPClient&In-Reply-To=b486cc990902101943h4c1790c8m58c1f9caa8cab74d%40mail.gmail.com"
       TITLE="[Twisted-Python] need help for twisted FTPClient">exarkun at divmod.com
       </A><BR>
    <I>Wed Feb 11 10:32:36 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019163.html">[Twisted-Python] need help for twisted FTPClient
</A></li>
        <LI>Next message: <A HREF="019166.html">[Twisted-Python] need help for twisted FTPClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19165">[ date ]</a>
              <a href="thread.html#19165">[ thread ]</a>
              <a href="subject.html#19165">[ subject ]</a>
              <a href="author.html#19165">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 11 Feb 2009 11:43:07 +0800, &#26611;&#38196; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ioscas at gmail.com</A>&gt; wrote:
&gt;<i>hello, everyone:
</I>&gt;<i>
</I>&gt;<i>    I'm new to twisted and ftp protocol. for some purpose, i need a python
</I>&gt;<i>ftp client to do list, get, put, remove operations upon a FTP server which
</I>&gt;<i>is implemented with twisted.
</I>&gt;<i>    here is my codes, testing for 'get' passed, but 'put' failed. i checked
</I>&gt;<i>the api of storeFile, abd got these:
</I>&gt;<i>
</I>&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i> but i don't know how to handle it, :)
</I>&gt;<i> sorry for the rubbish codes, but i really need help from you guys, it's
</I>&gt;<i>hard to find some useful info from twisted official doc,
</I>&gt;<i> Any suggestion on how to write a nice ftp client with twisted is welcome.
</I>&gt;<i> Thanks in advance.
</I>
The most obvious problem with the code is that it uses reactor.run and
reactor.stop too much.  You can start and stop the reactor exactly once.

&gt;<i>IOSCAS
</I>&gt;<i>
</I>&gt;<i>______________________________________________________________________________
</I>&gt;<i>
</I>&gt;<i>from twisted.protocols.ftp import FTPClient, FTPFileListProtocol
</I>&gt;<i>from twisted.internet.protocol import Protocol, ClientCreator
</I>&gt;<i>from twisted.python import usage
</I>&gt;<i>from twisted.internet import reactor, defer
</I>&gt;<i>
</I>&gt;<i>class SaveFile(Protocol):
</I>&gt;<i>    '''
</I>&gt;<i>    save the ftp file to local filesystem
</I>&gt;<i>    '''
</I>&gt;<i>    def __init__(self, output):
</I>&gt;<i>        self.fout = open(output, 'w')
</I>&gt;<i>
</I>&gt;<i>    def dataReceived(self, data):
</I>&gt;<i>        self.fout.write(data)
</I>&gt;<i>        self.fout.close()
</I>
This is also probably wrong.  dataReceived may be called multiple times.
You can't close the output file until you've received all the data.  I'm
not sure, but connectionLost is probably called when all data has been
received (or if there is an error receiving the data).

&gt;<i>class FTP:
</I>&gt;<i>    '''
</I>&gt;<i>    a simple ftp client
</I>&gt;<i>    '''
</I>&gt;<i>    def __init__(self, host, port):
</I>&gt;<i>        '''
</I>&gt;<i>        init
</I>&gt;<i>        '''
</I>&gt;<i>        self.__host = host
</I>&gt;<i>        self.__port = port
</I>&gt;<i>        self.__username = 'aaa'
</I>&gt;<i>        self.__passwd = 'bbb'
</I>&gt;<i>        self.__passive = 1
</I>&gt;<i>
</I>&gt;<i>    def __get(self, ftp_client, src, des):
</I>&gt;<i>        '''
</I>&gt;<i>        '''
</I>&gt;<i>        save_file = SaveFile(des)
</I>&gt;<i>        d = ftp_client.retrieveFile(src, save_file)
</I>&gt;<i>        d = ftp_client.quit()
</I>&gt;<i>        d.addCallback(lambda result: reactor.stop())
</I>&gt;<i>        return d
</I>
Don't stop the reactor here.  Stopping the reactor means your program is
basically done and you don't want to do anything else with Twisted.

&gt;<i>    def get(self, src, des):
</I>&gt;<i>        '''
</I>&gt;<i>        get src file from ftp server, store it in des
</I>&gt;<i>        '''
</I>&gt;<i>        creator = ClientCreator(reactor, FTPClient, self.__username,
</I>&gt;<i>self.__passwd, self.__passive)
</I>&gt;<i>        defer = creator.connectTCP(self.__host,
</I>&gt;<i>self.__port).addCallback(self.__get, src, des)
</I>&gt;<i>        reactor.run()
</I>&gt;<i>        return defer.result
</I>
Don't start the reactor here.  Start the reactor in the &quot;main&quot; part of your
program.  Also, don't access &quot;defer.result&quot;.  Instead, just return &quot;defer&quot;.

&gt;<i>
</I>&gt;<i>    def __put(self, ftp_client, src, des):
</I>&gt;<i>        '''
</I>&gt;<i>        '''
</I>&gt;<i>        source_file = os.path.basename(src)
</I>&gt;<i>        target_dir = os.path.dirname(des)
</I>&gt;<i>        ftp_client.changeDirectory(target_dir)
</I>&gt;<i>        d = ftp_client.storeFile(src)
</I>&gt;<i>        d = ftp_client.quit()
</I>&gt;<i>        d.addCallback(lambda result: reactor.stop())
</I>&gt;<i>        return d
</I>
Again, don't use stop here.

&gt;<i>   def put(self, src, des):
</I>&gt;<i>        '''
</I>&gt;<i>        put src file to ftp server, store it in des
</I>&gt;<i>        '''
</I>&gt;<i>        creator = ClientCreator(reactor, FTPClient, self.__username,
</I>&gt;<i>self.__passwd, self.__passive)
</I>&gt;<i>        defer = creator.connectTCP(self.__host,
</I>&gt;<i>self.__port).addCallback(self.__put, src, des)
</I>&gt;<i>        reactor.run()
</I>&gt;<i>        return defer.result
</I>&gt;<i>
</I>
And don't use run or .result here.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019163.html">[Twisted-Python] need help for twisted FTPClient
</A></li>
	<LI>Next message: <A HREF="019166.html">[Twisted-Python] need help for twisted FTPClient
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19165">[ date ]</a>
              <a href="thread.html#19165">[ thread ]</a>
              <a href="subject.html#19165">[ subject ]</a>
              <a href="author.html#19165">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
