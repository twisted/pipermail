<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: How can I disconnect ssl connection from	the	client side?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20How%20can%20I%20disconnect%20ssl%20connection%20from%0A%09the%09client%20side%3F&In-Reply-To=797440730902020248t30042234ob6b12b325804bdd4%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019128.html">
   <LINK REL="Next"  HREF="019127.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: How can I disconnect ssl connection from	the	client side?</H1>
    <B>Johann Borck</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20How%20can%20I%20disconnect%20ssl%20connection%20from%0A%09the%09client%20side%3F&In-Reply-To=797440730902020248t30042234ob6b12b325804bdd4%40mail.gmail.com"
       TITLE="[Twisted-Python] Re: How can I disconnect ssl connection from	the	client side?">johann.borck at densedata.com
       </A><BR>
    <I>Mon Feb  2 08:45:40 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019128.html">[Twisted-Python] Re: How can I disconnect ssl connection from the	client side?
</A></li>
        <LI>Next message: <A HREF="019127.html">[Twisted-Python] Re: How can I disconnect ssl connection from	the	client side?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19126">[ date ]</a>
              <a href="thread.html#19126">[ thread ]</a>
              <a href="subject.html#19126">[ subject ]</a>
              <a href="author.html#19126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Atsuo Ishimoto wrote:

...
&gt;<i> class Client(basic.LineReceiver):
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         class dmyfile:
</I>&gt;<i>             def read(self, n):
</I>&gt;<i>                 if CANCELED:
</I>&gt;<i>                     return
</I>&gt;<i>                 else:
</I>&gt;<i>                     return '1'
</I>&gt;<i>
</I>&gt;<i>         s = basic.FileSender()
</I>&gt;<i>         print &quot;start sending&quot;
</I>&gt;<i>
</I>&gt;<i>         def f1(lastChunk):
</I>&gt;<i>             print &quot;finished&quot;
</I>&gt;<i>
</I>&gt;<i>   
</I>...
&gt;<i> def cancel():
</I>&gt;<i>     print &quot;cancel&quot;, conn.state
</I>&gt;<i>     global CANCELED
</I>&gt;<i>     CANCELED = True
</I>&gt;<i>     conn.disconnect()
</I>&gt;<i>
</I>&gt;<i>   
</I>I think the problem is that you call conn.disconnect before the 
FileSender has a chance to call unregisterProducer on the transport (in 
real life before it has sent the whole file). If the producer is not 
unregistered, the doWrite() method called from the reactor doesn't even 
check if the connection is in 'disconnecting' state, assumes there's 
more data to come, and since no further events occur on the channel, the 
connection just remains open. You can check that by manually writing one 
more byte to the transport in f1, after FileSender has unregistered 
itself. The correct way is to call 
conn.disconnect()/transport.loseConnection() in f1 instead of in cancel.

from t.i.abstract.FileDescriptor.loseConnection.__doc__:
&quot;... If you have a producer registered, the connection won't be closed 
until the producer is finished. Therefore, make sure you unregister your 
producer when it's finished, or the connection willnever close ...&quot;

hth, Johann
&gt;<i> reactor.callLater(2, cancel) # disconnect 2 sec later
</I>&gt;<i> reactor.run()
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>   
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019128.html">[Twisted-Python] Re: How can I disconnect ssl connection from the	client side?
</A></li>
	<LI>Next message: <A HREF="019127.html">[Twisted-Python] Re: How can I disconnect ssl connection from	the	client side?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19126">[ date ]</a>
              <a href="thread.html#19126">[ thread ]</a>
              <a href="subject.html#19126">[ subject ]</a>
              <a href="author.html#19126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
