<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] KeyError when an errback is triggered within a	conch TCP tunnel
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20KeyError%20when%20an%20errback%20is%20triggered%20within%20a%0A%09conch%20TCP%20tunnel&In-Reply-To=%3C499CDEFC.6000609%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051703.html">
   <LINK REL="Next"  HREF="051741.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] KeyError when an errback is triggered within a	conch TCP tunnel</H1>
    <B>Luper Rouch</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20KeyError%20when%20an%20errback%20is%20triggered%20within%20a%0A%09conch%20TCP%20tunnel&In-Reply-To=%3C499CDEFC.6000609%40gmail.com%3E"
       TITLE="[Twisted-Python] KeyError when an errback is triggered within a	conch TCP tunnel">luper.rouch at gmail.com
       </A><BR>
    <I>Wed Feb 18 21:24:28 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051703.html">[Twisted-Python] KeyError when an errback is triggered within a	conch TCP tunnel
</A></li>
        <LI>Next message (by thread): <A HREF="051741.html">[Twisted-Python] Re: KeyError when an errback is triggered within a	conch TCP tunnel
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51704">[ date ]</a>
              <a href="thread.html#51704">[ thread ]</a>
              <a href="subject.html#51704">[ subject ]</a>
              <a href="author.html#51704">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>(posting it a second time with the example code inlined as pipermail did 
not like the attachment)

Sorry I have not been able to find a better title, please see the 
attached example which may be more descriptive.

Here is what it does:
  * set up an SSH connection
  * open a TCP forwarding channel through this connection
  * do something through the tunnel that will trigger an errback (in the
    example, try to do an XMLRPC call with no one listening on the
    tunnel's end)

This scenario gives me the following traceback (tested with Twisted 
8.1.0 and 8.2.0):

-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/python/log.py&quot;, 
line 84, in callWithLogger
     return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/python/log.py&quot;, 
line 69, in callWithContext
     return context.call({ILogContext: newCtx}, func, *args, **kw)
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/python/context.py&quot;, 
line 59, in callWithContext
     return self.currentContext().callWithContext(ctx, func, *args, **kw)
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/python/context.py&quot;, 
line 37, in callWithContext
     return func(*args,**kw)
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/internet/selectreactor.py&quot;, 
line 156, in _doReadOrWrite
     self._disconnectSelectable(selectable, why, method==&quot;doRead&quot;)
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/internet/posixbase.py&quot;, 
line 193, in _disconnectSelectable
     selectable.connectionLost(f)
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/internet/tcp.py&quot;, 
line 520, in connectionLost
     protocol.connectionLost(reason)
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/conch/ssh/forwarding.py&quot;, 
line 129, in connectionLost
     self.channel.loseConnection()
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/conch/ssh/channel.py&quot;, 
line 253, in loseConnection
     self.conn.sendClose(self)
   File 
&quot;/usr/lib/python2.5/site-packages/Twisted-8.2.0-py2.5-linux-i686.egg/twisted/conch/ssh/connection.py&quot;, 
line 491, in sendClose
     self.channelsToRemoteChannel[channel]))
exceptions.KeyError: 
&lt;twisted.conch.ssh.forwarding.SSHListenClientForwardingChannel instance 
at 0x972048c&gt;
-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-

It works well in the other cases, i.e.:
  * the errback is triggered but the tunnel is not used (comment line 57,
    uncomment line 59)
  * the errback is not triggered (start the XMLRPC server by uncommenting
    line 100), using the tunnel or not

You get the error only when the tunnel is used AND the errback is triggered.

To run the example execute it with an user name that can login using ssh 
on your host, e.g. 'python test.py someuser' and enter its password.

Cheers,
Luper


Example code:

-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-
#!/usr/bin/env python

import sys
from getpass import getpass
from twisted.python import log
from twisted.conch.ssh import connection, transport, userauth, keys, \
         forwarding, channel
from twisted.conch.ssh.common import NS
from twisted.internet import defer, protocol, reactor
from twisted.web import server, xmlrpc
from twisted.web.xmlrpc import Proxy


conn = None


def connect(user, host, port=22):
     return reactor.connectTCP(host, port, Factory(user, Transport))


class Factory(protocol.ClientFactory):
     def __init__(self, user, protocol):
         self.user = user
         self.protocol = protocol

     def buildProtocol(self, addr):
         p = self.protocol(self.user)
         p.factory = self
         return p


class Transport(transport.SSHClientTransport):
     def __init__(self, user):
         self.user = user

     def verifyHostKey(self, pubkey, fingerprint):
         return defer.succeed(1)

     def connectionSecure(self):
         self.requestService(UserAuth(self.user, Connection()))


class UserAuth(userauth.SSHUserAuthClient):
     def getPassword(self, prompt=None):
         return defer.succeed(getpass(&quot;password: &quot;))


class Connection(connection.SSHConnection):
     def __init__(self, *args, **kwargs):
         connection.SSHConnection.__init__(self, *args, **kwargs)
         self.forwarding_sockets = []

     def serviceStarted(self):
         # Create a tunnel from 12345 to 54321
         self.forward_port(12345, 54321)
         # Do something through the tunnel
         p = Proxy('<A HREF="http://localhost:12345/">http://localhost:12345/</A>')    # passing through the 
tunnel,
                                                 # triggers the KeyError
         #p = Proxy('<A HREF="http://localhost:54321/">http://localhost:54321/</A>')   # not using the tunnel, 
works
         print &quot;ping...&quot;,
         d = p.callRemote(&quot;ping&quot;)
         def stop_ok(response):
             print response
             conn.disconnect()
             reactor.stop()
         def stop_error(error):
             print &quot;error&quot;, error
             conn.disconnect()
             reactor.stop()
         d.addCallback(stop_ok)
         d.addErrback(stop_error)

     def serviceStopped(self):
         # Stop forwarding sockets
         for socket in self.forwarding_sockets:
             socket.stopListening()

     def forward_port(self, local_port, remote_port):
         print &quot;forwarding %d =&gt; %d&quot; % (local_port, remote_port)
         socket = reactor.listenTCP(local_port,
                 forwarding.SSHListenForwardingFactory(self,
                     (&quot;localhost&quot;, remote_port),
                     forwarding.SSHListenClientForwardingChannel))
         self.forwarding_sockets.append(socket)


class DummyServer(xmlrpc.XMLRPC):
     def xmlrpc_ping(self):
         return &quot;pong&quot;


if __name__ == &quot;__main__&quot;:
     if len(sys.argv) != 2:
         print &quot;usage: test.py user&quot;
         sys.exit(1)
     #log.startLogging(sys.stdout)

     # If the server is not running, stop_error() errback is triggered 
and we
     # have the KeyError when passing through the tunnel
     #reactor.listenTCP(54321, server.Site(DummyServer()))

     conn = connect(sys.argv[1], &quot;localhost&quot;)
     reactor.run()
-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-*-


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051703.html">[Twisted-Python] KeyError when an errback is triggered within a	conch TCP tunnel
</A></li>
	<LI>Next message (by thread): <A HREF="051741.html">[Twisted-Python] Re: KeyError when an errback is triggered within a	conch TCP tunnel
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51704">[ date ]</a>
              <a href="thread.html#51704">[ thread ]</a>
              <a href="subject.html#51704">[ subject ]</a>
              <a href="author.html#51704">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
