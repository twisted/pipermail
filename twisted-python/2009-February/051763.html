<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Why do I get an AlreadyCalledError?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Why%20do%20I%20get%20an%20AlreadyCalledError%3F&In-Reply-To=%3CEAED0465-9458-44D2-8AC1-B6F4EBFD57E8%40me.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051762.html">
   <LINK REL="Next"  HREF="051764.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Why do I get an AlreadyCalledError?</H1>
    <B>Conrad Winchester</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Why%20do%20I%20get%20an%20AlreadyCalledError%3F&In-Reply-To=%3CEAED0465-9458-44D2-8AC1-B6F4EBFD57E8%40me.com%3E"
       TITLE="[Twisted-Python] Why do I get an AlreadyCalledError?">conradwinchester at me.com
       </A><BR>
    <I>Sat Feb 28 07:57:33 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051762.html">[Twisted-Python] Why do I get an AlreadyCalledError?
</A></li>
        <LI>Next message (by thread): <A HREF="051764.html">[Twisted-Python] Why do I get an AlreadyCalledError?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51763">[ date ]</a>
              <a href="thread.html#51763">[ thread ]</a>
              <a href="subject.html#51763">[ subject ]</a>
              <a href="author.html#51763">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Jean-Paul,

Useful information, but then I am confused -

If I am running in a deferred how do I cause the errback to be called  
instead of the normal (non-error) callback?  How do I pass a failure  
object to the error handler? How should I do the  
self.process.errback(fail)?

All of this has to happen inside of the deferred doesn't it, because  
it is the deferred that is doing the work and where the errors will  
occur?

Conrad

On 28 Feb 2009, at 14:16, Jean-Paul Calderone wrote:

&gt;<i> On Sat, 28 Feb 2009 13:21:06 +0000, Conrad Winchester &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">conradwinchester at me.com</A> 
</I>&gt;<i> &gt; wrote:
</I>&gt;&gt;<i> Hi all,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I  am writing a restful twisted (8.1.0) server and am trying to  
</I>&gt;&gt;<i> return useful error statuses from requests. The problem is that  
</I>&gt;&gt;<i> even  following the documentation extremely carefully I am getting  
</I>&gt;&gt;<i> an  AlreadyCalled Error every time I generate a failure. Here is my  
</I>&gt;&gt;<i> main  class (leaving out code that I feel is not relevant to the  
</I>&gt;&gt;<i> question:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> from xml.dom import minidom
</I>&gt;&gt;<i> from twisted.web import server, resource
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> from FWGException import FWGException
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class DeferredPostHandler(resource.Resource,minidom.Document):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    NOT_IMPLEMENTED = 501
</I>&gt;&gt;<i>    BAD_REQUEST = 400
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def writeError(self, failure, request, *args, **kw):
</I>&gt;&gt;<i>        failure.trap(FWGException)
</I>&gt;&gt;<i>        request.setResponseCode(self.errorCode)
</I>&gt;&gt;<i>        request.write(&quot;Error handling request: %s&quot; %  
</I>&gt;&gt;<i> failure.getErrorMessage())
</I>&gt;&gt;<i>        request.finish()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def writeResult(self, result, request, *args, **kw):
</I>&gt;&gt;<i>        self.writexml(request)
</I>&gt;&gt;<i>        request.finish()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def render_GET(self, request):
</I>&gt;&gt;<i>        self.process=self.db.runInteraction(self.processForm,request)
</I>&gt;<i>
</I>&gt;<i> I think that self.db is a ConnectionPool instance.  This means that  
</I>&gt;<i> here,
</I>&gt;<i> you're starting self.processForm in a thread.  I'm not sure if this is
</I>&gt;<i> the reason you're having difficulties, but it may be.  See below.
</I>&gt;<i>
</I>&gt;&gt;<i>        self.process.addCallbacks(self.writeResult, self.writeError,  
</I>&gt;&gt;<i> [request], {}, [request], {})
</I>&gt;&gt;<i>        return server.NOT_DONE_YET
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have a handler that extends this
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> from DeferredPostHandler import DeferredPostHandler
</I>&gt;&gt;<i> from twisted.web import http
</I>&gt;&gt;<i> from twisted.python.failure import Failure
</I>&gt;&gt;<i> from FWGException import FWGException
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class CollectionAdminHandler(DeferredPostHandler):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def __init__(self, task, db, config):
</I>&gt;&gt;<i>        DeferredPostHandler.__init__(self,db)
</I>&gt;&gt;<i>        self.config = config
</I>&gt;&gt;<i>        self.task = task
</I>&gt;&gt;<i>        self.errorCode = http.OK
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def processForm(self, cursor, request):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        if self.task == 'add':
</I>&gt;&gt;<i>            self.addCollection(cursor, request)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        elif self.task == 'delete':
</I>&gt;&gt;<i>            self.deleteCollection(cursor, request)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        else:
</I>&gt;&gt;<i>            self.errorCode = DeferredPostHandler.NOT_IMPLEMENTED
</I>&gt;&gt;<i>            fail = Failure(FWGException(&quot;Unsupported Task&quot;))
</I>&gt;&gt;<i>            self.process.errback(fail)
</I>&gt;<i>
</I>&gt;<i> Here you're creating a Failure and errbacking a Deferred in a  
</I>&gt;<i> thread, since
</I>&gt;<i> processForm is running in a thread.  This isn't allowed.  Twisted  
</I>&gt;<i> APIs are
</I>&gt;<i> generally not safe to be called in any thread except the reactor  
</I>&gt;<i> thread.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def addCollection(self, cursor, request):
</I>&gt;&gt;<i>        fail = None
</I>&gt;&gt;<i>        if self.isValidAddRequest(request):
</I>&gt;&gt;<i>            pass
</I>&gt;&gt;<i>        else:
</I>&gt;&gt;<i>            self.errorCode = DeferredPostHandler.BAD_REQUEST
</I>&gt;&gt;<i>            fail = Failure(FWGException(&quot;Missing Parameter&quot;))
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        if fail:
</I>&gt;&gt;<i>            self.process.errback(fail);
</I>&gt;<i>
</I>&gt;<i> Likewise here.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def deleteCollection(self, cursor, request):
</I>&gt;&gt;<i>        print 'Delete Collection'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def isValidAddRequest(self, request):
</I>&gt;&gt;<i>        return 'title' in request.args and 'category' in  
</I>&gt;&gt;<i> request.args  and 'date' in request.args
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Unfortunately whenever I call
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> self.process.errback(fail)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> To remove the incorrect calls to Twisted APIs from a thread, you  
</I>&gt;<i> should
</I>&gt;<i> probably just raise an exception where you're currently errbacking  
</I>&gt;<i> that
</I>&gt;<i> Deferred.  In render_GET, or in writeError, you can handle the failure
</I>&gt;<i> which will result from that.
</I>&gt;<i>
</I>&gt;<i> Ah, and now I see your problem.  self.process is the Deferred returned
</I>&gt;<i> by runInteraction.  You're not supposed to errback that Deferred (or
</I>&gt;<i> callback it either).  A pretty good rule of thumb is that if you  
</I>&gt;<i> create
</I>&gt;<i> a Deferred, then you get to fire it.  In this case, runInteraction is
</I>&gt;<i> creating it, so runInteraction gets to fire it.  runInteraction will
</I>&gt;<i> fire it with the result of processForm, so that's why you get the  
</I>&gt;<i> error.
</I>&gt;<i> You're firing that Deferred and runInteraction is firing it.
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051762.html">[Twisted-Python] Why do I get an AlreadyCalledError?
</A></li>
	<LI>Next message (by thread): <A HREF="051764.html">[Twisted-Python] Why do I get an AlreadyCalledError?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51763">[ date ]</a>
              <a href="thread.html#51763">[ thread ]</a>
              <a href="subject.html#51763">[ subject ]</a>
              <a href="author.html#51763">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
