<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] supporting start/stop/restart behavior
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20supporting%20start/stop/restart%20behavior&In-Reply-To=20030320015843.GA29224%40doublegemini.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003315.html">
   <LINK REL="Next"  HREF="003320.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] supporting start/stop/restart behavior</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20supporting%20start/stop/restart%20behavior&In-Reply-To=20030320015843.GA29224%40doublegemini.com"
       TITLE="[Twisted-Python] supporting start/stop/restart behavior">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Mar 20 00:35:39 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="003315.html">[Twisted-Python] Re: supporting start/stop/restart behavior
</A></li>
        <LI>Next message: <A HREF="003320.html">[Twisted-Python] supporting start/stop/restart behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3319">[ date ]</a>
              <a href="thread.html#3319">[ thread ]</a>
              <a href="subject.html#3319">[ subject ]</a>
              <a href="author.html#3319">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On Wednesday, March 19, 2003, at 07:58 PM, Clark C. Evans wrote:

&gt;<i> ... what [Twisted] misses, IMHO, is a simple interface to stop and 
</I>&gt;<i> restart.
</I>
You're right, but this is the wrong way to go about fixing it.

&gt;<i> Also, it lacks a nice way to be embedded within a python script so 
</I>&gt;<i> that the __main__ == __name__ hack runs the file properly.
</I>
I disagree.  Despite the fact that I occasionally write quick scripts 
that work this way, it's for quick hacks only, and providing better 
support for it is a misleading band-aid on the deficiencies of 
multi-platform twistd functionality.

&gt;<i> And add these three lines of code to make it runnable...
</I>&gt;<i>
</I>&gt;<i>     if '__main__' == __name__:
</I>&gt;<i>         from twisted.scripts.twistd import runDirect
</I>&gt;<i>         runDirect(save=1)
</I>&gt;<i>
</I>&gt;<i> In this way, the following commands 'just work':
</I>&gt;<i>
</I>&gt;<i>     python test.py          # runs the app directly (no daemon)
</I>&gt;<i>     python test.py start    # runs the app as a deamon
</I>&gt;<i>     python test.py stop     # stops the app as a deamon
</I>&gt;<i>     python test.py restart  # restarts the app as a deamon
</I>
... on UNIX.

But, what does &quot;restart&quot; mean if you're running on Jython?  On win32?  
What interaction does this imply with native OS services?

&gt;<i> And, even twistd options can be included...
</I>&gt;<i>
</I>&gt;<i>     python test.py --quiet start
</I>&gt;<i>     python test.py --quiet
</I>
In that case, why not 'twistd -y test.py --quiet'?

&gt;<i>   1. Refactoring runApp to remove a hunk of code which
</I>&gt;<i>      runs os.kill on a pid found in the given pidfile.
</I>&gt;<i>      This is moved to another function, killApp, which
</I>&gt;<i>      takes two arguments, config and signal.   From the
</I>&gt;<i>      runApp the code then calls killApp(config, signal=0)
</I>
Currently, that code is there _only_ to determine, in a rather 
platform-specific way, whether the server should attempt to keep 
starting or not.  It's not a generalized stop-the-application.

&gt;<i>   2. Adding a new function, runDirect which does
</I>&gt;<i>      several things:
</I>&gt;<i>
</I>&gt;<i>      b.  it adds --python &lt;filename&gt; where filename is the
</I>&gt;<i>          name of the current python file (argv[0]), further,
</I>&gt;<i>          it gives a direct option in the function arguments
</I>&gt;<i>          to not save the tap file (saving a tap file is
</I>&gt;<i>          not always useful, and as an argument it is hard
</I>&gt;<i>          to miss); and
</I>
Saving a tap file is pretty much always useful.  It provides a common 
ground for introspection tools to look at what a server is doing.  I 
have gone over this in previous mails.

&gt;<i>      c.  if stop or restart are chosen, then this kills the
</I>&gt;<i>          current process using the given pidfile (which defaults
</I>&gt;<i>          to twistd.pid in the current directory) through
</I>&gt;<i>          killApp(signal=SIGTERM)
</I>
Why put this into Twisted where we have to swaddle it in a layer of 
cross-platform compatibility rather than just letting the user use 
whatever tools are available on their system for interacting with 
Twisted?

&gt;<i>      This function could be broken into the start/stop/restart
</I>&gt;<i>      behavior from the --python option; but I don't have this
</I>&gt;<i>      requirement and people in the IRC list didn't seem to think
</I>&gt;<i>      that either of these two functions are useful.
</I>&gt;<i>
</I>&gt;<i> Anyway, I'm posting to this list beacuse I think the way in
</I>&gt;<i> which twistd is used isn't obvious... i.e. the primary way
</I>&gt;<i> you'd use it with a python source file is an option buried
</I>&gt;<i> among many others.
</I>
So you are trying to solve a documentation problem by adding 
functionality to a different place, necessitating more documentation? 
:<i>-)
</I>
&gt;<i> I raised this change on the IRC list, and the primary argument
</I>&gt;<i> against the above was that it is out-of-scope; in other words,
</I>&gt;<i> one could write a shell script to do the same.   I think this
</I>&gt;<i> is a bad argument beacuse _all_ of twistd could be done in
</I>&gt;<i> a shell script.  For example, if you ask D. J. Bernstein, he'd
</I>&gt;<i> say that none of this deamon / logging behavior needs to be
</I>&gt;<i> in an application, and this is why he has his 'daemontools'.
</I>
D.J. Bernstein doesn't give a rip about portability outside of UNIX, so 
he makes the decision to write his framework for logging and 
daemonization in sh.  We write these frameworks in Python, but I agree 
with this point: none of this daemon/logging/startup/shutdown behavior 
needs to be in an application.

My view on functionality like this is that it is a platform-specific 
thing.  Even assuming that signals worked like you expect them to 
across all platforms that we are trying to support, there are other 
issues.  What about the cultural expectation of command lines?  On 
win32, the way Python programs are run isn't very natural.  On the 
command line, the location of the .exe is significant, there's no such 
thing as a shebang line, and users aren't accustomed to running 
interpreters on scripts.  They expect to have an icon to click on, 
usually a Service.  There are also differing cultural expectations of 
how you run stuff like this on MacOS.  Does the start/stop thing have a 
GUI?  A monitoring icon in the dock?

Now, we don't *currently* have functionality like that, but we hope to 
one day.  I am beginning to despair of ever actually achieving that 
goal, though, since nobody who understands it has time, and so many 
other programmers have habits that are opposed to this approach...

Supporting mechanisms in the framework that make configuration and 
introspection impossible without editing the start-up code for your 
particular application would make this eventual goal even more 
difficult than it already is.

Components written for twisted should be written in such a way that 
they can be loaded into existing applications without running a script. 
  The --python option to twistd is pushing about as far as we want to go 
in the direction of hard-coding custom functionality for a particular 
server process.

&gt;<i> So, the argument shouldn't be _can_ this be done externally,
</I>&gt;<i> of course it can.  The question is does it make sence to
</I>&gt;<i> standardize on particular ways of using twisted so that everyone
</I>&gt;<i> doesn't have their own approach, to logging, etc.  I feel that
</I>&gt;<i> this comes all the way down to Twisted having a simple way
</I>&gt;<i> to start/stop/restart a server without having to rely upon
</I>&gt;<i> external, non-Twisted scripts.
</I>
If you want to improve twistd, please feel free to suggest ways that 
stopping/restarting could be made easier or even more consistent across 
platforms.  For example, &quot;killApp&quot; might make sense if, on 
signals-challenged platforms, twistd automatically opened a 
localhost-only socket which allowed communication with the server.

&gt;<i> At the very least, I'd like the killApp refactor to be
</I>&gt;<i> accepted, as I'd rather not have to duplicate killApp
</I>&gt;<i> code within a private/sandbox copy of runDirect.
</I>
What functionality, exactly, is your platform's kill(1) missing that 
makes you want a Python version of it?
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.1 (Darwin)

iD8DBQE+eVMwvVGR4uSOE2wRAopTAJ4+JQiM0WrJYIAH2qPMCbil4bE1+gCeMRaF
X5qxxeDWi10E8IeWcuBkQE4=
=L2sp
-----END PGP SIGNATURE-----



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003315.html">[Twisted-Python] Re: supporting start/stop/restart behavior
</A></li>
	<LI>Next message: <A HREF="003320.html">[Twisted-Python] supporting start/stop/restart behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3319">[ date ]</a>
              <a href="thread.html#3319">[ thread ]</a>
              <a href="subject.html#3319">[ subject ]</a>
              <a href="author.html#3319">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
