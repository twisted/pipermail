<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] StikiWiki and textarea/woven/model problem.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20StikiWiki%20and%20textarea/woven/model%20problem.&In-Reply-To=%3C20030313141146.GA36050%40mithrandr.moria.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="035777.html">
   <LINK REL="Next"  HREF="035782.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] StikiWiki and textarea/woven/model problem.</H1>
    <B>Neil Blakey-Milner</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20StikiWiki%20and%20textarea/woven/model%20problem.&In-Reply-To=%3C20030313141146.GA36050%40mithrandr.moria.org%3E"
       TITLE="[Twisted-Python] StikiWiki and textarea/woven/model problem.">nbm at mithrandr.moria.org
       </A><BR>
    <I>Thu Mar 13 07:11:46 MST 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="035777.html">[Twisted-Python] small bugs
</A></li>
        <LI>Next message (by thread): <A HREF="035782.html">[Twisted-Python] StikiWiki and textarea/woven/model problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35778">[ date ]</a>
              <a href="thread.html#35778">[ thread ]</a>
              <a href="subject.html#35778">[ subject ]</a>
              <a href="author.html#35778">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Firstly, StikiWiki is a simple example of a somewhat Wiki-like web
application in Twisted that can create and edit reStructuredText
documents, and display them as HTML.  It's attached as stikiwiki.py.

Well, you can create documents.  Editing isn't as much editing as
rewriting.  I'm using a textarea for input, and since I haven't looked
all that much at woven, I can't figure out why its contents aren't
replaced with the existing content (via getData on the given model).

So, at the moment, you can create a page (localhost:9080/asdf/create),
type in some reST, and then go to localhost:9080/asdf and view it.  Then
go to localhost:9080/asdf/create and rewrite it.  I want to figure out
why the model's getData doesn't get involved.

Any help greatly appreciated.

Thanks,

Neil
-- 
Neil Blakey-Milner
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">nbm at mithrandr.moria.org</A>
-------------- next part --------------
#!/usr/local/bin/python
#
# Copyright (c) 2003 Neil Blakey-Milner
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.
#

from twisted.cred import service
from twisted.internet import app, reactor
from twisted.web import resource, server, static
from twisted.web.woven import model, page

from docutils import core, io
from StringIO import StringIO
from cog import db, base

entry_xhtml = &quot;&quot;&quot;
&lt;html&gt;
    &lt;head&gt;
        &lt;title model=&quot;title&quot;&gt;Quotes Galore!&lt;/title&gt;
        &lt;style&gt;.quote {color: green;}&lt;/style&gt;
    &lt;/head&gt;

    &lt;body&gt;
        &lt;h1 model=&quot;title&quot;&gt;New Page!&lt;/h1&gt;

        &lt;form action=&quot;&quot;&gt;
            &lt;textarea rows=&quot;15&quot; cols=&quot;50&quot; name=&quot;entry&quot; model=&quot;entry&quot;
                controller=&quot;Anything&quot; &gt;
                Something
            &lt;/textarea&gt;
            &lt;input type=&quot;submit&quot; /&gt;
        &lt;/form&gt;
    &lt;/body&gt;
&lt;/html&gt;
&quot;&quot;&quot;

default_css = &quot;&quot;&quot;
/*
:<i>Author: David Goodger
</I>:<i>Contact: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">goodger at users.sourceforge.net</A>
</I>:<i>date: $Date: 2002/07/27 14:55:52 $
</I>:<i>version: $Revision: 1.12 $
</I>:<i>copyright: This stylesheet has been placed in the public domain.
</I>
Default cascading style sheet for the HTML output of Docutils.
*/

a.footnote-reference {
  font-size: smaller ;
  vertical-align: super }

a.target {
  color: blue }

a.toc-backref {
  text-decoration: none ;
  color: black }

dd {
  margin-bottom: 0.5em }

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.attention, div.caution, div.danger, div.error, div.hint,
div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

div.hint p.admonition-title, div.important p.admonition-title,
div.note p.admonition-title, div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em }

div.footer, div.header {
  font-size: smaller }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr {
  width: 75% }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.first {
  margin-top: 0 }

p.label {
  white-space: nowrap }

p.topic-title {
  font-weight: bold }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.field-argument {
  font-style: italic }

span.interpreted {
  font-family: sans-serif }

span.option-argument {
  font-style: italic }

span.problematic {
  color: red }

table {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.citation {
  border-left: solid thin gray ;
  padding-left: 0.5ex }

table.docinfo {
  margin: 2em 4em }

table.footnote {
  border-left: solid thin black ;
  padding-left: 0.5ex }

td, th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: baseline }

td.docinfo-name {
  font-weight: bold ;
  text-align: right }

td.field-name {
  font-weight: bold }
&quot;&quot;&quot;

class MStikiEntry(model.Model):
    def __init__(self, page, path, value):
        model.Model.__init__(self)
        self.page = page
        self.path = path
        self.value = value

    def getData(self):
        return self.value
        pass

    def setData(self, data):
        p = StikiPage(self.page.parent, self.path, data)
        self.page.parent.putChild(self.path, p)
        print &quot;putChild with %s and %s on %s&quot; % (self.path, p.id, self.page.parent.id)

class StikiPage(object, resource.Resource):
    __persistent__ = 1

    value = &quot;&quot;&quot;
Uninitialised StikiPage
-----------------------

This StikiPage exists, but doesn't have any content in it.&quot;&quot;&quot;

    def __init__(self, parent, path, value = None):
        self.errorpage = 0
        self.final = 0
        resource.Resource.__init__(self)
        self.parent = parent
        if value:
            self.value = value
        self.id = path
        base.setDirty(self, 1)

    def getChild(self, path, request):

        if path == &quot;&quot;:
            return self

        fullpath = &quot;/&quot;.join(request.acqpath[:-2])
        shortpath = request.acqpath[-2]

        self.model = {'entry': MStikiEntry(self, shortpath, self.value), 'title': &quot;New StikiWiki Entry!&quot;}

        if path == &quot;create&quot;:
            p = page.Page(self.model, templateFile=&quot;create.xhtml&quot;)
            p.template = entry_xhtml
            return p

        if path == &quot;delete&quot;:
            return StikiErrorPage(self, path, request.uri)

        return StikiErrorPage(self, path, request.uri)

    def render(self, request):
        pub = core.Publisher()
        pub.set_reader('restructuredtext', None, 'restructuredtext')
        pub.set_writer('html')
        pub.set_options()
        pub.options._destination = ''
        pub.options.stylesheet = '/default.css'
        pub.source = io.StringIO(pub.options, source = self.value)
        pub.destination = io.StringIO(pub.options)
        pub.options.report_level = 5
        pub.options.halt_level = 6
        warnings = StringIO()
        pub.options.warning_stream = warnings
        return pub.publish()

    def putChild(self, path, res):
        resource.Resource.putChild(self, path, res)
        base.setDirty(self, 1)

class StikiErrorPage(StikiPage):
    def __init__(self, parent, path, uri, final = 0):
        StikiPage.__init__(self, parent, path)
        self.errorpage = 1
        self.final = final
        self.value = &quot;&quot;&quot;
No such entry
-------------

There is no such entry in this StikiWiki.&quot;&quot;&quot;

        if not final:
            if not uri.endswith(&quot;/&quot;):
                uri += &quot;/&quot;
            uri += &quot;create&quot;
            self.value += &quot;&quot;&quot;  `Create it?`_
            
.. _`Create it?`: %s&quot;&quot;&quot; % (uri)

    def getChild(self, path, request):
        if self.final:
            return StikiErrorPage(self, path, request.uri, 1)

        if not self.final and path == &quot;&quot;:
            self.final = 1
            return self

        fullpath = &quot;/&quot;.join(request.acqpath[:-2])
        shortpath = request.acqpath[-2]

        self.model = {'entry': MStikiEntry(self, shortpath, self.value), 'title': &quot;New StikiWiki Entry!&quot;}

        if path == &quot;create&quot;:
            p = page.Page(self.model, templateFile=&quot;create.xhtml&quot;)
            p.template = entry_xhtml
            return p

        #if path == &quot;delete&quot;:
        #    return StikiErrorPage(self, path, request.uri)

        #if self.errorpage:
        #    self.final = 1

        return StikiErrorPage(self, path, request.uri, 1)


class StikiSite(object, resource.Resource):
    __persistent__ = 1

    def __init__(self):
        resource.Resource.__init__(self)
        self.id = &quot;site&quot;

    def getChild(self, path, request):
        if path == &quot;&quot;:
            return self.getChildWithDefault(&quot;Index&quot;, request)
        return StikiErrorPage(self, path, request.uri)

    def putChild(self, path, res):
        resource.Resource.putChild(self, path, res)
        base.setDirty(self, 1)

class StikiService(app.ApplicationService):
    def startService(self):
        app.ApplicationService.startService(self)
        reactor.callLater(0, self.addDefaults)

    def addDefaults(self):
        db = self.serviceParent.getServiceNamed(&quot;cog&quot;).db

        if not db.registry.has_key(&quot;stikisite&quot;):
            self.ss = StikiSite()
            db.registry.set(&quot;stikisite&quot;, self.ss)
        else:
            self.ss = db.registry.get(&quot;stikisite&quot;)
            self.ss._load()

        self.serviceParent.listenTCP(9080, server.Site(self.ss))

        if &quot;Index&quot; not in self.ss.listStaticNames():
            self.ss.putChild(&quot;Index&quot;, StikiPage(self.ss, &quot;Index&quot;,
                &quot;&quot;&quot;
Hello World!
-----------

Hey there!&quot;&quot;&quot;))

        if &quot;default.css&quot; not in self.ss.listStaticNames():
            self.ss.putChild(&quot;default.css&quot;, static.Data(default_css, &quot;text/css&quot;))

        db.flush()
        del db

class CogService(app.ApplicationService):
    def __init__(self, path, serviceName, serviceParent=None):
        app.ApplicationService.__init__(self, serviceName, serviceParent=serviceParent)
        self.path = path

    def startService(self):
        self.db = db.openDatabase(self.path)
        self.scheduledWork = reactor.callLater(60, self.doPeriodicWork)

    def stopService(self):
        self.scheduledWork.cancel()
        del self.scheduledWork
        self.db.close()
        del self.db

    def doPeriodicWork(self):
        delay = self.db.do_periodic_work()
        self.scheduledWork = reactor.callLater(delay, self.doPeriodicWork)

    def commit(self):
        self.db.flush()

def main():
    a = app.Application(&quot;stikiwiki&quot;)
    s = StikiService(&quot;stiki&quot;, a)
    c = CogService(&quot;/tmp/cog/&quot;, &quot;cog&quot;, a)
    a.run(save=0)

if __name__ == &quot;__main__&quot;:
    main()
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="035777.html">[Twisted-Python] small bugs
</A></li>
	<LI>Next message (by thread): <A HREF="035782.html">[Twisted-Python] StikiWiki and textarea/woven/model problem.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35778">[ date ]</a>
              <a href="thread.html#35778">[ thread ]</a>
              <a href="subject.html#35778">[ subject ]</a>
              <a href="author.html#35778">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
