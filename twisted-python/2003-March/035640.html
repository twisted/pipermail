<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] patch implementing &quot;fetchmany&quot; from enterprise.adbapi
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20patch%20implementing%20%22fetchmany%22%20from%20enterprise.adbapi&In-Reply-To=%3C20030304073228.GA52396%40doublegemini.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="035693.html">
   <LINK REL="Next"  HREF="035641.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] patch implementing &quot;fetchmany&quot; from enterprise.adbapi</H1>
    <B>Clark C. Evans</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20patch%20implementing%20%22fetchmany%22%20from%20enterprise.adbapi&In-Reply-To=%3C20030304073228.GA52396%40doublegemini.com%3E"
       TITLE="[Twisted-Python] patch implementing &quot;fetchmany&quot; from enterprise.adbapi">cce at clarkevans.com
       </A><BR>
    <I>Tue Mar  4 00:32:28 MST 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="035693.html">[Twisted-Python] coding standard: column width?
</A></li>
        <LI>Next message (by thread): <A HREF="035641.html">[Twisted-Python] patch implementing 'fetchmany' from      enterprise.adbapi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35640">[ date ]</a>
              <a href="thread.html#35640">[ thread ]</a>
              <a href="subject.html#35640">[ subject ]</a>
              <a href="author.html#35640">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Please find following a patch to add the ability for fetchmany()
to be used from within the enterprise adbapi.py interface.  This
uses the patches previously posted (and included following) which
enable an iterator to be deferred via a thread.  

Basically, one can use runQueryChunked instead of runQuery 
and it will call your callback once for each &quot;fetchmany&quot;
return, which, depending on the database driver can be
about 10-50 rows at a time.  This is essential for incremental
handling of large query results.

The patch also tests for &quot;threadsaftey&quot;, for some reason
mxODBC has an apilevel of &quot;2.0&quot; yet they are missing this
attribute (they call it threadlevel).   I'm not fond of
this part of the patch, but it is included since this
is what I tested with (I don't have permissions to change
mxODBC).

The remainder of the message is hereby public domain.

Best,

Clark

--- adbapi.py.orig	Fri Feb 28 16:51:08 2003
+++ adbapi.py	Tue Mar  4 02:01:36 2003
@@ -52,7 +52,9 @@
             log.msg(&quot;Connecting to database: %s %s %s&quot; % (dbapiName, connargs, connkw))
         self.dbapi = reflect.namedModule(dbapiName)
         assert self.dbapi.apilevel == '2.0', 'DB API module not DB API 2.0 compliant.'
-        assert self.dbapi.threadsafety &gt; 0, 'DB API module not sufficiently thread-safe.'
+        if hasattr(self.dbapi,&quot;threadsaftey&quot;):
+           test = self.dbapi.threadsaftey &gt; 0 
+           assert test, 'DB API module not sufficiently thread-safe.'
         self.connargs = connargs
         self.connkw = connkw
         import thread
@@ -99,6 +101,21 @@
         curs.close()
         return result
 
+    def _runQueryChunked(self, args, kw):
+        conn = self.connect()
+        curs = conn.cursor()
+        apply(curs.execute, args, kw)
+        class fetchChunk:
+            def __init__(self,curs):
+                self.curs = curs
+            def next(self):
+                ret = self.curs.fetchmany()
+                if not ret:
+                    self.curs.close()
+                    raise StopIteration
+                return ret
+        return fetchChunk(curs)
+
     def _runOperation(self, args, kw):
         &quot;&quot;&quot;This is used for non-query operations that don't want &quot;fetch*&quot; to be called
         &quot;&quot;&quot;
@@ -121,6 +138,10 @@
         threads.deferToThread(self._runQuery, args, kw).addCallbacks(
             callback, errback)
 
+    def queryChunked(self, callback, errback, *args, **kw):
+        threads.deferIterationToThread(self._runQueryChunked, args, kw
+                                      ).addCallbacks(callback, errback)
+
     def operation(self, callback, errback, *args, **kw):
         threads.deferToThread(self._runOperation, args, kw).addCallbacks(
             callback, errback)
@@ -229,6 +250,11 @@
         apply(self.dbpool.query, (d.callback, d.errback)+args, kw)
         return d
 
+    def runQueryChunked(self, *args, **kw):
+        d = defer.MultiCallDeferred()
+        apply(self.dbpool.queryChunked, (d.callback, d.errback)+args, kw)
+        return d
+
     def runOperation(self, *args, **kw):
         d = defer.Deferred()
         apply(self.dbpool.operation, (d.callback,d.errback)+args, kw)



----- Forwarded message from &quot;Clark C. Evans&quot; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">cce at clarkevans.com</A>&gt; -----
From: &quot;Clark C. Evans&quot; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">cce at clarkevans.com</A>&gt;
To: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>
Subject: [Twisted-Python] patch implementing deferIterationToThread
Date: Tue, 4 Mar 2003 05:46:48 +0000

Please find a patch to internet/defer.py and iternet/threads.py
which enables an &quot;iterator&quot; to be deferred to a thread.  This is
useful since often you have a long running process (a database
query for example) which you'd like to return results every
once and a while rather than delivering all of the output 
at the end of the process.  This patch adds to the given
files (it doesn't change any code).

The remainder of the message is hereby public domain.

#
# code to append to defer.py
#
class MultiCallDeferred(Deferred):
    &quot;&quot;&quot;This is a verision of Deferred which can be invoked more
       than once.  This is accomplished by cloning the current
       deferred object and carrying out the callbacks on the clone.
    &quot;&quot;&quot;
    def _startRunCallbacks(self, result, isError):
        clone = Deferred()
        clone.default = self.default
        for x in self.callbacks:
            clone.callbacks.append(x)
        clone._startRunCallbacks(result, isError)

#
# code to be added to threads.py
#
def _putIterationInDeferred(deferred, f, args, kwargs):
    &quot;&quot;&quot;Send the results of an iteration to a deferred.
       The function called should return an object
       with a next() operator.  This is the ideal mechanism
       to defer a generator.
    &quot;&quot;&quot;
    from twisted.internet import reactor
    try:
        itr = apply(f, args, kwargs)
        while 1:
            reactor.callFromThread(deferred.callback, itr.next())
    except StopIteration: pass
    except:
        f = failure.Failure()
        reactor.callFromThread(deferred.errback, f)
def deferIterationToThread(f, *args, **kwargs):
    &quot;&quot;&quot;Run the results of an iterator in a thread.&quot;&quot;&quot;
    d = defer.MultiCallDeferred()
    reactor.callInThread(_putIterationInDeferred, d, f, args, kwargs)
    return d

#
# usage using iterators (or generators for simpler syntax)
# 
from twisted.internet.threads import deferIterationToThread
from twisted.internet import reactor
class producer:
    def __init__(self):
        self.val = 9
    def next(self):
        val = self.val
        if val &lt; 1: raise StopIteration
        self.val -= 1
        return val
def bldr(): return producer()
def printResult(x): print x
d = deferIterationToThread(bldr)
d.addCallback(printResult)
try: # if you have generators
    from __future__ import generators
    def gene(start=99):
        while(start &gt; 90):
            yield start
            start -= 1
    d = deferIterationToThread(gene)
    d.addCallback(printResult)
except: pass
reactor.run()


_______________________________________________
Twisted-Python mailing list
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>

----- End forwarded message -----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="035693.html">[Twisted-Python] coding standard: column width?
</A></li>
	<LI>Next message (by thread): <A HREF="035641.html">[Twisted-Python] patch implementing 'fetchmany' from      enterprise.adbapi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#35640">[ date ]</a>
              <a href="thread.html#35640">[ thread ]</a>
              <a href="subject.html#35640">[ subject ]</a>
              <a href="author.html#35640">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
