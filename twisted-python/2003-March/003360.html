<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] ssl.py patch + example client /w server certificate verify
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20ssl.py%20patch%20%2B%20example%20client%20/w%20server%20certificate%20verify&In-Reply-To=20030325205733.GA53709%40doublegemini.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003356.html">
   <LINK REL="Next"  HREF="003363.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] ssl.py patch + example client /w server certificate verify</H1>
    <B>Clark C. Evans</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20ssl.py%20patch%20%2B%20example%20client%20/w%20server%20certificate%20verify&In-Reply-To=20030325205733.GA53709%40doublegemini.com"
       TITLE="[Twisted-Python] ssl.py patch + example client /w server certificate verify">cce at clarkevans.com
       </A><BR>
    <I>Tue Mar 25 18:04:10 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="003356.html">[Twisted-Python] ssl.py patch + example client /w server certificate verify
</A></li>
        <LI>Next message: <A HREF="003363.html">[Twisted-Python] ssl.py/client.py patches to implement getSecurePage()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3360">[ date ]</a>
              <a href="thread.html#3360">[ thread ]</a>
              <a href="subject.html#3360">[ subject ]</a>
              <a href="author.html#3360">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>With some help from etrepum (Bob Ippolito), the example is smaller,
and it even includes using POST.   Thanks Bob.

    from twisted.internet import reactor, ssl
    from twisted.web import client
    import urllib
    
    HOST = 'localhost'; PORT = 8443
    serverCertificate = file(&quot;server.crt&quot;).read()
    
    def verifyCert(cert):
        return ssl.dumpCertificate(cert) == serverCertificate
    
    def getdata():
        postdata = urllib.urlencode({'some': 'argument', 'another': 'arg'})
        headers  = {&quot;Content-type&quot;:&quot;application/x-www-form-urlencoded&quot;}
        context  = ssl.DefaultOpenSSLContextFactory(
                      &quot;client.key&quot;,&quot;client.crt&quot;,
                      verifyCallback = verifyCert)
        factory = client.HTTPClientFactory(HOST, &quot;/some/path&quot;, &quot;POST&quot;,
                                    postdata,  headers )
        reactor.connectSSL(HOST, PORT, factory, context)
        return factory.deferred
    
    def result(data): print data
    
    if __name__ == '__main__':
        reactor.callLater(5, reactor.stop)
        deferred = getdata()
        deferred.addCallback(result)
        reactor.run()

Ooh, this still requires the following patch to twisted.internet.ssl

--- ssl.py.orig	Tue Mar 25 13:44:40 2003
+++ ssl.py	Tue Mar 25 15:32:15 2003
@@ -36,7 +36,7 @@
 &quot;&quot;&quot;
 
 # System imports
-from OpenSSL import SSL
+from OpenSSL import SSL, crypto
 import socket
 
 # sibling imports
@@ -55,20 +55,32 @@
         &quot;&quot;&quot;Return a SSL.Context object. override in subclasses.&quot;&quot;&quot;
         raise NotImplementedError
 
+def dumpCertificate(cert, filetype = crypto.FILETYPE_PEM ):
+    ''' a helper to dump an incoming cert as a PEM '''
+    return crypto.dump_certificate(filetype, cert)
 
 class DefaultOpenSSLContextFactory(ContextFactory):
 
     def __init__(self, privateKeyFileName, certificateFileName,
-                 sslmethod=SSL.SSLv23_METHOD):
-        self.privateKeyFileName = privateKeyFileName
+                 sslmethod=SSL.SSLv23_METHOD, verifyCallback = None):
+        self.verifyCallback      = (verifyCallback, )      
+        self.privateKeyFileName  = privateKeyFileName
         self.certificateFileName = certificateFileName
         self.sslmethod = sslmethod
         self.cacheContext()
 
+                        
+    def verifyCertificate(self, conn, cert, errno, depth, retcode):
+        cb = self.verifyCallback[0]
+        if cb: return cb(cert)
+        return 1
+
     def cacheContext(self):
         ctx = SSL.Context(self.sslmethod)
         ctx.use_certificate_file(self.certificateFileName)
         ctx.use_privatekey_file(self.privateKeyFileName)
+        if self.verifyCallback[0]:
+            ctx.set_verify(SSL.VERIFY_PEER, self.verifyCertificate) 
         self._context = ctx
 
     def __getstate__(self):



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003356.html">[Twisted-Python] ssl.py patch + example client /w server certificate verify
</A></li>
	<LI>Next message: <A HREF="003363.html">[Twisted-Python] ssl.py/client.py patches to implement getSecurePage()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3360">[ date ]</a>
              <a href="thread.html#3360">[ thread ]</a>
              <a href="subject.html#3360">[ subject ]</a>
              <a href="author.html#3360">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
