<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] PyOpenSSL empty socket property
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20PyOpenSSL%20empty%20socket%20property&In-Reply-To=%3CCAObs90D9WZvU0qnrQeGOPHsSqp7izmzJZ59uqwWEYpR9tnfp8w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] PyOpenSSL empty socket property</H1>
    <B>Arn Vollebregt</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20PyOpenSSL%20empty%20socket%20property&In-Reply-To=%3CCAObs90D9WZvU0qnrQeGOPHsSqp7izmzJZ59uqwWEYpR9tnfp8w%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] PyOpenSSL empty socket property">kpn.arn.vollebregt at gmail.com
       </A><BR>
    <I>Wed Sep  4 02:37:39 MDT 2019</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64910">[ date ]</a>
              <a href="thread.html#64910">[ thread ]</a>
              <a href="subject.html#64910">[ subject ]</a>
              <a href="author.html#64910">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I noticed that PyOpenSSL SNI callbacks (set with
*ctx.set_tlsext_servername_callback*) receive a *OpenSSL.SSL.Connection*
object within Twisted that have an empty *_socket* property, while this
property *is* actually set when using *PyOpenSSL* directly. For my use-case
this is a problem as I want to call *conn._socket.getpeername()* to
determine the peer's IP address. So I am wondering: why is this behaviour
different? And how do I get the peer IP address?

---console---
user:~$ sudo python testTwisted.py &amp;
[3] 32842
user:~$ curl -s --insecure --key clientPrivateKey.pem --cert
clientCertificate.pem <A HREF="https://127.0.0.1">https://127.0.0.1</A> &gt; /dev/null
'sniCallback' called.
        conn._socket: None
'verifyCallback' called for result 0
        conn._socket: None
'verifyCallback' called for result 1
        conn._socket: None
user:~$ sudo python testPyOpenSSL.py &amp;
[1] 33270
user:~$ curl -s --insecure --key clientPrivateKey.pem --cert
clientCertificate.pem <A HREF="https://127.0.0.1">https://127.0.0.1</A> &gt; /dev/null
'sniCallback' called.
        conn._socket: &lt;socket._socketobject object at 0x7f34c5bd3130&gt;
&lt;class 'OpenSSL.SSL.Connection'&gt;
'verifyCallback' called for result 0
        conn._socket: &lt;socket._socketobject object at 0x7f34c5bd3130&gt;
'verifyCallback' called for result 1
        conn._socket: &lt;socket._socketobject object at 0x7f34c5bd3130&gt;
127.0.0.1 - - [29/Aug/2019 11:45:47] &quot;GET / HTTP/1.1&quot; 200 -
------

---testTwisted.py---
### Generate server key material ###
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout
serverPrivateKey.pem -out serverCertificate.pem -subj
&quot;/C=''/O=''/OU=''/CN=server&quot;
### Generate client key material ###
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout
clientPrivateKey.pem -out clientCertificate.pem -subj
&quot;/C=''/O=''/OU=''/CN=client&quot;
from __future__ import print_function
#<A HREF="https://twistedmatrix.com/documents/12.0.0/core/howto/ssl.html">https://twistedmatrix.com/documents/12.0.0/core/howto/ssl.html</A>
from OpenSSL import SSL
from twisted.internet import ssl, reactor
from twisted.web import server, resource
from twisted.internet.protocol import Factory, Protocol

def verifyCallback(conn, cert, errno, depth, result):
    print('\'verifyCallback\' called for result ' + str(result))
    print('\tconn._socket: ' + str(conn._socket))
    return True

def sniCallback(conn):
    print('\'sniCallback\' called.')
    print('\tconn._socket: ' + str(conn._socket))

class MainResource(resource.Resource):
    isLeaf = True

    def render_GET(self, request):
        request.responseHeaders.addRawHeader(&quot;Content-Type&quot;, &quot;text/html;
charset=utf-8&quot;)
        return b&quot;&lt;html&gt;&lt;body&gt;Hello World&lt;/body&gt;&lt;/html&gt;&quot;

if __name__ == '__main__':
    myContextFactory = ssl.DefaultOpenSSLContextFactory(
        'serverPrivateKey.pem',
        'serverCertificate.pem'
    )
    ctx = myContextFactory.getContext()
    #
<A HREF="https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_verify">https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_verify</A>
    ctx.set_verify(SSL.VERIFY_PEER, verifyCallback)
    #
<A HREF="https://pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_tlsext_servername_callback">https://pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_tlsext_servername_callback</A>
    ctx.set_tlsext_servername_callback(sniCallback)

    site = server.Site(MainResource())
    reactor.listenSSL(443, site, myContextFactory)
    reactor.run()
------

---testPyOpenSSL.py---
### Generate server key material ###
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout
serverPrivateKey.pem -out serverCertificate.pem -subj
&quot;/C=''/O=''/OU=''/CN=server&quot;
### Generate client key material ###
# openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout
clientPrivateKey.pem -out clientCertificate.pem -subj
&quot;/C=''/O=''/OU=''/CN=client&quot;
from __future__ import print_function
import socket, sys, os
from SocketServer import BaseServer
from BaseHTTPServer import HTTPServer
from SimpleHTTPServer import SimpleHTTPRequestHandler
from OpenSSL import SSL

def verifyCallback(conn, cert, errno, depth, result):
    print('\'verifyCallback\' called for result ' + str(result))
    print('\tconn._socket: ' + str(conn._socket))
    return True

def sniCallback(conn):
    print('\'sniCallback\' called.')
    print('\tconn._socket: ' + str(conn._socket))
    print(type(conn))

class SecureHTTPServer(HTTPServer):
    def __init__(self, server_address, HandlerClass):
        BaseServer.__init__(self, server_address, HandlerClass)
        ctx = SSL.Context(SSL.TLSv1_2_METHOD)
        ctx.use_privatekey_file('serverPrivateKey.pem')
        ctx.use_certificate_file('serverCertificate.pem')
        #
<A HREF="https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_verify">https://www.pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_verify</A>
        ctx.set_verify(SSL.VERIFY_PEER, verifyCallback)
        #
<A HREF="https://pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_tlsext_servername_callback">https://pyopenssl.org/en/stable/api/ssl.html#OpenSSL.SSL.Context.set_tlsext_servername_callback</A>
        ctx.set_tlsext_servername_callback(sniCallback)
        self.socket = SSL.Connection(ctx,
socket.socket(self.address_family,self.socket_type))
        self.server_bind()
        self.server_activate()

    def shutdown_request(self,request):
        request.shutdown()

class SecureHTTPRequestHandler(SimpleHTTPRequestHandler):
    def setup(self):
        self.connection = self.request
        self.rfile = socket._fileobject(self.request, &quot;rb&quot;, self.rbufsize)
        self.wfile = socket._fileobject(self.request, &quot;wb&quot;, self.wbufsize)

    def do_GET(self):
        self.send_response(200)
        SimpleHTTPRequestHandler.end_headers(self)
        self.wfile.write('&lt;html&gt;&lt;body&gt;Hello World&lt;/body&gt;&lt;/html&gt;')

if __name__ == '__main__':
    ip,port = ('0.0.0.0', 443)
    httpd = SecureHTTPServer((ip, port), SecureHTTPRequestHandler)
    httpd.serve_forever()
------

(Please note that even though these examples are for Python2 (due to other
quirks) I am aiming to implement this in Python3.)

Regards,

Arn
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190904/62fa0936/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64910">[ date ]</a>
              <a href="thread.html#64910">[ thread ]</a>
              <a href="subject.html#64910">[ subject ]</a>
              <a href="author.html#64910">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
