<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] HTTP PUT a GET's streaming response with treq
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20HTTP%20PUT%20a%20GET%27s%20streaming%20response%20with%20treq&In-Reply-To=%3C275d565a-5c59-636a-736d-91c26f618524%40imperial.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031410.html">
   <LINK REL="Next"  HREF="031415.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] HTTP PUT a GET's streaming response with treq</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20HTTP%20PUT%20a%20GET%27s%20streaming%20response%20with%20treq&In-Reply-To=%3C275d565a-5c59-636a-736d-91c26f618524%40imperial.ac.uk%3E"
       TITLE="[Twisted-Python] HTTP PUT a GET's streaming response with treq">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Fri May  5 02:26:49 MDT 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031410.html">[Twisted-Python] HTTP PUT a GET's streaming response with treq
</A></li>
        <LI>Next message (by thread): <A HREF="031415.html">[Twisted-Python] HTTP PUT a GET's streaming response with treq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31414">[ date ]</a>
              <a href="thread.html#31414">[ thread ]</a>
              <a href="subject.html#31414">[ subject ]</a>
              <a href="author.html#31414">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04/05/17 16:30, Nagy, Attila wrote:

&gt;<i> I would like to use the simplest (and correct of course) solution.
</I>&gt;<i> Juggling with buffering/data by hand seems even more risky to me.
</I>
The problem with the approach you've outlined is that it treats the 
transport (a private member) in ways that I suspect are invalid. In 
particular there's no handling of the length of the object or chunked 
encodings - I suspect what you're doing will only work on simple HTTP 
requests with no connection reuse.

I *think* if you use the t.web deliverBody response method, you get 
legal access to a transport (via an IProtocol you provide) and the API 
docs confirm that transport can be accessed and paused.

However if you look at:

<A HREF="https://github.com/twisted/twisted/blob/twisted-17.1.0/src/twisted/web/_newclient.py#L1069">https://github.com/twisted/twisted/blob/twisted-17.1.0/src/twisted/web/_newclient.py#L1069</A>

...you'll see that deliverBody starts writing to the transport straight 
away, and you have no way to know if the consumer will have been 
provided to IBodyProducer at that point, or if it'll have been paused.

I think you inevitably will have to buffer some data, and a quick PoC of 
that code suggests to me that handling of the return deferred from 
startProducing is quite complex.


Perhaps someone more knowledgeable than I can chime in here?

&gt;<i> Your implementation seems to do things which twisted should do, which
</I>&gt;<i> (also) doesn't seem to be right. :)
</I>&gt;<i> It would be nice if this could be solved in an elegant way.
</I>
On that I completely agree. It could be that there's some simple idiom 
or built-in code for this that I'm unaware of.

&gt;<i> BTW (without reading it), I've tried your solution (thank you very much
</I>&gt;<i> for it!).
</I>&gt;<i> From a 1073741824 bytes source file, it transferred a 1056490639
</I>&gt;<i> destination file.
</I>
Hey, I did say lightly tested ;o)

I think it's a bug in cleanly handling things at the end of the request.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031410.html">[Twisted-Python] HTTP PUT a GET's streaming response with treq
</A></li>
	<LI>Next message (by thread): <A HREF="031415.html">[Twisted-Python] HTTP PUT a GET's streaming response with treq
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31414">[ date ]</a>
              <a href="thread.html#31414">[ thread ]</a>
              <a href="subject.html#31414">[ subject ]</a>
              <a href="author.html#31414">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
