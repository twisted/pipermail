<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted irc client + packet capturing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20irc%20client%20%2B%20packet%20capturing&In-Reply-To=%3C20131108120855.8349.1701346083.divmod.xquotient.386%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="060151.html">
   <LINK REL="Next"  HREF="060153.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted irc client + packet capturing</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20irc%20client%20%2B%20packet%20capturing&In-Reply-To=%3C20131108120855.8349.1701346083.divmod.xquotient.386%40top%3E"
       TITLE="[Twisted-Python] twisted irc client + packet capturing">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri Nov  8 05:08:55 MST 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="060151.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
        <LI>Next message (by thread): <A HREF="060153.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60152">[ date ]</a>
              <a href="thread.html#60152">[ thread ]</a>
              <a href="subject.html#60152">[ subject ]</a>
              <a href="author.html#60152">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 08:50 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ewong at pw-wspx.org</A> wrote:
&gt;<i>Hi,
</I>&gt;<i>
</I>&gt;<i>I've created a script that would log on to an irc server, while
</I>&gt;<i>capturing packets.
</I>&gt;<i>
</I>&gt;<i>I came across the following link:
</I>&gt;<i>
</I>&gt;<i><A HREF="http://dound.com/2009/09/integrating-twisted-with-a-pcap-based-python-">http://dound.com/2009/09/integrating-twisted-with-a-pcap-based-python-</A> 
</I>&gt;<i>packet-sniffer/
</I>&gt;<i>
</I>&gt;<i>But I'm using pycap (<A HREF="http://pycap.sourceforge.net/">http://pycap.sourceforge.net/</A>), but I'm having
</I>&gt;<i>some difficulties with getting it to work.
</I>&gt;<i>
</I>&gt;<i>Here's the code:
</I>&gt;<i>
</I>&gt;<i># Copyright (c) Twisted Matrix Laboratories.
</I>&gt;<i># See LICENSE for details.
</I>&gt;<i>
</I>&gt;<i># twisted imports
</I>&gt;<i>from twisted.words.protocols import irc
</I>&gt;<i>from twisted.internet import reactor, protocol
</I>&gt;<i>from twisted.python import log
</I>&gt;<i>from twisted.internet.defer import Deferred
</I>&gt;<i>
</I>&gt;<i># system imports
</I>&gt;<i>import time, sys
</I>&gt;<i>
</I>&gt;<i>import pycap.capture
</I>&gt;<i>
</I>&gt;<i>def run_pcap(f):
</I>&gt;<i>     p = pycap.capture.capture('eth0')
</I>&gt;<i>     p.filter('src host ! 192.168.1.100 and dst host ! 192.168.1.100 and 
</I>&gt;<i>dst port 25')
</I>&gt;<i>     packet = None
</I>&gt;<i>     print &quot;Listening...\n&quot;
</I>&gt;<i>     while 1:
</I>&gt;<i>        if packet:
</I>&gt;<i>           print &quot;Received packet.&quot;
</I>&gt;<i>           reactor.callFromThread(f, packet)
</I>&gt;<i>        else:
</I>&gt;<i>           print &quot;no packet\n&quot;
</I>&gt;<i>        packet = p.next()
</I>&gt;<i>
</I>&gt;<i>class LogBot(irc.IRCClient):
</I>&gt;<i>     &quot;&quot;&quot;A logging IRC bot.&quot;&quot;&quot;
</I>&gt;<i>
</I>&gt;<i>     nickname = &quot;testbot&quot;
</I>&gt;<i>
</I>&gt;<i>     def packetShow(self, packet):
</I>&gt;<i>         &quot;&quot;&quot; booga &quot;&quot;&quot;
</I>&gt;<i>         msg = &quot;Port 25 hit | From:[%s] To:[%s]&quot; % (packet[1].source, 
</I>&gt;<i>packet[1].destination)
</I>&gt;<i>         self.msg(self.channel, msg)
</I>&gt;<i>
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         irc.IRCClient.connectionMade(self)
</I>&gt;<i>         print &quot;Setting up callInThread\n&quot;
</I>&gt;<i>         reactor.callInThread(run_pcap, self.packetShow)
</I>&gt;<i>         print &quot;Finished setting up callInThread\n&quot;
</I>&gt;<i>
</I>&gt;<i>     def connectionLost(self, reason):
</I>&gt;<i>         irc.IRCClient.connectionLost(self, reason)
</I>&gt;<i>
</I>&gt;<i>     # callbacks for events
</I>&gt;<i>
</I>&gt;<i>     def signedOn(self):
</I>&gt;<i>         &quot;&quot;&quot;Called when bot has succesfully signed on to server.&quot;&quot;&quot;
</I>&gt;<i>         print &quot;Signing on to %s.\n&quot; % self.factory.channel
</I>&gt;<i>         # self.join(self.factory.channel)
</I>&gt;<i>         self.sendLine(&quot;JOIN %s&quot; % (self.factory.channel,))
</I>&gt;<i>
</I>&gt;<i>     def joined(self, channel):
</I>&gt;<i>         &quot;&quot;&quot;This will get called when the bot joins the channel.&quot;&quot;&quot;
</I>&gt;<i>         print &quot;Joining channel %s.&quot; % channel
</I>&gt;<i>
</I>&gt;<i>     def privmsg(self, user, channel, msg):
</I>&gt;<i>         &quot;&quot;&quot;This will get called when the bot receives a message.&quot;&quot;&quot;
</I>&gt;<i>         user = user.split('!', 1)[0]
</I>&gt;<i>
</I>&gt;<i>         # Check to see if they're sending me a private message
</I>&gt;<i>         if channel == self.nickname:
</I>&gt;<i>             msg = &quot;It isn't nice to whisper!  Play nice with the 
</I>&gt;<i>group.&quot;
</I>&gt;<i>             self.msg(user, msg)
</I>&gt;<i>             return
</I>&gt;<i>
</I>&gt;<i>         # Otherwise check to see if it is a message directed at me
</I>&gt;<i>         if msg.startswith(self.nickname + &quot;:&quot;):
</I>&gt;<i>             msg = &quot;%s: I am a log bot&quot; % user
</I>&gt;<i>             self.msg(channel, msg)
</I>&gt;<i>
</I>&gt;<i>     def action(self, user, channel, msg):
</I>&gt;<i>         &quot;&quot;&quot;This will get called when the bot sees someone do an 
</I>&gt;<i>action.&quot;&quot;&quot;
</I>&gt;<i>         user = user.split('!', 1)[0]
</I>&gt;<i>
</I>&gt;<i>     # irc callbacks
</I>&gt;<i>
</I>&gt;<i>     def irc_NICK(self, prefix, params):
</I>&gt;<i>         &quot;&quot;&quot;Called when an IRC user changes their nickname.&quot;&quot;&quot;
</I>&gt;<i>         old_nick = prefix.split('!')[0]
</I>&gt;<i>         new_nick = params[0]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     # For fun, override the method that determines how a nickname is 
</I>&gt;<i>changed on
</I>&gt;<i>     # collisions. The default method appends an underscore.
</I>&gt;<i>     def alterCollidedNick(self, nickname):
</I>&gt;<i>         &quot;&quot;&quot;
</I>&gt;<i>         Generate an altered version of a nickname that caused a 
</I>&gt;<i>collision in an
</I>&gt;<i>         effort to create an unused related name for subsequent 
</I>&gt;<i>registration.
</I>&gt;<i>         &quot;&quot;&quot;
</I>&gt;<i>         return nickname + '^'
</I>&gt;<i>
</I>&gt;<i>class LogBotFactory(protocol.ClientFactory):
</I>&gt;<i>     &quot;&quot;&quot;A factory for LogBots.
</I>&gt;<i>
</I>&gt;<i>     A new protocol instance will be created each time we connect to the 
</I>&gt;<i>server.
</I>&gt;<i>     &quot;&quot;&quot;
</I>&gt;<i>
</I>&gt;<i>     def __init__(self, channel):
</I>&gt;<i>         self.channel = channel
</I>&gt;<i>
</I>&gt;<i>     def buildProtocol(self, addr):
</I>&gt;<i>         p = LogBot()
</I>&gt;<i>         p.factory = self
</I>&gt;<i>         return p
</I>&gt;<i>
</I>&gt;<i>     def clientConnectionLost(self, connector, reason):
</I>&gt;<i>         &quot;&quot;&quot;If we get disconnected, reconnect to server.&quot;&quot;&quot;
</I>&gt;<i>         connector.connect()
</I>&gt;<i>
</I>&gt;<i>     def clientConnectionFailed(self, connector, reason):
</I>&gt;<i>         print &quot;connection failed:&quot;, reason
</I>&gt;<i>         reactor.stop()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>if __name__ == '__main__':
</I>&gt;<i>     # create factory protocol and application
</I>&gt;<i>     f = LogBotFactory(&quot;#testx&quot;)
</I>&gt;<i>
</I>&gt;<i>     # connect factory to this host and port
</I>&gt;<i>     reactor.connectTCP(&quot;192.168.1.170&quot;, 6667, f)
</I>&gt;<i>
</I>&gt;<i>     # run bot
</I>&gt;<i>     reactor.run()
</I>&gt;<i>
</I>&gt;<i>I was told that perhaps I could use twisted.pair,
</I>&gt;<i>but I have no idea how to use the module.  The
</I>&gt;<i>documentation is lacking and I've only just started
</I>&gt;<i>programming in Twisted.
</I>&gt;<i>
</I>&gt;<i>Any help appreciated.
</I>
I don't know if Twisted Pair will work better for you but you can find 
the start of some documentation about it in this branch:

  <A HREF="https://twistedmatrix.com/trac/browser/branches/tuntap-pytun-6169-3">https://twistedmatrix.com/trac/browser/branches/tuntap-pytun-6169-3</A>

Additionally, this branch removes the Twisted Pair dependency on the 
&quot;eunuchs&quot; module which is abandoned and difficult to find.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="060151.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
	<LI>Next message (by thread): <A HREF="060153.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60152">[ date ]</a>
              <a href="thread.html#60152">[ thread ]</a>
              <a href="subject.html#60152">[ subject ]</a>
              <a href="author.html#60152">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
