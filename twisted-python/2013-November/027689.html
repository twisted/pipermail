<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted irc client + packet capturing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20irc%20client%20%2B%20packet%20capturing&In-Reply-To=%3C527CA5DD.70306%40pw-wspx.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="060149.html">
   <LINK REL="Next"  HREF="060151.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted irc client + packet capturing</H1>
    <B>Edmund Wong</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20irc%20client%20%2B%20packet%20capturing&In-Reply-To=%3C527CA5DD.70306%40pw-wspx.org%3E"
       TITLE="[Twisted-Python] twisted irc client + packet capturing">ewong at pw-wspx.org
       </A><BR>
    <I>Fri Nov  8 01:50:37 MST 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="060149.html">[Twisted-Python] Strange DataLoosing Problem after some time of connection
</A></li>
        <LI>Next message (by thread): <A HREF="060151.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27689">[ date ]</a>
              <a href="thread.html#27689">[ thread ]</a>
              <a href="subject.html#27689">[ subject ]</a>
              <a href="author.html#27689">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I've created a script that would log on to an irc server, while
capturing packets.

I came across the following link:

<A HREF="http://dound.com/2009/09/integrating-twisted-with-a-pcap-based-python-packet-sniffer/">http://dound.com/2009/09/integrating-twisted-with-a-pcap-based-python-packet-sniffer/</A>

But I'm using pycap (<A HREF="http://pycap.sourceforge.net/">http://pycap.sourceforge.net/</A>), but I'm having
some difficulties with getting it to work.

Here's the code:

# Copyright (c) Twisted Matrix Laboratories.
# See LICENSE for details.

# twisted imports
from twisted.words.protocols import irc
from twisted.internet import reactor, protocol
from twisted.python import log
from twisted.internet.defer import Deferred

# system imports
import time, sys

import pycap.capture

def run_pcap(f):
     p = pycap.capture.capture('eth0')
     p.filter('src host ! 192.168.1.100 and dst host ! 192.168.1.100 and 
dst port 25')
     packet = None
     print &quot;Listening...\n&quot;
     while 1:
        if packet:
           print &quot;Received packet.&quot;
           reactor.callFromThread(f, packet)
        else:
           print &quot;no packet\n&quot;
        packet = p.next()

class LogBot(irc.IRCClient):
     &quot;&quot;&quot;A logging IRC bot.&quot;&quot;&quot;

     nickname = &quot;testbot&quot;

     def packetShow(self, packet):
         &quot;&quot;&quot; booga &quot;&quot;&quot;
         msg = &quot;Port 25 hit | From:[%s] To:[%s]&quot; % (packet[1].source, 
packet[1].destination)
         self.msg(self.channel, msg)

     def connectionMade(self):
         irc.IRCClient.connectionMade(self)
         print &quot;Setting up callInThread\n&quot;
         reactor.callInThread(run_pcap, self.packetShow)
         print &quot;Finished setting up callInThread\n&quot;

     def connectionLost(self, reason):
         irc.IRCClient.connectionLost(self, reason)

     # callbacks for events

     def signedOn(self):
         &quot;&quot;&quot;Called when bot has succesfully signed on to server.&quot;&quot;&quot;
         print &quot;Signing on to %s.\n&quot; % self.factory.channel
         # self.join(self.factory.channel)
         self.sendLine(&quot;JOIN %s&quot; % (self.factory.channel,))

     def joined(self, channel):
         &quot;&quot;&quot;This will get called when the bot joins the channel.&quot;&quot;&quot;
         print &quot;Joining channel %s.&quot; % channel

     def privmsg(self, user, channel, msg):
         &quot;&quot;&quot;This will get called when the bot receives a message.&quot;&quot;&quot;
         user = user.split('!', 1)[0]

         # Check to see if they're sending me a private message
         if channel == self.nickname:
             msg = &quot;It isn't nice to whisper!  Play nice with the group.&quot;
             self.msg(user, msg)
             return

         # Otherwise check to see if it is a message directed at me
         if msg.startswith(self.nickname + &quot;:&quot;):
             msg = &quot;%s: I am a log bot&quot; % user
             self.msg(channel, msg)

     def action(self, user, channel, msg):
         &quot;&quot;&quot;This will get called when the bot sees someone do an action.&quot;&quot;&quot;
         user = user.split('!', 1)[0]

     # irc callbacks

     def irc_NICK(self, prefix, params):
         &quot;&quot;&quot;Called when an IRC user changes their nickname.&quot;&quot;&quot;
         old_nick = prefix.split('!')[0]
         new_nick = params[0]


     # For fun, override the method that determines how a nickname is 
changed on
     # collisions. The default method appends an underscore.
     def alterCollidedNick(self, nickname):
         &quot;&quot;&quot;
         Generate an altered version of a nickname that caused a 
collision in an
         effort to create an unused related name for subsequent 
registration.
         &quot;&quot;&quot;
         return nickname + '^'

class LogBotFactory(protocol.ClientFactory):
     &quot;&quot;&quot;A factory for LogBots.

     A new protocol instance will be created each time we connect to the 
server.
     &quot;&quot;&quot;

     def __init__(self, channel):
         self.channel = channel

     def buildProtocol(self, addr):
         p = LogBot()
         p.factory = self
         return p

     def clientConnectionLost(self, connector, reason):
         &quot;&quot;&quot;If we get disconnected, reconnect to server.&quot;&quot;&quot;
         connector.connect()

     def clientConnectionFailed(self, connector, reason):
         print &quot;connection failed:&quot;, reason
         reactor.stop()


if __name__ == '__main__':
     # create factory protocol and application
     f = LogBotFactory(&quot;#testx&quot;)

     # connect factory to this host and port
     reactor.connectTCP(&quot;192.168.1.170&quot;, 6667, f)

     # run bot
     reactor.run()

I was told that perhaps I could use twisted.pair,
but I have no idea how to use the module.  The
documentation is lacking and I've only just started
programming in Twisted.

Any help appreciated.

Edmund


</PRE>
















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="060149.html">[Twisted-Python] Strange DataLoosing Problem after some time of connection
</A></li>
	<LI>Next message (by thread): <A HREF="060151.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27689">[ date ]</a>
              <a href="thread.html#27689">[ thread ]</a>
              <a href="subject.html#27689">[ subject ]</a>
              <a href="author.html#27689">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
