<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Could Service.startService return a Deferred?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Could%20Service.startService%20return%20a%20Deferred%3F&In-Reply-To=%3C1385650876.9277.53151729.78F55A96%40webmail.messagingengine.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027786.html">
   <LINK REL="Next"  HREF="027793.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Could Service.startService return a Deferred?</H1>
    <B>Peter Westlake</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Could%20Service.startService%20return%20a%20Deferred%3F&In-Reply-To=%3C1385650876.9277.53151729.78F55A96%40webmail.messagingengine.com%3E"
       TITLE="[Twisted-Python] Could Service.startService return a Deferred?">peter.westlake at pobox.com
       </A><BR>
    <I>Thu Nov 28 08:01:16 MST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027786.html">[Twisted-Python] Could Service.startService return a Deferred?
</A></li>
        <LI>Next message: <A HREF="027793.html">[Twisted-Python] Could Service.startService return a Deferred?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27792">[ date ]</a>
              <a href="thread.html#27792">[ thread ]</a>
              <a href="subject.html#27792">[ subject ]</a>
              <a href="author.html#27792">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Nov 27, 2013, at 19:20, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:
&gt;<i> On 06:00 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">peter.westlake at pobox.com</A> wrote:
</I>... 

&gt;<i> &gt;class Runner(service.Service):
</I>&gt;<i> &gt;    def __init__(self, baton):
</I>&gt;<i> &gt;        self.baton = baton
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    def startService(self):
</I>&gt;<i> &gt;        print 'startService', self.name, reactor.running
</I>&gt;<i> &gt;        self.baton.addCallback(lambda ignore:deferLater(reactor, 1.0,
</I>&gt;<i> &gt;        self.realStartService))
</I>&gt;<i> &gt;        self.baton.addErrback(report)
</I>&gt;<i> 
</I>&gt;<i> I'd be concerned with the state of `Runner` at this point in the 
</I>&gt;<i> process.
</I>&gt;<i> 
</I>&gt;<i> What happens if the application gets shut down while that `deferLater` 
</I>&gt;<i> is still pending?
</I>&gt;<i> 
</I>&gt;<i> `stopService` has a harder job because it might need to deal with a 
</I>&gt;<i> service that is partially initialized or a service that is completely 
</I>&gt;<i> initialized (and &quot;partially initialized&quot; may cover a multitude of 
</I>&gt;<i> different states depending on the complexity of your service).
</I>&gt;<i> &gt;
</I>...
&gt;<i> 
</I>&gt;<i> What about something like this instead?
</I>&gt;<i> 
</I>&gt;<i>   @implementer(IService)
</I>&gt;<i>   class Runner(object):
</I>&gt;<i>       ...
</I>&gt;<i>       @classmethod
</I>&gt;<i>       def loadFromWhatever(cls, name):
</I>&gt;<i>           return deferLater(reactor, Runner, name)
</I>&gt;<i> 
</I>&gt;<i>       def __init__(self, name):
</I>&gt;<i>           self.name = name
</I>&gt;<i> 
</I>&gt;<i>       def startService(self):
</I>&gt;<i>           self.running = True
</I>&gt;<i>           print 'realStartService', self.name, reactor.running
</I>&gt;<i> 
</I>&gt;<i>   def parent(service):
</I>&gt;<i>       application.setServiceParent(service)
</I>&gt;<i> 
</I>&gt;<i>   loading = Runner.initializeFromWhatever(&quot;foo&quot;)
</I>&gt;<i>   loading.addCallback(parent)
</I>&gt;<i>   loading.addCallback(lambda ignored: 
</I>&gt;<i> Runner.initializeFromWhatever(&quot;bar&quot;))
</I>&gt;<i>   loading.addCallback(parent)
</I>&gt;<i>   loading.addErrback(stopTheReactorOrWhatever)
</I>&gt;<i> 
</I>&gt;<i> The advantage I see of this approach is that a `Runner` never exists in
</I>&gt;<i> the service hierarchy until it is fully initialized, started, and 
</I>&gt;<i> running.
</I>&gt;<i> 
</I>&gt;<i> If a `Runner` is only partially ready and the process shuts down then 
</I>&gt;<i> its `stopService` method isn't called because it's not part of the 
</I>&gt;<i> service hierarchy.
</I>
I'll do that, thank you!

Could the documentation for Service say something about which methods
can be called when? For instance, it would never have occurred to me
that
setServiceParent could be called after control had passed out of the
.tac
file and the reactor had started running. I see from the source that it
calls
startService, but this is definitely the sort of non-obvious tip that it
would
be helpful to have written down. Likewise the fact that startService
normally runs before the reactor starts.

Out of interest, was there a reason for not making Runner a subclass
of Service? There are some methods of IService that this version
doesn't implement.

&gt;<i> I could definitely imagine a library to help with this kind of thing. 
</I>&gt;<i> For example, perhaps you want the above encapsulated as:
</I>&gt;<i> 
</I>&gt;<i>   asynchronouslySetUpServices(application, [
</I>&gt;<i>       lambda: Runner.initializeFromWhatever(&quot;foo&quot;),
</I>&gt;<i>       lambda: Runner.initialifrFromWhatever(&quot;bar&quot;)])
</I>&gt;<i> 
</I>&gt;<i> And maybe then you want to add in some logic so that if the application 
</I>&gt;<i> gets shut down while some things are still being initialized then you 
</I>&gt;<i> cancel their Deferred.  Then you have good cleanup support for the 
</I>&gt;<i> uninitialized case - without complicating `stopService` (the cleanup 
</I>&gt;<i> logic is isolated in the implementation of Deferred cancellation where 
</I>&gt;<i> it belongs - eg, with this `deferLater`-based asynchronousness it's 
</I>&gt;<i> alreay present since deferLater implements cancellation already).
</I>
I'll add it to my list of things to do one of these years :-)
Would you like to put in a ticket with a spec?

Thanks for the help,

Peter.

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027786.html">[Twisted-Python] Could Service.startService return a Deferred?
</A></li>
	<LI>Next message: <A HREF="027793.html">[Twisted-Python] Could Service.startService return a Deferred?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27792">[ date ]</a>
              <a href="thread.html#27792">[ thread ]</a>
              <a href="subject.html#27792">[ subject ]</a>
              <a href="author.html#27792">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
