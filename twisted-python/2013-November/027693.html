<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted irc client + packet capturing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20irc%20client%20%2B%20packet%20capturing&In-Reply-To=%3CCAN0_x-KXrfqzodWh5CabHMomUUZ8g%3DGidWH9gER-MkM0HsS1ZA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027692.html">
   <LINK REL="Next"  HREF="027695.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted irc client + packet capturing</H1>
    <B>Sofiane Akermoun</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20irc%20client%20%2B%20packet%20capturing&In-Reply-To=%3CCAN0_x-KXrfqzodWh5CabHMomUUZ8g%3DGidWH9gER-MkM0HsS1ZA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] twisted irc client + packet capturing">akersof at gmail.com
       </A><BR>
    <I>Fri Nov  8 09:16:48 MST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027692.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
        <LI>Next message: <A HREF="027695.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27693">[ date ]</a>
              <a href="thread.html#27693">[ thread ]</a>
              <a href="subject.html#27693">[ subject ]</a>
              <a href="author.html#27693">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

1) create a pcapdevice
I use pcapy because it can return a file descriptor of the new
pcapdevice created

2) Use abstract.FileDescriptor
With absbract.FileDescriptor you can wrap the previvous pcapdevice
with its file descriptor into some that twisted can use properly into
the reactor. With abstract.FileDescriptor you will create an event
based pcapdevice which will read data when they income without
blocking anything and without using thread.

3) plug you twisted-like pcapdevice into your application.
Now with a pcapdevice based on abstract.FileDescriptor you can use it
into you twisted application without any problem

I will try to speed up my developpement process to show you a little
module that could permit you to do it really easly.
I am actually coding the dissector of the packet received.

kinds regards,

Sofiane Akermoun


2013/11/8 David Stainton &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dstainton415 at gmail.com</A>&gt;:
&gt;<i> I got my sniffer to work in Twisted... but then I'm not using pycap :
</I>&gt;<i> <A HREF="https://github.com/david415/hushVPN/blob/master/nflog_reader.py">https://github.com/david415/hushVPN/blob/master/nflog_reader.py</A>
</I>&gt;<i>
</I>&gt;<i> I use the NetLinkFilter socket via this python cffi:
</I>&gt;<i> <A HREF="https://github.com/mk-fg/scapy-nflog-capture">https://github.com/mk-fg/scapy-nflog-capture</A>
</I>&gt;<i> Anyhow this allows me to control which packets my sniffer picks up via
</I>&gt;<i> iptables rules like this:
</I>&gt;<i>
</I>&gt;<i> iptables -A INPUT -p tcp --dport 22 -j NFLOG
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers!
</I>&gt;<i>
</I>&gt;<i> David
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, Nov 8, 2013 at 12:50 AM, Edmund Wong &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ewong at pw-wspx.org</A>&gt; wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've created a script that would log on to an irc server, while
</I>&gt;&gt;<i> capturing packets.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I came across the following link:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://dound.com/2009/09/integrating-twisted-with-a-pcap-based-python-packet-sniffer/">http://dound.com/2009/09/integrating-twisted-with-a-pcap-based-python-packet-sniffer/</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But I'm using pycap (<A HREF="http://pycap.sourceforge.net/">http://pycap.sourceforge.net/</A>), but I'm having
</I>&gt;&gt;<i> some difficulties with getting it to work.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here's the code:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Copyright (c) Twisted Matrix Laboratories.
</I>&gt;&gt;<i> # See LICENSE for details.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # twisted imports
</I>&gt;&gt;<i> from twisted.words.protocols import irc
</I>&gt;&gt;<i> from twisted.internet import reactor, protocol
</I>&gt;&gt;<i> from twisted.python import log
</I>&gt;&gt;<i> from twisted.internet.defer import Deferred
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # system imports
</I>&gt;&gt;<i> import time, sys
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> import pycap.capture
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> def run_pcap(f):
</I>&gt;&gt;<i>     p = pycap.capture.capture('eth0')
</I>&gt;&gt;<i>     p.filter('src host ! 192.168.1.100 and dst host ! 192.168.1.100 and dst
</I>&gt;&gt;<i> port 25')
</I>&gt;&gt;<i>     packet = None
</I>&gt;&gt;<i>     print &quot;Listening...\n&quot;
</I>&gt;&gt;<i>     while 1:
</I>&gt;&gt;<i>        if packet:
</I>&gt;&gt;<i>           print &quot;Received packet.&quot;
</I>&gt;&gt;<i>           reactor.callFromThread(f, packet)
</I>&gt;&gt;<i>        else:
</I>&gt;&gt;<i>           print &quot;no packet\n&quot;
</I>&gt;&gt;<i>        packet = p.next()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class LogBot(irc.IRCClient):
</I>&gt;&gt;<i>     &quot;&quot;&quot;A logging IRC bot.&quot;&quot;&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     nickname = &quot;testbot&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def packetShow(self, packet):
</I>&gt;&gt;<i>         &quot;&quot;&quot; booga &quot;&quot;&quot;
</I>&gt;&gt;<i>         msg = &quot;Port 25 hit | From:[%s] To:[%s]&quot; % (packet[1].source,
</I>&gt;&gt;<i> packet[1].destination)
</I>&gt;&gt;<i>         self.msg(self.channel, msg)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def connectionMade(self):
</I>&gt;&gt;<i>         irc.IRCClient.connectionMade(self)
</I>&gt;&gt;<i>         print &quot;Setting up callInThread\n&quot;
</I>&gt;&gt;<i>         reactor.callInThread(run_pcap, self.packetShow)
</I>&gt;&gt;<i>         print &quot;Finished setting up callInThread\n&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def connectionLost(self, reason):
</I>&gt;&gt;<i>         irc.IRCClient.connectionLost(self, reason)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     # callbacks for events
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def signedOn(self):
</I>&gt;&gt;<i>         &quot;&quot;&quot;Called when bot has succesfully signed on to server.&quot;&quot;&quot;
</I>&gt;&gt;<i>         print &quot;Signing on to %s.\n&quot; % self.factory.channel
</I>&gt;&gt;<i>         # self.join(self.factory.channel)
</I>&gt;&gt;<i>         self.sendLine(&quot;JOIN %s&quot; % (self.factory.channel,))
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def joined(self, channel):
</I>&gt;&gt;<i>         &quot;&quot;&quot;This will get called when the bot joins the channel.&quot;&quot;&quot;
</I>&gt;&gt;<i>         print &quot;Joining channel %s.&quot; % channel
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def privmsg(self, user, channel, msg):
</I>&gt;&gt;<i>         &quot;&quot;&quot;This will get called when the bot receives a message.&quot;&quot;&quot;
</I>&gt;&gt;<i>         user = user.split('!', 1)[0]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         # Check to see if they're sending me a private message
</I>&gt;&gt;<i>         if channel == self.nickname:
</I>&gt;&gt;<i>             msg = &quot;It isn't nice to whisper!  Play nice with the group.&quot;
</I>&gt;&gt;<i>             self.msg(user, msg)
</I>&gt;&gt;<i>             return
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>         # Otherwise check to see if it is a message directed at me
</I>&gt;&gt;<i>         if msg.startswith(self.nickname + &quot;:&quot;):
</I>&gt;&gt;<i>             msg = &quot;%s: I am a log bot&quot; % user
</I>&gt;&gt;<i>             self.msg(channel, msg)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def action(self, user, channel, msg):
</I>&gt;&gt;<i>         &quot;&quot;&quot;This will get called when the bot sees someone do an action.&quot;&quot;&quot;
</I>&gt;&gt;<i>         user = user.split('!', 1)[0]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     # irc callbacks
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def irc_NICK(self, prefix, params):
</I>&gt;&gt;<i>         &quot;&quot;&quot;Called when an IRC user changes their nickname.&quot;&quot;&quot;
</I>&gt;&gt;<i>         old_nick = prefix.split('!')[0]
</I>&gt;&gt;<i>         new_nick = params[0]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     # For fun, override the method that determines how a nickname is changed
</I>&gt;&gt;<i> on
</I>&gt;&gt;<i>     # collisions. The default method appends an underscore.
</I>&gt;&gt;<i>     def alterCollidedNick(self, nickname):
</I>&gt;&gt;<i>         &quot;&quot;&quot;
</I>&gt;&gt;<i>         Generate an altered version of a nickname that caused a collision in
</I>&gt;&gt;<i> an
</I>&gt;&gt;<i>         effort to create an unused related name for subsequent registration.
</I>&gt;&gt;<i>         &quot;&quot;&quot;
</I>&gt;&gt;<i>         return nickname + '^'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class LogBotFactory(protocol.ClientFactory):
</I>&gt;&gt;<i>     &quot;&quot;&quot;A factory for LogBots.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     A new protocol instance will be created each time we connect to the
</I>&gt;&gt;<i> server.
</I>&gt;&gt;<i>     &quot;&quot;&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def __init__(self, channel):
</I>&gt;&gt;<i>         self.channel = channel
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def buildProtocol(self, addr):
</I>&gt;&gt;<i>         p = LogBot()
</I>&gt;&gt;<i>         p.factory = self
</I>&gt;&gt;<i>         return p
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def clientConnectionLost(self, connector, reason):
</I>&gt;&gt;<i>         &quot;&quot;&quot;If we get disconnected, reconnect to server.&quot;&quot;&quot;
</I>&gt;&gt;<i>         connector.connect()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     def clientConnectionFailed(self, connector, reason):
</I>&gt;&gt;<i>         print &quot;connection failed:&quot;, reason
</I>&gt;&gt;<i>         reactor.stop()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> if __name__ == '__main__':
</I>&gt;&gt;<i>     # create factory protocol and application
</I>&gt;&gt;<i>     f = LogBotFactory(&quot;#testx&quot;)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     # connect factory to this host and port
</I>&gt;&gt;<i>     reactor.connectTCP(&quot;192.168.1.170&quot;, 6667, f)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     # run bot
</I>&gt;&gt;<i>     reactor.run()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I was told that perhaps I could use twisted.pair,
</I>&gt;&gt;<i> but I have no idea how to use the module.  The
</I>&gt;&gt;<i> documentation is lacking and I've only just started
</I>&gt;&gt;<i> programming in Twisted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any help appreciated.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Edmund
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>


-- 
Sofiane AKERMOUN
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">akersof at gmail.com</A>

</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027692.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
	<LI>Next message: <A HREF="027695.html">[Twisted-Python] twisted irc client + packet capturing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27693">[ date ]</a>
              <a href="thread.html#27693">[ thread ]</a>
              <a href="subject.html#27693">[ subject ]</a>
              <a href="author.html#27693">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
