<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Determine TLS version from within request handler ? (twisted web)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Determine%20TLS%20version%20from%20within%20request%0A%20handler%20%3F%20%28twisted%20web%29&In-Reply-To=%3C8af01e767be5317d016f6258bd46c7f7.squirrel%40webmail.xs4all.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="060146.html">
   <LINK REL="Next"  HREF="060167.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Determine TLS version from within request handler ? (twisted web)</H1>
    <B>Rob Meijer</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Determine%20TLS%20version%20from%20within%20request%0A%20handler%20%3F%20%28twisted%20web%29&In-Reply-To=%3C8af01e767be5317d016f6258bd46c7f7.squirrel%40webmail.xs4all.nl%3E"
       TITLE="[Twisted-Python] Determine TLS version from within request handler ? (twisted web)">rmeijer at xs4all.nl
       </A><BR>
    <I>Mon Nov 11 01:45:05 MST 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="060146.html">[Twisted-Python] Determine TLS version from within request handler ? (twisted web)
</A></li>
        <LI>Next message (by thread): <A HREF="060167.html">[Twisted-Python] Determine TLS version from within request handler ? (twisted web)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60165">[ date ]</a>
              <a href="thread.html#60165">[ thread ]</a>
              <a href="subject.html#60165">[ subject ]</a>
              <a href="author.html#60165">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, November 6, 2013 15:38, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:
&gt;<i> On 11:43 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">rmeijer at xs4all.nl</A> wrote:
</I>&gt;&gt;<i>I'm using twisted web for an https connection. At first I start with
</I>&gt;&gt;<i>creating and configuring a ssl.DefaultOpenSSLContextFactory derived
</I>&gt;&gt;<i>class
</I>&gt;&gt;<i>that disables SSLv2 and SSLv3. So (basically we're left with TLS1.0 and
</I>&gt;&gt;<i>up) and forces the use of a single strong (non RC4 but BEAST
</I>&gt;&gt;<i>vulnerable)
</I>&gt;&gt;<i>cipher.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Than I have a http.HTTPFactory derived class with a 'buildProtocol'that
</I>&gt;&gt;<i>return a http.HTTPChannel derived object, that in turn returns a
</I>&gt;&gt;<i>http.Request derived object.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Than reactor.listenSSL is invoked with both the SSL factory and the
</I>&gt;&gt;<i>HTTP
</I>&gt;&gt;<i>factory. Now my problem. I don't really understand how these two are
</I>&gt;&gt;<i>connected once the request handler gets invoked.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>What I would like to do is that I would want to allow TLS1.0 users to
</I>&gt;&gt;<i>use
</I>&gt;&gt;<i>the server, but only after explicitly agreeing that they understand the
</I>&gt;&gt;<i>risks involved with using an old BEAST vulnerable browser.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Is there any way to retrieve info on what TLS version has been
</I>&gt;&gt;<i>negotiated
</I>&gt;&gt;<i>from within the HTTP request handler? I've been walking the 'self'
</I>&gt;&gt;<i>object
</I>&gt;&gt;<i>a bit, and self.transport.getHandle() seems to have some tls stuff like
</I>&gt;&gt;<i>'get_cipher_list' and 'get_peer_certificate', but the simple TLS
</I>&gt;&gt;<i>version
</I>&gt;&gt;<i>number does not seem to be available.
</I>&gt;<i>
</I>&gt;<i> The object you get back from `self.transport.getHandle()` happens to be
</I>&gt;<i> an object from pyOpenSSL - an instance of OpenSSL.SSL.Connection.  While
</I>&gt;<i> reading the following, though, bear in mind that `getHandle` doesn't
</I>&gt;<i> make much of a promise about what it will return.  Other transports may
</I>&gt;<i> return something else and future versions of Twisted may change the
</I>&gt;<i> result as well.
</I>&gt;<i>
</I>&gt;<i> The API that OpenSSL appears to offer for determining what protocol
</I>&gt;<i> version is in use appears to be SSL_get_version().  This returns a
</I>&gt;<i> string like &quot;SSLv2&quot; or &quot;TLSv1&quot; (the documentation doesn't say anything
</I>&gt;<i> about TLSv1.1 or TLSv1.2 but *presumably* if you have a version of
</I>&gt;<i> OpenSSL that implements either of these protocols and one of them is
</I>&gt;<i> negotiated on a connection then SSL_get_version() will identify them in
</I>&gt;<i> its result).
</I>&gt;<i>
</I>&gt;<i> pyOpenSSL, however, does not expose this method.  So in order to get the
</I>&gt;<i> information you need you may need to contribute a binding for this
</I>&gt;<i> method to pyOpenSSL.
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>
Hi Jean-Paul,

Tnx very much for your answer. I've now ended up with what I think is a
bit of a hack. I've consulted the wikipedia page on TLS :

<A HREF="http://en.wikipedia.org/wiki/Transport_Layer_Security#Web_browsers">http://en.wikipedia.org/wiki/Transport_Layer_Security#Web_browsers</A>

and added some code that checks the browser version as reported un the
user-agent header against the minimum version of major browsers that
report to have TLS1.1 support both implemented and enabled by default.
I'm not fully satisfied with this one, but unfortunately it seems to be
the only viable option for my current project :-(


Tnx,

Rob



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="060146.html">[Twisted-Python] Determine TLS version from within request handler ? (twisted web)
</A></li>
	<LI>Next message (by thread): <A HREF="060167.html">[Twisted-Python] Determine TLS version from within request handler ? (twisted web)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60165">[ date ]</a>
              <a href="thread.html#60165">[ thread ]</a>
              <a href="subject.html#60165">[ subject ]</a>
              <a href="author.html#60165">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
