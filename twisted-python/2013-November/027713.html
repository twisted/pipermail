<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] DirtyReactorAggregateError: Reactor was unclean. -	What to do?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20DirtyReactorAggregateError%3A%20Reactor%20was%20unclean.%20-%0A%09What%20to%20do%3F&In-Reply-To=%3CCACVXvXqstzDb4504ZuGtWd3QZ8EEsjmhRKQiYUZ%2Bp_M%2B4VPGAA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="060197.html">
   <LINK REL="Next"  HREF="027715.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] DirtyReactorAggregateError: Reactor was unclean. -	What to do?</H1>
    <B>Jonas Brunsgaard</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20DirtyReactorAggregateError%3A%20Reactor%20was%20unclean.%20-%0A%09What%20to%20do%3F&In-Reply-To=%3CCACVXvXqstzDb4504ZuGtWd3QZ8EEsjmhRKQiYUZ%2Bp_M%2B4VPGAA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] DirtyReactorAggregateError: Reactor was unclean. -	What to do?">jonas.brunsgaard at gmail.com
       </A><BR>
    <I>Wed Nov 13 04:27:50 MST 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="060197.html">[Twisted-Python] FreeBSD buildslaves: change proposal
</A></li>
        <LI>Next message (by thread): <A HREF="027715.html">[Twisted-Python] Xbmc Don´t close after run a script with Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27713">[ date ]</a>
              <a href="thread.html#27713">[ thread ]</a>
              <a href="subject.html#27713">[ subject ]</a>
              <a href="author.html#27713">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear list

I may need som advise to get som testing wokring.

I have a server for service a, which creates a client for service b to get
som data:

 class StateHandler(object):
    implements(State.Iface)

    def __init__(self):
        #do stuff
        self.loaddata()

     @inlineCallbacks
    def loaddata(self):
        try:
            conn = yield ClientCreator(
                reactor,
                TTwisted.ThriftClientProtocol,
                dsClient,

TBinaryProtocol.TBinaryProtocolFactory()).connectTCP(&quot;10.70.10.30&quot;, 7246)
                data = yield conn.client.getAllAuthenticationData()
            #process data
            conn.transport.loseConnection()

I use trail to test this service, code is bolow:

class TestStateStore(unittest.TestCase):

     @defer.inlineCallbacks
    def setUp(self):
        self.handler = StateHandler()
        self.processor = State.Processor(self.handler)
        self.pfactory = TBinaryProtocol.TBinaryProtocolFactory()
        self.server = reactor.listenTCP(
            0,
            TTwisted.ThriftServerFactory(self.processor, self.pfactory),
            interface=&quot;127.0.0.1&quot;)
        self.portNo = self.server.getHost().port
        self.txclient = yield ClientCreator(
            reactor,
             TTwisted.ThriftClientProtocol,
            State.Client,
            self.pfactory).connectTCP(&quot;127.0.0.1&quot;, self.portNo)
        self.client = self.txclient.client

    @defer.inlineCallbacks
    def tearDown(self):
        self.txclient.transport.loseConnection()
        yield self.server.stopListening()


    def test_dummy(self):
        self.assertEquals(True, True)

When I run test it fails with the following error message.

ERROR]
Traceback (most recent call last):
Failure: twisted.trial.util.DirtyReactorAggregateError: Reactor was unclean.
DelayedCalls: (set twisted.internet.base.DelayedCall.debug = True to debug)
&lt;DelayedCall 0x29d99e0 [29.9931809902s] called=0 cancelled=0
Client.failIfNotConnected(TimeoutError('',))&gt;

oc.tests.test_state_service.TestStateStore.test_dummy
===============================================================================
[ERROR]
Traceback (most recent call last):
Failure: twisted.trial.util.DirtyReactorAggregateError: Reactor was unclean.
Selectables:
&lt;&lt;class 'twisted.internet.tcp.Client'&gt; to ('10.70.10.30', 7246) at 29d2c10&gt;

oc.tests.test_state_service.TestStateStore.test_dummy
-------------------------------------------------------------------------------
Ran 1 tests in 0.010s

To me it seems like Trail shuts down the reactor and throws an error, due
to the fact that the reactor is unclean, because the server client is still
active, or at least not cleaned up. How do I work around this problem, any
help is very appreciated.

--
Jonas Brunsgaard
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20131113/9ded9b27/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20131113/9ded9b27/attachment-0001.html</A>&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="060197.html">[Twisted-Python] FreeBSD buildslaves: change proposal
</A></li>
	<LI>Next message (by thread): <A HREF="027715.html">[Twisted-Python] Xbmc Don´t close after run a script with Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27713">[ date ]</a>
              <a href="thread.html#27713">[ thread ]</a>
              <a href="subject.html#27713">[ subject ]</a>
              <a href="author.html#27713">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
