<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Returning a deferred from buildProtocol	t.i.p.Factory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Returning%20a%20deferred%20from%20buildProtocol%0A%09t.i.p.Factory&In-Reply-To=%3CCAMwy1typfbvqvD_VCzXfhJST9yD7MJmF7DZEPc4tGd8ee8%2BCEQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="060180.html">
   <LINK REL="Next"  HREF="060192.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Returning a deferred from buildProtocol	t.i.p.Factory</H1>
    <B>Tom van Neerijnen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Returning%20a%20deferred%20from%20buildProtocol%0A%09t.i.p.Factory&In-Reply-To=%3CCAMwy1typfbvqvD_VCzXfhJST9yD7MJmF7DZEPc4tGd8ee8%2BCEQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Returning a deferred from buildProtocol	t.i.p.Factory">twisted at tomvn.com
       </A><BR>
    <I>Sun Nov 17 10:44:05 MST 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="060180.html">[Twisted-Python] Returning a deferred from buildProtocol	t.i.p.Factory
</A></li>
        <LI>Next message (by thread): <A HREF="060192.html">[Twisted-Python] Returning a deferred from buildProtocol t.i.p.Factory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60191">[ date ]</a>
              <a href="thread.html#60191">[ thread ]</a>
              <a href="subject.html#60191">[ subject ]</a>
              <a href="author.html#60191">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for both those suggestions.
I'll be taking a closer look at txLoadbabancer when I get time as it looks
like it'll take care of a lot of my desired functionality out the box.
To get started tho I'll move my async routing decision call into the
protocol as suggested.

Is there any reason why the internal calls to buildProtocol shouldn't be
wrapped in a maybeDeferred?


On Sat, Nov 16, 2013 at 7:05 PM, Lucas Taylor &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ltaylor.volks at gmail.com</A>&gt;wrote:

&gt;<i>
</I>&gt;<i> On Nov 16, 2013, at 7:09 AM, Tom van Neerijnen wrote:
</I>&gt;<i>
</I>&gt;<i> Hi all
</I>&gt;<i>
</I>&gt;<i> I'm building a simple TCP load balancer based on a code snippet from Glyph
</I>&gt;<i> on SO:
</I>&gt;<i> <A HREF="http://stackoverflow.com/questions/4096061/general-question-regarding-wether-or-not-use-twisted-in-tcp-proxy-project">http://stackoverflow.com/questions/4096061/general-question-regarding-wether-or-not-use-twisted-in-tcp-proxy-project</A>
</I>&gt;<i>
</I>&gt;<i> It's served me well but I can't work out how to convert Glyphs round robin
</I>&gt;<i> retrieval of the server endpoint into an async balancing decision in the
</I>&gt;<i> buildProtocol method of the Factory. If I return a deferred here it fails
</I>&gt;<i> with an AttributeError: Deferred instance has no attribute 'makeConnection'.
</I>&gt;<i>
</I>&gt;<i> Currently I'm working around this by running a separate management loop
</I>&gt;<i> that periodically updates a dictionary with all the data necessary to make
</I>&gt;<i> my routing decision so that I can do it without a deferred. This worries me
</I>&gt;<i> because I may be making my decision on slightly stale data and I'd really
</I>&gt;<i> like this to be a real time decision as the connection comes in. Does
</I>&gt;<i> anyone have a clever way of doing this?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hi Tom,
</I>&gt;<i>
</I>&gt;<i> One possibly unexpected aspect of using @inlineCallbacks is that the
</I>&gt;<i> decorated function itself returns a Deferred. This is why you see the
</I>&gt;<i> AttributeError...the machinery calling buildProtocol expects an IProtocol
</I>&gt;<i> instance (or None), and the function is returning a Deferred.
</I>&gt;<i> `defer.returnValue()` is provided to the callback on that Deferred, not as
</I>&gt;<i> a direct return value from the decorated function.
</I>&gt;<i>
</I>&gt;<i> If you want to make the routing decision when the client connects, then
</I>&gt;<i> you could push the decision-making process down into the Protocol itself.
</I>&gt;<i>
</I>&gt;<i> Here's a quick mockup overriding connectionMade in a ProxyServer protocol
</I>&gt;<i> subclass. It calls the factory routing function (which may or may not
</I>&gt;<i> return a deferred), and connects the proxy once the decision has been made.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> from twisted.internet.protocol import Factory
</I>&gt;<i> from twisted.protocols.portforward import ProxyServer
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class Balancer(Factory):
</I>&gt;<i>     protocol = RoutingProxyServer
</I>&gt;<i>     routing_func = port_routing_decision_async
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class RoutingProxyServer(ProxyServer):
</I>&gt;<i>
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         # Don't read anything from the connecting client until we have
</I>&gt;<i>         # somewhere to send it to.
</I>&gt;<i>         self.transport.pauseProducing()
</I>&gt;<i>
</I>&gt;<i>         client = self.clientProtocolFactory()
</I>&gt;<i>         client.setServer(self)
</I>&gt;<i>
</I>&gt;<i>         if self.reactor is None:
</I>&gt;<i>             from twisted.internet import reactor
</I>&gt;<i>             self.reactor = reactor
</I>&gt;<i>
</I>&gt;<i>         def connectProxy(host, port):
</I>&gt;<i>             self.reactor.connectTCP(host, port, client)
</I>&gt;<i>
</I>&gt;<i>         d = maybeDeferred(self.factory.routing_func)
</I>&gt;<i>         d.addCallback(connectProxy)
</I>&gt;<i>         d.addErrback(log.err)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Lucas
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> An example is below. The hashed out buildProtocol is a synchronous
</I>&gt;<i> decision which works. Thanks in advance!
</I>&gt;<i>
</I>&gt;<i> from twisted.internet.protocol import Factory
</I>&gt;<i> from twisted.protocols.portforward import ProxyFactory
</I>&gt;<i> from twisted.internet import reactor, defer
</I>&gt;<i> import random
</I>&gt;<i>
</I>&gt;<i> from twisted.python import log
</I>&gt;<i> import sys
</I>&gt;<i> log.startLogging(sys.stderr)
</I>&gt;<i>
</I>&gt;<i> local_ports = set([1024, 1025])
</I>&gt;<i>
</I>&gt;<i> def port_routing_decision_sync():
</I>&gt;<i>     return random.choice(list(local_ports))
</I>&gt;<i>
</I>&gt;<i> def port_routing_decision_async():
</I>&gt;<i>     d = defer.Deferred()
</I>&gt;<i>     reactor.callLater(1, d.callback, port_routing_decision_sync())
</I>&gt;<i>     return d
</I>&gt;<i>
</I>&gt;<i> class Balancer(Factory):
</I>&gt;<i>     # def buildProtocol(self, addr):
</I>&gt;<i>     #     port = port_routing_decision_sync()
</I>&gt;<i>     #     print &quot;connecting to local port {}&quot;.format(port)
</I>&gt;<i>     #     return ProxyFactory(&quot;127.0.0.1&quot;, port).buildProtocol(addr)
</I>&gt;<i>
</I>&gt;<i>     @defer.inlineCallbacks
</I>&gt;<i>     def buildProtocol(self, addr):
</I>&gt;<i>         port = yield port_routing_decision_async()
</I>&gt;<i>         print &quot;connecting to local port {}&quot;.format(port)
</I>&gt;<i>         defer.returnValue(ProxyFactory(&quot;127.0.0.1&quot;,
</I>&gt;<i> port).buildProtocol(addr))
</I>&gt;<i>
</I>&gt;<i> def main():
</I>&gt;<i>     factory = Balancer()
</I>&gt;<i>     reactor.listenTCP(5678, factory)
</I>&gt;<i>     reactor.run()
</I>&gt;<i>
</I>&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;<i>     main()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20131117/96725b12/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="060180.html">[Twisted-Python] Returning a deferred from buildProtocol	t.i.p.Factory
</A></li>
	<LI>Next message (by thread): <A HREF="060192.html">[Twisted-Python] Returning a deferred from buildProtocol t.i.p.Factory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60191">[ date ]</a>
              <a href="thread.html#60191">[ thread ]</a>
              <a href="subject.html#60191">[ subject ]</a>
              <a href="author.html#60191">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
