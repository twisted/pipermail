<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted.mail newbie question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted.mail%20newbie%20question&In-Reply-To=%3C4306553F.2010303%40mac.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043676.html">
   <LINK REL="Next"  HREF="043678.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted.mail newbie question</H1>
    <B>xing at mac.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted.mail%20newbie%20question&In-Reply-To=%3C4306553F.2010303%40mac.com%3E"
       TITLE="[Twisted-Python] twisted.mail newbie question">xing at mac.com
       </A><BR>
    <I>Fri Aug 19 15:55:11 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043676.html">[Twisted-Python] Telnet &amp; echo
</A></li>
        <LI>Next message (by thread): <A HREF="043678.html">[Twisted-Python] Re: [Twisted-commits] r14280 - Less fragile error	checking.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43677">[ date ]</a>
              <a href="thread.html#43677">[ thread ]</a>
              <a href="subject.html#43677">[ subject ]</a>
              <a href="author.html#43677">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I have read the twisted.mail.smtp source and ran the sample code 
(included below) in the debugger with break points and yet I still do 
not know where I can inject my code to handle actual message delivery 
where both the email message and all the recipients are available at one 
point in time.

The IMessageDelivery handler doesn't appear to see the message, and the 
IMessage only sees the message and not the recipients. As such, I'm 
thorughly confused. Very new to twisted and async programming model.

Thanks for any pointers.

I have written a basic smtp relayer wrapped around twisted smtp.sendmail 
using my own delivery queue and mx selection management and trying to 
put the last piece in: the smtp server which will hand off all incoming 
messages into my queues.


Xing Li


code
----------------------------------

from twisted.internet import defer
from twisted.protocols import smtp
from twisted.internet import reactor

class ConsoleMessageDelivery:
     __implements__ = (smtp.IMessageDelivery)

     def receivedHeader(self, helo, origin, recipients):
         for i in recipients:
             print i
         return &quot;Received: ConsoleMessageDelivery&quot;

     def validateFrom(self, helo, origin):
         # All addresses are accepted
         return origin

     def validateTo(self, user):
         # Only messages directed to the &quot;console&quot; user are accepted.
         #if user.dest.local == &quot;console&quot;:
         return lambda: ConsoleMessage()

         #raise smtp.SMTPBadRcpt(user)

class ConsoleMessage:
     __implements__ = (smtp.IMessage,)

     def __init__(self):
         self.lines = []

     def lineReceived(self, line):
         self.lines.append(line)

     def eomReceived(self):
         print &quot;New message received:&quot;
         print &quot;\n&quot;.join(self.lines)
         self.lines = None
         return defer.succeed(None)

     def connectionLost(self):
         # There was an error, throw away the stored lines
         self.lines = None

class ConsoleSMTPFactory(smtp.SMTPFactory):
     def __init__(self, *a, **kw):
         smtp.SMTPFactory.__init__(self, *a, **kw)
         self.delivery = ConsoleMessageDelivery()

     def buildProtocol(self, addr):
         p = smtp.SMTPFactory.buildProtocol(self, addr)
         p.delivery = self.delivery
         return p




if __name__ == '__main__':
     f = ConsoleSMTPFactory()

     reactor.listenTCP(25, f)
     reactor.run()



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043676.html">[Twisted-Python] Telnet &amp; echo
</A></li>
	<LI>Next message (by thread): <A HREF="043678.html">[Twisted-Python] Re: [Twisted-commits] r14280 - Less fragile error	checking.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43677">[ date ]</a>
              <a href="thread.html#43677">[ thread ]</a>
              <a href="subject.html#43677">[ subject ]</a>
              <a href="author.html#43677">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
