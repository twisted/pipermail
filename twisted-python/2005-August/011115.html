<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] What is wrong with this instance?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20What%20is%20wrong%20with%20this%20instance%3F&In-Reply-To=1123750874.2846.8.camel%40localhost.localdomain">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011114.html">
   <LINK REL="Next"  HREF="011116.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] What is wrong with this instance?</H1>
    <B>Micha&#322; Tyde</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20What%20is%20wrong%20with%20this%20instance%3F&In-Reply-To=1123750874.2846.8.camel%40localhost.localdomain"
       TITLE="[Twisted-Python] What is wrong with this instance?">ajchos at wp.pl
       </A><BR>
    <I>Thu Aug 11 06:26:30 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="011114.html">[Twisted-Python] What is wrong with this instance?
</A></li>
        <LI>Next message: <A HREF="011116.html">[Twisted-Python] What is wrong with this instance?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11115">[ date ]</a>
              <a href="thread.html#11115">[ thread ]</a>
              <a href="subject.html#11115">[ subject ]</a>
              <a href="author.html#11115">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry I dont want to send too large posts, so I shorten the problem. I
am writing a telnet client, and I got a little problem with keeping
connection alive (thread: [Twisted - Python] Telnet client &amp; keeping
connection alive). I use a reactor.callLater() loop, and i can't exectue
a method i have written in Protocol class. I try to execute this method
in the end of code before reactor.run(). 

Code below:
#---------------------#
#Client Side Protocol #
#---------------------#
from twisted.protocols.telnet import Telnet
from twisted.internet.protocol import Protocol
from twisted.internet.protocol import ClientFactory
from twisted.internet import reactor, task, defer, threads
import telnetlib as tln
from twisted.python import threadable
threadable.init()
import logging, thread
delimiters = ['\r\n', '\r\x00']

class TelnetProtocol(Telnet):
#	log = logging.getLogger(&quot;telnet.protocol.&quot;)
	buffer = ''
	global ciag
	licznik = 0

	def makeConnection(self, transport):
		print &quot;Making a connection&quot;
		Telnet.makeConnection(self, transport)
		
	def connectionMade(self):
		print &quot;Connection made&quot;
#		self.log.info(&quot;telnet_protocol connected&quot;)
		Telnet.connectionMade(self)
		
	def connectionLost(self, reason):
#		self.log.debug(&quot;Connection lost: %s&quot;, reason)
		print &quot;connection lost, %s&quot; % reason
		Telnet.connectionLost(self, reason)

	def dataReceived(self, data):
		print &quot;Data recived&quot;
		ciag=&quot;&quot;
		self.buffer+=data
		f=open(&quot;new.txt&quot;,&quot;a+&quot;)
		print self.buffer
		f.write(self.buffer)
		odp = self.responseFunct(data)
		self.write(odp)
		if self.buffer == '':
			print &quot;nic nie ma&quot;
			self.transport.loseConnection()
		if (&quot;login:&quot; in  data) and (&quot;Last login:&quot; not in data):
			print &quot;wchodze 4&quot;
			# here i take a username from USE CASE
			self.telnet_User()
			print &quot;wychodze 4&quot;
		if &quot;Password:&quot; in  data:
			print &quot;wchodze 5&quot;
			# here i take a password from USE CASE
			self.telnet_Password()
			print &quot;wychodze 5&quot;
		try:
			print &quot;try 1&quot;
			if &quot;[<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mkl at julia</A> mkl]$&quot; in data:
				self.telnet_Check_OK(data)
				print &quot;try 2&quot;
			else:
				print &quot;else 1&quot;
				self.telnet_Check_DENY() 
				print &quot;else 2&quot;
				pass
		except:
			pass
	
	def responseFunct(self, buffer):
		response = &quot;&quot;
		print &quot;funkcja in&quot;
		f = open(&quot;dlugosc.txt&quot;,&quot;a+&quot;)
		length = len(buffer)# buffer - string
		response_buffer=&quot;&quot;
		for i in range(length/3):
			# every seqence I should RESponse, should begin from IAC - \xff (255)
			# i dont get a terminal type
			sequence=buffer[0+(i*3):3+(i*3)]
			f.write(&quot;seq:&quot;+sequence)
			if sequence.count(tln.IAC):
				f.write(&quot;&lt;-: YES\n&quot;)
				if sequence.count(tln.DO) and sequence.count(tln.SNDLOC):
					response = tln.IAC + tln.DO + tln.SNDLOC
					f.write(&quot;RES:&quot;+str(response)+&quot;\n&quot;)
				elif sequence.count(tln.DO) and sequence.count(tln.BINARY):
					response = tln.IAC + tln.WILL + tln.BINARY
					f.write(&quot;RES:&quot;+str(response)+&quot;\n&quot;)
				elif sequence.count(tln.DO) and sequence.count(tln.ECHO):
					response = tln.IAC + tln.WILL + tln.ECHO
					f.write(&quot;RES:&quot;+str(response)+&quot;\n&quot;)
				elif sequence.count(tln.DO) and sequence.count(tln.SGA):
					response = tln.IAC + tln.WILL + tln.SGA
					f.write(&quot;RES:&quot;+str(response)+&quot;\n&quot;)
				elif sequence.count(tln.WILL) and sequence.count(tln.BINARY):
					response = tln.IAC + tln.DO + tln.BINARY
					f.write(&quot;RES:&quot;+str(response)+&quot;\n&quot;)
				elif sequence.count(tln.WILL) and sequence.count(tln.ECHO):
					response = tln.IAC + tln.DO + tln.ECHO
					f.write(&quot;RES:&quot;+str(response)+&quot;\n&quot;)
				elif sequence.count(tln.WILL) and sequence.count(tln.SGA):
					response = tln.IAC + tln.DO + tln.SGA
					f.write(&quot;RES:&quot;+str(response)+&quot;\n&quot;)
				elif tln.DO in sequence or tln.DONT in sequence:
					response = tln.IAC + tln.WONT + sequence[2]
					f.write(&quot;RES:&quot;+str(response)+&quot;\n&quot;)
				elif tln.WILL in sequence or tln.WONT in sequence:
					response = tln.IAC + tln.DONT + sequence[2]
					f.write(&quot;RES:&quot;+str(response)+&quot;\n&quot;)
			else:
				f.write(&quot;\n&quot;)
			response_buffer +=response
		print &quot;funkcja out&quot;
		return response_buffer

	def telnet_User(self, user=&quot;mkl&quot;):
		print &quot;user1&quot;
		self.transport.write(user+&quot;\n\r&quot;)
		print &quot;user2&quot;
		
	def telnet_Password(self, paswd=&quot;Kznjsnm&quot;):
		print &quot;pass1&quot;
		self.transport.write(paswd+&quot;\n\r&quot;)
		print &quot;pass2&quot;
	
	def loggedIn(self):
		# i know that user succesfuly login
		f=open(&quot;zewn.txt&quot;,&quot;w&quot;)
		f.write(&quot;logged In&quot;)
		print &quot;logged In&quot;
			
	def telnet_Check_OK(self, data):
		if &quot;[<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mkl at julia</A> mkl]$&quot; in data:
			print &quot;wchodze spr log&quot;
			f=open(&quot;new.txt&quot;,&quot;a+&quot;)
			f.write(&quot;udalo sie zalogowac&quot;)
			print &quot;wychodze spr log&quot;
		pass
#			self.loggedIn(tf=False)


	def telnet_Check_DENY(self):
		print &quot;zly user we&quot;
		f=open(&quot;new.txt&quot;,&quot;a+&quot;)
		f.write(&quot;zly user - nie udalo sie zalogowac&quot;)
		print &quot;zly user wy&quot;	
		self.tansport.loseConnection()
		reactor.stop()
	
	def telnet_KeepAlive(self):
		print &quot;KA 1&quot;
		self.write(&quot;pwd\n\r&quot;)
		print &quot;KA 2&quot;
	
	def telnet_Command(self, command=&quot;pwd&quot;):
		print &quot;comm1&quot;
		print command
		self.write(command+&quot;\r\n&quot;)
		f.write(command)
		print &quot;comm2&quot;
	
#-------------------------#
# Client Side Factories 2 #
#-------------------------#

class MyFactory(ClientFactory):
	protocol = TelnetProtocol

	def startedConnecting(self, connector):
		#self.makeConnection()
		#connector.connect()
		pass # we could connector.stopConnecting()
	
	def clientConnectionLost(self, connector, reason):
		print &quot;Connection lost reconecting %s&quot; % reason
		reactor.stop()
#		connector.connect() # reconnect
	
	def clientConnectionFailed(self, connector, reason):
		print &quot;connection failed %s&quot; % reason
		reactor.stop()
	
#-------------------------------------#
# Connection API					  #
#-------------------------------------#
if __name__==&quot;__main__&quot;:
	def command(commd):
#		tel=TelnetProtocol()
		print &quot;command&quot;
		print commd
		
	def telnet_KeepAlive():
		print &quot;keeping alive 1&quot;
		tel=TelnetProtocol()
		print type(tel)
		print hasattr(tel,'telnet_KeepAlive')
		c=tel.telnet_KeepAlive
		print c
		#c()#doesn't execute
		print &quot;keeping alive 2&quot;	
	
	HOST='127.0.0.1'
	port=23
	l = task.LoopingCall(telnet_KeepAlive)
	l.start(5.0)
#	reactor.callLater(5,command(commd=&quot;ls&quot;))
	reactor.connectTCP(HOST, port, MyFactory())
	reactor.run()





</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011114.html">[Twisted-Python] What is wrong with this instance?
</A></li>
	<LI>Next message: <A HREF="011116.html">[Twisted-Python] What is wrong with this instance?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11115">[ date ]</a>
              <a href="thread.html#11115">[ thread ]</a>
              <a href="subject.html#11115">[ subject ]</a>
              <a href="author.html#11115">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
