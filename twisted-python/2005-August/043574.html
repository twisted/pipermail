<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] process status
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20process%20status&In-Reply-To=%3C42EFA90F.8070603%40geo.unizh.ch%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043573.html">
   <LINK REL="Next"  HREF="043575.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] process status</H1>
    <B>Daniel Isenegger</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20process%20status&In-Reply-To=%3C42EFA90F.8070603%40geo.unizh.ch%3E"
       TITLE="[Twisted-Python] process status">disen at geo.unizh.ch
       </A><BR>
    <I>Tue Aug  2 11:10:39 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043573.html">[Twisted-Python] Sydney Twisted Sprint (19-21/8): Linux Australia	grants
</A></li>
        <LI>Next message (by thread): <A HREF="043575.html">[Twisted-Python] Twisted api docs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43574">[ date ]</a>
              <a href="thread.html#43574">[ thread ]</a>
              <a href="subject.html#43574">[ subject ]</a>
              <a href="author.html#43574">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>How to query process state and receive back control?

Hi,
a  newbie question: i struggle with the defer-mechanism.
i start from a client program a using defers a 
protocol.ProcessProtocol-class to invoke a local application (grass) to 
display a raster.
This works fine, the problem is now how to propagate back the final 
state of the invoked process back to the invoking instance and then to 
get the control back over the shell the process has been running in.

I can see that the state of the invoked process can be accesses in 
processEnded(), but when this function is invoked the connection to the 
invoking instance is already closed, so the state cannot be propagated 
to this invoking instance.

Additionaly the shell the process has been invoked does not receive 
further output of the invoking process., so i assume that the control is 
not handed back to the invoking process

Any hints?
Thanks Dani

In the following some excerpts of code to illustrate my problem:
 
invoking process:
#############################################################
    # invokes GIS to display the raster cmd, using IpodlasProcess to
    # call a process on the machine
    def displayRaster(self):
        
        # init deferred object d
        d = defer.Deferred()
        # add the pair of callbacks
        d.addCallback(self.handleDisplayRaster)
        d.addErrback(self.handleDisplayRasterFailure)
        #
        #invoke the deferred functions: i.e. handleDisplayRaster
        # and handleDisplayRasterFailure
        d.callback(rasterfile)
        print &quot;displayRaster: after d.callback()&quot;
    #
 ############################################################
    # handles the successfull call of the display of the raster theRaster
    def handleDisplayRaster(self,theRaster):
        #
        # init IpodlasProcess
        ip = IpodlasProcess()
        #
        #
        # invoke IpodlasProcess to invoke Grass to display the raster 
theRaster
        ip.displayRaster(theRaster)
        #
 #########################################################
    # handles the failed call of the display of the file theFoile
    # and its return object theFailure
    def handleDisplayRasterFailure(self,theFailure):
        #
        theFailure.trap(RuntimeError)
        #
###############################################################################
# IpodlasClientFactory is derived from ReconnectingClientFactory, which 
tries
# to reconnect if connection is lost
class IpodlasClientFactory(ReconnectingClientFactory):
    # creates protocol and receives events relating to connection state
    #
    def startedConnecting(self, connector):
        print 'Started to connect.'

    def buildProtocol(self, addr):
        print 'Connected.'
        print 'Resetting reconnection delay'
        self.resetDelay()
        # associated subsystem is the GUI
        return IpodlasClient()

    def clientConnectionLost(self, connector, reason):
        print 'Lost connection.  Reason:', reason
        # tries to reconnect, if conn fails with exponentially delays
        ReconnectingClientFactory.clientConnectionLost(self, connector, 
reason)
    #
    # if connection could not be established
    def clientConnectionFailed(self, connector, reason):
        print 'Connection failed. Reason:', reason
        ReconnectingClientFactory.clientConnectionFailed(self, connector,
                                                         reason)

###################################################################
if __name__ == &quot;__main__&quot;:
    #
    if len(sys.argv) &gt; 1:
        # set global subsystem
        assoSubsys = sys.argv[1]
        #print assoSubsys
    #
    from twisted.internet import reactor
    reactor.connectTCP(&quot;localhost&quot;,51423,IpodlasClientFactory())
    reactor.run()




invoked Process:
#! /usr/bin/python
# File:ipodlasProcess.py

&quot;&quot;&quot;
ipodlasProcess.py
usage: python ipodlasProcess.py
&quot;&quot;&quot;

from twisted.internet import protocol
from twisted.internet import reactor
from twisted.internet import utils #needed to query process termination 
status
import re
import os
import gc
# own classes

class IpodlasProcess(protocol.ProcessProtocol):
    def __init__(self):
        self.data = &quot;&quot;
        #
    #
    def connectionMade(self):
        print &quot;IP connectionMade&quot;
        self.transport.closeStdin()
    # data from standard output is receieve in outReceived.
    def outReceived(self, data):
        print &quot;IP outReceived: &quot; + self.data
        self.data = self.data + data
    #
    def errReceived(self, data):
        print &quot;IP errReceived():&quot; + data
    #
    def inConnectionLost(self):
        print &quot;IP inConnectionLost! stdin is closed! (we probably did it)&quot;
    #
    def outConnectionLost(self):
        print &quot;IP outConnectionLost data: &quot; + self.data
    #
    def errConnectionLost(self):
        print &quot;IP errConnectionLost! stdin is closed! (we probably did it)&quot;
    #
    def processEnded(self, status_object):
        self.processStatus = status_object.value.exitCode
        print &quot;IP processEnded, status: &quot; + 
str(status_object.value.exitCode) \
              + &quot;\nquitting &quot;
        # this is outcommented, since otherwise the reactor of 
ipodlasClient would
        # stopped, since this is the one which controls ipodlasProcess 
(the own in
        # the main fctn is only started, when invoked from cmd-line)
        # reactor.stop
        
    #
    def displayRaster(self,theRaster):
        #
        cmd = &quot;d.rast&quot;
        arg1 = theRaster
        arg2 = &quot;bg=white&quot;
        # processes are runned trough reactor using spawnProcess
        # invoke process cmd with the args arg1, arg2 and the parent process
        # environment env
        reactor.spawnProcess(self,cmd,[cmd,arg1,arg2],env=os.environ)
        #
        print &quot;IP displayRaster&quot;
###################################################################
if __name__ == &quot;__main__&quot;:
    #
    ip = IpodlasProcess()
    ip.displayRaster(&quot;upperEngadine_raster&quot;)
    #
    reactor.run()




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043573.html">[Twisted-Python] Sydney Twisted Sprint (19-21/8): Linux Australia	grants
</A></li>
	<LI>Next message (by thread): <A HREF="043575.html">[Twisted-Python] Twisted api docs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43574">[ date ]</a>
              <a href="thread.html#43574">[ thread ]</a>
              <a href="subject.html#43574">[ subject ]</a>
              <a href="author.html#43574">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
