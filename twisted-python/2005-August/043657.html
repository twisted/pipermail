<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] problem with combining deferreds together
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20problem%20with%20combining%20deferreds%20together&In-Reply-To=%3C4300CD48.5070302%40corp.earthlink.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043656.html">
   <LINK REL="Next"  HREF="043659.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] problem with combining deferreds together</H1>
    <B>Jason Fritcher</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20problem%20with%20combining%20deferreds%20together&In-Reply-To=%3C4300CD48.5070302%40corp.earthlink.net%3E"
       TITLE="[Twisted-Python] problem with combining deferreds together">fritcher at corp.earthlink.net
       </A><BR>
    <I>Mon Aug 15 11:13:44 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043656.html">[Twisted-Python] problem with combining deferreds together
</A></li>
        <LI>Next message (by thread): <A HREF="043659.html">[Twisted-Python] problem with combining deferreds together
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43657">[ date ]</a>
              <a href="thread.html#43657">[ thread ]</a>
              <a href="subject.html#43657">[ subject ]</a>
              <a href="author.html#43657">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>michal salaban wrote:
&gt;<i> class ObjectRepository:
</I>&gt;<i> 
</I>&gt;<i>     def getById(self, id):
</I>&gt;<i>         dMain = self.dbpool.runInteraction(
</I>&gt;<i>                 fetchOneAndMapToDictionary,
</I>&gt;<i>                 &quot;SELECT * FROM MainTable WHERE id = '%d'&quot; % (id,)
</I>&gt;<i>                 )
</I>&gt;<i>         dMain.addCallback(self._gotMainData)
</I>&gt;<i>         return dMain
</I>&gt;<i> 
</I>&gt;<i>     def _gotMainData(self, mappedRow):
</I>&gt;<i>         dSub = self.dbpool.runInteraction(
</I>&gt;<i>                 fetchOneAndMapToDictionary,
</I>&gt;<i>                 &quot;SELECT * FROM SubTable WHERE id = '%d'&quot; % (mappedRow['SubID'],)
</I>&gt;<i>                 )
</I>&gt;<i>         dSub.addCallback(self._gotSubData)
</I>&gt;<i>         return [what to return ????]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> how can i return the result that consist of data from both queries?
</I>&gt;<i> chaining callbacks is impossible. i cannot have dSub before dMain.callback()
</I>&gt;<i> is called, and also cannot do dMain.chainDeferred(dSub) in _gotMainData()
</I>&gt;<i> because dMain has already been returned to calling code and contains callbacks
</I>&gt;<i> attached there.
</I>
Give this a try and see how it works for you...

def _gotMainData(self, mappedRow):
    dSub = self.dbpool.runInteraction(
        fetchOneAndMapToDictionary,
        &quot;SELECT * FROM SubTable WHERE id = '%d'&quot; % (mappedRow['SubID'],)
        )
        dSub.addCallback(self._gotSubData, mappedRow)
        return dSub

def _gotSubData(self, subMappedRow, mainMappedRow):
    # Do work here.


When adding callbacks to a deferred, you can add arguments that will get
passed to the argument, independant of the result from previous
callbacks. Like above, you can take the mappedRow dictionary from the
first callback and pass it as an argument to the callback for the
subrequest. Also, for the new deferred to be useful, you return it from
the callback. When Twisted sees that, it'll pause the callback chain
until that deferred fires and processes all of its callbacks. It'll take
the result that is produced from that deferred and use it as the result
for the next callback in the main deferred.

-- 
Jason Fritcher
Software Engineer
Core Infrastructure Services &amp; Strategy
Earthlink, Inc
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">fritcher at corp.earthlink.net</A>
(404) 748-7262, x22262
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 253 bytes
Desc: OpenPGP digital signature
URL: &lt;/pipermail/twisted-python/attachments/20050815/0d71fccb/attachment.sig&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043656.html">[Twisted-Python] problem with combining deferreds together
</A></li>
	<LI>Next message (by thread): <A HREF="043659.html">[Twisted-Python] problem with combining deferreds together
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43657">[ date ]</a>
              <a href="thread.html#43657">[ thread ]</a>
              <a href="subject.html#43657">[ subject ]</a>
              <a href="author.html#43657">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
