<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Setting socket options before connect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Setting%20socket%20options%20before%20connect&In-Reply-To=%3C90F2544A-F578-4278-AF35-3D8932194A9F%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027195.html">
   <LINK REL="Next"  HREF="027204.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Setting socket options before connect</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Setting%20socket%20options%20before%20connect&In-Reply-To=%3C90F2544A-F578-4278-AF35-3D8932194A9F%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Setting socket options before connect">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Jul 17 11:44:05 MDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027195.html">[Twisted-Python] Setting socket options before connect
</A></li>
        <LI>Next message: <A HREF="027204.html">[Twisted-Python] Setting socket options before connect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27201">[ date ]</a>
              <a href="thread.html#27201">[ thread ]</a>
              <a href="subject.html#27201">[ subject ]</a>
              <a href="author.html#27201">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Jul 15, 2013, at 4:44 AM, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:

&gt;<i> On 01:01 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A> wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Jul 12, 2013, at 5:09 AM, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:
</I>&gt;&gt;&gt;<i> On 10:42 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">p.mayers at imperial.ac.uk</A> wrote:
</I>&gt;&gt;&gt;&gt;<i> On 12/07/13 11:34, Itamar Turner-Trauring wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Subclass twisted.internet.tcp.Client, override createInternetSocket() so
</I>&gt;&gt;&gt;&gt;&gt;<i> it calls setsockopt() on the socket after you've called base
</I>&gt;&gt;&gt;&gt;&gt;<i> implementation to create it. This breaks some abstraction boundaries, so
</I>&gt;&gt;&gt;&gt;&gt;<i> it isn't great, but very little code duplication is involved.
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Ah, ok. Presumably I also need to subclass Connector and override _makeTransport to use MyClient, then call MyConnector() directly (or subclass the reactor... shudder)
</I>&gt;&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Should there be something built in to Twisted for this? Should I open a ticket?
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> If you want your code to keep working, or to work with alternate reactor implementations, then you'd *really* rather use a documented, tested interface rather than the hack outlined above.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Does such an API exist today, or should a ticket be filed for one?
</I>&gt;<i> 
</I>&gt;<i> Hm, I'm not *totally* sure what you mean.
</I>
Mostly just socratic method: you said &quot;don't do this, do something else&quot;, I am just curious what &quot;do something else&quot; is :-).  Given that no documented, tested interfaces actually exist, &quot;use a documented, tested interface&quot; is not presently an option - &quot;create a documented, tested interface&quot; seems to be what you (well, we, really) are suggesting, which means somebody needs to come up with a specification and file a ticket to make the change to Twisted.

&gt;<i> There's the approach Itamar outlined, using APIs such as `twisted.internet.tcp.{Client,Server}`.  I don't think we should codify this as the public, stable, encouraged API to use - for precisely the reasons you give below.
</I>
Yup.

&gt;<i> There's various other APIs that are clearly related but definitely don't currently allow you to wedge this functionality in:
</I>&gt;<i> 
</I>&gt;<i> 1) reactor.connectTCP - nowhere to pass extra socket options now, but we could add more arguments to it I suppose.  Doesn't sound very nice to me.
</I>
There are two general approaches I can think of here:

 1. pass a callable object to be invoked on the ... socket? transport? ... before connect().  This seems problematic because it could violate lots of assumptions Twisted makes about the socket and create arbitrary I/O problems in the main loop, which won't be reported well.
 2. pass a static description of things to do pre-connect.

To me, 1. analogizes to 'preexec_fn' in subprocess vs. 2. posix_spawn static description of process-state options, which means I like 2. a lot better.  So the question is: is there anything other than setting socket options might want to do pre-connect?  If we can conclusively say not, then I think adding an argument to pass extra socket options seems fine.  If so, then if we can enumerate the other things you might want to do, we could just add arguments for each of them.

&gt;<i> 2) endpoints?  Again, no current support, but it's a place you could add new parameters.  Of course, this isn't a complete solution, since endpoints mostly just use reactor methods to set things up - but if we had a nice endpoints-based API then we could have a gross lower-level API that no one actually has to use.  Still, is &quot;tcp:host=A:port=B:sockopt=TCP_CORK|TCP_QUICKACK&quot; the road we want to go down?
</I>
This would still require support from connectTCP anyway, no?  The sockopt:... key is just the, uh, &quot;user interface&quot; (for lack of a better word) for some structured functionality exposed at a lower level.  So... that suggests that it just reverts to case 1.

&gt;<i> 3) More transport methods
</I>
That is already supported, in a sense, you can call '.getHandle()' and set socket options on it if you want to be just a little bit platform-specific.  And we have things like setTcpNoDelay already, too, to avoid depending on python socket objects.

&gt;<i> - but this is an incomplete solution, as certain sockopts only make sense before a connection, so once you have a transport it's too late.
</I>
Right, it's the timing that seems to be the issue.

&gt;<i> Maybe someone else has some suggestions from a totally different ballpark that solve the problem more pleasantly?
</I>
Passing socket options to connectTCP is growing on me, but it sure would be nice to have something nicer.

&gt;<i> Anyhow, I think this certainly means a ticket should be filed for introducing some API - but it seems that a little more discussion about what the API should be will still be necessary.
</I>
Agreed.  But then, it's been a couple days and nobody else has contributed to this thread :-).

-g
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20130717/80694f8c/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20130717/80694f8c/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027195.html">[Twisted-Python] Setting socket options before connect
</A></li>
	<LI>Next message: <A HREF="027204.html">[Twisted-Python] Setting socket options before connect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27201">[ date ]</a>
              <a href="thread.html#27201">[ thread ]</a>
              <a href="subject.html#27201">[ subject ]</a>
              <a href="author.html#27201">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
