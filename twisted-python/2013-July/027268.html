<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] transport.write performance.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20transport.write%20performance.&In-Reply-To=%3CSNT131-W42743A6AF69DF292E83ABFB4560%40phx.gbl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027267.html">
   <LINK REL="Next"  HREF="027269.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] transport.write performance.</H1>
    <B>zipxing</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20transport.write%20performance.&In-Reply-To=%3CSNT131-W42743A6AF69DF292E83ABFB4560%40phx.gbl%3E"
       TITLE="[Twisted-Python] transport.write performance.">zipxing at hotmail.com
       </A><BR>
    <I>Tue Jul 30 02:58:17 MDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027267.html">[Twisted-Python] transport.write performance.
</A></li>
        <LI>Next message: <A HREF="027269.html">[Twisted-Python] transport.write performance.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27268">[ date ]</a>
              <a href="thread.html#27268">[ thread ]</a>
              <a href="subject.html#27268">[ subject ]</a>
              <a href="author.html#27268">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>tsvr.py
-----------------------------------------------------------
import sys, time, random, socket, traceback
from twisted.internet import epollreactor
epollreactor.install()
from twisted.internet import defer, reactor, task
from twisted.internet.protocol import Protocol, Factory
from protocol import TCPServerProtocol

def main():
&#160; &#160; &#160; &#160; tcpprotocol = TCPServerProtocol
&#160; &#160; &#160; &#160; factory = Factory()
&#160; &#160; &#160; &#160; factory.protocol = tcpprotocol
&#160; &#160; &#160; &#160; reactor.listenTCP(9976, factory)
&#160; &#160; &#160; &#160; reactor.run()

if __name__ == '__main__':
&#160; &#160; &#160; &#160; main()

protocol.py
---------------------------------------------------------&#160;
import socket
import datetime
import traceback
from twisted.protocols.basic import LineReceiver
from twisted.internet import protocol

class TCPServerProtocol(LineReceiver):
&#160; &#160; &#160; &#160; req_count = 0
&#160; &#160; &#160; &#160; req_time = datetime.datetime.now()

&#160; &#160; &#160; &#160; def lineReceived(self, data):
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; TCPServerProtocol.req_count+=1
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; if TCPServerProtocol.req_count%10000==0:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ct = datetime.datetime.now()
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; dt = ct-TCPServerProtocol.req_time
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; pps = 10000/(dt.seconds+dt.microseconds/1000000.0)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; TCPServerProtocol.req_time=ct
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; print('RPS='+str(pps))
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; try:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; #self.transport.write(data)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; self.transport.getHandle().send(data)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; except:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; traceback.print_exc()

tcli.py&#160;
-----------------------------------------------------------------
import sys
import socket
import traceback
import time
import datetime

host = 'localhost'
port = 9976
loopcount = 300
sockcount = 5000
RPS = 4000

ss=[]
for x in xrange(sockcount):
&#160; &#160; &#160; &#160; ss.append(socket.socket(socket.AF_INET, socket.SOCK_STREAM))
&#160; &#160; &#160; &#160; ss[x].connect((host, port))
&#160; &#160; &#160; &#160; ss[x].settimeout(120)

for x in xrange(10000000):
&#160; &#160; &#160; &#160; st = datetime.datetime.now()
&#160; &#160; &#160; &#160; for y in xrange(loopcount):
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; try:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; if ss[x%sockcount]!=None:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ss[x%sockcount].sendall('1234567890\r\n')
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; ss[x%sockcount].recv(1024)
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; except:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; print y
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; sys.exit()
&#160; &#160; &#160; &#160; time.sleep(0.1)
&#160; &#160; &#160; &#160; dt = (datetime.datetime.now()-st)
&#160; &#160; &#160; &#160; plc = loopcount/(dt.seconds+dt.microseconds/1000000.0)
&#160; &#160; &#160; &#160; print loopcount/(dt.seconds+dt.microseconds/1000000.0)
&#160; &#160; &#160; &#160; #auto adjust RPS
&#160; &#160; &#160; &#160; if plc&lt;RPS:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; if RPS-plc&gt;50:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; loopcount+=10
&#160; &#160; &#160; &#160; else:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; if plc-RPS&gt;50:
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; loopcount-=10

echosvr.c&#160;
----------------------------------------------------------------------
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;errno.h&gt;
#include &lt;assert.h&gt;

#include &lt;event2/event.h&gt;
#include &lt;event2/bufferevent.h&gt;

#define LISTEN_PORT 9976
#define LISTEN_BACKLOG 32

#ifdef FD_SETSIZE
#undef FD_SETSIZE
#endif
#define FD_SETSIZE 65536

void do_accept(evutil_socket_t listener, short event, void *arg);
void read_cb(struct bufferevent *bev, void *arg);
void error_cb(struct bufferevent *bev, short event, void *arg);
void write_cb(struct bufferevent *bev, void *arg);

int main(int argc, char *argv[])
{
&#160; &#160; int ret;
&#160; &#160; evutil_socket_t listener;
&#160; &#160; listener = socket(AF_INET, SOCK_STREAM, 0);
&#160; &#160; assert(listener&gt; 0);
&#160; &#160; evutil_make_listen_socket_reuseable(listener);

&#160; &#160; struct sockaddr_in sin;
&#160; &#160; sin.sin_family = AF_INET;
&#160; &#160; sin.sin_addr.s_addr = 0;
&#160; &#160; sin.sin_port = htons(LISTEN_PORT);

&#160; &#160; if (bind(listener, (struct sockaddr *)&amp;sin, sizeof(sin)) &lt; 0) {
&#160; &#160; &#160; &#160; perror(&quot;bind&quot;);
&#160; &#160; &#160; &#160; return 1;
&#160; &#160; }

&#160; &#160; if (listen(listener, LISTEN_BACKLOG) &lt; 0) {
&#160; &#160; &#160; &#160; perror(&quot;listen&quot;);
&#160; &#160; &#160; &#160; return 1;
&#160; &#160; }

&#160; &#160; printf (&quot;Listening...\n&quot;);

&#160; &#160; evutil_make_socket_nonblocking(listener);

&#160; &#160; struct event_base *base = event_base_new();
&#160; &#160; assert(base != NULL);
&#160; &#160; struct event *listen_event;
&#160; &#160; listen_event = event_new(base, listener, EV_READ|EV_PERSIST, do_accept, (void*)base);
&#160; &#160; event_add(listen_event, NULL);
&#160; &#160; event_base_dispatch(base);

&#160; &#160; printf(&quot;The End.&quot;);
&#160; &#160; return 0;
}

void do_accept(evutil_socket_t listener, short event, void *arg)
{
&#160; &#160; struct event_base *base = (struct event_base *)arg;
&#160; &#160; evutil_socket_t fd;
&#160; &#160; struct sockaddr_in sin;
&#160; &#160; socklen_t slen;
&#160; &#160; fd = accept(listener, (struct sockaddr *)&amp;sin, &amp;slen);
&#160; &#160; if (fd &lt; 0) {
&#160; &#160; &#160; &#160; perror(&quot;accept&quot;);
&#160; &#160; &#160; &#160; return;
&#160; &#160; }
&#160; &#160; if (fd&gt; FD_SETSIZE) {
&#160; &#160; &#160; &#160; perror(&quot;fd&gt; FD_SETSIZE\n&quot;);
&#160; &#160; &#160; &#160; return;
&#160; &#160; }

&#160; &#160; printf(&quot;ACCEPT: fd = %u\n&quot;, fd);

&#160; &#160; struct bufferevent *bev = bufferevent_socket_new(base, fd, BEV_OPT_CLOSE_ON_FREE);
&#160; &#160; bufferevent_setcb(bev, read_cb, NULL, error_cb, arg);
&#160; &#160; bufferevent_enable(bev, EV_READ|EV_WRITE|EV_PERSIST);
}

void read_cb(struct bufferevent *bev, void *arg)
{
#define MAX_LINE &#160; &#160;256
&#160; &#160; char line[MAX_LINE+1];
&#160; &#160; int n;
&#160; &#160; evutil_socket_t fd = bufferevent_getfd(bev);

&#160; &#160; while (n = bufferevent_read(bev, line, MAX_LINE), n&gt; 0) {
&#160; &#160; &#160; &#160; line[n] = '\0';
&#160; &#160; &#160; &#160; //printf(&quot;fd=%u, read line: %s\n&quot;, fd, line);

&#160; &#160; &#160; &#160; bufferevent_write(bev, line, n);
&#160; &#160; }
}

void write_cb(struct bufferevent *bev, void *arg) {}

void error_cb(struct bufferevent *bev, short event, void *arg)
{
&#160; &#160; evutil_socket_t fd = bufferevent_getfd(bev);
&#160; &#160; printf(&quot;fd = %u, &quot;, fd);
&#160; &#160; if (event &amp; BEV_EVENT_TIMEOUT) {
&#160; &#160; &#160; &#160; printf(&quot;Timed out\n&quot;); //if bufferevent_set_timeouts() called
&#160; &#160; }
&#160; &#160; else if (event &amp; BEV_EVENT_EOF) {
&#160; &#160; &#160; &#160; printf(&quot;connection closed\n&quot;);
&#160; &#160; }
&#160; &#160; else if (event &amp; BEV_EVENT_ERROR) {
&#160; &#160; &#160; &#160; printf(&quot;some other error\n&quot;);
&#160; &#160; }
&#160; &#160; bufferevent_free(bev);
} 		 	   		  
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027267.html">[Twisted-Python] transport.write performance.
</A></li>
	<LI>Next message: <A HREF="027269.html">[Twisted-Python] transport.write performance.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27268">[ date ]</a>
              <a href="thread.html#27268">[ thread ]</a>
              <a href="subject.html#27268">[ subject ]</a>
              <a href="author.html#27268">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
