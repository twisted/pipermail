<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Trial &amp; the mock library
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Trial%20%26%20the%20mock%20library&In-Reply-To=%3C20130726141203.28793.1763275835.divmod.xquotient.749%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027253.html">
   <LINK REL="Next"  HREF="027255.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Trial &amp; the mock library</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Trial%20%26%20the%20mock%20library&In-Reply-To=%3C20130726141203.28793.1763275835.divmod.xquotient.749%40top%3E"
       TITLE="[Twisted-Python] Trial &amp; the mock library">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri Jul 26 08:12:03 MDT 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="027253.html">[Twisted-Python] Trial &amp; the mock library
</A></li>
        <LI>Next message: <A HREF="027255.html">[Twisted-Python] Trial &amp; the mock library
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27254">[ date ]</a>
              <a href="thread.html#27254">[ thread ]</a>
              <a href="subject.html#27254">[ subject ]</a>
              <a href="author.html#27254">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25 Jul, 02:25 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jamesbroadhead at gmail.com</A> wrote:
&gt;<i>Hey all -
</I>&gt;<i>
</I>&gt;<i>I've recently started working with the 'mock' library in our trial 
</I>&gt;<i>tests,
</I>&gt;<i>and am looking for some best-practice advice.  I'm really just starting 
</I>&gt;<i>to
</I>&gt;<i>get used to the library, so it might well have functionality that I'm
</I>&gt;<i>unaware of or am misusing.
</I>&gt;<i>
</I>&gt;<i>I very quickly ran into a problem where I mistakenly returned a Mock() 
</I>&gt;<i>in
</I>&gt;<i>the place of a deferred, causing the asserts in callbacks to not be 
</I>&gt;<i>called,
</I>&gt;<i>and for the test to spuriously pass.
</I>
To address this problem, I suggest you get into the habit of watching 
your unit tests fail in the expected way before you make the necessary 
implementation changes to make them pass.

This is only one of an unlimited number of ways your unit tests can be 
buggy.  It might be tempting to try to fix the test runner to prevent 
you from ever falling into this trap again - and who knows, it might 
even be a good idea.
However, if you run your tests and see them fail in the way you expected 
them to fail before you write the code that makes them pass, then you 
will be sure to avoid the many, many, many *other* pitfalls that have 
nothing to do with accidentally returning the wrong object.

This is just one of the attractions of test-driven development for me.

Jean-Paul
&gt;<i>A basic example:
</I>&gt;<i>
</I>&gt;<i>def test_foo():
</I>&gt;<i>  d = Mock()
</I>&gt;<i>  def check_result(res):
</I>&gt;<i>    self.assertEqual(res.code, expected)  # never called
</I>&gt;<i>  d.addCallback(check_result)
</I>&gt;<i>  return d # Mock is truthy, test passes
</I>&gt;<i>
</I>&gt;<i>This occurred where I was mocking some internals of the class under 
</I>&gt;<i>test;
</I>&gt;<i>something like the below
</I>&gt;<i>
</I>&gt;<i>A slightly more believable example:
</I>&gt;<i>== myclass.py ==
</I>&gt;<i>def some_function(...):
</I>&gt;<i>  d = self.authenticate()
</I>&gt;<i>  d.addCallback(foo) # foo never called
</I>&gt;<i>  d.addErrback(bar) # bar never called
</I>&gt;<i>  return d
</I>&gt;<i>
</I>&gt;<i>== test_myclass.py ==
</I>&gt;<i>def setUp(self):
</I>&gt;<i>  self.resource.authenticate = Mock(return_value=Mock())
</I>&gt;<i>
</I>&gt;<i>def test_foo():
</I>&gt;<i>  d = self.resource.some_function
</I>&gt;<i>  def check_result(res):  # never called
</I>&gt;<i>    self.assertEqual(res.code, expected)
</I>&gt;<i>  d.addCallback(check_result)
</I>&gt;<i>  return d # test passes
</I>&gt;<i>
</I>&gt;<i>Currently, I'm experimenting with wrapping Mock instantiations by 
</I>&gt;<i>defining
</I>&gt;<i>common deferred methods on them in advance; this approach would 
</I>&gt;<i>eventually
</I>&gt;<i>lead to extending Mock itself with this functionality.
</I>&gt;<i>
</I>&gt;<i>def nonDeferredMock():
</I>&gt;<i>    m = Mock()
</I>&gt;<i>    def notimpl(*args, **kwargs):
</I>&gt;<i>        raise NotImplementedError('You treated a Mock like a Deferred!')
</I>&gt;<i>    m.addCallback = notimpl
</I>&gt;<i>    m.addErrback = notimpl
</I>&gt;<i>    m.addBoth = notimpl
</I>&gt;<i>    m.addCallbacks = notimpl
</I>&gt;<i>    return m
</I>&gt;<i>
</I>&gt;<i>Another approach might be extending TestCase to check that return 
</I>&gt;<i>values
</I>&gt;<i>are always not Mock objects.
</I>&gt;<i>
</I>&gt;<i>Does anyone on the list have experience with this? Obviously, this only
</I>&gt;<i>happens when mistakes are made when writing tests, but I'd rather have
</I>&gt;<i>confidence that when my tests pass, that they've passed for the right
</I>&gt;<i>reasons.
</I>&gt;<i>
</I>&gt;<i>Another antipattern that I've come across has been:
</I>&gt;<i>
</I>&gt;<i>resource.mymethod = Mock(return_value=defer.succeed(None))
</I>&gt;<i>
</I>&gt;<i>which works fine for tests in which mymethod() is called once, but 
</I>&gt;<i>always
</I>&gt;<i>returns the same deferred object if multiple calls are made. What would 
</I>&gt;<i>be
</I>&gt;<i>a better approach?
</I>&gt;<i>
</I>&gt;<i>Cheers-
</I>&gt;<i>
</I>&gt;<i>James
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="027253.html">[Twisted-Python] Trial &amp; the mock library
</A></li>
	<LI>Next message: <A HREF="027255.html">[Twisted-Python] Trial &amp; the mock library
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27254">[ date ]</a>
              <a href="thread.html#27254">[ thread ]</a>
              <a href="subject.html#27254">[ subject ]</a>
              <a href="author.html#27254">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
