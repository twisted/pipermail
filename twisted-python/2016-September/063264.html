<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How do you determine the buffer size of a	transport - a use-case for not using back pressure
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20do%20you%20determine%20the%20buffer%20size%20of%20a%0A%09transport%20-%20a%20use-case%20for%20not%20using%20back%20pressure&In-Reply-To=%3CA57C76E6-5EE9-442D-A059-FD4346C1E88A%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How do you determine the buffer size of a	transport - a use-case for not using back pressure</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20do%20you%20determine%20the%20buffer%20size%20of%20a%0A%09transport%20-%20a%20use-case%20for%20not%20using%20back%20pressure&In-Reply-To=%3CA57C76E6-5EE9-442D-A059-FD4346C1E88A%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] How do you determine the buffer size of a	transport - a use-case for not using back pressure">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Sep 28 21:47:29 MDT 2016</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63264">[ date ]</a>
              <a href="thread.html#63264">[ thread ]</a>
              <a href="subject.html#63264">[ subject ]</a>
              <a href="author.html#63264">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Steve,

It looks like I had marked this message as interesting and warranting a reply, but never got around to it.  I'm sorry it's been quite a while!  I appreciate the amount of research you did here :-).

&gt;<i> On Aug 17, 2016, at 3:43 PM, Steve Morin &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">steve.morin at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Twisted Community
</I>&gt;<i> 
</I>&gt;<i> Problem: How do you determine the buffer size of a transport, to know how much data is waiting to be transmitted from using transport.write?
</I>&gt;<i> 
</I>&gt;<i> Wait! You're going to say: use the Producer Consumer API ( <A HREF="http://twistedmatrix.com/documents/current/core/howto/producers.html">http://twistedmatrix.com/documents/current/core/howto/producers.html</A> &lt;<A HREF="http://twistedmatrix.com/documents/current/core/howto/producers.html">http://twistedmatrix.com/documents/current/core/howto/producers.html</A>&gt; )
</I>
This is, unfortunately, the only solution :).

&gt;<i> To do what: So that instead of using back pressure I can check the buffer and when it's &quot;too big/full&quot; can decide to do something to the transport I am writing to:
</I>
I think when you say &quot;back pressure&quot; you're referring to your program exerting back-pressure on its peer.  I understand why you don't want to do that.  However, there's another kind of back pressure - your peer exerting back pressure on your program.

Commensurately, there are two ways to use back pressure:

To exert back pressure on your peer, call `self.transport.pauseProducing()`.  Later, when you're ready to receive more data, call `self.transport.resumeProducing()`.  This is what you don't want to do.
To detect when back pressure is applied from your peer, call `self.transport.registerProducer(self, True)`; then the reactor will call pauseProducing() when its buffer is full and and resumeProducing() when it empties out again.

Your list of things you might want to do here:

&gt;<i> - Buffer to disk instead of memory
</I>&gt;<i> - Kill the transport
</I>&gt;<i> - Decide to skip sending some data
</I>&gt;<i> - Send an error or message to the transport I am writing to
</I>&gt;<i> - Reduce the resolution, increase the compression (things like video or audio)
</I>
is a good one, and all these things can be achieved.  Going through them:

If you want to buffer to disk instead of memory, have a method like:

def someDataToSendToPeer(self, someData):
    if self.isProducing:
        self.transport.write(someData)
    else:
        self.bufferFile.write(someData)

def pauseProducing(self):
    self.isProducing = False
    self.bufferFile = open(&quot;buffer.file&quot;, &quot;wb&quot;)

def resumeProducing(self):
    self.isProducing = True
    self.startUbufferingFromFile()

If you want to kill the transport,

def pauseProducing(self):
    self.transport.abortConnection()

If you want to reduce video stream quality,

def streamSomeRawVideo(self, someRawVideo):
    if self.isProducing:
        self.transport.write(self.videoBuffer.addAndEncodeToBytes(someRawVideo))
    else:
        self.videoBuffer.addAndCompressSomeMore(someRawVideo)

and so on, and so on.

Basically, you can treat the buffer as &quot;empty&quot; until pauseProducing() is called.  Once it is, you can treat it as &quot;full&quot;.

Hope this was helpful, and still timely enough for you to make some use of it :).

-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20160928/99042030/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63264">[ date ]</a>
              <a href="thread.html#63264">[ thread ]</a>
              <a href="subject.html#63264">[ subject ]</a>
              <a href="author.html#63264">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
