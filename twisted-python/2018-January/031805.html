<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Circular references in TLSMemoryBIOProtocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Circular%20references%20in%20TLSMemoryBIOProtocol&In-Reply-To=%3C5C0AD3B3-C328-4057-B268-B01A7D811784%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031803.html">
   <LINK REL="Next"  HREF="031806.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Circular references in TLSMemoryBIOProtocol</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Circular%20references%20in%20TLSMemoryBIOProtocol&In-Reply-To=%3C5C0AD3B3-C328-4057-B268-B01A7D811784%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Circular references in TLSMemoryBIOProtocol">glyph at twistedmatrix.com
       </A><BR>
    <I>Sun Jan 21 02:50:23 MST 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031803.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
        <LI>Next message (by thread): <A HREF="031806.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31805">[ date ]</a>
              <a href="thread.html#31805">[ thread ]</a>
              <a href="subject.html#31805">[ subject ]</a>
              <a href="author.html#31805">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Jan 20, 2018, at 9:32 AM, Ilya Skriblovsky &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ilyaskriblovsky at gmail.com</A>&gt; wrote:
&gt;<i> 
</I>&gt;<i> Yes, doing it only for TLSMemoryBIOProtocol fails test too :(
</I>&gt;<i> 
</I>&gt;<i> SSL-related seem to be touching both ends of this reference cycle after connectionLost:
</I>&gt;<i> 
</I>&gt;<i> 1. twisted/test/test_sslverify.py:2102
</I>&gt;<i> self.assertEqual(sProto.wrappedProtocol.data, b'')
</I>&gt;<i> This one touches `wrappedProtocol`
</I>&gt;<i> 
</I>&gt;<i> 2. twisted/test/proto_helpers.py:924 (waitUntilAllDisconnected, used by twisted.web.test.test_webclient.WebClientSSLTests, for example)
</I>&gt;<i> if not True in [x.transport is not None and x.transport.connected for x in protocols]:
</I>&gt;<i> and this one touches `transport` field
</I>&gt;<i> 
</I>&gt;<i> There are other examples as well.
</I>&gt;<i> 
</I>&gt;<i> Sure, these test failures can probably be fixed by changing tests themselves, for example by making them to hold their own references to both wrapping and wrapped protocols. But I'm not sure this wouldn't break any user's code too... For my app it was easily fixed by breaking cycle in my protocol's connectionLost. But I'm not experienced enough in Twisted internals to be sure doing it inside TLSMemoryBIOProtocol wouldn't break any real-world usage scenarios.
</I>
I think that this is worth trying, at least.  If you could write a PR that fixes the tests, you might want to try following the exception process documented in <A HREF="https://twistedmatrix.com/documents/current/core/development/policy/compatibility-policy.html#procedure-for-exceptions-to-this-policy">https://twistedmatrix.com/documents/current/core/development/policy/compatibility-policy.html#procedure-for-exceptions-to-this-policy</A> &lt;<A HREF="https://twistedmatrix.com/documents/current/core/development/policy/compatibility-policy.html#procedure-for-exceptions-to-this-policy">https://twistedmatrix.com/documents/current/core/development/policy/compatibility-policy.html#procedure-for-exceptions-to-this-policy</A>&gt; and see if anyone has any code that might break.

I'm pretty sure that the direction to break the cycle in is to break the reference to .wrappedProtocol, and not to mess with .wrappedProtocol.transport (which is not really something that should be touched from the outside of the wrapped protocol).

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20180121/56648f42/attachment.html&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031803.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
	<LI>Next message (by thread): <A HREF="031806.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31805">[ date ]</a>
              <a href="thread.html#31805">[ thread ]</a>
              <a href="subject.html#31805">[ subject ]</a>
              <a href="author.html#31805">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
