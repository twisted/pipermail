<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Circular references in TLSMemoryBIOProtocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Circular%20references%20in%20TLSMemoryBIOProtocol&In-Reply-To=%3C2801916D-83AC-47FC-B5E4-ED4BC8CD0330%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064260.html">
   <LINK REL="Next"  HREF="064262.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Circular references in TLSMemoryBIOProtocol</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Circular%20references%20in%20TLSMemoryBIOProtocol&In-Reply-To=%3C2801916D-83AC-47FC-B5E4-ED4BC8CD0330%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Circular references in TLSMemoryBIOProtocol">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Jan 18 00:10:15 MST 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064260.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
        <LI>Next message (by thread): <A HREF="064262.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64261">[ date ]</a>
              <a href="thread.html#64261">[ thread ]</a>
              <a href="subject.html#64261">[ subject ]</a>
              <a href="author.html#64261">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

&gt;<i> On Jan 17, 2018, at 1:09 PM, Ilya Skriblovsky &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ilyaskriblovsky at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I have the Twisted app that serves tons of short-lived TLS connections using TLSMemoryBIOFactory. I usually set loosened garbage collector thresholds in production environment for the sake of performance. But I've noticed that this app's RAM usage quickly grows up to unreasonable values. Digging into the issue using pdb and objgraph showed that protocol instances are still living long after they were closed.
</I>
This sounds like an issue that should be reported as a bug and fixed!

It would be great if you could come up with a performance regression test or benchmark which could validate that this doesn't regress, but, it's quite challenging to do this (especially for memory issues) so as long as it's adequately behaviorally tested I'm sure we could accept something.

&gt;<i> I found two circular dependencies which are created for each TLS connection:
</I>&gt;<i> 1. Between twisted.protocols.policies.ProtocolWrapper and its self.wrappedProtocol
</I>&gt;<i> 2. Between twisted.protocols.tls.TLSMemoryBIOProtocol and its self._tlsConnection
</I>&gt;<i> 
</I>&gt;<i> Both of them cause protocol instance to not be deleted when the connection is closed. So all OpenSSL-related objects and all business-related data attached to that protocol instance are still living untill the next GC collection. This affects both RAM usage and performance (due to much more often GC collections)
</I>&gt;<i> 
</I>&gt;<i> I've tried to fix both circular dependencies:
</I>&gt;<i> 
</I>&gt;<i> replaced <A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/policies.py#L75">https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/policies.py#L75</A> &lt;<A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/policies.py#L75">https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/policies.py#L75</A>&gt; by
</I>&gt;<i> self.wrappedProtocol.makeConnection(weakref.proxy(self))
</I>&gt;<i> and replaced <A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/tls.py#L199">https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/tls.py#L199</A> &lt;<A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/tls.py#L199">https://github.com/twisted/twisted/blob/trunk/src/twisted/protocols/tls.py#L199</A>&gt; by:
</I>&gt;<i> self._tlsConnection = self.factory._createConnection(weakref.proxy(self))
</I>&gt;<i> 
</I>&gt;<i> Memory usage pattern changed drastically after this change.
</I>&gt;<i> 
</I>&gt;<i> I've created demo script that makes 10k TLS loopback connections with GC disabled and measures the number of objects are still living after the work is done and total resident RAM consumption:
</I>&gt;<i> <A HREF="https://gist.github.com/IlyaSkriblovsky/4dd3abfd5f67c64b13f1c673f56466f9">https://gist.github.com/IlyaSkriblovsky/4dd3abfd5f67c64b13f1c673f56466f9</A> &lt;<A HREF="https://gist.github.com/IlyaSkriblovsky/4dd3abfd5f67c64b13f1c673f56466f9">https://gist.github.com/IlyaSkriblovsky/4dd3abfd5f67c64b13f1c673f56466f9</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> Output without the fix:
</I>&gt;<i>     N = 10000 , K = 100
</I>&gt;<i>     objects before 50136
</I>&gt;<i>     DummyServerProtocols still living 10000
</I>&gt;<i>     objects after 439919
</I>&gt;<i>     mem 778 mb
</I>&gt;<i> 
</I>&gt;<i> Output with the fix:
</I>&gt;<i>     N = 10000 , K = 100
</I>&gt;<i>     objects before 50133
</I>&gt;<i>     DummyServerProtocols still living 0
</I>&gt;<i>     objects after 159919
</I>&gt;<i>     mem 96 mb
</I>&gt;<i> 
</I>&gt;<i> So using weakrefs makes all protocol instances and instances of TLSMemoryBIOProtocol to be deleted right after a connection is closed. Less circular-dependent objects → less GC invocations → better performance. And I see much nicer RAM usage pattern in my app.
</I>
Hooray!

&gt;<i> Is it possible to fix circular deps in some more clean way? Can this be solved at all while user's code is able to try to touch both sides of circular dep after connection is closed? Please advice
</I>
Protocols and transports have a fairly defined lifecycle, and as L. Daniel Burr already pointed out, it would probably be appropriate to explicitly break these reference cycles in connectionLost.

-g

&gt;<i> 
</I>&gt;<i> Thanks for consideration
</I>&gt;<i> 
</I>&gt;<i> Best regards,
</I>&gt;<i>     Ilya
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20180117/81738113/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064260.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
	<LI>Next message (by thread): <A HREF="064262.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64261">[ date ]</a>
              <a href="thread.html#64261">[ thread ]</a>
              <a href="subject.html#64261">[ subject ]</a>
              <a href="author.html#64261">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
