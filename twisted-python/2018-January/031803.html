<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Circular references in TLSMemoryBIOProtocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Circular%20references%20in%20TLSMemoryBIOProtocol&In-Reply-To=%3CCAOG7vkx%2BmApGk0dsd1vn8SXGSDZrqaWtA%3D4kqih901-XZ2ru%2Bg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031802.html">
   <LINK REL="Next"  HREF="031805.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Circular references in TLSMemoryBIOProtocol</H1>
    <B>Ilya Skriblovsky</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Circular%20references%20in%20TLSMemoryBIOProtocol&In-Reply-To=%3CCAOG7vkx%2BmApGk0dsd1vn8SXGSDZrqaWtA%3D4kqih901-XZ2ru%2Bg%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Circular references in TLSMemoryBIOProtocol">ilyaskriblovsky at gmail.com
       </A><BR>
    <I>Sat Jan 20 10:32:10 MST 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031802.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
        <LI>Next message (by thread): <A HREF="031805.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31803">[ date ]</a>
              <a href="thread.html#31803">[ thread ]</a>
              <a href="subject.html#31803">[ subject ]</a>
              <a href="author.html#31803">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yes, doing it only for TLSMemoryBIOProtocol fails test too :(

SSL-related seem to be touching both ends of this reference cycle after
connectionLost:

1. twisted/test/test_sslverify.py:2102
self.assertEqual(sProto.wrappedProtocol.data, b'')
This one touches `wrappedProtocol`

2. twisted/test/proto_helpers.py:924 (waitUntilAllDisconnected, used by
twisted.web.test.test_webclient.WebClientSSLTests, for example)
if not True in [x.transport is not None and x.transport.connected for x in
protocols]:
and this one touches `transport` field

There are other examples as well.

Sure, these test failures can probably be fixed by changing tests
themselves, for example by making them to hold their own references to both
wrapping and wrapped protocols. But I'm not sure this wouldn't break any
user's code too... For my app it was easily fixed by breaking cycle in my
protocol's connectionLost. But I'm not experienced enough in Twisted
internals to be sure doing it inside TLSMemoryBIOProtocol wouldn't break
any real-world usage scenarios.

- Ilya

сб, 20 янв. 2018 г. в 9:10, Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;:

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On Jan 19, 2018, at 11:52 AM, Ilya Skriblovsky &lt;
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ilyaskriblovsky at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Protocols and transports have a fairly defined lifecycle, and as L.
</I>&gt;<i> Daniel Burr already pointed out, it would probably be appropriate to
</I>&gt;<i> explicitly break these reference cycles in connectionLost.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Explicitly breaking cycle in ProtocolWrapper.connectionLost by any of:
</I>&gt;<i> &gt; • self.wrappedProtocol = None
</I>&gt;<i> &gt; • self.wrappedProtocol.transport = None
</I>&gt;<i> &gt; • self.wrappedProtocol = weakref.proxy(self.wrappedProtocol)
</I>&gt;<i> &gt; • self.wrappedProtocol.transport = weakref.proxy(self)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ... breaks some existing tests :(
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Seems like these tests do some post-run checks against protocol
</I>&gt;<i> instances and their transports. Not sure whether it is relevant to
</I>&gt;<i> real-life usage.
</I>&gt;<i> &gt; Will investigate more...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; - Ilya
</I>&gt;<i>
</I>&gt;<i> Do these tests fail if you only do it in TLSMemoryBIOProtocol instead of
</I>&gt;<i> WrapperProtocol?
</I>&gt;<i>
</I>&gt;<i> If so, this may be worth a compatibility exception.
</I>&gt;<i>
</I>&gt;<i> -g
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20180120/c0bb261b/attachment.html&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031802.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
	<LI>Next message (by thread): <A HREF="031805.html">[Twisted-Python] Circular references in TLSMemoryBIOProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31803">[ date ]</a>
              <a href="thread.html#31803">[ thread ]</a>
              <a href="subject.html#31803">[ subject ]</a>
              <a href="author.html#31803">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
