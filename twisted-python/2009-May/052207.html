<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Guidance on Proxy-type Application
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Guidance%20on%20Proxy-type%20Application&In-Reply-To=%3C5a8f2d170905281222v79d84301k1050ad112a2c9e60%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052206.html">
   <LINK REL="Next"  HREF="052208.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Guidance on Proxy-type Application</H1>
    <B>Aaron Bush</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Guidance%20on%20Proxy-type%20Application&In-Reply-To=%3C5a8f2d170905281222v79d84301k1050ad112a2c9e60%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Guidance on Proxy-type Application">asb.bush at gmail.com
       </A><BR>
    <I>Thu May 28 13:22:20 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052206.html">[Twisted-Python] Guidance on Proxy-type Application
</A></li>
        <LI>Next message (by thread): <A HREF="052208.html">[Twisted-Python] Guidance on Proxy-type Application
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52207">[ date ]</a>
              <a href="thread.html#52207">[ thread ]</a>
              <a href="subject.html#52207">[ subject ]</a>
              <a href="author.html#52207">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks John.

Here is some sample code that is somewhat working for me right now.  Any and
all comments are greatly appreciated.

1) I setup a netcat listener on port 8080.
2) Start the twisted program, it connects to 8080 and then fires up a
listener on port 808 from the ChattyMCProtocol protocol.
3) Start a netcat client connection to the server process.
4) The client connection and any data they enter will be passed to the
'master control' process (ReconnectingClientFactory).

from twisted.internet.protocol import ReconnectingClientFactory,
ServerFactory
from twisted.protocols.basic import LineOnlyReceiver
from twisted.internet import reactor

&quot;&quot;&quot;Some test code using a chat-like approach with a master control node&quot;&quot;&quot;

class ChattyServerProtocol(LineOnlyReceiver):
    '''
    A test proto which will receive data and then forward it on the to the
master control
    '''
    delimiter = '\n'

    def connectionMade(self):
        self.transport.write(&quot;Welcome to the Server\n&quot;)
        &quot;&quot;&quot; Tell the master control that a client came in&quot;&quot;&quot;
        self.factory.parent.transport.write(&quot;Someone connected\n&quot;)

    def connectionLost(self, reason):
        self.factory.parent.transport.write(&quot;Server lost the connection to a
client&quot;)

    def lineReceived(self, line):
        print &quot;Server got some data: &quot; + line
        &quot;&quot;&quot; Now send the data to the master control&quot;&quot;&quot;
        self.factory.parent.transport.write(&quot;Client Said: %s\n&quot; % line)


class ChattyServerFactory(ServerFactory):
    protocol = ChattyServerProtocol

    def __init__(self, parent):
        self.parent = parent
        pass

class ChattyMCProtocol(LineOnlyReceiver):
    delimiter = '\n'

    def __init__(self):
        &quot;&quot;&quot;Connected so startup Server for clients&quot;&quot;&quot;
        self.server_factory = ChattyServerFactory(self)
        reactor.listenTCP(808, self.server_factory)

    def lineReceived(self, line):
        self.transport.write(&quot;Processing what you said: %s\n&quot; % line)

class ChattyMCFactory(ReconnectingClientFactory):

    def startedConnecting(self, connector):
        print &quot;Connecting...&quot;

    def clientConnectionFailed(self, connector, reason):
        print &quot;The connection failed&quot;
        ReconnectingClientFactory.clientConnectionFailed(self, connector,
reason)

    def clientConnectionLost(self, connector, reason):
        print &quot;The connection was lost&quot;
        ReconnectingClientFactory.clientConnectionLost(self, connector,
reason)

    def buildProtocol(self, addr):
        print &quot;Connected, reset the delay&quot;
        self.resetDelay()
        # Next startup a server for the clients
        #self.server_factory = ChattyServerFactory(self)
        return ChattyMCProtocol()

reactor.connectTCP(&quot;127.0.0.1&quot;, 8080, ChattyMCFactory())
reactor.run()

Items that I don't know how to handle yet:
 - I need to determine how to better handle the case where the connection
made via ReconnectingClientFactory is dropped.  It does reconnect as the
Factory should but the problem is that the Server portion is not cleanly
shutdown so when the ChattyMCProtocol tries to listen it fails as the socket
is already in use.  Any ideas how to signal to the server to shutdown?
 - Much more to be done.  How to take this to the level of a proper Twisted
&quot;application&quot;, etc.

Thanks,
-ab

On Thu, May 28, 2009 at 12:01 PM, John Santos &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">JOHN at egh.com</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> Hi Adam -
</I>&gt;<i>
</I>&gt;<i> I'm in pretty much the same situation as you and am working on a similar
</I>&gt;<i> problem.  Very much a Python and Twisted newbie.
</I>&gt;<i>
</I>&gt;<i> The program I'm working on needs to talk to a variety of clients and to
</I>&gt;<i> a single server, with more-or-less permanent connections to all of them.
</I>&gt;<i>
</I>&gt;<i> My problem is somewhat different from yours (and probably a little
</I>&gt;<i> simpler), since all input from all clients goes to the server, and
</I>&gt;<i> all output from the server goes to all clients (so I don't have to
</I>&gt;<i> tag and remember which response goes to which client.)  However,
</I>&gt;<i> there are other messages from the clients that don't go to the
</I>&gt;<i> server, but instead do other things, some requiring responses.
</I>&gt;<i> So the message handling in my program (what happens when dataRecieved
</I>&gt;<i> gets called) may be more complicated than in yours.  But that is
</I>&gt;<i> (at least from my perspective) the easy part.  Getting the twisted
</I>&gt;<i> app to talk to the server and all the clients, and not to fall over
</I>&gt;<i> dead when a client goes away, etc. is (to me) the hard part, and I
</I>&gt;<i> feel like I've just gotten over a huge hump now that that is (mostly)
</I>&gt;<i> working (as of two days ago.)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am using two factories, one to generate the object that talks to the
</I>&gt;<i> server (using conch.telnet), and one to generate objects to talk to
</I>&gt;<i> the clients.  The clients can come and go but would typically be
</I>&gt;<i> permanent.  (Actually 3 factories right now, since I'm using the
</I>&gt;<i> StdioProxyFactory from the example for debugging, but that will
</I>&gt;<i> go away as I get the client protocol working.)
</I>&gt;<i>
</I>&gt;<i> I started from the dataforward.py example in Twisted book, but by
</I>&gt;<i> now it has been massively changed.
</I>&gt;<i>
</I>&gt;<i> Before starting the reactor, I do a reactor.connectTCP to the server
</I>&gt;<i> using the factory for the server connections and a reactor.listenTCP
</I>&gt;<i> using the client connection factory, to listen for client connections.
</I>&gt;<i>
</I>&gt;<i> One change I had to make to the example was to promote the
</I>&gt;<i> InputForwarder object from an attribute of the client connection
</I>&gt;<i> object to a global object since it is common to all the
</I>&gt;<i> client connections.  (I hope I have the terminology correct here;
</I>&gt;<i> as I've said, I'm a Python newbie.)
</I>&gt;<i>
</I>&gt;<i> It turns out to be fairly small amount of code, and I think it
</I>&gt;<i> can still be simplified some more.
</I>&gt;<i>
</I>&gt;<i> So I think you are on the right track.  HTH!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> John Santos
</I>&gt;<i> Evans Griffiths &amp; Hart, Inc.
</I>&gt;<i> 781-861-0670 ext 539
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20090528/8db3556e/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052206.html">[Twisted-Python] Guidance on Proxy-type Application
</A></li>
	<LI>Next message (by thread): <A HREF="052208.html">[Twisted-Python] Guidance on Proxy-type Application
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52207">[ date ]</a>
              <a href="thread.html#52207">[ thread ]</a>
              <a href="subject.html#52207">[ subject ]</a>
              <a href="author.html#52207">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
