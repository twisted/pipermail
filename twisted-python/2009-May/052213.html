<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Guidance on Proxy-type Application
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Guidance%20on%20Proxy-type%20Application&In-Reply-To=%3C20090528225800.12555.827283410.divmod.xquotient.11675%40weber.divmod.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="052208.html">
   <LINK REL="Next"  HREF="052214.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Guidance on Proxy-type Application</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Guidance%20on%20Proxy-type%20Application&In-Reply-To=%3C20090528225800.12555.827283410.divmod.xquotient.11675%40weber.divmod.com%3E"
       TITLE="[Twisted-Python] Guidance on Proxy-type Application">glyph at divmod.com
       </A><BR>
    <I>Thu May 28 16:58:00 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="052208.html">[Twisted-Python] Guidance on Proxy-type Application
</A></li>
        <LI>Next message (by thread): <A HREF="052214.html">[Twisted-Python] Guidance on Proxy-type Application
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52213">[ date ]</a>
              <a href="thread.html#52213">[ thread ]</a>
              <a href="subject.html#52213">[ subject ]</a>
              <a href="author.html#52213">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 01:23 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">asb.bush at gmail.com</A> wrote:
&gt;<i>I have just started to look at the Twisted framework and would like to 
</I>&gt;<i>put it
</I>&gt;<i>to use for a new project I am working on.  Not being very familiar with 
</I>&gt;<i>the
</I>&gt;<i>framework and fairly new to Python in general I would like to ask a
</I>&gt;<i>design/architecture question.  (I have written similar applications in 
</I>&gt;<i>C but
</I>&gt;<i>would prefer to start this in the right direction and not write Python 
</I>&gt;<i>like
</I>&gt;<i>C.)
</I>
Thanks for asking!

I apologize for the delay in my answer.  I started writing up a simple 
example (attached) but was discouraged to find that it was 100 lines 
long and required too much explaining.

Then I started documenting it and explaining every line but that was a 
very long, tedious message.  So, it doesn't have much in the way of 
explanation; I hope you will find it useful regardless.
&gt;<i>The application has the following model:
</I>
&gt;<i>Many clients connect to the Application and prefer to leave the 
</I>&gt;<i>connection
</I>&gt;<i>open.  They will send messages across this connection.  They will 
</I>&gt;<i>expect to
</I>&gt;<i>get a message back at some point later, they do not wait for a response
</I>&gt;<i>(async).  The clients are already coded (legacy) and just need to send 
</I>&gt;<i>their
</I>&gt;<i>proprietary protocol to the new Application (written using Twisted).
</I>
This is *almost* a FAQ.  At least, you may find this to be a useful 
answer:

&lt;<A HREF="http://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions#HowdoImakeinputononeconnectionresultinoutputonanother">http://twistedmatrix.com/trac/wiki/FrequentlyAskedQuestions#HowdoImakeinputononeconnectionresultinoutputonanother</A>&gt;
&gt;<i>The Twisted application will take the data from the clients and do some
</I>&gt;<i>transformation on it then send the message on to another server (3rd 
</I>&gt;<i>party).
</I>&gt;<i>This connection to &quot;another&quot; server must be a single connection, not 
</I>&gt;<i>one
</I>&gt;<i>connection per client.  This connection should also be persistent and 
</I>&gt;<i>not
</I>&gt;<i>opened/closed for each client message sent.  Ideally if the 3rd party 
</I>&gt;<i>server
</I>&gt;<i>is down then I would also not accept client connections as the messages 
</I>&gt;<i>are
</I>&gt;<i>time sensitive and should not be stored and forwarded.  At some point 
</I>&gt;<i>the 3rd
</I>&gt;<i>part will send a message back and the Application will route it back to 
</I>&gt;<i>the
</I>&gt;<i>original source.  Basically request/reply pattern.
</I>
The example that I've attached does basically this.  Run it and then run 
'telnet localhost 4322', and type some lines; you will see that they are 
transformed and echoed back to you, both by the proxy and by the 
protocol being proxied.

At a high level, the answer to your question is so simple that it's hard 
to express.  Basically, you just need to have all the relevant objects 
having references to each other, and calling methods to achieve the 
desired effect.  The less magic, the better.

More precisely, you need an object responsible for managing your 
outgoing connections to your legacy server, so that it can handle 
disconnection and reconnection, queueing messages and so on.  Then you 
need your proxy server factory to hold a reference to that object, so 
that it can create references from each proxy server protocol connection 
object to the connection manager.

This is related to another recent thread - you can see my message in 
that thread here:

    <A HREF="http://thread.gmane.org/gmane.comp.python.twisted/18377/focus=18385">http://thread.gmane.org/gmane.comp.python.twisted/18377/focus=18385</A>
&gt;<i>I have been reading through the archives and the twisted docs and have 
</I>&gt;<i>also
</I>&gt;<i>looked over the Hex-dump port-forwarding recipe but not found anything 
</I>&gt;<i>that
</I>&gt;<i>explains how to use twisted for this model.  Hex-dump is close but
</I>&gt;<i>opens/closes the connection to the server on each client connection.
</I>
I'm not sure why hex-dump port-forwarding is particularly relevant to 
this example.  Is it just because this is an application that connects 
from one host to another?
&gt;<i>I am thinking that there will be two Factories [and two protocols: 1) 
</I>&gt;<i>for
</I>&gt;<i>clients and 2) for 3rd party].  I am not sure how to best establish 
</I>&gt;<i>both the
</I>&gt;<i>listening factory and the client to 3rd party factory.  Once they are
</I>&gt;<i>established what is the preferred way in Twisted to pass a message from 
</I>&gt;<i>one
</I>&gt;<i>protocol to another?
</I>
This part of your question is almost exactly the FAQ I mentioned above 
:<i>).  To reiterate that answer, you just need to have references between 
</I>objects, and call methods on the objects you want to do stuff.

If you have a client connection object, just get a reference to that 
from the relevant server connection object and call methods on the 
client object to emit messages on the client protocol, handling any 
responses appropriately.  Deferreds can help with that latter part.

It is always better if you can establish that reference as simply as 
possible; for example, by passing parameters to the __init__ of various 
classes.  Again, for reasons that have nothing to do with Twisted 
specifically, it's a bad idea to try to establish these references by 
having global variables floating around.

Here's a very very simple example of the &quot;good way&quot; to propagate some 
data to protocol instances that need it:

    class MyProtocol(Protocol):
        def __init__(self, data):
            self.data = data

    class MyFactory(Factory):
        def __init__(self, data):
            self.data = data

        def buildProtocol(self, addr):
            return MyProtocol(self.data)

    reactor.listenTCP(8765, MyFactory(&quot;some data&quot;))

and here's a simple example of a really bad way (don't do this!):

    class MyProtocol(Protocol):
        def connectionMade(self):
            self.bleh = bleh

    bleh = &quot;some data&quot;
    f = Factory()
    f.protocol = MyProtocol
    reactor.listenTCP(9876, f)

Even in C, I'm pretty sure it's better style to pass structures to 
functions than to abuse piles of local variables :).  I only illustrate 
this bad style here because it seems to be a common antipattern.  The 
Protocol class itself doesn't take any parameters to __init__, and 
Twisted's users don't always realize that protocols and factories and so 
on are just regular objects, with no special rules; they just get 
methods called on them by the reactor.
&gt;<i>Any pointers or sample code that you can offer is greatly appreciated. 
</I>&gt;<i>I
</I>&gt;<i>would really like to cook this in Twisted and not go back to the C way.
</I>
Based on what you've said so far, I think you're basically on the right 
track.  Good luck!
-------------- next part --------------
A non-text attachment was scrubbed...
Name: multiclient.py
Type: application/x-python
Size: 2998 bytes
Desc: not available
URL: &lt;/pipermail/twisted-python/attachments/20090528/f3e6c1bf/attachment-0002.bin&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="052208.html">[Twisted-Python] Guidance on Proxy-type Application
</A></li>
	<LI>Next message (by thread): <A HREF="052214.html">[Twisted-Python] Guidance on Proxy-type Application
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#52213">[ date ]</a>
              <a href="thread.html#52213">[ thread ]</a>
              <a href="subject.html#52213">[ subject ]</a>
              <a href="author.html#52213">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
