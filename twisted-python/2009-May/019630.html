<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Consistent%20interfaces%20to%0A%09asynchronous%09partially-available%20services%09using%09Deferreds%20and%0A%09state%09machines%20%28was%20Re%3A%20Another%20approach%20to%20allowing%09__init__%0A%09to%09work%20with%20Deferreds%29&In-Reply-To=18955.53185.984111.643482%40jon.es">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019624.html">
   <LINK REL="Next"  HREF="019657.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)</H1>
    <B>Phil Christensen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Consistent%20interfaces%20to%0A%09asynchronous%09partially-available%20services%09using%09Deferreds%20and%0A%09state%09machines%20%28was%20Re%3A%20Another%20approach%20to%20allowing%09__init__%0A%09to%09work%20with%20Deferreds%29&In-Reply-To=18955.53185.984111.643482%40jon.es"
       TITLE="[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)">phil at bubblehouse.org
       </A><BR>
    <I>Thu May 14 11:48:02 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019624.html">[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)
</A></li>
        <LI>Next message: <A HREF="019657.html">[Twisted-Python] Consistent interfaces to asynchronous	partially-available services using Deferreds and state	machines (was Re: Another approach to allowing __init__ to	work with Deferreds)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19630">[ date ]</a>
              <a href="thread.html#19630">[ thread ]</a>
              <a href="subject.html#19630">[ subject ]</a>
              <a href="author.html#19630">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On May 14, 2009, at 4:01 AM, Terry Jones wrote:
&gt;&gt;&gt;&gt;&gt;&gt;<i> &quot;Phil&quot; == Phil Christensen &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">phil at bubblehouse.org</A>&gt; writes:
</I>&gt;<i>
</I>&gt;<i> Phil&gt; I don't know if I agree with the need for such a feature (that  
</I>&gt;<i> is,
</I>&gt;<i> Phil&gt; deferred __init__ usage), but it was a very interesting coding
</I>&gt;<i> Phil&gt; challenge I wanted to take a whack at. I *think* I might have  
</I>&gt;<i> found a
</I>&gt;<i> Phil&gt; solution, but I don't know if it falls under the heading of
</I>&gt;<i> Phil&gt; &quot;decorator abuse&quot; ;-)
</I>&gt;<i>
</I>&gt;<i> Hi Phil
</I>&gt;<i>
</I>&gt;<i> I finally had time to look at your solution a bit (though I've not run
</I>&gt;<i> it). It does a couple of things I wouldn't have thought of, like  
</I>&gt;<i> putting
</I>&gt;<i> the dictionary onto the deferredInit function. A couple of comments,
</I>&gt;<i> supposing I understand your code properly:
</I>&gt;<i>
</I>&gt;<i> - One thing I had hoped to avoid was to slow the class methods down by
</I>&gt;<i>   having them always check the original deferred (or a flag) before  
</I>&gt;<i> taking
</I>&gt;<i>   action. My approach does this by moving them aside and then  
</I>&gt;<i> putting them
</I>&gt;<i>   back in place once the deferred fires. Your solution requires that  
</I>&gt;<i> every
</I>&gt;<i>   decorated method does several extra things before it gets going.  
</I>&gt;<i> That
</I>&gt;<i>   could be greatly reduced if you were to check  
</I>&gt;<i> self.initDeferred.called
</I>&gt;<i>   and simply call the original function if the deferred has fired.
</I>
Yeah, I see what you mean. I changed it to directly call the function  
if the initDeferred has already been fired. One catch is that I think  
it's important that the function always return a Deferred, even if  
it's just a succeed() wrapper, so as to provide a consistent interface  
whether __init__ is finished or not.

I added a couple additional calls to my test example to illustrate this.

&gt;<i> - If multiple calls are made to instance methods before the init  
</I>&gt;<i> deferred
</I>&gt;<i>   has fired, they will, as I read it, all try to del
</I>&gt;<i>   deferredInit.waiting[self] in _finish. So I guess that del needs  
</I>&gt;<i> to be
</I>&gt;<i>   conditional or in a try/except.
</I>
I realized there's no reason to keep a dictionary anyways, since you  
always have access to `self`. The result means less bookkeeping, which  
is always good...

&gt;<i> - Using self as a key into the dict on initDeferred seems like it
</I>&gt;<i>   addresses Glyph's observation/criticism that my approach raises
</I>&gt;<i>   questions wrt inheritance.
</I>
I believe even though I removed that state dictionary, this should  
still work properly, since we always operate on/with `self`.

&gt;<i> - You could use chainDeferred where you're currently using
</I>&gt;<i>   .addCallbacks(resultDeferred.callback, resultDeferred.errback)
</I>
Ah yes. I forgot this existed; a lot of my Deferred experience is with  
sequential processes, so I've been using inlineCallbacks for everything.

&gt;<i> That's all for now. I'll see if I have more time to think about all  
</I>&gt;<i> this.
</I>&gt;<i> When I tried to use a decorator the first time, I was also using a  
</I>&gt;<i> super
</I>&gt;<i> class (whereas you're putting state into a dict on the deferredInit
</I>&gt;<i> function) but I got into a mess accessing self properly (partly  
</I>&gt;<i> because, I
</I>&gt;<i> think, I wanted to have a mixin class and I was looking at
</I>&gt;<i> self.__class__.__mro__).
</I>&gt;<i>
</I>&gt;<i> In any case, thanks for replying, for playing with it, and for  
</I>&gt;<i> posting your
</I>&gt;<i> code. I got to learn new things as a result, which is really great :-)
</I>
Yeah, same here. It's pretty rare that I can get into any 'semi- 
advanced' discussions on here (things often seem to go between one  
extreme and the other), but I always learn lots when I do.

I'm still not sure if I would use this technique myself, but I'm  
reasonably satisfied with the &quot;scent&quot; of this code. Obviously though,  
I haven't thought through a whole bunch of use cases, but it seems to  
be pretty simple, in the end.

I've attached the revised version of the decorator. Let me know if you  
think of anything else.

Thanks,

-phil

-------------- next part --------------
A non-text attachment was scrubbed...
Name: init_deferred.py
Type: text/x-python-script
Size: 2272 bytes
Desc: not available
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20090514/71b81de9/attachment.bin">http://twistedmatrix.com/pipermail/twisted-python/attachments/20090514/71b81de9/attachment.bin</A> 
-------------- next part --------------

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019624.html">[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)
</A></li>
	<LI>Next message: <A HREF="019657.html">[Twisted-Python] Consistent interfaces to asynchronous	partially-available services using Deferreds and state	machines (was Re: Another approach to allowing __init__ to	work with Deferreds)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19630">[ date ]</a>
              <a href="thread.html#19630">[ thread ]</a>
              <a href="subject.html#19630">[ subject ]</a>
              <a href="author.html#19630">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
