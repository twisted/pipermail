<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Consistent%20interfaces%20to%0A%09asynchronous%09partially-available%20services%09using%09Deferreds%20and%0A%09state%09machines%20%28was%20Re%3A%20Another%20approach%20to%20allowing%09__init__%0A%09to%09work%20with%20Deferreds%29&In-Reply-To=18953.24553.54020.283769%40jon.es">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019610.html">
   <LINK REL="Next"  HREF="019612.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)</H1>
    <B>Phil Christensen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Consistent%20interfaces%20to%0A%09asynchronous%09partially-available%20services%09using%09Deferreds%20and%0A%09state%09machines%20%28was%20Re%3A%20Another%20approach%20to%20allowing%09__init__%0A%09to%09work%20with%20Deferreds%29&In-Reply-To=18953.24553.54020.283769%40jon.es"
       TITLE="[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)">phil at bubblehouse.org
       </A><BR>
    <I>Tue May 12 10:47:38 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019610.html">[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)
</A></li>
        <LI>Next message: <A HREF="019612.html">[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19611">[ date ]</a>
              <a href="thread.html#19611">[ thread ]</a>
              <a href="subject.html#19611">[ subject ]</a>
              <a href="author.html#19611">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On May 12, 2009, at 7:39 AM, Terry Jones wrote:
&gt;&gt;<i> Just as a point of convenience, I would have automatically  
</I>&gt;&gt;<i> determined this
</I>&gt;&gt;<i> list of method names by using a decorator or something.  Having it  
</I>&gt;&gt;<i> as a
</I>&gt;&gt;<i> static list in the method invocation seems to me like it would be  
</I>&gt;&gt;<i> very easy
</I>&gt;&gt;<i> to forget to add or remove a method from the list, and it would  
</I>&gt;&gt;<i> make diffs
</I>&gt;&gt;<i> that touched a user of this class always have two hunks for adding a
</I>&gt;&gt;<i> method; one at the method definition site, one at the call to wrap().
</I>&gt;<i>
</I>&gt;<i> I started out trying to write this using decorators. But I didn't  
</I>&gt;<i> really
</I>&gt;<i> see how to do it. I was using two - one for __init__ and one for the
</I>&gt;<i> wrapped functions. I also tried with decorators and a super class.  
</I>&gt;<i> In the
</I>&gt;<i> end I saw a simple way to do it with the mixin, so went for that.  
</I>&gt;<i> I'd be
</I>&gt;<i> happier with a decorator solution for the reasons you mention.
</I>
I don't know if I agree with the need for such a feature (that is,  
deferred __init__ usage), but it was a very interesting coding  
challenge I wanted to take a whack at. I *think* I might have found a  
solution, but I don't know if it falls under the heading of &quot;decorator  
abuse&quot; ;-)

Basically, it requires that the init method set an instance variable  
bound to a Deferred that will fire when the initialization is  
finished. Then, @deferredInit decorators applied to each instance  
method handle checking for and adding callbacks to that original  
&quot;initDeferred&quot;.

This way, any method that depends on &quot;complete instantiation&quot; (which  
is probably most or all of them) can have the decorator applied, and  
will have itself added as a callback to the original initDeferred.

Right now, the name of the Deferred used by __init__ is hard coded,  
but you could easily make the decorator take an argument that  
specifies the name to use.

This appears to work for me, but there's a lot of stuff I'm still  
learning about deferreds, and although I read most of this thread, I  
may have missed a use case that won't work in this manner.

Still, it was a fun challenge ;-)

Let me know what you think:


     from twisted.internet import defer, reactor
     from twisted.enterprise import adbapi

     def deferredInit(func):
         if not(hasattr(deferredInit, 'waiting')):
             deferredInit.waiting = {}

         def _deferredInit(self, *args, **kwargs):
             waiting_for_init = self in deferredInit.waiting

             if not(waiting_for_init):
                 if(hasattr(self, 'initDeferred')):
                     deferredInit.waiting[self] = self.initDeferred
                 else:
                     raise RuntimeError(&quot;%s doesn't seem to support  
deferred instantion.&quot; % self.__class__.__name__)

             def _finish(result):
                 del deferredInit.waiting[self]
                 return func(self, *args, **kwargs)

             def _finish_error(failure):
                 print '_finish_err: %s' % failure

             resultDeferred = defer.Deferred()
             resultDeferred.addCallbacks(_finish, _finish_error)

              
deferredInit.waiting[self].addCallbacks(resultDeferred.callback,  
resultDeferred.errback)

             return resultDeferred

         return _deferredInit

     class TestDeferredInit(object):
         def __init__(self):
             self.pool = adbapi.ConnectionPool(&quot;MySQLdb&quot;, 'localhost',  
'test', 'test')
             self.initDeferred = self.pool.runQuery(&quot;SELECT 'it  
worked';&quot;)
             def _finish_init(msg):
                 self.msg = msg
             def _finish_init_error(failure):
                 print '_finish_init_err: %s' % failure
             self.initDeferred.addCallbacks(_finish_init,  
_finish_init_error)

         @deferredInit
         def query(self):
             return self.msg

     if(__name__ == '__main__'):
         def _print(msg):
             print msg
             reactor.stop()

         def _print_error(failure):
             print '_print_err: %s' % failure

         test = TestDeferredInit()

         d = test.query()
         d.addCallbacks(_print, _print_error)

         reactor.run()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019610.html">[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)
</A></li>
	<LI>Next message: <A HREF="019612.html">[Twisted-Python] Consistent interfaces to	asynchronous	partially-available services	using	Deferreds and	state	machines (was Re: Another approach to allowing	__init__	to	work with Deferreds)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19611">[ date ]</a>
              <a href="thread.html#19611">[ thread ]</a>
              <a href="subject.html#19611">[ subject ]</a>
              <a href="author.html#19611">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
