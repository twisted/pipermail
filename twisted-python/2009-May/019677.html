<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Reactor callback from the wrong thread
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Reactor%20callback%20from%20the%20wrong%20thread&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019675.html">
   <LINK REL="Next"  HREF="019679.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Reactor callback from the wrong thread</H1>
    <B>Lars Ivar Igesund</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Reactor%20callback%20from%20the%20wrong%20thread&In-Reply-To="
       TITLE="[Twisted-Python] Reactor callback from the wrong thread">larsivi at gmail.com
       </A><BR>
    <I>Wed May 27 09:08:49 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019675.html">[Twisted-Python] Twisted at UDS Karmic
</A></li>
        <LI>Next message: <A HREF="019679.html">[Twisted-Python] Reactor callback from the wrong thread
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19677">[ date ]</a>
              <a href="thread.html#19677">[ thread ]</a>
              <a href="subject.html#19677">[ subject ]</a>
              <a href="author.html#19677">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

I have an issue where the reactor calls the callback from a different
thread than the one the reactor is running in.

The usecase is as follows;

We are running tests using PyFit (Fitnesse), and where some of the
tests depends on receiving SNMP traps in the background. So at the
start we start a trap deamon defined as

class TrapDeamon(Thread, netsnmp.Session)

We use the pynetsnmp.twistedsnmp package and has a run() method that
looks like this

def run(self):
    self.awaitTraps(self.hostPort)
    twistedsnmp.updateReactor()
    reactor.run(installSignalHandlers=0)

In the callback from the reactor, we get the pdu of the trap which is
then sent into a trap buffer. On the PyFit side of things, we execute
some commands, and at some points we need a confirmation from a trap
before we can continue. This is done by waiting on a queue
(Queue.Queue). The trap buffer has a register over queues and awaited
trap OID's, and when the correct one is added to the buffer from the
reactor callback, it is put onto the queue, the test rejoice, and
continues.

However, I noticed that fairly often (say every 3rd wait), the wait
timed out even though I had seen the trap on wireshark. So I improved
the logging, and noticed that in the cases where the wait timed out,
the reactor callback for the trap I waited for happened in the main
thread (at least main thread id is reported by python logging), and
thus did not appear until immediately after the wait had failed and
unblocked. Most of the trap callbacks (both before and after these
misses) happens in the correct (reactor) thread though.

What can cause this and how may I debug it? AFAIK, PyFit does not use
twisted or threading at all, and we only have two simple background
threads our selves in addition to the one running the trap deamon.

Best regards,
Lars Ivar Igesund


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019675.html">[Twisted-Python] Twisted at UDS Karmic
</A></li>
	<LI>Next message: <A HREF="019679.html">[Twisted-Python] Reactor callback from the wrong thread
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19677">[ date ]</a>
              <a href="thread.html#19677">[ thread ]</a>
              <a href="subject.html#19677">[ subject ]</a>
              <a href="author.html#19677">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
