<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted plugins and py2exe
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted%20plugins%20and%20py2exe&In-Reply-To=20090224195505.12555.1349207332.divmod.xquotient.5060%40weber.divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019593.html">
   <LINK REL="Next"  HREF="019595.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted plugins and py2exe</H1>
    <B>Gabriel Rossetti</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted%20plugins%20and%20py2exe&In-Reply-To=20090224195505.12555.1349207332.divmod.xquotient.5060%40weber.divmod.com"
       TITLE="[Twisted-Python] Twisted plugins and py2exe">gabriel.rossetti at arimaz.com
       </A><BR>
    <I>Sun May 10 06:42:49 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019593.html">[Twisted-Python] Twisted plugins and py2exe
</A></li>
        <LI>Next message: <A HREF="019595.html">[Twisted-Python] help using deferred
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19594">[ date ]</a>
              <a href="thread.html#19594">[ thread ]</a>
              <a href="subject.html#19594">[ subject ]</a>
              <a href="author.html#19594">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>it would help if I attatched the patch :-)

<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A> wrote:
&gt;<i>
</I>&gt;<i> On 04:55 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A> wrote:
</I>&gt;&gt;<i> Tue, 24 Feb 2009 17:35:14 +0100, Gabriel Rossetti 
</I>&gt;&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">gabriel.rossetti at arimaz.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> Jean-Paul Calderone wrote:
</I>&gt;&gt;&gt;&gt;<i> On Tue, 24 Feb 2009 11:49:13 +0100, Gabriel Rossetti 
</I>&gt;&gt;&gt;&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">gabriel.rossetti at arimaz.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Has anyone ever had this problem while using plugins with Twisted 
</I>&gt;&gt;&gt;&gt;&gt;<i> and py2exe?
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> No, but from the traceback, it seems fairly clear that the plugin 
</I>&gt;&gt;&gt;&gt;<i> system
</I>&gt;&gt;&gt;&gt;<i> is trying to write a plugin cache file into your py2exe-created zip 
</I>&gt;&gt;&gt;&gt;<i> file
</I>&gt;&gt;&gt;&gt;<i> of Python source.
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> Ok, I could do this, teach it abot zip files and have it update it's 
</I>&gt;&gt;&gt;<i> cache in the zip file, but in certain cases, like mine actually, if 
</I>&gt;&gt;&gt;<i> you tell py2exe to include the zip file in the exec, then it won't 
</I>&gt;&gt;&gt;<i> work. How about adding the possibility to specify where the cache is 
</I>&gt;&gt;&gt;<i> to be written?
</I>&gt;<i>
</I>&gt;<i> This is almost certainly the wrong solution to your problem, but if 
</I>&gt;<i> you disagree with this assessment please feel free to update this ticket:
</I>&gt;<i>
</I>&gt;<i>    <A HREF="http://twistedmatrix.com/trac/ticket/3348">http://twistedmatrix.com/trac/ticket/3348</A>
</I>&gt;<i>
</I>&gt;<i> Several people have requested this feature and nobody has really made 
</I>&gt;<i> a good case for why it should be implemented.  (I don't think it 
</I>&gt;<i> should be, I just think we should record all the reasons why not on 
</I>&gt;<i> that ticket :)).
</I>&gt;&gt;<i> Updating the cache in the zip file probably isn't the right thing to do.
</I>&gt;&gt;<i> Just skipping cache generation would probably make more sense.  It 
</I>&gt;&gt;<i> should
</I>&gt;&gt;<i> be easier to implement, anyway.
</I>&gt;<i>
</I>&gt;<i> Skipping the cache generation is like skipping bytecode compilation. 
</I>&gt;<i> It's not a catastrophic error, everything should still work, but it 
</I>&gt;<i> will result in more unnecessary work being done at runtime.
</I>&gt;<i>
</I>&gt;<i> IMHO the right solution in this particular case would be to get py2exe 
</I>&gt;<i> (or some part of the setup process in py2exe, which I believe is 
</I>&gt;<i> implemented using distutils) to generate a cache file as part of the 
</I>&gt;<i> built zip file.  Presumably .pyc files are also created and included 
</I>&gt;<i> in the zip file.  The appropriate procedure for forcibly generating 
</I>&gt;<i> the cache is described here:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/projects/core/documentation/howto/plugin.html#auto3">http://twistedmatrix.com/projects/core/documentation/howto/plugin.html#auto3</A> 
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> A cache generated in this manner will be suitable for packaging into a 
</I>&gt;<i> zip file.
</I>Sorry for reviving this old thread now, but I found a way of doing it
with almost no modifications to the way things are currently done. I
just made twisted.python.zippath.ZipPath.open have the same signature as
twisted.python.filepath.FilePath (see my patch) and then added the
following to my py2exe setup file:

from py2exe.build_exe import py2exe as BuildExe
from twisted.plugin import getCache

class PluginCacheCollector(BuildExe):
    def copy_extensions(self, extensions):
        BuildExe.copy_extensions(self, extensions)

        # Import the plugin packages
        from mypackage.plugins.io import myioplugins
        from mypackage.plugins.misc import myotherplugins
        mods = [ myioplugins, myotherplugins ]

        for m in mods:

            # Pre-gen the plugin cache
            getCache(m)

            # Build the cache file's path in the build collect dir and
copy the cache files there
            f = os.path.join(*(m.__name__.split('.') + [&quot;dropin.cache&quot;]))
            full = os.path.join(self.collect_dir, f)
            self.copy_file(f, full)

            # Add the cache file path to the list of files to be added
to the py2exe zip file
            self.compiled_files.append(f)

and add this 'cmdclass={&quot;py2exe&quot;: PluginCacheCollector}' to setup() like so:

opts = {
    &quot;py2exe&quot;: {
        &quot;packages&quot;: [ &quot;mypackage&quot; ],
        &quot;includes&quot;: [ &quot;myincludes&quot; ],
        &quot;excludes&quot;: [ &quot;curses&quot;, &quot;Tkinter&quot;, &quot;Tkconstants&quot;, &quot;doctest&quot;,
&quot;pdb&quot;, &quot;unittest&quot;, &quot;difflib&quot;, &quot;pyreadline&quot;, &quot;optparse&quot;, &quot;calendar&quot;,
&quot;tcl&quot;, &quot;pywin.debugger&quot;, &quot;pywin.debugger.dbgcon&quot;,
                      &quot;pywin.dialogs&quot;, &quot;_gtkagg&quot;, &quot;_tkagg&quot; ],
        &quot;dll_excludes&quot;: [&quot;libgdk-win32-2.0-0.dll&quot;,
&quot;libgobject-2.0-0.dll&quot;, &quot;tcl84.dll&quot;, &quot;tk84.dll&quot;],
        &quot;dist_dir&quot;: &quot;dist&quot;,
        &quot;optimize&quot;: 2, # Use -OO when building (e.g. python -OO setup.py
py2exe)
        &quot;bundle_files&quot;: 1,
        &quot;compressed&quot;: True,
    }
}

setup(
    console=['mymain.py'],
    zipfile=&quot;library.zip&quot;,
    options=opts,
    data_files=[(&quot;icons&quot;, glob.glob(&quot;icons/*.*&quot;))],
    cmdclass={&quot;py2exe&quot;: PluginCacheCollector}, # &lt;----------- add this
    )

And that does the trick, it will generate the cache files and they will
be copied to the collect dir, then they will get added to the zip. What
do you think?

Gabriel
&gt;<i>
</I>&gt;<i> Another part of the solution would be to implement setContent on 
</I>&gt;<i> ZipPath.  However, there are still likely to be erroneous deployment 
</I>&gt;<i> scenarios where the ZipPath is not available for writing, just as an 
</I>&gt;<i> installation path is frequently not available for writing now.  So an 
</I>&gt;<i> initial implementation of setContent on ZipPath could just raise the 
</I>&gt;<i> same exception that an unwritable FilePath would, for consistency in 
</I>&gt;<i> error handling.
</I>&gt;<i>
</I>&gt;<i> For the issue of quieting the mostly-harmless error message now 
</I>&gt;<i> produced by a failure to write the cache file, see here:
</I>&gt;<i>
</I>&gt;<i>    <A HREF="http://twistedmatrix.com/trac/ticket/2409">http://twistedmatrix.com/trac/ticket/2409</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: zippath.py.patch
Type: text/x-diff
Size: 358 bytes
Desc: not available
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20090510/e480afba/attachment.patch">http://twistedmatrix.com/pipermail/twisted-python/attachments/20090510/e480afba/attachment.patch</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019593.html">[Twisted-Python] Twisted plugins and py2exe
</A></li>
	<LI>Next message: <A HREF="019595.html">[Twisted-Python] help using deferred
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19594">[ date ]</a>
              <a href="thread.html#19594">[ thread ]</a>
              <a href="subject.html#19594">[ subject ]</a>
              <a href="author.html#19594">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
