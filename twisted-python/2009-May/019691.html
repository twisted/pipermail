<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Reactor callback from the wrong thread
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Reactor%20callback%20from%20the%20wrong%20thread&In-Reply-To=20090527154322.21531.781574174.divmod.quotient.26327%40henry.divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019679.html">
   <LINK REL="Next"  HREF="019696.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Reactor callback from the wrong thread</H1>
    <B>Lars Ivar Igesund</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Reactor%20callback%20from%20the%20wrong%20thread&In-Reply-To=20090527154322.21531.781574174.divmod.quotient.26327%40henry.divmod.com"
       TITLE="[Twisted-Python] Reactor callback from the wrong thread">larsivi at gmail.com
       </A><BR>
    <I>Thu May 28 08:04:13 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019679.html">[Twisted-Python] Reactor callback from the wrong thread
</A></li>
        <LI>Next message: <A HREF="019696.html">[Twisted-Python] Reactor callback from the wrong thread
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19691">[ date ]</a>
              <a href="thread.html#19691">[ thread ]</a>
              <a href="subject.html#19691">[ subject ]</a>
              <a href="author.html#19691">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, thanks for the reply.

On Wed, May 27, 2009 at 5:43 PM, Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt; wrote:
&gt;<i> On Wed, 27 May 2009 15:08:49 +0200, Lars Ivar Igesund &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">larsivi at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>Hi!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I have an issue where the reactor calls the callback from a different
</I>&gt;&gt;<i>thread than the one the reactor is running in.
</I>&gt;<i>
</I>&gt;<i> Generally speaking, the only callbacks the reactor invokes are protocol
</I>&gt;<i> methods (like dataReceived and connectionLost) and timed events (things
</I>&gt;<i> you pass to reactor.callLater). &#160;It always calls these in the thread it
</I>&gt;<i> is running in. &#160;What callbacks are you seeing be invoked in the &quot;wrong&quot;
</I>&gt;<i> thread?
</I>
Sorry for being a bit unclear; these callbacks originates from the
SNMP trap listen agent which at the bottom is Net-SNMP wrapped in
Python and a protocol for Twisted (incorporated in pynetsnmp, package
python-pynetsnmp in Ubuntu/Debian).

&gt;<i>
</I>&gt;&gt;<i> [snip]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>What can cause this and how may I debug it? AFAIK, PyFit does not use
</I>&gt;&gt;<i>twisted or threading at all, and we only have two simple background
</I>&gt;&gt;<i>threads our selves in addition to the one running the trap deamon.
</I>&gt;<i>
</I>&gt;<i> The most likely explanation is that your code (perhaps by way of PyFit,
</I>&gt;<i> I'm not sure -- I've never used PyFit) is calling a Twisted API from a
</I>&gt;<i> thread other than the reactor thread. &#160;So, examine all the places you
</I>&gt;<i> call Twisted APIs (including APIs in twistedsnmp which may call Twisted
</I>&gt;<i> APIs) and make sure they're only run in the reactor thread.
</I>
Googling further, it appears that NetSNMP is not considered thread
safe, and this is probably the reason for my troubles (there are
normal netsnmp calls going the other way from the apparently hijacked
thread).

PyFit did not have any twisted dependencies, so I don't consider it an
option at this point.

I have also tested the alternative Twisted SNMP package (based on
PySNMP), but unfortunately both of those appear to mature enough for
our use.

At this point I'm probably left with two options; either make all of
the SNMP communication go via pynetsnmp (will cause at least some
rewriting), or move the trap deamon part into its own application that
communicates with the test framework via a sockets. The latter would
guarantee no snmp thread confusion, but may be a bit overkill.

If anyone has a good advice, then I'd appreciate it.

Thanks!


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019679.html">[Twisted-Python] Reactor callback from the wrong thread
</A></li>
	<LI>Next message: <A HREF="019696.html">[Twisted-Python] Reactor callback from the wrong thread
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19691">[ date ]</a>
              <a href="thread.html#19691">[ thread ]</a>
              <a href="subject.html#19691">[ subject ]</a>
              <a href="author.html#19691">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
