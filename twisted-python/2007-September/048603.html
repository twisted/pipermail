<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to stop reactor when execution finishes on	more than one ssh server?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20stop%20reactor%20when%20execution%20finishes%20on%0A%09more%20than%20one%20ssh%20server%3F&In-Reply-To=%3C20070929185429.8162.1242645935.divmod.quotient.15945%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="048602.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to stop reactor when execution finishes on	more than one ssh server?</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20stop%20reactor%20when%20execution%20finishes%20on%0A%09more%20than%20one%20ssh%20server%3F&In-Reply-To=%3C20070929185429.8162.1242645935.divmod.quotient.15945%40ohm%3E"
       TITLE="[Twisted-Python] How to stop reactor when execution finishes on	more than one ssh server?">exarkun at divmod.com
       </A><BR>
    <I>Sat Sep 29 12:54:29 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="048602.html">[Twisted-Python] How to stop reactor when execution finishes on	more than one ssh server?
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48603">[ date ]</a>
              <a href="thread.html#48603">[ thread ]</a>
              <a href="subject.html#48603">[ subject ]</a>
              <a href="author.html#48603">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 30 Sep 2007 01:08:52 +0800, James Deng &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jtdeng at gmail.com</A>&gt; wrote:
&gt;<i>Hi,
</I>&gt;<i>in the sample sshsimpleclient.py, it demostrated how to connect to a ssh
</I>&gt;<i>server and issue a command. my question is what should I do if I want to
</I>&gt;<i>connect to more than one ssh server.
</I>&gt;<i>
</I>&gt;<i>I did try to create more than one SimpleTransport by using the following
</I>&gt;<i>code
</I>&gt;<i>
</I>&gt;<i>HOSTS=[host1, host2, host3]
</I>&gt;<i>protocol.ClientCreator(reactor, SimpleTransport).connectTCP(host1, 22)
</I>&gt;<i>protocol.ClientCreator(reactor, SimpleTransport).connectTCP(host2, 22)
</I>&gt;<i>protocol.ClientCreator(reactor, SimpleTransport).connectTCP(host3, 22)
</I>&gt;<i>reactor.run()
</I>&gt;<i>
</I>&gt;<i>this really behaves as what i expected, and executed the command on all
</I>&gt;<i>remote hosts, but after it finishes, i just hangs there, I know I need a
</I>&gt;<i>place to call something like reactor.stop() when all transport finishes the
</I>&gt;<i>execution. but i do not know where to call it,  need some deffereds? and
</I>&gt;<i>how?
</I>
First, you need to know when a single connection is finished.  If what you
are interested in is a channel being closed, then the appropriate callback
is SSHChannel.closed, as sshsimpleclient.py demonstrates.

Then you need for that information to be relayed to the code which is
responsible for knowing that at some point the reactor should be stopped.
sshsimpleclient.py is not a good example of this, since with its approach
to this, when a CatChannel is disconnected, the reactor will always be
stopped.  This makes CatChannel inappropriate for use in any real program.
Instead, you may want to callback a Deferred in your closed implementation.
The Deferred might be one which was supplied to your channel's constructor
and was ultimately created by the same code which knows that the reactor
needs to be stopped.

Finally, you need to aggregate multiple Deferreds into one.  You can do this
using twisted.internet.defer.gatherResults, which takes a list of Deferreds
and returns a Deferred which will be called back when all of the inputs have
been called back.  You can pass the Deferred for each of your channels to
gatherResults and add a callback to the returned Deferred which stops the
reactor.

So, for example (not runnable):

    hosts = [host1, host2, host3]
    closedDeferreds = []
    for host in hosts:
        d = Deferred()
        closedDeferreds.append(d)
        ClientCreator(reactor, SimpleTransport, d).connectTCP(host, 22)
    gatherResults(closedDeferreds).addCallback(lambda ignored: reactor.stop())
    reactor.run()

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="048602.html">[Twisted-Python] How to stop reactor when execution finishes on	more than one ssh server?
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48603">[ date ]</a>
              <a href="thread.html#48603">[ thread ]</a>
              <a href="subject.html#48603">[ subject ]</a>
              <a href="author.html#48603">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
