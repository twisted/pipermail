<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] adbapi and ConnectionLost.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20adbapi%20and%20ConnectionLost.&In-Reply-To=%3C496CFA6D.2040800%402le.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051525.html">
   <LINK REL="Next"  HREF="051541.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] adbapi and ConnectionLost.</H1>
    <B>Sébastien HEITZMANN</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20adbapi%20and%20ConnectionLost.&In-Reply-To=%3C496CFA6D.2040800%402le.net%3E"
       TITLE="[Twisted-Python] adbapi and ConnectionLost.">2le at 2le.net
       </A><BR>
    <I>Tue Jan 13 13:32:45 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051525.html">[Twisted-Python] IPushProducer problem
</A></li>
        <LI>Next message (by thread): <A HREF="051541.html">[Twisted-Python] Re: adbapi and ConnectionLost.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51518">[ date ]</a>
              <a href="thread.html#51518">[ thread ]</a>
              <a href="subject.html#51518">[ subject ]</a>
              <a href="author.html#51518">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

for a couple of week i search how i should handle mysql disconnection on
my twisted web service. When I restart the database without restarting
my service i got some ConnectionLost fired. I have used the cp_reconnect
on the connection pool and it seem to work ( the lost connection is
restarted ) but the current query isn't executed.

So my question is how should I handle this case. Should I intercept the
connectionLost and restart the query ? I have several queries in a
single deffer so this method is not easy and clear.

Any advice whould be welcome.

I join the code of a sample resource.

Thanks

Sébastien HEITZMANN


class StartResource(resource.Resource):
    def __init__(self, dbConnection, mdbConnection, config):
        self.db = dbConnection
        self.mdb = mdbConnection
        resource.Resource.__init__(self)

    def render_POST(self, request):
        try:
            uid = request.args['uid'][0]
            key = request.args['kkey'][0]
            conf = unicode(request.args['conf'][0],'utf8')
            self.db.runInteraction(self._start, uid, key, conf, request)
            return server.NOT_DONE_YET
        except Exception, e:
            print str(e)
            request.setResponseCode(http.INTERNAL_SERVER_ERROR, str(e))
            request.write('ERROR:'+str(e))
            request.finish()

    def _start(self, trans, uid, key, conf, request):
        try:
            if not utils.checkKKEY(uid, key, trans):
                r_status = 'ko'
                r_action = ''
                r_params = 'kkey invalid'
                request.write(json.write([r_status, r_action, r_params]))
                request.finish()
                return None

            query = &quot;UPDATE kserver.b set status=-1 where status=0 and
uid=%s&quot;
            query %= (str(uid))
            trans.execute(query)

            query = u&quot;INSERT INTO `b` (uid, conf)&quot;
            query += &quot; VALUES(%s, '%s');&quot; % ( str(uid), dbutil.safe(conf) )
            trans.execute(query)
            bid = trans._cursor.connection.insert_id()
            #trans.commit()
            r_status = 'ok'
            r_action = ''
            r_params = {'bid':str(bid)}
            request.write(json.write([r_status, r_action, r_params]))
            request.finish()
        except Exception, e:
            print str(e)
            request.setResponseCode(http.INTERNAL_SERVER_ERROR, str(e))
            request.write('ERROR:'+str(e))
            request.finish()




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051525.html">[Twisted-Python] IPushProducer problem
</A></li>
	<LI>Next message (by thread): <A HREF="051541.html">[Twisted-Python] Re: adbapi and ConnectionLost.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51518">[ date ]</a>
              <a href="thread.html#51518">[ thread ]</a>
              <a href="subject.html#51518">[ subject ]</a>
              <a href="author.html#51518">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
