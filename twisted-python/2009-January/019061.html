<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] pb: callRemotes execute serially on server-side
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20pb%3A%20callRemotes%20execute%20serially%20on%20server-side&In-Reply-To=a399cf060901191042q1a1f05fflfc35c99ba05cad2e%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019060.html">
   <LINK REL="Next"  HREF="019063.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] pb: callRemotes execute serially on server-side</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20pb%3A%20callRemotes%20execute%20serially%20on%20server-side&In-Reply-To=a399cf060901191042q1a1f05fflfc35c99ba05cad2e%40mail.gmail.com"
       TITLE="[Twisted-Python] pb: callRemotes execute serially on server-side">exarkun at divmod.com
       </A><BR>
    <I>Mon Jan 19 15:36:11 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019060.html">[Twisted-Python] pb: callRemotes execute serially on server-side
</A></li>
        <LI>Next message: <A HREF="019063.html">[Twisted-Python] high server loads on FreeBSD - does kqueue reactor	help?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19061">[ date ]</a>
              <a href="thread.html#19061">[ thread ]</a>
              <a href="subject.html#19061">[ subject ]</a>
              <a href="author.html#19061">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 19 Jan 2009 13:42:14 -0500, David Karnowski &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dkarnows at gmail.com</A>&gt; wrote:
&gt;<i>Hi all,
</I>&gt;<i>
</I>&gt;<i>I'm having a client-side pb app call the same server-side function 10
</I>&gt;<i>times with this client-side code:
</I>&gt;<i>
</I>&gt;<i> def process_test(rootObject):
</I>&gt;<i>     for i in range(10):
</I>&gt;<i>         _logger.debug(&quot;Calling remote with arg: %d&quot; % (i))
</I>&gt;<i>         deferred = rootObject.callRemote(&quot;test_it&quot;, i)
</I>&gt;<i>         deferred.addCallbacks(success, problem,
</I>&gt;<i>callbackKeywords={'i': i}, errbackKeywords={'i': i})
</I>&gt;<i>
</I>&gt;<i>The server-side &quot;remote_test_it&quot; function takes 5 seconds to complete
</I>&gt;<i>(per call). I find the following. The first point is what I'd expect,
</I>&gt;<i>but points 2 &amp; 3 are not:
</I>&gt;<i>
</I>&gt;<i>1) The above for-loop completes asynchronously, with no blocking. It's
</I>&gt;<i>complete in a few-thousand milliseconds.
</I>&gt;<i>2) The server-side executes serially. The second client-side call to
</I>&gt;<i>&quot;remote_test_it&quot; doesn't start executing &quot;test_it&quot; on the server-side
</I>&gt;<i>until after the first call has finished. I'd have thought these 10
</I>&gt;<i>calls would occur in parallel (in separate server-side threads). No?
</I>&gt;<i>3) None of the callbacks you see in the above client-side for-loop get
</I>&gt;<i>executed until ALL 10 callRemotes have finished on the server-side.
</I>&gt;<i>e.g. the callRemote for the first loop iteration finishes on the
</I>&gt;<i>server-side in 5 seconds, but the associated client-side callback
</I>&gt;<i>isn't executed until after 50 seconds (after the 10th loop iteration's
</I>&gt;<i>server-side call finishes).
</I>&gt;<i>
</I>&gt;<i>I'm just starting with Twisted. Are points 2 &amp; 3 expected, and is
</I>&gt;<i>there a way for me to have them run in parallel rather than serially?
</I>
Twisted is based on &quot;cooperative multitasking&quot; - not preemptive
multithreading.  If you have a task which will take ten seconds
to complete, then you have several options:

  * Just let it take ten seconds.  Since there is no preemption, no
    events will be serviced until the task has finished (ie, for 10
    seconds).  This means you will have serial processing, rather
    than parallel.  This is what you're seeing now.

  * Bring preemptive multithreading into the picture.  Explicitly run
    the task in a thread.  This is probably what you were expecting to
    happen automatically, but it doesn't.  Fortunately, it's quite easy
    to do this - see twisted.internet.threads.deferToThread for the most
    basic (and usually adequate) solution.  You will end up with a Deferred
    which PB knows how to interact with (just return it from your remote_
    method).

  * Convert the implementation of your 10 second task into an asynchronous
    version without using preemptive multithreading.  If your task is CPU
    bound, this may not be suitable (but you might want to consider running
    it in another process rather than another thread, depending on what
    hardware you have available and other concerns).  However, if you're
    waiting for 10 seconds for an HTTP request to complete, then you should
    use some Twisted facility to do the slow network I/O asynchronously
    than blocking on it.  Depending on the network protocol being used, you
    may find a nice high-level asynchronous API somewhere in Twisted, or you
    may need to implement something yourself.

Hope this helps,

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019060.html">[Twisted-Python] pb: callRemotes execute serially on server-side
</A></li>
	<LI>Next message: <A HREF="019063.html">[Twisted-Python] high server loads on FreeBSD - does kqueue reactor	help?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19061">[ date ]</a>
              <a href="thread.html#19061">[ thread ]</a>
              <a href="subject.html#19061">[ subject ]</a>
              <a href="author.html#19061">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
