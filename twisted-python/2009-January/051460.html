<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Best place to put application code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Best%20place%20to%20put%20application%20code&In-Reply-To=%3Cfaf2d7810901030316m6da00d34v4217385d475c1ec0%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051529.html">
   <LINK REL="Next"  HREF="051458.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Best place to put application code</H1>
    <B>John Aherne</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Best%20place%20to%20put%20application%20code&In-Reply-To=%3Cfaf2d7810901030316m6da00d34v4217385d475c1ec0%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Best place to put application code">johnaherne at rocs.co.uk
       </A><BR>
    <I>Sat Jan  3 04:16:41 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051529.html">[Twisted-Python] [Q] multi-process chat client and poller
</A></li>
        <LI>Next message (by thread): <A HREF="051458.html">[Twisted-Python] Best place to put application code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51460">[ date ]</a>
              <a href="thread.html#51460">[ thread ]</a>
              <a href="subject.html#51460">[ subject ]</a>
              <a href="author.html#51460">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the reply.
Very helpful. despite the question being like 'How long is a piece of
string'.

It's good to just hear what someone else reckons is the way to structure the
code.

I like the code sample.It makes clearer what some of my options are. So I'll
have a look and see how I can make use of it.

Thanks once again.

John Aherne



On Fri, Jan 2, 2009 at 3:59 PM, Jean-Paul Calderone &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt;wrote:

&gt;<i> On Fri, 2 Jan 2009 10:14:40 +0000, John Aherne &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> One thing that has been puzzling me is where is the best place to put
</I>&gt;&gt;<i> application code.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It depends. :)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> The case I am using is straightforward TCP server with client connections
</I>&gt;&gt;<i> making simple requests and waiting for responses retrieved from database
</I>&gt;&gt;<i> tables to be sent back.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Reading the docs and looking at various examples provided in books and
</I>&gt;&gt;<i> documentation has left me a bit confused.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there a best practice for where application code should go - either the
</I>&gt;&gt;<i> protcocol class or the factory class or somewhere else. Does it actually
</I>&gt;&gt;<i> matter.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there any downside to putting application code in the protocol or
</I>&gt;&gt;<i> factory. What pitfalls are there for either approach.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Best practice for a Protocol class is to include code which is necessary
</I>&gt;<i> to interpret bytes which are received and turn them into a structured form
</I>&gt;<i> which is easier to deal with; code which starts from some structured form
</I>&gt;<i> and emits bytes to be sent should also be part of a Protocol class.
</I>&gt;<i>
</I>&gt;<i> It is common practice to have a class which includes just these things and
</I>&gt;<i> then a subclass which adds application-specific logic based on top of this
</I>&gt;<i> functionality.  It is also common practice to connect a protocol which has
</I>&gt;<i> only these things, no application-specific code, and then have application
</I>&gt;<i> code elsewhere (in a free function, a method of a factory, another class's
</I>&gt;<i> method, user input, etc) make calls onto it.  Which of these approaches is
</I>&gt;<i> most well suited to a particular application depends.  For example, if the
</I>&gt;<i> application code creates multiple connections with shared state adding the
</I>&gt;<i> application logic to a Protocol subclass isn't a good approach.
</I>&gt;<i>
</I>&gt;<i>  I see examples where application code appears in both classes, but the
</I>&gt;&gt;<i> examples are very small so may not be indicative of what should be done.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Generally they're so small that there's no advantage to any approach over
</I>&gt;<i> any other, yes.
</I>&gt;<i>
</I>&gt;<i>  In the docs I see reference to most of the code will be written in the
</I>&gt;&gt;<i> protocol class, but that seems to be referring to actually writing
</I>&gt;&gt;<i> protocols
</I>&gt;&gt;<i> not application code. It also says that when the protocol needs to call
</I>&gt;&gt;<i> application code to make it a method call -  not to mix protocol and
</I>&gt;&gt;<i> application code. This could just mean creating some methods in the
</I>&gt;&gt;<i> protocol
</I>&gt;&gt;<i> class to handle the task.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Consider all of the code you write to be part of a library you're
</I>&gt;<i> developing.
</I>&gt;<i> If you implement a protocol, then you've just written part of a library
</I>&gt;<i> which
</I>&gt;<i> provides a slightly higher-level API for interacting with the network in
</I>&gt;<i> some
</I>&gt;<i> way.  With that in hand, you can move on to some other part of your library
</I>&gt;<i> which uses that higher-level API to accomplish something even higher-level,
</I>&gt;<i> perhaps presenting yet another API to some other part of your application
</I>&gt;<i> which is higher-level still.  The motivation to not mix protocol and
</I>&gt;<i> application code is just the motivation to have clear boundaries in your
</I>&gt;<i> library to make as much of it reusable as possible.  If you have a protocol
</I>&gt;<i> implementation mixed together with application A, when you come along to
</I>&gt;<i> write application B which needs to use the same protocol, you'll have to
</I>&gt;<i> re-implement the protocol, or refactor your original implementation to move
</I>&gt;<i> the application A code elsewhere (of course, there's nothing wrong with
</I>&gt;<i> having to refactor your code - it's a common part of programming, and since
</I>&gt;<i> it's very difficult to predict the future, it's often best *not* to try to
</I>&gt;<i> anticipate your future requirements when writing code - just write what
</I>&gt;<i> works
</I>&gt;<i> and is easily testable, and when your future requirements come along, deal
</I>&gt;<i> with them then; as you do this more and more, you'll probably get a sense
</I>&gt;<i> of
</I>&gt;<i> how to structure your code to minimize the effort required for refactoring,
</I>&gt;<i> but aside from experience with this process, I don't know of any way to
</I>&gt;<i> learn
</I>&gt;<i> this skill).
</I>&gt;<i>
</I>&gt;<i>  However, if the application code needs to run for 10-12 seconds looking up
</I>&gt;&gt;<i> database tables and accumulating results and waiting on  deferreds, should
</I>&gt;&gt;<i> all this code reside in the protocol class or the factory.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I wouldn't take the duration of the task into consideration when trying to
</I>&gt;<i> decide where to put it.  I'd consider reusability, testability, simplicity,
</I>&gt;<i> and correctness.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> If I keep it in the protocol, then I already have my client connection to
</I>&gt;&gt;<i> write back to. So that seems to be the place to keep the code.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I put the code in the factory, then I need to pass the client
</I>&gt;&gt;<i> connection
</I>&gt;&gt;<i> so it can write back to the client. Or is there another way of doing this
</I>&gt;&gt;<i> I
</I>&gt;&gt;<i> have missed.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This isn't much different from the trade-off you have to consider when you
</I>&gt;<i> decide to implement anything as two classes instead of one.  Since you can
</I>&gt;<i> no longer just use `selfÂ´ everywhere, you'll have to figure out how to get
</I>&gt;<i> a reference to the other instance that you need sometimes.  This shouldn't
</I>&gt;<i> be difficult though - just invoke a method on one class with an instance of
</I>&gt;<i> the other.
</I>&gt;<i>
</I>&gt;<i>  .
</I>&gt;&gt;<i> The factory seems to be the place where other classes can be passed in and
</I>&gt;&gt;<i> the protocol can call them via self.factory. That seems to imply that
</I>&gt;&gt;<i> application code should be put into the factory, but I can't see any way
</I>&gt;&gt;<i> of
</I>&gt;&gt;<i> passing back information from deferred results to the call from protocol.
</I>&gt;&gt;<i> It's ok if it was just a simple method call that returns a result, but if
</I>&gt;&gt;<i> the code has to run a series of deferreds then it will be the called
</I>&gt;&gt;<i> method
</I>&gt;&gt;<i> that will have the result and it will need a means of writing this back to
</I>&gt;&gt;<i> the client. I don't think I can signal the protocol to say I now have the
</I>&gt;&gt;<i> result.Of course I could easily be mistaken. So please correct.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This is just what Deferreds are for.  For example, let's consider a
</I>&gt;<i> protocol
</I>&gt;<i> and factory for a game server lobby.  The protocol has a message type which
</I>&gt;<i> lets the server inform the client of the list of games which are currently
</I>&gt;<i> available to be joined.  The Protocol subclass sends this information to
</I>&gt;<i> the client when the connection is established, but it uses the factory
</I>&gt;<i> to actually find the list of games that are available.  Again, this
</I>&gt;<i> division is probably desirable for a number of reasons (it simplifies
</I>&gt;<i> unit testing, for example).
</I>&gt;<i>
</I>&gt;<i> class GameFactory(ServerFactory):
</I>&gt;<i>   def availableGames(self):
</I>&gt;<i>       &quot;&quot;&quot;
</I>&gt;<i>       Return a Deferred which will fire with a list of the games
</I>&gt;<i>       currently available to be joined.
</I>&gt;<i>       &quot;&quot;&quot;
</I>&gt;<i>       return self.connectionPool.runQuery(
</I>&gt;<i>           &quot;SELECT game_id FROM available_games&quot;)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class GameProtocol(Protocol):
</I>&gt;<i>   def connectionMade(self):
</I>&gt;<i>       &quot;&quot;&quot;
</I>&gt;<i>       Send the available-games message so the client can pick one to
</I>&gt;<i>       join.
</I>&gt;<i>       &quot;&quot;&quot;
</I>&gt;<i>       d = self.factory.availableGames()
</I>&gt;<i>       def cbGotGames(games):
</I>&gt;<i>           self.transport.write(&quot; &quot;.join(games))
</I>&gt;<i>       d.addCallback(cbGotGames)
</I>&gt;<i>       d.addErrback(log.err)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Of course if I passs the client connection to the factory, then it can use
</I>&gt;&gt;<i> this to write back. But that means passing around the client connection.
</I>&gt;&gt;<i> Should I avoid doing that or is that not a problem.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It's an option, but I hope the above example will show how you can use
</I>&gt;<i> Deferreds to avoid needing to do this.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I hope I have explained myself clearly. I'm just looking for some guidance
</I>&gt;&gt;<i> and pointers to what is best to do or what is best to avoid.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Hope this helps,
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20090103/b8500549/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051529.html">[Twisted-Python] [Q] multi-process chat client and poller
</A></li>
	<LI>Next message (by thread): <A HREF="051458.html">[Twisted-Python] Best place to put application code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51460">[ date ]</a>
              <a href="thread.html#51460">[ thread ]</a>
              <a href="subject.html#51460">[ subject ]</a>
              <a href="author.html#51460">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
