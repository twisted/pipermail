<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Perspective broker and inlineCallbacks exception	handling problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Perspective%20broker%20and%20inlineCallbacks%20exception%0A%09handling%20problem&In-Reply-To=%3C18786.16415.15492.53811%40jon.es%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051472.html">
   <LINK REL="Next"  HREF="051477.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Perspective broker and inlineCallbacks exception	handling problem</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Perspective%20broker%20and%20inlineCallbacks%20exception%0A%09handling%20problem&In-Reply-To=%3C18786.16415.15492.53811%40jon.es%3E"
       TITLE="[Twisted-Python] Perspective broker and inlineCallbacks exception	handling problem">terry at jon.es
       </A><BR>
    <I>Mon Jan  5 10:15:11 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051472.html">[Twisted-Python] Perspective broker and inlineCallbacks exception	handling problem
</A></li>
        <LI>Next message (by thread): <A HREF="051477.html">[Twisted-Python] Perspective broker and inlineCallbacks exception	handling problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51474">[ date ]</a>
              <a href="thread.html#51474">[ thread ]</a>
              <a href="subject.html#51474">[ subject ]</a>
              <a href="author.html#51474">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Maik

I'm not an expert on inlineCallbacks, but I know enough to give something
of an answer.

&gt;<i> I am developing a basic client/server application based on twisted.
</I>&gt;<i> For communication purposes I am using perspective broker. I have
</I>&gt;<i> problems with inlineCallbacks and remotely raised errors:
</I>&gt;<i> 
</I>&gt;<i> My client code looks like this (pseudo code):
</I>&gt;<i> 
</I>&gt;<i> class Client:
</I>&gt;<i>   @defer.inlineCallbacks
</I>&gt;<i>   def login(self, prms):
</I>&gt;<i>     self.factory = pb.PBClientFactory()
</I>&gt;<i>     reactor.connect(host, port)
</I>&gt;<i>     self.perspective = yield self.factory.login()
</I>&gt;<i>     self.services = yield self.perspective.callRemote('getClientServices')
</I>&gt;<i> 
</I>&gt;<i> When using this class in application, I want to handle errors raised remotely:
</I>&gt;<i> 
</I>&gt;<i> @defer.inlineCallbacks
</I>&gt;<i> def main():
</I>&gt;<i>   client = Client()
</I>&gt;<i>   try:
</I>&gt;<i>     yield client.login(prms)
</I>&gt;<i>   except Exception, e:
</I>&gt;<i>     print 'Handled exception:', e
</I>&gt;<i> 
</I>&gt;<i> However, no matter what is raised on remote side, except block is
</I>&gt;<i> never used.
</I>
The first thing to say is that you shouldn't send us pseudo code. It will
help you understand what's going on if you write a small example and play
with it. And that will help us help you because we'll be able to see
exactly what's going on and run your code ourselves.

Without a real example, it's hard to give a concrete answer. There are
quite a few subtleties involved in using inlineCallbacks, and you're using
it twice.

Below is some working code that has something like the calling pattern you
seem to be trying to set up. If I cause _login to raise an exception, it IS
propagated all the way back to the except Exception clause.


&gt;<i> But if I change the code to plain except, exception is handled:
</I>&gt;<i> 
</I>&gt;<i> @defer.inlineCallbacks
</I>&gt;<i> def main():
</I>&gt;<i>   client = Client()
</I>&gt;<i>   try:
</I>&gt;<i>     client.login(prms)
</I>&gt;<i>   except:
</I>&gt;<i>     print 'Some error occurred'
</I>
Note that in the above snippet, you're using inlineCallbacks but you're not
yielding anything. If you try calling this main() function, it will give
you an exception: Failure instance: Traceback: &lt;type
'exceptions.AttributeError'&gt;: 'NoneType' object has no attribute 'send'

That's just an example of the subtleties (and it's not so sublte in this
case), and underlines why you should send us real code.

Are you actually trying to call main()?


&gt;<i> If I rewrite this function using classic deferred style, it works as
</I>&gt;<i> excepted (prints error with the correct type):
</I>&gt;<i> 
</I>&gt;<i> def eb_failure(failure):
</I>&gt;<i>   print type(failure), failure
</I>&gt;<i> 
</I>&gt;<i> def cb_success(result):
</I>&gt;<i>   print 'OK', result
</I>&gt;<i> 
</I>&gt;<i> def main():
</I>&gt;<i>   client = Client()
</I>&gt;<i>   d = client.login(prms)
</I>&gt;<i>   d.addCallbacks(cb_success, eb_failure)
</I>
Right. But that code is very different from what's going on behind the
scenes when you use inlineCallbacks.

&gt;<i> I am purposely raising errors derived from pb.Error. Using the
</I>&gt;<i> inlineCallbacks version I can only inspect remote errors with
</I>&gt;<i> sys.exc_info(), and that results in a plain string object, which
</I>&gt;<i> includes the classname of the original error like
</I>&gt;<i> 'myerror.MyAuthenticationError'
</I>
How do you raise the error? Let's see the code.

&gt;<i> What am I doing wrong? Is there a way to resolve this?
</I>
Sure. But we need to know more first.

Below is some code that might be useful.  It's also worth trying to figure
out how inlineCallbacks does its magic.

Terry

---

#!/usr/bin/python

from twisted.internet import defer, reactor

def _login(d):
    try:
        hello
    except Exception:
        d.errback()
    else:
        d.callback(True)

def login():
    d = defer.Deferred()
    reactor.callLater(1, _login, d)
    return d

class Client:
    @defer.inlineCallbacks
    def login(self, prms):
        yield login()

@defer.inlineCallbacks
def main():
    client = Client()
    try:
        yield client.login(33)
    except Exception, e:
        print 'Handled exception:', e

def ok(result):
    print &quot;ok&quot;, result

def nok(failure):
    print &quot;nok&quot;, failure

def stop(_):
    reactor.stop()

def go():
    x = main()
    x.addCallback(ok)
    x.addErrback(nok)
    x.addBoth(stop)

if __name__ == '__main__':
    reactor.callLater(0, go)
    reactor.run()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051472.html">[Twisted-Python] Perspective broker and inlineCallbacks exception	handling problem
</A></li>
	<LI>Next message (by thread): <A HREF="051477.html">[Twisted-Python] Perspective broker and inlineCallbacks exception	handling problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51474">[ date ]</a>
              <a href="thread.html#51474">[ thread ]</a>
              <a href="subject.html#51474">[ subject ]</a>
              <a href="author.html#51474">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
