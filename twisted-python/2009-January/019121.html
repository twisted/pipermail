<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] New C++ implementation of Deferreds
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20New%20C%2B%2B%20implementation%20of%20Deferreds&In-Reply-To=1233302940.4190.1297566749%40webmail.messagingengine.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019120.html">
   <LINK REL="Next"  HREF="019122.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] New C++ implementation of Deferreds</H1>
    <B>Tom Cocagne</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20New%20C%2B%2B%20implementation%20of%20Deferreds&In-Reply-To=1233302940.4190.1297566749%40webmail.messagingengine.com"
       TITLE="[Twisted-Python] New C++ implementation of Deferreds">tom.cocagne at gmail.com
       </A><BR>
    <I>Fri Jan 30 12:22:15 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019120.html">[Twisted-Python] New C++ implementation of Deferreds
</A></li>
        <LI>Next message: <A HREF="019122.html">[Twisted-Python] How can I disconnect ssl connection from the	client side?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19121">[ date ]</a>
              <a href="thread.html#19121">[ thread ]</a>
              <a href="subject.html#19121">[ subject ]</a>
              <a href="author.html#19121">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>    The C++ library is completely independent of Python and Twisted but it
can be made to work with them. One of the initial uses of it, in fact, was
to run a Python interpreter (using Twisted) in a dedicated C++ thread and
use it to direct the actions of all the other threads in the process.

    The way I did it is this:

    1. Spawn a C++ thread to run the Python interpreter inside of. All use
of the Python C-API must be done from within this thread if you want to
avoid dealing with the Global Interpreter Lock (remember Python itself is a
single-threaded application). Other C++ threads needing to call a Python
C-API function can do so using a DeferredCommand object that wraps the call
they want to make. Hand this object to the Python thread for execution and
use the Deferred mechanism to get the answer back to the original
thread..... Basically, you turn the interpreter into one big Active Object
as per the standard design pattern.

    2. Use the Python C-API to import a Python module you wrote that will
initialize Twisted and create a pair of TCP sockets that are connected to
each other. Then use the C-API to get the OS-level file descriptor to one of
the sockets. The purpose of this is to provide a mechanism for other C++
threads to inform the Twisted reactor that there's something in the C++
world it needs to do. When one of those DeferredCommands in step one is
given to the Python thread, the last thing the delivering thread needs to do
is call a function that writes a single byte to the TCP socket. This will
cause the Twisted reactor in the Python thread to wake up from it's 'select'
call and dispatch a handler. This handler can then execute a C++ function
you registered with the C-API. Once back in the C++ world and in the context
of the Python thread,  you can dispatch any of the DeferredCommands sitting
in the thread's queue.

    I don't currently have a mechanism for tying a Twisted Deferred directly
to one of the C++ deferreds since I haven't yet found a use-case where it
makes sense to do so. It's probably possible though.

    As for using the C++ deferreds with boost's asio... I haven't used asio
yet but a quick read through the API makes it looks like an almost perfect
match for these deferreds. In fact, I'd like to eventually put this code up
for consideration by the boost community for eventually including something
like it in boost. I *highly* doubt they'd want to use the code I've written
but it might serve as a good proof-of-concept at least.

    Tom

On Fri, Jan 30, 2009 at 12:09 AM, V S P &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">toreason at fastmail.fm</A>&gt; wrote:

&gt;<i> Hi, this is very interesting
</I>&gt;<i> ( am I currently testing out C++ web server (using boost asio) called
</I>&gt;<i> pion
</I>&gt;<i> to see if can suit my needs (it is a multi-threaded async IO generic
</I>&gt;<i> server and boost asio uses the best async APIs for each OS (including
</I>&gt;<i> kques for freebsd for example).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I looked at the example threads.cpp -- but could not figure out -- how
</I>&gt;<i> would it integrate with Twisted ?
</I>&gt;<i>
</I>&gt;<i> thanks
</I>&gt;<i>
</I>&gt;<i> On Thu, 29 Jan 2009 12:21:36 -0800, &quot;Tom Cocagne&quot;
</I>&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">tom.cocagne at gmail.com</A>&gt; said:
</I>&gt;<i> &gt;     The question of whether anyone had developed a C++ implementation of
</I>&gt;<i> &gt; Twisted's Deferreds has cropped up on this list several times over the
</I>&gt;<i> &gt; last
</I>&gt;<i> &gt; few years. To date, I've unfortunately been forced to sit on an
</I>&gt;<i> &gt; implementation I developed several years ago for the Department of
</I>&gt;<i> &gt; Defense.
</I>&gt;<i> &gt; Due to some rather draconian IP &amp; security policies, it's taken an
</I>&gt;<i> &gt; exceptionally long time to get the code released. I'm happy to announce
</I>&gt;<i> &gt; though that I finally managed to obtain release authorization for it and
</I>&gt;<i> &gt; that the code now has a new home on Sourceforge.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     As C++ has differing language features, the API of the C++ deferreds
</I>&gt;<i> &gt; isn't identical to those of Twisted's but most of the key concepts mapped
</I>&gt;<i> &gt; over pretty well. Additionally, this implementation has a few design
</I>&gt;<i> &gt; extensions to facilitate the development multi-threaded C++ applications.
</I>&gt;<i> &gt; The multi-threaded aspect grew almost accidentally out of the original
</I>&gt;<i> &gt; single-threaded design but, since then, it has proven to be
</I>&gt;<i> &gt; extraordinarily
</I>&gt;<i> &gt; useful for simplifying several multi-threaded applications I've worked
</I>&gt;<i> &gt; on.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     The implementation of the library is, however, rather complex. In
</I>&gt;<i> &gt;     large
</I>&gt;<i> &gt; part, this is due to the effort required to work around the inherent
</I>&gt;<i> &gt; inflexibility of the C++ type system. The Function, Bind, and
</I>&gt;<i> &gt; Meta-Programming libraries found in Boost have gone a long way towards
</I>&gt;<i> &gt; simplify the implementation though (my original Loki-based attempt was
</I>&gt;<i> &gt; almost incomprehensible even to me ;-). The library is fully documented
</I>&gt;<i> &gt; though so as long as you're reasonably comfortable with C++ templates, it
</I>&gt;<i> &gt; should be understandable.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     So far, the library has only been exposed to a handful of individuals
</I>&gt;<i> &gt; for review. I'd be interested to hear the comments anyone has about the
</I>&gt;<i> &gt; design and/or implementation approach. The code is available at:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;         <A HREF="http://deferred.svn.sourceforge.net/viewvc/deferred/">http://deferred.svn.sourceforge.net/viewvc/deferred/</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Cheers,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Tom
</I>&gt;<i> --
</I>&gt;<i>  V S P
</I>&gt;<i>  <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">toreason at fastmail.fm</A>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> <A HREF="http://www.fastmail.fm">http://www.fastmail.fm</A> - Accessible with your email software
</I>&gt;<i>                          or over the web
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20090130/fe302cc7/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20090130/fe302cc7/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019120.html">[Twisted-Python] New C++ implementation of Deferreds
</A></li>
	<LI>Next message: <A HREF="019122.html">[Twisted-Python] How can I disconnect ssl connection from the	client side?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19121">[ date ]</a>
              <a href="thread.html#19121">[ thread ]</a>
              <a href="subject.html#19121">[ subject ]</a>
              <a href="author.html#19121">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
