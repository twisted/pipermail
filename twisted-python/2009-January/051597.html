<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] RE: Write into a persistent connection befor	estopping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20RE%3A%20Write%20into%20a%20persistent%20connection%20befor%0A%09estopping&In-Reply-To=%3C050AD9702349384DADA9CD2480053669025087F8%40SMFIDF806A.main.fr.ds.corp%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051593.html">
   <LINK REL="Next"  HREF="051598.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] RE: Write into a persistent connection befor	estopping</H1>
    <B>Boeuf, Jean-Francois</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20RE%3A%20Write%20into%20a%20persistent%20connection%20befor%0A%09estopping&In-Reply-To=%3C050AD9702349384DADA9CD2480053669025087F8%40SMFIDF806A.main.fr.ds.corp%3E"
       TITLE="[Twisted-Python] RE: Write into a persistent connection befor	estopping">jean-francois.boeuf at eads.com
       </A><BR>
    <I>Mon Jan 26 09:07:23 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051593.html">[Twisted-Python] RE: Write into a persistent connection before	stopping
</A></li>
        <LI>Next message (by thread): <A HREF="051598.html">[Twisted-Python] RE: Write into a persistent connection befor	estopping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51597">[ date ]</a>
              <a href="thread.html#51597">[ thread ]</a>
              <a href="subject.html#51597">[ subject ]</a>
              <a href="author.html#51597">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> 

&gt;<i> -----Message d'origine-----
</I>&gt;<i> De : <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> 
</I>&gt;<i> [mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] De la part 
</I>&gt;<i> de Jean-Paul Calderone
</I>&gt;<i> Envoyé : lundi 26 janvier 2009 16:23
</I>&gt;<i> À : Twisted general discussion
</I>&gt;<i> Objet : Re: [Twisted-Python] RE: Write into a persistent 
</I>&gt;<i> connection beforestopping
</I>&gt;<i> 
</I>&gt;<i> On Mon, 26 Jan 2009 16:12:57 +0100, &quot;Boeuf, Jean-Francois&quot; 
</I>&gt;<i> &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jean-francois.boeuf at eads.com</A>&gt; wrote:
</I>&gt;<i> &gt;Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;As i didn't get any answer to my problem i writed a little 
</I>&gt;<i> test code to 
</I>&gt;<i> &gt;reproduce it (I can't divulgate the production code, and 
</I>&gt;<i> then it would 
</I>&gt;<i> &gt;be to much complicated to expose the matter). You can just 
</I>&gt;<i> run it using 
</I>&gt;<i> &gt;twistd -y test.py and then connect to the 8080 tcp port with 
</I>&gt;<i> a browser. 
</I>&gt;<i> &gt;As we can see in the browser the connection is active and 
</I>&gt;<i> periodicaly 
</I>&gt;<i> &gt;writed. The logs indicate that the conections are notifyied 
</I>&gt;<i> before port 
</I>&gt;<i> &gt;and connection close, but the browser never receives the 
</I>&gt;<i> notification.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Thanks for your help
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;##################test.py begins here####################### from 
</I>&gt;<i> &gt;twisted.application import internet, service from twisted.internet 
</I>&gt;<i> &gt;import reactor from twisted.web import resource, server, 
</I>&gt;<i> static import 
</I>&gt;<i> &gt;threading
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;application = service.Application(&quot;test&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;LISTENING   = list()
</I>&gt;<i> &gt;CHECK       = threading.Event()
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;def writeToActiveConnections():
</I>&gt;<i> &gt;    while not CHECK.isSet():
</I>&gt;<i> &gt;        for request in LISTENING:
</I>&gt;<i> &gt;            request.write(&quot;active&lt;br /&gt;&quot;)
</I>&gt;<i> &gt;        CHECK.wait(2)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;def onStop():
</I>&gt;<i> &gt;    print &quot;ON STOP CALLED&quot;
</I>&gt;<i> &gt;    CHECK.set()
</I>&gt;<i> &gt;    for request in LISTENING:
</I>&gt;<i> &gt;        request.write(&quot;&lt;strong&gt;Connection closed because of server
</I>&gt;<i> &gt;shutdown&lt;/strong&gt;&quot;)
</I>&gt;<i> &gt;    print &quot;ALL CONNECTIONS HAVE BEEN NOTIFIED&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;def onError(_error, _request):
</I>&gt;<i> &gt;    print &quot;Connection Closed %s&quot; % _error
</I>&gt;<i> &gt;    LISTENING.remove(_request)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;class ListenRessource(resource.Resource):
</I>&gt;<i> &gt;    def render_GET(self, _request):
</I>&gt;<i> &gt;        _request.write(&quot;listen connection opened&lt;br /&gt;&quot;)
</I>&gt;<i> &gt;        LISTENING.append(_request)
</I>&gt;<i> &gt;        d = _request.notifyFinish()
</I>&gt;<i> &gt;        d.addCallback(LISTENING.remove, _request)
</I>&gt;<i> &gt;        d.addErrback(onError, _request)
</I>&gt;<i> &gt;        return server.NOT_DONE_YET
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;class MainRessource(resource.Resource):
</I>&gt;<i> &gt;    def render_GET(self, _request):
</I>&gt;<i> &gt;        return &quot;&quot;&quot;
</I>&gt;<i> &gt;&lt;html&gt;
</I>&gt;<i> &gt;    &lt;head&gt;&lt;/head&gt;
</I>&gt;<i> &gt;    &lt;body&gt;
</I>&gt;<i> &gt;        &lt;h1&gt;Test page&lt;/h1&gt;
</I>&gt;<i> &gt;        &lt;iframe src=/listen&gt;&lt;/iframe&gt;
</I>&gt;<i> &gt;    &lt;/body&gt;
</I>&gt;<i> &gt;&lt;/html&gt;
</I>&gt;<i> &gt;        &quot;&quot;&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;class TestSite(server.Site):
</I>&gt;<i> &gt;    def __init__(self):
</I>&gt;<i> &gt;        root = static.File(&quot;/tmp&quot;)
</I>&gt;<i> &gt;        root.putChild(&quot;test&quot;, MainRessource())
</I>&gt;<i> &gt;        root.putChild(&quot;listen&quot;, ListenRessource() )
</I>&gt;<i> &gt;        server.Site.__init__(self, root)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;class TestService(internet.TCPServer):
</I>&gt;<i> &gt;    def __init__(self):
</I>&gt;<i> &gt;        internet.TCPServer.__init__(
</I>&gt;<i> &gt;            self,
</I>&gt;<i> &gt;            8080,
</I>&gt;<i> &gt;            TestSite()
</I>&gt;<i> &gt;        )
</I>&gt;<i> &gt;        reactor.callInThread(writeToActiveConnections)
</I>&gt;<i> &gt;        reactor.addSystemEventTrigger('before', 'shutdown', onStop)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;TestService().setServiceParent(application)
</I>&gt;<i> 
</I>&gt;<i> Twisted APIs are generally not safe to be invoked from any 
</I>&gt;<i> thread except for the thread in which the reactor is running.
</I>&gt;<i> 
</I>&gt;<i> If you want to run some code periodically, don't do it with 
</I>&gt;<i> threads and events, do it with reactor.callLater or 
</I>&gt;<i> twisted.internet.task.LoopingCall.
</I>&gt;<i> 
</I>&gt;<i> Jean-Paul
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> 
</I>I'm Ok with that but it is no more than test sample code. The server does
write periodically the connection but doesn't send &quot;&lt;strong&gt;Connection
closed because of server shutdown&lt;/strong&gt;&quot; whereas the onStop method is
correctly called!

Jean-François


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051593.html">[Twisted-Python] RE: Write into a persistent connection before	stopping
</A></li>
	<LI>Next message (by thread): <A HREF="051598.html">[Twisted-Python] RE: Write into a persistent connection befor	estopping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51597">[ date ]</a>
              <a href="thread.html#51597">[ thread ]</a>
              <a href="subject.html#51597">[ subject ]</a>
              <a href="author.html#51597">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
