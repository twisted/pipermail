<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Looping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looping&In-Reply-To=%3C613d56580901052001w1a40145n20ec6d78d779383f%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051473.html">
   <LINK REL="Next"  HREF="051476.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Looping</H1>
    <B>Robert Hancock</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looping&In-Reply-To=%3C613d56580901052001w1a40145n20ec6d78d779383f%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Looping">hancock.robert at gmail.com
       </A><BR>
    <I>Mon Jan  5 21:01:16 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051473.html">[Twisted-Python] Looping
</A></li>
        <LI>Next message (by thread): <A HREF="051476.html">[Twisted-Python] Looping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51475">[ date ]</a>
              <a href="thread.html#51475">[ thread ]</a>
              <a href="subject.html#51475">[ subject ]</a>
              <a href="author.html#51475">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I understand how the deferreds can create concurrency, but I still
cant' figure out how to get the process to loop correctly

I changed the code to use multiple deffereds, but I feel I'm missing a
basic architectural design on how to get the process to run in a loop.
 Any help would be greatly appreciated.

Case 1
-------------
If I execute if with:
   (RSSFeedStorage(GROUPS)).refreshAllFeeds()
    reactor.run()

If executes perfectly, one time.  Or from a loop in a shell script it
also runs fine multiple times.

I would like to perform the same function every 30 seconds from within
the script, but when I try:
    while True:
        (RSSFeedStorage(GROUPS)).refreshAllFeeds()
        reactor.run()
        time.sleep(5)

Case 2
------------
It executes twice and hangs, and when you hit Ctrl-C the traceback is:

  File &quot;main_rss.py&quot;, line 94, in &lt;module&gt;
    reactor.run()
  File &quot;/usr/local/python26/lib/python2.6/site-packages/Twisted-8.2.0-py2.6-linux-x86_64.egg/twisted/internet/base.py&quot;,
line 1128, in run
    self.mainLoop()
  File &quot;/usr/local/python26/lib/python2.6/site-packages/Twisted-8.2.0-py2.6-linux-x86_64.egg/twisted/internet/base.py&quot;,
line 1137, in mainLoop
    self.runUntilCurrent()
--- &lt;exception caught here&gt; ---
  File &quot;/usr/local/python26/lib/python2.6/site-packages/Twisted-8.2.0-py2.6-linux-x86_64.egg/twisted/internet/base.py&quot;,
line 729, in runUntilCurrent
    f(*a, **kw)
  File &quot;/usr/local/python26/lib/python2.6/site-packages/Twisted-8.2.0-py2.6-linux-x86_64.egg/twisted/internet/base.py&quot;,
line 527, in stop
    &quot;Can't stop reactor that isn't running.&quot;)
twisted.internet.error.ReactorNotRunning: Can't stop reactor that isn't running.

Case 3
-------------
I tried th task.LoopingCall() example from the manual and wrote:
    rf = RSSFeedStorage(GROUPS)
    l = task.LoopingCall(rf.refreshAllFeeds())
    l.start(10)
[commented out reactor.stop in sto_working()]

and it raises the following exception, I assume because the function
returns a deferred list.

exceptions.AttributeError: DeferredList instance has no __call__ method



==== Code ======

import os
import time
import xml.sax.saxutils

from twisted.internet import reactor, defer, protocol, task
from twisted.web import client

GROUPS = { 'yahoo' : '<A HREF="http://finance.yahoo.com/rss/usmarkets">http://finance.yahoo.com/rss/usmarkets</A>',
           'bbc':
'<A HREF="http://newsrss.bbc.co.uk/rss/newsonline_world_edition/front_page/rss.xml">http://newsrss.bbc.co.uk/rss/newsonline_world_edition/front_page/rss.xml</A>',
           'npr': '<A HREF="http://www.npr.org/rss/rss.php?id=1006">http://www.npr.org/rss/rss.php?id=1006</A>',
           'nytimes':
'<A HREF="http://www.nytimes.com/services/xml/rss/nyt/WorldBusiness.xml">http://www.nytimes.com/services/xml/rss/nyt/WorldBusiness.xml</A>'
           }
RSYNC_DIR = '/local/apps/rdretrvl/rdsync/rssfeed'
escape_dict = {'/': '_'}


class RssFeed(object):

    def __init__(self, groupName, feedUrl):
        self.refreshRate = 10
        self.title = ''
        self.groupName = groupName
        self.feedUrl = feedUrl
        self.articles = []
        self.articlesById = {}
        self.lastRefreshTime = 0
        self.refreshing = None

    def refreshIfNeeded(self):
        timeSinceRefersh = time.time() - self.lastRefreshTime
        if timeSinceRefersh &gt; self.refreshRate:
            if not self.refreshing:
                self.refreshing = client.getPage(self.feedUrl).addCallback(
                    self._gotFeedData).addErrback(self._getDataFailed)
            d = defer.Deferred()
            self.refreshing.chainDeferred(d)
            return d
        else:
            return defer.succeed(None)

    def _gotFeedData(self, data):
        print &quot;Loaded feed data from %s&quot; % self.feedUrl
        self.refreshing = None
        self.lastRefreshTime = time.time()
        # write to rsync directory
        name = xml.sax.saxutils.escape(self.feedUrl, escape_dict)
        try:
            fnout = os.path.join(RSYNC_DIR, name)
            fout = open(fnout, 'w')
        except IOError, e:
            print e
            #log.error('Opening %s: %s' % (fnout, e))
            return

        try:
            fout.write(data)
            #log.info('Wrote %s.' % fnout)
            print 'Wrote %s.' % fnout
        except IOError, e:
            print e
            #log.error('Wrting to %s: %s' % (fnout, e))
        finally:
            fout.close()

    def _getDataFailed(self, failure):
        print 'Failed to load RSS data from %s: %s' % (self.feedUrl,
failure.getErrorMessage())
        self.refreshing = None
        return failure

class RSSFeedStorage(object):

    def __init__(self, feeds):
        self.feeds = {}
        for groupName, url in feeds.iteritems():
            self.feeds[groupName] = RssFeed(groupName, url)

    def refreshAllFeeds(self):
        refreshes = [feed.refreshIfNeeded() for feed in self.feeds.values()]
        return defer.DeferredList(refreshes).addCallback(self.stop_working).addErrback(self.handleError)

    def stop_working(self, data):
        reactor.stop()
        print 'Reactor stopped'

    def handleError(self, failure):
        print failure

if __name__ == &quot;__main__&quot;:

          {execution code goes here]

On Mon, Jan 5, 2009 at 11:53 AM, Drew Smathers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">drew.smathers at gmail.com</A>&gt; wrote:
&gt;<i> On Sun, Jan 4, 2009 at 11:23 PM, Robert Hancock
</I>&gt;<i> &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">hancock.robert at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i> How many urls are in url_tuples?
</I>&gt;&gt;<i> 4 - 32
</I>&gt;&gt;&gt;<i> Is there a reason why you're using just one deferred?
</I>&gt;&gt;<i> What is the advantage of using more?
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Concurrency.
</I>&gt;<i>
</I>&gt;<i> -Drew
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051473.html">[Twisted-Python] Looping
</A></li>
	<LI>Next message (by thread): <A HREF="051476.html">[Twisted-Python] Looping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51475">[ date ]</a>
              <a href="thread.html#51475">[ thread ]</a>
              <a href="subject.html#51475">[ subject ]</a>
              <a href="author.html#51475">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
