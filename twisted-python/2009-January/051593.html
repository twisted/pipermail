<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] RE: Write into a persistent connection before	stopping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20RE%3A%20Write%20into%20a%20persistent%20connection%20before%0A%09stopping&In-Reply-To=%3C20090126152245.24460.2109813100.divmod.quotient.2141%40henry.divmod.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051592.html">
   <LINK REL="Next"  HREF="051597.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] RE: Write into a persistent connection before	stopping</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20RE%3A%20Write%20into%20a%20persistent%20connection%20before%0A%09stopping&In-Reply-To=%3C20090126152245.24460.2109813100.divmod.quotient.2141%40henry.divmod.com%3E"
       TITLE="[Twisted-Python] RE: Write into a persistent connection before	stopping">exarkun at divmod.com
       </A><BR>
    <I>Mon Jan 26 08:22:45 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051592.html">[Twisted-Python] RE: Write into a persistent connection before	stopping
</A></li>
        <LI>Next message (by thread): <A HREF="051597.html">[Twisted-Python] RE: Write into a persistent connection befor	estopping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51593">[ date ]</a>
              <a href="thread.html#51593">[ thread ]</a>
              <a href="subject.html#51593">[ subject ]</a>
              <a href="author.html#51593">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 26 Jan 2009 16:12:57 +0100, &quot;Boeuf, Jean-Francois&quot; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jean-francois.boeuf at eads.com</A>&gt; wrote:
&gt;<i>Hi,
</I>&gt;<i>
</I>&gt;<i>As i didn't get any answer to my problem i writed a little test code to
</I>&gt;<i>reproduce it (I can't divulgate the production code, and then it would be to
</I>&gt;<i>much complicated to expose the matter). You can just run it using twistd -y
</I>&gt;<i>test.py and then connect to the 8080 tcp port with a browser. As we can see
</I>&gt;<i>in the browser the connection is active and periodicaly writed. The logs
</I>&gt;<i>indicate that the conections are notifyied before port and connection close,
</I>&gt;<i>but the browser never receives the notification.
</I>&gt;<i>
</I>&gt;<i>Thanks for your help
</I>&gt;<i>
</I>&gt;<i>##################test.py begins here#######################
</I>&gt;<i>from twisted.application import internet, service
</I>&gt;<i>from twisted.internet import reactor
</I>&gt;<i>from twisted.web import resource, server, static
</I>&gt;<i>import threading
</I>&gt;<i>
</I>&gt;<i>application = service.Application(&quot;test&quot;)
</I>&gt;<i>
</I>&gt;<i>LISTENING   = list()
</I>&gt;<i>CHECK       = threading.Event()
</I>&gt;<i>
</I>&gt;<i>def writeToActiveConnections():
</I>&gt;<i>    while not CHECK.isSet():
</I>&gt;<i>        for request in LISTENING:
</I>&gt;<i>            request.write(&quot;active&lt;br /&gt;&quot;)
</I>&gt;<i>        CHECK.wait(2)
</I>&gt;<i>
</I>&gt;<i>def onStop():
</I>&gt;<i>    print &quot;ON STOP CALLED&quot;
</I>&gt;<i>    CHECK.set()
</I>&gt;<i>    for request in LISTENING:
</I>&gt;<i>        request.write(&quot;&lt;strong&gt;Connection closed because of server
</I>&gt;<i>shutdown&lt;/strong&gt;&quot;)
</I>&gt;<i>    print &quot;ALL CONNECTIONS HAVE BEEN NOTIFIED&quot;
</I>&gt;<i>
</I>&gt;<i>def onError(_error, _request):
</I>&gt;<i>    print &quot;Connection Closed %s&quot; % _error
</I>&gt;<i>    LISTENING.remove(_request)
</I>&gt;<i>
</I>&gt;<i>class ListenRessource(resource.Resource):
</I>&gt;<i>    def render_GET(self, _request):
</I>&gt;<i>        _request.write(&quot;listen connection opened&lt;br /&gt;&quot;)
</I>&gt;<i>        LISTENING.append(_request)
</I>&gt;<i>        d = _request.notifyFinish()
</I>&gt;<i>        d.addCallback(LISTENING.remove, _request)
</I>&gt;<i>        d.addErrback(onError, _request)
</I>&gt;<i>        return server.NOT_DONE_YET
</I>&gt;<i>
</I>&gt;<i>class MainRessource(resource.Resource):
</I>&gt;<i>    def render_GET(self, _request):
</I>&gt;<i>        return &quot;&quot;&quot;
</I>&gt;<i>&lt;html&gt;
</I>&gt;<i>    &lt;head&gt;&lt;/head&gt;
</I>&gt;<i>    &lt;body&gt;
</I>&gt;<i>        &lt;h1&gt;Test page&lt;/h1&gt;
</I>&gt;<i>        &lt;iframe src=/listen&gt;&lt;/iframe&gt;
</I>&gt;<i>    &lt;/body&gt;
</I>&gt;<i>&lt;/html&gt;
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>
</I>&gt;<i>class TestSite(server.Site):
</I>&gt;<i>    def __init__(self):
</I>&gt;<i>        root = static.File(&quot;/tmp&quot;)
</I>&gt;<i>        root.putChild(&quot;test&quot;, MainRessource())
</I>&gt;<i>        root.putChild(&quot;listen&quot;, ListenRessource() )
</I>&gt;<i>        server.Site.__init__(self, root)
</I>&gt;<i>
</I>&gt;<i>class TestService(internet.TCPServer):
</I>&gt;<i>    def __init__(self):
</I>&gt;<i>        internet.TCPServer.__init__(
</I>&gt;<i>            self,
</I>&gt;<i>            8080,
</I>&gt;<i>            TestSite()
</I>&gt;<i>        )
</I>&gt;<i>        reactor.callInThread(writeToActiveConnections)
</I>&gt;<i>        reactor.addSystemEventTrigger('before', 'shutdown', onStop)
</I>&gt;<i>
</I>&gt;<i>TestService().setServiceParent(application)
</I>
Twisted APIs are generally not safe to be invoked from any thread except
for the thread in which the reactor is running.

If you want to run some code periodically, don't do it with threads and
events, do it with reactor.callLater or twisted.internet.task.LoopingCall.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051592.html">[Twisted-Python] RE: Write into a persistent connection before	stopping
</A></li>
	<LI>Next message (by thread): <A HREF="051597.html">[Twisted-Python] RE: Write into a persistent connection befor	estopping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51593">[ date ]</a>
              <a href="thread.html#51593">[ thread ]</a>
              <a href="subject.html#51593">[ subject ]</a>
              <a href="author.html#51593">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
