<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Best place to put application code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Best%20place%20to%20put%20application%20code&In-Reply-To=%3C20090102155956.20272.958450739.divmod.quotient.30688%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051455.html">
   <LINK REL="Next"  HREF="051459.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Best place to put application code</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Best%20place%20to%20put%20application%20code&In-Reply-To=%3C20090102155956.20272.958450739.divmod.quotient.30688%40ohm%3E"
       TITLE="[Twisted-Python] Best place to put application code">exarkun at divmod.com
       </A><BR>
    <I>Fri Jan  2 08:59:56 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051455.html">[Twisted-Python] Best place to put application code
</A></li>
        <LI>Next message (by thread): <A HREF="051459.html">[Twisted-Python] [Q] multi-process chat client and poller
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51457">[ date ]</a>
              <a href="thread.html#51457">[ thread ]</a>
              <a href="subject.html#51457">[ subject ]</a>
              <a href="author.html#51457">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 2 Jan 2009 10:14:40 +0000, John Aherne &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A>&gt; wrote:
&gt;<i>One thing that has been puzzling me is where is the best place to put
</I>&gt;<i>application code.
</I>
It depends. :)

&gt;<i>
</I>&gt;<i>The case I am using is straightforward TCP server with client connections
</I>&gt;<i>making simple requests and waiting for responses retrieved from database
</I>&gt;<i>tables to be sent back.
</I>&gt;<i>
</I>&gt;<i>Reading the docs and looking at various examples provided in books and
</I>&gt;<i>documentation has left me a bit confused.
</I>&gt;<i>
</I>&gt;<i>Is there a best practice for where application code should go - either the
</I>&gt;<i>protcocol class or the factory class or somewhere else. Does it actually
</I>&gt;<i>matter.
</I>&gt;<i>
</I>&gt;<i>Is there any downside to putting application code in the protocol or
</I>&gt;<i>factory. What pitfalls are there for either approach.
</I>
Best practice for a Protocol class is to include code which is necessary
to interpret bytes which are received and turn them into a structured form
which is easier to deal with; code which starts from some structured form
and emits bytes to be sent should also be part of a Protocol class.

It is common practice to have a class which includes just these things and
then a subclass which adds application-specific logic based on top of this
functionality.  It is also common practice to connect a protocol which has
only these things, no application-specific code, and then have application
code elsewhere (in a free function, a method of a factory, another class's
method, user input, etc) make calls onto it.  Which of these approaches is
most well suited to a particular application depends.  For example, if the application code creates multiple connections with shared state adding the application logic to a Protocol subclass isn't a good approach.

&gt;<i>I see examples where application code appears in both classes, but the
</I>&gt;<i>examples are very small so may not be indicative of what should be done.
</I>
Generally they're so small that there's no advantage to any approach over
any other, yes.

&gt;<i>In the docs I see reference to most of the code will be written in the
</I>&gt;<i>protocol class, but that seems to be referring to actually writing protocols
</I>&gt;<i>not application code. It also says that when the protocol needs to call
</I>&gt;<i>application code to make it a method call -  not to mix protocol and
</I>&gt;<i>application code. This could just mean creating some methods in the protocol
</I>&gt;<i>class to handle the task.
</I>
Consider all of the code you write to be part of a library you're developing.
If you implement a protocol, then you've just written part of a library which
provides a slightly higher-level API for interacting with the network in some
way.  With that in hand, you can move on to some other part of your library
which uses that higher-level API to accomplish something even higher-level,
perhaps presenting yet another API to some other part of your application
which is higher-level still.  The motivation to not mix protocol and
application code is just the motivation to have clear boundaries in your
library to make as much of it reusable as possible.  If you have a protocol
implementation mixed together with application A, when you come along to
write application B which needs to use the same protocol, you'll have to
re-implement the protocol, or refactor your original implementation to move
the application A code elsewhere (of course, there's nothing wrong with
having to refactor your code - it's a common part of programming, and since
it's very difficult to predict the future, it's often best *not* to try to
anticipate your future requirements when writing code - just write what works
and is easily testable, and when your future requirements come along, deal
with them then; as you do this more and more, you'll probably get a sense of
how to structure your code to minimize the effort required for refactoring,
but aside from experience with this process, I don't know of any way to learn
this skill).

&gt;<i>However, if the application code needs to run for 10-12 seconds looking up
</I>&gt;<i>database tables and accumulating results and waiting on  deferreds, should
</I>&gt;<i>all this code reside in the protocol class or the factory.
</I>
I wouldn't take the duration of the task into consideration when trying to
decide where to put it.  I'd consider reusability, testability, simplicity,
and correctness.

&gt;<i>
</I>&gt;<i>If I keep it in the protocol, then I already have my client connection to
</I>&gt;<i>write back to. So that seems to be the place to keep the code.
</I>&gt;<i>
</I>&gt;<i>If I put the code in the factory, then I need to pass the client connection
</I>&gt;<i>so it can write back to the client. Or is there another way of doing this I
</I>&gt;<i>have missed.
</I>
This isn't much different from the trade-off you have to consider when you
decide to implement anything as two classes instead of one.  Since you can
no longer just use `selfÂ´ everywhere, you'll have to figure out how to get
a reference to the other instance that you need sometimes.  This shouldn't
be difficult though - just invoke a method on one class with an instance of
the other.

&gt;<i>.
</I>&gt;<i>The factory seems to be the place where other classes can be passed in and
</I>&gt;<i>the protocol can call them via self.factory. That seems to imply that
</I>&gt;<i>application code should be put into the factory, but I can't see any way of
</I>&gt;<i>passing back information from deferred results to the call from protocol.
</I>&gt;<i>It's ok if it was just a simple method call that returns a result, but if
</I>&gt;<i>the code has to run a series of deferreds then it will be the called method
</I>&gt;<i>that will have the result and it will need a means of writing this back to
</I>&gt;<i>the client. I don't think I can signal the protocol to say I now have the
</I>&gt;<i>result.Of course I could easily be mistaken. So please correct.
</I>
This is just what Deferreds are for.  For example, let's consider a protocol
and factory for a game server lobby.  The protocol has a message type which
lets the server inform the client of the list of games which are currently
available to be joined.  The Protocol subclass sends this information to
the client when the connection is established, but it uses the factory
to actually find the list of games that are available.  Again, this
division is probably desirable for a number of reasons (it simplifies
unit testing, for example).

class GameFactory(ServerFactory):
    def availableGames(self):
        &quot;&quot;&quot;
        Return a Deferred which will fire with a list of the games
        currently available to be joined.
        &quot;&quot;&quot;
        return self.connectionPool.runQuery(
            &quot;SELECT game_id FROM available_games&quot;)


class GameProtocol(Protocol):
    def connectionMade(self):
        &quot;&quot;&quot;
        Send the available-games message so the client can pick one to
        join.
        &quot;&quot;&quot;
        d = self.factory.availableGames()
        def cbGotGames(games):
            self.transport.write(&quot; &quot;.join(games))
        d.addCallback(cbGotGames)
        d.addErrback(log.err)

&gt;<i>
</I>&gt;<i>Of course if I passs the client connection to the factory, then it can use
</I>&gt;<i>this to write back. But that means passing around the client connection.
</I>&gt;<i>Should I avoid doing that or is that not a problem.
</I>
It's an option, but I hope the above example will show how you can use
Deferreds to avoid needing to do this.

&gt;<i>
</I>&gt;<i>I hope I have explained myself clearly. I'm just looking for some guidance
</I>&gt;<i>and pointers to what is best to do or what is best to avoid.
</I>&gt;<i>
</I>
Hope this helps,

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051455.html">[Twisted-Python] Best place to put application code
</A></li>
	<LI>Next message (by thread): <A HREF="051459.html">[Twisted-Python] [Q] multi-process chat client and poller
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51457">[ date ]</a>
              <a href="thread.html#51457">[ thread ]</a>
              <a href="subject.html#51457">[ subject ]</a>
              <a href="author.html#51457">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
