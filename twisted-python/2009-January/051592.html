<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] RE: Write into a persistent connection before	stopping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20RE%3A%20Write%20into%20a%20persistent%20connection%20before%0A%09stopping&In-Reply-To=%3C050AD9702349384DADA9CD24800536690250879A%40SMFIDF806A.main.fr.ds.corp%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051546.html">
   <LINK REL="Next"  HREF="051593.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] RE: Write into a persistent connection before	stopping</H1>
    <B>Boeuf, Jean-Francois</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20RE%3A%20Write%20into%20a%20persistent%20connection%20before%0A%09stopping&In-Reply-To=%3C050AD9702349384DADA9CD24800536690250879A%40SMFIDF806A.main.fr.ds.corp%3E"
       TITLE="[Twisted-Python] RE: Write into a persistent connection before	stopping">jean-francois.boeuf at eads.com
       </A><BR>
    <I>Mon Jan 26 08:12:57 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051546.html">[Twisted-Python] Write into a persistent connection before stopping
</A></li>
        <LI>Next message (by thread): <A HREF="051593.html">[Twisted-Python] RE: Write into a persistent connection before	stopping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51592">[ date ]</a>
              <a href="thread.html#51592">[ thread ]</a>
              <a href="subject.html#51592">[ subject ]</a>
              <a href="author.html#51592">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

As i didn't get any answer to my problem i writed a little test code to
reproduce it (I can't divulgate the production code, and then it would be to
much complicated to expose the matter). You can just run it using twistd -y
test.py and then connect to the 8080 tcp port with a browser. As we can see
in the browser the connection is active and periodicaly writed. The logs
indicate that the conections are notifyied before port and connection close,
but the browser never receives the notification.

Thanks for your help

##################test.py begins here#######################
from twisted.application import internet, service
from twisted.internet import reactor
from twisted.web import resource, server, static
import threading

application = service.Application(&quot;test&quot;)

LISTENING   = list()
CHECK       = threading.Event()

def writeToActiveConnections():
    while not CHECK.isSet():
        for request in LISTENING:
            request.write(&quot;active&lt;br /&gt;&quot;)
        CHECK.wait(2)

def onStop():
    print &quot;ON STOP CALLED&quot;
    CHECK.set()
    for request in LISTENING:
        request.write(&quot;&lt;strong&gt;Connection closed because of server
shutdown&lt;/strong&gt;&quot;)
    print &quot;ALL CONNECTIONS HAVE BEEN NOTIFIED&quot;

def onError(_error, _request):
    print &quot;Connection Closed %s&quot; % _error
    LISTENING.remove(_request)

class ListenRessource(resource.Resource):
    def render_GET(self, _request):
        _request.write(&quot;listen connection opened&lt;br /&gt;&quot;)
        LISTENING.append(_request)
        d = _request.notifyFinish()
        d.addCallback(LISTENING.remove, _request)
        d.addErrback(onError, _request)
        return server.NOT_DONE_YET

class MainRessource(resource.Resource):
    def render_GET(self, _request):
        return &quot;&quot;&quot;
&lt;html&gt;
    &lt;head&gt;&lt;/head&gt;
    &lt;body&gt;
        &lt;h1&gt;Test page&lt;/h1&gt;
        &lt;iframe src=/listen&gt;&lt;/iframe&gt;
    &lt;/body&gt;
&lt;/html&gt;
        &quot;&quot;&quot;

class TestSite(server.Site):
    def __init__(self):
        root = static.File(&quot;/tmp&quot;)
        root.putChild(&quot;test&quot;, MainRessource())
        root.putChild(&quot;listen&quot;, ListenRessource() )
        server.Site.__init__(self, root)

class TestService(internet.TCPServer):
    def __init__(self):
        internet.TCPServer.__init__(
            self,
            8080,
            TestSite()
        )
        reactor.callInThread(writeToActiveConnections)
        reactor.addSystemEventTrigger('before', 'shutdown', onStop)

TestService().setServiceParent(application)
##################test.py ends here#######################


&gt;<i> -----Message d'origine-----
</I>&gt;<i> De : Boeuf, Jean-Francois 
</I>&gt;<i> Envoyé : vendredi 16 janvier 2009 13:26
</I>&gt;<i> À : '<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>'
</I>&gt;<i> Objet : Write into a persistent connection before stopping
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I have an application using twisted in which the web browser 
</I>&gt;<i> opens a persistent connection when a user logs in (COMET 
</I>&gt;<i> model). I want to write data into active persistent 
</I>&gt;<i> connections at server stop to notify client to logout properly.
</I>&gt;<i> 
</I>&gt;<i> To do that, I add a system event trigger to the reactor 
</I>&gt;<i> calling the method that closes session before shutdown when I 
</I>&gt;<i> start the webService. This method is called when twisted 
</I>&gt;<i> receives a SIGTERM and I can see in twistd.log traces of 
</I>&gt;<i> writing to the persistent connexion before services stops and 
</I>&gt;<i> connexions are closed. But the web browser never receives 
</I>&gt;<i> this content and listening the traffic between server and 
</I>&gt;<i> client with wireshark, I can't see anything else than the 
</I>&gt;<i> [FIN, ACK] packets that are sent when server ends all 
</I>&gt;<i> connections (delayed for maximum clarity in the logs).
</I>&gt;<i> 
</I>&gt;<i> The same method is called to logout client properly when 
</I>&gt;<i> session expires and does work fully.
</I>&gt;<i> 
</I>&gt;<i> You can see below the twistd.log file when the servers stops.
</I>&gt;<i> 
</I>&gt;<i> Thank you for your help.
</I>&gt;<i> 
</I>&gt;<i> Regards
</I>&gt;<i> 
</I>&gt;<i> Jean-François
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> twistd.log
</I>&gt;<i> ----------
</I>&gt;<i> 2009-01-16 13:26:16+0100 [-] Received SIGTERM, shutting down.
</I>&gt;<i> 2009-01-16 13:26:16+0100 [-] 10.37.68.212 - - 
</I>&gt;<i> [16/Jan/2009:12:26:16 +0000] &quot;GET 
</I>&gt;<i> /sim/listen?sourceScreen=216 HTTP/1.1&quot; 200 166 
</I>&gt;<i> &quot;<A HREF="http://peyo:8080/sim?id=216">http://peyo:8080/sim?id=216</A>&quot; &quot;Mozilla/5.0 (Windows; U; 
</I>&gt;<i> Windows NT 5.1; fr; rv:1.8.1.16) Gecko/20080702 Firefox/2.0.0.16&quot;
</I>&gt;<i> 2009-01-16 13:26:16+0100 [-] 10.37.68.212 - - 
</I>&gt;<i> [16/Jan/2009:12:26:16 +0000] &quot;GET 
</I>&gt;<i> /sim/listen?sourceScreen=217 HTTP/1.1&quot; 200 166 
</I>&gt;<i> &quot;<A HREF="http://peyo:8080/sim?id=217">http://peyo:8080/sim?id=217</A>&quot; &quot;Mozilla/5.0 (Windows; U; 
</I>&gt;<i> Windows NT 5.1; fr; rv:1.8.1.16) Gecko/20080702 Firefox/2.0.0.16&quot;
</I>&gt;<i> 2009-01-16 13:26:16+0100 [-] 10.37.68.212 - - 
</I>&gt;<i> [16/Jan/2009:12:26:16 +0000] &quot;GET 
</I>&gt;<i> /sim/listen?sourceScreen=218 HTTP/1.1&quot; 200 166 
</I>&gt;<i> &quot;<A HREF="http://peyo:8080/sim?id=218&amp;screen0=216&amp;screen1=217&amp;nbScreen=">http://peyo:8080/sim?id=218&amp;screen0=216&amp;screen1=217&amp;nbScreen=</A>
</I>&gt;<i> 2&quot; &quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; fr; rv:1.8.1.16) 
</I>&gt;<i> Gecko/20080702 Firefox/2.0.0.16&quot;
</I>&gt;<i> 2009-01-16 13:26:25+0100 [-] (Port 8080 Closed)
</I>&gt;<i> 2009-01-16 13:26:25+0100 [-] Stopping factory 
</I>&gt;<i> &lt;cockpitServer.userSessionManagement.cockpitSite.CockpitSite 
</I>&gt;<i> object at 0xb6db9e6c&gt;
</I>&gt;<i> 2009-01-16 13:26:25+0100 [-] (Port 8082 Closed)
</I>&gt;<i> 2009-01-16 13:26:25+0100 [-] Stopping factory 
</I>&gt;<i> &lt;cockpitServer.soapService.SoapSite object at 0xb7092d0c&gt;
</I>&gt;<i> 2009-01-16 13:26:25+0100 [-] Main loop terminated.
</I>&gt;<i> 2009-01-16 13:26:25+0100 [-] Server Shut Down
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051546.html">[Twisted-Python] Write into a persistent connection before stopping
</A></li>
	<LI>Next message (by thread): <A HREF="051593.html">[Twisted-Python] RE: Write into a persistent connection before	stopping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51592">[ date ]</a>
              <a href="thread.html#51592">[ thread ]</a>
              <a href="subject.html#51592">[ subject ]</a>
              <a href="author.html#51592">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
