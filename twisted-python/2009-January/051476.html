<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Looping
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looping&In-Reply-To=%3C9bb390e70901052209o12a9f175h2163b09a9822a366%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051475.html">
   <LINK REL="Next"  HREF="051468.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Looping</H1>
    <B>Rob Hoadley</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looping&In-Reply-To=%3C9bb390e70901052209o12a9f175h2163b09a9822a366%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Looping">hoadley at gmail.com
       </A><BR>
    <I>Mon Jan  5 23:09:21 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051475.html">[Twisted-Python] Looping
</A></li>
        <LI>Next message (by thread): <A HREF="051468.html">[Twisted-Python] Looping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51476">[ date ]</a>
              <a href="thread.html#51476">[ thread ]</a>
              <a href="subject.html#51476">[ subject ]</a>
              <a href="author.html#51476">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So one problem is understanding the reactor.  It's only meant to be
run once.  Some of your code looks like it's trying to start it more
than once.   You only want one started at a time or weird things
happen.  I'd start here and make sure you understand the reactor:

<A HREF="http://twistedmatrix.com/projects/core/documentation/howto/reactor-basics.html">http://twistedmatrix.com/projects/core/documentation/howto/reactor-basics.html</A>

As far as your problem, you should make your URL grabbing service a
twisted service so you can reach your goal of running it as a daemon
and so you can make a programmatic avenue to add new urls to grab.
You'd also want to learn about making twisted services.   As a
previous poster recommends, you have a two straightforward ways to
call things.  reactor.callLater is the one I like to use.  The example
l show you below is going every 10 seconds.

The way to daemonize things is by using twistd using a tac file.  So
there are a number of things you'll need to cover.  You may want to
slowly go through the twisted tutorial.

<A HREF="http://twistedmatrix.com/projects/core/documentation/howto/tutorial/index.html">http://twistedmatrix.com/projects/core/documentation/howto/tutorial/index.html</A>

As a teaser,  In your service __init__ you'd create your
self.localUrls aka GROUPS from above as an object complex or simple as
you want.  You may want to carry around more info. want it to persist,
or not.  Below the data doesn't persist as it's pop'd off a deque.
It's up to you to figure out how you want it to work.

Here are some modules you'd probably want to use and a semi working example:

from twisted.internet import  reactor
from twisted.python import  log
from twisted.web import client
from twisted.application import  service
from collections import deque

class URLGrabService(service.Service):

    def __init__ ( self ):
        # self.urls  = deque() something that contains your urls I like deque
        self.call = reactor.callLater(10,self.getPages)

   def startService( self ):
        # implement your start service code if needed
        # twistd would call this from a succesful Application Object
don't call directly
        service.Service.startService( self )

    def stopService( self ):
       # stop your reactor.call
       if self.call:
           self.call.cancel()
       service.Service.stopService( self )

    def getPages( self ):

        if len( self.urls ):
            localUrls = deque()

            while self.urls:
                localQueue.append( self.localUrls.popleft() )

            # clear out the localUrls and move to a localQueue var

            while localQueue:
                urlObj = localQueue.popleft() # mucho faster than a
list doing pop(0)
                log.msg( 'sending %s' % urlObj.url )
                self._getPage( urlObj )
                # I just create a bunch of deferreds

        self.call = reactor.callLater(10,self.getPages)

	def _getPage( self, urlObj ):
		d = client.getPage( urlObj.url )
	        d.addCallback( self._checkWebStatus, urlObj )
	        d.addErrback( self._readdUrl, urlObj )
	        return d

        def _checkWebStatus( self, page, urlObj ):
               # do the work you'd do on a successful grab

        def _readdUrl( self, urlObj ):
                # handle errors... I generally retry them on the next
cycle and set a urlObj.retry +1

Then you'd want a tac file to pull it all together.  Hope this helps.

-rob




On Mon, Jan 5, 2009 at 8:01 PM, Robert Hancock &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">hancock.robert at gmail.com</A>&gt; wrote:
&gt;<i> I understand how the deferreds can create concurrency, but I still
</I>&gt;<i> cant' figure out how to get the process to loop correctly
</I>&gt;<i>
</I>&gt;<i> I changed the code to use multiple deffereds, but I feel I'm missing a
</I>&gt;<i> basic architectural design on how to get the process to run in a loop.
</I>&gt;<i>  Any help would be greatly appreciated.
</I>&gt;<i>
</I>&gt;<i> Case 1
</I>&gt;<i> -------------
</I>&gt;<i> If I execute if with:
</I>&gt;<i>   (RSSFeedStorage(GROUPS)).refreshAllFeeds()
</I>&gt;<i>    reactor.run()
</I>&gt;<i>
</I>&gt;<i> If executes perfectly, one time.  Or from a loop in a shell script it
</I>&gt;<i> also runs fine multiple times.
</I>&gt;<i>
</I>&gt;<i> I would like to perform the same function every 30 seconds from within
</I>&gt;<i> the script, but when I try:
</I>&gt;<i>    while True:
</I>&gt;<i>        (RSSFeedStorage(GROUPS)).refreshAllFeeds()
</I>&gt;<i>        reactor.run()
</I>&gt;<i>        time.sleep(5)
</I>&gt;<i>
</I>&gt;<i> Case 2
</I>&gt;<i> ------------
</I>&gt;<i> It executes twice and hangs, and when you hit Ctrl-C the traceback is:
</I>&gt;<i>
</I>&gt;<i>  File &quot;main_rss.py&quot;, line 94, in &lt;module&gt;
</I>&gt;<i>    reactor.run()
</I>&gt;<i>  File &quot;/usr/local/python26/lib/python2.6/site-packages/Twisted-8.2.0-py2.6-linux-x86_64.egg/twisted/internet/base.py&quot;,
</I>&gt;<i> line 1128, in run
</I>&gt;<i>    self.mainLoop()
</I>&gt;<i>  File &quot;/usr/local/python26/lib/python2.6/site-packages/Twisted-8.2.0-py2.6-linux-x86_64.egg/twisted/internet/base.py&quot;,
</I>&gt;<i> line 1137, in mainLoop
</I>&gt;<i>    self.runUntilCurrent()
</I>&gt;<i> --- &lt;exception caught here&gt; ---
</I>&gt;<i>  File &quot;/usr/local/python26/lib/python2.6/site-packages/Twisted-8.2.0-py2.6-linux-x86_64.egg/twisted/internet/base.py&quot;,
</I>&gt;<i> line 729, in runUntilCurrent
</I>&gt;<i>    f(*a, **kw)
</I>&gt;<i>  File &quot;/usr/local/python26/lib/python2.6/site-packages/Twisted-8.2.0-py2.6-linux-x86_64.egg/twisted/internet/base.py&quot;,
</I>&gt;<i> line 527, in stop
</I>&gt;<i>    &quot;Can't stop reactor that isn't running.&quot;)
</I>&gt;<i> twisted.internet.error.ReactorNotRunning: Can't stop reactor that isn't running.
</I>&gt;<i>
</I>&gt;<i> Case 3
</I>&gt;<i> -------------
</I>&gt;<i> I tried th task.LoopingCall() example from the manual and wrote:
</I>&gt;<i>    rf = RSSFeedStorage(GROUPS)
</I>&gt;<i>    l = task.LoopingCall(rf.refreshAllFeeds())
</I>&gt;<i>    l.start(10)
</I>&gt;<i> [commented out reactor.stop in sto_working()]
</I>&gt;<i>
</I>&gt;<i> and it raises the following exception, I assume because the function
</I>&gt;<i> returns a deferred list.
</I>&gt;<i>
</I>&gt;<i> exceptions.AttributeError: DeferredList instance has no __call__ method
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ==== Code ======
</I>&gt;<i>
</I>&gt;<i> import os
</I>&gt;<i> import time
</I>&gt;<i> import xml.sax.saxutils
</I>&gt;<i>
</I>&gt;<i> from twisted.internet import reactor, defer, protocol, task
</I>&gt;<i> from twisted.web import client
</I>&gt;<i>
</I>&gt;<i> GROUPS = { 'yahoo' : '<A HREF="http://finance.yahoo.com/rss/usmarkets">http://finance.yahoo.com/rss/usmarkets</A>',
</I>&gt;<i>           'bbc':
</I>&gt;<i> '<A HREF="http://newsrss.bbc.co.uk/rss/newsonline_world_edition/front_page/rss.xml">http://newsrss.bbc.co.uk/rss/newsonline_world_edition/front_page/rss.xml</A>',
</I>&gt;<i>           'npr': '<A HREF="http://www.npr.org/rss/rss.php?id=1006">http://www.npr.org/rss/rss.php?id=1006</A>',
</I>&gt;<i>           'nytimes':
</I>&gt;<i> '<A HREF="http://www.nytimes.com/services/xml/rss/nyt/WorldBusiness.xml">http://www.nytimes.com/services/xml/rss/nyt/WorldBusiness.xml</A>'
</I>&gt;<i>           }
</I>&gt;<i> RSYNC_DIR = '/local/apps/rdretrvl/rdsync/rssfeed'
</I>&gt;<i> escape_dict = {'/': '_'}
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class RssFeed(object):
</I>&gt;<i>
</I>&gt;<i>    def __init__(self, groupName, feedUrl):
</I>&gt;<i>        self.refreshRate = 10
</I>&gt;<i>        self.title = ''
</I>&gt;<i>        self.groupName = groupName
</I>&gt;<i>        self.feedUrl = feedUrl
</I>&gt;<i>        self.articles = []
</I>&gt;<i>        self.articlesById = {}
</I>&gt;<i>        self.lastRefreshTime = 0
</I>&gt;<i>        self.refreshing = None
</I>&gt;<i>
</I>&gt;<i>    def refreshIfNeeded(self):
</I>&gt;<i>        timeSinceRefersh = time.time() - self.lastRefreshTime
</I>&gt;<i>        if timeSinceRefersh &gt; self.refreshRate:
</I>&gt;<i>            if not self.refreshing:
</I>&gt;<i>                self.refreshing = client.getPage(self.feedUrl).addCallback(
</I>&gt;<i>                    self._gotFeedData).addErrback(self._getDataFailed)
</I>&gt;<i>            d = defer.Deferred()
</I>&gt;<i>            self.refreshing.chainDeferred(d)
</I>&gt;<i>            return d
</I>&gt;<i>        else:
</I>&gt;<i>            return defer.succeed(None)
</I>&gt;<i>
</I>&gt;<i>    def _gotFeedData(self, data):
</I>&gt;<i>        print &quot;Loaded feed data from %s&quot; % self.feedUrl
</I>&gt;<i>        self.refreshing = None
</I>&gt;<i>        self.lastRefreshTime = time.time()
</I>&gt;<i>        # write to rsync directory
</I>&gt;<i>        name = xml.sax.saxutils.escape(self.feedUrl, escape_dict)
</I>&gt;<i>        try:
</I>&gt;<i>            fnout = os.path.join(RSYNC_DIR, name)
</I>&gt;<i>            fout = open(fnout, 'w')
</I>&gt;<i>        except IOError, e:
</I>&gt;<i>            print e
</I>&gt;<i>            #log.error('Opening %s: %s' % (fnout, e))
</I>&gt;<i>            return
</I>&gt;<i>
</I>&gt;<i>        try:
</I>&gt;<i>            fout.write(data)
</I>&gt;<i>            #log.info('Wrote %s.' % fnout)
</I>&gt;<i>            print 'Wrote %s.' % fnout
</I>&gt;<i>        except IOError, e:
</I>&gt;<i>            print e
</I>&gt;<i>            #log.error('Wrting to %s: %s' % (fnout, e))
</I>&gt;<i>        finally:
</I>&gt;<i>            fout.close()
</I>&gt;<i>
</I>&gt;<i>    def _getDataFailed(self, failure):
</I>&gt;<i>        print 'Failed to load RSS data from %s: %s' % (self.feedUrl,
</I>&gt;<i> failure.getErrorMessage())
</I>&gt;<i>        self.refreshing = None
</I>&gt;<i>        return failure
</I>&gt;<i>
</I>&gt;<i> class RSSFeedStorage(object):
</I>&gt;<i>
</I>&gt;<i>    def __init__(self, feeds):
</I>&gt;<i>        self.feeds = {}
</I>&gt;<i>        for groupName, url in feeds.iteritems():
</I>&gt;<i>            self.feeds[groupName] = RssFeed(groupName, url)
</I>&gt;<i>
</I>&gt;<i>    def refreshAllFeeds(self):
</I>&gt;<i>        refreshes = [feed.refreshIfNeeded() for feed in self.feeds.values()]
</I>&gt;<i>        return defer.DeferredList(refreshes).addCallback(self.stop_working).addErrback(self.handleError)
</I>&gt;<i>
</I>&gt;<i>    def stop_working(self, data):
</I>&gt;<i>        reactor.stop()
</I>&gt;<i>        print 'Reactor stopped'
</I>&gt;<i>
</I>&gt;<i>    def handleError(self, failure):
</I>&gt;<i>        print failure
</I>&gt;<i>
</I>&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;<i>
</I>&gt;<i>          {execution code goes here]
</I>&gt;<i>
</I>&gt;<i> On Mon, Jan 5, 2009 at 11:53 AM, Drew Smathers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">drew.smathers at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> On Sun, Jan 4, 2009 at 11:23 PM, Robert Hancock
</I>&gt;&gt;<i> &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">hancock.robert at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i> How many urls are in url_tuples?
</I>&gt;&gt;&gt;<i> 4 - 32
</I>&gt;&gt;&gt;&gt;<i> Is there a reason why you're using just one deferred?
</I>&gt;&gt;&gt;<i> What is the advantage of using more?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Concurrency.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -Drew
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051475.html">[Twisted-Python] Looping
</A></li>
	<LI>Next message (by thread): <A HREF="051468.html">[Twisted-Python] Looping
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51476">[ date ]</a>
              <a href="thread.html#51476">[ thread ]</a>
              <a href="subject.html#51476">[ subject ]</a>
              <a href="author.html#51476">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
