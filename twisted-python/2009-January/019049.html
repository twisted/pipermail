<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Tracebacks%20being%20dropped%20from%20exceptions%20when%0A%09using%20inlineCallbacks&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019053.html">
   <LINK REL="Next"  HREF="019051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Tracebacks%20being%20dropped%20from%20exceptions%20when%0A%09using%20inlineCallbacks&In-Reply-To="
       TITLE="[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks">terry at jon.es
       </A><BR>
    <I>Sat Jan 17 12:11:09 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019053.html">[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
</A></li>
        <LI>Next message: <A HREF="019051.html">[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19049">[ date ]</a>
              <a href="thread.html#19049">[ thread ]</a>
              <a href="subject.html#19049">[ subject ]</a>
              <a href="author.html#19049">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Glyph

&gt;&gt;&gt;&gt;&gt;<i> &quot;glyph&quot; == glyph  &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A>&gt; writes:
</I>glyph&gt; It sounds like the real issue here is that we don't have a channel
glyph&gt; to communicate a &quot;cleaned traceback&quot; (i.e., failure with stringified
glyph&gt; frames, but no traceback) from one bit of code to another?

Yes, now that I better understand what's going on with cleaning failures, I
think that's completely accurate.

glyph&gt; 1. More of this discussion should be on a ticket.  The mailing list
glyph&gt; is good for getting discussions started and figuring out what needs
glyph&gt; to be done, but now we're talking about the technical specifics of
glyph&gt; resolving a specific problem.  Someone (terry?) should take the
glyph&gt; specifics in the email that started this thread and file an
glyph&gt; appropriate ticket.

OK, I will do that, because I do still think there is a problem. Code below.

glyph&gt; 2. When filing that ticket, I'd really like a full working example
glyph&gt; of inlineCallbacks not showing a traceback to play with, not just
glyph&gt; examples of portions of the problem.  The obvious example I tried,

glyph&gt; from twisted.internet.defer import inlineCallbacks

glyph&gt; def buggy2():
glyph&gt;     raise RuntimeError(&quot;Whoops!&quot;)

glyph&gt; @inlineCallbacks
glyph&gt; def buggy():
glyph&gt;     yield buggy2()

glyph&gt; buggy()

glyph&gt; actually prints a nice descriptive traceback.

That's because buggy2 is raising an exception, there's no failure coming
back via a deferred into buggy (where its traceback would ultimately be
replaced with None in cleanFailure).

Here's a example:

    from twisted.internet import reactor, defer

    def ok(r): print 'OK', r
    def nok(r): print 'FAILED', r

    def two():
        try:
            1 / 0
        except Exception:
            return defer.fail()

    @defer.inlineCallbacks
    def one():
        yield two()

    def zero():
        one().addCallbacks(ok, nok).addBoth(lambda _: reactor.stop())

    reactor.callLater(0, zero)
    reactor.run()


Because two returns a deferred whose errback has been called, one gets a
result that's a failure and that failure gets cleaned.  The output of
running this example is:

    FAILED [Failure instance: Traceback: &lt;type 'exceptions.ZeroDivisionError'&gt;: integer division or modulo by zero
    /usr/lib/python2.5/site-packages/twisted/internet/posixbase.py:228:mainLoop
    /usr/lib/python2.5/site-packages/twisted/internet/base.py:561:runUntilCurrent
    five.py:17:zero
    /usr/lib/python2.5/site-packages/twisted/internet/defer.py:813:unwindGenerator
    --- &lt;exception caught here&gt; ---
    /usr/lib/python2.5/site-packages/twisted/internet/defer.py:724:_inlineCallbacks
    five.py:14:one
    ]

Showing the exception caught on line 14 (in one) not line 8. If you look at
the deferred that comes back from calling two, its failure result has None
as its tb attribute (via the process described in my original mail).


However if we replace one with a version that doesn't use inlineCallbacks:

    def one():
        return two()

Then the failure has the original traceback:

    FAILED [Failure instance: Traceback: &lt;type 'exceptions.ZeroDivisionError'&gt;: integer division or modulo by zero
    /usr/lib/python2.5/site-packages/twisted/internet/posixbase.py:228:mainLoop
    /usr/lib/python2.5/site-packages/twisted/internet/base.py:561:runUntilCurrent
    five.py:17:zero
    five.py:14:one
    --- &lt;exception caught here&gt; ---
    five.py:8:two
    ]


I'll file a ticket and we can take discussion about what to do into the
tracker.

Thanks!

Terry


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019053.html">[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
</A></li>
	<LI>Next message: <A HREF="019051.html">[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19049">[ date ]</a>
              <a href="thread.html#19049">[ thread ]</a>
              <a href="subject.html#19049">[ subject ]</a>
              <a href="author.html#19049">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
