<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Tracebacks%20being%20dropped%20from%20exceptions%20when%0A%09using%20inlineCallbacks&In-Reply-To=18795.61464.631046.43215%40jon.es">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019012.html">
   <LINK REL="Next"  HREF="019044.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks</H1>
    <B>Phil Christensen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Tracebacks%20being%20dropped%20from%20exceptions%20when%0A%09using%20inlineCallbacks&In-Reply-To=18795.61464.631046.43215%40jon.es"
       TITLE="[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks">phil at bubblehouse.org
       </A><BR>
    <I>Fri Jan 16 19:28:06 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019012.html">[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
</A></li>
        <LI>Next message: <A HREF="019044.html">[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19043">[ date ]</a>
              <a href="thread.html#19043">[ thread ]</a>
              <a href="subject.html#19043">[ subject ]</a>
              <a href="author.html#19043">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Jan 12, 2009, at 8:36 PM, Terry Jones wrote:
&gt;<i> I think I've finally gotten to the bottom of why exceptions  
</I>&gt;<i> sometimes lose
</I>&gt;<i> their tracebacks when using inlineCallbacks.
</I>[snip]
&gt;<i> We make a failure object, it has a
</I>&gt;<i> traceback, but after passing it to the errback method on a deferred  
</I>&gt;<i> the
</I>&gt;<i> traceback is gone.
</I>&gt;<i>
</I>&gt;<i> This happens because _runCallbacks in defer.py finds no call/errback
</I>&gt;<i> functions to call on the deferred, drops into this code:
</I>&gt;<i>
</I>&gt;<i>        if isinstance(self.result, failure.Failure):
</I>&gt;<i>            self.result.cleanFailure()
</I>&gt;<i>
</I>&gt;<i> which sets the __dict__ on the failure object to the result of the
</I>&gt;<i> failure's __getstate__ method, which sets the traceback to None:
</I>&gt;<i>
</I>&gt;<i>        # added 2003-06-23. See comment above in __init__
</I>&gt;<i>        c['tb'] = None
</I>&gt;<i>
</I>&gt;<i> But the comment in __init__ seems to have been deleted.
</I>
The comment was this:

         # added 2003-06-23 by Chris Armstrong. Yes, I actually have a
         # use case where I need this traceback object, and I've made
         # sure that it'll be cleaned up.
         self.tb = tb

presumably referring to the problem with keeping references to  
tracebacks that was a potential pitfall in the Python version of that  
time. That's a non-issue since Python 2.2, though, which is probably  
why the comment got deleted.

Originally all __getstate__ did was stringify the object's state,  
which is probably why cleanFailure calls it directly. It looks to me  
like most of the code from __getstate__ should really be moved into a  
separate method, which would be called from cleanFailure as well as  
__getstate__.

This assumes that __getstate__ would still set c['tb'] to None, but  
that cleanFailure would not. I'm not sure what the repercussions of  
this would be, though. It seems the old problem with keeping  
references to tracebacks is less of an issue now, based on this from  
the current Python docs:

&gt;<i> Note Beginning with Python 2.2, such cycles are automatically  
</I>&gt;<i> reclaimed when garbage collection is enabled and they become  
</I>&gt;<i> unreachable, but it remains more efficient to avoid creating cycles.
</I>
I'd appreciate any feedback.

-phil


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019012.html">[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
</A></li>
	<LI>Next message: <A HREF="019044.html">[Twisted-Python] Tracebacks being dropped from exceptions when	using inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19043">[ date ]</a>
              <a href="thread.html#19043">[ thread ]</a>
              <a href="subject.html#19043">[ subject ]</a>
              <a href="author.html#19043">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
