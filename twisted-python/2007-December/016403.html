<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Advise for heavy concurrency
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Advise%20for%20heavy%20concurrency&In-Reply-To=02cf01c834b4%24ad950000%2408bf0000%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016401.html">
   <LINK REL="Next"  HREF="016404.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Advise for heavy concurrency</H1>
    <B>Tristan Seligmann</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Advise%20for%20heavy%20concurrency&In-Reply-To=02cf01c834b4%24ad950000%2408bf0000%24%40com"
       TITLE="[Twisted-Python] Advise for heavy concurrency">mithrandi at mithrandi.za.net
       </A><BR>
    <I>Sun Dec  2 07:21:25 EST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="016401.html">[Twisted-Python] Advise for heavy concurrency
</A></li>
        <LI>Next message: <A HREF="016404.html">[Twisted-Python] Advise for heavy concurrency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16403">[ date ]</a>
              <a href="thread.html#16403">[ thread ]</a>
              <a href="subject.html#16403">[ subject ]</a>
              <a href="author.html#16403">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>* Alec Matusis &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">matusis at yahoo.com</A>&gt; [2007-12-01 23:26:38 -0800]:

&gt;<i> &gt; Because it is not a supported use of the API.  Twisted APIs, unless
</I>&gt;<i> &gt; other-
</I>&gt;<i> &gt; wise documented, are not thread safe and can only be called from the
</I>&gt;<i> &gt; thread
</I>&gt;<i> &gt; in which the reactor is running.
</I>&gt;<i> 
</I>&gt;<i> Then I do not understand when it is safe to use 
</I>&gt;<i> 
</I>&gt;<i> t.i.threads.deferToThread(f, clients) ?
</I>
The code in f, or in functions called from f, must not invoke any
functions in the Twisted API other than reactor.callFromThread. The same
goes for a thread created any other way (eg. with callInThread).

&gt;<i> I was thinking of calling this from the main reactor thread, where f is
</I>&gt;<i> 
</I>&gt;<i> def f(clients):
</I>&gt;<i>     for client in clients:
</I>&gt;<i>         client.protocol.transport.write('hello')
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This function would not even have a deferred attached to it. 
</I>&gt;<i> Is the point that it's not thread-safe to have Twisted API calls
</I>&gt;<i> inside the function f?
</I>
Yes, that is basically the point; the only API that is thread-safe is
callFromThread; any other Twisted function must be invoked from the
reactor thread.

If this loop is really blocking for too long, you could use something
like the following, which cooperatively distributes the work over
several timeslices; you'll need to check that the default scheduler
performs the work fast enough for your purposes, though.

from twisted.internet.task import coiterate

def f(clients):
    for client in clients:
        client.protocol.transport.write('hello')
        yield None

coiterate(f)
-- 
mithrandi, i Ainil en-Balandor, a faer Ambar
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 197 bytes
Desc: Digital signature
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20071202/8efaa016/attachment.pgp">http://twistedmatrix.com/pipermail/twisted-python/attachments/20071202/8efaa016/attachment.pgp</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016401.html">[Twisted-Python] Advise for heavy concurrency
</A></li>
	<LI>Next message: <A HREF="016404.html">[Twisted-Python] Advise for heavy concurrency
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16403">[ date ]</a>
              <a href="thread.html#16403">[ thread ]</a>
              <a href="subject.html#16403">[ subject ]</a>
              <a href="author.html#16403">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
