<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Simple ssh problem, please help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Simple%20ssh%20problem%2C%20please%20help&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025569.html">
   <LINK REL="Next"  HREF="025571.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Simple ssh problem, please help</H1>
    <B>Kevin Ting</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Simple%20ssh%20problem%2C%20please%20help&In-Reply-To="
       TITLE="[Twisted-Python] Simple ssh problem, please help">gwkin1989 at gmail.com
       </A><BR>
    <I>Thu May 24 12:52:25 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="025569.html">[Twisted-Python] deferLater with trial issue
</A></li>
        <LI>Next message: <A HREF="025571.html">[Twisted-Python] deferLater with trial issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25570">[ date ]</a>
              <a href="thread.html#25570">[ thread ]</a>
              <a href="subject.html#25570">[ subject ]</a>
              <a href="author.html#25570">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone, I am a beginner to Twisted so any help would be appreciated.

I got an example code from the Twisted, Networking Programming Essentials
book:

from twisted.conch import error
from twisted.conch.ssh import transport, connection, keys, userauth,
channel, common
from twisted.internet import defer, protocol, reactor

class ClientCommandTransport(transport.SSHClientTransport):
    def __init__(self, username, password, command):
        self.username = username
        self.password = password
        self.command = command
        print &quot;Transport Created&quot;

    def verifyHostKey(self, pubKey, fingerprint):
        print &quot;In Verify Host Key&quot;
        return defer.succeed(True)

    def connectionSecure(self):
        print &quot;In Connection Secure&quot;
        temp = PasswordAuth(self.username, self.password,
ClientConnection(self.command))
        print &quot;Created Everything&quot;
        self.requestService(temp)
        print &quot;Double Check&quot;

class PasswordAuth(userauth.SSHUserAuthClient):
    def __init__(self, user, password, connection):
        userauth.SSHUserAuthClient.__init__(self, user, connection)
        self.password = password
        print &quot;init password auth&quot;

    def getPassword(self, prompt=None):
        print &quot;In getPassword&quot;
        return defer.succeed(self.password)

class ClientConnection(connection.SSHConnection):
    def __init__(self, cmd, *args, **kwargs):
        print &quot;Init Client Connection&quot;
        connection.SSHConnection.__init__(self)
        print &quot;Next line of Client Connection&quot;
        self.command = cmd

    def serviceStarted(self):
        print &quot;Service Started&quot;
        self.openChannel(CommandChannel(self.command, conn=self))

class CommandChannel(channel.SSHChannel):
    name = 'session'

    def __init__(self, command, *args, **kwargs):
        channel.SSHChannel.__init__(self, *args, **kwargs)
        self.command = command

    def channelOpen(self, data):
        print (&quot;Channel was opened&quot;)
        self.conn.sendRequest(self,'exec',common.NS(self.command),wantReply
= True).addCallback(self._gotResponse)

    def _gotResponse(self,_):
        self.conn.sendEOF(self)

    def dataReceived(self, data):
        print data

    def closed(self):
        print(&quot;###### Entered Closed #####&quot;)
self.loseConnection()
        reactor.stop()
        print(&quot;##### Done with Closed ####&quot;)

class ClientCommandFactory(protocol.ClientFactory):
    def __init__(self, username, password, command):
        self.username = username
        self.password = password
        self.command = command

    def buildProtocol(self,addr):
        protocol = ClientCommandTransport(
            self.username, self.password, self.command)
        return protocol

if __name__ == &quot;__main__&quot;:
    import sys, getpass
    server = sys.argv[1]
    command = sys.argv[2]
    username = raw_input(&quot;Username: &quot;)
    password = getpass.getpass(&quot;Password: &quot;)
    factory = ClientCommandFactory(username, password, command)
    reactor.connectTCP(server, 22, factory)
    reactor.run()



*************************************************************

But after running this, I get this Unhandled error.  Which is strange
because the reactor is being successfully stopped.  Does anyone have any
clue what this means and how I should go about fixing it?  Thanks!!!!!

Unhandled Error
Traceback (most recent call last):
  File &quot;/usr/lib/python2.7/dist-packages/twisted/internet/posixbase.py&quot;,
line 586, in _doReadOrWrite
    why = selectable.doRead()
  File &quot;/usr/lib/python2.7/dist-packages/twisted/internet/tcp.py&quot;, line
199, in doRead
    rval = self.protocol.dataReceived(data)
  File &quot;/usr/lib/python2.7/dist-packages/twisted/conch/ssh/transport.py&quot;,
line 438, in dataReceived
    self.dispatchMessage(messageNum, packet[1:])
  File &quot;/usr/lib/python2.7/dist-packages/twisted/conch/ssh/transport.py&quot;,
line 460, in dispatchMessage
    messageNum, payload)
--- &lt;exception caught here&gt; ---
  File &quot;/usr/lib/python2.7/dist-packages/twisted/python/log.py&quot;, line 84,
in callWithLogger
    return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
  File &quot;/usr/lib/python2.7/dist-packages/twisted/python/log.py&quot;, line 69,
in callWithContext
    return context.call({ILogContext: newCtx}, func, *args, **kw)
  File &quot;/usr/lib/python2.7/dist-packages/twisted/python/context.py&quot;, line
118, in callWithContext
    return self.currentContext().callWithContext(ctx, func, *args, **kw)
  File &quot;/usr/lib/python2.7/dist-packages/twisted/python/context.py&quot;, line
81, in callWithContext
    return func(*args,**kw)
  File &quot;/usr/lib/python2.7/dist-packages/twisted/conch/ssh/service.py&quot;,
line 44, in packetReceived
    return f(packet)
  File &quot;/usr/lib/python2.7/dist-packages/twisted/conch/ssh/connection.py&quot;,
line 314, in ssh_CHANNEL_REQUEST
    channel = self.channels[localChannel]
exceptions.KeyError: 0
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20120524/6387c8f8/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20120524/6387c8f8/attachment.htm</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025569.html">[Twisted-Python] deferLater with trial issue
</A></li>
	<LI>Next message: <A HREF="025571.html">[Twisted-Python] deferLater with trial issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25570">[ date ]</a>
              <a href="thread.html#25570">[ thread ]</a>
              <a href="subject.html#25570">[ subject ]</a>
              <a href="author.html#25570">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
