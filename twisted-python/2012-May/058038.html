<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Getting rid of &quot;DirtyReactorWarning&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Getting%20rid%20of%20%22DirtyReactorWarning%22&In-Reply-To=%3C20120518202139.30694.1712291274.divmod.xquotient.30%40localhost6.localdomain6%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="058027.html">
   <LINK REL="Next"  HREF="058062.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Getting rid of &quot;DirtyReactorWarning&quot;</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Getting%20rid%20of%20%22DirtyReactorWarning%22&In-Reply-To=%3C20120518202139.30694.1712291274.divmod.xquotient.30%40localhost6.localdomain6%3E"
       TITLE="[Twisted-Python] Getting rid of &quot;DirtyReactorWarning&quot;">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri May 18 14:21:39 MDT 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="058027.html">[Twisted-Python] Getting rid of &quot;DirtyReactorWarning&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="058062.html">[Twisted-Python] Getting rid of &quot;DirtyReactorWarning&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58038">[ date ]</a>
              <a href="thread.html#58038">[ thread ]</a>
              <a href="subject.html#58038">[ subject ]</a>
              <a href="author.html#58038">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15 May, 10:26 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">itamar at itamarst.org</A> wrote:
&gt;<i>I have a ticket open for allowing tests that look like this, where each
</I>&gt;<i>run has a new reactor instance:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>def test_somethingShouldHappen(self, reactor):
</I>&gt;<i>      result = []
</I>&gt;<i>      reactor.listenTCP(...)
</I>&gt;<i>      self.runReactor(reactor)
</I>&gt;<i>      self.assertEqual(result, [&quot;hooray&quot;])
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Further thought suggests however that this doesn't add much,
</I>&gt;<i>necessarily, over the current &quot;return a Deferred&quot; idiom for most users.
</I>&gt;<i>Experience with ReactorBuilder framework that has similar testing
</I>&gt;<i>mechanism suggests it's far too easy to fail to stop the reactor.
</I>&gt;<i>Moreover, things like coiterate() don't work since they rely on
</I>&gt;<i>pre-imported global reactor, and given the &quot;from twisted.internet 
</I>&gt;<i>import
</I>&gt;<i>reactor&quot; idiom this testing style won't work well for many people's 
</I>&gt;<i>code.
</I>&gt;<i>
</I>&gt;<i>But! ReactorBuilder tests are superior in one way: no
</I>&gt;<i>DirtyReactorWarning. You don't have to wait until all connections are
</I>&gt;<i>closed, which is difficult, or make sure to cancel every timeout. This
</I>&gt;<i>makes test writing simpler.
</I>&gt;<i>
</I>&gt;<i>Perhaps we should get rid of DirtyReactorWarning for regular
</I>&gt;<i>Deferred-returning tests as well, then. We have all the infrastructure
</I>&gt;<i>we need, after all, for canceling scheduled events and disconnecting 
</I>&gt;<i>all
</I>&gt;<i>descriptors. We might want to log when we do so, to help debug things,
</I>&gt;<i>but we already have cleanup code mostly implemented in trial anyway, 
</I>&gt;<i>and
</I>&gt;<i>it seems like DirtyReactorWarning doesn't usually make future tests 
</I>&gt;<i>fail
</I>&gt;<i>anyway since we do run cleanup.
</I>&gt;<i>
</I>&gt;<i>Threaded code might still be a problem, but that's the case for current
</I>&gt;<i>tests now, and even switching to a new style of tests as above would
</I>&gt;<i>only somewhat mitigate the issue.
</I>
I think you should talk to jml about his ideas for a new base 
`TestCase`-like class which is better factored with respect to its 
handling of Twisted-related reponsibilities.

I don't think just removing `DirtyReactorWarning` from all the places it 
is currently emitted is a good idea (if only because it is providing 
*us* value, and because new behavior merits new interfaces).

More generally, I don't think ReactorBuilder is the best approach for 
unit testing anything except reactor implementations, just as I don't 
think using a real reactor (with real time, real networking, etc) is the 
best way approach for unit testing application code that uses the 
reactor.

We need to keep improving our test doubles, documenting their usage, and 
porting our own test suite (the application-y parts, at least) to them.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="058027.html">[Twisted-Python] Getting rid of &quot;DirtyReactorWarning&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="058062.html">[Twisted-Python] Getting rid of &quot;DirtyReactorWarning&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58038">[ date ]</a>
              <a href="thread.html#58038">[ thread ]</a>
              <a href="subject.html#58038">[ subject ]</a>
              <a href="author.html#58038">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
