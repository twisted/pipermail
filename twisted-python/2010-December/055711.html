<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Modifying the logstring
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Modifying%20the%20logstring&In-Reply-To=%3CAANLkTik-eUxA5-aQh%3DTvhC9%2B%3DQT%3D5%3DkQvYmjngSs_vsk%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="055705.html">
   <LINK REL="Next"  HREF="055712.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Modifying the logstring</H1>
    <B>Einar S. Idsø</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Modifying%20the%20logstring&In-Reply-To=%3CAANLkTik-eUxA5-aQh%3DTvhC9%2B%3DQT%3D5%3DkQvYmjngSs_vsk%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Modifying the logstring">einar.twisted at norsk-esport.no
       </A><BR>
    <I>Tue Dec  7 06:14:26 MST 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="055705.html">[Twisted-Python] Modifying the logstring
</A></li>
        <LI>Next message (by thread): <A HREF="055712.html">[Twisted-Python] Mail content filter: How to avoid SMTP client finishing sending message before SMTP server finishes receiving it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55711">[ date ]</a>
              <a href="thread.html#55711">[ thread ]</a>
              <a href="subject.html#55711">[ subject ]</a>
              <a href="author.html#55711">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>To continue my monologue: For future reference, it is worth noting
that the code previously posted will not work for reconnecting clients
since only the first connection receives the modified logPrefix
method. A better approach is to bind logPrefix() in
onClientConnected() to ensure it is bound for each new connection.

def startClient(self):
    self.f = self.getFactory()
    reactor.connectTCP(self.ip, self.queryPort, self.f)

def f_onClientConnected(self, protocolInstance):
    def logPrefix():
        return &quot;whateveryouwant&quot;
    self.f.connection = protocolInstance
    self.f.connection.transport.logPrefix = logPrefix

def getFactory(self):
    f = ReconnectingClientFactory()
    f.protocol = whatever
    f.onClientConnected = self.f_onClientConnected
    return f

I am still in the dark when it comes to modifying the logstring in
other cases, though. I am sure I could transfer the results from my
UDP logger to my service using strings instead of bound methods, but
then the logstring would end up being simply [-], which is of no use
to me. Is there really no way in which I can tell Twisted that &quot;All
log messages generated by this object shall be on the following
format&quot;? It seems like such a simple task to accomplish, yet it
completely avoids me.

Also let me add that I am completely taken aback with the genius that
is Twisted Python. The more I work with it, the more I realise this.
Writing clients or servers for *anything* is so simple, and the
efficiency of the code, especially with respect to CPU-usage, is
wonderful. My application started by polling each server via an
external executable written in C, but now fetches info from the same
number of servers using protocols written in Python, and even gathers
a whole lot more info than before via event logs.CPU-usage has dropped
from 20% to 1%, and the memory footprint is only around 40 MB :)

Cheers,
Einar



On Mon, Dec 6, 2010 at 11:51 AM, Einar S. Idsø
&lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">einar.twisted at norsk-esport.no</A>&gt; wrote:
&gt;<i> I was able to modify the logstring for the TCP query by following a
</I>&gt;<i> similar approach to what I did to the UDP logger:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    def logPrefix(self):
</I>&gt;<i>        return self.connection.transport.protocol.__class__.__name__ +
</I>&gt;<i> &quot;, &quot; + str(self.id)
</I>&gt;<i>
</I>&gt;<i>    def startClient(self):
</I>&gt;<i>        self.f = self.factory(self, password=self.queryPassword)
</I>&gt;<i>        self.connection = reactor.connectTCP(self.ip, self.queryPort, self.f)
</I>&gt;<i>        self.connection.transport.logPrefix = self.logPrefix
</I>&gt;<i>
</I>&gt;<i> Perhaps not very elegant, but it does the job and allows me to get a
</I>&gt;<i> log prefix which not only tells me the protocol but also the exact
</I>&gt;<i> serverinstance.
</I>&gt;<i>
</I>&gt;<i> But is it even possibly to do something similar for the UDP scenario
</I>&gt;<i> where I have one UDP-logger which calls bound functions from the
</I>&gt;<i> individual server-representing instances to do the actual parsing? The
</I>&gt;<i> UDP-listener class is defined like this:
</I>&gt;<i>
</I>&gt;<i> class UDPListener(DatagramProtocol):
</I>&gt;<i>    _serverList = {}
</I>&gt;<i>
</I>&gt;<i>    def addParser(self, ip, port, f):
</I>&gt;<i>        self._serverList[(str(ip), int(port))] = f
</I>&gt;<i>
</I>&gt;<i>    def removeParser(self, ip, port):
</I>&gt;<i>        if (str(host), int(port)) in self._serverList:
</I>&gt;<i>            del self._serverList[(str(ip), int(port))]
</I>&gt;<i>
</I>&gt;<i>    def datagramReceived(self, data, (host, port)):
</I>&gt;<i>        #print &quot;received %r from %s:%d&quot; % (data, host, port)
</I>&gt;<i>        if (host, port) in self._serverList:
</I>&gt;<i>            self._serverList[(host, port)](data)
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Einar
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Dec 6, 2010 at 10:21 AM, Einar S. Idsø
</I>&gt;<i> &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">einar.twisted at norsk-esport.no</A>&gt; wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have an application which logs activity on a number of servers by
</I>&gt;&gt;<i> two methods:
</I>&gt;&gt;<i> 1. TCP-based queries (app is client)
</I>&gt;&gt;<i> 2. UDP-based logging (app is server)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Each server that is being logged is represented by an instance of a
</I>&gt;&gt;<i> server class. TCP-queries are performed by each instance at set
</I>&gt;&gt;<i> intervals, while the UDP-logs are gathered by a global logging
</I>&gt;&gt;<i> instance which listens to a specific port. Events for a given server
</I>&gt;&gt;<i> can be triggered by both protocols, but are handled by the server
</I>&gt;&gt;<i> instance. In other words: An instance of a server class gathers events
</I>&gt;&gt;<i> by polling the server via TCP /and/ by receiving strings from a UDP
</I>&gt;&gt;<i> logging instance which passes received datagrams as strings to the
</I>&gt;&gt;<i> correct instance.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Whenever a loggable event results from the TCP queries, the name of
</I>&gt;&gt;<i> the protocol class, which is a subclass of
</I>&gt;&gt;<i> twisted.internet.protocol.Protocol), is used as the logstring. That is
</I>&gt;&gt;<i> fine, as it allows me to distinguish between different server classes,
</I>&gt;&gt;<i> although I cannot distinguish between individual servers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, when a loggable event occurs on the UDP logging instance, it
</I>&gt;&gt;<i> writes out a longish protocol name which is the same for all the
</I>&gt;&gt;<i> different server classes that are subscribing to events on that UDP
</I>&gt;&gt;<i> port. I have managed to modify the string by doing the following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        self.udpLogger = reactor.listenUDP(myPort, UDPListener())
</I>&gt;&gt;<i>        self.udpLogger.logstr = &quot;UDPLogger&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yet when the logged string is passed, as a string, to a server
</I>&gt;&gt;<i> instance for processing, the logstring for any result remains
</I>&gt;&gt;<i> &quot;UDPLogger&quot; no matter how I pass it or what I do to it. I suppose it
</I>&gt;&gt;<i> is expected behaviour that the protocol should &quot;follow&quot; a result, no
</I>&gt;&gt;<i> matter how it is processed down the line, but is there any way in
</I>&gt;&gt;<i> which I can alter the logstring so that instead of &quot;UDPLogger&quot; or the
</I>&gt;&gt;<i> name of the protocol class, it instead uses the server id or any other
</I>&gt;&gt;<i> value that I specify?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What I am getting in my logs is:
</I>&gt;&gt;<i> 2010-11-30 10:23:09+0100 [CSS,client] Something happened on TCP
</I>&gt;&gt;<i> 2010-11-30 10:23:09+0100 [UDPLogger] Something happened on UDP
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What I would like is:
</I>&gt;&gt;<i> 2010-11-30 10:23:09+0100 [CSS (TCP),12345] Something happened on TCP
</I>&gt;&gt;<i> 2010-11-30 10:23:09+0100 [CSS (UDP),12345] Something happened on UDP
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> where 12345 is a unique identifier of the specific server. Or at least:
</I>&gt;&gt;<i> 2010-11-30 10:23:09+0100 [CSS,client] Something happened on TCP
</I>&gt;&gt;<i> 2010-11-30 10:23:09+0100 [CSS] Something happened on UDP
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> so that I know the result from UDP concerns a CSS-server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I hope this was possible to understand. Please let me know if anything
</I>&gt;&gt;<i> needs to be clarified. :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers,
</I>&gt;&gt;<i> Einar
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="055705.html">[Twisted-Python] Modifying the logstring
</A></li>
	<LI>Next message (by thread): <A HREF="055712.html">[Twisted-Python] Mail content filter: How to avoid SMTP client finishing sending message before SMTP server finishes receiving it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55711">[ date ]</a>
              <a href="thread.html#55711">[ thread ]</a>
              <a href="subject.html#55711">[ subject ]</a>
              <a href="author.html#55711">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
