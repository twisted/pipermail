<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] [Twisted-web] render_GET and memory consumption
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%5BTwisted-web%5D%20render_GET%20and%20memory%20consumption&In-Reply-To=%3C12CB770E-8539-4FAF-ABB6-798F362E9EA6%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="055744.html">
   <LINK REL="Next"  HREF="055746.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] [Twisted-web] render_GET and memory consumption</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%5BTwisted-web%5D%20render_GET%20and%20memory%20consumption&In-Reply-To=%3C12CB770E-8539-4FAF-ABB6-798F362E9EA6%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] [Twisted-web] render_GET and memory consumption">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Dec 23 23:13:40 MST 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="055744.html">[Twisted-Python] Python 2.6 with twisted on OSX
</A></li>
        <LI>Next message (by thread): <A HREF="055746.html">[Twisted-Python] [Twisted-web] render_GET and memory consumption
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55745">[ date ]</a>
              <a href="thread.html#55745">[ thread ]</a>
              <a href="subject.html#55745">[ subject ]</a>
              <a href="author.html#55745">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Cross-posting to Twisted core list because this is starting to get into general non-web stuff.  Future replies about this fork of the thread should go there.

On Dec 23, 2010, at 11:22 AM, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:

&gt;<i> On 22 Dec, 06:51 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A> wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Dec 21, 2010, at 2:24 PM, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:
</I>&gt;&gt;&gt;<i> Instead, you have to go all the way to producers/consumers, and only 
</I>&gt;&gt;&gt;<i> write more data to the transport buffer when it has finished dealing 
</I>&gt;&gt;&gt;<i> with what you previously gave it.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> While everybody should of course use producers and consumers, I feel 
</I>&gt;&gt;<i> like there should be a twisted core ticket for this behavior of 
</I>&gt;&gt;<i> transport buffering, and a twisted web ticket for this behavior of the 
</I>&gt;&gt;<i> request buffering.  The naive implementation _could_ be much cheaper 
</I>&gt;&gt;<i> memory-wise; at the very least, twisted.web.static.Data ought to do the 
</I>&gt;&gt;<i> smart thing.
</I>&gt;<i> 
</I>&gt;<i> Fixing Data sounds like a good idea.  I don't know what improvement to 
</I>&gt;<i> the transport buffering you're thinking of, though.  It doesn't seem 
</I>&gt;<i> like there is an obvious, generally correct fix.
</I>
Right now, FileDescriptor.write appends its input data directly to _tempDataBuffer.  So far, so good: no string mangling.

So let's say we do fd.write(header); fd.write(veryBigBody).

Then we start writing.

FileDescriptor.doWrite comes along and notices that the dataBuffer is empty.  The first thing it does in this case: ''.join(_tempDataBuffer); which copies the entire veryBigBody.

FileDescriptor is kinda sorta trying to avoid this problem by maintaining an 'offset' so it doesn't need to re-copy dataBuffer; it could use a similar tactic and do write()s out of individual chunks which are greater than SEND_LIMIT directly, rather than coalescing them together.

Or maybe we could wrap writev() instead of copying stuff at all?



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="055744.html">[Twisted-Python] Python 2.6 with twisted on OSX
</A></li>
	<LI>Next message (by thread): <A HREF="055746.html">[Twisted-Python] [Twisted-web] render_GET and memory consumption
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55745">[ date ]</a>
              <a href="thread.html#55745">[ thread ]</a>
              <a href="subject.html#55745">[ subject ]</a>
              <a href="author.html#55745">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
