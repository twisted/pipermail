<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Looking for help dealing with ClientService	reconnections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20help%20dealing%20with%20ClientService%0A%09reconnections&In-Reply-To=%3CCADzPF4u2jMxfoEn6oxhjLgoATZ%3DkacDuL4J2ji2-HYyH57bd_Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="062774.html">
   <LINK REL="Next"  HREF="062793.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Looking for help dealing with ClientService	reconnections</H1>
    <B>Daniel Sutcliffe</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20help%20dealing%20with%20ClientService%0A%09reconnections&In-Reply-To=%3CCADzPF4u2jMxfoEn6oxhjLgoATZ%3DkacDuL4J2ji2-HYyH57bd_Q%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Looking for help dealing with ClientService	reconnections">dansut at gmail.com
       </A><BR>
    <I>Tue May 10 10:52:42 MDT 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="062774.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
        <LI>Next message (by thread): <A HREF="062793.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62780">[ date ]</a>
              <a href="thread.html#62780">[ thread ]</a>
              <a href="subject.html#62780">[ subject ]</a>
              <a href="author.html#62780">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Glyph, I think you have given me a push back in the 'right'
direction - more thoughts and commentary embedded below if you, or
anyone else, has the time.

On May 6, 2016, at 10:19 AM, Daniel Sutcliffe &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt; wrote:
[...]
&gt;&gt;<i> The new ClientService class seems like it will fit my needs very
</I>&gt;&gt;<i> closely but I am struggling with how to handle the reconnections... I
</I>&gt;&gt;<i> have been using the whenConnected() method to grab the Protocol for
</I>&gt;&gt;<i> the initial connection and then use a method of this to poll the
</I>&gt;&gt;<i> connected slave. When the connection is lost I get an errback from
</I>&gt;&gt;<i> this method's deferred which I use as a signal to abandon the Protocol
</I>&gt;&gt;<i> and call whenConnected() again... at this point I have an issue though
</I>&gt;&gt;<i> as the returned deferred immediately gives me a callback with the same
</I>&gt;&gt;<i> Protocol which has just lost its connection, and thus loop...
</I>
On Mon, May 9, 2016 at 6:19 PM, Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
&gt;<i> If you want a hook each time a new protocol is created, you're probably
</I>&gt;<i> better off writing a wrapper protocol factory, and passing that to your
</I>&gt;<i> ClientService, then doing any set-up work you want to do in your
</I>&gt;<i> buildProtocol implementation, which delegates to the real, pymodbus
</I>&gt;<i> implementation.
</I>
Understood, if this is the way the framework is intended to be used I
realize doing anything else is going to be fighting against the flow.

However, just to probe the situation I found myself in further, for
the sake probing broken code to see how it might be fixed:

Given the ClientService.whenConnected() method is intended to provide
access to my connected Protocol through the deferred it returns, is it
not a little unfriendly that this Protocol may turn out to be
disconnected? OK occasionally due to timing but for this to be a
possible condition which can loop with the same disconnected Protocol
returned until the ClientService has its _currentConnection set to
None, suggests to me that I can't safely use my Protocol from
whenConnected() for much other than as a notification the first
connection has occurred... but how do I avoid this?

I have looked at the source and it seems to me the fact that the
connection has been lost should bubble up to the ClientService through
a t.a.i._DisconnectFactory and t.a.i._ReconnectingProtocolProxy once
my Protocol's connectionLost() is called. My issue seems to be that I
errback on a Protocol method's deferred returned to code at or above
the ClientService level which gives up on that Protocol and calls
whenConnected() to get the next one, only the Protocol's
connectionLost() has yet to be called and then doesn't have chance to
because my code is looping around calling whenConnected() and getting
the same Protocol back. I hope that makes sense :-/

My Q on this is if I should be internally calling my Protocol's
connectionLost() so it can bubble up to the ClientService before I
errback on the Protocol method - whose responsibility is it to call
this?

&gt;&gt;<i> Before I got on this mailing list I posted this Q to stackoverflow
</I>&gt;&gt;<i> with some example code:
</I>&gt;&gt;<i>    <A HREF="http://stackoverflow.com/q/37061807/3448214">http://stackoverflow.com/q/37061807/3448214</A>
</I>&gt;&gt;<i> but no solution or much attention there yet.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As I say there, I realize I have probably just made a bad pattern
</I>&gt;&gt;<i> choice for how to use this API, but I have not been able to work out a
</I>&gt;&gt;<i> better choice which seems clean and fits my needs/understanding well.
</I>&gt;&gt;<i> I have tried deriving my own Protocol/Factory and handling the polling
</I>&gt;&gt;<i> there but this seems to get really messy once I start to add code to
</I>&gt;&gt;<i> get the collected data to a destination at that level, involving
</I>&gt;&gt;<i> giving the Protocol too much knowledge of how the data is to be
</I>&gt;&gt;<i> handled.
</I>&gt;<i>
</I>&gt;<i> I am curious as to why you say that this is &quot;messy&quot;.
</I>
Honestly, this was just a gut feeling at the time, probably more
sourced in my implementation from lack of experience in using Twisted;
after reading around the subject, looking at many more examples, and
your advice, I think I am convinced I need to back to looking at my
own Protocol derived from the pymodbus one with a Factory that
contains the persistent config and access to an interface to pump the
polled data upstream.

&gt;&gt;<i> Any advice, good patterns, or pointers to other projects which do
</I>&gt;&gt;<i> something similar is appreciated,
</I>&gt;<i>
</I>&gt;<i> I spent a while thinking about your question, and I'm sorry that I can't give
</I>&gt;<i> a more thorough answer, but I think you need to be a bit more specific
</I>&gt;<i> about what it is you don't like about your potential solution.  It seems to me
</I>&gt;<i> that having a delegating Factory, especially if all you need to do is set up
</I>&gt;<i> some state on each Protocol that gets produced, should be sufficient...
</I>
Looking at the code again I think it just seemed to make sense to me
at the time to have something that is (or has) a ClientService be the
object I am calling a DataSource have more control over when it polls
that data and what it does with it - and not to have to make the
Protocol and its Factory aware of this at all. Does that make it any
clearer? I am happy to push ahead with building this into my
Factory/Protocol if that is more normal usage for Twisted as I am sure
there will be benefits of encapsulating it here beyond the other side
I was seeing during that moment of confusion.

Thanks for the advice, I think it was enough to nudge me in a
direction that will work better to get me going, and if with more
experience other usage makes more sense I can always refactor,
refactor, refactor :)
Cheers
/dan
-- 
Daniel Sutcliffe &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="062774.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
	<LI>Next message (by thread): <A HREF="062793.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62780">[ date ]</a>
              <a href="thread.html#62780">[ thread ]</a>
              <a href="subject.html#62780">[ subject ]</a>
              <a href="author.html#62780">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
