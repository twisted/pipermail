<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Looking for help dealing with ClientService	reconnections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20help%20dealing%20with%20ClientService%0A%09reconnections&In-Reply-To=%3CCADzPF4t8ZDo7pX%2BzVFVHvw9o1qVQW3Vc%2BuRT%3D2yf-RJrQ745XQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="062767.html">
   <LINK REL="Next"  HREF="062774.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Looking for help dealing with ClientService	reconnections</H1>
    <B>Daniel Sutcliffe</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20help%20dealing%20with%20ClientService%0A%09reconnections&In-Reply-To=%3CCADzPF4t8ZDo7pX%2BzVFVHvw9o1qVQW3Vc%2BuRT%3D2yf-RJrQ745XQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Looking for help dealing with ClientService	reconnections">dansut at gmail.com
       </A><BR>
    <I>Mon May  9 14:09:39 MDT 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="062767.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
        <LI>Next message (by thread): <A HREF="062774.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62769">[ date ]</a>
              <a href="thread.html#62769">[ thread ]</a>
              <a href="subject.html#62769">[ subject ]</a>
              <a href="author.html#62769">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the response Kevin, a few individual replies embedded below:

On Sat, May 7, 2016 at 3:19 PM, Kevin Conway &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">kevinjacobconway at gmail.com</A>&gt; wrote:
&gt;<i> I'm still working through your code example and trying to get a better grasp
</I>&gt;<i> of what, exactly, you're trying to implement as far as client behavior is
</I>&gt;<i> concerned. In the meantime, it sounds, on the surface, like you are trying
</I>&gt;<i> to implement a form of the ReconnectingClientFactory:
</I>&gt;<i> <A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.protocol.ReconnectingClientFactory.html.">http://twistedmatrix.com/documents/current/api/twisted.internet.protocol.ReconnectingClientFactory.html.</A>
</I>
pymodbus actually has a pymodbus.client.async.ModbusClientFactory
which is derived from
twisted.internet.protocol.ReconnectingClientFactory
  <A HREF="http://pymodbus.readthedocs.io/en/latest/library/async-client.html">http://pymodbus.readthedocs.io/en/latest/library/async-client.html</A>

&gt;<i> Your client protocol must be factory aware and call the resetDelay method on
</I>&gt;<i> the factory when a connection is made, but the factory will handle
</I>&gt;<i> reconnecting and generating a new protocol instance. Is that similar to what
</I>&gt;<i> you are trying to accomplish? Maybe see also
</I>&gt;<i> <A HREF="http://twistedmatrix.com/documents/current/core/howto/clients.html#reconnection">http://twistedmatrix.com/documents/current/core/howto/clients.html#reconnection</A>
</I>&gt;<i> for a quick example of using the reconnecting factory.
</I>
I had built working tests using the docs you link to and understand
the way it works, but when Twisted 16.1 came out I decided that as I
was writing fresh code I probably ought to use the suggested new API.
After reading up and checking the source for ClientService it seemed
just what I was after; offering the advantages that Glyph mentioned,
and simplifying the amount of code I had to write (and maintain),
especially as my intention was to use twistd and thus Services.

It was only when I started to implement this that I felt my
inexperience with Twisted's ways of doing things was holding me back
and couldn't see a clear direction of how to build my architecture
around it.

Initially I used my own Protocol class derived from
pymodbus.client.async.ModbusClientProtocol that handled the polling
internally with a Factory that was aware of this class based on
ClientFactory (not ReconnectingClientFactory) that stored the
persistent info (poll rate, etc). This worked well with ClientService
and reconnections happened as expected but once I started to try and
evolve my code to consolidate (from many ClientServices polling
various PLCs) and write out the data (to MySQL) the model felt like
the focus was in the wrong place and that maybe I should be focussing
more on making a derivation of the ClientService have more control of
the polling and just using the Protocol provided by pymodbus as-is.

After hitting the problem I described below, I decided it was time to
ask those with more Twisted experience what the most appropriate way
to approach this problem was. Am I better off going back to doing
polling in Protocol with a Factory that provides ways to pump the data
back upstream to where it needs to be consolidated, and not rolling my
own ClientService to control it? or do I just need a better way of
getting my ClientService to be aware of the latest connection? Maybe
there's a pathway in between, or even something I haven't yet thought
of?

If anyone does have the time and desire to help me with this but feels
they need more info from me or background then please just ask, and I
will provide and be most appreciative :)

Cheers
/dan

On Fri, May 6, 2016, 12:23 Daniel Sutcliffe &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt; wrote:
&gt;&gt;<i> Hello all, my first post here - only been using Twisted for about a
</I>&gt;&gt;<i> month and am also a relative newcomer to Python but have been coding
</I>&gt;&gt;<i> professionally for 20+ years. I was attracted to Twisted and Python
</I>&gt;&gt;<i> for a particular project purely because after research it seemed to be
</I>&gt;&gt;<i> the best tool for the job, and have actually been enjoying both Python
</I>&gt;&gt;<i> and Twisted much more than I ever thought I would.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The project I am coding towards is creating a sensor data collection
</I>&gt;&gt;<i> gateway. First iteration needs are simply pulling data from ModBus TCP
</I>&gt;&gt;<i> slave PLCs and writing it to a MySQL database, but goals beyond that
</I>&gt;&gt;<i> are making the source of the data and its destination(s) very
</I>&gt;&gt;<i> flexible(pluggable). Therefore I am trying to create a good clean
</I>&gt;&gt;<i> architecture from the outset so as I iterate forwards I don't finish
</I>&gt;&gt;<i> up having to take too many steps backwards before heading forwards.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am using pymodbus to pull the data which works well for my devices,
</I>&gt;&gt;<i> has a twisted async API, and have created more than a few prototypes
</I>&gt;&gt;<i> that demonstrate all works as I expect. Where I am a bit stalled is
</I>&gt;&gt;<i> getting to grips with a good architecture that fulfills my needs - my
</I>&gt;&gt;<i> intention is that the application that meets my first goal will be a
</I>&gt;&gt;<i> twistd plugin.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The new ClientService class seems like it will fit my needs very
</I>&gt;&gt;<i> closely but I am struggling with how to handle the reconnections... I
</I>&gt;&gt;<i> have been using the whenConnected() method to grab the Protocol for
</I>&gt;&gt;<i> the initial connection and then use a method of this to poll the
</I>&gt;&gt;<i> connected slave. When the connection is lost I get an errback from
</I>&gt;&gt;<i> this method's deferred which I use as a signal to abandon the Protocol
</I>&gt;&gt;<i> and call whenConnected() again... at this point I have an issue though
</I>&gt;&gt;<i> as the returned deferred immediately gives me a callback with the same
</I>&gt;&gt;<i> Protocol which has just lost its connection, and thus loop...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Before I got on this mailing list I posted this Q to stackoverflow
</I>&gt;&gt;<i> with some example code:
</I>&gt;&gt;<i>     <A HREF="http://stackoverflow.com/q/37061807/3448214">http://stackoverflow.com/q/37061807/3448214</A>
</I>&gt;&gt;<i> but no solution or much attention there yet.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As I say there, I realize I have probably just made a bad pattern
</I>&gt;&gt;<i> choice for how to use this API, but I have not been able to work out a
</I>&gt;&gt;<i> better choice which seems clean and fits my needs/understanding well.
</I>&gt;&gt;<i> I have tried deriving my own Protocol/Factory and handling the polling
</I>&gt;&gt;<i> there but this seems to get really messy once I start to add code to
</I>&gt;&gt;<i> get the collected data to a destination at that level, involving
</I>&gt;&gt;<i> giving the Protocol too much knowledge of how the data is to be
</I>&gt;&gt;<i> handled.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any advice, good patterns, or pointers to other projects which do
</I>&gt;&gt;<i> something similar is appreciated,
</I>-- 
Daniel Sutcliffe &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="062767.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
	<LI>Next message (by thread): <A HREF="062774.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62769">[ date ]</a>
              <a href="thread.html#62769">[ thread ]</a>
              <a href="subject.html#62769">[ subject ]</a>
              <a href="author.html#62769">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
