<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Looking for help dealing with ClientService	reconnections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20help%20dealing%20with%20ClientService%0A%09reconnections&In-Reply-To=%3CCADzPF4vVs28PdjNDoDrnux8HXKwfz2hAzvAeaK4hB4PbFur4tA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030332.html">
   <LINK REL="Next"  HREF="030307.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Looking for help dealing with ClientService	reconnections</H1>
    <B>Daniel Sutcliffe</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20help%20dealing%20with%20ClientService%0A%09reconnections&In-Reply-To=%3CCADzPF4vVs28PdjNDoDrnux8HXKwfz2hAzvAeaK4hB4PbFur4tA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Looking for help dealing with ClientService	reconnections">dansut at gmail.com
       </A><BR>
    <I>Tue May 31 15:21:49 MDT 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="030332.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
        <LI>Next message: <A HREF="030307.html">[Twisted-Python] Twisted 16.2.0pre1 Release Announcement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30403">[ date ]</a>
              <a href="thread.html#30403">[ thread ]</a>
              <a href="subject.html#30403">[ subject ]</a>
              <a href="author.html#30403">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Delayed response here but hopefully it is still seen as worthwhile
discussion, sorry if it is seems to just be beating a dead horse ;)

On May 10, 2016, at 9:52 AM, Daniel Sutcliffe &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt; wrote:
&gt;<i> &gt; Given the ClientService.whenConnected() method is intended to provide
</I>&gt;<i> &gt; access to my connected Protocol through the deferred it returns, is it
</I>&gt;<i> &gt; not a little unfriendly that this Protocol may turn out to be
</I>&gt;<i> &gt; disconnected? OK occasionally due to timing but for this to be a
</I>&gt;<i> &gt; possible condition which can loop with the same disconnected Protocol
</I>&gt;<i> &gt; returned until the ClientService has its _currentConnection set to
</I>&gt;<i> &gt; None, suggests to me that I can't safely use my Protocol from
</I>&gt;<i> &gt; whenConnected() for much other than as a notification the first
</I>&gt;<i> &gt; connection has occurred... but how do I avoid this?
</I>
&gt;<i> whenConnected() is not intended to be used for &quot;give me each Protocol as it
</I>&gt;<i> is instantiated so that state can be set up&quot;, it is intended for API clients
</I>&gt;<i> which want to send a message to the current connection to just retrieve the
</I>&gt;<i> current connection so they can call a method on it.
</I>
I appreciate now this 'protocol/connection init' isn't what the
whenConnected() method was intended for, and it wasn't what I was
using it for when I came across my issue. However there seems to me to
be no documentary discouragement for using it this way... at least for
someone who is not as familiar with Twisted's common usage patterns

&gt;<i> I'm not sure what you mean by &quot;turn out to be disconnected&quot;.  The physical
</I>&gt;<i> reality of networking is that you might always encounter a transport which
</I>&gt;<i> has been disconnected but which you haven't received notification of its
</I>&gt;<i> disconnection yet.
</I>
The 'turns out to be disconnected' actually came from my acceptance
that network connections drop/fail and I have little control of how or
when this happens. Thus I may call a method on a Protocol at any time
only to find that it is not in a good state to handle my request.

My (misguided) goal was to call a method of the Protocol returned from
whenConnected() every so often to give it a task to do; my expectation
being that *when* the connection failed I would find out from the task
method's returned deferred and could then just fire off another
ClientService whenConnected() to get the next useful Protocol once it
is established, and then use this to continue giving the Protocol
tasks until it also ultimately fails...

&gt;<i> &gt; I have looked at the source and it seems to me the fact that the
</I>&gt;<i> &gt; connection has been lost should bubble up to the ClientService through
</I>&gt;<i> &gt; a t.a.i._DisconnectFactory and t.a.i._ReconnectingProtocolProxy once
</I>&gt;<i> &gt; my Protocol's connectionLost() is called. My issue seems to be that I
</I>&gt;<i> &gt; errback on a Protocol method's deferred returned to code at or above
</I>&gt;<i> &gt; the ClientService level which gives up on that Protocol and calls
</I>&gt;<i> &gt; whenConnected() to get the next one, only the Protocol's
</I>&gt;<i> &gt; connectionLost() has yet to be called and then doesn't have chance to
</I>&gt;<i> &gt; because my code is looping around calling whenConnected() and getting
</I>&gt;<i> &gt; the same Protocol back. I hope that makes sense :-/
</I>&gt;<i>
</I>&gt;<i> Let me try to rephrase: you call a protocol method which returns a Deferred;
</I>&gt;<i> you add an errback to that Deferred which calls whenConnected() to re-try,
</I>&gt;<i> but since the protocol hasn't disconnected yet, you get the same protocol
</I>&gt;<i> instance back, which is useless to you.
</I>
Thanks Glyph, that seems like exactly what I was trying to say.

&gt;<i> &gt; My Q on this is if I should be internally calling my Protocol's
</I>&gt;<i> &gt; connectionLost() so it can bubble up to the ClientService before I
</I>&gt;<i> &gt; errback on the Protocol method - whose responsibility is it to call
</I>&gt;<i> &gt; this?
</I>&gt;<i>
</I>&gt;<i> It's the framework's responsibility to call it.  You should not call it
</I>&gt;<i> yourself.  Your Protocol's connectionLost isn't going to bubble up to
</I>&gt;<i> ClientService anyway; you'd have to call your wrapper's connectionLost,
</I>&gt;<i> which would confuse its internal state, since the framework would call it
</I>&gt;<i> again right afterwards, and we definitely don't have test coverage for that,
</I>&gt;<i> since the framework will normally only call it once.
</I>
I'm glad that I got this mostly right in my head - it didn't feel
right for me to be calling this, or any similar method I could find.

&gt;<i> The right way to handle this would be to introduce a delay between re-tries.
</I>&gt;<i> It's generally a good idea to have such a delay for lots of reasons; you
</I>&gt;<i> don't want to overload your peer in the case of a transient failure.  As a
</I>&gt;<i> bonus, the fact that you've gone back up to the reactor loop to wait a while
</I>&gt;<i> means that the transport will be properly disconnected and whenConnected()
</I>&gt;<i> will do what you want.
</I>
I didn't even consider this as my thinking was along the lines of the
ClientService having the ability to handle the connection re-tries and
delays to avoid any overloading of the service it wraps.

It would be nice if there was something I could do in my Protocol task
method such that it didn't fire the errback on its deferred until its
Factory (and ultimately its Service in this case) had been made aware
the connection had failed. Does this not have to be done elsewhere in
Twisted or other projects using Twisted, or is the common pattern just
to introduce a delay to avoid any possible race condition?

My current intention is to have the Protocol's Factory handle the
assigning of tasks to its Protocol which seems the 'more normal'
direction to take, so any discussions above are purely for my
education and intellectual curiosity - I'm glad of any and all
feedback.

Cheers
/dan
-- 
Daniel Sutcliffe &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt;

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030332.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
	<LI>Next message: <A HREF="030307.html">[Twisted-Python] Twisted 16.2.0pre1 Release Announcement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30403">[ date ]</a>
              <a href="thread.html#30403">[ thread ]</a>
              <a href="subject.html#30403">[ subject ]</a>
              <a href="author.html#30403">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
