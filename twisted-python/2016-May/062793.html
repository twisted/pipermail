<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Looking for help dealing with ClientService	reconnections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20help%20dealing%20with%20ClientService%0A%09reconnections&In-Reply-To=%3CA88137BD-6D7C-4C39-B4CA-56832B4ECA1C%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="062780.html">
   <LINK REL="Next"  HREF="062864.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Looking for help dealing with ClientService	reconnections</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Looking%20for%20help%20dealing%20with%20ClientService%0A%09reconnections&In-Reply-To=%3CA88137BD-6D7C-4C39-B4CA-56832B4ECA1C%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Looking for help dealing with ClientService	reconnections">glyph at twistedmatrix.com
       </A><BR>
    <I>Sat May 21 15:54:53 MDT 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="062780.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
        <LI>Next message (by thread): <A HREF="062864.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62793">[ date ]</a>
              <a href="thread.html#62793">[ thread ]</a>
              <a href="subject.html#62793">[ subject ]</a>
              <a href="author.html#62793">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On May 10, 2016, at 9:52 AM, Daniel Sutcliffe &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Thanks Glyph, I think you have given me a push back in the 'right'
</I>&gt;<i> direction - more thoughts and commentary embedded below if you, or
</I>&gt;<i> anyone else, has the time.
</I>&gt;<i> 
</I>&gt;<i> On May 6, 2016, at 10:19 AM, Daniel Sutcliffe &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dansut at gmail.com</A>&gt; wrote:
</I>&gt;<i> [...]
</I>&gt;&gt;&gt;<i> The new ClientService class seems like it will fit my needs very
</I>&gt;&gt;&gt;<i> closely but I am struggling with how to handle the reconnections... I
</I>&gt;&gt;&gt;<i> have been using the whenConnected() method to grab the Protocol for
</I>&gt;&gt;&gt;<i> the initial connection and then use a method of this to poll the
</I>&gt;&gt;&gt;<i> connected slave. When the connection is lost I get an errback from
</I>&gt;&gt;&gt;<i> this method's deferred which I use as a signal to abandon the Protocol
</I>&gt;&gt;&gt;<i> and call whenConnected() again... at this point I have an issue though
</I>&gt;&gt;&gt;<i> as the returned deferred immediately gives me a callback with the same
</I>&gt;&gt;&gt;<i> Protocol which has just lost its connection, and thus loop...
</I>&gt;<i> 
</I>&gt;<i> On Mon, May 9, 2016 at 6:19 PM, Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;<i> If you want a hook each time a new protocol is created, you're probably
</I>&gt;&gt;<i> better off writing a wrapper protocol factory, and passing that to your
</I>&gt;&gt;<i> ClientService, then doing any set-up work you want to do in your
</I>&gt;&gt;<i> buildProtocol implementation, which delegates to the real, pymodbus
</I>&gt;&gt;<i> implementation.
</I>&gt;<i> 
</I>&gt;<i> Understood, if this is the way the framework is intended to be used I
</I>&gt;<i> realize doing anything else is going to be fighting against the flow.
</I>&gt;<i> 
</I>&gt;<i> However, just to probe the situation I found myself in further, for
</I>&gt;<i> the sake probing broken code to see how it might be fixed:
</I>&gt;<i> 
</I>&gt;<i> Given the ClientService.whenConnected() method is intended to provide
</I>&gt;<i> access to my connected Protocol through the deferred it returns, is it
</I>&gt;<i> not a little unfriendly that this Protocol may turn out to be
</I>&gt;<i> disconnected? OK occasionally due to timing but for this to be a
</I>&gt;<i> possible condition which can loop with the same disconnected Protocol
</I>&gt;<i> returned until the ClientService has its _currentConnection set to
</I>&gt;<i> None, suggests to me that I can't safely use my Protocol from
</I>&gt;<i> whenConnected() for much other than as a notification the first
</I>&gt;<i> connection has occurred... but how do I avoid this?
</I>
whenConnected() is not intended to be used for &quot;give me each Protocol as it is instantiated so that state can be set up&quot;, it is intended for API clients which want to send a message to the current connection to just retrieve the current connection so they can call a method on it.

I'm not sure what you mean by &quot;turn out to be disconnected&quot;.  The physical reality of networking is that you might always encounter a transport which has been disconnected but which you haven't received notification of its disconnection yet.

&gt;<i> I have looked at the source and it seems to me the fact that the
</I>&gt;<i> connection has been lost should bubble up to the ClientService through
</I>&gt;<i> a t.a.i._DisconnectFactory and t.a.i._ReconnectingProtocolProxy once
</I>&gt;<i> my Protocol's connectionLost() is called. My issue seems to be that I
</I>&gt;<i> errback on a Protocol method's deferred returned to code at or above
</I>&gt;<i> the ClientService level which gives up on that Protocol and calls
</I>&gt;<i> whenConnected() to get the next one, only the Protocol's
</I>&gt;<i> connectionLost() has yet to be called and then doesn't have chance to
</I>&gt;<i> because my code is looping around calling whenConnected() and getting
</I>&gt;<i> the same Protocol back. I hope that makes sense :-/
</I>
Let me try to rephrase: you call a protocol method which returns a Deferred; you add an errback to that Deferred which calls whenConnected() to re-try, but since the protocol hasn't disconnected yet, you get the same protocol instance back, which is useless to you.

&gt;<i> My Q on this is if I should be internally calling my Protocol's
</I>&gt;<i> connectionLost() so it can bubble up to the ClientService before I
</I>&gt;<i> errback on the Protocol method - whose responsibility is it to call
</I>&gt;<i> this?
</I>
It's the framework's responsibility to call it.  You should not call it yourself.  Your Protocol's connectionLost isn't going to bubble up to ClientService anyway; you'd have to call your wrapper's connectionLost, which would confuse its internal state, since the framework would call it again right afterwards, and we definitely don't have test coverage for that, since the framework will normally only call it once.

The right way to handle this would be to introduce a delay between re-tries.  It's generally a good idea to have such a delay for lots of reasons; you don't want to overload your peer in the case of a transient failure.  As a bonus, the fact that you've gone back up to the reactor loop to wait a while means that the transport will be properly disconnected and whenConnected() will do what you want.

&gt;&gt;&gt;<i> Before I got on this mailing list I posted this Q to stackoverflow
</I>&gt;&gt;&gt;<i> with some example code:
</I>&gt;&gt;&gt;<i>   <A HREF="http://stackoverflow.com/q/37061807/3448214">http://stackoverflow.com/q/37061807/3448214</A>
</I>&gt;&gt;&gt;<i> but no solution or much attention there yet.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> As I say there, I realize I have probably just made a bad pattern
</I>&gt;&gt;&gt;<i> choice for how to use this API, but I have not been able to work out a
</I>&gt;&gt;&gt;<i> better choice which seems clean and fits my needs/understanding well.
</I>&gt;&gt;&gt;<i> I have tried deriving my own Protocol/Factory and handling the polling
</I>&gt;&gt;&gt;<i> there but this seems to get really messy once I start to add code to
</I>&gt;&gt;&gt;<i> get the collected data to a destination at that level, involving
</I>&gt;&gt;&gt;<i> giving the Protocol too much knowledge of how the data is to be
</I>&gt;&gt;&gt;<i> handled.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I am curious as to why you say that this is &quot;messy&quot;.
</I>&gt;<i> 
</I>&gt;<i> Honestly, this was just a gut feeling at the time, probably more
</I>&gt;<i> sourced in my implementation from lack of experience in using Twisted;
</I>&gt;<i> after reading around the subject, looking at many more examples, and
</I>&gt;<i> your advice, I think I am convinced I need to back to looking at my
</I>&gt;<i> own Protocol derived from the pymodbus one with a Factory that
</I>&gt;<i> contains the persistent config and access to an interface to pump the
</I>&gt;<i> polled data upstream.
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> Any advice, good patterns, or pointers to other projects which do
</I>&gt;&gt;&gt;<i> something similar is appreciated,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I spent a while thinking about your question, and I'm sorry that I can't give
</I>&gt;&gt;<i> a more thorough answer, but I think you need to be a bit more specific
</I>&gt;&gt;<i> about what it is you don't like about your potential solution.  It seems to me
</I>&gt;&gt;<i> that having a delegating Factory, especially if all you need to do is set up
</I>&gt;&gt;<i> some state on each Protocol that gets produced, should be sufficient...
</I>&gt;<i> 
</I>&gt;<i> Looking at the code again I think it just seemed to make sense to me
</I>&gt;<i> at the time to have something that is (or has) a ClientService be the
</I>&gt;<i> object I am calling a DataSource have more control over when it polls
</I>&gt;<i> that data and what it does with it - and not to have to make the
</I>&gt;<i> Protocol and its Factory aware of this at all. Does that make it any
</I>&gt;<i> clearer? I am happy to push ahead with building this into my
</I>&gt;<i> Factory/Protocol if that is more normal usage for Twisted as I am sure
</I>&gt;<i> there will be benefits of encapsulating it here beyond the other side
</I>&gt;<i> I was seeing during that moment of confusion.
</I>&gt;<i> 
</I>&gt;<i> Thanks for the advice, I think it was enough to nudge me in a
</I>&gt;<i> direction that will work better to get me going, and if with more
</I>&gt;<i> experience other usage makes more sense I can always refactor,
</I>&gt;<i> refactor, refactor :)
</I>
Yup!

Happy to help, sorry for the super long lag time on this reply, but my email queue has been pretty full lately :)

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20160521/52b6366b/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="062780.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
	<LI>Next message (by thread): <A HREF="062864.html">[Twisted-Python] Looking for help dealing with ClientService	reconnections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62793">[ date ]</a>
              <a href="thread.html#62793">[ thread ]</a>
              <a href="subject.html#62793">[ subject ]</a>
              <a href="author.html#62793">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
