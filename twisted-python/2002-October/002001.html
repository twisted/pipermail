<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: nntp protocol supports moderated newsgroups?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20nntp%20protocol%20supports%20moderated%20newsgroups%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002042.html">
   <LINK REL="Next"  HREF="002010.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: nntp protocol supports moderated newsgroups?</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20nntp%20protocol%20supports%20moderated%20newsgroups%3F&In-Reply-To="
       TITLE="[Twisted-Python] Re: nntp protocol supports moderated newsgroups?">exarkun at twistedmatrix.com
       </A><BR>
    <I>Sat Oct 19 15:28:29 EDT 2002</I>
    <P><UL>
        <LI>Previous message: <A HREF="002042.html">[Twisted-Python] Re: nntp protocol supports moderated newsgroups?
</A></li>
        <LI>Next message: <A HREF="002010.html">[Twisted-Python] Re: nntp protocol supports moderated newsgroups?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2001">[ date ]</a>
              <a href="thread.html#2001">[ thread ]</a>
              <a href="subject.html#2001">[ subject ]</a>
              <a href="author.html#2001">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Barry A. Warsaw wrote:

&gt;&gt;&gt;&gt;&gt;&gt;<i>&quot;JC&quot; == Jp Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; writes:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>            
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    JC&gt;  Hmm, twisted/news/database.py should have all the stuff it
</I>&gt;<i>    JC&gt; needs already - maybe makeGroupSQL() will need to be modified
</I>&gt;<i>    JC&gt; a bit so that twisted/tap/news.py can tell it which groups
</I>&gt;<i>    JC&gt; should be moderated and which shouldn't.  twisted/tap/news.py
</I>&gt;<i>    JC&gt; will probably have most of the action; it'll need code to let
</I>&gt;<i>    JC&gt; the user specify moderated/unmoderated to mktap somehow, maybe
</I>&gt;<i>    JC&gt; with another --groups parameter, or with some indicator in the
</I>&gt;<i>    JC&gt; groups file.
</I>&gt;<i>
</I>&gt;<i>    JC&gt; Maybe it's time twisted.news got a *real* configuration
</I>&gt;<i>    JC&gt; interface :) I'll ponder that a little (maybe something fun
</I>&gt;<i>    JC&gt; with woven), and if you(/anyone else) have any ideas on this,
</I>&gt;<i>    JC&gt; I'd love to hear them.
</I>&gt;<i>
</I>&gt;<i>I don't really, since I'm fairly green in my Twisted use.  I will note
</I>&gt;<i>that the news stuff seems a little more difficult to use than when I
</I>&gt;<i>last looked at it (Twisted 0.19 I think).  I'm using Twisted from cvs
</I>&gt;<i>now, so it's possible this stuff is just in flux.
</I>&gt;<i>  
</I>&gt;<i>
</I>  I wish I could say that is the case -- I've just been motivated to 
work on other
projects lately.  I agree that it has gotten more complex, and I don't 
like it.  I've
recently been pointed at twisted.persisted.dirdbm, and my current 
thinking is
that PickleStorage and NewsStorageAugmentation should go away in favor of
a DirDBMStorage.  PickleStorage was never meant as anything more than a
toy, and the SQL stuff doesn't seem to have yielded any performance 
benefits,
probably due to the complexity of some of the common queries it is 
performing.

&gt;<i>Specifically:
</I>&gt;<i>
</I>&gt;<i>- What is the --servers switch for?  I couldn't actually find where
</I>&gt;<i>  that was used in tap/news.py but it seemed required, so I fed it
</I>&gt;<i>  nonsense. 
</I>&gt;<i>
</I>The file given to --servers should contain a list of news servers to which
to connect and share messages with.  This hasn't yet been tested 
thoroughly --
I have surprising difficulty finding a news server that implemented 
enough of
the protocol to let this work.  I guess the &quot;user facing&quot; servers are kept
intentionally non-functional for some reason.

&gt;<i>
</I>&gt;<i>- I understand why &quot;mktap news&quot; requires an extra argument now, but it
</I>&gt;<i>  would be nice if either the pickle or sql command were defaulted.  I
</I>&gt;<i>  don't think I needed to specify &quot;mktap news pickle&quot; last time.  Hmm,
</I>&gt;<i>  maybe if --file is given you can default to pickle?
</I>&gt;<i>
</I>Yea, this is new too, since pickle was the only legal command in the 
past.  If I
go with the dirdbm stuff, I'll probably make it the default and let 
pickle or sql
be specified if someone wants something different (Or pickle and sql might
quietly disappear - the prospect of maintaining 3 different backends - 2 of
which are likely useless to nearly everybody - is a little unpleasant).

&gt;<i>
</I>&gt;<i>- I noticed some bugs in the code, a few of which I fixed, but some I
</I>&gt;<i>  didn't.  I ran the server w/ twistd -n and watched the output.  I
</I>&gt;<i>  got mysterious log messages such as:
</I>&gt;<i>
</I>&gt;<i>[...]
</I>&gt;<i>19/10/2002 11:54 [*news*] Starting factory &lt;twisted.news.news.UsenetClientFactory instance at 0x82a52d4&gt;
</I>&gt;<i>19/10/2002 11:54 [*news*] Connection failed: [Failure instance: Traceback! exceptions.IOError, address not found
</I>&gt;<i>19/10/2002 11:54 [*news*] ]
</I>&gt;<i>19/10/2002 11:54 [*news*] Connection failed: [Failure instance: Traceback! exceptions.IOError, address not found
</I>&gt;<i>19/10/2002 11:54 [*news*] ]
</I>&gt;<i>19/10/2002 11:54 [*news*] Stopping factory &lt;twisted.news.news.UsenetClientFactory instance at 0x82a52d4&gt;
</I>&gt;<i>19/10/2002 11:55 [*news*] Starting factory &lt;twisted.news.news.UsenetClientFactory instance at 0x82a52d4&gt;
</I>&gt;<i>[...]
</I>&gt;<i>
</I>&gt;<i>  While these repeated as long as the server was running, they didn't
</I>&gt;<i>  seem to affect its operation.
</I>&gt;<i>  
</I>&gt;<i>
</I>I'm guessing these are due to whatever you put in your server list file.

&gt;<i>- In news/news.py, buildProtocol() is trying to pass self.remoteHosts
</I>&gt;<i>  to the self.protocol() call, but self.protocol() -- which is really
</I>&gt;<i>  the nntp.NNTPServer class, doesn't take two arguments.
</I>&gt;<i>
</I>Thanks for the fix.

&gt;<i>In any event, I hacked in moderated group support by adding a
</I>&gt;<i>-m/--moderators flag, which takes a file containing a list of
</I>&gt;<i>newsgroup/moderator address pairs.  When a message is POSTed to a
</I>&gt;<i>group, the list of target newsgroups is checked against the
</I>&gt;<i>moderators.  If there is any match, and the article has no Approved
</I>&gt;<i>header, the article is not posted, but instead emailed to the
</I>&gt;<i>moderators address.  The value of the Approved header is completely
</I>&gt;<i>ignored -- it just has to be there.  I believe this is pretty close to
</I>&gt;<i>how Usenet s/w handles moderators.
</I>&gt;<i>  
</I>&gt;<i>
</I>Hmm.  How does a moderator then approve the message?  The interface
I had envisioned was something closer to mailman's scheme, though this
is certainly easier on the server side :)

&gt;<i>A couple of kludges that should be cleaned up:
</I>&gt;<i>
</I>&gt;<i>- What to do if the list of target newsgroups has more than one
</I>&gt;<i>  moderated newsgroup in it?  Off hand, I'm not sure what Usenet does
</I>&gt;<i>  in this case.
</I>&gt;<i>
</I>I believe the correct behavior would be to post the message to all 
un-moderated
groups and hold the message for approval from the moderators of each 
moderated
group, posting it to each held group when the appropriate moderator 
approves it.
One issue I see with this, though, is if someone is a moderator for 
multiple groups
that a single message is sent to.  I'm not sure if/how you could/would 
approve the
message for one group but reject it for another.  Maybe once I 
understand how the
email approval system works this will become clear.

&gt;<i>
</I>&gt;<i>- We really need a few more config options, including the smtp host
</I>&gt;<i>  and port to use to send out the moderator's email, and the envelope
</I>&gt;<i>  sender address to use in that email.  Both are hard coded in my
</I>&gt;<i>  hack.
</I>&gt;<i>
</I>Indeed.

&gt;<i>
</I>&gt;<i>- Any un-Twisted coding offenses. :)
</I>&gt;<i>  
</I>&gt;<i>
</I>The only one I see is the use of smtplib.  Its sendmail method will very 
likely
block, possibly for a long time, hanging the entire server.  Aside from 
just being
nasty, this opens up the possibility for DoS on servers, simply by 
repeatedly mailing
a moderated group.  I'm going out of town for a week this coming 
tuesday, and I
doubt I'll have time to figure out how twisted.protocols.smtp.SMTPClient 
works
before then, so I'm going to hold off on committing this.  If you want 
to figure that
out and send another patch, that'd be great, otherwise I'll just take 
care of it when
I get back.

&gt;<i>So, in the grand tradition of scratching my own itch, but just enough
</I>&gt;<i>so I can sleep, here's the patch.
</I>&gt;<i>
</I>&gt;<i>Oh, BTW, for someone who was completely green to the code base,
</I>&gt;<i>Twisted is very nicely written.  It wasn't difficult at all to drill
</I>&gt;<i>down to where I needed to make the changes.  JP's hints helped a lot
</I>&gt;<i>too.  Yay!
</I>&gt;<i>  
</I>&gt;<i>
</I>  Glad to hear it :)  Thanks for the patch.

  Jp




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002042.html">[Twisted-Python] Re: nntp protocol supports moderated newsgroups?
</A></li>
	<LI>Next message: <A HREF="002010.html">[Twisted-Python] Re: nntp protocol supports moderated newsgroups?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2001">[ date ]</a>
              <a href="thread.html#2001">[ thread ]</a>
              <a href="subject.html#2001">[ subject ]</a>
              <a href="author.html#2001">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
