<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] &quot;Eww...  Here, smell this!&quot;  (was Re: Multiplex)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20%22Eww...%20%20Here%2C%20smell%20this%21%22%20%20%28was%20Re%3A%20Multiplex%29&In-Reply-To=Pine.LNX.4.21.0108080644230.29078-100000%40zaibach.twistedmatrix.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000215.html">
   <LINK REL="Next"  HREF="000262.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] &quot;Eww...  Here, smell this!&quot;  (was Re: Multiplex)</H1>
    <B>Kevin Turner</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20%22Eww...%20%20Here%2C%20smell%20this%21%22%20%20%28was%20Re%3A%20Multiplex%29&In-Reply-To=Pine.LNX.4.21.0108080644230.29078-100000%40zaibach.twistedmatrix.com"
       TITLE="[Twisted-Python] &quot;Eww...  Here, smell this!&quot;  (was Re: Multiplex)">acapnotic at twistedmatrix.com
       </A><BR>
    <I>Sun Aug 12 06:05:09 EDT 2001</I>
    <P><UL>
        <LI>Previous message: <A HREF="000215.html">[Twisted-Python] Multiplex
</A></li>
        <LI>Next message: <A HREF="000262.html">[Twisted-Python] &quot;Eww...  Here, smell this!&quot;  (was Re: Multiplex)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#247">[ date ]</a>
              <a href="thread.html#247">[ thread ]</a>
              <a href="subject.html#247">[ subject ]</a>
              <a href="author.html#247">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Aug 08, 2001 at 06:48:59AM -0500, Glyph Lefkowitz wrote:
&gt;<i> 
</I>&gt;<i> This is what Cached was designed for :-).
</I>
I must be missin' something.  Here's my attempt.  Problems include not
being sure if I can really talk in the Cache -&gt; Cached direction, and
the transparent automatic repeater creation alchemy doesn't even come
close.

(no, it doesn't run.  yes, the names suck.  but none of that matters if
it doesn't work at all.)

class PlexPerspective(Perspective):
    &quot;&quot;&quot;This is the perspective given by Bob's repeater service.&quot;&quot;&quot;
    
    def perspective_setPlexTag(self, tag):
        &quot;&quot;&quot;Register a copytag as being a plexed class.&quot;&quot;&quot;
        
        # Do some sanity checking, make sure tag has a safe prefix
        # like &quot;PLEX_&quot; or somesuch.
        pb.setCopyTags(tag, PlexRepeater)
    

class PlexBase(Copied):
    &quot;&quot;&quot;Plex base class -- always returns a consistant copytag

    (even if it's been through a repeater, where everything is a
    PlexRepeater, no matter what the tag.)
    &quot;&quot;&quot;
    
    def getStateToCopy(self):
        # Make sure _copytag gets into our state, which it otherwise
        # wouldn't do if our _copytag refers to the class attribute.
        state = pb.Copied.getStateToCopy(self)
        state['_copytag'] = self._copytag
        return state

    def getTypeToCopy(self):
        return self._copytag
        

class PlexRepeater(PlexBase, Cached, Copy):
    &quot;&quot;&quot;This is how 'plexes look in the repeater.

    Repeaters don't have unique properties as they're all instances
    of this class, but they must remember the copytag to give to
    their children.&quot;&quot;&quot;
    
    def setCopiedState(self, state):
        &quot;&quot;&quot;Leaf -&gt; Repeater alchemy.

        This is so new plexed objects may be created transparently, if
        a peer just passes through an instance of their leaf-class.&quot;&quot;&quot;
        
        # XXX: How do I find out which broker I arrived through?
        # There isn't a setCopiedStateFor()

        moms_perspective = moms_broker.getPerspective()

        # I need to convince that broker that Mom is really a
        # remote cache of me.
        puid = self.ProcessUniqueID()
        moms_broker.remotelyCachedLUIDs[puid] = moms_luid
        moms_broker.remotelyCachedObjects[moms_luid] = Local(self)

        # Add Mom as an Observer
        observer = CacheObserver(moms_broker, self, moms_perspective)
        
        # Don't need to get the state, actually, but that is the
        # method that keeps my observer list healthy.
        self.getStateToCacheAndObserveFor(moms_perspective, observer)

        # XXX: Now I have to convince Mom's broker on her end to make
        # a CacheProxy for me, with Mom as the cNotProxy.

        state['_receive_daughter'](self) 
        
        pb.Copy.setCopiedState(self, state)

    def remoteMessageReceived(self, broker, message, args, kw):
        &quot;&quot;&quot;Pass the word along to all the kids.&quot;&quot;&quot;
        
        # ??? Do I receive remote messages?
        # Or do I have to pass this method as part of my cached state?

        for o in self.observers:
            self.remoteCacheDo(bla, bla, args, kw)

    def getStateToCacheAndObserveFor(self, perspective, observer):
        &quot;&quot;&quot;keep a list of my kids.&quot;&quot;&quot;

        self.observerlist.append(observer)

        return self.getStateToCopyFor(self, perspective)


class PlexLeaf(PlexBase, Cache):
    &quot;&quot;&quot;This is subclassed by Alec, Amy, and Angus.

    it will be the setCopierForClass for a PLEX_ copytag, and thus
    created whenever a peer (most likely the repeater) passes a plex to
    us.  

    It receives updates from the plex object it caches,
    and can talk back to that object as well (causing it to broadcast,
    if it is a repeater).

    My subclass should define a _copytag attribute to identify me when
    I'm passed to my peer if I was initialized locally, and not by the
    broker as a Cache.
    &quot;&quot;&quot;

    def __getattr__(self, key):

        # Shout out through the plex
        if key[:6] == &quot;shout_&quot;:
            return getattr(self.cached, key[6:])
        



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000215.html">[Twisted-Python] Multiplex
</A></li>
	<LI>Next message: <A HREF="000262.html">[Twisted-Python] &quot;Eww...  Here, smell this!&quot;  (was Re: Multiplex)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#247">[ date ]</a>
              <a href="thread.html#247">[ thread ]</a>
              <a href="subject.html#247">[ subject ]</a>
              <a href="author.html#247">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
