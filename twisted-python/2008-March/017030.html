<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted names - how to add answers to a message	and send replies
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20twisted%20names%20-%20how%20to%20add%20answers%20to%20a%20message%0A%09and%20send%20replies&In-Reply-To=20080312133000.6859.1007360226.divmod.quotient.18377%40ohm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017029.html">
   <LINK REL="Next"  HREF="017031.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted names - how to add answers to a message	and send replies</H1>
    <B>Chris Dew</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20twisted%20names%20-%20how%20to%20add%20answers%20to%20a%20message%0A%09and%20send%20replies&In-Reply-To=20080312133000.6859.1007360226.divmod.quotient.18377%40ohm"
       TITLE="[Twisted-Python] twisted names - how to add answers to a message	and send replies">chris at sidwells.com
       </A><BR>
    <I>Thu Mar 13 03:52:24 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="017029.html">[Twisted-Python] twisted names - how to add answers to a message	and send replies
</A></li>
        <LI>Next message: <A HREF="017031.html">[Twisted-Python] twisted names - how to add answers to a message	and send replies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17030">[ date ]</a>
              <a href="thread.html#17030">[ thread ]</a>
              <a href="subject.html#17030">[ subject ]</a>
              <a href="author.html#17030">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for your reply.  I have tried setting answer to 1.  I have included
an amended version of my programme at the end of this email.

When I run this, the server reports no error.  When I  'dig @localhost
foo.bar' I get the response:

&quot;&quot;&quot;
;; Warning: Message parser reports malformed message packet.

; &lt;&lt;&gt;&gt; DiG 9.4.1 &lt;&lt;&gt;&gt; @localhost foo.bar
; (1 server found)
;; global options:  printcmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 18948
;; flags: qr rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
;; WARNING: recursion requested but not available
;; WARNING: Messages has 4 extra bytes at end

;; QUESTION SECTION:
;foo.bar.                       IN      A

;; Query time: 1 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Thu Mar 13 07:37:50 2008
;; MSG SIZE  rcvd: 29
&quot;&quot;&quot;

Wireshark also shows the reply packet to be malformed:

0000  00 00 00 00 00 00 00 00  00 00 00 00 08 00 45 00   ........ ......E.
0010  00 39 00 00 40 00 40 11  3c b2 7f 00 00 01 7f 00   <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">.9.. at .</A>@. &lt;.......
0020  00 01 00 35 82 43 00 25  fe 38 51 cf 81 00 00 01   ...5.C.% .8Q.....
0030  00 01 00 00 00 00 03 66  6f 6f 03 62 61 72 00 00   .......f oo.bar..
0040  01 00 01 0a 0b 0c 0d

You  can see the 10.11.12.13 at the end (hex), but something about the
packet is wrong.

Could you point out my mistake?  If it's a bug in twisted.names, I'm happy
to look at fixing it (I've worked with the dns protocol at packet level
before), but I first want to make sure that I am using the API correctly.

Thanks,

Chris.





#!/usr/bin/python

from twisted.internet.protocol import Protocol, Factory
from twisted.internet import reactor
from twisted.names.server import DNSServerFactory
from twisted.names.dns import Query, DNSDatagramProtocol, RRHeader,
Record_CNAME, Record_A, Message
from twisted.names import dns
from twisted.internet.interfaces import IAddress

class Controller(object):
    def messageReceived(self, m, protocol, addr):
        print m, dir(m), m.queries, m.answers
        # this should always answer 10.11.12.13, regardless of the query
        m.answer = 1
        m.answers.append(Record_A(address=&quot;10.11.12.13&quot;))
        protocol.transport.write(m.toStr(), addr)

controller = Controller()

if __name__ == &quot;__main__&quot;:
    reactor.listenUDP(53, DNSDatagramProtocol(controller))
    reactor.run()








On 12/03/2008, Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On Wed, 12 Mar 2008 08:04:21 +0000, Chris Dew &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris at sidwells.com</A>&gt; wrote:
</I>&gt;<i> &gt;I have a small script which answers dns queries by returning the original
</I>&gt;<i> &gt;message.  I have spent a couple of hours RTFMing, but I still cannot find
</I>&gt;<i> &gt;out how to correctly add answers to the message, before returning it.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I want to add an answer, either a Record_CNAME or Record_A, so as to
</I>&gt;<i> produce
</I>&gt;<i> &gt;a trivial authoritative-only DNS server.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Adding a Record_XXX object to message.answers using the Array's 'append'
</I>&gt;<i> &gt;method produces a MalformedPacket (according to wireshark), though the
</I>&gt;<i> &gt;server does not throw any exceptions.   (In this situation, the answer
</I>&gt;<i> &gt;count, as shown by dig, does rise to 1, even though no answer is
</I>&gt;<i> displayed
</I>&gt;<i> &gt;[due to malformed packet?].)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Perhaps there is a completely different way to do this?  Could I craft a
</I>&gt;<i> &gt;message with answers from scratch?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Did you set `m.answer&#180; to 1?
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20080313/84fc4c67/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20080313/84fc4c67/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017029.html">[Twisted-Python] twisted names - how to add answers to a message	and send replies
</A></li>
	<LI>Next message: <A HREF="017031.html">[Twisted-Python] twisted names - how to add answers to a message	and send replies
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17030">[ date ]</a>
              <a href="thread.html#17030">[ thread ]</a>
              <a href="subject.html#17030">[ subject ]</a>
              <a href="author.html#17030">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
