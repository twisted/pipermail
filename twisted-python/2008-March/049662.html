<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: writing back to the connection is	blocking my code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20writing%20back%20to%20the%20connection%0A%09%3D%3Fiso-8859-1%3Fq%3Fis%3D09blocking_my%3F%3D%20code&In-Reply-To=%3C200803231329.11754.therve%40free.fr%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="049635.html">
   <LINK REL="Next"  HREF="049633.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: writing back to the connection is	blocking my code</H1>
    <B>Thomas Hervé</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20writing%20back%20to%20the%20connection%0A%09%3D%3Fiso-8859-1%3Fq%3Fis%3D09blocking_my%3F%3D%20code&In-Reply-To=%3C200803231329.11754.therve%40free.fr%3E"
       TITLE="[Twisted-Python] Re: writing back to the connection is	blocking my code">therve at free.fr
       </A><BR>
    <I>Sun Mar 23 06:29:11 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="049635.html">[Twisted-Python] Re: writing back to the connection is	blocking	my code
</A></li>
        <LI>Next message (by thread): <A HREF="049633.html">[Twisted-Python] Re: writing back to the connection is blocking	my code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49662">[ date ]</a>
              <a href="thread.html#49662">[ thread ]</a>
              <a href="subject.html#49662">[ subject ]</a>
              <a href="author.html#49662">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Le Friday 21 March 2008 18:11:58 coder_gus, vous avez écrit :
&gt;<i> Yup, that made it alot clear and thanks so much for it :)
</I>&gt;<i>
</I>&gt;<i> But now another question comes up: what if for a special client I want
</I>&gt;<i> to inject some data ... let's say that while he is processing some
</I>&gt;<i> tasks, the backend observes that some data in the database has altered
</I>&gt;<i> and wants to notify the client that he can't use that data anymore - if
</I>&gt;<i> I am using deferToThread I don't think sending data back trough that is
</I>&gt;<i> pretty easy ... or am I wrong?
</I>
Indeed, that's not a problem. You just have to pass something to your task 
that will allow it to send data back, and remember that Twisted is not 
threadsafe so that you must use reactor.callFromThread. Let's get back to our 
example:

def blockingTask(content, safeWrite):
     import sqlalchemy
     # sqlalchemy stuff
     query = session.query(&quot;bla&quot;)
     data  = query.getresult()
     if data == &quot;unexpected&quot;:
         safeWrite(&quot;Not expected!&quot;)
         # But I continue my task
     ....
     return result


class CommandProtocol(Protocol):
     def __init__(self):
         self.buf = ''

     def safeWrite(self, data):
         reactor.callFromThread(self.transport.write, data)

     def dataReceived(self, data):
         self.buf += data
         # This is stupid, don't do that
         while '&lt;/end_command&gt;' in self.buf:
              content, self.buf = self.buf.split('&lt;/end_command&gt;', 1)
              content += '&lt;/end_command&gt;'
              deferToThread(blockingTask, content,     
                      self.safeWrite).addCallback(self.response)

     def response(self, result):
         # I got the response event!
         self.sendLine.write(&quot;response %s&quot; % (result,))


See? We're passing a method to the task, so that you can send notification 
whenever you want. In practice, you'll have to check if the connection is 
still alive, but the main thing to remind is to use reactor.callFromThread.

-- 
Thomas


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="049635.html">[Twisted-Python] Re: writing back to the connection is	blocking	my code
</A></li>
	<LI>Next message (by thread): <A HREF="049633.html">[Twisted-Python] Re: writing back to the connection is blocking	my code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49662">[ date ]</a>
              <a href="thread.html#49662">[ thread ]</a>
              <a href="subject.html#49662">[ subject ]</a>
              <a href="author.html#49662">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
