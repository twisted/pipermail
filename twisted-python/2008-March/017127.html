<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: writing back to the connection is	blocking	my code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20writing%20back%20to%20the%20connection%20is%09blocking%0A%09my%20code&In-Reply-To=20080321162644.k7ihf3w4kk0kc0k4%40wasabox.wasabout.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017126.html">
   <LINK REL="Next"  HREF="017154.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: writing back to the connection is	blocking	my code</H1>
    <B>coder_gus</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20writing%20back%20to%20the%20connection%20is%09blocking%0A%09my%20code&In-Reply-To=20080321162644.k7ihf3w4kk0kc0k4%40wasabox.wasabout.net"
       TITLE="[Twisted-Python] Re: writing back to the connection is	blocking	my code">coder_gus at lavabit.com
       </A><BR>
    <I>Fri Mar 21 13:11:58 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="017126.html">[Twisted-Python] Re: writing back to the connection is	blocking my code
</A></li>
        <LI>Next message: <A HREF="017154.html">[Twisted-Python] Re: writing back to the connection is	blocking my code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17127">[ date ]</a>
              <a href="thread.html#17127">[ thread ]</a>
              <a href="subject.html#17127">[ subject ]</a>
              <a href="author.html#17127">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Yup, that made it alot clear and thanks so much for it :)

But now another question comes up: what if for a special client I want 
to inject some data ... let's say that while he is processing some 
tasks, the backend observes that some data in the database has altered 
and wants to notify the client that he can't use that data anymore - if 
I am using deferToThread I don't think sending data back trough that is 
pretty easy ... or am I wrong?

Thanks for all.


Thomas Herv&#233; wrote:
&gt;<i> Quoting coder_gus &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">coder_gus at lavabit.com</A>&gt;:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi, thanks for answering and clarifying this - until now you where the
</I>&gt;&gt;<i> only one that told me there no way of sending data if there is no event
</I>&gt;&gt;<i> on the server. So what I am trying to achieve, I have asked a couple of
</I>&gt;&gt;<i> weeks ago too about this matter (actually about the architecure): I
</I>&gt;&gt;<i> want to write an application server that receives data from clients
</I>&gt;&gt;<i> (client app written in delphi), data is in xml format (I want to write
</I>&gt;&gt;<i> it using a bare-bone protocol and not an xml-rpc server). The data the
</I>&gt;&gt;<i> client sends are some requests for some specific data hold in a
</I>&gt;&gt;<i> database. So, the client makes a request, request that is hold in a
</I>&gt;&gt;<i> synchronized queue together with an instance of the client's
</I>&gt;&gt;<i> connection. A coordinator takes the data from that queue and gives it
</I>&gt;&gt;<i> to some xml threads to parse it and the same coordinator take the
</I>&gt;&gt;<i> parsed data from the xml threads and give some workers to do the
</I>&gt;&gt;<i> bussiness work. This workers place the result in a queue from where the
</I>&gt;&gt;<i> coordinator takes care of sending it back to the clients. I will be
</I>&gt;&gt;<i> using sqlalchemy for database communication.
</I>&gt;&gt;<i> I know the architecture is pretty weird from the twisted perspective,
</I>&gt;&gt;<i> but when the dev-manager wants to do it that way, what can you do? So
</I>&gt;&gt;<i> that is the thing I want to achieve and from this started my question;
</I>&gt;&gt;<i> when the workers finish their work, they have the result, place it in a
</I>&gt;&gt;<i> queue and from there I have to send it to the clients asap, without
</I>&gt;&gt;<i> waiting the server for events.
</I>&gt;<i>
</I>&gt;<i> This is were you're wrong: pushing the result is an event! So to the 
</I>&gt;<i> event 'I got some result in a thread', you'll fire a connection write. 
</I>&gt;<i> Let me try to write some pseudo code to solve your problem:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def blockingTask(content):
</I>&gt;<i>     import sqlalchemy
</I>&gt;<i>     # sqlalchemy stuff
</I>&gt;<i>     query = session.query(&quot;bla&quot;)
</I>&gt;<i>     ....
</I>&gt;<i>     return result
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class CommandProtocol(Protocol):
</I>&gt;<i>     def __init__(self):
</I>&gt;<i>         self.buf = ''
</I>&gt;<i>
</I>&gt;<i>     def dataReceived(self, data):
</I>&gt;<i>         self.buf += data
</I>&gt;<i>         # This is stupid, don't do that
</I>&gt;<i>         while '&lt;/end_command&gt;' in self.buf:
</I>&gt;<i>              content, self.buf = self.buf.split('&lt;/end_command&gt;', 1)
</I>&gt;<i>              content += '&lt;/end_command&gt;'
</I>&gt;<i>              deferToThread(blockingTask, 
</I>&gt;<i> content).addCallback(self.response)
</I>&gt;<i>
</I>&gt;<i>     def response(self, result):
</I>&gt;<i>         # I got the response event!
</I>&gt;<i>         self.sendLine.write(&quot;response %s&quot; % (result,))
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> See? deferToThread generates an event, which is used the pass the 
</I>&gt;<i> result of the command to a callback.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I hope it clarifies some things.
</I>&gt;<i>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017126.html">[Twisted-Python] Re: writing back to the connection is	blocking my code
</A></li>
	<LI>Next message: <A HREF="017154.html">[Twisted-Python] Re: writing back to the connection is	blocking my code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17127">[ date ]</a>
              <a href="thread.html#17127">[ thread ]</a>
              <a href="subject.html#17127">[ subject ]</a>
              <a href="author.html#17127">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
