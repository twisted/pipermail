<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: SSL + AMP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20SSL%20%2B%20AMP&In-Reply-To=%3C96c9d6a80803241353i230e95bfofd1f6407688c4b72%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="049675.html">
   <LINK REL="Next"  HREF="049685.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: SSL + AMP</H1>
    <B>Nathan</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20SSL%20%2B%20AMP&In-Reply-To=%3C96c9d6a80803241353i230e95bfofd1f6407688c4b72%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Re: SSL + AMP">nathan.stocks at gmail.com
       </A><BR>
    <I>Mon Mar 24 14:53:05 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="049675.html">[Twisted-Python] Re: SSL + AMP
</A></li>
        <LI>Next message (by thread): <A HREF="049685.html">[Twisted-Python] Re: SSL + AMP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49684">[ date ]</a>
              <a href="thread.html#49684">[ thread ]</a>
              <a href="subject.html#49684">[ subject ]</a>
              <a href="author.html#49684">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Mar 21, 2008 at 2:56 PM, David Bolen &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">db3l.net at gmail.com</A>&gt; wrote:
&gt;<i>  I posted a while back a small sample of how to handle that for a
</I>&gt;<i>  general Twisted protocol that might be of some help, or point you in
</I>&gt;<i>  the right direction as well.
</I>&gt;<i>
</I>&gt;<i>  <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2007-August/015935.html">http://twistedmatrix.com/pipermail/twisted-python/2007-August/015935.html</A>
</I>&gt;<i>
</I>&gt;<i>  (Note the followup messages that clarify an erroneous &quot;False&quot; left in
</I>&gt;<i>  the original posted code)
</I>&gt;<i>
</I>&gt;<i>  This works fine with just normal CA/server/client certificates created
</I>&gt;<i>  through the standard OpenSSL process and tools.
</I>
I've generated a CA file, some private keys (and their corresponding
CSR's and certificates), and incorporated chunks of code from the post
you linked to above (and fixed the &quot;returning ok&quot; bit), but I'm
running into the following error:

[('SSL routines', 'SSL3_READ_BYTES', 'sslv3 alert certificate
unknown'), ('SSL routines', 'SSL3_READ_BYTES', 'ssl handshake
failure')]

So close!  I wonder if this has something to do with the fact that my
two endpoints are both on localhost, and not on some domain name?
Just a stab in the dark.

Anyway, here's the debugging print statement info from the client side
(I scrubbed out personal info):

_verify (ok=1):
  subject: &lt;X509Name object '/CN=MyCompany
CA/C=US/ST=Utah/L=MyCity/O=mycompany.com/emailAddress=<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">operations at mycompany.com</A>'&gt;
  issuer: &lt;X509Name object '/CN=MyCompany
CA/C=US/ST=Utah/L=MyCity/O=mycompany.com/emailAddress=<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">operations at mycompany.com</A>'&gt;
  errnum 0, errdepth 1

_verify (ok=1):
  subject: &lt;X509Name object
'/C=US/ST=Utah/O=mycompany.com/CN=controller/emailAddress=<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">operations at mycompany.com</A>'&gt;
  issuer: &lt;X509Name object '/CN=MyCompany
CA/C=US/ST=Utah/L=MyCity/O=mycompany.com/emailAddress=<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">operations at mycompany.com</A>'&gt;
  errnum 0, errdepth 0

And here's the ssl code from the client (the only significant change I
made was the filenames):

class ClientContextFactory(ssl.ClientContextFactory):

   def _verify(self, connection, x509, errnum, errdepth, ok):
      print '_verify (ok=%d):' % ok
      print '  subject:', x509.get_subject()
      print '  issuer:', x509.get_issuer()
      print '  errnum %s, errdepth %d' % (errnum, errdepth)
      return ok

   def getContext(self):
      ctx = ssl.ClientContextFactory.getContext(self)
      ctx.use_certificate_file('ssl/private/nathanmonitor.cert')
      ctx.use_privatekey_file('ssl/private/nathanmonitor.key')
      ctx.load_verify_locations('ssl/ca-cert.pem')
      ctx.set_verify(SSL.VERIFY_PEER|SSL.VERIFY_FAIL_IF_NO_PEER_CERT,
                     self._verify)
      return ctx

ClientCreator(reactor, MonitorClientProtocol).connectSSL(
  'localhost', MONITOR_PORT, ClientContextFactory()).addCallback(
                        monitor_window.install_amp_client)


nathanmonitor.key is the private ssl key of my &quot;monitor&quot; client

ca-cert.pem is the custom CA certificate I made by following
<A HREF="http://sial.org/howto/openssl/ca/">http://sial.org/howto/openssl/ca/</A>

nathanmonitor.cert is the ssl certificate of my &quot;monitor&quot; client
generated with my custom CA and a .csr of nathanmonitor.key


On the server side, the error output is pretty quiet:

_verify (ok=1):
subject:&lt;X509Name object '/CN=MyCompany
CA/C=US/ST=Utah/L=MyCity/O=mycompany.com/emailAddress=<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">operations at mycompany.com</A>'&gt;

...here's my server code (again, pretty much the same except for cert files)

class ServerContextFactory:
   def _verify(self, connection, x509, errnum, errdepth, ok):
      logging.info('_verify (ok=%d):' % ok)
      logging.info('  subject:%s' % x509.get_subject())
      logging.info('  issuer:', x509.get_issuer())
      logging.info('  errnum %s, errdepth %d' % (errnum, errdepth))
      return ok

   def getContext(self):
      &quot;&quot;&quot;Create an SSL context.&quot;&quot;&quot;
      ctx = SSL.Context(SSL.SSLv23_METHOD)
      ctx.use_certificate_file('ssl/private/controller.cert')
      ctx.use_privatekey_file('ssl/private/controller.key')
      ctx.load_client_ca('ssl/ca-cert.pem')
      ctx.load_verify_locations('ssl/ca-cert.pem')
      ctx.set_verify(SSL.VERIFY_PEER|SSL.VERIFY_FAIL_IF_NO_PEER_CERT,
                     self._verify)
      ctx.set_verify_depth(10)
      return ctx

reactor.listenSSL(MONITOR_PORT, monitor_factory, ServerContextFactory())


controller.key is the private ssl key of the &quot;server&quot;

ca-cert.pem is the same custom CA certificate file as used in the client.

controller.cert is the ssl certificate of the &quot;server&quot; generated with
my custom CA and a .csr of controller.key


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="049675.html">[Twisted-Python] Re: SSL + AMP
</A></li>
	<LI>Next message (by thread): <A HREF="049685.html">[Twisted-Python] Re: SSL + AMP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49684">[ date ]</a>
              <a href="thread.html#49684">[ thread ]</a>
              <a href="subject.html#49684">[ subject ]</a>
              <a href="author.html#49684">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
