<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20I%20send%20unique%20configuration%20data%20for%0A%09multiple%20connections%20through%20a%20factory%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021509.html">
   <LINK REL="Next"  HREF="021519.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?</H1>
    <B>Mark Bailey</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20I%20send%20unique%20configuration%20data%20for%0A%09multiple%20connections%20through%20a%20factory%3F&In-Reply-To="
       TITLE="[Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?">mebly5343 at gmail.com
       </A><BR>
    <I>Wed Feb 10 13:53:49 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021509.html">[Twisted-Python] Error handling for modules which use	twisted.enterprise.adbapi
</A></li>
        <LI>Next message: <A HREF="021519.html">[Twisted-Python] How can I send unique configuration data for multiple connections through a factory?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21512">[ date ]</a>
              <a href="thread.html#21512">[ thread ]</a>
              <a href="subject.html#21512">[ subject ]</a>
              <a href="author.html#21512">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Good day:

I've been having fun with Twisted.  I have my application running fine, with
multiple server and client connections using Telnet.  :-)

However, users always want something.  I need to send some unique
configuration information to each connection.  The connections are made
using connectTCP.  My first attempt assumed that the connection was made
when the call to connectTCP was executed.  It didn't work!  :-(

-------------------------------

from twisted.internet.protocol import ClientFactory
from twisted.internet import reactor
from twisted.conch.telnet import StatefulTelnetProtocol

class testClient(StatefulTelnetProtocol):

    def connectionMade(self):
        self.title = self.factory.connectString
        print &quot;Client Connected: &quot; + self.title
        self.setRawMode()
        self.factory.connections.append(self)

    def connectionLost(self, reason):
        if self in self.factory.connections:
            self.factory.connections.remove(self)

    def rawDataReceived(self,data):
        print data + &quot;\n&quot;

class ClusterClientFactory(ClientFactory):

    protocol = testClient

    def __init__(self):
        self.connections = []
        self.connectString = ''

    def startFactory(self):
        print &quot;startFactory: &quot; + self.connectString

    def startedConnecting(self, connector):
        print &quot;Started connecting: &quot; + str(connector)
        print self.connectString

    def buildProtocol(self, addr):
        print &quot;bulldProtocol: &quot; + str(addr)
        print &quot;buildProtocol: &quot; + self.connectString

        p = self.protocol()
        p.factory = self
        return p

if __name__ == '__main__':


    def startUp():

        factory = ClusterClientFactory()
        factory.maxDelay = 120  #  two minutes

        factory.connectString = &quot;FirstString...&quot;
        reactor.connectTCP(&quot;localhost&quot;, 7300, factory)

        factory.connectString = &quot;SecondString&quot;
        reactor.connectTCP(&quot;localhost&quot;, 7300, factory)

    reactor.callWhenRunning(startUp)
    reactor.run()

----------------------------------

The results are that buildProtocol gets the second string both times.
startedConnecting gets the correct string, but all I have there is a
connection object.  I need the correct data in buildProtocol to do it this
way.

------------------------------------

C:\Users\Mark\src\play&gt;python testclient.py
startFactory: FirstString...
Started connecting: &lt;twisted.internet.tcp.Connector instance at 0x01DAB620&gt;
FirstString...
Started connecting: &lt;twisted.internet.tcp.Connector instance at 0x01E0EFD0&gt;
SecondString
bulldProtocol: IPv4Address(TCP, '127.0.0.1', 7300)
buildProtocol: SecondString
Client Connected: SecondString
Welcome to SimpleServer5



bulldProtocol: IPv4Address(TCP, '127.0.0.1', 7300)
buildProtocol: SecondString
Client Connected: SecondString
Welcome to SimpleServer5

--------------------------


My &quot;best&quot; idea is to pass the strings to the factory in a dictionary indexed
by the IP address and the port.  Then, buildProtocol() can use that to
recover the string and I can use reactor.resolve() to translate the host
name to the IP address.  The real application won't have multiple
connections to the same host and port like this example, so this would work.

There MUST be a better way.  :-)

My &quot;simpleserver&quot; is below if you want to run this.

THANKS for all of your help.  I have the basic application running now
(including a Tkinter GUI  :-) ) and Twisted has saved me hundreds or even
thousands of lines of code...

Mark Bailey

------------------------------

from twisted.conch.telnet import StatefulTelnetProtocol
from twisted.internet import reactor, protocol
from twisted.protocols.basic import LineReceiver

class TelnetEcho(StatefulTelnetProtocol):
    def connectionMade(self):
        self.factory.connection.append(self)
        self.sendLine(&quot;Welcome to SimpleServer5\r\n&quot;)


    def lineReceived(self, data):
        data = data.rstrip('\n\r')

        if data.upper() == 'BYE':
            self.sendLine(&quot;Goodbye...\r&quot;)
            self.transport.loseConnection()
        else:
            self.sendLine(&quot;Unrecognized command: %r\r&quot; % (data,))

    def connectionLost(self, reason):
        self.factory.connection.remove(self)


class TelnetEchoFactory(protocol.Factory):
    protocol = TelnetEcho
    def __init__(self):
        self.connection = []


def createTelnetServer(port=7300):
    telnetinstance = TelnetEchoFactory()       #  needs to be a list
    reactor.listenTCP(port,telnetinstance)

if __name__ == &quot;__main__&quot;:
    reactor.callWhenRunning(createTelnetServer)
    reactor.run()
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20100210/acc93b9c/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20100210/acc93b9c/attachment.htm</A> 
</PRE>









































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021509.html">[Twisted-Python] Error handling for modules which use	twisted.enterprise.adbapi
</A></li>
	<LI>Next message: <A HREF="021519.html">[Twisted-Python] How can I send unique configuration data for multiple connections through a factory?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21512">[ date ]</a>
              <a href="thread.html#21512">[ thread ]</a>
              <a href="subject.html#21512">[ subject ]</a>
              <a href="author.html#21512">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
