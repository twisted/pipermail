<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20I%20send%20unique%20configuration%20data%20for%0A%09multiple%20connections%20through%20a%20factory%3F&In-Reply-To=4B730B48.3070206%40scherpenisse.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021519.html">
   <LINK REL="Next"  HREF="021529.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?</H1>
    <B>Mark Bailey</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20I%20send%20unique%20configuration%20data%20for%0A%09multiple%20connections%20through%20a%20factory%3F&In-Reply-To=4B730B48.3070206%40scherpenisse.net"
       TITLE="[Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?">mebly5343 at gmail.com
       </A><BR>
    <I>Wed Feb 10 16:15:40 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021519.html">[Twisted-Python] How can I send unique configuration data for multiple connections through a factory?
</A></li>
        <LI>Next message: <A HREF="021529.html">[Twisted-Python] multiple versions of twisted on same machine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21527">[ date ]</a>
              <a href="thread.html#21527">[ thread ]</a>
              <a href="subject.html#21527">[ subject ]</a>
              <a href="author.html#21527">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks, Arjan.  Of course, factories are breeding like rabbits, but that was
the obvious solution!  :-)  I wish I had thought of it.

You saved me several MORE hours...I've spend all day on this.

(It's snowing and work was CLOSED!  Yeehah!)

Mark

On Wed, Feb 10, 2010 at 2:38 PM, Arjan Scherpenisse
&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">arjan at scherpenisse.net</A>&gt;wrote:

&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i> If you create two instances of your ClusterClientFactory, each with a
</I>&gt;<i> unique string, you should be fine. Requires only a small modification:
</I>&gt;<i>
</I>&gt;<i>         factory = ClusterClientFactory()
</I>&gt;<i>         factory.maxDelay = 120  #  two minutes
</I>&gt;<i>         factory.connectString = &quot;FirstString...&quot;
</I>&gt;<i>         reactor.connectTCP(&quot;localhost&quot;, 7300, factory)
</I>&gt;<i>
</I>&gt;<i>          factory2 = ClusterClientFactory()
</I>&gt;<i>         factory2.maxDelay = 120  #  two minutes
</I>&gt;<i>         factory2.connectString = &quot;SecondString&quot;
</I>&gt;<i>         reactor2.connectTCP(&quot;localhost&quot;, 7300, factory)
</I>&gt;<i>
</I>&gt;<i> You can clean this up by putting the maxDelay and connectString in the
</I>&gt;<i> constructor of the factory:
</I>&gt;<i>
</I>&gt;<i> reactor2.connectTCP(&quot;localhost&quot;, 7300, ClusterClientFactory(120, &quot;First&quot;))
</I>&gt;<i> reactor2.connectTCP(&quot;localhost&quot;, 7300, ClusterClientFactory(120, &quot;Second&quot;))
</I>&gt;<i>
</I>&gt;<i> Arjan
</I>&gt;<i>
</I>&gt;<i> Mark Bailey wrote:
</I>&gt;<i> &gt; Good day:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've been having fun with Twisted.  I have my application running fine,
</I>&gt;<i> &gt; with multiple server and client connections using Telnet.  :-)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; However, users always want something.  I need to send some unique
</I>&gt;<i> &gt; configuration information to each connection.  The connections are made
</I>&gt;<i> &gt; using connectTCP.  My first attempt assumed that the connection was made
</I>&gt;<i> &gt; when the call to connectTCP was executed.  It didn't work!  :-(
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; from twisted.internet.protocol import ClientFactory
</I>&gt;<i> &gt; from twisted.internet import reactor
</I>&gt;<i> &gt; from twisted.conch.telnet import StatefulTelnetProtocol
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; class testClient(StatefulTelnetProtocol):
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def connectionMade(self):
</I>&gt;<i> &gt;         self.title = self.factory.connectString
</I>&gt;<i> &gt;         print &quot;Client Connected: &quot; + self.title
</I>&gt;<i> &gt;         self.setRawMode()
</I>&gt;<i> &gt;         self.factory.connections.append(self)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def connectionLost(self, reason):
</I>&gt;<i> &gt;         if self in self.factory.connections:
</I>&gt;<i> &gt;             self.factory.connections.remove(self)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def rawDataReceived(self,data):
</I>&gt;<i> &gt;         print data + &quot;\n&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; class ClusterClientFactory(ClientFactory):
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     protocol = testClient
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def __init__(self):
</I>&gt;<i> &gt;         self.connections = []
</I>&gt;<i> &gt;         self.connectString = ''
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def startFactory(self):
</I>&gt;<i> &gt;         print &quot;startFactory: &quot; + self.connectString
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def startedConnecting(self, connector):
</I>&gt;<i> &gt;         print &quot;Started connecting: &quot; + str(connector)
</I>&gt;<i> &gt;         print self.connectString
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def buildProtocol(self, addr):
</I>&gt;<i> &gt;         print &quot;bulldProtocol: &quot; + str(addr)
</I>&gt;<i> &gt;         print &quot;buildProtocol: &quot; + self.connectString
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;         p = self.protocol()
</I>&gt;<i> &gt;         p.factory = self
</I>&gt;<i> &gt;         return p
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; if __name__ == '__main__':
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def startUp():
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;         factory = ClusterClientFactory()
</I>&gt;<i> &gt;         factory.maxDelay = 120  #  two minutes
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;         factory.connectString = &quot;FirstString...&quot;
</I>&gt;<i> &gt;         reactor.connectTCP(&quot;localhost&quot;, 7300, factory)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;         factory.connectString = &quot;SecondString&quot;
</I>&gt;<i> &gt;         reactor.connectTCP(&quot;localhost&quot;, 7300, factory)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     reactor.callWhenRunning(startUp)
</I>&gt;<i> &gt;     reactor.run()
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ----------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The results are that buildProtocol gets the second string both times.
</I>&gt;<i> &gt; startedConnecting gets the correct string, but all I have there is a
</I>&gt;<i> &gt; connection object.  I need the correct data in buildProtocol to do it
</I>&gt;<i> &gt; this way.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ------------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; C:\Users\Mark\src\play&gt;python testclient.py
</I>&gt;<i> &gt; startFactory: FirstString...
</I>&gt;<i> &gt; Started connecting: &lt;twisted.internet.tcp.Connector instance at
</I>&gt;<i> 0x01DAB620&gt;
</I>&gt;<i> &gt; FirstString...
</I>&gt;<i> &gt; Started connecting: &lt;twisted.internet.tcp.Connector instance at
</I>&gt;<i> 0x01E0EFD0&gt;
</I>&gt;<i> &gt; SecondString
</I>&gt;<i> &gt; bulldProtocol: IPv4Address(TCP, '127.0.0.1', 7300)
</I>&gt;<i> &gt; buildProtocol: SecondString
</I>&gt;<i> &gt; Client Connected: SecondString
</I>&gt;<i> &gt; Welcome to SimpleServer5
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; bulldProtocol: IPv4Address(TCP, '127.0.0.1', 7300)
</I>&gt;<i> &gt; buildProtocol: SecondString
</I>&gt;<i> &gt; Client Connected: SecondString
</I>&gt;<i> &gt; Welcome to SimpleServer5
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My &quot;best&quot; idea is to pass the strings to the factory in a dictionary
</I>&gt;<i> &gt; indexed by the IP address and the port.  Then, buildProtocol() can use
</I>&gt;<i> &gt; that to recover the string and I can use reactor.resolve() to translate
</I>&gt;<i> &gt; the host name to the IP address.  The real application won't have
</I>&gt;<i> &gt; multiple connections to the same host and port like this example, so
</I>&gt;<i> &gt; this would work.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; There MUST be a better way.  :-)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My &quot;simpleserver&quot; is below if you want to run this.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; THANKS for all of your help.  I have the basic application running now
</I>&gt;<i> &gt; (including a Tkinter GUI  :-) ) and Twisted has saved me hundreds or
</I>&gt;<i> &gt; even thousands of lines of code...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Mark Bailey
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; from twisted.conch.telnet import StatefulTelnetProtocol
</I>&gt;<i> &gt; from twisted.internet import reactor, protocol
</I>&gt;<i> &gt; from twisted.protocols.basic import LineReceiver
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; class TelnetEcho(StatefulTelnetProtocol):
</I>&gt;<i> &gt;     def connectionMade(self):
</I>&gt;<i> &gt;         self.factory.connection.append(self)
</I>&gt;<i> &gt;         self.sendLine(&quot;Welcome to SimpleServer5\r\n&quot;)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def lineReceived(self, data):
</I>&gt;<i> &gt;         data = data.rstrip('\n\r')
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;         if data.upper() == 'BYE':
</I>&gt;<i> &gt;             self.sendLine(&quot;Goodbye...\r&quot;)
</I>&gt;<i> &gt;             self.transport.loseConnection()
</I>&gt;<i> &gt;         else:
</I>&gt;<i> &gt;             self.sendLine(&quot;Unrecognized command: %r\r&quot; % (data,))
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def connectionLost(self, reason):
</I>&gt;<i> &gt;         self.factory.connection.remove(self)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; class TelnetEchoFactory(protocol.Factory):
</I>&gt;<i> &gt;     protocol = TelnetEcho
</I>&gt;<i> &gt;     def __init__(self):
</I>&gt;<i> &gt;         self.connection = []
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; def createTelnetServer(port=7300):
</I>&gt;<i> &gt;     telnetinstance = TelnetEchoFactory()       #  needs to be a list
</I>&gt;<i> &gt;     reactor.listenTCP(port,telnetinstance)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; if __name__ == &quot;__main__&quot;:
</I>&gt;<i> &gt;     reactor.callWhenRunning(createTelnetServer)
</I>&gt;<i> &gt;     reactor.run()
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ------------------------------------------------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Twisted-Python mailing list
</I>&gt;<i> &gt; <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt; <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v1.4.9 (GNU/Linux)
</I>&gt;<i> Comment: Using GnuPG with Mozilla - <A HREF="http://enigmail.mozdev.org/">http://enigmail.mozdev.org/</A>
</I>&gt;<i>
</I>&gt;<i> iEYEARECAAYFAktzC0MACgkQigE4AbflYer9nwCgixra0FaTD6ubvGJufjApRG/m
</I>&gt;<i> A34An3C2ng+4x3/halWSgGQUvQvsCiTM
</I>&gt;<i> =Cg6W
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20100210/99001b18/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20100210/99001b18/attachment.htm</A> 
</PRE>




























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021519.html">[Twisted-Python] How can I send unique configuration data for multiple connections through a factory?
</A></li>
	<LI>Next message: <A HREF="021529.html">[Twisted-Python] multiple versions of twisted on same machine
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21527">[ date ]</a>
              <a href="thread.html#21527">[ thread ]</a>
              <a href="subject.html#21527">[ subject ]</a>
              <a href="author.html#21527">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
