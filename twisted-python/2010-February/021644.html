<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] debugging a memory leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20debugging%20a%20memory%20leak&In-Reply-To=007601cab42a%24d4c755e0%247e5601a0%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021643.html">
   <LINK REL="Next"  HREF="021646.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] debugging a memory leak</H1>
    <B>Maarten ter Huurne</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20debugging%20a%20memory%20leak&In-Reply-To=007601cab42a%24d4c755e0%247e5601a0%24%40com"
       TITLE="[Twisted-Python] debugging a memory leak">maarten at treewalker.org
       </A><BR>
    <I>Mon Feb 22 21:24:24 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021643.html">[Twisted-Python] debugging a memory leak
</A></li>
        <LI>Next message: <A HREF="021646.html">[Twisted-Python] debugging a memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21644">[ date ]</a>
              <a href="thread.html#21644">[ thread ]</a>
              <a href="subject.html#21644">[ subject ]</a>
              <a href="author.html#21644">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tuesday 23 February 2010, Alec Matusis wrote:

&gt;<i> When I start the process, both python object sizes and their counts rise
</I>&gt;<i> proportionally to the numbers of reconnected clients, and then they
</I>&gt;<i> stabilize after all clients have reconnected.
</I>&gt;<i> At that moment, the &quot;external&quot; RSS process size is about 260MB. The
</I>&gt;<i> &quot;internal size&quot; of all python objects reported by Heapy is about 150MB.
</I>&gt;<i> After two days, the internal sizes/counts stay the same, but the external
</I>&gt;<i> size grows to 1500MB.
</I>&gt;<i> 
</I>&gt;<i> Python object counts/total sizes are measured from the manhole.
</I>&gt;<i> Is this sufficient to conclude that this is a C memory leak in one of the
</I>&gt;<i> external modules or in the Python interpreter itself?
</I>
In general, there are other reasons why heap size and RSS size do not match:
1. pages are empty but not returned to the OS
2. pages cannot be returned to the OS because they are not completely empty

It seems Python has different allocators for small and large objects:
<A HREF="http://www.mail-archive.com/python-list@python.org/msg256116.html">http://www.mail-archive.com/python-list@python.org/msg256116.html</A>
<A HREF="http://effbot.org/pyfaq/why-doesnt-python-release-the-memory-when-i-delete-">http://effbot.org/pyfaq/why-doesnt-python-release-the-memory-when-i-delete-</A>
a-large-object.htm

Assuming Python uses malloc for all its allocations (does it?), it is the 
malloc implementation that determines whether empty pages are returned to 
the OS. Under Linux with glibc (your system?), empty pages are returned, so 
there reason 1 does not apply.

Depending on the allocation behaviour of Python, the pages may not be empty 
though, so reason 2 is a likely suspect.

Python extensions written in C could also leak or fragment memory. Are you 
using any extensions that are not pure Python?

Bye,
		Maarten

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021643.html">[Twisted-Python] debugging a memory leak
</A></li>
	<LI>Next message: <A HREF="021646.html">[Twisted-Python] debugging a memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21644">[ date ]</a>
              <a href="thread.html#21644">[ thread ]</a>
              <a href="subject.html#21644">[ subject ]</a>
              <a href="author.html#21644">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
