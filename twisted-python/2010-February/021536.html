<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] new epoll error after upgrading to 9.0.0
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20new%20epoll%20error%20after%20upgrading%20to%209.0.0&In-Reply-To=040f01caab78%24a5fdf670%24f1f9e350%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021535.html">
   <LINK REL="Next"  HREF="021538.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] new epoll error after upgrading to 9.0.0</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20new%20epoll%20error%20after%20upgrading%20to%209.0.0&In-Reply-To=040f01caab78%24a5fdf670%24f1f9e350%24%40com"
       TITLE="[Twisted-Python] new epoll error after upgrading to 9.0.0">exarkun at twistedmatrix.com
       </A><BR>
    <I>Thu Feb 11 21:54:37 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021535.html">[Twisted-Python] new epoll error after upgrading to 9.0.0
</A></li>
        <LI>Next message: <A HREF="021538.html">[Twisted-Python] Authenticating with md5 hashed passwords
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21536">[ date ]</a>
              <a href="thread.html#21536">[ thread ]</a>
              <a href="subject.html#21536">[ subject ]</a>
              <a href="author.html#21536">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12:16 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">matusis at yahoo.com</A> wrote:
&gt;<i>I upgraded to 9.0.0 and I am now seeing a new error, not present in 
</I>&gt;<i>8.2.0 or
</I>&gt;<i>earlier:
</I>&gt;<i>
</I>&gt;<i>[snip]
</I>&gt;<i>&quot;/usr/local/encap/python-2.6.4/lib/python2.6/site- 
</I>&gt;<i>packages/Twisted-9.0.0-py2
</I>&gt;<i>.6-linux-x86_64.egg/twisted/internet/abstract.py&quot;, line 267, in 
</I>&gt;<i>stopWriting
</I>&gt;<i>            self.reactor.removeWriter(self)
</I>&gt;<i>          File
</I>&gt;<i>&quot;/usr/local/encap/python-2.6.4/lib/python2.6/site- 
</I>&gt;<i>packages/Twisted-9.0.0-py2
</I>&gt;<i>.6-linux-x86_64.egg/twisted/internet/epollreactor.py&quot;, line 145, in
</I>&gt;<i>removeWriter
</I>&gt;<i>            self._remove(writer, self._writes, self._reads,
</I>&gt;<i>self._selectables, _epoll.OUT, _epoll.IN)
</I>&gt;<i>          File
</I>&gt;<i>&quot;/usr/local/encap/python-2.6.4/lib/python2.6/site- 
</I>&gt;<i>packages/Twisted-9.0.0-py2
</I>&gt;<i>.6-linux-x86_64.egg/twisted/internet/epollreactor.py&quot;, line 131, in 
</I>&gt;<i>_remove
</I>&gt;<i>            self._poller._control(cmd, fd, flags)
</I>&gt;<i>          File &quot;_epoll.pyx&quot;, line 125, in _epoll.epoll._control
</I>&gt;<i>
</I>&gt;<i>        exceptions.IOError: [Errno 2] No such file or directory
</I>&gt;<i>
</I>&gt;<i>The error is highy intemittent and occurs only under high connection 
</I>&gt;<i>client
</I>&gt;<i>rate. Any idea of what this could be?
</I>
Translating into English, a descriptor being monitored for writeability 
is being removed from the reactor, but epoll thinks it isn't being 
monitored in the first place.

It seems likely this is caused by an attempt to double remove something. 
However, why that would happen will probably take a bit more digging.

There was one direct change to epollreactor.py between 8.2 and 9.0:

  <A HREF="http://twistedmatrix.com/trac/changeset/26118#file1">http://twistedmatrix.com/trac/changeset/26118#file1</A>

It was to reactor shutdown code, though, so it seems like it probably 
isn't coming in to play in your case.

A number of other indirect changes were made, though (eg to the epoll 
reactor's base classes or other support code it uses).  It's conceivable 
one of these introduced the problem.  One could also imagine that the 
problem existed all along, and one of the changes merely nudged some 
race condition and now it's going badly for your app.

As far as suggestions for how to track this down go...

Well, minimizing the example is always nice. ;)  Aside from that, one 
idea that presents itself to me is to instrument the reactor to record 
addWriter/removeWriter events, and then log the complete stream of them 
for a particular writer when a double removeWriter is attempted. 
Initially you might just track that they happen, and use the result to 
confirm or reject the double removeWriter hypothesis.  If it holds up, 
it might be useful to add stack recording, in order to see why things 
are happening.

It may even be easy to implement this as a tiny reactor wrapper, which 
would make it easier to deploy and enable/disable.  If this doesn't 
disrupt your production environment overly, it might be worth trying.

Keep us updated. :)

Jean-Paul

</PRE>





























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021535.html">[Twisted-Python] new epoll error after upgrading to 9.0.0
</A></li>
	<LI>Next message: <A HREF="021538.html">[Twisted-Python] Authenticating with md5 hashed passwords
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21536">[ date ]</a>
              <a href="thread.html#21536">[ thread ]</a>
              <a href="subject.html#21536">[ subject ]</a>
              <a href="author.html#21536">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
