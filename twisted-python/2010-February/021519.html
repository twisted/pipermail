<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How can I send unique configuration data for multiple connections through a factory?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20I%20send%20unique%20configuration%20data%20for%0A%20multiple%20connections%20through%20a%20factory%3F&In-Reply-To=dc408fe51002101053g4234a5c3nc1040f9c72a9abae%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021512.html">
   <LINK REL="Next"  HREF="021527.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How can I send unique configuration data for multiple connections through a factory?</H1>
    <B>Arjan Scherpenisse</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20can%20I%20send%20unique%20configuration%20data%20for%0A%20multiple%20connections%20through%20a%20factory%3F&In-Reply-To=dc408fe51002101053g4234a5c3nc1040f9c72a9abae%40mail.gmail.com"
       TITLE="[Twisted-Python] How can I send unique configuration data for multiple connections through a factory?">arjan at scherpenisse.net
       </A><BR>
    <I>Wed Feb 10 14:38:48 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021512.html">[Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?
</A></li>
        <LI>Next message: <A HREF="021527.html">[Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21519">[ date ]</a>
              <a href="thread.html#21519">[ thread ]</a>
              <a href="subject.html#21519">[ subject ]</a>
              <a href="author.html#21519">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

If you create two instances of your ClusterClientFactory, each with a
unique string, you should be fine. Requires only a small modification:

         factory = ClusterClientFactory()
         factory.maxDelay = 120  #  two minutes
         factory.connectString = &quot;FirstString...&quot;
         reactor.connectTCP(&quot;localhost&quot;, 7300, factory)

         factory2 = ClusterClientFactory()
         factory2.maxDelay = 120  #  two minutes
         factory2.connectString = &quot;SecondString&quot;
         reactor2.connectTCP(&quot;localhost&quot;, 7300, factory)

You can clean this up by putting the maxDelay and connectString in the
constructor of the factory:

reactor2.connectTCP(&quot;localhost&quot;, 7300, ClusterClientFactory(120, &quot;First&quot;))
reactor2.connectTCP(&quot;localhost&quot;, 7300, ClusterClientFactory(120, &quot;Second&quot;))

Arjan

Mark Bailey wrote:
&gt;<i> Good day:
</I>&gt;<i> 
</I>&gt;<i> I've been having fun with Twisted.  I have my application running fine,
</I>&gt;<i> with multiple server and client connections using Telnet.  :-)
</I>&gt;<i> 
</I>&gt;<i> However, users always want something.  I need to send some unique
</I>&gt;<i> configuration information to each connection.  The connections are made
</I>&gt;<i> using connectTCP.  My first attempt assumed that the connection was made
</I>&gt;<i> when the call to connectTCP was executed.  It didn't work!  :-(
</I>&gt;<i> 
</I>&gt;<i> -------------------------------
</I>&gt;<i> 
</I>&gt;<i> from twisted.internet.protocol import ClientFactory
</I>&gt;<i> from twisted.internet import reactor
</I>&gt;<i> from twisted.conch.telnet import StatefulTelnetProtocol
</I>&gt;<i> 
</I>&gt;<i> class testClient(StatefulTelnetProtocol):
</I>&gt;<i> 
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         self.title = self.factory.connectString
</I>&gt;<i>         print &quot;Client Connected: &quot; + self.title
</I>&gt;<i>         self.setRawMode()
</I>&gt;<i>         self.factory.connections.append(self)
</I>&gt;<i> 
</I>&gt;<i>     def connectionLost(self, reason):
</I>&gt;<i>         if self in self.factory.connections:
</I>&gt;<i>             self.factory.connections.remove(self)
</I>&gt;<i> 
</I>&gt;<i>     def rawDataReceived(self,data):
</I>&gt;<i>         print data + &quot;\n&quot;
</I>&gt;<i> 
</I>&gt;<i> class ClusterClientFactory(ClientFactory):
</I>&gt;<i> 
</I>&gt;<i>     protocol = testClient
</I>&gt;<i> 
</I>&gt;<i>     def __init__(self):
</I>&gt;<i>         self.connections = []
</I>&gt;<i>         self.connectString = ''
</I>&gt;<i> 
</I>&gt;<i>     def startFactory(self):
</I>&gt;<i>         print &quot;startFactory: &quot; + self.connectString
</I>&gt;<i> 
</I>&gt;<i>     def startedConnecting(self, connector):
</I>&gt;<i>         print &quot;Started connecting: &quot; + str(connector)
</I>&gt;<i>         print self.connectString
</I>&gt;<i> 
</I>&gt;<i>     def buildProtocol(self, addr):
</I>&gt;<i>         print &quot;bulldProtocol: &quot; + str(addr)
</I>&gt;<i>         print &quot;buildProtocol: &quot; + self.connectString
</I>&gt;<i> 
</I>&gt;<i>         p = self.protocol()
</I>&gt;<i>         p.factory = self
</I>&gt;<i>         return p
</I>&gt;<i> 
</I>&gt;<i> if __name__ == '__main__':
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     def startUp():
</I>&gt;<i> 
</I>&gt;<i>         factory = ClusterClientFactory()
</I>&gt;<i>         factory.maxDelay = 120  #  two minutes
</I>&gt;<i> 
</I>&gt;<i>         factory.connectString = &quot;FirstString...&quot;
</I>&gt;<i>         reactor.connectTCP(&quot;localhost&quot;, 7300, factory)
</I>&gt;<i> 
</I>&gt;<i>         factory.connectString = &quot;SecondString&quot;
</I>&gt;<i>         reactor.connectTCP(&quot;localhost&quot;, 7300, factory)
</I>&gt;<i> 
</I>&gt;<i>     reactor.callWhenRunning(startUp)
</I>&gt;<i>     reactor.run()
</I>&gt;<i> 
</I>&gt;<i> ----------------------------------
</I>&gt;<i> 
</I>&gt;<i> The results are that buildProtocol gets the second string both times. 
</I>&gt;<i> startedConnecting gets the correct string, but all I have there is a
</I>&gt;<i> connection object.  I need the correct data in buildProtocol to do it
</I>&gt;<i> this way.
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------
</I>&gt;<i> 
</I>&gt;<i> C:\Users\Mark\src\play&gt;python testclient.py
</I>&gt;<i> startFactory: FirstString...
</I>&gt;<i> Started connecting: &lt;twisted.internet.tcp.Connector instance at 0x01DAB620&gt;
</I>&gt;<i> FirstString...
</I>&gt;<i> Started connecting: &lt;twisted.internet.tcp.Connector instance at 0x01E0EFD0&gt;
</I>&gt;<i> SecondString
</I>&gt;<i> bulldProtocol: IPv4Address(TCP, '127.0.0.1', 7300)
</I>&gt;<i> buildProtocol: SecondString
</I>&gt;<i> Client Connected: SecondString
</I>&gt;<i> Welcome to SimpleServer5
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> bulldProtocol: IPv4Address(TCP, '127.0.0.1', 7300)
</I>&gt;<i> buildProtocol: SecondString
</I>&gt;<i> Client Connected: SecondString
</I>&gt;<i> Welcome to SimpleServer5
</I>&gt;<i> 
</I>&gt;<i> --------------------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My &quot;best&quot; idea is to pass the strings to the factory in a dictionary
</I>&gt;<i> indexed by the IP address and the port.  Then, buildProtocol() can use
</I>&gt;<i> that to recover the string and I can use reactor.resolve() to translate
</I>&gt;<i> the host name to the IP address.  The real application won't have
</I>&gt;<i> multiple connections to the same host and port like this example, so
</I>&gt;<i> this would work.
</I>&gt;<i> 
</I>&gt;<i> There MUST be a better way.  :-)
</I>&gt;<i> 
</I>&gt;<i> My &quot;simpleserver&quot; is below if you want to run this.
</I>&gt;<i> 
</I>&gt;<i> THANKS for all of your help.  I have the basic application running now
</I>&gt;<i> (including a Tkinter GUI  :-) ) and Twisted has saved me hundreds or
</I>&gt;<i> even thousands of lines of code...
</I>&gt;<i> 
</I>&gt;<i> Mark Bailey
</I>&gt;<i> 
</I>&gt;<i> ------------------------------
</I>&gt;<i> 
</I>&gt;<i> from twisted.conch.telnet import StatefulTelnetProtocol
</I>&gt;<i> from twisted.internet import reactor, protocol
</I>&gt;<i> from twisted.protocols.basic import LineReceiver
</I>&gt;<i> 
</I>&gt;<i> class TelnetEcho(StatefulTelnetProtocol):
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         self.factory.connection.append(self)
</I>&gt;<i>         self.sendLine(&quot;Welcome to SimpleServer5\r\n&quot;)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     def lineReceived(self, data):
</I>&gt;<i>         data = data.rstrip('\n\r')
</I>&gt;<i> 
</I>&gt;<i>         if data.upper() == 'BYE':
</I>&gt;<i>             self.sendLine(&quot;Goodbye...\r&quot;)
</I>&gt;<i>             self.transport.loseConnection()
</I>&gt;<i>         else:
</I>&gt;<i>             self.sendLine(&quot;Unrecognized command: %r\r&quot; % (data,))
</I>&gt;<i> 
</I>&gt;<i>     def connectionLost(self, reason):
</I>&gt;<i>         self.factory.connection.remove(self)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> class TelnetEchoFactory(protocol.Factory):
</I>&gt;<i>     protocol = TelnetEcho
</I>&gt;<i>     def __init__(self):
</I>&gt;<i>         self.connection = []
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> def createTelnetServer(port=7300):
</I>&gt;<i>     telnetinstance = TelnetEchoFactory()       #  needs to be a list
</I>&gt;<i>     reactor.listenTCP(port,telnetinstance)
</I>&gt;<i> 
</I>&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;<i>     reactor.callWhenRunning(createTelnetServer)
</I>&gt;<i>     reactor.run()
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <A HREF="http://enigmail.mozdev.org/">http://enigmail.mozdev.org/</A>

iEYEARECAAYFAktzC0MACgkQigE4AbflYer9nwCgixra0FaTD6ubvGJufjApRG/m
A34An3C2ng+4x3/halWSgGQUvQvsCiTM
=Cg6W
-----END PGP SIGNATURE-----

</PRE>



































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021512.html">[Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?
</A></li>
	<LI>Next message: <A HREF="021527.html">[Twisted-Python] How can I send unique configuration data for	multiple connections through a factory?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21519">[ date ]</a>
              <a href="thread.html#21519">[ thread ]</a>
              <a href="subject.html#21519">[ subject ]</a>
              <a href="author.html#21519">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
