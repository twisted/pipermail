<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] debugging a memory leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20debugging%20a%20memory%20leak&In-Reply-To=%3C4B8722BD.2060900%40densedata.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="054170.html">
   <LINK REL="Next"  HREF="054182.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] debugging a memory leak</H1>
    <B>Johann Borck</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20debugging%20a%20memory%20leak&In-Reply-To=%3C4B8722BD.2060900%40densedata.com%3E"
       TITLE="[Twisted-Python] debugging a memory leak">johann.borck at densedata.com
       </A><BR>
    <I>Thu Feb 25 18:24:13 MST 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="054170.html">[Twisted-Python] debugging a memory leak
</A></li>
        <LI>Next message (by thread): <A HREF="054182.html">[Twisted-Python] debugging a memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54181">[ date ]</a>
              <a href="thread.html#54181">[ thread ]</a>
              <a href="subject.html#54181">[ subject ]</a>
              <a href="author.html#54181">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alec Matusis wrote:
&gt;<i> In desperation of not finding the real memory leak on the production server,
</I>&gt;<i>
</I>&gt;<i> I wrote a test server that I can push to arbitrary high RSS memory. I am far
</I>&gt;<i> from sure if this the same leak that I observe in production, but I would
</I>&gt;<i> like to understand what this one is. 
</I>&gt;<i> This is the server code:
</I>&gt;<i>
</I>&gt;<i> Server.py:
</I>&gt;<i>
</I>&gt;<i> import twisted.protocols.basic
</I>&gt;<i> from twisted.internet.protocol import Factory
</I>&gt;<i> from twisted.internet import reactor
</I>&gt;<i>         
</I>&gt;<i> class HiRate(twisted.protocols.basic.LineOnlyReceiver):
</I>&gt;<i>         MAX_LENGTH = 20000
</I>&gt;<i>         
</I>&gt;<i>         def lineReceived(self, line):
</I>&gt;<i>                 if line == 'get':
</I>&gt;<i>                         out = 'a'*4000+'\r\r' 
</I>&gt;<i>                         self.transport.write(out)
</I>&gt;<i>         
</I>&gt;<i>                 
</I>&gt;<i>                 
</I>&gt;<i> factory = Factory()
</I>&gt;<i> factory.protocol = HiRate
</I>&gt;<i>         
</I>&gt;<i> reactor.listenTCP(8007, factory, backlog=50, interface='10.18.0.2')
</I>&gt;<i> reactor.run()   
</I>&gt;<i> [...]
</I>&gt;<i> To reproduce the memory leak, I either need two machines with fast LAN
</I>&gt;<i> between them (since the client program takes 100% CPU), or possibly one
</I>&gt;<i> machine with a dual core CPU (I have not tried that). It is important that
</I>&gt;<i> client.py is given a separate CPU to run.
</I>&gt;<i> When the length of the response from the server is sufficient,  (out =
</I>&gt;<i> 'a'*4000+'\r\r' ,  4000 is enough in my case), the RSS of the server process
</I>&gt;<i> starts to leak without a bound.
</I>&gt;<i> If you introduce a small delay in the client (#time.sleep(.001)), the leak
</I>&gt;<i> does not occur.
</I>&gt;<i>
</I>&gt;<i>   
</I>Hi Alec,
I wouldn't call that a memory leak. In your example  ( SC/s = (n* CS) / 
s ;  n &gt; 1, SC: bytes sent to the client, CS: bytes sent to the server ) 
there is some CS that satifies the condition SC/s &gt; [available 
bandwidth]. For all CS that exceed that limit, the data will be first 
queued in the Send-Q of the socket and then inside twisted, because the 
Send-Q is full. That's the reason why you see increasing memory usage, 
but it's not a leak, it is a server that can not cope with this kind of 
DOS attack. Twisted can not handle this situation for you because that 
would mean it had to decide which packets, connections, etc. to drop. 
Such decisions have to be made by your application.

regards,
Johann



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="054170.html">[Twisted-Python] debugging a memory leak
</A></li>
	<LI>Next message (by thread): <A HREF="054182.html">[Twisted-Python] debugging a memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54181">[ date ]</a>
              <a href="thread.html#54181">[ thread ]</a>
              <a href="subject.html#54181">[ subject ]</a>
              <a href="author.html#54181">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
