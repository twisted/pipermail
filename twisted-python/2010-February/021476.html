<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Question about ReconnectingClientFactory and conch	StatefulTelnetProtocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Question%20about%20ReconnectingClientFactory%20and%0A%20conch%09StatefulTelnetProtocol&In-Reply-To=dc408fe51002051623w2cd97611kada178fad8df5030%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021475.html">
   <LINK REL="Next"  HREF="021477.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Question about ReconnectingClientFactory and conch	StatefulTelnetProtocol</H1>
    <B>Lucas Taylor</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Question%20about%20ReconnectingClientFactory%20and%0A%20conch%09StatefulTelnetProtocol&In-Reply-To=dc408fe51002051623w2cd97611kada178fad8df5030%40mail.gmail.com"
       TITLE="[Twisted-Python] Question about ReconnectingClientFactory and conch	StatefulTelnetProtocol">ltaylor.volks at gmail.com
       </A><BR>
    <I>Fri Feb  5 20:04:03 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021475.html">[Twisted-Python] Question about ReconnectingClientFactory and conch	StatefulTelnetProtocol
</A></li>
        <LI>Next message: <A HREF="021477.html">[Twisted-Python] Question about ReconnectingClientFactory and	conch StatefulTelnetProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21476">[ date ]</a>
              <a href="thread.html#21476">[ thread ]</a>
              <a href="subject.html#21476">[ subject ]</a>
              <a href="author.html#21476">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/5/10 5:23 PM, Mark Bailey wrote:
&gt;<i> Good day, everyone:
</I>&gt;<i> 
</I>&gt;<i> Continuing my effort to learn Python and Twisted, I need to create
</I>&gt;<i> several Telnet clients and somehow send two arguments to each and
</I>&gt;<i> receive data from each.
</I>&gt;<i> 
</I>&gt;<i> I tried the same pattern that I used with the Telnet server and created
</I>&gt;<i> a Factory, actually a ReconnectingClientFactory.  It doesn't work.  My
</I>&gt;<i> source and the error (no attribute 'factory') are below.
</I>&gt;<i> 
</I>&gt;<i> Do the &quot;conch&quot; protocols not support a factory?  Is there an alternative
</I>&gt;<i> that provides a Telnet client with a lineReceived method?
</I>&gt;<i> 
</I>&gt;<i> What am I doing wrong?  :-)  I suppose I could pass arguments to
</I>&gt;<i> ClusterClient by overriding __init__, but that seems inelegant.
</I>&gt;<i> 
</I>&gt;<i> Thanks for your help.
</I>&gt;<i> 
</I>&gt;<i> Mark
</I>&gt;<i>
</I>&gt;<i> ----------
</I>&gt;<i> 
</I>&gt;<i> from twisted.internet.protocol import Protocol, ReconnectingClientFactory
</I>&gt;<i> from sys import stdout
</I>&gt;<i> 
</I>&gt;<i> from twisted.internet import reactor
</I>&gt;<i> 
</I>&gt;<i> from twisted.conch.telnet import StatefulTelnetProtocol
</I>&gt;<i> 
</I>&gt;<i> class ClusterClient(StatefulTelnetProtocol):
</I>&gt;<i> 
</I>&gt;<i>     def lineReceived(self, data):
</I>&gt;<i>         print self.factory.prompt, self.factory.call
</I>&gt;<i>         print data
</I>&gt;<i> 
</I>&gt;<i> class ClusterClientFactory(ReconnectingClientFactory):
</I>&gt;<i> 
</I>&gt;<i>     protocol = ClusterClient
</I>&gt;<i> 
</I>&gt;<i>     def __init__(self):
</I>&gt;<i>         self.prompt = &quot;call:&quot;
</I>&gt;<i>         self.call = &quot;kd4d&quot;
</I>&gt;<i> 
</I>&gt;<i>     def startedConnecting(self, connector):
</I>&gt;<i>         print 'Started to connect.'
</I>&gt;<i> 
</I>&gt;<i>     def buildProtocol(self, addr):
</I>&gt;<i>         print 'Connected.'
</I>&gt;<i>         self.resetDelay()
</I>&gt;<i>         return ClusterClient()
</I>&gt;<i> 
</I>&gt;<i>     def clientConnectionLost(self, connector, reason):
</I>&gt;<i>         print 'Lost connection.  Reason:', reason
</I>&gt;<i>         ReconnectingClientFactory.clientConnectionLost(self, connector,
</I>&gt;<i> reason)
</I>&gt;<i> 
</I>&gt;<i>     def clientConnectionFailed(self, connector, reason):
</I>&gt;<i>         print 'Connection failed. Reason:', reason
</I>&gt;<i>         ReconnectingClientFactory.clientConnectionFailed(self, connector,
</I>&gt;<i>                                                          reason)
</I>&gt;<i> if __name__ == '__main__':
</I>&gt;<i>     factory = ClusterClientFactory()
</I>&gt;<i>     factory.maxDelay = 120  #  two minutes
</I>&gt;<i>     print factory.prompt, factory.call
</I>&gt;<i>     reactor.connectTCP(&quot;localhost&quot;, 8023, factory)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     reactor.run()
</I>&gt;<i> 
</I>&gt;<i> -----------------
</I>&gt;<i> 
</I>&gt;<i>   File &quot;ClusterClient.py&quot;, line 11, in lineReceived
</I>&gt;<i>     print self.factory.prompt, self.factory.call
</I>&gt;<i> exceptions.AttributeError: ClusterClient instance has no attribute 'factory'
</I>&gt;<i> Lost connection.  Reason: [Failure instance: Traceback (failure with no
</I>&gt;<i> frames):
</I>&gt;<i>  &lt;type 'exceptions.AttributeError'&gt;: ClusterClient instance has no
</I>&gt;<i> attribute 'fa
</I>&gt;<i> ctory'
</I>&gt;<i> ]
</I>&gt;<i> 
</I>


Hi Mark,

The problem is that you have overridden buildProtocol in your Factory
and not set the factory attribute on the protocol instance
(ClusterClient instance has no attribute 'factory').

buildProtocol is responsible for creating the protocol instance and the
default implementation takes care of assigning the factory to the protocol.

see the source for Factory and buildProtocol...it's very concise:

<A HREF="http://twistedmatrix.com/trac/browser/tags/releases/twisted-9.0.0/twisted/internet/protocol.py#L87">http://twistedmatrix.com/trac/browser/tags/releases/twisted-9.0.0/twisted/internet/protocol.py#L87</A>
<A HREF="http://twistedmatrix.com/documents/9.0.0/api/twisted.internet.protocol.Factory.html#buildProtocol">http://twistedmatrix.com/documents/9.0.0/api/twisted.internet.protocol.Factory.html#buildProtocol</A>


So something like this should work in your case:

    def buildProtocol(self, addr):
        print 'Connected.'
        self.resetDelay()
        p = self.protocol()
        p.factory = self
	return p


This doc is also helpful for understanding the relationship between
Protocols and Factories:
<A HREF="http://twistedmatrix.com/documents/current/core/howto/servers.html">http://twistedmatrix.com/documents/current/core/howto/servers.html</A>

It may be worth emphasizing that there's no real magic going on
here...you're just assigning a python object as an attribute of the
protocol instance.


Lucas


</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021475.html">[Twisted-Python] Question about ReconnectingClientFactory and conch	StatefulTelnetProtocol
</A></li>
	<LI>Next message: <A HREF="021477.html">[Twisted-Python] Question about ReconnectingClientFactory and	conch StatefulTelnetProtocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21476">[ date ]</a>
              <a href="thread.html#21476">[ thread ]</a>
              <a href="subject.html#21476">[ subject ]</a>
              <a href="author.html#21476">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
