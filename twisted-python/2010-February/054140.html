<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] IMAP4 Client extrange behavior
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IMAP4%20Client%20extrange%20behavior&In-Reply-To=%3Cb302bf881002220825g2be89yf0aa7ec7503ab1de%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="054139.html">
   <LINK REL="Next"  HREF="021642.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] IMAP4 Client extrange behavior</H1>
    <B>César García</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IMAP4%20Client%20extrange%20behavior&In-Reply-To=%3Cb302bf881002220825g2be89yf0aa7ec7503ab1de%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] IMAP4 Client extrange behavior">celord at gmail.com
       </A><BR>
    <I>Mon Feb 22 09:25:58 MST 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="054139.html">[Twisted-Python] Looking for companies doing Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="021642.html">[Twisted-Python] twisted.protocol.sip
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54140">[ date ]</a>
              <a href="thread.html#54140">[ thread ]</a>
              <a href="subject.html#54140">[ subject ]</a>
              <a href="author.html#54140">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all, I have this imap4 client <A HREF="http://www.pastebin.com/m4e387f1a">http://www.pastebin.com/m4e387f1a</A>
most of the code is barrowed from a IRC friend, bob_f , it works fine
but as soon as more that 1 email arrrives to the inbox, it only prints
the first new messages but not the others,  I wonder what am I doing
wrong

Thanks a lot







Here is the code:

#!/usr/bin/env python
#coding=utf-8


&quot;&quot;&quot;
Client de IMAP4 que descarga contenido del INBOX de una cuenta en especifico
para luego extraer el numero de telefono que debe venir en los correos enviados
&quot;&quot;&quot;

import StringIO
import sys
from Config import retCredentials

from twisted.internet.task import LoopingCall
from twisted.internet import protocol
from twisted.internet import defer
from twisted.mail import imap4
from twisted.python import util
from twisted.python import log
from twisted.internet import reactor
debug = 1

class IMAP4Client(imap4.IMAP4Client):

    def serverGreeting(self,caps):
        &quot;&quot;&quot;
        Metodo llamado cuando el servidor contesta
        &quot;&quot;&quot;
        if debug: print &quot;On serverGreeting&quot;

        self.serverCapabilities = caps
        if self.greetDeferred is not None:
            d, self.greetDeferred = self.greetDeferred, None
            d.addCallback(self.cbLogin)
            d.callback(self)


    def cbLogin(self, proto):
        &quot;&quot;&quot;
        Callback to IMAP login
        &quot;&quot;&quot;
        if debug: print &quot;On Login&quot;

        login =  self.login(self.factory.username, self.factory.password)
        login.addCallback(self.startPolling)


    def startPolling(self, proto):
        &quot;&quot;&quot;
        Callback to poll every x seconds
        &quot;&quot;&quot;
        call = LoopingCall(self.selectMailbox,mailbox=&quot;INBOX&quot;)
        call.start(20, now=True)


    def selectMailbox(self, mailbox):
        &quot;&quot;&quot;
        Select the mailbox to examin
        &quot;&quot;&quot;
        if debug: print &quot;On selectMailbox&quot;

        mailbox = self.factory.mailbox
        return self.select(mailbox).addCallback(self.cbSelectSuccess)


    def cbSelectSuccess(self, selected):
        &quot;&quot;&quot;
        Examine the INBOX mailbox for new mails

        &quot;&quot;&quot;
        if debug: print &quot;On cbSelectSuccess&quot;


        self.messageCount = selected['EXISTS']
        print &quot;Messages: &quot;, self.messageCount

        unseen = selected['EXISTS'] - selected['RECENT']

        if selected['RECENT'] == 0:
            print &quot;No new messages&quot;
            return

        return self.fetchMessage(&quot;%s:*&quot; % (unseen)
                ).addCallback(self.cbProcMessages)

    def cbProcMessages(self,messages):

        print messages


class IMAP4ClientFactory(protocol.ClientFactory):

    protocol = IMAP4Client

    def __init__(self, username, password,  onConn):

        self.username = username
        self.password = password
        self.mailbox = 'INBOX'
        self.onConn = onConn

    def buildProtocol(self,addr):
        if debug: print &quot;On buildProtocol&quot;
        p = self.protocol()
        p.factory = self
        p.greetDeferred = self.onConn
        auth = imap4.CramMD5ClientAuthenticator(self.username)
        p.registerAuthenticator(auth)

        return p

    def clientConectionFailed(self, connector, reason):
        d, self.onConn = self.onConn, None
        d.errback(reason)



def ebConnection(reason):
    log.startLogging(sys.stdout)
    log.err(reason)
    reactor.stop()



PORT = 143
RESULT = &quot;INBOX&quot;


def main():
    credentials = retCredentials()
    hostname = credentials['server']
    username = credentials['mailbox']
    password = util.getPassword('IMAP4 Password: ')

    onConn = defer.Deferred(
            ).addErrback(ebConnection
            )

    factory = IMAP4ClientFactory(username, password, onConn)


    reactor.connectTCP(hostname, PORT, factory)
    reactor.run()

if  __name__ == &quot;__main__&quot;:
    main()

-- 
<A HREF="http://celord.blogspot.com/">http://celord.blogspot.com/</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="054139.html">[Twisted-Python] Looking for companies doing Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="021642.html">[Twisted-Python] twisted.protocol.sip
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#54140">[ date ]</a>
              <a href="thread.html#54140">[ thread ]</a>
              <a href="subject.html#54140">[ subject ]</a>
              <a href="author.html#54140">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
