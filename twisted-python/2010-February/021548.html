<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Streaming File Transfer Protocol?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Streaming%20File%20Transfer%20Protocol%3F&In-Reply-To=1266098018.2532.63.camel%40kratos">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021547.html">
   <LINK REL="Next"  HREF="021549.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Streaming File Transfer Protocol?</H1>
    <B>John Santos</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Streaming%20File%20Transfer%20Protocol%3F&In-Reply-To=1266098018.2532.63.camel%40kratos"
       TITLE="[Twisted-Python] Streaming File Transfer Protocol?">JOHN at egh.com
       </A><BR>
    <I>Sat Feb 13 17:41:29 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="021547.html">[Twisted-Python] Streaming File Transfer Protocol?
</A></li>
        <LI>Next message: <A HREF="021549.html">[Twisted-Python] Streaming File Transfer Protocol?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21548">[ date ]</a>
              <a href="thread.html#21548">[ thread ]</a>
              <a href="subject.html#21548">[ subject ]</a>
              <a href="author.html#21548">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi -

I still regard myself as a newbie, and may have mangled some of
the terminology, but ...


A question I can answer!  I had the same problem...



Make your protocol class be an Int16StringReceiver (or 
Int&lt;size&gt;StringReceiver, I think there is an 8 and a 32 available
as well), and Twisted will do it for you.  When writing, it will
prepend the size to each message, and on the receiving side it
will accumulate pieces until it gets the full message, and then
call your stringReceived() method with the full message (length
stripped off.)

It you lose the connection in the middle of a message, I think
you'll get a connectionLost event, rather than a partial message
or an indefinite hang.

So your stringReceived() and sendString() usage looks exactly
the same, but behind the scenes, Twisted does all the work.

(TCP always delivers all the data you send in the correct order,
but the fragmentation can be random.  A single message can get
split into multiple chunks, and I think multiple messages could
get appended into a single chunk.  But the byte order seen by the
receiver is preserved, so the receiver can tell when a complete
message has arrived if it lays some sort of protocol on top of
the TCP stream.  It could be message lengths (this is what the
Int*StringReceiver protocols do), or it could be &quot;start&quot; and
&quot;Stop&quot; characters embedded in the stream (for example, FTP in
text mode or SMTP use &lt;CR&gt;&lt;LF&gt; to indicate ends of lines), or
it could be an agreed-upon count (I think FTP in binary mode
expects a series of 512-byte blocks, though I could be wrong
about this, and the receiver just partitions the incoming TCP
stream into groups of 512 bytes.)  I'm sure there are lots of
other ways to do it as well.  But the Twisted Int* protocol
should work fine for you.)

OBTW, the &quot;16&quot; is the number of bits in the message size
value; you should select a size large enough to hold your
largest message: &quot;8&quot; for up to 255 bytes, 16 allows for 65535
bytes and 32 allows something like 4MB.

The only two lines I had to change from my original code:

&gt;<i> from twisted.protocols.basic import Int16StringReceiver
</I>
&gt;<i> class MyProtocol(Int16StringReceiver):
</I>    [...]

Hope this helps.

-- 
John Santos
Evans Griffiths &amp; Hart, Inc.
781-861-0670 ext 539
-------------- next part --------------
I spoke too fast. But pardon my noobiness.



Ok, so I am using a simple protocol that is listening on a TCP port.



One the client side, I write 4096 bytes using

self.transport.write(bytes)



on dataReceived side, I get only 1448. 



Now, what I &quot;want&quot; to happen is when I issue a write of a known number

of bytes.

I &quot;want&quot; those bytes to arrive in total because they represent a pickled

object.

The server has no idea if the bytes are split and scattered (again, I

want the

control protocol to take affect).



1) Am I doing something wrong here?

2) Can I force twisted to send ALL the bytes I issue in the write

without

re-thinking TCP or forcing me to re-implement TCP?



thanks!

Darren



On Wed, 2010-02-10 at 18:34 -0500, Darren Govoni wrote:



&gt;<i> Thanks for that explanation David. Makes sense! 
</I>
&gt;<i> 
</I>
&gt;<i> On Wed, 2010-02-10 at 16:01 -0500, David Bolen wrote: 
</I>
&gt;<i> 
</I>
&gt;<i> &gt; Darren Govoni &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">darren at ontrenet.com</A>&gt; writes:
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; &gt;&gt;From what I learned in other posts, the dataReceived(self, data): in the
</I>
&gt;<i> &gt; &gt; Echo server
</I>
&gt;<i> &gt; &gt; will get called with out-of-order data/bytes from the client. Of course,
</I>
&gt;<i> &gt; &gt; I could be misinformed,
</I>
&gt;<i> &gt; &gt; but what I understood before was that in this type of Protocol, I would
</I>
&gt;<i> &gt; &gt; have to re-order
</I>
&gt;<i> &gt; &gt; and re-assemble the bytes.  And I'm trying to avoid that, since of
</I>
&gt;<i> &gt; &gt; course, TCP already does it.
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; Data being received out of order can't happen, as long as the Protocol
</I>
&gt;<i> &gt; is layered on top of TCP, since as you say, TCP already provides that
</I>
&gt;<i> &gt; guarantee.  The dataReceived() method is really just how the data
</I>
&gt;<i> &gt; being received from TCP is handed to the Protocol object.
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; UDP can be out of order, as it provides very few guarantees above and
</I>
&gt;<i> &gt; beyond IP itself.  But I'm not sure you can layer an IProtocol over
</I>
&gt;<i> &gt; UDP with Twisted.
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; There is a general issue where you may receive the data in differently
</I>
&gt;<i> &gt; sized chunks in dataReceived() than it might have been transmitted
</I>
&gt;<i> &gt; originally, which is a common source of confusion to people new to
</I>
&gt;<i> &gt; stream protocols, so perhaps you were thinking of that issue?
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; The stream nature (and possibility for early disconnect from the
</I>
&gt;<i> &gt; client) is why having some internal length information for bulk
</I>
&gt;<i> &gt; transfers is sensible.  For your original question, I was going to
</I>
&gt;<i> &gt; suggest an older posting of mine for a similar situation where I needed
</I>
&gt;<i> &gt; a bulk upload to augment a PB-based server, but it appears that you've
</I>
&gt;<i> &gt; located it in the archives yourself.
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; &gt; But like I said, I could have been misinformed because it seems pretty
</I>
&gt;<i> &gt; &gt; basic to write 1,2,3
</I>
&gt;<i> &gt; &gt; to a server and have it received 1,2,3, guaranteed.
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; Yes - TCP guarantees that what you transmit at one end will be
</I>
&gt;<i> &gt; received in order at the other end or not at all (e.g., outages,
</I>
&gt;<i> &gt; disconnects, etc...).  It has a weaker guarantee in terms of no
</I>
&gt;<i> &gt; corruption, but one that is, in combination with typical link layer
</I>
&gt;<i> &gt; protections, generally more than sufficient for the vast majority of
</I>
&gt;<i> &gt; connections using it each day.
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; -- David
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; 
</I>
&gt;<i> &gt; _______________________________________________
</I>
&gt;<i> &gt; Twisted-Python mailing list
</I>
&gt;<i> &gt; <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>
&gt;<i> &gt; <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
&gt;<i> 
</I>
&gt;<i> 
</I>
&gt;<i> 
</I>
&gt;<i> _______________________________________________
</I>
&gt;<i> Twisted-Python mailing list
</I>
&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>
&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>




-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20100213/ee8b4353/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20100213/ee8b4353/attachment.htm</A> 
-------------- next part --------------
_______________________________________________

Twisted-Python mailing list

<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>

<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021547.html">[Twisted-Python] Streaming File Transfer Protocol?
</A></li>
	<LI>Next message: <A HREF="021549.html">[Twisted-Python] Streaming File Transfer Protocol?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21548">[ date ]</a>
              <a href="thread.html#21548">[ thread ]</a>
              <a href="subject.html#21548">[ subject ]</a>
              <a href="author.html#21548">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
