<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] nonblocking stdio
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20nonblocking%20stdio&In-Reply-To=%3C20050428003329.15422.215602842.divmod.quotient.4470%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="042752.html">
   <LINK REL="Next"  HREF="042755.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] nonblocking stdio</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20nonblocking%20stdio&In-Reply-To=%3C20050428003329.15422.215602842.divmod.quotient.4470%40ohm%3E"
       TITLE="[Twisted-Python] nonblocking stdio">exarkun at divmod.com
       </A><BR>
    <I>Wed Apr 27 18:33:29 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="042752.html">[Twisted-Python] nonblocking stdio
</A></li>
        <LI>Next message (by thread): <A HREF="042755.html">[Twisted-Python] P2P Discovery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42753">[ date ]</a>
              <a href="thread.html#42753">[ thread ]</a>
              <a href="subject.html#42753">[ subject ]</a>
              <a href="author.html#42753">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 27 Apr 2005 16:59:56 -0700, &quot;Sir.shz&quot; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">sir.shz at gmail.com</A>&gt; wrote:
&gt;<i>Hi, I'm trying to write a test tcp client which sends some commands to the
</I>&gt;<i>server, I'd like the
</I>&gt;<i>client to take the commands from stdin, and sends it to the server. The
</I>&gt;<i>following code segment
</I>&gt;<i>doesn't seem to send anything, is it because the while loop is actually
</I>&gt;<i>blocking? what's the right way to
</I>&gt;<i>accomplish this? Thanks.
</I>
  There are a few things that you may want to do differently in your MyClientProtocol class.

&gt;<i>
</I>&gt;<i>Z.
</I>&gt;<i>
</I>&gt;<i>class MyClientProtocol(basic.LineReceiver):
</I>&gt;<i>     def lineReceived(self,data):
</I>&gt;<i>          stdout.write(&quot;From Server:&quot; + data+&quot;\n&quot;),
</I>&gt;<i>
</I>
  stdout.write (assuming that's sys.stdout) can block.  This doesn't happen too frequently, except under certain conditions: for example, if you have piped the output of the program to less and have been less than diligent than paging to the end of output (less will read so much beyond what it can display and then stop reading, which means your process will no longer be able to write, and so will block); another similar scenario occurs with screen(1) when switched into copy mode.

  If this is something you want to worry about, twisted.internet.stdio may be of use.  It provides a simple way to get stdout into non-blocking mode, and then does buffering for you in cases where it is required.

&gt;<i>     def connectionMade(self):
</I>&gt;<i>           while True:
</I>&gt;<i>                cmd = raw_input(&quot;Enter command:&quot;)
</I>&gt;<i>                self.transport.write(cmd+&quot;\r\n&quot;)
</I>
  There are a couple problems with this definition of connectionMade().  

  First, a &quot;while True:&quot; loop like this is pretty much off-limits in a Twisted application.  You're right about why - it blocks the entire reactor, preventing any work from being accomplished.  Even the calls to transport.write() inside this loop will probably result in nothing, since the reactor can't get to the socket associated with that transport and perform actual writes.  I'll come back to how you can achieve this behavior without blocking the reactor in a moment.

  The other problem is the use of raw_input().  Like the while loop that contains it, raw_input() will also block the reactor.  You need another way to get input from the user, a way which doesn't block.  There are a couple alternatives in the most recent Twisted release.  The first I mentioned above, twisted.internet.stdio.  In addition to giving you non-blocking output, it gives you a callback-oriented way to deal with input.  It won't give you readline-like line-editing abilities, though.  It just deals with straight-up byte streams.  The other possible solution is new in Twisted 2.0 and part of Conch, twisted.conch.insults.  This also provides a callback-oriented way of getting input, but also allows you to define behavior for various function keys.  It comes with a very rudimentary line editor that supports the arrow keys, typeover and insert mode, as well as input history (while this is less featureful than readline, it has the advantage of being much more easily extensible, and in Python ;).

  You can find examples of twisted.internet.stdio in the Twisted core examples directory, or online at:

    <A HREF="http://twistedmatrix.com/documents/current/examples/stdin.py">http://twistedmatrix.com/documents/current/examples/stdin.py</A>

  For more advanced examples of Insults, check out:

    <A HREF="http://twistedmatrix.com/users/warner/doc-latest/conch/examples/demo_recvline.tac">http://twistedmatrix.com/users/warner/doc-latest/conch/examples/demo_recvline.tac</A>

  as well as twisted/conch/stdio.py in Twisted 2.0 (also viewable online at 

    <A HREF="http://svn.twistedmatrix.com/cvs/*checkout*/trunk/twisted/conch/stdio.py?rev=12763&amp;content-type=text%2Fplain">http://svn.twistedmatrix.com/cvs/*checkout*/trunk/twisted/conch/stdio.py?rev=12763&amp;content-type=text%2Fplain</A> )

  Note that twisted/conch/stdio.py does not present a stable interface (it is likely to change incompatibly in the future), so you should consider it an example of how to use insults, rather than a library to use from your application.

  Also note that these solutions are POSIX-only.  They will not work on Windows.

  HTH,

  Jp


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="042752.html">[Twisted-Python] nonblocking stdio
</A></li>
	<LI>Next message (by thread): <A HREF="042755.html">[Twisted-Python] P2P Discovery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42753">[ date ]</a>
              <a href="thread.html#42753">[ thread ]</a>
              <a href="subject.html#42753">[ subject ]</a>
              <a href="author.html#42753">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
