<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Help with SMTP Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Help%20with%20SMTP%20Proxy&In-Reply-To=%3C4269FD43.8060607%40reedflute.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="042704.html">
   <LINK REL="Next"  HREF="042711.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Help with SMTP Proxy</H1>
    <B>Eugene Coetzee</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Help%20with%20SMTP%20Proxy&In-Reply-To=%3C4269FD43.8060607%40reedflute.com%3E"
       TITLE="[Twisted-Python] Help with SMTP Proxy">projects at reedflute.com
       </A><BR>
    <I>Sat Apr 23 01:46:11 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="042704.html">[Twisted-Python] Help with SMTP Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="042711.html">[Twisted-Python] Help with SMTP Proxy - correction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42710">[ date ]</a>
              <a href="thread.html#42710">[ thread ]</a>
              <a href="subject.html#42710">[ subject ]</a>
              <a href="author.html#42710">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jan Van Uytven wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm a new user of Twisted, I came to it because I need to write an 
</I>&gt;<i> SMTP proxy and want to use Python to do it. The proxy would copy the 
</I>&gt;<i> incoming e-mail (including the envelope headers) and then forward it 
</I>&gt;<i> to Postfix.
</I>&gt;<i>
</I>&gt;<i> Googling around I came across an example of an SMTP server (written by 
</I>&gt;<i> the author of twisted.mail I think)  and after playing around with it 
</I>&gt;<i> a bit I can get it to receive and copy the e-mail, but I'm not quite 
</I>&gt;<i> sure how to forward it on after that. Right now I have the proxy 
</I>&gt;<i> sitting on port 2025 and the final smtp server on port 2030. Here's 
</I>&gt;<i> the code I have so far:
</I>&gt;<i>
</I>&gt;<i> import os, StringIO
</I>&gt;<i> from zope.interface import implements
</I>&gt;<i> from twisted.application import service
</I>&gt;<i>
</I>&gt;<i> application = service.Application(&quot;Postfix SMTP Proxy for CopyUser&quot;)
</I>&gt;<i>
</I>&gt;<i> from twisted.application import internet
</I>&gt;<i> from twisted.internet import protocol, defer
</I>&gt;<i>
</I>&gt;<i> smtpServerFactory = protocol.ServerFactory()
</I>&gt;<i>
</I>&gt;<i> from twisted.mail import smtp
</I>&gt;<i>
</I>&gt;<i> class FileMessage(object):
</I>&gt;<i>    implements(smtp.IMessage)
</I>&gt;<i>
</I>&gt;<i>    def __init__(self, fileObj):
</I>&gt;<i>        self.fileObj = fileObj
</I>&gt;<i>        self.msg = []
</I>&gt;<i>
</I>&gt;<i>    def lineReceived(self, line):
</I>&gt;<i>        self.fileObj.write(line + '\n')
</I>&gt;<i>        self.msg.append(line)
</I>&gt;<i>          def eomReceived(self):
</I>&gt;<i>        self.fileObj.close()
</I>&gt;<i>        print &quot;\n&quot;.join(self.msg)
</I>&gt;<i>        return defer.succeed(None)
</I>&gt;<i>          def connectionLost(self):
</I>&gt;<i>        self.fileObj.close()
</I>&gt;<i>        os.remove(self.fileObj.name)
</I>&gt;<i>
</I>&gt;<i> class Delivery(object):
</I>&gt;<i>    implements(smtp.IMessageDelivery)
</I>&gt;<i>    counter = 0
</I>&gt;<i>
</I>&gt;<i>    def validateTo(self, user):
</I>&gt;<i>        fileName = 'smtplog.' + str(self.counter)
</I>&gt;<i>        self.counter += 1
</I>&gt;<i>        return lambda: FileMessage(file(fileName, 'w'))
</I>&gt;<i>      def validateFrom(self, helo, origin):
</I>&gt;<i>        return origin
</I>&gt;<i>
</I>&gt;<i>    def receivedHeader(self, helo, origin, recipients):
</I>&gt;<i>        recpts = []
</I>&gt;<i>        for i in recipients:
</I>&gt;<i>            recpts.append(str(i))
</I>&gt;<i>        recptstr = &quot;Recipients: &quot; + &quot;,&quot;.join(recpts)
</I>&gt;<i>        origin = &quot;Origin: &quot; + str(origin)
</I>&gt;<i>        return recptstr+&quot;\r\n&quot;+origin+&quot;\r\n\r\n&quot;
</I>&gt;<i>
</I>&gt;<i> class ESMTPFactory(protocol.ServerFactory):
</I>&gt;<i>    protocol = smtp.ESMTP
</I>&gt;<i>
</I>&gt;<i>    def buildProtocol(self, addr):
</I>&gt;<i>        p = self.protocol()
</I>&gt;<i>        p.delivery = Delivery()
</I>&gt;<i>        p.factory = self
</I>&gt;<i>        return p
</I>&gt;<i>
</I>&gt;<i> class ForwardSMTPClient(smtp.ESMTPClient):
</I>&gt;<i>
</I>&gt;<i>    def getMailFrom(self):
</I>&gt;<i>        return [&quot;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">smtp_proxy at localhost</A>&quot;]
</I>&gt;<i>
</I>&gt;<i>    def getMailTo(self):
</I>&gt;<i>        return &quot;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">tester at localhost</A>&quot;
</I>&gt;<i>
</I>&gt;<i>    def getMailData(self):
</I>&gt;<i>        data = &quot;&quot;&quot;
</I>&gt;<i>        Subject: Test!
</I>&gt;<i>
</I>&gt;<i>        Test!
</I>&gt;<i>        &quot;&quot;&quot;
</I>&gt;<i>        return StringIO.StringIO(data)
</I>&gt;<i>      def sentMail(self, code, resp, numOk, addresses, log):
</I>&gt;<i>        print 'Sent', numOk, 'messages'
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> class SMTPClientFactory(protocol.ClientFactory):
</I>&gt;<i>    protocol = ForwardSMTPClient
</I>&gt;<i>
</I>&gt;<i>    def buildProtocol(self, addr):
</I>&gt;<i>        return self.protocol(secret=None, identity='localhost')
</I>&gt;<i>      
</I>&gt;<i> smtpServerFactory = ESMTPFactory()
</I>&gt;<i> smtpClientFactory = SMTPClientFactory()
</I>&gt;<i> smtpServerService = internet.TCPServer(2025, smtpServerFactory)
</I>&gt;<i> smtpServerService.setServiceParent(application)
</I>&gt;<i>
</I>&gt;<i> I've left out actually forwarding the message for now, I just want to 
</I>&gt;<i> forward a test e-mail upon receipt of the message. The whole structure 
</I>&gt;<i> of this program doesn't seem right to me. I thought initially of 
</I>&gt;<i> trying something like adding this to the eomReceived method:
</I>&gt;<i>
</I>&gt;<i> smtpForwardService = internet.TCPClient('localhost', 2030, 
</I>&gt;<i> smtpClientFactory)
</I>&gt;<i> smtpForwardService.setServiceParent(application)
</I>&gt;<i>
</I>This is how I'm doing it.

<A HREF="http://twistedmatrix.com/pipermail/twisted-python/2005-March/009888.html">http://twistedmatrix.com/pipermail/twisted-python/2005-March/009888.html</A>

Conductor instance registers a reference to both smtpServerService  
instance and smtpForwardService instance.

I would call something like conductor.write(destination) from within the 
smtpServerService instance which would in turn  call  a method on the 
reference to smtpForwardService from within conductor.

regards,

Eugene Coetzee

-- 
--
===============================================
Reedflute Software Solutions

Telephone           -&gt; +27 18 293 3236
General information -&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">info at reedflute.com</A>
Project information -&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">projects at reedflute.com</A>
Web                 -&gt; www.reedflute.com
=============================================== 



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="042704.html">[Twisted-Python] Help with SMTP Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="042711.html">[Twisted-Python] Help with SMTP Proxy - correction
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#42710">[ date ]</a>
              <a href="thread.html#42710">[ thread ]</a>
              <a href="subject.html#42710">[ subject ]</a>
              <a href="author.html#42710">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
