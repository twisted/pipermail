<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Help with SMTP Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Help%20with%20SMTP%20Proxy&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010194.html">
   <LINK REL="Next"  HREF="010202.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Help with SMTP Proxy</H1>
    <B>Jan Van Uytven</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Help%20with%20SMTP%20Proxy&In-Reply-To="
       TITLE="[Twisted-Python] Help with SMTP Proxy">wyvern at crm3.com
       </A><BR>
    <I>Fri Apr 22 20:19:03 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010194.html">[Twisted-Python] Twisted P2P
</A></li>
        <LI>Next message: <A HREF="010202.html">[Twisted-Python] Help with SMTP Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10196">[ date ]</a>
              <a href="thread.html#10196">[ thread ]</a>
              <a href="subject.html#10196">[ subject ]</a>
              <a href="author.html#10196">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm a new user of Twisted, I came to it because I need to write an SMTP 
proxy and want to use Python to do it. The proxy would copy the incoming 
e-mail (including the envelope headers) and then forward it to Postfix.

Googling around I came across an example of an SMTP server (written by 
the author of twisted.mail I think)  and after playing around with it a 
bit I can get it to receive and copy the e-mail, but I'm not quite sure 
how to forward it on after that. Right now I have the proxy sitting on 
port 2025 and the final smtp server on port 2030. Here's the code I have 
so far:

import os, StringIO
from zope.interface import implements
from twisted.application import service

application = service.Application(&quot;Postfix SMTP Proxy for CopyUser&quot;)

from twisted.application import internet
from twisted.internet import protocol, defer

smtpServerFactory = protocol.ServerFactory()

from twisted.mail import smtp

class FileMessage(object):
    implements(smtp.IMessage)

    def __init__(self, fileObj):
        self.fileObj = fileObj
        self.msg = []

    def lineReceived(self, line):
        self.fileObj.write(line + '\n')
        self.msg.append(line)
       
    def eomReceived(self):
        self.fileObj.close()
        print &quot;\n&quot;.join(self.msg)
        return defer.succeed(None)
       
    def connectionLost(self):
        self.fileObj.close()
        os.remove(self.fileObj.name)

class Delivery(object):
    implements(smtp.IMessageDelivery)
    counter = 0

    def validateTo(self, user):
        fileName = 'smtplog.' + str(self.counter)
        self.counter += 1
        return lambda: FileMessage(file(fileName, 'w'))
   
    def validateFrom(self, helo, origin):
        return origin

    def receivedHeader(self, helo, origin, recipients):
        recpts = []
        for i in recipients:
            recpts.append(str(i))
        recptstr = &quot;Recipients: &quot; + &quot;,&quot;.join(recpts)
        origin = &quot;Origin: &quot; + str(origin)
        return recptstr+&quot;\r\n&quot;+origin+&quot;\r\n\r\n&quot;

class ESMTPFactory(protocol.ServerFactory):
    protocol = smtp.ESMTP

    def buildProtocol(self, addr):
        p = self.protocol()
        p.delivery = Delivery()
        p.factory = self
        return p

class ForwardSMTPClient(smtp.ESMTPClient):

    def getMailFrom(self):
        return [&quot;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">smtp_proxy at localhost</A>&quot;]

    def getMailTo(self):
        return &quot;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">tester at localhost</A>&quot;

    def getMailData(self):
        data = &quot;&quot;&quot;
        Subject: Test!

        Test!
        &quot;&quot;&quot;
        return StringIO.StringIO(data)
   
    def sentMail(self, code, resp, numOk, addresses, log):
        print 'Sent', numOk, 'messages'


class SMTPClientFactory(protocol.ClientFactory):
    protocol = ForwardSMTPClient

    def buildProtocol(self, addr):
        return self.protocol(secret=None, identity='localhost')
       

smtpServerFactory = ESMTPFactory()
smtpClientFactory = SMTPClientFactory()
smtpServerService = internet.TCPServer(2025, smtpServerFactory)
smtpServerService.setServiceParent(application)

I've left out actually forwarding the message for now, I just want to 
forward a test e-mail upon receipt of the message. The whole structure 
of this program doesn't seem right to me. I thought initially of trying 
something like adding this to the eomReceived method:

smtpForwardService = internet.TCPClient('localhost', 2030, 
smtpClientFactory)
smtpForwardService.setServiceParent(application)

but it started an endless loop of sending the test e-mail. Most clients 
use reactor.stop() to finish after processing, but I need the reactor to 
keep on going.

Documentation on twisted.mail is almost non-existent. Is there a better 
way of doing this?

Thanks,

Still Struggling


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010194.html">[Twisted-Python] Twisted P2P
</A></li>
	<LI>Next message: <A HREF="010202.html">[Twisted-Python] Help with SMTP Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10196">[ date ]</a>
              <a href="thread.html#10196">[ thread ]</a>
              <a href="subject.html#10196">[ subject ]</a>
              <a href="author.html#10196">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
