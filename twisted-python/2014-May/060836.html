<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] doWrite called on a twisted.internet.unix.Port
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20doWrite%20called%20on%20a%20twisted.internet.unix.Port&In-Reply-To=%3C20140523145627.5287.2007686315.divmod.xquotient.70%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="060835.html">
   <LINK REL="Next"  HREF="028336.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] doWrite called on a twisted.internet.unix.Port</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20doWrite%20called%20on%20a%20twisted.internet.unix.Port&In-Reply-To=%3C20140523145627.5287.2007686315.divmod.xquotient.70%40top%3E"
       TITLE="[Twisted-Python] doWrite called on a twisted.internet.unix.Port">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri May 23 08:56:27 MDT 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="060835.html">[Twisted-Python] doWrite called on a twisted.internet.unix.Port
</A></li>
        <LI>Next message (by thread): <A HREF="028336.html">[Twisted-Python] The Twisted 14.0 Release Pre-Post-Mortem,	and Where To From Here
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60836">[ date ]</a>
              <a href="thread.html#60836">[ thread ]</a>
              <a href="subject.html#60836">[ subject ]</a>
              <a href="author.html#60836">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01:49 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">killiands at gmail.com</A> wrote:
&gt;<i>Hi Exarkun,
</I>&gt;<i>
</I>&gt;<i>I tried hacking the addWriter method as follows:
</I>&gt;<i>        add_writer_orig = reactor.__class__.addWriter 
</I>&gt;<i>#@UndefinedVariable
</I>&gt;<i>        def my_add_writer(self, writer):
</I>&gt;<i>            logging.warn(writer.__class__.__mro__)
</I>&gt;<i>            logging.warn(''.join(traceback.format_stack()))
</I>&gt;<i>            if isinstance(writer,Port):
</I>&gt;<i>                raise Exception(&quot;Shouldn't add a port as a writer&quot;)
</I>&gt;<i>            return add_writer_orig(self, writer)
</I>&gt;<i>        reactor.addWriter = types.MethodType(my_add_writer,reactor)
</I>&gt;<i>But I actually got nothing out of it.
</I>
This seems alright to me.  I'm not sure why it hasn't revealed any extra 
information.  Did you test it in the trivial case?  For example, set it 
up and then do:

    port = reactor.listenTCP(0, Factory.forProtocol(Protocol))
    port.startWriting()

If you don't see anything logged then there's something wrong with the 
instrumentation.

Here's a slightly different version.  I don't see any reason why it 
would work if your version doesn't, it's basically doing the same thing. 
Maybe there's some obscure detail that prevents your version from 
working, though.

    from __future__ import print_function

    from traceback import print_stack

    from twisted.internet import reactor
    from twisted.internet.interfaces import IListeningPort
    from twisted.internet.protocol import Protocol, Factory

    def addWriter(writer):
        if IListeningPort.providedBy(writer):
            print(&quot;Adding a listening port as a writer: &quot;, writer)
            print_stack()
        return reactor.__class__.addWriter(reactor, writer)

    reactor.addWriter = addWriter

    # Demonstrates that it works in the trivial case.
    port = reactor.listenTCP(0, Factory.forProtocol(Protocol))
    port.startWriting()

Another scenario that occurs to me is that the port itself is never 
added as a writer.  Instead, some other object that is actually supposed 
to write sometimes is added.  Then, the file descriptor for that object 
is closed.  Then, a new port is created and is accidentally assigned the 
same integer as its file descriptor as the one that just got closed. 
Plus, you're using a reactor that doesn't notice when file descriptors 
are closed (this is a complex and subtle corner case and the handling 
varies between reactors because the underlying platform behavior varies 
and it's really difficult, if not impossible, to paper over differences 
in this area due to missing platform services).

Another question about your environment, does the process that is 
affected by this error ever launch any child processes or fork for any 
other reason (having duplicates of the file descriptor, which often 
happens when you fork, is one way this issue can affect the epoll 
reactor)?
Another debug strategy might be to strace all file-descriptor related 
syscalls and see if you can catch an integer being reused and then being 
subject to this error.  Logging the port's file descriptor in the port's 
doWrite might help with this too.

Jean-Paul
&gt;<i>I also noticed this backtrace (or
</I>&gt;<i>similar) is sometimes with a Udp.Port, not only a Unix.Port:
</I>&gt;<i>Unhandled Error
</I>&gt;<i>Traceback (most recent call last):
</I>&gt;<i>  File &quot;/path/to/twisted.zip/twisted/python/log.py&quot;, line 88, in
</I>&gt;<i>callWithLogger
</I>&gt;<i>  File &quot;/path/to/twisted.zip/twisted/python/log.py&quot;, line 73, in
</I>&gt;<i>callWithContext
</I>&gt;<i>  File &quot;/path/to/twisted.zip/twisted/python/context.py&quot;, line 118, in
</I>&gt;<i>callWithContext
</I>&gt;<i>  File &quot;/path/to/twisted.zip/twisted/python/context.py&quot;, line 81, in
</I>&gt;<i>callWithContext
</I>&gt;<i>--- &lt;exception caught here&gt; ---
</I>&gt;<i>  File &quot;/path/to/twisted.zip/twisted/internet/posixbase.py&quot;, line 619, 
</I>&gt;<i>in
</I>&gt;<i>_doReadOrWrite
</I>&gt;<i>  File &quot;/path/to/twisted.zip/twisted/internet/base.py&quot;, line 1117, in
</I>&gt;<i>doWrite
</I>&gt;<i>exceptions.RuntimeError: doWrite called on a twisted.internet.udp.Port
</I>&gt;<i>
</I>&gt;<i>Any other ideas how I could find out the culprit?
</I>&gt;<i>
</I>&gt;<i>Thank you,
</I>&gt;<i>
</I>&gt;<i>Killian
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>On 7 May 2014 17:09, Killian De Smedt &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">killiands at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>Hi Exarkun,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Thanks for the quick response. I should have specified those things
</I>&gt;&gt;<i>immediately.
</I>&gt;&gt;<i>I manually merged the UDP ipv6 branch in the trunk somewhere in august 
</I>&gt;&gt;<i>and
</I>&gt;&gt;<i>used that one, the version number is reported as [twisted, version 
</I>&gt;&gt;<i>13.1.0].
</I>&gt;&gt;<i>The platform is always centos though the centos version might range 
</I>&gt;&gt;<i>from
</I>&gt;&gt;<i>5.x to 6.x, 32 bit, but most of the time it runs on a centos 5.2
</I>&gt;&gt;<i>installation (kernel on my working machine is 2.6.18). Python is 2.7.1 
</I>&gt;&gt;<i>.
</I>&gt;&gt;<i>  I use the default reactor which should come down to the epoll one.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I'll try to hack up the addwriter, it shouldn't be that hard to for 
</I>&gt;&gt;<i>just
</I>&gt;&gt;<i>that application.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Thank you,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Killian
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>On 7 May 2014 16:11, &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>On 01:47 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">killiands at gmail.com</A> wrote:
</I>&gt;&gt;&gt;&gt;<i>Hello everybody,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>I sometimes see the following error logged by a twisted application, 
</I>&gt;&gt;&gt;&gt;<i>it
</I>&gt;&gt;&gt;&gt;<i>only happens sporadically and I cannot even reproduce when trying to
</I>&gt;&gt;&gt;&gt;<i>re-execute the exact sequence of those failures. So giving an SSCCE 
</I>&gt;&gt;&gt;&gt;<i>is
</I>&gt;&gt;&gt;&gt;<i>quite impossible for now (sorry). Given this trace it's also hard to 
</I>&gt;&gt;&gt;&gt;<i>find
</I>&gt;&gt;&gt;&gt;<i>what was actually called/executed.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>I've seen something like this with a somewhat old version of Twisted 
</I>&gt;&gt;&gt;<i>and
</I>&gt;&gt;&gt;<i>a custom reactor.  I never tracked down the cause.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>What version of Twisted are you using, what platform are you on, and 
</I>&gt;&gt;&gt;<i>what
</I>&gt;&gt;&gt;<i>reactor are you using?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Another useful bit of debug information would be to hack up the 
</I>&gt;&gt;&gt;<i>reactor's
</I>&gt;&gt;&gt;<i>`addWriter` method to do a check of the argument.  The call stack at 
</I>&gt;&gt;&gt;<i>*that*
</I>&gt;&gt;&gt;<i>point (when the argument is a Port) is more interesting than the call 
</I>&gt;&gt;&gt;<i>stack
</I>&gt;&gt;&gt;<i>at the point where `doWrite` is called.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Jean-Paul
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>_______________________________________________
</I>&gt;&gt;&gt;<i>Twisted-Python mailing list
</I>&gt;&gt;&gt;<i><A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>--
</I>&gt;&gt;<i>Killian De Smedt
</I>&gt;&gt;<i>mobile: +32 486/825 951
</I>&gt;&gt;<i>mail: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">killiands at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>--
</I>&gt;<i>Killian De Smedt
</I>&gt;<i>mobile: +32 486/825 951
</I>&gt;<i>mail: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">killiands at gmail.com</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="060835.html">[Twisted-Python] doWrite called on a twisted.internet.unix.Port
</A></li>
	<LI>Next message (by thread): <A HREF="028336.html">[Twisted-Python] The Twisted 14.0 Release Pre-Post-Mortem,	and Where To From Here
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60836">[ date ]</a>
              <a href="thread.html#60836">[ thread ]</a>
              <a href="subject.html#60836">[ subject ]</a>
              <a href="author.html#60836">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
