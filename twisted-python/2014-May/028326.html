<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] tor hidden service endpoint parser returns a	deferred
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20tor%20hidden%20service%20endpoint%20parser%20returns%20a%0A%09deferred&In-Reply-To=%3CB9DA601A-E4DA-45E4-979A-94C6AE618332%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028324.html">
   <LINK REL="Next"  HREF="028328.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] tor hidden service endpoint parser returns a	deferred</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20tor%20hidden%20service%20endpoint%20parser%20returns%20a%0A%09deferred&In-Reply-To=%3CB9DA601A-E4DA-45E4-979A-94C6AE618332%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] tor hidden service endpoint parser returns a	deferred">glyph at twistedmatrix.com
       </A><BR>
    <I>Mon May  5 23:31:31 MDT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="028324.html">[Twisted-Python] tor hidden service endpoint parser returns a	deferred
</A></li>
        <LI>Next message: <A HREF="028328.html">[Twisted-Python] tor hidden service endpoint parser returns a	deferred
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28326">[ date ]</a>
              <a href="thread.html#28326">[ thread ]</a>
              <a href="subject.html#28326">[ subject ]</a>
              <a href="author.html#28326">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On May 5, 2014, at 6:52 PM, David Stainton &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dstainton415 at gmail.com</A>&gt; wrote:

&gt;<i> OK... I decided that txtorcon's endpoint constructor should only take
</I>&gt;<i> string arguments besides the reactor arg...
</I>&gt;<i> because serverFromString passes only str args to the endpoint constructor.
</I>
I strongly suggest that this is wrong.

The endpoint constructor should do _construction_.  The endpoint parser should do _parsing_.  The task of parsing is of taking strings and producing meaningful values.

You may want to have the endpoint parser actually live in a separate method in txtorcon rather than putting it into the plugin itself, and leave the plugin simply the task of plugging in, but the parsing method should not be called __init__.

(Also, don't use asserts.  This is probably indicative of a weakness in the parsing API we've provided, but you should likely raise something like UsageError.)

&gt;<i> I wrote the endpoint parser to be as simple as possible.
</I>&gt;<i> The endpoint's `listen` method now handles the tor configuration and
</I>&gt;<i> launch logic... and returns a deferred which will
</I>&gt;<i> fire with an IListenPort.
</I>
Great.

&gt;<i> The pip method definitely works... my code works but prints traceback
</I>&gt;<i> with this error:
</I>&gt;<i> &quot;Unexpected error while writing cache file&quot;
</I>&gt;<i> Do you as well?
</I>&gt;<i> 
</I>
What exactly is 'usewithtor'?

&gt;<i> usewithtor pip install twisted
</I>


&gt;<i> Running the example code:
</I>&gt;<i> cd examples
</I>&gt;<i> python launch_tor_endpoint.py
</I>&gt;<i> Unexpected error while writing cache file
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i>  File &quot;/home/human/virtenv-txtorcon/local/lib/python2.7/site-packages/twisted/internet/endpoints.py&quot;,
</I>&gt;<i> line 1465, in serverFromString
</I>&gt;<i>    return _serverFromStringLegacy(reactor, description, _NO_DEFAULT)
</I>&gt;<i>  File &quot;/home/human/virtenv-txtorcon/local/lib/python2.7/site-packages/twisted/internet/endpoints.py&quot;,
</I>&gt;<i> line 1393, in _serverFromStringLegacy
</I>&gt;<i>    nameOrPlugin, args, kw = _parseServer(description, None, default)
</I>&gt;<i>  File &quot;/home/human/virtenv-txtorcon/local/lib/python2.7/site-packages/twisted/internet/endpoints.py&quot;,
</I>&gt;<i> line 1380, in _parseServer
</I>&gt;<i>    for plugin in getPlugins(IStreamServerEndpointStringParser):
</I>&gt;<i>  File &quot;/home/human/virtenv-txtorcon/local/lib/python2.7/site-packages/twisted/plugin.py&quot;,
</I>&gt;<i> line 209, in getPlugins
</I>&gt;<i>    allDropins = getCache(package)
</I>&gt;<i> --- &lt;exception caught here&gt; ---
</I>&gt;<i>  File &quot;/home/human/virtenv-txtorcon/local/lib/python2.7/site-packages/twisted/plugin.py&quot;,
</I>&gt;<i> line 181, in getCache
</I>&gt;<i>    dropinPath.setContent(pickle.dumps(dropinDotCache))
</I>&gt;<i> exceptions.AttributeError: 'ZipPath' object has no attribute 'setContent'
</I>&gt;<i> I have set up a hidden service, advertised at: &lt;&lt;class
</I>&gt;<i> 'twisted.internet.tcp.Port'&gt; of twisted.web.server.Site on 55141&gt;
</I>
This traceback is actually harmless, if annoying.  It's trying to generate the plugin cache, which is explained here:

&lt;<A HREF="https://twistedmatrix.com/documents/current/core/howto/plugin.html#auto3">https://twistedmatrix.com/documents/current/core/howto/plugin.html#auto3</A>&gt;

&gt;<i> <A HREF="http://mqrcnytlnh4xynmh.onion:80">http://mqrcnytlnh4xynmh.onion:80</A>
</I>&gt;<i> locally listening on IPv4Address(TCP, '127.0.0.1', 55141)
</I>&gt;<i> 
</I>&gt;<i> and txtorcon's setup.py output:
</I>&gt;<i> python setup.py install
</I>

&gt;<i> running bdist_egg
</I> ^ This right here is your problem.

There are a couple of solutions, in order of increasing complexity:

Don't build eggs.  Why are you building eggs?  Eggs are unfortunately a huge problem magnet.  I don't think 'pip install' builds eggs; I don't manually run setup.py anywhere any more because I assume pip understands these concerns better than I do.
Set zip_safe in your setup.py to False, which will turn your egg into a directory rather than a directory.
Figure out a way to hook the _build_ step specifically so you can run getPlugins() to generate the dropin cache before zipping up your zip file.  Twisted plugins actually do work within zip files, but nobody has bothered working out the setuptools incantation to get them to generate at the appropriate time for building an egg.  This is extra tricky because you only want to generate this dropin.cache file if the dropin is going to live inside an egg; otherwise, it would conflict with the communal dropin.cache file generated at install time.  This option will be the most confusing and frustrating for you, but I hope you choose it, because it would be GREAT to have a Right Way&#8482; to address this problem in a Twisted plugin project's setup.py :).

&gt;<i> zip_safe flag not set; analyzing archive contents...
</I>
It's probably best to set zip_safe one way or the other though, even if you want to set it to 'true'.  Letting setuptools guess like this will, unsurprisingly, get you unpredictable results.

-g
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20140505/f17e4a33/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20140505/f17e4a33/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028324.html">[Twisted-Python] tor hidden service endpoint parser returns a	deferred
</A></li>
	<LI>Next message: <A HREF="028328.html">[Twisted-Python] tor hidden service endpoint parser returns a	deferred
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28326">[ date ]</a>
              <a href="thread.html#28326">[ thread ]</a>
              <a href="subject.html#28326">[ subject ]</a>
              <a href="author.html#28326">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
