<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] pb objects unexpectedly change identity
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20pb%20objects%20unexpectedly%20change%20identity&In-Reply-To=%3CCAKN9TDLPLwZHv-Ni2%3DGjtfr8PfyBw9ky6viezQZRaNTMrad-jw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] pb objects unexpectedly change identity</H1>
    <B>Daniel Sank</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20pb%20objects%20unexpectedly%20change%20identity&In-Reply-To=%3CCAKN9TDLPLwZHv-Ni2%3DGjtfr8PfyBw9ky6viezQZRaNTMrad-jw%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] pb objects unexpectedly change identity">sank.daniel at gmail.com
       </A><BR>
    <I>Thu May  1 22:55:59 MDT 2014</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60754">[ date ]</a>
              <a href="thread.html#60754">[ thread ]</a>
              <a href="subject.html#60754">[ subject ]</a>
              <a href="author.html#60754">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear twisted users,

I have discovered the cause of this strange behavior. This is a good one.

The object exposed to you as a client when you receive a RemoteCache is not
the same object which is passed in as &quot;self&quot; to observe_* methods. In the
source code, there is a pair of objects created when a RemoteCache is
received. One of them is given to the client, and the other remains in the
shadows of pb for reasons I don't yet understand. For some reason
remoteMessageReceived delegates observe_* methods to the object which is
not the one given to the client. This means that normal methods and
observe_* methods get different self arguments.

The authors seemed to try to cover this up by forcing the two objects to
share the same __dict__ and __class__. Of course this does not give the
objects the same id, which was the source of my problem.

I have reported this issue here: <A HREF="https://twistedmatrix.com/trac/ticket/7274">https://twistedmatrix.com/trac/ticket/7274</A>

I am interested in fixing this bug. What is the right way to get help from
people who know the code? I have some simple questions I'd like to ask so
that I go in the right direction while fixing this.

-Daniel



On Wed, Apr 30, 2014 at 8:09 PM, Daniel Sank &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">sank.daniel at gmail.com</A>&gt; wrote:

&gt;<i> Dear Twisted users,
</I>&gt;<i>
</I>&gt;<i> To my amazement I have reproduced this strange behaviour in an even
</I>&gt;<i> simpler program. Attached are a pb client/server which illustrate
</I>&gt;<i> unexpected behaviour of the id of a pb.RemoteCache. To run the example, run
</I>&gt;<i> server.py and then client.py (with resources.py in the same working
</I>&gt;<i> directory).
</I>&gt;<i>
</I>&gt;<i> You will see output like this (line numbers added by me)
</I>&gt;<i>
</I>&gt;<i> ====
</I>&gt;<i> 1. RemoteCache 29403544 initialized
</I>&gt;<i> 2. Client received RemoteCache: id=29403544
</I>&gt;<i> 3. RemoteCache: while responding to observe_add I think my id is 29403760
</I>&gt;<i> 4. Client: The RemoteCache's ide is 29403544
</I>&gt;<i> ...
</I>&gt;<i> ====
</I>&gt;<i>
</I>&gt;<i> 1. When the RemoteCache is initialized it thinks its id is 29403544.
</I>&gt;<i> 2. The client agrees that it has received a RemoteCache with id 29403544.
</I>&gt;<i> 3. When the RemoteCache is inside observe_add it thinks its id is 29403760.
</I>&gt;<i> 4. The client still thinks the RemoteCache's id is 29403544.
</I>&gt;<i>
</I>&gt;<i> If you let the program run it will continue to loop between the
</I>&gt;<i> RemoteCache reporting its id while in observe_add, and the client reporting
</I>&gt;<i> the id of the RemoteCache. The two reported ids are always the same unequal
</I>&gt;<i> numbers.
</I>&gt;<i>
</I>&gt;<i> The question appears to be &quot;Why does the id reported by a RemoteCache's
</I>&gt;<i> while inside an observe_* method differ the id reported by objects owning
</I>&gt;<i> references to that RemoteCache?&quot;
</I>&gt;<i>
</I>&gt;<i> Thank you for your time,
</I>&gt;<i> Daniel
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Wed, Apr 30, 2014 at 11:00 AM, Daniel Sank &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">sank.daniel at gmail.com</A>&gt;wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Dear twisted users,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think I have found some surprising behavior in perspective broker. I
</I>&gt;&gt;<i> define a subclass of pb.RemoteCache which has a method managed by a
</I>&gt;&gt;<i> descriptor. The descriptor keeps track of the instances it manages in a set.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When the RemoteCache is first received by the client, it accesses the
</I>&gt;&gt;<i> descriptor-ified method inside setCopyableState. At that time the
</I>&gt;&gt;<i> RemoteCache's id is a certain value X. Then later when the RemoteCache is
</I>&gt;&gt;<i> notified of a change by the server side Cacheable, it again accesses the
</I>&gt;&gt;<i> descriptor-ified method, but at this time it's id is Y, and Y!=X.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I attach to this post a simple working example which displays the
</I>&gt;&gt;<i> behavior described above. To run, first run server.py and then run
</I>&gt;&gt;<i> client.py. You will see a little bit of output, the most important part
</I>&gt;&gt;<i> being
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ===
</I>&gt;&gt;<i> Client received RemoteCache: id=45952496
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Asking server to update
</I>&gt;&gt;<i> TD 45921680 (test.RemoteCache.add) accessed by &lt;test.RemoteCache instance
</I>&gt;&gt;<i> at 2BD2DC8&gt;: id=45952456
</I>&gt;&gt;<i> RemoteCache id=45952496
</I>&gt;&gt;<i> ===
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To understand the details of the output please see descriptor.py. The id
</I>&gt;&gt;<i> of the RemoteCache is first reported as 45952496 when the client receives
</I>&gt;&gt;<i> it. Then, when the descriptor is accessed, the id of the accessing instance
</I>&gt;&gt;<i> is reported as 45952456, which is different. Then, when in the last line we
</I>&gt;&gt;<i> print out the id of the RemoteCache we're back to 45952496.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there some reason that a RemoteCache's id can change during its life
</I>&gt;&gt;<i> time?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Daniel Sank
</I>&gt;&gt;<i> Department of Physics
</I>&gt;&gt;<i> Broida Hall
</I>&gt;&gt;<i> University of California
</I>&gt;&gt;<i> Santa Barbara, CA 93117
</I>&gt;&gt;<i> (805)893-3899
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Daniel Sank
</I>&gt;<i> Department of Physics
</I>&gt;<i> Broida Hall
</I>&gt;<i> University of California
</I>&gt;<i> Santa Barbara, CA 93117
</I>&gt;<i> (805)893-3899
</I>&gt;<i>
</I>


-- 
Daniel Sank
Department of Physics
Broida Hall
University of California
Santa Barbara, CA 93117
(805)893-3899
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20140501/3f3e59cc/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60754">[ date ]</a>
              <a href="thread.html#60754">[ thread ]</a>
              <a href="subject.html#60754">[ subject ]</a>
              <a href="author.html#60754">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
