<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] deferToThread and trial
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20deferToThread%20and%20trial&In-Reply-To=%3CE4E6567B37AA4BFD959111DAF834FC52%40jsphere.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="028389.html">
   <LINK REL="Next"  HREF="060852.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] deferToThread and trial</H1>
    <B>Jonathan Jacobs</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20deferToThread%20and%20trial&In-Reply-To=%3CE4E6567B37AA4BFD959111DAF834FC52%40jsphere.com%3E"
       TITLE="[Twisted-Python] deferToThread and trial">jonathan+twisted at jsphere.com
       </A><BR>
    <I>Fri May 30 03:40:53 MDT 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="028389.html">[Twisted-Python] deferToThread and trial
</A></li>
        <LI>Next message (by thread): <A HREF="060852.html">[Twisted-Python] deferToThread and trial
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60851">[ date ]</a>
              <a href="thread.html#60851">[ thread ]</a>
              <a href="subject.html#60851">[ subject ]</a>
              <a href="author.html#60851">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Piper,  

`successResultOf` is intended to be called on a Deferred which has a result (meaning `Deferred.errback` or `Deferred.callback` has been called on it already.) [1] In this case presumably your blocking call hasn’t finished (or even started?) by the time the assertion is executed, hence the Deferred has no result.

The usual case for using `successResultOf` is when you have a Deferred that you’re delivering results to synchronously (probably by way of calling `Deferred.callback` from your test) to determine if the callback chain produces the expected final result.

Without debating the merits of preferring to avoid interaction with the real world in unit tests, you can return a Deferred from your test method to run the reactor for you until the Deferred has fired and its callbacks have run. [2] You probably want to add some callbacks, to perform some assertions about the result, to the Deferred you’ll be returning.

[1] &lt;<A HREF="http://twistedmatrix.com/documents/current/api/twisted.trial._synctest._Assertions.html#successResultOf">http://twistedmatrix.com/documents/current/api/twisted.trial._synctest._Assertions.html#successResultOf</A>&gt;
[2] &lt;<A HREF="http://twistedmatrix.com/documents/current/core/howto/testing.html#leave-the-reactor-as-you-found-it">http://twistedmatrix.com/documents/current/core/howto/testing.html#leave-the-reactor-as-you-found-it</A>&gt;

--  
Jonathan


On Friday 30 May 2014 at 8:13 AM, Piper Masden wrote:

&gt;<i> I have some Klein code that uses deferToThread for I/O. It looks something like this:
</I>&gt;<i>  
</I>&gt;<i> @app.route('/', methods=['GET']
</I>&gt;<i> def index(request, *args, **kwargs):
</I>&gt;<i>     d = deferToThread(some_blocking_db_select_function)
</I>&gt;<i>  
</I>&gt;<i>     def serialize(db_object):
</I>&gt;<i>         return json.dumps({
</I>&gt;<i>             'id': db_object,
</I>&gt;<i>             })
</I>&gt;<i>     d.addCallback(serialize)
</I>&gt;<i>     return d
</I>&gt;<i>  
</I>&gt;<i> I have a test that executes this function, and the deferToThread returns a Deferred, but that deferred never fires its callback, and so when I use successResultOf expecting a success result, no result is found.  
</I>&gt;<i>  
</I>&gt;<i> When I use twistd to run the Klein application, everything works fine (the deferred fires and I get a json string in the body of the response). What's different about the trial environment that deferToThread might not fire its callback? Do I need to explicitly set up a thread pool in trial that I don't have to set up using twistd?  Any help would be appreciated.
</I>&gt;<i>  
</I>&gt;<i>  
</I>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20140530/f653d60d/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="028389.html">[Twisted-Python] deferToThread and trial
</A></li>
	<LI>Next message (by thread): <A HREF="060852.html">[Twisted-Python] deferToThread and trial
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60851">[ date ]</a>
              <a href="thread.html#60851">[ thread ]</a>
              <a href="subject.html#60851">[ subject ]</a>
              <a href="author.html#60851">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
