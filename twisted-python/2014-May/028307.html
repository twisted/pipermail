<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Some comments regarding #5190 - ``RFC 6125 (&quot;Service Identity&quot;) implementation&#180;&#180;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%0A%20%3D%3Futf-8%3Fq%3FSome_comments_regarding_%3D235190_-_%3D60%3F%3D%0A%20%3D%3Futf-8%3Fq%3F%3D60RFC_6125_%3D28%3D22Service_Identity%3D22%3D29_implementation%3DC2%3DB4%3F%3D%0A%20%3D%3Futf-8%3Fb%3FwrQ%3D%3F%3D&In-Reply-To=%3C20140503122041.6354.1241503771.divmod.xquotient.163%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028287.html">
   <LINK REL="Next"  HREF="028308.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Some comments regarding #5190 - ``RFC 6125 (&quot;Service Identity&quot;) implementation&#180;&#180;</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%0A%20%3D%3Futf-8%3Fq%3FSome_comments_regarding_%3D235190_-_%3D60%3F%3D%0A%20%3D%3Futf-8%3Fq%3F%3D60RFC_6125_%3D28%3D22Service_Identity%3D22%3D29_implementation%3DC2%3DB4%3F%3D%0A%20%3D%3Futf-8%3Fb%3FwrQ%3D%3F%3D&In-Reply-To=%3C20140503122041.6354.1241503771.divmod.xquotient.163%40top%3E"
       TITLE="[Twisted-Python] Some comments regarding #5190 - ``RFC 6125 (&quot;Service Identity&quot;) implementation&#180;&#180;">exarkun at twistedmatrix.com
       </A><BR>
    <I>Sat May  3 06:20:41 MDT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="028287.html">[Twisted-Python] Some comments regarding #5190 - ``RFC 6125 (&quot;Service Identity&quot;) implementation&#180;&#180;
</A></li>
        <LI>Next message: <A HREF="028308.html">[Twisted-Python] Some comments regarding #5190 - ``RFC 6125 (&quot;Service Identity&quot;) implementation&#180;&#180;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28307">[ date ]</a>
              <a href="thread.html#28307">[ thread ]</a>
              <a href="subject.html#28307">[ subject ]</a>
              <a href="author.html#28307">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1 May, 07:23 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A> wrote:
&gt;<i>
</I>&gt;<i>On Apr 30, 2014, at 5:21 AM, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:
</I>&gt;&gt;<i>I've just noticed that the changeset for #5190 included some untested 
</I>&gt;&gt;<i>code.  Specifically, there are no tests for the code which detects 
</I>&gt;&gt;<i>missing dependencies and emits warnings about them.
</I>&gt;<i>
</I>&gt;<i>My bad.  Well, technically hawkowl's bad; hawkowl is a committer and 
</I>&gt;<i>did the review and therefore has all the criminal liability in this 
</I>&gt;<i>case, but as the author who wrote the code I bear some responsibility, 
</I>&gt;<i>at least in some abstract, hypothetical sense ;-).
</I>
My hope is that by drawing attention to examples of this kind of mistake 
will help us avoid making the mistake in the future.  Considering what 
my email prompted you to write, I think it may work. :)
&gt;<i>
</I>&gt;<i>Thanks for working on the fix; it looks like the relevant ticket is 
</I>&gt;<i>&lt;<A HREF="https://twistedmatrix.com/trac/ticket/7097">https://twistedmatrix.com/trac/ticket/7097</A>&gt;.  I'll try to review that 
</I>&gt;<i>as soon as it's ready; let me know.
</I>
No problem.  I probably should have started my previous email with 
thanks to you and hawkowl for working on that feature.  It is *really* 
good to have service identity checking support in Twisted.
&gt;&gt;<i>
</I>&gt;&gt;<i>I'd previously noticed that this code was broken but hadn't realized 
</I>&gt;&gt;<i>this was because it was untested.
</I>&gt;<i>
</I>&gt;<i>Neither the author nor the reviewer realized this either, apparently. 
</I>&gt;<i>Certainly it wasn't an intentional omission.
</I>&gt;&gt;<i>I don't think there's any disagreement whatsoever over Twisted's 
</I>&gt;&gt;<i>testing requirements.  All code must have full line and branch 
</I>&gt;&gt;<i>coverage (as reported by the coverage.py tool).  Developers, please 
</I>&gt;&gt;<i>write tests for all of your code (and please learn to do test-driven 
</I>&gt;&gt;<i>development - it will make this task easier, I promise).  Reviewers, 
</I>&gt;&gt;<i>please don't accept proposed changes that include untested code.
</I>&gt;<i>
</I>&gt;<i>The problem with code like this is that, in some configurations, it is 
</I>&gt;<i>in fact reported as covered by coverage.py.  It requires manual 
</I>&gt;<i>examination to get the intersection of a diff and a coverage report, 
</I>&gt;<i>and even when you do, we still have too many places where it's &quot;okay&quot; 
</I>&gt;<i>to skip coverage.
</I>
This is true - but I'm not sure the code in this case is particularly 
special.  It's nearly always possible to write code and tests such that 
coverage.py says your code is covered but without actually having any 
meaningful test coverage of the implementation.  After all, coverage.py 
only knows that a line ran or didn't.

The problem of platform- or environment-specific code requiring multiple 
branches which can never always all run is an extra challenge but I 
think a widely applicable solution is to not do that.  To add to your 
comments below, if there is platform- or environment-specific code then 
parameterize it on the environment and write tests for all of the cases.
&gt;<i>
</I>&gt;<i>As the author I looked at coverage periodically and it looked sort of 
</I>&gt;<i>like what I expected.  Since I was testing multiple installed-library 
</I>&gt;<i>configurations I had used &quot;coverage combine&quot; which misleadingly told me 
</I>&gt;<i>that it was all covered (although this particular code should have been 
</I>&gt;<i>tested independently without requiring a combined run).  And I'm sure 
</I>&gt;<i>the reviewer thought about it a little bit, but even if they'd looked 
</I>&gt;<i>at a coverage report, it might have looked like it was OK to skip these 
</I>&gt;<i>particular lines.  And I was in fact doing test-driven development; I 
</I>&gt;<i>didn't add the warning code there until I was looking at a failing test 
</I>&gt;<i>because one of the buildbots didn't have one of my expected 
</I>&gt;<i>dependencies installed, and I made my tests pass locally by having an 
</I>&gt;<i>environment without those dependencies installed locally either.
</I>&gt;<i>
</I>&gt;<i>Yes, I understand how this isn't really 100% TDD, and that a failure on 
</I>&gt;<i>a buildbot should have resulted in me writing a new test; mistakes were 
</I>&gt;<i>made etc.  But all TDD necessarily involves the occasional 
</I>&gt;<i>error/error/pass where there really ought to have been a pass/fail/pass 
</I>&gt;<i>- if we understood what was going on with all of our code all the time 
</I>&gt;<i>we probably wouldn't need tests in the first place :-).  It's a bit 
</I>&gt;<i>disingenuous to say that I need to &quot;learn to do test-driven 
</I>&gt;<i>development&quot; to avoid mistakes like this, though.
</I>&gt;<i>
</I>&gt;<i>On the other side of the equation, I imagine that a reviewer looking at 
</I>&gt;<i>this, even carefully considering coverage, might see a missed line on 
</I>&gt;<i>some buildbot or in their local run and then thought &quot;oh, of course, 
</I>&gt;<i>but that line will be run if I had/didn't have that library installed&quot;. 
</I>&gt;<i>And there are some bits of code which are acceptable to cover in this 
</I>&gt;<i>manner (except they should have direct test coverage from actual tests, 
</I>&gt;<i>rather than just importing the test module, which coverage.py won't 
</I>&gt;<i>show you).  It's a quite subtle point to understand that this 
</I>&gt;<i>particular kind of code should actually be fully covered in all 
</I>&gt;<i>configurations.  Especially because these tests are smack in the middle 
</I>&gt;<i>of a file which will be validly missing coverage in some supported 
</I>&gt;<i>configurations (no pyOpenSSL installed) and surrounded with thickets of 
</I>&gt;<i>conditionals and test skips to optionally import more dependencies than 
</I>&gt;<i>just this one.
</I>&gt;<i>
</I>&gt;<i>We should remain vigilant, but I think that if we want to really reduce 
</I>&gt;<i>errors like this in the future we need to make them easier to spot. 
</I>&gt;<i>Failing that we need to have more specific suggestions.  In this case, 
</I>&gt;<i>I happen to know that I do TDD and that Hawkowl was is aware of the 
</I>&gt;<i>standard on coverage issues (and is at least aware of coverage.py, 
</I>&gt;<i>whether or not it was run as part of this review), so those two 
</I>&gt;<i>suggestions aren't going to help as we're already doing them.  Any time 
</I>&gt;<i>the solution to a problem is &quot;everybody should just try harder&quot; that 
</I>&gt;<i>seems like a bet against human fallibility.
</I>&gt;<i>
</I>&gt;<i>So until someone has a month to spend on an all-singing all-dancing 
</I>&gt;<i>combined ratcheting coverage report for all the builders and a 
</I>&gt;<i>fantastic visualization for its output which highlights every possible 
</I>&gt;<i>coverage issue, here are some specific suggestions which might avoid 
</I>&gt;<i>some parts of this class of error:
</I>
I don't think we even have a plan for a tool that will report whether a 
change introduces code that isn't *really* tested (contrast &quot;tested&quot; 
with &quot;executed&quot;).

I think this may be an area where we do actually need to rely on people 
doing a good job.  Perhaps to counter balance that we need to eliminate 
more of the other crap involved in the development process?  For 
example, if reviewers never had to spend any time thinking about whether 
the whitespace in a change was correct, they would have that much more 
brain power to apply to assessing the quality of the test suite.
&gt;<i>
</I>&gt;<i>For authors (what I could have done better):
</I>&gt;<i>
</I>&gt;<i>I know I said they're inevitable, but whenever you get an error/pass, 
</I>&gt;<i>always consider where you could make it a clean fail/pass instead.  You 
</I>&gt;<i>(and by &quot;you&quot; I obviously mean &quot;me&quot;) think you understand why an error 
</I>&gt;<i>happened but the only way to really demonstrate you understand it well 
</I>&gt;<i>enough to convert it into an assertion that fails with a useful error 
</I>&gt;<i>message.
</I>&gt;<i>Be intensely suspicious of any code that needs to run at import time. 
</I>&gt;<i>I did stuff the warning into a function, which at least doesn't leak 
</I>&gt;<i>local variables, but I probably could have moved this warning somewhere 
</I>&gt;<i>easier to manage, and would have noticed warnings coming out of tests 
</I>&gt;<i>as opposed to just being printed at the beginning.  Declarative like 
</I>&gt;<i>deprecatedModuleAttribute automate some of the magic for making code- 
</I>&gt;<i>level artifacts emit warnings when bound to and used rather than 
</I>&gt;<i>accidents of their initial import, so make use of those. (I'm still 
</I>&gt;<i>thinking about how I could have applied that in this specific case; I 
</I>&gt;<i>probably could have.)
</I>&gt;<i>Configure your development environment to be more aggressive about 
</I>&gt;<i>warnings (at least for now, eventually trial should fix this for you, 
</I>&gt;<i>see &lt;<A HREF="https://twistedmatrix.com/trac/ticket/6348">https://twistedmatrix.com/trac/ticket/6348</A>&gt;).  I don't think it 
</I>&gt;<i>would have helped in this particular case because the warning itself is 
</I>&gt;<i>emitted at import time (see point 2) but this sort of mistake crops up 
</I>&gt;<i>unfortunately frequently related to deprecation warnings, which are a 
</I>&gt;<i>bit more common, and could often be caught by a better setup.  I 
</I>&gt;<i>recently changed my PYTHONWARNINGS environment variable to 
</I>&gt;<i>'all::DeprecationWarning,all::UserWarning', and that seems to catch 
</I>&gt;<i>most things.  (Unfortunately setting it to simply 'all' produces too 
</I>&gt;<i>much noise from the stdlib and dependencies so it's better to be 
</I>&gt;<i>slightly more restrictive.)
</I>&gt;<i>
</I>&gt;<i>For reviewers (what hawkowl could have done better):
</I>&gt;<i>
</I>&gt;<i>Run coverage.  Particularly, run coverage just on the relevant and 
</I>&gt;<i>changed test modules, and make sure the system under test gets run 
</I>&gt;<i>directly and just accidentally executed by running the code.
</I>&gt;<i>I know I've been reminding reviewers lately to give clear feedback 
</I>&gt;<i>about what elements of reviews are suggestions and which are required 
</I>&gt;<i>fixes for violations of policy, and that may produce the subjective 
</I>&gt;<i>impression that I've been asking for faster or less careful reviews. 
</I>&gt;<i>If so, I should correct that impression: I would like there to be less 
</I>&gt;<i>bike shedding, but it's still pretty important that the &#163;10 million 
</I>&gt;<i>reactor actually work.  Any lack of test coverage is at least a 
</I>&gt;<i>potential policy violation.  Even if you think you understand why it's 
</I>&gt;<i>missing, even if it looks like a platform variance that doesn't make 
</I>&gt;<i>sense to test on the machine you're running, always ask the author to 
</I>&gt;<i>explain or justify why coverage isn't there, if it could be added to a 
</I>&gt;<i>cross-platform test with a reasonable (or, in many cases, even an 
</I>&gt;<i>existing) fake; if there's no relevant fake and it would be too much 
</I>&gt;<i>work, maybe we need to file a ticket for implementing some test 
</I>&gt;<i>support.
</I>&gt;<i>Especially if you're dealing with a new feature or a significant 
</I>&gt;<i>behavior change, always try to actually run and interact with the code 
</I>&gt;<i>and look at its output.  In this case, noticing the whitespace / 
</I>&gt;<i>formatting errors in the warning messages might have lead us to spot 
</I>&gt;<i>the coverage error earlier.  (Jean-Paul made some comments to me when 
</I>&gt;<i>he noticed it, but it was an off-the-cuff thing after the branch had 
</I>&gt;<i>already been landed and not part of a code review; context is important 
</I>&gt;<i>here, as evidenced by the fact that it took him some time to realize 
</I>&gt;<i>that it was indicative of a test coverage issue!
</I>
Thanks!  These are great suggestions.  Can we record them in a way that 
lets all Twisted contributors learn from this case (instead of only the 
people reading this thread) - but without adding to the already 
unreasonably large quantity of text new contributors are ostensibly 
already responsible for reading?

How's the unified Contributing-to-Twisted documentation effort coming?

Jean-Paul

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028287.html">[Twisted-Python] Some comments regarding #5190 - ``RFC 6125 (&quot;Service Identity&quot;) implementation&#180;&#180;
</A></li>
	<LI>Next message: <A HREF="028308.html">[Twisted-Python] Some comments regarding #5190 - ``RFC 6125 (&quot;Service Identity&quot;) implementation&#180;&#180;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28307">[ date ]</a>
              <a href="thread.html#28307">[ thread ]</a>
              <a href="subject.html#28307">[ subject ]</a>
              <a href="author.html#28307">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
