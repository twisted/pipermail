<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] wvfactory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20wvfactory&In-Reply-To=%3C000001c3afaa%2424c8b3e0%24687ba8c0%40vicky%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] wvfactory</H1>
    <B>vicky lupien</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20wvfactory&In-Reply-To=%3C000001c3afaa%2424c8b3e0%24687ba8c0%40vicky%3E"
       TITLE="[Twisted-Python] wvfactory">vlupien at drummonddesigns.com
       </A><BR>
    <I>Thu Nov 20 14:06:18 MST 2003</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39025">[ date ]</a>
              <a href="thread.html#39025">[ thread ]</a>
              <a href="subject.html#39025">[ subject ]</a>
              <a href="author.html#39025">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a form in a web page and I need to fill it with many sql queries
but only the first time the page is rendered.  
The other times, I want to fill it with the data from request.args.
 
I decided to build a dictionnary that looks like the dictionnary of
request.args to be able to use only one function to validate and fill my
form.
My function that fill my forms need to receive the dictionnary, the
document(node that I need to change) and a signature (signature is a
list of the name and the type of each elements from the form that need
to be fill).
 
In my template, I defined a wmfactory in the tag &lt;form&gt; that return my
dictionnary.  Ive also define a wvfactory that call my function to fill
the form.
The problems is that wmfactory return a deferred so in wvfactory I have
to call my function to fill like this:  return
model.getData(request).addCallback(my function).  But I think that
return doesnt wait that the addCallback is done.
 
Is there something I can do to make my returns wait for the addCallback
to return the new node filled with the dictionnary of data.
 
Heres a part of my code:
 
#verify is the function that fill and verify my form
class handle:
    def __init__(self):
        pass
    
    def verify(self, dict, doc, signature):
        # dict is the dictionnary from the sql queries of the
request.args
        # doc is the node &lt;form&gt; and its child
        error = 0
        for item in signature:
            nodeList = domhelpers.locateNodes(doc, 'name', item[0])
            #INTEGER, FLOAT and STRING
            if item[1] == 'integer' or item[1] == 'float' or item[1] ==
'string':
                pass
            #CHECKBOX
            elif item[1] == 'checkbox':
                for node in nodeList:
                    # dict est None s'il n'est pas cochee
                    if dict.get(item[0]) != None and
str(node.getAttribute('value')) in dict.get(item[0]):
                        print 'checked'
                        node.setAttribute('checked', 'checked')
                        print node
                    else:
                        if item[2] == 'true':
                            error = 1
                            l = microdom.lmx(node)
                            l.span(style='color: red').text('donnees
obligatoires')
        return doc
 
# class that execute the queries needed
class SummaryEditDB:
    def __init__(self, dbpool):
        self.dbpool = dbpool
 
    def getSummary(self, plan_id):
        sql = &quot;select * from plan where plan_id = '%s'&quot; %plan_id
        return self.dbpool.runQueryDict(sql)
 
    def getCategoriesIdByPlanId(self, plan_id):
        sql = &quot;&quot;&quot;select to_plan_category_id from plan_categories
                 where to_plan_id='%s' order by to_plan_category_id&quot;&quot;&quot; %
plan_id
        return self.dbpool.runQueryDict(sql)
 
 
class SummaryEditPage(pages.BasePage):
    templateFile = &quot;summary_edit.html&quot;
    
    def initialize(self, dbpool, *args):
        self.dbpool = dbpool
        self.db = SummaryEditDB(self.dbpool)
        self.signature = (('categories', 'checkbox', 'false', 'valeurs
non correctes'))
 
    def executeSQL(self, plan_id):
        def createSummaryDict(results, newDict):
            for item in results[0]:
                for elem in self.signature:
                    if item == elem[0]:
                        newDict[item] = results[0][item]
            return
self.db.getCategoriesIdByPlanId(plan_id).addCallback(createCategoriesDic
t, newDict)
 
        def createCategoriesDict(results, newDict):
            newDict['categories'] = []
            for item in results:
 
newDict['categories'].append(str(item.get('to_plan_category_id')))
            return newDict
 
        newDict = {}    
        return
self.db.getSummary(plan_id).addCallback(createSummaryDict, newDict)    #
first addCallback to fill the dictionnary
                 
 
    def setUp(self, request, *args):
            self.planData = self.executeSQL(plan_id) #this call the
function that return the dictionnary with the data (deferred)
   
    def wmfactory_planData(self, request):
        return self.planData          # Usually, when I return an SQL
queries, the model is not deferred but in this case, it is
    
    def wvfactory_fillFromSQL(self, request, node, model):
        def format(results):
            print results
            return handle().verify(results, node, self.signature) # the
function that fill the form (replace attributes in the node)
          
        return self.planData.addCallback(format)   # to be able to see
the results of self.planData, I need to use a addCallback to be able to
see the results
 
and to call the form filler.  But I seems that it doesnt wait to the
addCallback to be done
        
    def wchild_update(self, request):
        return self
        
Heres a part of my template file:
 
&lt;form action=&quot;/summary/edit/update&quot; method=&quot;post&quot;
enctype=&quot;multipart/form-data&quot; view=&quot;fillFromSQL&quot; model=&quot;planData&quot;&gt;
&lt;table border=&quot;0&quot; width=&quot;100%&quot; cellspacing=&quot;1&quot; cellpadding=&quot;2&quot;&gt;
                        &lt;tr&gt;
                                    &lt;td class=&quot;label&quot; width=&quot;25%&quot;
valign=&quot;top&quot;&gt;
                                                &nbsp;Cat&eacute;gories 
                                    &lt;/td&gt;
                                    &lt;td class=&quot;area&quot; width=&quot;75%&quot;&gt;
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000001&quot; /&gt;1 étage&lt;br /&gt; 
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000002&quot; /&gt;1/2 étages&lt;br/&gt; 
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000003&quot; /&gt;2 étages&lt;br/&gt;
&lt;input class=&quot;box&quot; type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000004&quot;
/&gt;Split-Level&lt;br /&gt; 
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000005&quot; /&gt;Chalet 4 saisons&lt;br
/&gt; 
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000006&quot; /&gt;Bi-Génération&lt;br /&gt; 
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000007&quot; /&gt;Semi-Détaché&lt;br /&gt; 
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000008&quot; /&gt;Townhouse&lt;br /&gt; 
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000009&quot; /&gt;Duplex&lt;br /&gt; 
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000010&quot; /&gt;Triplex&lt;br /&gt; 
                                                &lt;input class=&quot;box&quot;
type=&quot;checkbox&quot; name=&quot;categories&quot; value=&quot;1000011&quot; /&gt;Appartement (4+)&lt;br
/&gt; 
                                    &lt;/td&gt;
                        &lt;/tr&gt;
            &lt;/table&gt;
&lt;/form&gt;
 
I really need help, so if someone wants to help me, it will be
appreciate.
Thx in advance
Vicky
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20031120/043719e1/attachment.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39025">[ date ]</a>
              <a href="thread.html#39025">[ thread ]</a>
              <a href="subject.html#39025">[ subject ]</a>
              <a href="author.html#39025">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
