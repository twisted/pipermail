<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Scaling problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Scaling%20problem&In-Reply-To=%3C200311050248.07658.uwe%40oss4u.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="038801.html">
   <LINK REL="Next"  HREF="038808.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Scaling problem</H1>
    <B>Uwe C. Schroeder</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Scaling%20problem&In-Reply-To=%3C200311050248.07658.uwe%40oss4u.com%3E"
       TITLE="[Twisted-Python] Scaling problem">uwe at oss4u.com
       </A><BR>
    <I>Wed Nov  5 03:48:07 MST 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="038801.html">[Twisted-Python] Scaling problem
</A></li>
        <LI>Next message (by thread): <A HREF="038808.html">[Twisted-Python] Scaling problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38806">[ date ]</a>
              <a href="thread.html#38806">[ thread ]</a>
              <a href="subject.html#38806">[ subject ]</a>
              <a href="author.html#38806">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On Tuesday 04 November 2003 12:20 pm, Glyph Lefkowitz wrote:
&gt;<i> Uwe C. Schroeder wrote:
</I>&gt;<i> &gt; Is there a way to have twisted do something like apache or postgres and
</I>&gt;<i> &gt; split the incoming connection to several processes ? It's not a web
</I>&gt;<i> &gt; application, I'm solely using pb.
</I>&gt;<i>
</I>&gt;<i> This is possible, although not as easy as I'd like it to be.  In
</I>&gt;<i> principle, on most UNIX-based OSes, it's possible to listen() and
</I>&gt;<i> accept() in one process, pass the returned file descriptor to a
</I>&gt;<i> subprocess and do communication there.  I'd like to make this automatic
</I>&gt;<i> at some point, but won't have the time to do it for at least another few
</I>&gt;<i> months.
</I>&gt;<i>
</I>&gt;<i> The fact that it's not as graceful or automatic as I like doesn't mean
</I>&gt;<i> it's impossible though.  If you want to just have one &quot;control&quot; process
</I>&gt;<i> that shuttles around I/O and N worker processes that do the actual work,
</I>&gt;<i> you can still use spawnProcess and communicate over stdin/stdout to the
</I>&gt;<i> subprocesses about new connections using a simple protocol which
</I>&gt;<i> multiplexes multiple socket connections down to the one pipe connection
</I>&gt;<i> and back.
</I>&gt;<i>
</I>&gt;<i> Also, if database latency is your main problem, or you can move a little
</I>&gt;<i> bit of performance-sensitive code into C and relinquish the GIL while
</I>&gt;<i> they're happening, you can just use callInThread to run your
</I>&gt;<i> transactions in threads instead of having the reactor waiting on them.
</I>
I figured that the impact of callInThread is much higher to the rest of the 
system than I like. I'm already using deferToThread a lot, however there are 
limits to the usefulness of threads.  For example I use it to do page 
formatting (printjobs). Each of the printjobs is about 120 pages to format. 
If I start 20 to 30 such formatting jobs with deferToThread twisted virtually 
becomes unresponsive. If I limit to a max of 3 or so it works. I admit I 
don't understand this, since IMHO defering to a thread should make it 
independant from the parent. I didn't dig into this problem since It's not a 
big deal to limit to a few such jobs at any given time and use a spooler type 
interface to suspend requests for later.

I think I suffer from database latency in general and with the expensive 
function in particular. The expensive function could be moved to a thread and 
maybe I'll give it a try. However if I do this for every method that writes 
more than 10 or 15 records to the database I'll most likely end up with 
thousands of threads. Currently the system is used by up to 15 people, but 
projection goes to 400+ people at any given time. I don't have a problem with 
having people wait for a result, I have a problem with the other people that 
don't get a result because the framework stops responding for a couple of 
functions that just take more than a millisecond to execute. 
I'd rather have 500 processes like with apache and have the OS do the 
scheduling - which is way more efficient than having the framework schedule.
The most expensive function I have (besides the printing mentioned above) 
executes in about 3 seconds. This is not &quot;blocking&quot; in my understanding, 
since the function never waits for something to happen, it just calculates 
and stores stuff. Twisted is unresponsive for those 3 seconds. Multiply that 
by 10 users and one user might end up with a delay of more than 30 seconds 
before his &quot;3 seconds&quot; are evaluated. If I had a lot of processes the OS 
would schedule that more efficiently since then the function might take 5 
seconds to complete, but it would be interrupted by the OS scheduler to hand 
processing time to one of the other processes. 

Maybe I'll look into splitting into n worker processes. Since this would 
involve going into twisted code, where would I start looking ?

	UC

- --
Open Source Solutions 4U, LLC	2570 Fleetwood Drive
Phone:  +1 650 872 2425		San Bruno, CA 94066
Cell:   +1 650 302 2405		United States
Fax:    +1 650 872 2417
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.1 (GNU/Linux)

iD8DBQE/qNVnjqGXBvRToM4RAgyCAJ9d73B7bnWIu4C3NyGDwQ23HqfXRACguodJ
pB5TPkUy6oYjlgC/Fvei36E=
=osgL
-----END PGP SIGNATURE-----



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="038801.html">[Twisted-Python] Scaling problem
</A></li>
	<LI>Next message (by thread): <A HREF="038808.html">[Twisted-Python] Scaling problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38806">[ date ]</a>
              <a href="thread.html#38806">[ thread ]</a>
              <a href="subject.html#38806">[ subject ]</a>
              <a href="author.html#38806">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
