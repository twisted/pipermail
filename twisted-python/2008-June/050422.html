<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re-working a synchronous iterator to use Twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re-working%20a%20synchronous%20iterator%20to%20use%20Twisted&In-Reply-To=%3C18520.10328.729525.221355%40jon.es%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="050412.html">
   <LINK REL="Next"  HREF="050492.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re-working a synchronous iterator to use Twisted</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re-working%20a%20synchronous%20iterator%20to%20use%20Twisted&In-Reply-To=%3C18520.10328.729525.221355%40jon.es%3E"
       TITLE="[Twisted-Python] Re-working a synchronous iterator to use Twisted">terry at jon.es
       </A><BR>
    <I>Tue Jun 17 15:10:48 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="050412.html">[Twisted-Python] Re-working a synchronous iterator to use Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="050492.html">[Twisted-Python] Re-working a synchronous iterator to use Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50422">[ date ]</a>
              <a href="thread.html#50422">[ thread ]</a>
              <a href="subject.html#50422">[ subject ]</a>
              <a href="author.html#50422">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>For the record, here's a followup to my own posting, with working code.
The earlier untested code was a bit of a mess. The below runs fine.

In case it wasn't clear before, you're pulling &quot;results&quot; (e.g., from a
search engine) in off the web. Each results pages comes with an indicator
to tell you whether there are more results. I wanted to write a function
(see processResults below) that, when called, would call the process
function below on each result, all done asynchronously.

This solution feels cumbersome, but it does work (aka prints the expected
output).

Comments welcome (just don't tell me to use version control :-))

Terry


from twisted.internet import defer

def process(result):
    # Stub: process a single result.
    print 'processed result', result

def getPage(uri, offset=0):
    # Stub: return some results and an indicator of whether more are available.
    data = [[0, 1, 2],
            [4, 7, 8, 10],
            [12, 14, 18, 30]]
    results = data[offset]
    more = offset &lt; len(data) - 1
    return defer.succeed((results, more))
        
def getResultsFromPage(page):
    # Stub: get the results from page, return them in a list
    return page[0]

def needToCallAgain(page):
    # Stub: determine if there are more results, given current page. return bool.
    return page[1]
    
# ASYNCHRONOUS result producer
def getResults(uri, offset=0):
    def parsePage(page, offset):
        results = getResultsFromPage(page)
        if needToCallAgain(page):
            d = getResults(uri, offset + 1)
        else:
            d = None
        return results, d
    def returnTheseResults(page, offset):
        resultIterator, done = parsePage(page, offset)
        return resultIterator, done
    return getPage(uri, offset).addCallback(returnTheseResults, offset)

# ASYNCHRONOUS calling
def processResults(uri):
    def cb((resultIterator, deferred)):
        for result in resultIterator:
            process(result)
        if deferred is not None:
            deferred.addCallback(cb)
    return getResults(uri).addCallback(cb)


if __name__ == '__main__':
    def finished(x):
        print 'finished'
    processResults('uri').addCallback(finished)



The above prints

$ python xxx.py
processed result 0
processed result 1
processed result 2
processed result 4
processed result 7
processed result 8
processed result 10
processed result 12
processed result 14
processed result 18
processed result 30
finished


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="050412.html">[Twisted-Python] Re-working a synchronous iterator to use Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="050492.html">[Twisted-Python] Re-working a synchronous iterator to use Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50422">[ date ]</a>
              <a href="thread.html#50422">[ thread ]</a>
              <a href="subject.html#50422">[ subject ]</a>
              <a href="author.html#50422">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
