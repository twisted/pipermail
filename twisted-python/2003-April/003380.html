<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] supressess warnings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20supressess%20warnings&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="003382.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] supressess warnings</H1>
    <B>Andrew Dalke</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20supressess%20warnings&In-Reply-To="
       TITLE="[Twisted-Python] supressess warnings">dalke at dalkescientific.com
       </A><BR>
    <I>Tue Apr  1 07:00:53 EST 2003</I>
    <P><UL>
        
        <LI>Next message: <A HREF="003382.html">[Twisted-Python] supressess warnings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3380">[ date ]</a>
              <a href="thread.html#3380">[ thread ]</a>
              <a href="subject.html#3380">[ subject ]</a>
              <a href="author.html#3380">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm just starting to learn how to use Twisted.  My first project
is to write a simple XML-RPC server.  I started with the demo,
and that worked fine.

I then added an import statement for the module I need.

from openeye.oechem import *

Now, this uses a shared library extension which was built
for Python 2.2, and I'm running a CVS version of Python 2.3,
so I usually get

/usr/local/lib/python2.3/site-packages/openeye/oechem.py:5:  
RuntimeWarning: Python C API version mismatch for module _oechem: This  
Python has API version 1012, module _oechem has version 1011.
   import _oechem

However, that didn't happen when I started my my simple
server.  I got no warning message.  I started to worry that my
file system wasn't properly saving files!  I played around with
the imports, and moved that import to be above the twisted
ones, and it started reporting the warning.

A bit of searching later and I found
   twisted/python/log.py
which redefines (!) warnings.showwarning to dump the data to a
logfile, which is initialized to a NullFile(), which does nothing.

So the twisted code is throwing some (potentially useful) diagnostics.

Doing a search I found the commit statement
<A HREF="http://twistedmatrix.com/pipermail/twisted-commits/2002-October/">http://twistedmatrix.com/pipermail/twisted-commits/2002-October/</A> 
003975.html
 &gt; 2) implemented a custom warning handler; now warnings look sexy.
 &gt;   (the hackish overriding of warnings.showwarning is the recommended  
way to
 &gt;   do so, according to the library reference.)

I'll grant that's what the docs say.  However, why is the logfile for
showwarnings initialized to NullFile, and not to sys.stderr?

For that matter, I think it's better to delay replacement until  
startLogging
is called.

Hmm, and why is os.linesep used in the logging?  The log
file should have been opened in text mode, in which case &quot;\n&quot;
will get translated to the proper os-dependent form.


I started to change the code, so I could submit a patch.  I got the
code out of CVS and am reading the documentation at
   <A HREF="http://twistedmatrix.com/documents/howto/coding-standard">http://twistedmatrix.com/documents/howto/coding-standard</A>
It says that the main test suite builder is in 'twisted.test.test_all'

That module doesn't exist (can't import it) nor is the appropriate
file present anywhere.  And the hyperlink from that page yields
   &quot;No Such Resource
    File not found.&quot;

It then says
   Acceptance tests are all automated by the bin/accepttests
but that program is in admin/accepttests

I ran that for my Mac OS X machine, with 'open' as the
WEBBROWSER setting (where does the '-b' option go, since
open doesn't block .. do I pass it to 'accepttests'?  Yes.) and  
/bin/true
as my IRCCLIENT, since I wouldn't know what to do with one
even assuming I had one.

Anyway, after a while it gave this error

/------
|<i>####
</I>|<i>#### Starting mail test.
</I>|<i>#### Output should be one email (<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">postmaster at foo.bar</A>)
</I>|<i>#### and one bounce (<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">postmaster at no.such.domain</A>).
</I>|<i>####
</I>\------
Running Command: './admin/../bin/mktap mail --domain foo.bar=dump  
--user postmaster=postmaster  --pop 18110'
option --pop not a unique prefix
Usage: mktap mail [options]
Options:
   -p, --pop3=                 Port to start the POP3 server on (0 to  
disable).
                               [default: 8110]
   -S, --pop3s=                Port to start the POP3-over-SSL server on  
(0 to
                               disable). [default: 0]
   -s, --smtp=                 Port to start the SMTP server on (0 to  
disable).
                               [default: 8025]
   -r, --relay=                relay mail we do not know how to handle  
to this
                               IP, using the given path as a queue  
directory
   -c, --certificate=          Certificate file to use for SSL  
connections
   -d, --domain=               generate an SMTP/POP3 virtual domain  
which saves
                               to &quot;path&quot;
       --version
       --help                  Display this help and exit.
   -u, --user=                 add a user/password to the last specified  
domains
       --bounce-to-postmaster  undelivered mails are sent to the  
postmaster

This creates a mail.tap file that can be used by twistd.
Running Command: './admin/../bin/twistd -f mail.tap'

Failed to load application: [Errno 2] No such file or directory:  
'mail.tap'
Traceback (most recent call last):
   File &quot;./admin/accepttests&quot;, line 271, in ?
     runAllTests()
   File &quot;./admin/accepttests&quot;, line 247, in runAllTests
     runMailTest()
   File &quot;./admin/accepttests&quot;, line 204, in runMailTest
     s = smtplib.SMTP('127.0.0.1', 18026)
   File &quot;/usr/local/lib/python2.3/smtplib.py&quot;, line 240, in __init__
     (code, msg) = self.connect(host, port)
   File &quot;/usr/local/lib/python2.3/smtplib.py&quot;, line 302, in connect
     raise socket.error, msg
socket.error: (61, 'Connection refused')

Hmmm.... Is 'admin/runtests' the correct script to run?  I ran that,
and got the following output

======================================================================== 
=======
FAILURE: testReadLimit (twisted.test.test_policies.ThrottlingTestCase)
------------------------------------------------------------------------ 
-------
Traceback (most recent call last):
    File &quot;/Users/dalke/cvses/Twisted/twisted/test/test_policies.py&quot;,  
line 193, in testReadLimit
     self.assertEquals(tServer.readThisSecond, 0)
  FailTest: 20 != 0
======================================================================== 
=======
FAILURE: testWriteLimit (twisted.test.test_policies.ThrottlingTestCase)
------------------------------------------------------------------------ 
-------
Traceback (most recent call last):
    File &quot;/Users/dalke/cvses/Twisted/twisted/test/test_policies.py&quot;,  
line 152, in testWriteLimit
     self.assert_(abs(p.wrappedProtocol.paused - now - 1.0) &lt; 0.1)
  FailTest
======================================================================== 
=======
FAILURE: testPackages (twisted.test.test_setup.CheckingPackagesTestCase)
------------------------------------------------------------------------ 
-------
Traceback (most recent call last):
    File &quot;/Users/dalke/cvses/Twisted/twisted/test/test_setup.py&quot;, line  
44, in testPackages
     self.failUnlessEqual(l, [])
  FailTest: ['twisted.bugs', 'twisted.coils', 'twisted.eco',  
'twisted.enterprise.userRequests', 'twisted.forum', 'twisted.inetd',  
'twisted.issues', 'twisted.issues.ui', 'twisted.issues.ui.templates',  
'twisted.lumberjack', 'twisted.metrics', 'twisted.pretzel',  
'twisted.protocols.ldap', 'twisted.reality', 'twisted.reality.ui',  
'twisted.secsh', 'twisted.test.interactive', 'twisted.web.blog',  
'twisted.words.ui', 'twisted.words.ui.gateways'] != []
======================================================================== 
=======
FAILURE: testFailing (twisted.test.test_tcp.LoopbackTestCase)
------------------------------------------------------------------------ 
-------
Traceback (most recent call last):
    File &quot;/Users/dalke/cvses/Twisted/twisted/test/test_tcp.py&quot;, line  
171, in testFailing
     self.assert_(time.time() - start &lt; 0.1)
  FailTest
======================================================================== 
=======
ERROR: testUnicodeTolerance (twisted.test.test_xml.MicroDOMTest)
------------------------------------------------------------------------ 
-------
Traceback (most recent call last):
    File &quot;/Users/dalke/cvses/Twisted/twisted/trial/unittest.py&quot;, line  
165, in runOneTest
     method(testCase)
    File &quot;/Users/dalke/cvses/Twisted/twisted/test/test_xml.py&quot;, line  
326, in testUnicodeTolerance
     ud = microdom.parseString(s.encode('UTF-16'))
    File &quot;./twisted/web/microdom.py&quot;, line 644, in parseString
    File &quot;./twisted/web/microdom.py&quot;, line 609, in parse
    File &quot;./twisted/protocols/sux.py&quot;, line 155, in dataReceived
    File &quot;./twisted/protocols/sux.py&quot;, line 176, in do_begin
    File &quot;./twisted/protocols/sux.py&quot;, line 108, in _parseError
  ParseError: &lt;xmlfile /&gt;:1:1: First char of document ['\xfe'] wasn't &lt;
======================================================================== 
=======
SKIPPED: test_modules (twisted.test.test_doc.DocCoverage)
------------------------------------------------------------------------ 
-------
Remove this line when you feel like writing docstrings.
------------------------------------------------------------------------ 
-------
Ran 494 tests in 227.667s

FAILED (failures=4, errors=1, skips=1)

Could not import twisted.test.test_conch: No module named Crypto.Cipher





So I tried to rewrite the code given that it looks like the self-tests
run reasonably well, but then ran into complications with this bit of  
code

# Make sure we have some basic logging setup.  This only works in  
cpython.
try:
     logOwner
except NameError:
     logOwner = LogOwner()

     ...

# Prevent logfile from being erased on reload.  This only works in  
cpython.
try:
     logfile
except NameError:
     logfile = NullFile()
     logerr = sys.stderr


Okay, so we've got some code duplication here, and comment
skew.  I've fixed that up, and tidied up a few other bits of the code.
And for the life of me I can't figure out why the log file should
default (when no logging is enabled) to the NullFile rather than
sys.stderr -- if you really want the NullFile, just pass it in.  So
I switched it to use sys.stderr.

I then reran the 'admin/runtests' script and got ... some warnings
and comments which were being supressed.

/Users/dalke/cvses/Twisted/twisted/test/test_delay.py:24:  
DeprecationWarning: twisted.python.delay is deprecated. Please use  
reactor methods.
   from twisted.python import delay
/Users/dalke/cvses/Twisted/twisted/protocols/dns.py:46: RuntimeWarning:  
PyCrypto not available - proceeding with non-cryptographically secure  
random source
Enabling Multithreading.
Resolver added ('64.105.156.138', 53) to server list
Resolver added ('64.105.132.250', 53) to server list

Also, I removed those os.linesep references, and the os module,
and the needless string module.  And turned 'file_protocol' into
'_file_protocol' since it's for internal use only.

Why's the Log pickleable? What happens if a cStringIO is passed
in instead of a file?  Or an outgoing network socket?  Or a
os.popen(&quot;lp&quot;)?

It looks like Log.synchronized is old code that can be removed.  Yes?

Why does doc/examples/cursesclient.py set log.logfile directly?
Shouldn't it call log.startLogging(log.NullFile()) ?  It's the only  
other
piece of code which references log.NullFile.

Is 'discardLogs' the true inverse of startLogging?  If so, it
should add something to restore sys.stdout/sys.stderr if
startLogging asked them to be changed.

If not, where's the 'stopLogging' function?  And 'discard'
means to ignore logging?  Or should it throw away the
log files?  The terminology is confusing.

Anyway, the diff -u is attached for you all to review and
correct. 
  
-------------- next part --------------
A non-text attachment was scrubbed...
Name: log.py.diff
Type: application/octet-stream
Size: 4148 bytes
Desc: not available
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20030401/a162bb55/attachment.obj">http://twistedmatrix.com/pipermail/twisted-python/attachments/20030401/a162bb55/attachment.obj</A> 
-------------- next part --------------


Oh, and with my changes, I now see the expected warning
when I start up, and I see two twisted messages ...

[Andrew-Dalkes-Computer:~/cvses/Twisted] dalke% python cansmi_rpc.py
/usr/local/lib/python2.3/site-packages/openeye/oechem.py:5: 
RuntimeWarning: Python C API version mismatch for module _oechem: This 
Python has API version 1012, module _oechem has version 1011.
   import _oechem
twisted.web.server.Site starting on 8080
Starting factory &lt;twisted.web.server.Site instance at 0x640850&gt;

which tells me that those two messages (&quot;Site starting&quot; and &quot;Starting
factory&quot;) were being sent to never-never-land the whole time.  Perhaps
the latter shouldn't be present?

					Andrew
					<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dalke at dalkescientific.com</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="003382.html">[Twisted-Python] supressess warnings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3380">[ date ]</a>
              <a href="thread.html#3380">[ thread ]</a>
              <a href="subject.html#3380">[ subject ]</a>
              <a href="author.html#3380">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
