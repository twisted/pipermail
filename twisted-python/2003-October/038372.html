<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] smtp.SMTP help 
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20smtp.SMTP%20help%20&In-Reply-To=%3C200310012347.h91NlHW04812%40haddock.cd.chalmers.se%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="038371.html">
   <LINK REL="Next"  HREF="038379.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] smtp.SMTP help </H1>
    <B>Anders Hammarquist</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20smtp.SMTP%20help%20&In-Reply-To=%3C200310012347.h91NlHW04812%40haddock.cd.chalmers.se%3E"
       TITLE="[Twisted-Python] smtp.SMTP help ">iko at cd.chalmers.se
       </A><BR>
    <I>Wed Oct  1 17:47:17 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="038371.html">[Twisted-Python] smtp.SMTP help
</A></li>
        <LI>Next message (by thread): <A HREF="038379.html">[Twisted-Python] smtp.SMTP help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38372">[ date ]</a>
              <a href="thread.html#38372">[ thread ]</a>
              <a href="subject.html#38372">[ subject ]</a>
              <a href="author.html#38372">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Greg!

In a message of Wed, 01 Oct 2003 17:20:17 EDT, Greg writes:
&gt;<i>Working on an SMTP filter (consisting of an SMTP server that receives 
</I>&gt;<i>messages, some code that mangles them, then and SMTP client that forwards 
</I>&gt;<i>them along). The first step is to get a functioning SMTP server working, and 
</I>&gt;<i>I'm having some trouble with SMTPFactory / SMTP. I've overloaded the validate 
</I>&gt;<i>methods in an attempt accept emails to and from any domain, but I can't 
</I>&gt;<i>figure out how to hook in a class that implements IMessageDelivery:
</I>
There are several problems with your code, but to my eye it looks like
confusion between several methods of using the SMTP class. Until recently,
the IMessageDelivery method didn't exists, and you needed to override
SMTP to implement validateTo and validateFrom. Now, you can instead pass
an IMessageDelivery to SMTP, either directly or using the authenticator
(and if you do, you shouldn't need to subclass SMTP - and if your twisted
is recent enough, you have to use the IMessageDelivery method).

You do need to make your own factory though, since the one that's there
doesn't deal with IMessageDelivery()s yet. Something like

class MySMTPFactory(SMTPFactory):
	def buildProtocol(self, addr):
		p = self.protocol(MyMessageDelivery())
		p.factory = self
		p.portal = self.portal
		p.host = self.domain
		return p

&gt;<i>class MySMTPProtocol(SMTP):
</I>[...]
&gt;<i>	def validateTo(self, user):
</I>&gt;<i>		d = defer.Deferred()
</I>&gt;<i>		reactor.callLater(0, self.fakeSucceed())
</I>&gt;<i>		return d
</I>
You don't need this code, but I still want to point out that it doesn't
do anything useful, and is overcomplicated. 

First, validateTo may return an IMessage or a deferred returning an
IMessage, so you don't need the deferred, you can just return you
IMessage directly. Secondly the deferred is never called, so it will
never return, and thus your SMTP server stops here.

reactor.callLater() just calls another function asynchrously and discards
the result. If you want to pass back a result from a callLater, you need
to pass along the deferred and call it in the function you callLater()ed.

&gt;<i>class MyIMessage:
</I>&gt;<i>	__implements__ = (smtp.IMessageDelivery)
</I>
You seem to have mixed up IMessage and IMessageDelivery. You need both.
Your IMessageDelivery.validateTo() should return an IMessage (or a deferred
returning an IMessage).

HTH
/Anders

-- 
 -- Of course I'm crazy, but that doesn't mean I'm wrong.
Anders Hammarquist                                  | <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">iko at cd.chalmers.se</A>
Physics student, Chalmers University of Technology, | Hem: +46 31 88 48 50
G|teborg, Sweden.           RADIO: SM6XMM and N2JGL | Mob: +46 707 27 86 87


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="038371.html">[Twisted-Python] smtp.SMTP help
</A></li>
	<LI>Next message (by thread): <A HREF="038379.html">[Twisted-Python] smtp.SMTP help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38372">[ date ]</a>
              <a href="thread.html#38372">[ thread ]</a>
              <a href="subject.html#38372">[ subject ]</a>
              <a href="author.html#38372">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
