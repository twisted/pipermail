<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] smtp.SMTP help
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20smtp.SMTP%20help&In-Reply-To=%3C3F7D613C.5020609%40digitalinfo.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="038381.html">
   <LINK REL="Next"  HREF="038395.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] smtp.SMTP help</H1>
    <B>Greg</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20smtp.SMTP%20help&In-Reply-To=%3C3F7D613C.5020609%40digitalinfo.net%3E"
       TITLE="[Twisted-Python] smtp.SMTP help">greg at digitalinfo.net
       </A><BR>
    <I>Fri Oct  3 05:45:00 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="038381.html">[Twisted-Python] smtp.SMTP help
</A></li>
        <LI>Next message (by thread): <A HREF="038395.html">[Twisted-Python] smtp.SMTP help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38393">[ date ]</a>
              <a href="thread.html#38393">[ thread ]</a>
              <a href="subject.html#38393">[ subject ]</a>
              <a href="author.html#38393">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks! In order to help others like me who were struggling with this, 
here's the working code. Please let me know if I did anything 
egregiously stupid here.

#!/usr/bin/env python
# Simple SMTP server shell

from twisted.internet import reactor, protocol, defer
from twisted.protocols import smtp

class MyMessage:
    __implements__ = (smtp.IMessage)
       
    def __init__(self):
        self.msg = []

    def lineReceived(self, line):
        self.msg.append(line)

    def eomReceived(self):
        # Handle message here
        for line in self.msg:
            print line
        self.msg = []
        return defer.succeed('&lt;Whatever&gt;')
   
class MyMessageDelivery:
    __implements__ = (smtp.IMessageDelivery)
   
    def validateFrom(self, helo, origin):
        return origin
       
    def validateTo(self, user):
        return MyMessage
       
    def receivedHeader(self, helo, origin, recipients):
        return None

class MySMTPFactory(smtp.SMTPFactory):
    def buildProtocol(self, addr):
        p = self.protocol(MyMessageDelivery())
        p.factory = self
        p.portal = self.portal
        p.host = &quot;somedomain.com&quot;
        return p   
       
factory = MySMTPFactory()
factory.protocol = smtp.SMTP
reactor.listenTCP(25, factory)
reactor.run()

Anders Hammarquist wrote:

&gt;<i>Hi Greg!
</I>&gt;<i>
</I>&gt;<i>In a message of Wed, 01 Oct 2003 17:20:17 EDT, Greg writes:
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>Working on an SMTP filter (consisting of an SMTP server that receives 
</I>&gt;&gt;<i>messages, some code that mangles them, then and SMTP client that forwards 
</I>&gt;&gt;<i>them along). The first step is to get a functioning SMTP server working, and 
</I>&gt;&gt;<i>I'm having some trouble with SMTPFactory / SMTP. I've overloaded the validate 
</I>&gt;&gt;<i>methods in an attempt accept emails to and from any domain, but I can't 
</I>&gt;&gt;<i>figure out how to hook in a class that implements IMessageDelivery:
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>There are several problems with your code, but to my eye it looks like
</I>&gt;<i>confusion between several methods of using the SMTP class. Until recently,
</I>&gt;<i>the IMessageDelivery method didn't exists, and you needed to override
</I>&gt;<i>SMTP to implement validateTo and validateFrom. Now, you can instead pass
</I>&gt;<i>an IMessageDelivery to SMTP, either directly or using the authenticator
</I>&gt;<i>(and if you do, you shouldn't need to subclass SMTP - and if your twisted
</I>&gt;<i>is recent enough, you have to use the IMessageDelivery method).
</I>&gt;<i>
</I>&gt;<i>You do need to make your own factory though, since the one that's there
</I>&gt;<i>doesn't deal with IMessageDelivery()s yet. Something like
</I>&gt;<i>
</I>&gt;<i>class MySMTPFactory(SMTPFactory):
</I>&gt;<i>	def buildProtocol(self, addr):
</I>&gt;<i>		p = self.protocol(MyMessageDelivery())
</I>&gt;<i>		p.factory = self
</I>&gt;<i>		p.portal = self.portal
</I>&gt;<i>		p.host = self.domain
</I>&gt;<i>		return p
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>class MySMTPProtocol(SMTP):
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>[...]
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>	def validateTo(self, user):
</I>&gt;&gt;<i>		d = defer.Deferred()
</I>&gt;&gt;<i>		reactor.callLater(0, self.fakeSucceed())
</I>&gt;&gt;<i>		return d
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>You don't need this code, but I still want to point out that it doesn't
</I>&gt;<i>do anything useful, and is overcomplicated. 
</I>&gt;<i>
</I>&gt;<i>First, validateTo may return an IMessage or a deferred returning an
</I>&gt;<i>IMessage, so you don't need the deferred, you can just return you
</I>&gt;<i>IMessage directly. Secondly the deferred is never called, so it will
</I>&gt;<i>never return, and thus your SMTP server stops here.
</I>&gt;<i>
</I>&gt;<i>reactor.callLater() just calls another function asynchrously and discards
</I>&gt;<i>the result. If you want to pass back a result from a callLater, you need
</I>&gt;<i>to pass along the deferred and call it in the function you callLater()ed.
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>&gt;&gt;<i>class MyIMessage:
</I>&gt;&gt;<i>	__implements__ = (smtp.IMessageDelivery)
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>You seem to have mixed up IMessage and IMessageDelivery. You need both.
</I>&gt;<i>Your IMessageDelivery.validateTo() should return an IMessage (or a deferred
</I>&gt;<i>returning an IMessage).
</I>&gt;<i>
</I>&gt;<i>HTH
</I>&gt;<i>/Anders
</I>&gt;<i>
</I>&gt;<i>  
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20031003/e009dbaa/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="038381.html">[Twisted-Python] smtp.SMTP help
</A></li>
	<LI>Next message (by thread): <A HREF="038395.html">[Twisted-Python] smtp.SMTP help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38393">[ date ]</a>
              <a href="thread.html#38393">[ thread ]</a>
              <a href="subject.html#38393">[ subject ]</a>
              <a href="author.html#38393">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
