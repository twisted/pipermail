<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Deferred problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Deferred%20problem&In-Reply-To=000001c39d5f%24cf9d43b0%24687ba8c0%40vicky">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006185.html">
   <LINK REL="Next"  HREF="006192.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Deferred problem</H1>
    <B>Donovan Preston</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Deferred%20problem&In-Reply-To=000001c39d5f%24cf9d43b0%24687ba8c0%40vicky"
       TITLE="[Twisted-Python] Deferred problem">dp at twistedmatrix.com
       </A><BR>
    <I>Tue Oct 28 11:07:06 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="006185.html">[Twisted-Python] Deferred problem
</A></li>
        <LI>Next message: <A HREF="006192.html">[Twisted-Python] Authentication (cred.checkers) by a database (was deferred problem)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6188">[ date ]</a>
              <a href="thread.html#6188">[ thread ]</a>
              <a href="subject.html#6188">[ subject ]</a>
              <a href="author.html#6188">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Oct 28, 2003, at 9:28 AM, vicky lupien wrote:

&gt;<i> &#160;&#160;&#160; def getUser(self, username):
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; sql = &quot;&quot;&quot;SELECT * FROM users WHERE name='%s'&quot;&quot;&quot; %username
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; results = self.dbpool.runQuery(sql)&#160;&#160; ## the deferred result
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; if results is not None:
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return results[0], results[1]
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; raise KeyError(username)
</I>
The Deferred is a promise that some data will be available eventually. 
You cannot
immediately access the result as you try to do here. What you want to 
do is return the
deferred from here after adding a callback which checks to see if there 
was a match
in the database and returns a Failure (analogous to raising an 
exception) if not. If the
authentication succeeded, the callback should return the id of the 
authenticated user.


def requestAvatarId(self, creds):
	## Start the database query; it will not be done until later.
	theDeferred = self.dbpool.runQuery(
		&quot;select * from users where name='%s'&quot; % username
	)

	## Define a callback which will check the results from the database
	## when they are ready and return either the id of the user who has
	## logged in or a failure indicating login failure.
	def checkAuth(result):
		if result is None:
			return failure.Failure(UnauthorizedLogin(c.username))

		u, p = result
		if components.implements(creds, credentials.IUsernameHashedPassword):
			h = self.hash(creds.username, creds.password, p)
			if h == p:
				return u
		return failure.Failure(UnauthorizedLogin(c.username)

	## Add the callback to the Deferred and return it; when the database
	## result is ready, the callback will fire and provide either a Failure
	## or a logged in user id to the framework code which has called
	## requestAvatarId.
	return theDeferred.addCallback(
		checkAuth
	)



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006185.html">[Twisted-Python] Deferred problem
</A></li>
	<LI>Next message: <A HREF="006192.html">[Twisted-Python] Authentication (cred.checkers) by a database (was deferred problem)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6188">[ date ]</a>
              <a href="thread.html#6188">[ thread ]</a>
              <a href="subject.html#6188">[ subject ]</a>
              <a href="author.html#6188">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
