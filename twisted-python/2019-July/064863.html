<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Need some enlightenment on using web client properly, or maybe nudge a bug to get fixed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Need%20some%20enlightenment%20on%20using%20web%20client%0A%20properly%2C%20or%20maybe%20nudge%20a%20bug%20to%20get%20fixed&In-Reply-To=%3C43260BF0-3DA9-4833-9015-78C27BB599CF%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032388.html">
   <LINK REL="Next"  HREF="064866.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Need some enlightenment on using web client properly, or maybe nudge a bug to get fixed</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Need%20some%20enlightenment%20on%20using%20web%20client%0A%20properly%2C%20or%20maybe%20nudge%20a%20bug%20to%20get%20fixed&In-Reply-To=%3C43260BF0-3DA9-4833-9015-78C27BB599CF%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Need some enlightenment on using web client properly, or maybe nudge a bug to get fixed">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Jul 11 01:19:14 MDT 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032388.html">[Twisted-Python] Need some enlightenment on using web client properly, or maybe nudge a bug to get fixed
</A></li>
        <LI>Next message (by thread): <A HREF="064866.html">[Twisted-Python] Need some enlightenment on using web client properly, or maybe nudge a bug to get fixed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64863">[ date ]</a>
              <a href="thread.html#64863">[ thread ]</a>
              <a href="subject.html#64863">[ subject ]</a>
              <a href="author.html#64863">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jarosław!

&gt;<i> On Jul 1, 2019, at 4:48 PM, Jarosław Fedewicz &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jaroslaw.fedewicz at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> I have written a simple service which takes data from network, massages it until it's useful enough, and sends the results out periodically via HTTP to an API.
</I>
A reasonable start :-).

&gt;<i> It all works for a while, then I get an error like this approximately 40 minutes into the service's uptime:
</I>&gt;<i> 
</I>&gt;<i> ResponseNeverReceived: [&lt;twisted.python.failure.Failure OpenSSL.SSL.ZeroReturnError: &gt;]
</I>&gt;<i> 
</I>&gt;<i> Then a couple more like this:
</I>&gt;<i> 
</I>&gt;<i> ResponseNeverReceived: [&lt;twisted.python.failure.Failure twisted.internet.error.ConnectionLost: Connection to the other side was lost in a non-clean fashion: Connection lost.&gt;]
</I>&gt;<i> 
</I>&gt;<i> Then it ends with
</I>&gt;<i> 
</I>&gt;<i> TimeoutError: User timeout caused connection failure.
</I>&gt;<i> 
</I>&gt;<i> Then every request results in the same TimeoutError. I don't know if using HTTPS important in this case.
</I>
I'm pretty sure the presence of an OpenSSL.SSL error indeed means that HTTPS is important.

&gt;<i> Restarting the whole service, of course, makes the problem go for a while. The other side is the Slack API, so I rather assume it's not very much to blame, it can be demonstrated to work rather reliably, all its criticisms notwithstanding.
</I>
It does seem likely that the clustering of errors you're seeing are a local problem with Twisted.

&gt;<i> I cannot yet tell if this bug is a function of uptime, or the number of requests made.
</I>
My personal guess is that it has something to do with the number of the TCP connections; or, specifically, the number of pyOpenSSL 'Connection' objects.

&gt;<i> I have tried to work around the problem by discarding the agent object, and using an HTTPConnectionPool with persistent=False, but it didn't help at all. I think it made the problem worse because the framework seems to refer to some objects the Agent creates, and the process becomes a CPU hogs in a couple hours (with the TimeoutErrors still happening all the time).
</I>
I have a slight suspicion that the thing that is leaking between connections here is the pyOpenSSL &quot;Context&quot; object.  We recently implemented an optimization which shares the Context object among multiple Connection objects that reference the same host.  What version of Twisted area you using, and what version of OpenSSL, pyOpenSSL, and Cryptography?

I'm curious if you reverse that optimization, if it would make any different to your use-case.

&gt;<i> The closest I've got on the internets which describes a similar problem, apart from people complaining on StackOverflow about precisely this to happen when they are using Scrapy, is this blog post from almost a decade ago: <A HREF="http://www.chris-wong.net/twisted-web-framework-user-timeout-caused-connection-failure/">http://www.chris-wong.net/twisted-web-framework-user-timeout-caused-connection-failure/</A> &lt;<A HREF="http://www.chris-wong.net/twisted-web-framework-user-timeout-caused-connection-failure/">http://www.chris-wong.net/twisted-web-framework-user-timeout-caused-connection-failure/</A>&gt;. 
</I>
This definitely seems like a bug, if it's occurring in multiple places.

&gt;<i> There could be a small chance I'm holding it wrong(tm), but maybe there exists a ticket, just worded differently, which could help me get to the bottom of it.
</I>
I don't think that any open tickets describe your precise issue.  So please do open one.  And if possible, can you minimize a proof of concept?  Some example code would go a long way to helping to isolate this.

-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190711/080ec3f1/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032388.html">[Twisted-Python] Need some enlightenment on using web client properly, or maybe nudge a bug to get fixed
</A></li>
	<LI>Next message (by thread): <A HREF="064866.html">[Twisted-Python] Need some enlightenment on using web client properly, or maybe nudge a bug to get fixed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64863">[ date ]</a>
              <a href="thread.html#64863">[ thread ]</a>
              <a href="subject.html#64863">[ subject ]</a>
              <a href="author.html#64863">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
