<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] New user, help needed with raw UDP packets
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20New%20user%2C%20help%20needed%20with%20raw%20UDP%20packets&In-Reply-To=%3C200404190856.56373.r.taylor%40eris.qinetiq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="040027.html">
   <LINK REL="Next"  HREF="040154.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] New user, help needed with raw UDP packets</H1>
    <B>Richard Taylor</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20New%20user%2C%20help%20needed%20with%20raw%20UDP%20packets&In-Reply-To=%3C200404190856.56373.r.taylor%40eris.qinetiq.com%3E"
       TITLE="[Twisted-Python] New user, help needed with raw UDP packets">r.taylor at eris.qinetiq.com
       </A><BR>
    <I>Mon Apr 19 01:56:46 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="040027.html">[Twisted-Python] New user, help needed with raw UDP packets
</A></li>
        <LI>Next message (by thread): <A HREF="040154.html">[Twisted-Python] twisted and interactive/command driven input
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40059">[ date ]</a>
              <a href="thread.html#40059">[ thread ]</a>
              <a href="subject.html#40059">[ subject ]</a>
              <a href="author.html#40059">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Many thanks to everyone that responded to my appeal for help with raw UDP 
sockets. Following up on the useful pointers I have come up with an initial 
proof of concept. The code below does appear to do what I need, although it 
needs lots of tiding up. If anyone can see anything wrong with what I am 
doing I would value the criticism. 


	
	import socket, fcntl
	from twisted.internet import protocol
	from twisted.internet import udp
	from twisted.internet import reactor

	import impacket # library from 
<A HREF="http://oss.coresecurity.com/projects/impacket.html">http://oss.coresecurity.com/projects/impacket.html</A>
	from impacket import ImpactDecoder,ImpactPacket

	from twisted.python.runtime import platformType
	if platformType == 'win32':
	    from errno import WSAEWOULDBLOCK as EWOULDBLOCK
	    from errno import WSAEINTR as EINTR
	    from errno import WSAEMSGSIZE as EMSGSIZE
	    from errno import WSAECONNREFUSED as ECONNREFUSED
	    from errno import WSAECONNRESET
	    from errno import EAGAIN
	elif platformType != 'java':
	    from errno import EWOULDBLOCK, EINTR, EMSGSIZE, ECONNREFUSED, EAGAIN
	
	
	class Echo(protocol.DatagramProtocol):

	    def __init__(self):
	        self.fake_addr = None
	        self.dest = &quot;127.0.0.1&quot;
	        self.port = 9999

	    def setFakeSrc(self, addr):
	        &quot;&quot;&quot;Set the fake address from which packets should appear to come.&quot;&quot;&quot;
	        self.fake_addr = addr
	        
	    def startProtocol(self):
	        print &quot;starting Echo&quot;
	        
	    def datagramReceived(self, data, (host, port)):
	        &quot;&quot;&quot;data is a IP packet object from Impacket.&quot;&quot;&quot;
	        ip = data
	        udp = ip.child()
	        if udp.get_uh_dport() == 9999:
	            src = ip.get_ip_src()
	
	            print &quot;host = %s&quot; % (host,)
	            print &quot;udp src = %s&quot; % (src,)
	            print &quot;received: %s&quot; % (udp,)
	
	            if self.fake_addr and src == &quot;128.98.3.63&quot;:
			# Fake the src address and resend the packet
	                ip.set_ip_src(self.fake_addr)
	                print &quot;resending with src = %s\n&quot; % (ip.get_ip_src(),)
	                self.transport.write(ip.get_packet(), (self.dest,self.port))

	class RawUDPPort(udp.Port):
	    &quot;&quot;&quot;Raw udp port.&quot;&quot;&quot;

	    __implements__ = udp.Port.__implements__

	    socketType = socket.SOCK_RAW # Overide socket type.
	    addressFamily = socket.AF_INET
	
	    def __init__(self, *args, **kw):
	        udp.Port.__init__(self,*args,**kw)
	        
	        self.protocolNum = socket.getprotobyname('udp')
	        self.decoder = ImpactDecoder.IPDecoder()
	    
	    def createInternetSocket(self):
	        s = socket.socket(self.addressFamily, self.socketType, 	
self.protocolNum)
	        s.setblocking(0)
		# enable the sending of udp headers.
	        s.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, 1)
	        if fcntl and hasattr(fcntl, 'FD_CLOEXEC'):
	            old = fcntl.fcntl(s.fileno(), fcntl.F_GETFD)
	            fcntl.fcntl(s.fileno(), fcntl.F_SETFD, old | fcntl.FD_CLOEXEC)
	        return s
	
	    def doRead(self):
	        &quot;&quot;&quot;Called when my socket is ready for reading.&quot;&quot;&quot;
	        read = 0
	        while read &lt; self.maxThroughput:
	            try:
	                data, addr = self.socket.recvfrom(self.maxPacketSize)
	                read += len(data)
	                ip = self.decoder.decode(data)
	                if isinstance(ip.child(),ImpactPacket.UDP) and \
	                   ip.child().get_uh_dport() == self.port:                
	                    self.protocol.datagramReceived(ip, addr)
	            except socket.error, se:
	                no = se.args[0]
	                if no in (EAGAIN, EINTR, EWOULDBLOCK):
	                    return
	                if (no == ECONNREFUSED) or (platformType == &quot;win32&quot; and no == 	
WSAECONNRESET):
	                    # XXX for the moment we don't deal with connection 	
refused
	                    # in non-connected UDP sockets.
	                    pass
	                else:
	                    raise
	##            except:
	##                log.deferr()
	
	echo = Echo()
	echo.setFakeSrc(&quot;127.0.0.1&quot;)

	reactor.listenWith(RawUDPPort,
                   proto=echo, port=9999, interface=&quot;localhost&quot;, 	
reactor=reactor)
	reactor.run()

Thanks again to everyone that helped. Once I have tidied things up I will send 
the finished bits to the appropriate people (who are they?) in case they want 
to include them as an example.

Regards

Richard

- -- 
QinetiQ                                  
B009 Woodward Building
St. Andrews Road
Malvern
Worcs WR14 3PS
Jabber: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">RichardTaylor at jabber.org</A>
PGPKey: <A HREF="http://search.keyserver.net:11371/pks/lookup?op=get&amp;search=0xA7DA9FD9">http://search.keyserver.net:11371/pks/lookup?op=get&amp;search=0xA7DA9FD9</A>
Key fingerprint = D051 A121 E7C3 485F 3C0E  1593 ED9E D868 A7DA 9FD9
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.1 (GNU/Linux)

iD8DBQFAg4ZE7Z7YaKfan9kRAqPIAKDOmCMLn7zEXKbr7i3kmkw7ofibFwCcCvZt
CqkSAsP397lFCqKFeke0J6s=
=DN4i
-----END PGP SIGNATURE-----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="040027.html">[Twisted-Python] New user, help needed with raw UDP packets
</A></li>
	<LI>Next message (by thread): <A HREF="040154.html">[Twisted-Python] twisted and interactive/command driven input
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40059">[ date ]</a>
              <a href="thread.html#40059">[ thread ]</a>
              <a href="subject.html#40059">[ subject ]</a>
              <a href="author.html#40059">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
