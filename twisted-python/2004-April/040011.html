<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: [Twisted-commits] r10475 - Use writeSequence	instead of silly for-loop.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20%5BTwisted-commits%5D%20r10475%20-%20Use%20writeSequence%0A%09instead%20of%20silly%20for-loop.&In-Reply-To=%3C3BF2210C-8F02-11D8-94D4-000A95A50FB2%40fuhm.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="040157.html">
   <LINK REL="Next"  HREF="040012.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: [Twisted-commits] r10475 - Use writeSequence	instead of silly for-loop.</H1>
    <B>James Y Knight</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20%5BTwisted-commits%5D%20r10475%20-%20Use%20writeSequence%0A%09instead%20of%20silly%20for-loop.&In-Reply-To=%3C3BF2210C-8F02-11D8-94D4-000A95A50FB2%40fuhm.net%3E"
       TITLE="[Twisted-Python] Re: [Twisted-commits] r10475 - Use writeSequence	instead of silly for-loop.">foom at fuhm.net
       </A><BR>
    <I>Thu Apr 15 11:27:56 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="040157.html">[Twisted-Python] twisted and interactive/command driven input
</A></li>
        <LI>Next message (by thread): <A HREF="040012.html">[Twisted-Python] Re: [Twisted-commits] r10475 - Use	writeSequence instead of silly for-loop.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40011">[ date ]</a>
              <a href="thread.html#40011">[ thread ]</a>
              <a href="subject.html#40011">[ subject ]</a>
              <a href="author.html#40011">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Apr 5, 2004, at 10:36 AM, Andrew Bennetts wrote:

&gt;<i> Author: spiv
</I>&gt;<i> Date: Mon Apr  5 08:36:43 2004
</I>&gt;<i> New Revision: 10475
</I>&gt;<i>
</I>&gt;<i> Modified:
</I>&gt;<i>    trunk/twisted/protocols/http.py
</I>&gt;<i> Log:
</I>&gt;<i> Use writeSequence instead of silly for-loop.
</I>
You might not have noticed that writeSequence is implemented like so:
   self.write(&quot;&quot;.join(iovec))
thus negating the performance enhancement recently added by not copying 
large data into a new string.

This is of course quite silly, and I suspect a nice performance 
enhancement could be achieved by making FileDescriptor.dataBuffer be a 
list of strings, rather than a single string. That would both cause 
multiple writes in a row to not allocate new strings, and allow 
writeSequence to be implemented sanely.

Doesn't look very hard really; looks like you'd only need to touch 
write/writeSequence/doWrite. This'd also have the advantage of making 
it easier to put a Sendfile-struct in there as well. So pahan's 
volunteered to fix this!

Unfortunately, python doesn't expose the writev syscall, which means 
that you depend on Nagling to not coalesce the TCP packets. There *is* 
a TCP option which you can use to help fix too many small packets: 
TCP_CORK on linux and TCP_NOPUSH on FreeBSD. This keeps partial packets 
from being sent at all until you close the connection or turn off the 
option (except on older freebsd, where it's broken and you need to turn 
off the option and call write again to wake it up).

I suspect it's worthwhile to set TCP_CORK/TCP_NOPUSH while the 
python-side buffer has any data left in it, or else the kernel may be 
deciding to send out small packets when it should be waiting for more 
data from an upcoming write call and wasting time/bandwidth. Python has 
the TCP_CORK constant, even, yay! FreeBSD will  just have to suffer, I 
suppose, since python doesn't know about TCP_NOPUSH.

James



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="040157.html">[Twisted-Python] twisted and interactive/command driven input
</A></li>
	<LI>Next message (by thread): <A HREF="040012.html">[Twisted-Python] Re: [Twisted-commits] r10475 - Use	writeSequence instead of silly for-loop.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40011">[ date ]</a>
              <a href="thread.html#40011">[ thread ]</a>
              <a href="subject.html#40011">[ subject ]</a>
              <a href="author.html#40011">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
