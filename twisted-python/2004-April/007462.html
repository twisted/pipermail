<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] follow up: at what point does reactor.run() need	to be called?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20follow%20up%3A%20at%20what%20point%20does%20reactor.run%28%29%20need%0A%09to%20be%20called%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007461.html">
   <LINK REL="Next"  HREF="007463.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] follow up: at what point does reactor.run() need	to be called?</H1>
    <B>Damon Fasching</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20follow%20up%3A%20at%20what%20point%20does%20reactor.run%28%29%20need%0A%09to%20be%20called%3F&In-Reply-To="
       TITLE="[Twisted-Python] follow up: at what point does reactor.run() need	to be called?">damon.fasching at sbcglobal.net
       </A><BR>
    <I>Wed Apr  7 04:04:34 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="007461.html">[Twisted-Python] POP3 Client
</A></li>
        <LI>Next message: <A HREF="007463.html">[Twisted-Python] follow up: at what point does reactor.run() need	to be called?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7462">[ date ]</a>
              <a href="thread.html#7462">[ thread ]</a>
              <a href="subject.html#7462">[ subject ]</a>
              <a href="author.html#7462">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm still confused.

Here is the working code, again.

# ================= server.py ====================
from twisted.spread import pb
from twisted.internet import reactor

class ServerClass(pb.Root):
    def remote_shutdown(self):
        print &quot;server stopping&quot;
        reactor.stop()

reactor.listenTCP(8789,
pb.PBServerFactory(ServerClass()))
reactor.run()

# =========== client.py =============
from twisted.spread import pb
from twisted.internet import reactor

def gotRootObject(obj):
    d = obj.callRemote(&quot;shutdown&quot;)
    d.addCallback(serverStopped)
    d.addErrback(remoteCallFailure)

def serverStopped(result):
    print 'server stopped'
    stop()

def remoteCallFailure(reason):
    print &quot;remote call failed: %s&quot; % (reason.value)
    stop()

def stop():
    print &quot;client stopping&quot;
    reactor.stop()

factory = pb.PBClientFactory()
reactor.connectTCP(&quot;localhost&quot;, 8789, factory)
d = factory.getRootObject()
d.addCallback(gotRootObject)
d.addErrback(remoteCallFailure, &quot;getRootObject&quot;)
reactor.run()

============

And here is a modification to the last lines of
client.py which breaks it, in this case causes it to
hang.  (server does not get the shutdown call and
client is not stopped, so it seems the callback for
getRootObject is not executed.)

factory = pb.PBClientFactory()
reactor.connectTCP(&quot;localhost&quot;, 8789, factory)
d = factory.getRootObject()
reactor.run()
d.addCallback(gotRootObject)
d.addErrback(remoteCallFailure, &quot;getRootObject&quot;)

==============================================

&gt;<i> It doesn't hang, it just gets the root object, but 
</I>&gt;<i> has no callback to pass it to.
</I>
Huh?  What about the line
d.addCallback(gotRootObject)?  It's still there, just
a little further down, and d is still d, the deferred
object returned by getRootObject.  Does the call to
reactor.run() change the deferred, d?

What I really see as a limitation is that it seems
that I must connect to all of my servers before
starting the reactor, something which is only done
once per process.  And because of that, I can't
interact with any of the servers until I have
connected to all of them (because the reactor isn't
running before then).

For example, why does the client hang if I change the
last lines to the following?

reactor.run()
factory = pb.PBClientFactory()
reactor.connectTCP(&quot;localhost&quot;, 8789, factory)
d = factory.getRootObject()
d.addCallback(gotRootObject)
d.addErrback(remoteCallFailure, &quot;getRootObject&quot;)

This seems to be an inevitable sequence of calls if I
want to be able to connect to a server after having
already connected to and intereacted with other
servers.  Start the reactor, do some stuff, and then
at a later point, connect to another server.  If I
substitute those lines for the original last 6 lines,
start the server and start the client...nothing
happens.  They both just sit there.

What have I misunderstood?

How can I connect to a server on the fly?

&gt;<i> The value, that getRootObject() returns is a
</I>Deferred
&gt;<i> object. This is a &quot;delayed&quot; function call (which is
</I>&gt;<i> also non-blocking), so the *real* rootObject is
</I>&gt;<i> passed to the Deferred.callback function.
</I>
Right, it's the obj argument of the gotRootObject()
method in the original code.

&gt;<i> -- 
</I>&gt;<i> mp
</I>
Thanks,
  Damon



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007461.html">[Twisted-Python] POP3 Client
</A></li>
	<LI>Next message: <A HREF="007463.html">[Twisted-Python] follow up: at what point does reactor.run() need	to be called?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7462">[ date ]</a>
              <a href="thread.html#7462">[ thread ]</a>
              <a href="subject.html#7462">[ subject ]</a>
              <a href="author.html#7462">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
