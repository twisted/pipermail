<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] why deferred.setTimeout is not my favorite API	method
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20why%20deferred.setTimeout%20is%20not%20my%20favorite%20API%0A%09method&In-Reply-To=%3C20040418002534.GA7803%40frobozz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="040046.html">
   <LINK REL="Next"  HREF="040067.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] why deferred.setTimeout is not my favorite API	method</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20why%20deferred.setTimeout%20is%20not%20my%20favorite%20API%0A%09method&In-Reply-To=%3C20040418002534.GA7803%40frobozz%3E"
       TITLE="[Twisted-Python] why deferred.setTimeout is not my favorite API	method">andrew-twisted at puzzling.org
       </A><BR>
    <I>Sat Apr 17 18:25:34 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="040046.html">[Twisted-Python] why deferred.setTimeout is not my favorite API	method
</A></li>
        <LI>Next message (by thread): <A HREF="040067.html">[Twisted-Python] why deferred.setTimeout is not my favorite API	method
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40044">[ date ]</a>
              <a href="thread.html#40044">[ thread ]</a>
              <a href="subject.html#40044">[ subject ]</a>
              <a href="author.html#40044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>It looks like I've succeeded in rekindling interest in this issue :)

On Sat, Apr 17, 2004 at 06:22:50PM -0400, Jonathan Simms wrote:
&gt;<i> This is response to issue 178 on the twisted tracker:
</I>&gt;<i> <A HREF="http://www.twistedmatrix.com/users/roundup.twistd/twisted/issue178,">http://www.twistedmatrix.com/users/roundup.twistd/twisted/issue178,</A>
</I>&gt;<i> about the deferred method setTimeout.
</I>&gt;<i> 
</I>&gt;<i> The reason why I added a &quot;DON'T USE THIS&quot; to the docstring was that I
</I>&gt;<i> find that we are telling people this at least once a week. I think it
</I>&gt;<i> has more gravitas coming from the API documentation, as there is this
</I>&gt;<i> illusion that the people on IRC don't really know what they're talking
</I>&gt;<i> about, but if the author has marked something in the documentation, it
</I>&gt;<i> has a certain level of legitimacy.
</I>
Well, I guess I'm a bit confused.  Why not raise a DeprecationWarning as
well then?  Is &quot;DON'T USE THIS&quot; meant to be a watered-down version of a
DeprecationWarning?

&gt;<i> I agree with spiv in the sense that it would be nice to have a minimal
</I>&gt;<i> interface that would provide this functionality. However, i think that
</I>&gt;<i> the level of control that is needed to pull this off properly is best
</I>&gt;<i> served by writing an explicit timeout method and accompanying call to
</I>&gt;<i> callLater. 
</I>
The tricky part isn't the callLater, it's the actual cancellation of
whatever the operation that would've produced a deferred result -- and
that's something defer.py can't help with, because it is app-specific.

&gt;<i> now, I'd like to present the idiom that we are try to encourage users to
</I>&gt;<i> follow every time we have to steer them away from setTimeout. 
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> d = iReturnADeferred()
</I>&gt;<i> 
</I>&gt;<i> def onTimeout():
</I>&gt;<i>     handleTimeoutCondition()
</I>&gt;<i> 
</I>&gt;<i> delayedCall = reactor.callLater(timeoutLen, onTimeout)
</I>&gt;<i> 
</I>&gt;<i> def success(value):
</I>&gt;<i>     handleSuccess()
</I>&gt;<i> 
</I>&gt;<i> def nonTimeoutFailure(reason):
</I>&gt;<i>     handleErrorCondition()
</I>&gt;<i> 
</I>&gt;<i> def cancelTimeout(val):
</I>&gt;<i>     if delayedCall.active():
</I>&gt;<i>         delayedCall.cancel()
</I>&gt;<i> 
</I>&gt;<i> d.addBoth(cancelTimeout)
</I>&gt;<i> d.addCallback(success)
</I>&gt;<i> d.addErrback(nonTimeoutFailure)
</I>&gt;<i> 
</I>&gt;<i> -------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Here you see that each step is very explicit. You can see what happens
</I>&gt;<i> on success and on timeout (failure). I think one problem with setTimeout
</I>&gt;<i> is the handling of the IDelayedCall is something that a new user could
</I>&gt;<i> miss.  
</I>
First, there's a bug.  Presumably, cancelTimeout should return val,
otherwise you swallow the result/failure, regardless of what actually
happens.

What I don't see here is the most important part: presumably,
iReturnADeferred starts a long-running operation going, maybe a call to a
remote server.  This code doesn't do anything to stop that operation, and
doesn't do anything to prevent an AlreadyCalledError happening in that code
when the long-running operation completes.  Or does the mysterious
handleTimeoutCondition method do that?

setTimeout doesn't provide that either -- but it was my understanding that
that was the main objection to it.  Why is handling this yourself (which as
you demonstrate is error-prone!) an improvement over setTimeout?

With setTimeout, this code becomes:

----
d = iReturnADeferred()

def onTimeout():
    handleTimeoutCondition()
    raise defer.TimeoutError

d.setTimeout(timeoutLen, onTimeout)

def success(value):
    handleSuccess()

def nonTimeoutFailure(reason):
    if reason.check(defer.TimeoutError):
        raise reason  # don't process TimeoutErrors here
    handleErrorCondition()

d.addCallback(success)
d.addErrback(nonTimeoutFailure)
----

I think that's an accurate translation, anyway, your example relies a bit
too heavily on mysterious global functions to be 100% clear.

&gt;<i> For instance, someone who hadn't /read/ the code of setTimeout, would
</I>&gt;<i> most likely miss the returned IDelayedCall, and wouldn't know to cancel
</I>&gt;<i> the pending timeout call in the event of success OR other failure. This
</I>&gt;<i> is _a crucial piece of the code path_, and setTimeout makes this easier
</I>&gt;<i> to miss.
</I>
I think you misunderstand setTimeout.  You can safely ignore the
IDelayedCall it returns (and the fact it does so isn't even documented in
the docstring), and the delayed call will be cancelled for you anyway if the
deferred is called back before the timeout triggers.  setTimeout doesn't
make this easier to miss; it makes it so you don't have to worry about it at
all.

&gt;<i> As from the Zen of Python Programming:
</I>&gt;<i> 
</I>&gt;<i> - Explicit is better than implicit
</I>&gt;<i>     
</I>&gt;<i>     setTimeout hides a small piece of code that contains all of the
</I>&gt;<i>     important conceptual elements that a user is required to understand
</I>&gt;<i>     so that they may handle this side-exit condition properly.
</I>
This is true of many functions and classes, e.g. how LineReceiver's
dataReceived handler works is an excellent example of how to do a certain
task in Twisted, but the implementation is hidden from the user!  Oh, except
that they can always read the source if they want to know :)

I don't believe that convenience functions are inherently bad because they
hide things from the user (and defer.py has lots of them).  If they mean
there's one less code idiom to learn, then great.  If they mean there's a
working example for people to read, including warts that real-life imposes
that wouldn't be in an artificial example, great.

&gt;<i>     
</I>&gt;<i> - Special cases aren't special enough to break the rules
</I>&gt;<i> 
</I>&gt;<i>     Delayed calls are orthogonal to deferreds. 
</I>
This I somewhat agree with, enough that I'd be tempted to make setTimeout
live as a help function in twisted.internet.util rather than a method of
Deferred, or similar, except that it would be considerably harder and
messier to write.

&gt;<i>     Deferreds are a _reactive_ tool, they fire in response to an event
</I>&gt;<i>     
</I>&gt;<i>     delayed calls are a _proactive_ tool, they cause events to fire
</I>&gt;<i> 
</I>&gt;<i>     Mixing the two together for the special case of dealing with a
</I>&gt;<i>     timeout is at best hairy and at worst ugly and confusing.
</I>
I disagree.  The event that Deferreds react to has to come from *somewhere*.

What is problematic is that timeouts provide a *second* place that might
trigger the Deferred, in addition to whatever the usual place the creator
expects.  With setTimeout, this means that AlreadyCalledErrors can arise
from calls to d.callback/d.errback where the original author didn't expect
them, just because a user of that module is setting timeouts to Deferreds.
I thought this was the primary objection to setTimeout?  It's certainly the
biggest concern I have about it.

Ok, how about a compromise: if a creator a Deferred is able to cope with
timeouts, they should pass an &quot;allowTimeouts=True&quot; flag to the constructor.
Without it, the setTimeout method will raise an AssertionError.  (For
backwards-compatibility, for a release it will merely raise a Warning rather
than an exception).  I'm willing to implement this, and properly document
setTimeout in the Deferred HOWTO while I'm at it.  This is now my preferred
option.

&gt;<i>     Timeout conditions are _not necessarily_ something that a user needs
</I>&gt;<i>     to deal with 80% of the time they are working with deferreds. 
</I>
Great.  So they won't call setTimeout.  Why is this a problem?

&gt;<i> - Simple is better than complex
</I>&gt;<i> 
</I>&gt;<i>     The deferred api should contain absolutely necessary functionality. 
</I>&gt;<i> 
</I>&gt;<i>     Let's emulate the python language, not the python standard library
</I>
On the other hand, timeouts are often desired functionality, and they should
have a common API for people to implement them and use them.

It would be a shame if &quot;oh, I got a deferred from twisted.news, but I want
to set a timeout on it, so I do d.callback(twisted.news.magicTimeoutResult)
in a DIY delayed call... but if I get a deferred from twisted.mail I want to
set a timeout on, I do mailConnection.timeoutRequest(d), and if...&quot; etc.

Functions/methods to support timeouts are an ideal candidate for inclusion
in Twisted, if only we could agree on what functions/methods :)

&gt;<i> - There should be one, and preferrably only one way to do it
</I>&gt;<i> 
</I>&gt;<i>     It is better to have users of our API use a widely-understood and
</I>&gt;<i>     flexible idiom to accomplish this rather than a half-baked method
</I>&gt;<i>     that saves them 8 lines of easily written and conceptually crucial
</I>&gt;<i>     code
</I>
You mean error-prone, like your example ;)

&gt;<i>     I would like to recommend that we document a best-practice idiom
</I>&gt;<i>     in the deferred api documentation, and remove setTimeout.
</I>
I don't believe it's easily written until you have a pretty advanced grasp
of both Deferreds and reactor.callLater.  I don't see why allowing users of
Deferreds to just say &quot;d.setTimeout(5)&quot; is a bad thing?

setTimeout has the big big advantage that it's dead easy for *users* of
Deferreds to work with.  The trouble with it is that it requires some work
from the *creators* of Deferreds to support safely -- but I see the same
flaw in every solution proposed, including your own of documenting and
entirely by-hand idiom.

&gt;<i> - If an implementation is hard to explain it's a bad idea
</I>&gt;<i> 
</I>&gt;<i>     Explaining to users how to properly use setTimeout takes more effort
</I>&gt;<i>     than explaining to them how to use the tools that setTimeout employs
</I>&gt;<i>     to achieve its functionality.
</I>
I believe your idiom suffers from this even worse than setTimeout.

I'm happy to write some docs to support correct usage of setTimeout that
people can be referred to.

&gt;<i> spiv said: 
</I>&gt;<i> 
</I>&gt;<i> &quot;In hindsight, I should've thought harder about the implications of
</I>&gt;<i> setTimeout before I committed it... but now it's there, I don't like the
</I>&gt;<i> idea of ripping it out unless we have a clearly better solution.&quot;
</I>
I think my &quot;allowTimeouts&quot; proposal above is a clearly better solution. :)

I'm going to spend a little time pondering it, then I'll look at
implementing a patch and adding it to the bug.

&gt;<i> This is a less-than-optimal solution to an edge-case use of two
</I>&gt;<i> orthogonal parts of our API.
</I>
I disagree.

&gt;<i> It makes no sense to leave a sharp, pointy thing lying around for users
</I>&gt;<i> to hurt themselves with, and to constantly tell them &quot;DON'T USE THAT&quot;.
</I>
Agreed.  It should be properly documented at least.

-Andrew.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="040046.html">[Twisted-Python] why deferred.setTimeout is not my favorite API	method
</A></li>
	<LI>Next message (by thread): <A HREF="040067.html">[Twisted-Python] why deferred.setTimeout is not my favorite API	method
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40044">[ date ]</a>
              <a href="thread.html#40044">[ thread ]</a>
              <a href="subject.html#40044">[ subject ]</a>
              <a href="author.html#40044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
