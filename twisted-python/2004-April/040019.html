<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] New user, help needed with raw UDP packets
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20New%20user%2C%20help%20needed%20with%20raw%20UDP%20packets&In-Reply-To=%3C200404160800.25087.r.taylor%40eris.qinetiq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="040010.html">
   <LINK REL="Next"  HREF="040021.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] New user, help needed with raw UDP packets</H1>
    <B>Richard Taylor</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20New%20user%2C%20help%20needed%20with%20raw%20UDP%20packets&In-Reply-To=%3C200404160800.25087.r.taylor%40eris.qinetiq.com%3E"
       TITLE="[Twisted-Python] New user, help needed with raw UDP packets">r.taylor at eris.qinetiq.com
       </A><BR>
    <I>Fri Apr 16 01:00:18 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="040010.html">[Twisted-Python] New user, help needed with raw UDP packets
</A></li>
        <LI>Next message (by thread): <A HREF="040021.html">[Twisted-Python] New user, help needed with raw UDP packets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40019">[ date ]</a>
              <a href="thread.html#40019">[ thread ]</a>
              <a href="subject.html#40019">[ subject ]</a>
              <a href="author.html#40019">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Jp

On Thursday 15 April 2004 03:37, Jp Calderone wrote:
&gt;<i> [snip]
</I>&gt;<i>   More likely you'll want either a RawUDPProtocol subclass, or something =
</I>&gt;<i>
</I>&gt;<i> very much like one.  You'll also need to create a new transport class =
</I>&gt;<i>
</I>&gt;<i> which works on raw sockets.  
</I>
Thanks for the pointers. At least I know now that I am not just being 
stupid :-)

I have been looking at how to subclass usp.Port to get what I want but I have 
come up against a problem that looks like a show stopper to me. It does not 
look like Python's socket library supports SOCK_RAW. I may be mistaken, but I 
think that I need to put the socket into RAW mode to get the incoming headers 
and to set my own headers on the outgoing packets. Without SOCK_RAW I am 
stuffed.

My code so far looks like this:

	from twisted.internet import protocol 
	from twisted.internet import udp
	from twisted.internet import reactor

	class Echo(protocol.DatagramProtocol):
    
	    def datagramReceived(self, data, (host, port)):
	        print &quot;received %r from %s:%d&quot; % (data, host, port)


	class RawUDPPort(udp.Port):
	    &quot;&quot;&quot;Raw udp port.&quot;&quot;&quot;

	    __implements__ = udp.Port.__implements__

	    socketType = socket.SOCK_RAW # Overide socket type.


	reactor.listenWith(RawUDPPort,
	                   proto=Echo(), port=9999, reactor=reactor)
	reactor.run()

When run I get the following trace back:

	Traceback (most recent call last):
	  File &quot;./asb_proxy.py&quot;, line 45, in ?
	    proto=Echo(), port=9999, reactor=reactor)
	  File &quot;/usr/lib/python2.2/site-packages/twisted/internet/default.py&quot;, line 	
301, in listenWith
	    p.startListening()
	  File &quot;/usr/lib/python2.2/site-packages/twisted/internet/udp.py&quot;, line 83, 	
in startListening
	    self._bindSocket()
	  File &quot;/usr/lib/python2.2/site-packages/twisted/internet/udp.py&quot;, line 92, 	
in _bindSocket
	    raise error.CannotListenError, (self.interface, self.port, le)
	twisted.internet.error.CannotListenError: Couldn't listen on any:9999: (94, 
	'Socket type not supported').

I am sure this is the underlying call to socket as the following Python 
session shows:

	Python 2.2.3 (#1, Sep 15 2003, 12:38:33)
	[GCC 2.95.3 20010315 (release)] on linux2
	Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
	&gt;&gt;&gt; import socket
	&gt;&gt;&gt; s = socket.socket(socket.AF_INET, socket.SOCK_RAW)
	Traceback (most recent call last):
	  File &quot;&lt;stdin&gt;&quot;, line 1, in ?
	socket.error: (94, 'Socket type not supported')
	&gt;&gt;&gt;

I guess that I might be able to use the pcap library to access the raw socket 
but integrating that into Twisted is starting to look like a big job.

Has anyone got any ideas as to how I should approach this.

&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>   If you get it working (documented, tested,etc ;), =
</I>&gt;<i>
</I>&gt;<i> it might be nice if you could contribute it back, since raw socket =
</I>&gt;<i>
</I>&gt;<i> support is something that does get asked for every once in a while.  =
</I>&gt;<i>
</I>&gt;<i> It'd be nice to be able to tell someone how to use existing support, =
</I>&gt;<i>
</I>&gt;<i> instead of telling them they have to implement it.
</I>&gt;<i>
</I>
If I get something working I will certainly contribute it back to twisted.

Many thanks.

Richard

- -- 
QinetiQ                                  
B009 Woodward Building
St. Andrews Road
Malvern
Worcs WR14 3PS
Jabber: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">RichardTaylor at jabber.org</A>
PGPKey: <A HREF="http://search.keyserver.net:11371/pks/lookup?op=get&amp;search=0xA7DA9FD9">http://search.keyserver.net:11371/pks/lookup?op=get&amp;search=0xA7DA9FD9</A>
Key fingerprint = D051 A121 E7C3 485F 3C0E  1593 ED9E D868 A7DA 9FD9
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.2.1 (GNU/Linux)

iD8DBQFAf4SI7Z7YaKfan9kRAnBjAJoDYDWaaB3zqfrChSMIvXo901WWQwCeKt21
vKa2BRlNHXHXq92vD7xaHOc=
=POTK
-----END PGP SIGNATURE-----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="040010.html">[Twisted-Python] New user, help needed with raw UDP packets
</A></li>
	<LI>Next message (by thread): <A HREF="040021.html">[Twisted-Python] New user, help needed with raw UDP packets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#40019">[ date ]</a>
              <a href="thread.html#40019">[ thread ]</a>
              <a href="subject.html#40019">[ subject ]</a>
              <a href="author.html#40019">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
