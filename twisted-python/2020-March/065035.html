<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] IReactorTime.seconds: epoch time or no?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IReactorTime.seconds%3A%20epoch%20time%20or%20no%3F&In-Reply-To=%3C3915205.rqfhMI5Yx9%40fpbarry%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065034.html">
   <LINK REL="Next"  HREF="065036.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] IReactorTime.seconds: epoch time or no?</H1>
    <B>Barry Scott</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IReactorTime.seconds%3A%20epoch%20time%20or%20no%3F&In-Reply-To=%3C3915205.rqfhMI5Yx9%40fpbarry%3E"
       TITLE="[Twisted-Python] IReactorTime.seconds: epoch time or no?">barry.scott at forcepoint.com
       </A><BR>
    <I>Thu Mar 26 03:23:07 MDT 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065034.html">[Twisted-Python] IReactorTime.seconds: epoch time or no?
</A></li>
        <LI>Next message (by thread): <A HREF="065036.html">[Twisted-Python] IReactorTime.seconds: epoch time or no?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65035">[ date ]</a>
              <a href="thread.html#65035">[ thread ]</a>
              <a href="subject.html#65035">[ subject ]</a>
              <a href="author.html#65035">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wednesday, 25 March 2020 07:02:46 GMT Glyph wrote:
&gt;<i> &gt; On Mar 24, 2020, at 4:05 PM, Tom Most &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twm at freecog.net</A>&gt; wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'll offer a dissenting opinion:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I've worked on systems where the reactor is patched to use monotonic time.
</I>&gt;<i> &gt; (This is essential on embedded systems that lack a real-time clock.) I'm
</I>&gt;<i> &gt; not aware of this causing any issues, and it fixed real problems.
</I>&gt;<i> I am curious to know the problems that were fixed here, but, this is a
</I>&gt;<i> violation of the IReactorTime contract, implicit as it may be.
</I>&gt;<i> 
</I>&gt;<i> The reactor should have a monotonic-time interface, and maybe we should even
</I>&gt;<i> use it to implement callLater.  But .seconds() is wall-clock time.
</I>&gt;<i> &gt; HTTPFactory is quite unusual in assuming that it is epoch time. Most parts
</I>&gt;<i> &gt; of Twisted that require wall time call `time.time()` or equivalent
</I>&gt;<i> &gt; directly. IMO HTTPFactory is in error here, and this is simply a bug. We
</I>&gt;<i> &gt; should change HTTPFactory to use `time.time()` directly.
</I>&gt;<i> Nope.  This breaks a whole class of testing strategies, which are explicitly
</I>&gt;<i> documented in
</I>&gt;<i> <A HREF="https://twistedmatrix.com/documents/20.3.0/core/howto/trial.html#testing-sc">https://twistedmatrix.com/documents/20.3.0/core/howto/trial.html#testing-sc</A>
</I>&gt;<i> heduling
</I>&gt;<i> &lt;<A HREF="https://twistedmatrix.com/documents/20.3.0/core/howto/trial.html#testing-s">https://twistedmatrix.com/documents/20.3.0/core/howto/trial.html#testing-s</A>
</I>&gt;<i> cheduling&gt; .
</I>&gt;<i> 
</I>&gt;<i> However, I can definitely see the need for monotonic time.  `IReactorTimeEx`
</I>&gt;<i> should probably include methods for getting monotonic time, getting civil
</I>&gt;<i> times, scheduling callables at future civil times explicitly rather than
</I>&gt;<i> using relative timestamps, etc.  Possibly some of these should be different
</I>&gt;<i> interfaces.
</I>&gt;<i> &gt; Since the time base of IReactorTime.seconds() hasn't ever been clearly
</I>&gt;<i> &gt; defined, I think that we should really go the other way: use
</I>&gt;<i> &gt; `time.monotonic()` by default where possible. (Or, more realistically,
</I>&gt;<i> &gt; make it an option and maybe the default.)
</I>&gt;<i> Definitely not.  Huge huge swathes of Twisted code would break, not least of
</I>&gt;<i> which would be Twisted's own HTTP access logs which rely on .seconds() to
</I>&gt;<i> be wall clock.
</I>
Why does Twisted need to duplicate the built in python time features?
What was wrong with using time.time() for the access logs?

Surely reactors must be use monotonic time to avoid breaking protocol
timing across wall-clock time being adjusted by ntp etc.

Barry

&gt;<i> &gt; ---Tom
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; On Mon, Mar 23, 2020, at 1:24 PM, Amber Brown (hawkowl) wrote:
</I>&gt;<i> &gt;&gt; On 24/3/20 6:45 am, Richard van der Hoff wrote:
</I>&gt;<i> &gt;&gt;&gt; HTTPFactory seems to think that `reactor.seconds` is reliably an epoch
</I>&gt;<i> &gt;&gt;&gt; time (see
</I>&gt;<i> &gt;&gt;&gt; <A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L3">https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L3</A>
</I>&gt;<i> &gt;&gt;&gt; 110, etc).
</I>&gt;<i> &gt;&gt;&gt; 
</I>&gt;<i> &gt;&gt;&gt; On the other hand. AsyncioSelectorReactor.seconds() returns a monotonic
</I>&gt;<i> &gt;&gt;&gt; time:
</I>&gt;<i> &gt;&gt;&gt; 
</I>&gt;<i> &gt;&gt;&gt; python3 -c 'from twisted.internet import asyncioreactor;
</I>&gt;<i> &gt;&gt;&gt; print(asyncioreactor.AsyncioSelectorReactor().seconds())'
</I>&gt;<i> &gt;&gt;&gt; 41116.763594412
</I>&gt;<i> &gt;&gt;&gt; 
</I>&gt;<i> &gt;&gt;&gt; One of these is wrong... I think it's HTTPFactory making bad
</I>&gt;<i> &gt;&gt;&gt; assumptions, but can anyone confirm the intention here?
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; It's a bug in asyncioreactor. IReactorTime defines it as &quot;current time
</I>&gt;<i> &gt;&gt; in seconds&quot;, which _probably_ should be defined nicer
</I>&gt;<i> &gt;&gt; (<A HREF="https://twistedmatrix.com/documents/current/api/twisted.internet.interfa">https://twistedmatrix.com/documents/current/api/twisted.internet.interfa</A>
</I>&gt;<i> &gt;&gt; ces.IReactorTime.html#seconds) but is generally epoch time.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; asyncioreactor does have a few problems with time:
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; <A HREF="https://twistedmatrix.com/trac/ticket/9611">https://twistedmatrix.com/trac/ticket/9611</A>
</I>&gt;<i> &gt;&gt; <A HREF="https://twistedmatrix.com/trac/ticket/9780">https://twistedmatrix.com/trac/ticket/9780</A>
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; I can't find a bug for this issue, though, although I'm almost sure I've
</I>&gt;<i> &gt;&gt; seen it before... so, if you could file one (and maybe a patch to fix
</I>&gt;<i> &gt;&gt; it!) then that would be appreciated.
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; - Amber
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Twisted-Python mailing list
</I>&gt;<i> &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>



</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065034.html">[Twisted-Python] IReactorTime.seconds: epoch time or no?
</A></li>
	<LI>Next message (by thread): <A HREF="065036.html">[Twisted-Python] IReactorTime.seconds: epoch time or no?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65035">[ date ]</a>
              <a href="thread.html#65035">[ thread ]</a>
              <a href="subject.html#65035">[ subject ]</a>
              <a href="author.html#65035">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
