<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] IReactorTime.seconds: epoch time or no?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IReactorTime.seconds%3A%20epoch%20time%20or%20no%3F&In-Reply-To=%3CB6C055F3-3177-42AF-9B7F-EF1D85A1DA45%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065033.html">
   <LINK REL="Next"  HREF="065035.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] IReactorTime.seconds: epoch time or no?</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20IReactorTime.seconds%3A%20epoch%20time%20or%20no%3F&In-Reply-To=%3CB6C055F3-3177-42AF-9B7F-EF1D85A1DA45%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] IReactorTime.seconds: epoch time or no?">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Mar 25 01:02:46 MDT 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065033.html">[Twisted-Python] IReactorTime.seconds: epoch time or no?
</A></li>
        <LI>Next message (by thread): <A HREF="065035.html">[Twisted-Python] IReactorTime.seconds: epoch time or no?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65034">[ date ]</a>
              <a href="thread.html#65034">[ thread ]</a>
              <a href="subject.html#65034">[ subject ]</a>
              <a href="author.html#65034">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On Mar 24, 2020, at 4:05 PM, Tom Most &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twm at freecog.net</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> I'll offer a dissenting opinion:
</I>&gt;<i> 
</I>&gt;<i> I've worked on systems where the reactor is patched to use monotonic time. (This is essential on embedded systems that lack a real-time clock.) I'm not aware of this causing any issues, and it fixed real problems.
</I>
I am curious to know the problems that were fixed here, but, this is a violation of the IReactorTime contract, implicit as it may be.

The reactor should have a monotonic-time interface, and maybe we should even use it to implement callLater.  But .seconds() is wall-clock time.

&gt;<i> HTTPFactory is quite unusual in assuming that it is epoch time. Most parts of Twisted that require wall time call `time.time()` or equivalent directly. IMO HTTPFactory is in error here, and this is simply a bug. We should change HTTPFactory to use `time.time()` directly.
</I>
Nope.  This breaks a whole class of testing strategies, which are explicitly documented in <A HREF="https://twistedmatrix.com/documents/20.3.0/core/howto/trial.html#testing-scheduling">https://twistedmatrix.com/documents/20.3.0/core/howto/trial.html#testing-scheduling</A> &lt;<A HREF="https://twistedmatrix.com/documents/20.3.0/core/howto/trial.html#testing-scheduling">https://twistedmatrix.com/documents/20.3.0/core/howto/trial.html#testing-scheduling</A>&gt; .

However, I can definitely see the need for monotonic time.  `IReactorTimeEx` should probably include methods for getting monotonic time, getting civil times, scheduling callables at future civil times explicitly rather than using relative timestamps, etc.  Possibly some of these should be different interfaces.

&gt;<i> Since the time base of IReactorTime.seconds() hasn't ever been clearly defined, I think that we should really go the other way: use `time.monotonic()` by default where possible. (Or, more realistically, make it an option and maybe the default.)
</I>
Definitely not.  Huge huge swathes of Twisted code would break, not least of which would be Twisted's own HTTP access logs which rely on .seconds() to be wall clock.

&gt;<i> ---Tom
</I>&gt;<i> 
</I>&gt;<i> On Mon, Mar 23, 2020, at 1:24 PM, Amber Brown (hawkowl) wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On 24/3/20 6:45 am, Richard van der Hoff wrote:
</I>&gt;&gt;&gt;<i> HTTPFactory seems to think that `reactor.seconds` is reliably an epoch 
</I>&gt;&gt;&gt;<i> time (see 
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L3110,">https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L3110,</A> 
</I>&gt;&gt;&gt;<i> etc).
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> On the other hand. AsyncioSelectorReactor.seconds() returns a monotonic 
</I>&gt;&gt;&gt;<i> time:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> python3 -c 'from twisted.internet import asyncioreactor; 
</I>&gt;&gt;&gt;<i> print(asyncioreactor.AsyncioSelectorReactor().seconds())'
</I>&gt;&gt;&gt;<i> 41116.763594412
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> One of these is wrong... I think it's HTTPFactory making bad 
</I>&gt;&gt;&gt;<i> assumptions, but can anyone confirm the intention here?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> It's a bug in asyncioreactor. IReactorTime defines it as &quot;current time 
</I>&gt;&gt;<i> in seconds&quot;, which _probably_ should be defined nicer 
</I>&gt;&gt;<i> (<A HREF="https://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.IReactorTime.html#seconds">https://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.IReactorTime.html#seconds</A>) 
</I>&gt;&gt;<i> but is generally epoch time.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> asyncioreactor does have a few problems with time:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/trac/ticket/9611">https://twistedmatrix.com/trac/ticket/9611</A>
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/trac/ticket/9780">https://twistedmatrix.com/trac/ticket/9780</A>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I can't find a bug for this issue, though, although I'm almost sure I've 
</I>&gt;&gt;<i> seen it before... so, if you could file one (and maybe a patch to fix 
</I>&gt;&gt;<i> it!) then that would be appreciated.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> - Amber
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20200325/e48cdff5/attachment.htm&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065033.html">[Twisted-Python] IReactorTime.seconds: epoch time or no?
</A></li>
	<LI>Next message (by thread): <A HREF="065035.html">[Twisted-Python] IReactorTime.seconds: epoch time or no?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65034">[ date ]</a>
              <a href="thread.html#65034">[ thread ]</a>
              <a href="subject.html#65034">[ subject ]</a>
              <a href="author.html#65034">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
