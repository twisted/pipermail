<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python]  How to get the client ip when it ask a resolution with twisted.names
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%0A%20%3D%3Futf-8%3Fq%3FHow_to_get_the_client_ip_when_it_ask_%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fa_resolution_with_twisted%3D2Enames%3F%3D&In-Reply-To=%3C7029-608e4d00-a5-79ec3680%40231407499%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065608.html">
   <LINK REL="Next"  HREF="065607.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python]  How to get the client ip when it ask a resolution with twisted.names</H1>
    <B>contact at benoit-laviale.fr</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%0A%20%3D%3Futf-8%3Fq%3FHow_to_get_the_client_ip_when_it_ask_%3F%3D%0A%20%3D%3Futf-8%3Fq%3Fa_resolution_with_twisted%3D2Enames%3F%3D&In-Reply-To=%3C7029-608e4d00-a5-79ec3680%40231407499%3E"
       TITLE="[Twisted-Python]  How to get the client ip when it ask a resolution with twisted.names">contact at benoit-laviale.fr
       </A><BR>
    <I>Sun May  2 00:56:46 MDT 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065608.html">[Twisted-Python] How to get the client ip when it ask a resolution with twisted.names
</A></li>
        <LI>Next message (by thread): <A HREF="065607.html">[Twisted-Python] Does anyone know why trunk is failing CI on PyPy 7.3.4?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65610">[ date ]</a>
              <a href="thread.html#65610">[ thread ]</a>
              <a href="subject.html#65610">[ subject ]</a>
              <a href="author.html#65610">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi Adi, all,
First, thx for your reply.
I think your solution may not be the good one, but for sure, you put me on the good track, so thx a lot.

What I currently did :
I did an inheritance of DNSServerFactory to be able to add the &quot;address&quot; propertie on my query object.
It looks like that :

class DNSServerFactory2(server.DNSServerFactory):

   def handleQuery(self, message, protocol, address):
        query = message.queries[0]
        query.address = address
        message.queries[0] = query
        from pprint import pprint
        pprint(vars(message.queries[0]))
        return super().handleQuery(message, protocol, address) # @  this point the resolver is called in the DNSServerFactory.

In the log i have that :
2021-05-02 08:47:58+0200 [-] {'address': ('127.0.0.1', 60750),
2021-05-02 08:47:58+0200 [-]  'cls': 1,
2021-05-02 08:47:58+0200 [-]  'name': &lt;twisted.names.dns.Name object at 0x13c8e38b0&gt;,
2021-05-02 08:47:58+0200 [-]  'type': 1}
So the propertie looks added...

But after that, I am going to the resolver and at that moment, the address propertie is missing...?!

def query(self, query, timeout=None):
        from pprint import pprint
        pprint(vars(query))

in the logs :
2021-05-02 08:47:58+0200 [-] {'cls': 1, 'name': &lt;twisted.names.dns.Name object at 0x13c8e3880&gt;, 't
ype': 1}
So there is no anymore the address propertie that i have added just before...

What am i missing?

Thx

Benoît

Le Samedi, Mai 01, 2021 11:18 CEST, Adi Roiban &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A>&gt; a écrit:
 Hi On Sat, 1 May 2021 at 07:43, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">contact at benoit-laviale.fr</A> &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">contact at benoit-laviale.fr</A>&gt; wrote:Dear all,

I am working on twisted names since some days to make kind of filtering system (with domains blacklists).
So I made my own resolver that can reply defer.fail(error.DomainError()) to send the query to the next resolver (and in this case, it will be resolve) or defer.fail(dns.AuthoritativeDomainError(query.name.name)) to reply NXDOMAIN that can &quot;block&quot; the domain to the final client.    

That part is working well.

Next, i would like to &quot;block&quot; the resolution regarding the device (Mac address/IP/???).

I would like something like that :

if self.query.meta.client.ip == b&quot;192.168.0.5&quot; or self.query.meta.client.mac == &quot;XX:YY:ZZ:....&quot;:
         self.do_something()

My use case is that device of Kelly, (Kelly is a teenager of 12 years) cant use youtube.com at all, but other devices are allowed to get the resolution.
How can I get the IP/Name/mac (an identifier) of the device that's querying my custom dns?
I read something about datagrams, but in my case i think i must get this information in my resolver...

Thx and cheers. I think you are using DNS over UDP... so to understand how UDP works with Twisted you can check this <A HREF="pagehttps://twistedmatrix.com/documents/current/core/howto/udp.html&#194;&#160;&#194;&#160;I">pagehttps://twistedmatrix.com/documents/current/core/howto/udp.html  I</A> have never used Twisted names so I am just trying to help based on my general knowledge of Twisted design... but I think the entry point is here <A HREF="https://github.com/twisted/twisted/blob/63649469c1fe46d8a713e8034239ac3cc0498ea7/src/twisted/names/dns.py#L3242&#194;&#160;then">https://github.com/twisted/twisted/blob/63649469c1fe46d8a713e8034239ac3cc0498ea7/src/twisted/names/dns.py#L3242 then</A> it goes to here <A HREF="https://github.com/twisted/twisted/blob/63649469c1fe46d8a713e8034239ac3cc0498ea7/src/twisted/names/server.py#L538&#194;&#160;and">https://github.com/twisted/twisted/blob/63649469c1fe46d8a713e8034239ac3cc0498ea7/src/twisted/names/server.py#L538 and</A> then in handleQuery where I see that the  query is done without the `address`...but the address is available again in`gotResolverResponse`.. so maybe that help ------- Hope it helps Cheers --Adi Roiban


 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20210502/6fd8610d/attachment.htm&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065608.html">[Twisted-Python] How to get the client ip when it ask a resolution with twisted.names
</A></li>
	<LI>Next message (by thread): <A HREF="065607.html">[Twisted-Python] Does anyone know why trunk is failing CI on PyPy 7.3.4?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65610">[ date ]</a>
              <a href="thread.html#65610">[ thread ]</a>
              <a href="subject.html#65610">[ subject ]</a>
              <a href="author.html#65610">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
