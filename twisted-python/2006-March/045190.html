<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] waitForDeferred Question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20waitForDeferred%20Question&In-Reply-To=%3C20060311194421.6122.644459607.divmod.quotient.15047%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="045185.html">
   <LINK REL="Next"  HREF="045182.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] waitForDeferred Question</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20waitForDeferred%20Question&In-Reply-To=%3C20060311194421.6122.644459607.divmod.quotient.15047%40ohm%3E"
       TITLE="[Twisted-Python] waitForDeferred Question">exarkun at divmod.com
       </A><BR>
    <I>Sat Mar 11 12:44:21 MST 2006</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="045185.html">[Twisted-Python] waitForDeferred Question
</A></li>
        <LI>Next message (by thread): <A HREF="045182.html">[Twisted-Python] waitForDeferred Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#45190">[ date ]</a>
              <a href="thread.html#45190">[ thread ]</a>
              <a href="subject.html#45190">[ subject ]</a>
              <a href="author.html#45190">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sat, 11 Mar 2006 10:10:38 -0800, Brian Granger &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bgranger at scu.edu</A>&gt; wrote:
&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>The problem is that the user will want to do:
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> result = computeSomething()
</I>&gt;<i>
</I>&gt;<i>OR
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> result = 2.0*computeOneThing()*math.sin(computeAnother())
</I>&gt;<i>
</I>&gt;<i>What should happen in these cases?  Ideally, the _entire_ command
</I>&gt;<i>should become a &quot;job&quot; that evaluates in a &quot;smart&quot; manner.  That is,
</I>&gt;<i>the final result shouldn't be computed until all other results are
</I>&gt;<i>available.  Meanwhile, the prompt should retrn to the user so they can
</I>&gt;<i>continue working.  But, I don't think this is possible w/o making
</I>&gt;<i>changes to CPython itself.  The alternative is to simply make each
</I>&gt;<i>command appear to block.
</I>
The difficulty you are encountering is that you want to use a language which is very much like Python as the input for your command shell, but which is not quite Python.  If you look at it this way, it should be clear that simply evaluating the input as Python will never give you a satisfactory solution.

One approach you might take, instead, is to parse the input using the compiler module, rewrite the AST so as to account for a Deferred at every step of the evaluation of the expression, and then compile the result into bytecode and execute that.

Taking your example:

    result = 2.0 * computeOneThing() * math.sin(computeAnother())

You would want to rewrite this to:

    _d1 = defer.maybeDeferred(computeAnother)
    _d1.addCallback(lambda result: math.sin(result))
    _d2 = defer.maybeDeferred(computeOneThing)
    _d2.addCallback(lambda result: result * 2.0)
    _d3 = defer.gatherResults([_d1, _d2])
    _d3.addCallback(lambda (left, right): left * right)
    _d3.addCallback(lambda result: assign(&quot;result&quot;, result))
    _d3.addCallback(lambda ign: continueREPL())

As you can see, this is a fairly simple mechanical transformation.  In addition to the steps I've taken above, you may also want to serialize the operations, in case allowing computeOneThing() and computeAnother() to run in parallel would be surprising to your users.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="045185.html">[Twisted-Python] waitForDeferred Question
</A></li>
	<LI>Next message (by thread): <A HREF="045182.html">[Twisted-Python] waitForDeferred Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#45190">[ date ]</a>
              <a href="thread.html#45190">[ thread ]</a>
              <a href="subject.html#45190">[ subject ]</a>
              <a href="author.html#45190">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
