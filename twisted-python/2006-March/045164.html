<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Degrading under load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Degrading%20under%20load&In-Reply-To=%3C2608b8a80603091602s4d80e7a5rf6120ae670bd79b3%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="045285.html">
   <LINK REL="Next"  HREF="045171.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Degrading under load</H1>
    <B>Yitzchak Gale</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Degrading%20under%20load&In-Reply-To=%3C2608b8a80603091602s4d80e7a5rf6120ae670bd79b3%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Degrading under load">gale at sefer.org
       </A><BR>
    <I>Thu Mar  9 17:02:55 MST 2006</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="045285.html">[Twisted-Python] Twisted on a USB stick?
</A></li>
        <LI>Next message (by thread): <A HREF="045171.html">[Twisted-Python] Degrading under load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#45164">[ date ]</a>
              <a href="thread.html#45164">[ thread ]</a>
              <a href="subject.html#45164">[ subject ]</a>
              <a href="author.html#45164">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alec,

Thanks for the great information!

Our situation is a bit different in that we will
not be keeping connections open for more
than a few seconds at a time (I hope).
So even at peak expected load, we shouldn't
ever have as many as 100 sockets open at any
given time.

Also, we will be load balancing at least two
boxes, for hardware redundancy. So we could
always throw in an extra box or two if things heat
up.

But I think I'll go with B anyway. It is neater in
that it separates performance under load
from the architechture of the high-level processing.
With A, we will always have to worry about
dividing the XML stuff into small enough pieces
to let the event loop in often enough.

Your platform comparisons will be very helpful.

-Yitz

On 3/9/06, Alec (Chatango) &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at chatango.com</A>&gt; wrote:
&gt;<i> Hi Yitzchak,
</I>&gt;<i>
</I>&gt;<i> I can give you some information regarding option A.
</I>&gt;<i> We are running our chatserver using twisted. When we run twisted as a single
</I>&gt;<i> process, when the number of connections per second is more than 50 (&gt; 3000
</I>&gt;<i> per min), twisted often blocks and does not accept new connections. The CPU
</I>&gt;<i> load showed by &quot;top&quot; for twisted process is 99.9%
</I>&gt;<i> This behavior is on linux 2.6 on a 64 bit 4 CPU machine.
</I>&gt;<i> On 2.4 kernel on a 32 bit 4 CPU machine however, it always accepted new
</I>&gt;<i> connections, even with 99.9% load, but then they would often time out, since
</I>&gt;<i> under that load no data was written into them for a long time. This was with
</I>&gt;<i> Twisted 1.3
</I>&gt;<i>
</I>&gt;<i> I should add here that in our case, the load was driven not by
</I>&gt;<i> connection/disconnection events, but by the number of established
</I>&gt;<i> connections. When that number was in the vicinity of 5000, system poll()
</I>&gt;<i> became very slow (we run poll reactor).
</I>&gt;<i>
</I>&gt;<i> Another observation: we had a memory leak, so when the RSS memory grew say
</I>&gt;<i> 3x the starting memory, the performance severely degraded. I should note
</I>&gt;<i> that the machine was not running out of memory: we have 4GB RAM, and the
</I>&gt;<i> total used memory was at most 400MB, with twistd process using maybe 160MB
</I>&gt;<i> at the most.
</I>&gt;<i>
</I>&gt;<i> We are now moving to Twisted 2.2 and multiprocess architecture, somewhat
</I>&gt;<i> similar to your B option.
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>
</I>&gt;<i> [mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] On Behalf Of Yitzchak Gale
</I>&gt;<i> Sent: Thursday, March 09, 2006 1:13 PM
</I>&gt;<i> To: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>
</I>&gt;<i> Subject: Re: [Twisted-Python] Degrading under load
</I>&gt;<i>
</I>&gt;<i> Sorry, I guess my question wasn't clear enough.
</I>&gt;<i>
</I>&gt;<i> The most important things I need to know are:
</I>&gt;<i>
</I>&gt;<i> When running listenTCP, how often does twisted
</I>&gt;<i> accept pending connections on the port? Is it only
</I>&gt;<i> when the previous connection is finished
</I>&gt;<i> processing, or every time the event loop gets
</I>&gt;<i> control, or something in between?
</I>&gt;<i>
</I>&gt;<i> And when twisted does accept pending connections,
</I>&gt;<i> does it accept ALL of them and queue them all for
</I>&gt;<i> processing, or just one at a time?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Yitz
</I>&gt;<i>
</I>&gt;<i> My original post:
</I>&gt;<i> &gt; I need to set up a TCP service (on a linux box)
</I>&gt;<i> &gt; that will get something like a few hunderd connections
</I>&gt;<i> &gt; per minute at peak load. For each connection, I do
</I>&gt;<i> &gt; some XML processing, and possibly send a query
</I>&gt;<i> &gt; to another nearby machine and get a respone.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Seems to me that twisted should be able to handle that.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But what happens when I get the occasional burst
</I>&gt;<i> &gt; of connections, lets say tens of connections within
</I>&gt;<i> &gt; one second? What I need is:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; o Every client gets a socket connection promptly, so
</I>&gt;<i> &gt;  no danger of TCP timeout.
</I>&gt;<i> &gt; o Under medium load, clients will have to wait a
</I>&gt;<i> &gt;  bit longer for the response.
</I>&gt;<i> &gt; o Under heavy load, some clients will get a &quot;busy&quot;
</I>&gt;<i> &gt;  response (defined in the protocol I am implementing)
</I>&gt;<i> &gt;  and immediate socket close.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; What is the best way to do that in twisted? I envision
</I>&gt;<i> &gt; one of the following architectures:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; A. Just use twisted in the usual way. Watch twisted's
</I>&gt;<i> &gt; event queue for heavy load.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; B. Two processes: one to dish out connections and one
</I>&gt;<i> &gt; to queue requests and process them.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; C. Three processes: one to dish out connections, one
</I>&gt;<i> &gt; to queue requests and watch for load, and one to
</I>&gt;<i> &gt; process the requests.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Which of these do I need to use to get the desired
</I>&gt;<i> &gt; effect under load? Or is there some better way?
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="045285.html">[Twisted-Python] Twisted on a USB stick?
</A></li>
	<LI>Next message (by thread): <A HREF="045171.html">[Twisted-Python] Degrading under load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#45164">[ date ]</a>
              <a href="thread.html#45164">[ thread ]</a>
              <a href="subject.html#45164">[ subject ]</a>
              <a href="author.html#45164">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
