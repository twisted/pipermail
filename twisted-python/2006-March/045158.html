<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Degrading under load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Degrading%20under%20load&In-Reply-To=%3CE1FHT10-0001ZK-00%40pyramid.twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="045192.html">
   <LINK REL="Next"  HREF="045159.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Degrading under load</H1>
    <B>Alec (Chatango)</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Degrading%20under%20load&In-Reply-To=%3CE1FHT10-0001ZK-00%40pyramid.twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Degrading under load">alecm at chatango.com
       </A><BR>
    <I>Thu Mar  9 14:49:22 MST 2006</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="045192.html">[Twisted-Python] Degrading under load
</A></li>
        <LI>Next message (by thread): <A HREF="045159.html">[Twisted-Python] Degrading under load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#45158">[ date ]</a>
              <a href="thread.html#45158">[ thread ]</a>
              <a href="subject.html#45158">[ subject ]</a>
              <a href="author.html#45158">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Yitzchak,

I can give you some information regarding option A.
We are running our chatserver using twisted. When we run twisted as a single
process, when the number of connections per second is more than 50 (&gt; 3000
per min), twisted often blocks and does not accept new connections. The CPU
load showed by &quot;top&quot; for twisted process is 99.9% 
This behavior is on linux 2.6 on a 64 bit 4 CPU machine.
On 2.4 kernel on a 32 bit 4 CPU machine however, it always accepted new
connections, even with 99.9% load, but then they would often time out, since
under that load no data was written into them for a long time. This was with
Twisted 1.3

I should add here that in our case, the load was driven not by
connection/disconnection events, but by the number of established
connections. When that number was in the vicinity of 5000, system poll()
became very slow (we run poll reactor).

Another observation: we had a memory leak, so when the RSS memory grew say
3x the starting memory, the performance severely degraded. I should note
that the machine was not running out of memory: we have 4GB RAM, and the
total used memory was at most 400MB, with twistd process using maybe 160MB
at the most.

We are now moving to Twisted 2.2 and multiprocess architecture, somewhat
similar to your B option. 

-----Original Message-----
From: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>
[mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] On Behalf Of Yitzchak Gale
Sent: Thursday, March 09, 2006 1:13 PM
To: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>
Subject: Re: [Twisted-Python] Degrading under load

Sorry, I guess my question wasn't clear enough.

The most important things I need to know are:

When running listenTCP, how often does twisted
accept pending connections on the port? Is it only
when the previous connection is finished
processing, or every time the event loop gets
control, or something in between?

And when twisted does accept pending connections,
does it accept ALL of them and queue them all for
processing, or just one at a time?

Thanks,
Yitz

My original post:
&gt;<i> I need to set up a TCP service (on a linux box)
</I>&gt;<i> that will get something like a few hunderd connections
</I>&gt;<i> per minute at peak load. For each connection, I do
</I>&gt;<i> some XML processing, and possibly send a query
</I>&gt;<i> to another nearby machine and get a respone.
</I>&gt;<i>
</I>&gt;<i> Seems to me that twisted should be able to handle that.
</I>&gt;<i>
</I>&gt;<i> But what happens when I get the occasional burst
</I>&gt;<i> of connections, lets say tens of connections within
</I>&gt;<i> one second? What I need is:
</I>&gt;<i>
</I>&gt;<i> o Every client gets a socket connection promptly, so
</I>&gt;<i>  no danger of TCP timeout.
</I>&gt;<i> o Under medium load, clients will have to wait a
</I>&gt;<i>  bit longer for the response.
</I>&gt;<i> o Under heavy load, some clients will get a &quot;busy&quot;
</I>&gt;<i>  response (defined in the protocol I am implementing)
</I>&gt;<i>  and immediate socket close.
</I>&gt;<i>
</I>&gt;<i> What is the best way to do that in twisted? I envision
</I>&gt;<i> one of the following architectures:
</I>&gt;<i>
</I>&gt;<i> A. Just use twisted in the usual way. Watch twisted's
</I>&gt;<i> event queue for heavy load.
</I>&gt;<i>
</I>&gt;<i> B. Two processes: one to dish out connections and one
</I>&gt;<i> to queue requests and process them.
</I>&gt;<i>
</I>&gt;<i> C. Three processes: one to dish out connections, one
</I>&gt;<i> to queue requests and watch for load, and one to
</I>&gt;<i> process the requests.
</I>&gt;<i>
</I>&gt;<i> Which of these do I need to use to get the desired
</I>&gt;<i> effect under load? Or is there some better way?
</I>
_______________________________________________
Twisted-Python mailing list
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="045192.html">[Twisted-Python] Degrading under load
</A></li>
	<LI>Next message (by thread): <A HREF="045159.html">[Twisted-Python] Degrading under load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#45158">[ date ]</a>
              <a href="thread.html#45158">[ thread ]</a>
              <a href="subject.html#45158">[ subject ]</a>
              <a href="author.html#45158">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
