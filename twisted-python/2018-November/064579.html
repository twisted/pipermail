<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] &quot;disconnecting properly&quot; in tests still hangs on macOS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%22disconnecting%20properly%22%20in%20tests%20still%20hangs%0A%20on%20macOS&In-Reply-To=%3CCAEeXt4N6whe_mXc6W19HptqH1BxtgeSfJJd0W%3DVhHRU81Zsu0w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032117.html">
   <LINK REL="Next"  HREF="064580.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] &quot;disconnecting properly&quot; in tests still hangs on macOS</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20%22disconnecting%20properly%22%20in%20tests%20still%20hangs%0A%20on%20macOS&In-Reply-To=%3CCAEeXt4N6whe_mXc6W19HptqH1BxtgeSfJJd0W%3DVhHRU81Zsu0w%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] &quot;disconnecting properly&quot; in tests still hangs on macOS">exarkun at twistedmatrix.com
       </A><BR>
    <I>Wed Nov 14 06:40:00 MST 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032117.html">[Twisted-Python] &quot;disconnecting properly&quot; in tests still hangs on macOS
</A></li>
        <LI>Next message (by thread): <A HREF="064580.html">[Twisted-Python] &quot;disconnecting properly&quot; in tests still hangs on macOS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64579">[ date ]</a>
              <a href="thread.html#64579">[ thread ]</a>
              <a href="subject.html#64579">[ subject ]</a>
              <a href="author.html#64579">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Nov 14, 2018 at 3:50 AM Chris Withers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris at withers.org</A>&gt; wrote:

&gt;<i> Right, so, I've been trying to get the technique in
</I>&gt;<i> <A HREF="https://jml.io/pages/how-to-disconnect-in-twisted-really.html">https://jml.io/pages/how-to-disconnect-in-twisted-really.html</A> to work
</I>&gt;<i> for me.
</I>&gt;<i>
</I>&gt;<i> No hating please, most of my testing in the past has involved hitting a
</I>&gt;<i> relational database, so there's already a TCP connection flying around,
</I>&gt;<i> one more won't make any difference.
</I>&gt;<i>
</I>&gt;<i> jml's example, exactly as-is on that page, hangs around 30-40% of the
</I>&gt;<i> time when running on my macOS laptop. From changing the teardown to look
</I>&gt;<i> like this:
</I>&gt;<i>
</I>&gt;<i>      def tearDown(self):
</I>&gt;<i>          ds = defer.maybeDeferred(self.serverPort.stopListening)
</I>&gt;<i>          dc = defer.maybeDeferred(self.clientConnection.disconnect)
</I>&gt;<i>          print()
</I>&gt;<i>
</I>&gt;<i>          ds.addCallback(lambda _: print('serverPort.stopListening'))
</I>&gt;<i>          dc.addCallback(lambda _:
</I>&gt;<i> print('self.clientConnection.disconnect'))
</I>&gt;<i>          self.clientDisconnected.addCallback(lambda _:
</I>&gt;<i> print('self.clientDisconnected'))
</I>&gt;<i>          self.serverDisconnected.addCallback(lambda _:
</I>&gt;<i> print('self.serverDisconnected'))
</I>&gt;<i>          self.serverDisconnected.addErrback(lambda _:
</I>&gt;<i> print('self.serverDisconnected:', _))
</I>&gt;<i>          return defer.gatherResults([ds, dc, self.clientDisconnected,
</I>&gt;<i> self.serverDisconnected])
</I>&gt;<i>
</I>&gt;<i> ...it appears that it's the serverDisconnected deferred that's failing
</I>&gt;<i> to fire. I can't reproduce this on Linux as of yet, so I'm guessing this
</I>&gt;<i> is a difference between the SelectReactor used on macOS and the
</I>&gt;<i> EPollReactor used on Linux.
</I>&gt;<i>
</I>&gt;<i> What's the best way to go about debugging a non-firing deferred like this?
</I>&gt;<i>
</I>
Track it backwards towards the earliest/lowest possible source of the
event.  You've already started this: you noticed that the result of
`gatherResults` doesn't fire and you investigate somehow and learned that
this is because `serverDisconnected` didn't fire.  Now keep going.  Why
didn't `serverDisconnected` fire?  It looks like it should be fired by
`ServerProtocol.connectionLost`.  Does that method ever get called?  If so,
you've now identified the break in the chain and you just have to figure
out why `connectionLost` doesn't manage to make `serverDisconnected` fire.
If not, keep going.  What code calls `ServerProtocol.connectionLost` - does
that run, etc.  Repeat until you find the break.


&gt;<i>
</I>&gt;<i> Anyone know what this might be?
</I>&gt;<i>
</I>
I know that macOS often delivers events in a different order compared to
Linux.  This has sometimes caused problems, particularly in the test
suite.  I can't quite see how that would explain this behavior though so
maybe it's something else.  It might be useful to share your version of
Python, Twisted, macOS, and the reactor you're using, in case anyone wants
to try to replicate.

Jean-Paul


&gt;<i>
</I>&gt;<i> cheers,
</I>&gt;<i>
</I>&gt;<i> Chris
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20181114/d1f96ee0/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032117.html">[Twisted-Python] &quot;disconnecting properly&quot; in tests still hangs on macOS
</A></li>
	<LI>Next message (by thread): <A HREF="064580.html">[Twisted-Python] &quot;disconnecting properly&quot; in tests still hangs on macOS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64579">[ date ]</a>
              <a href="thread.html#64579">[ thread ]</a>
              <a href="subject.html#64579">[ subject ]</a>
              <a href="author.html#64579">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
