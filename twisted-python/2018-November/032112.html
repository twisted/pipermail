<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] probably stupid question about automated testing and reactor.run
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20probably%20stupid%20question%20about%20automated%0A%20testing%20and%20reactor.run&In-Reply-To=%3CCAEeXt4MeEumbdLVJPALVDLdgAUnXUe%3DpZ2CaNDFc48drWoB2bA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032111.html">
   <LINK REL="Next"  HREF="032115.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] probably stupid question about automated testing and reactor.run</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20probably%20stupid%20question%20about%20automated%0A%20testing%20and%20reactor.run&In-Reply-To=%3CCAEeXt4MeEumbdLVJPALVDLdgAUnXUe%3DpZ2CaNDFc48drWoB2bA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] probably stupid question about automated testing and reactor.run">exarkun at twistedmatrix.com
       </A><BR>
    <I>Wed Nov  7 10:37:38 MST 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032111.html">[Twisted-Python] probably stupid question about automated testing and reactor.run
</A></li>
        <LI>Next message (by thread): <A HREF="032115.html">[Twisted-Python] pytest-twisted questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32112">[ date ]</a>
              <a href="thread.html#32112">[ thread ]</a>
              <a href="subject.html#32112">[ subject ]</a>
              <a href="author.html#32112">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>`reactor` is global mutable state.  So all of the usual tragedies of such a
thing apply when you consider how unit tests will interact with it.

Twisted has some APIs that will jump through some hoops for you to try to
mitigate the damage done by this early design mistake.  For example,
there's a context manager that will swap out the current reactor with a new
object specified by you.  *If* the code under test doesn't import the
reactor until it is invoked, this can help (this is just one reason a lot
of modern Twisted code avoids importing the reactor until it absolutely
needs it - of course, another thing modern Twisted code often does is
accept the reactor as an argument instead of importing it and if you do
this then you can escape some of the &quot;global&quot; part of the problem).

But you still may not want to have `reactor.run` in your application code.
There are other problems - such as the fact that it's common for the
*failure* mode of tests for such code to be to hang indefinitely.  Or for
test failures to be obscure in other ways due to the fact that you're
invoking pretty much your *whole* stack at once - not so much a &quot;unit&quot; test
- and so finding the cause of the problem is a challenge. Or for tests to
work on one run but fail on another due to non-determinism in event
delivery/dispatch.  Or for tests to work on one platform but fail on
another for similar reasons.

So, think about the goals you have for the tests you want to write.  You
may indeed want *some* tests for reactor.run-calling code but my guess is
that you want the majority to be for &quot;pure&quot; (in the functional sense) code
that stays pretty far from the reactor.  Of course, if you're using a
Twisted-based library that hasn't thought out the testing story for
application code, you may have some roadblocks in your way.

Personally, the most recent Twisted-using application I wrote, I factored
all of my &quot;start up Twisted and configure the process and such&quot; code into
one re-usable component and manually verified it works, then wrote
automated tests (mostly unit) for everything *else*.  In some ways, this is
what `IService` gives you, though if you find yourself wanting to go beyond
what it offers you may have to write something like what I did.

Finally, Twisted has a bunch of blackbox tests *for reactor
implementations* which
essentially must call reactor.run.  It's not clear how applicable the
strategies used by these tests might be to tests for application code
(rather than reactor implementation code) but it might be worth looking
at.  These tests are mostly in twisted/internet/test/ - eg test_tcp.py in
that directory.

Jean-Paul

On Wed, Nov 7, 2018 at 11:14 AM Chris Withers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris at withers.org</A>&gt; wrote:

&gt;<i> Hi All,
</I>&gt;<i>
</I>&gt;<i> Sorry, the silly questions about testing keep coming...
</I>&gt;<i>
</I>&gt;<i> Is it legit for a unit testable piece of an application's code to call
</I>&gt;<i> reactor.run()?
</I>&gt;<i>
</I>&gt;<i> How do you feed a reactor.stop() into such a test? Would that be a sane
</I>&gt;<i> thing to try and do?
</I>&gt;<i>
</I>&gt;<i> How do people deal with this kind of testing?
</I>&gt;<i>
</I>&gt;<i> cheers,
</I>&gt;<i>
</I>&gt;<i> Chris
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20181107/9363059c/attachment.html&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032111.html">[Twisted-Python] probably stupid question about automated testing and reactor.run
</A></li>
	<LI>Next message (by thread): <A HREF="032115.html">[Twisted-Python] pytest-twisted questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32112">[ date ]</a>
              <a href="thread.html#32112">[ thread ]</a>
              <a href="subject.html#32112">[ subject ]</a>
              <a href="author.html#32112">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
