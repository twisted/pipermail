<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] profiling twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20profiling%20twisted&In-Reply-To=468274E7.4070301%40bluegap.ch">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015634.html">
   <LINK REL="Next"  HREF="015638.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] profiling twisted</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20profiling%20twisted&In-Reply-To=468274E7.4070301%40bluegap.ch"
       TITLE="[Twisted-Python] profiling twisted">glyph at divmod.com
       </A><BR>
    <I>Wed Jun 27 12:32:12 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015634.html">[Twisted-Python] profiling twisted
</A></li>
        <LI>Next message: <A HREF="015638.html">[Twisted-Python] profiling twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15637">[ date ]</a>
              <a href="thread.html#15637">[ thread ]</a>
              <a href="subject.html#15637">[ subject ]</a>
              <a href="author.html#15637">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02:32 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">markus at bluegap.ch</A> wrote:
&gt;<i>Requests per second:    494.40 [#/sec] (mean)
</I>
&gt;<i>Now, measured while the server is under very small load:
</I>
&gt;<i>Requests per second:    24.37 [#/sec] (mean)
</I>
&gt;<i>When putting the server under real load, those response times climb up 
</I>&gt;<i>to
</I>
What is 'real load'?  Are you talking about things in process with, but 
not related to, the web server?
&gt;<i>two seconds, so there must be something wrong.
</I>
Maybe your server is slow? :)
&gt;<i>Can I somehow get the reactor's state, i.e. how many deferreds are 
</I>&gt;<i>waiting in the queue, how many threads are running concurrently, etc?
</I>
There is no queue of Deferreds.  They don't actually have anything to do 
with the reactor.
&gt;<i>How good is the idea of deferring File I/O to threads, i.e. 
</I>&gt;<i>threads.deferToThread(self.filehandle.write, data)?
</I>
If you do indeed discover that you are waiting a long time to write your 
particular stuff to files, then that might help.  It might also randomly 
interleave the data and corrupt your files, if 'data' is big enough.
&gt;<i>Another possibly blocking module might be the database api, but I'm 
</I>&gt;<i>using twisted's enterprise adbapi, which should be async, AFAICT.
</I>
It does the operations in threads, yes.  However, the threadpool will 
eventually fill up; the concurrency is fairly limited.  (The default is 
10 or so workers, I think).
&gt;<i>Maybe copying data around takes time. I'm sending around chunks of 64k 
</I>&gt;<i>size (streaming from the database to an external programm). Reducing 
</I>&gt;<i>chunk size to 1k helps somewhat (i.e. response time is seldom over 
</I>&gt;<i>150ms, but can still climb up to &gt; 0.5 seconds).
</I>
That's a possibility that the &quot;--profile&quot; option to twistd which JP 
suggested might help you with.  You'll see the functions copying data 
taking a lot of CPU time in that case.
&gt;<i>Hum... external program.... maybe it's the self.transport.write() call 
</I>&gt;<i>which blocks several 100ms? Is it safe to write:
</I>&gt;<i>
</I>&gt;<i>   d = threads.deferToThread(self.transport.write, dataChunk)
</I>&gt;<i>
</I>&gt;<i>(i.e. call transport.write from a thread?)
</I>
No.  _All_ Twisted APIs are not thread safe.  This call does not block 
though, and it is extremely, vanishingly unlikely that it is causing 
your problems.  It just sticks some data into the outgoing queue and 
returns immediately.
&gt;<i>How much resources do these deferToThread() deferreds eat? AFAICT, the 
</I>&gt;<i>reactor prepares a thread pool, which leads me to think that it's a 
</I>&gt;<i>well optimized implementation...
</I>
It's not particularly &quot;optimized&quot;, in the sense that we haven't measured 
the performance or improved it much, but it's also not doing very much; 
put a value into a queue, get it out in a thread, do it: that's about 
all.  It would certainly surprise me if that operation were taking 
100ms.

One quick measurement you can do to determine what might be causing this 
performance loss is to examine the server in 'top' while it is allegedly 
under load.  Is it taking up 100% CPU?  If not, then it's probably 
blocked on some kind of I/O in your application, or perhaps writing the 
log.  If so, then there's some inefficient application code (or Twisted 
code) that you need to profile and optimize.  The output of &quot;strace -T&quot; 
on your Twisted server *might* be useful if you discover that you're 
blocking on some kind of I/O.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20070627/52ac8e14/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20070627/52ac8e14/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015634.html">[Twisted-Python] profiling twisted
</A></li>
	<LI>Next message: <A HREF="015638.html">[Twisted-Python] profiling twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15637">[ date ]</a>
              <a href="thread.html#15637">[ thread ]</a>
              <a href="subject.html#15637">[ subject ]</a>
              <a href="author.html#15637">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
