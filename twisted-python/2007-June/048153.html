<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Implementing streaming (broadcast) TCP servers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Implementing%20streaming%20%28broadcast%29%20TCP%20servers&In-Reply-To=%3C4683B853.7080700%40acm.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="048148.html">
   <LINK REL="Next"  HREF="048154.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Implementing streaming (broadcast) TCP servers</H1>
    <B>Carl Zmola</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Implementing%20streaming%20%28broadcast%29%20TCP%20servers&In-Reply-To=%3C4683B853.7080700%40acm.org%3E"
       TITLE="[Twisted-Python] Implementing streaming (broadcast) TCP servers">zmola at acm.org
       </A><BR>
    <I>Thu Jun 28 07:32:03 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="048148.html">[Twisted-Python] Implementing streaming (broadcast) TCP servers
</A></li>
        <LI>Next message (by thread): <A HREF="048154.html">[Twisted-Python] Implementing streaming (broadcast) TCP servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48153">[ date ]</a>
              <a href="thread.html#48153">[ thread ]</a>
              <a href="subject.html#48153">[ subject ]</a>
              <a href="author.html#48153">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Adam,

In general, if you are streaming different data to each client, it is
going to be expensive.  There really are only 3 areas to optimize

1) disk IO  --  Read in bigger chunks and make sure you flush your
buffer.  You might want to drop into C and write your buffering or find
a good &quot;ring buffer&quot;  (big array that you reuse for the stream) so you
don't have to allocate and  deallocate memory all the time.
2) Network IO  -- check what protocol you can use.  If you can get away
with lossy streaming, UDP or RTCP might be wins.
3) CPU -- Profile your application and see where the time is being
spent.  You need to be careful about memory copying and allocation.
Python normally handles this well, so this probably isn't the problem.

OOPS,  I just realized that you said the same data to multiple clients.
Is the data the same at the same time, meaning the clients are all
getting the same data simultaneously?  If so, if you have any control
over the network, then UDP Multicast can be a big win.  You would only
be sending out one stream of data and everyone would hear it.

Also, I would look at making sure that you are not copying data around much.

I must admit that my Knowledge of all the twisted classes that are
available is limited, so I don't know what class to use but I would
suggest dropping in to the low level classes below web2 since you will
need a little more control for this than normal web applications.

Carl
<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">zmola at acm.org</A>



Adam Atlas wrote:
&gt;<i> I'm working on a server that will be streaming the same data from a 
</I>&gt;<i> source to many clients. It has to be invoked from an HTTP server, so 
</I>&gt;<i> I'm using twisted.web2 (not twisted.web because it also needs to host 
</I>&gt;<i> a WSGI application). In other words, calling GET on a certain path 
</I>&gt;<i> results in the stream as the response, at which point I don't really 
</I>&gt;<i> need any more HTTP functionality. I have it working... currently, the 
</I>&gt;<i> basic process is: I have a class implementing IByteStream, an instance 
</I>&gt;<i> of which is created for each client; it simply keeps a queue of data 
</I>&gt;<i> to be sent, sending one piece with each call to read(), or a sending a 
</I>&gt;<i> Deferred if the queue is empty. Meanwhile, the part of the application 
</I>&gt;<i> that provides the data (a different server, receiving data from a 
</I>&gt;<i> broadcaster) adds the data to all the clients' byte stream queues, 
</I>&gt;<i> whenever it receives a piece of data.
</I>&gt;<i>
</I>&gt;<i> Since efficiency is obviously important for a streaming server, I was 
</I>&gt;<i> just wondering if anyone had any efficiency tips. I've tested it with 
</I>&gt;<i> at most 64 concurrent clients. There doesn't seem to be any slowdown 
</I>&gt;<i> from the clients' perspective (the data is coming in at the rate it 
</I>&gt;<i> should), but server-side, CPU and memory usage start increasing pretty 
</I>&gt;<i> quickly. Especially CPU -- with 64 clients, CPU usage peaked at 26.8%, 
</I>&gt;<i> which is not acceptable. Any thoughts? Is there a better way to handle 
</I>&gt;<i> the streaming process as I previously described?
</I>&gt;<i>
</I>&gt;<i> - Adam
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="048148.html">[Twisted-Python] Implementing streaming (broadcast) TCP servers
</A></li>
	<LI>Next message (by thread): <A HREF="048154.html">[Twisted-Python] Implementing streaming (broadcast) TCP servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48153">[ date ]</a>
              <a href="thread.html#48153">[ thread ]</a>
              <a href="subject.html#48153">[ subject ]</a>
              <a href="author.html#48153">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
