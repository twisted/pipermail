<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Testing with trial, adbapi questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Testing%20with%20trial%2C%20adbapi%20questions&In-Reply-To=e64b001e0706250817s223f9833med051053bfa355c5%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015608.html">
   <LINK REL="Next"  HREF="015610.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Testing with trial, adbapi questions</H1>
    <B>Christian Simms</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Testing%20with%20trial%2C%20adbapi%20questions&In-Reply-To=e64b001e0706250817s223f9833med051053bfa355c5%40mail.gmail.com"
       TITLE="[Twisted-Python] Testing with trial, adbapi questions">christian.simms at gmail.com
       </A><BR>
    <I>Mon Jun 25 12:28:23 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015608.html">[Twisted-Python] Testing with trial, adbapi questions
</A></li>
        <LI>Next message: <A HREF="015610.html">[Twisted-Python] Testing with trial, adbapi questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15609">[ date ]</a>
              <a href="thread.html#15609">[ thread ]</a>
              <a href="subject.html#15609">[ subject ]</a>
              <a href="author.html#15609">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I think your biggest hurdle is that you need to get used to using Deferred's
in adbapi and any functions/methods that call adbapi indirectly.  Unless you
use a fast embedded database like Sqlite, you have to use Deferred's because
there's network traffic under the covers to the database server. I'll try to
include a little advice below for each item:


On 6/25/07, Brendon Colby &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">brendoncolby at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Greetings,
</I>&gt;<i>
</I>&gt;<i> I've begun moving an application I wrote from asynchat to twisted.
</I>&gt;<i> I've got basic functionality, I've converted my DB stuff to adbapi and
</I>&gt;<i> have begun writing unit tests. I have a few questions that I haven't
</I>&gt;<i> been able to get answered through the API docs, twisted.words protocol
</I>&gt;<i> code, mailing list posts etc. I'd be very grateful for some
</I>&gt;<i> assistance!
</I>&gt;<i>
</I>&gt;<i> 1. Right now I'm defining my dbPool in my factory init, and running a
</I>&gt;<i> method to load some data from the DB. I've copied the IRC
</I>&gt;<i> BasicServerFunctionalityTestCase and modified it for my use:
</I>&gt;<i>
</I>&gt;<i> class BasicServerFunctionalityTestCase(unittest.TestCase):
</I>&gt;<i>     def setUp(self):
</I>&gt;<i>         self.f = StringIOWithoutClosing()
</I>&gt;<i>         self.t = FileWrapperThatWorks(self.f) # I need this to return
</I>&gt;<i> an IPv4Address!
</I>&gt;<i>         self.p = sserverd.SServerProtocol()
</I>&gt;<i>         self.p.factory = sserverd.SServerFactory(self.p)
</I>&gt;<i>         self.p.makeConnection(self.t)
</I>&gt;<i>         self.p.factory.dbPool.start()
</I>&gt;<i>
</I>&gt;<i>     def tearDown(self):
</I>&gt;<i>         self.p.factory.dbPool.close()
</I>&gt;<i>
</I>&gt;<i>     def check(self, s):
</I>&gt;<i>         self.assertEquals(self.f.getvalue(), s)
</I>&gt;<i>
</I>&gt;<i>     def testSendDeveloperID(self):
</I>&gt;<i>         self.p.lineReceived('{%s:&quot;PG&quot;}\0' % sserverson.base10toN(104))
</I>&gt;<i>         self.check(&quot;test\0&quot;)
</I>&gt;<i>
</I>&gt;<i> I've gotten past the database threads hanging open by running start()
</I>&gt;<i> and close() manually. Now, my database callbacks that load necessary
</I>&gt;<i> data appear to be getting called AFTER my test runs. I know they're
</I>&gt;<i> getting called, but when the above test runs, the required data
</I>&gt;<i> structure is empty. What am I missing here?
</I>

I think you have a race condition because (I assume)
self.p.lineReceivedindirectly did a database insert, and then the
self.check did a database select.  If that's true, you should make your test
use Deferred's like this:

  d = defer.succeed(None)
  d.addCallback(lambda out: self.p.lineReceived('{%s:&quot;PG&quot;}\0' %
sserverson.base10toN(104))
  d.addCallback(lambda out: self.check(&quot;test\0&quot;))
  return d

You could also write this code using the new defer.inlineCallbacks (needs
python 2.5) or the older defer.deferredGenerator, but you might as well get
used to using callbacks/errbacks and Deferred's.


2. I'm having a bit of trouble wrapping my head around adbapi. Prior
&gt;<i> to it, one thing I would do is gather data and return a row, as in,
</I>&gt;<i> the method &quot;developerExists()&quot; would check the DB and return row[0][0]
</I>&gt;<i> or something (a bool). Now it seems as though I have to preload this
</I>&gt;<i> data and check against that. Can I replicate this behavior with
</I>&gt;<i> adbapi? Is there a better way than having to preload ALL my data up
</I>&gt;<i> front? How can I get any data from the DB like this:
</I>&gt;<i>
</I>&gt;<i> data = getSomethingFromDB()
</I>&gt;<i>
</I>&gt;<i> I'm suspicious that I need to adopt a new paradigm here, but am having
</I>&gt;<i> difficulty seeing past the old way of doing things!
</I>

You're right that you need a new paradigm, like this:

  def cb(data):
       # use the data here, in the callback function
  return getSomethingFromDB().addCallback(cb)

This assumes getSomethingFromDB() returns a Deferred which fires with the
result you wanted.

3. I have some methods (as I pointed out in #1) that load data. With
&gt;<i> adbapi, it appears that I have to do this:
</I>&gt;<i>
</I>&gt;<i>   def _loadDevelopers(self,results):
</I>&gt;<i>     for result in results:
</I>&gt;<i>       developerID = result[2]
</I>&gt;<i>       ...
</I>&gt;<i>       self.addDeveloper
</I>&gt;<i> (Developer(authHost,authUrl,developerID,self,rc4key,
</I>&gt;<i>         postHost,postUrl))
</I>&gt;<i>
</I>&gt;<i>   def loadDevelopers(self):
</I>&gt;<i>     self.dbPool.runQuery(&quot;select * from developers where
</I>&gt;<i> active=1&quot;).addCallback(
</I>&gt;<i>     self._loadDevelopers).addErrback(printError)
</I>&gt;<i>     # Before, I would just load my data here!
</I>&gt;<i>
</I>&gt;<i> Is this correct? i.e. a DB method that gets called, each having a
</I>&gt;<i> corresponding callback method that does the real work? (This seems
</I>&gt;<i> sort of a pain to me...) I feel as though I'm close to &quot;getting it&quot;
</I>&gt;<i> (twisted in general, adbapi) but feel that I have yet to connect some
</I>&gt;<i> key pieces of information.
</I>


This is basically correct, though loadDevelopers should probably return the
result of the runQuery() call.


4. I was digging through the adbapi code, and it appears that the only
&gt;<i> type of result set I can get is a tuple (because only cursors are
</I>&gt;<i> used...). Is there a way I can get a dictionary returned, keys are
</I>&gt;<i> column names? i.e. a MySqlDB.fetch_row(how=1). I'm just not seeing how
</I>&gt;<i> I can do this with adbapi or, rather, how I can pass through to the
</I>&gt;<i> MySqlDB module to get this type of result set.
</I>


If you can't find a MySQL-specific way to get a dictionary, you can always
write a generic python function which does so, and then always call that in
your code.  adbapi doesn't do this for you.

5. I've always run my application using DJB's daemontools
&gt;<i> (<A HREF="http://cr.yp.to/daemontools.html">http://cr.yp.to/daemontools.html</A>). Is there an incredibly compelling
</I>&gt;<i> reason to switch to using twistd? It seems to have some pretty neat
</I>&gt;<i> features, but I'm just not 100% sure I want to give up daemontools
</I>&gt;<i> yet.
</I>

You really need to run your twisted app with twistd.  That's the abstraction
for launching twisted programs -- i.e., you define a variable named
&quot;application&quot; in your .tac file and then use twistd to start your app.  Of
course, there's nothing stopping you from using daemontools on top of it.

Thanks!
&gt;<i>
</I>&gt;<i> Brendon Colby
</I>&gt;<i>
</I>
Cheers,
Christian
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20070625/63d0a358/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20070625/63d0a358/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015608.html">[Twisted-Python] Testing with trial, adbapi questions
</A></li>
	<LI>Next message: <A HREF="015610.html">[Twisted-Python] Testing with trial, adbapi questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15609">[ date ]</a>
              <a href="thread.html#15609">[ thread ]</a>
              <a href="subject.html#15609">[ subject ]</a>
              <a href="author.html#15609">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
