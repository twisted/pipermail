<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] profiling twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20profiling%20twisted&In-Reply-To=%3C468274E7.4070301%40bluegap.ch%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="048140.html">
   <LINK REL="Next"  HREF="048142.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] profiling twisted</H1>
    <B>Markus Schiltknecht</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20profiling%20twisted&In-Reply-To=%3C468274E7.4070301%40bluegap.ch%3E"
       TITLE="[Twisted-Python] profiling twisted">markus at bluegap.ch
       </A><BR>
    <I>Wed Jun 27 08:32:07 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="048140.html">[Twisted-Python] profiling twisted
</A></li>
        <LI>Next message (by thread): <A HREF="048142.html">[Twisted-Python] profiling twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48141">[ date ]</a>
              <a href="thread.html#48141">[ thread ]</a>
              <a href="subject.html#48141">[ subject ]</a>
              <a href="author.html#48141">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Mike C. Fletcher wrote:
&gt;<i> <A HREF="http://blog.vrplumber.com/1353">http://blog.vrplumber.com/1353</A>
</I>
Thanks, nice article. And I've tried that code snipped, but it didn't 
help much in my case, as response times are below 1 second.

Please see these measurements, taken with apache bench. I'm testing 
response times on a simple status resource, which doesn't take long to 
calculate (i.e. doesn't even throw a deferred, but returns a response 
immediately):

Document Path:          /status
Document Length:        202 bytes

Concurrency Level:      10
Time taken for tests:   0.202266 seconds
Complete requests:      100
Failed requests:        0
Write errors:           0
Total transferred:      38400 bytes
HTML transferred:       20200 bytes
Requests per second:    494.40 [#/sec] (mean)
Time per request:       20.227 [ms] (mean)
Time per request:       2.023 [ms] (mean, across all concurrent requests)
Transfer rate:          182.93 [Kbytes/sec] received


Now, measured while the server is under very small load:

Document Path:          /status
Document Length:        202 bytes

Concurrency Level:      10
Time taken for tests:   4.103465 seconds
Complete requests:      100
Failed requests:        0
Write errors:           0
Total transferred:      38400 bytes
HTML transferred:       20200 bytes
Requests per second:    24.37 [#/sec] (mean)
Time per request:       410.347 [ms] (mean)
Time per request:       41.035 [ms] (mean, across all concurrent requests)
Transfer rate:          9.02 [Kbytes/sec] received


When putting the server under real load, those response times climb up 
to two seconds, so there must be something wrong.

Can I somehow get the reactor's state, i.e. how many deferreds are 
waiting in the queue, how many threads are running concurrently, etc?

How good is the idea of deferring File I/O to threads, i.e. 
threads.deferToThread(self.filehandle.write, data)? Another possibly 
blocking module might be the database api, but I'm using twisted's 
enterprise adbapi, which should be async, AFAICT.

Maybe copying data around takes time. I'm sending around chunks of 64k 
size (streaming from the database to an external programm). Reducing 
chunk size to 1k helps somewhat (i.e. response time is seldom over 
150ms, but can still climb up to &gt; 0.5 seconds).

Hum... external program.... maybe it's the self.transport.write() call 
which blocks several 100ms? Is it safe to write:

   d = threads.deferToThread(self.transport.write, dataChunk)

(i.e. call transport.write from a thread?)

How much resources do these deferToThread() deferreds eat? AFAICT, the 
reactor prepares a thread pool, which leads me to think that it's a well 
optimized implementation...

Regards

Markus




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="048140.html">[Twisted-Python] profiling twisted
</A></li>
	<LI>Next message (by thread): <A HREF="048142.html">[Twisted-Python] profiling twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48141">[ date ]</a>
              <a href="thread.html#48141">[ thread ]</a>
              <a href="subject.html#48141">[ subject ]</a>
              <a href="author.html#48141">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
