<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Advice on doing thousands of simultaneous UDP queries with Twisted...
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Advice%20on%20doing%20thousands%20of%20simultaneous%20UDP%0A%20queries%20with%20Twisted...&In-Reply-To=%3C40288714.2040100%40rogers.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="039541.html">
   <LINK REL="Next"  HREF="039543.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Advice on doing thousands of simultaneous UDP queries with Twisted...</H1>
    <B>Mike C. Fletcher</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Advice%20on%20doing%20thousands%20of%20simultaneous%20UDP%0A%20queries%20with%20Twisted...&In-Reply-To=%3C40288714.2040100%40rogers.com%3E"
       TITLE="[Twisted-Python] Advice on doing thousands of simultaneous UDP queries with Twisted...">mcfletch at rogers.com
       </A><BR>
    <I>Tue Feb 10 00:24:04 MST 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="039541.html">[Twisted-Python] Advice on doing thousands of simultaneous UDP	queries with Twisted...
</A></li>
        <LI>Next message (by thread): <A HREF="039543.html">[Twisted-Python] Twisted and SNMP (was: Advice on doing thousands of simultaneous UDP queries with Twisted...)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39542">[ date ]</a>
              <a href="thread.html#39542">[ thread ]</a>
              <a href="subject.html#39542">[ subject ]</a>
              <a href="author.html#39542">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Stephen Thorne wrote:

&gt;<i>Have a look at htb.py, you should be able to rate limit the udp
</I>&gt;<i>throughput rather easily.
</I>&gt;<i>
</I>&gt;<i>For me doing web stuff it was (in its entirety) like this:
</I>&gt;<i>  
</I>&gt;<i>
</I>&lt;bandwidth throttler clipped&gt;

&gt;<i>Hope that helps.
</I>&gt;<i>  
</I>&gt;<i>
</I>If for no other reason than that it convinced me there wasn't a simple 
and elegant solution readily available to be dropped in for a UDP system 
:<i>) .  In the final analysis, what was happening is that individual 
</I>queries were timing out *before the queries were even sent* because it 
was taking so incredibly long to format and send all of the queries.

The manually written system was &quot;pull&quot; based.  It marked the 
time-of-sending for timeout purposes deep in the select loop.  The 
Twisted version is setting the timeout via a callLater when the request 
is *submitted*.  With 2 or 3 thousand queries, the 20 seconds of timeout 
was finishing before any messages were processed from the incoming port, 
then the timeouts would all get called, which kept eating up processing 
time, preventing any messages from getting read, so the port's internal 
buffer would fill up and more timeouts occurred, so basically nothing 
would get through.

Queueing up the outputs before sending didn't help, btw.  Nor would 
simple bandwidth throttling without modifying the timeout characteristics.

My solution, which is rather low tech, is to do an effective &quot;yield&quot; 
after each message is sent, to allow for processing incoming responses.  
This is done with this little method:

    def smallBatch( self, oids, tables, index=0, iterDelay=.01 ):
        if index &lt; len(self.proxies):
            proxy = self.proxies[index]
            self.singleProxy(
                proxy,oids,tables
            )
            reactor.callLater( iterDelay, self.smallBatch, oids, tables, 
index+1 )
        else:
            dl = defer.DeferredList( self.partialDefers )
            dl.addCallback( self.returnFinal )

(which also has a side-effect of introducing a bandwidth throttling), 
but most importantly, it delays setting the timeout on any given query 
until when the query is actually sent (or fairly close to then).  Put 
another way, it gives the system a chance to send the message as soon 
after submitting it as possible.

Have fun all, and thanks, Stephen,
Mike

&gt;<i>Stephen Thorne
</I>&gt;<i>
</I>&gt;<i>On Mon, 2004-02-09 at 20:51, Mike C. Fletcher wrote:
</I>&gt;<i>  
</I>&gt;<i>
</I>...

&gt;&gt;<i>only a few dozen dropped messages.  However, with the Twisted equivalent 
</I>&gt;&gt;<i>(UDPTransport with my simple protocol object), I was seeing huge drop 
</I>&gt;&gt;<i>rates, so, gathering that Twisted isn't queueing up the UDP requests, I 
</I>&gt;&gt;<i>wrote a (byzantine) query-throttling mechanism with Twisted defers.
</I>&gt;&gt;<i>    
</I>&gt;&gt;<i>
</I>...

 
_______________________________________
  Mike C. Fletcher
  Designer, VR Plumber, Coder
  <A HREF="http://members.rogers.com/mcfletch/">http://members.rogers.com/mcfletch/</A>




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="039541.html">[Twisted-Python] Advice on doing thousands of simultaneous UDP	queries with Twisted...
</A></li>
	<LI>Next message (by thread): <A HREF="039543.html">[Twisted-Python] Twisted and SNMP (was: Advice on doing thousands of simultaneous UDP queries with Twisted...)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39542">[ date ]</a>
              <a href="thread.html#39542">[ thread ]</a>
              <a href="subject.html#39542">[ subject ]</a>
              <a href="author.html#39542">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
