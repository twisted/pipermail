<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20do%20you%20determine%20the%20buffer%20size%20of%20a%0A%20transport%20-%20a%20use-case%20for%20not%20using%20back%20pressure&In-Reply-To=%3CCAPxhEGccVASQQsh9kGODOVnu3ygHrjDAdo%2B8_gwYLWwmaqQ1mA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="063197.html">
   <LINK REL="Next"  HREF="063204.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure</H1>
    <B>Steve Morin</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20do%20you%20determine%20the%20buffer%20size%20of%20a%0A%20transport%20-%20a%20use-case%20for%20not%20using%20back%20pressure&In-Reply-To=%3CCAPxhEGccVASQQsh9kGODOVnu3ygHrjDAdo%2B8_gwYLWwmaqQ1mA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure">steve.morin at gmail.com
       </A><BR>
    <I>Wed Aug 17 16:43:57 MDT 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="063197.html">[Twisted-Python] [BACKWARDS INCOMPATIBILITY] Making	twisted.python.dist3 private
</A></li>
        <LI>Next message (by thread): <A HREF="063204.html">[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30739">[ date ]</a>
              <a href="thread.html#30739">[ thread ]</a>
              <a href="subject.html#30739">[ subject ]</a>
              <a href="author.html#30739">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Twisted Community

Problem: How do you determine the buffer size of a transport, to know how
much data is waiting to be transmitted from using transport.write?

Wait! You're going to say: use the Producer Consumer API (
<A HREF="http://twistedmatrix.com/documents/current/core/howto/producers.html">http://twistedmatrix.com/documents/current/core/howto/producers.html</A> )

To do what: So that instead of using back pressure I can check the buffer
and when it's &quot;too big/full&quot; can decide to do something to the transport I
am writing to:

Slow transport handling options:

- Buffer to disk instead of memory
- Kill the transport
- Decide to skip sending some data
- Send an error or message to the transport I am writing to
- Reduce the resolution, increase the compression (things like video or
audio)

Why not use back pressure?: Some use-cases and some protocols this doesn't
make sense.

Examples:
- You're sending video and if the receiver can't keep up you want to
downgrade or upgrade the quality of the video, but if you don't know if you
can't tell how much it buffering.
- You're receiving from one connection and then broadcasting what you
received to multiple clients and you want to handle it by sending an error
to a client that doesn't keep up
- You're sending a real-time protocol and want to skip sending some data
that's no longer relevant if the buffer is too slow.

On a server what are the consequences:
Too much buffering in many transport write buffer can cause a server to
fail.  I don't know how to keep track of this to proactively without access
to the buffer sizes.  Resolutions can then be to, not accept new
connections when memory pressure is too high, kill connections with the
weakest/slowest clients or have a protocol that can have client switch
connections to new servers when instructed to spread out the load.
1) I would like to hear on how people would solve this sort of problem in
Twisted for a server?
2) I would like to hear people opinions on this in general.

Tobias Oberstein - BCC'ed you on this email because you seems to have
tackled similar problems (based on the mailing list) and would really love
to get your take on this too.

Glyph and Jean-Paul, you're also big on those threads so any opinions you
have would be appreciated as well.

Some of my background research

* <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2015-January/029064.html">http://twistedmatrix.com/pipermail/twisted-python/2015-January/029064.html</A>
* Later but good in the chain:
<A HREF="http://twistedmatrix.com/pipermail/twisted-python/2015-January/029071.html">http://twistedmatrix.com/pipermail/twisted-python/2015-January/029071.html</A>
  * Twisted receiving buffers swamped?
  * Summary: Great thread but runs into a tangent for a while and picks up
good at the end again discussing producer again and the need for
backpressure
  * Other:
    * <A HREF="http://crossbar.io/">http://crossbar.io/</A>
    * <A HREF="http://tavendo.com/">http://tavendo.com/</A>
  * Scenario: &quot;Twisted is reading off the TCP stack from the kernel and
buffering in userspace faster than the echo server is pushing out stuff to
the TCP stack into the kernel. Hence, no TCP backpressure results, netperf
happily sends more and more, and the memory of the Twisted process runs
away.&quot;
  * Confirmed: Data isn't Buffered in &quot;userspace inside Twisted, and before
data is handled by the app in dataReceived.&quot;
*
<A HREF="https://twistedmatrix.com/pipermail/twisted-python/2010-September/022900.html">https://twistedmatrix.com/pipermail/twisted-python/2010-September/022900.html</A>
  * How to cap the buffering size of data to be sent in Protocol class
  * Summary: Same issue, very short no good info
* <A HREF="https://twistedmatrix.com/pipermail/twisted-python/2012-March/025416.html">https://twistedmatrix.com/pipermail/twisted-python/2012-March/025416.html</A>
  * Limit on transport.write
  * Summary: Similar issue, very short no good info, glyph confirms that
transport.write buffers everything sent to it.
*
<A HREF="https://twistedmatrix.com/pipermail/twisted-python/2012-February/025215.html">https://twistedmatrix.com/pipermail/twisted-python/2012-February/025215.html</A>
  * pushing out same message on 100k TCPs
  * Summary: Interesting discussion but different issue - interesting aside
about irc spanning trees for a large broadcasts
* <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2008-April/017503.html">http://twistedmatrix.com/pipermail/twisted-python/2008-April/017503.html</A>
  * Question on push/pull producers inter-workings, was : &quot;Is there a
simple Producer/Consumer example or tutorial?&quot;
  * Summary: Related and goes into what a producer is - an explanation of it
* <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2004-May/007732.html">http://twistedmatrix.com/pipermail/twisted-python/2004-May/007732.html</A>
  * When do calls to transport.write() block ?
  * Summary: Discusses the right issue, talks about buffer call back if
full which would be great (if configurable)
*
<A HREF="https://pythonhosted.org/qbuf/qbuf.twisted_support.MultiBufferer-class.html">https://pythonhosted.org/qbuf/qbuf.twisted_support.MultiBufferer-class.html</A>
  * <A HREF="https://launchpad.net/qbuf">https://launchpad.net/qbuf</A>
  * Summary: c buffer implementation that's incomplete thought might be
promising
*
<A HREF="http://stackoverflow.com/questions/21821119/twisted-producer-to-many-clients-with-buffer">http://stackoverflow.com/questions/21821119/twisted-producer-to-many-clients-with-buffer</A>
  * Summary: Was indicating a similar use-case but source doesn't seem to
exist on the internet
* <A HREF="http://twistedmatrix.com/documents/current/core/howto/producers.html">http://twistedmatrix.com/documents/current/core/howto/producers.html</A>
  * Summary: Documentation on Producer and Consumers but only help with a
backpressure scenario
* <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2007-July/015690.html">http://twistedmatrix.com/pipermail/twisted-python/2007-July/015690.html</A>
  * Summary: Discussion on how producer-consumer API's work and future
enhancement no help
* MANY MORE THAT 100% NOT RELEVANT


-- 
Steve Morin | Hacker, Entrepreneur, Startup Advisor
twitter.com/SteveMorin | stevemorin.com
*Live the dream start a startup. Make the world ... a better place.*
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20160817/b0dd2096/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20160817/b0dd2096/attachment.html</A>&gt;
</PRE>















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="063197.html">[Twisted-Python] [BACKWARDS INCOMPATIBILITY] Making	twisted.python.dist3 private
</A></li>
	<LI>Next message (by thread): <A HREF="063204.html">[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30739">[ date ]</a>
              <a href="thread.html#30739">[ thread ]</a>
              <a href="subject.html#30739">[ subject ]</a>
              <a href="author.html#30739">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
