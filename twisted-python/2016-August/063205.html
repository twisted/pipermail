<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20do%20you%20determine%20the%20buffer%20size%20of%20a%0A%20transport%20-%20a%20use-case%20for%20not%20using%20back%20pressure&In-Reply-To=%3CCAEeXt4No1DMTZwMej2uN8r2130eTUThJJU903ux7ToqzyGi_dA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="063204.html">
   <LINK REL="Next"  HREF="063214.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20do%20you%20determine%20the%20buffer%20size%20of%20a%0A%20transport%20-%20a%20use-case%20for%20not%20using%20back%20pressure&In-Reply-To=%3CCAEeXt4No1DMTZwMej2uN8r2130eTUThJJU903ux7ToqzyGi_dA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri Aug 19 09:58:22 MDT 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="063204.html">[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure
</A></li>
        <LI>Next message (by thread): <A HREF="063214.html">[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63205">[ date ]</a>
              <a href="thread.html#63205">[ thread ]</a>
              <a href="subject.html#63205">[ subject ]</a>
              <a href="author.html#63205">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>There are at least two buffers (per direction) you might be interested in.
You can get the kernel buffer size with getsockopt - SO_SNDBUF and
SO_RCVBUF.  Then, there may also be a user-space buffer (or perhaps more
than one) managed by the transport implementation.  The details of this are
entirely up to the transport so there's no general answer apart from &quot;read
the implementation, contribute a patch implementing a public interface for
retrieving the information&quot;.

Jean-Paul

On Fri, Aug 19, 2016 at 10:08 AM, Steve Morin &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">steve at stevemorin.com</A>&gt; wrote:

&gt;<i> Anyone know how do you determine the buffer size of a transport, to know
</I>&gt;<i> how much data is waiting to be transmitted from using transport.write?
</I>&gt;<i>
</I>&gt;<i> Or how you would go about adding that ability to a reactor/transport?
</I>&gt;<i>
</I>&gt;<i> On Wed, Aug 17, 2016 at 3:43 PM, Steve Morin &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">steve.morin at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Twisted Community
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Problem: How do you determine the buffer size of a transport, to know how
</I>&gt;&gt;<i> much data is waiting to be transmitted from using transport.write?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Wait! You're going to say: use the Producer Consumer API (
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/documents/current/core/howto/producers.html">http://twistedmatrix.com/documents/current/core/howto/producers.html</A> )
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To do what: So that instead of using back pressure I can check the buffer
</I>&gt;&gt;<i> and when it's &quot;too big/full&quot; can decide to do something to the transport I
</I>&gt;&gt;<i> am writing to:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Slow transport handling options:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Buffer to disk instead of memory
</I>&gt;&gt;<i> - Kill the transport
</I>&gt;&gt;<i> - Decide to skip sending some data
</I>&gt;&gt;<i> - Send an error or message to the transport I am writing to
</I>&gt;&gt;<i> - Reduce the resolution, increase the compression (things like video or
</I>&gt;&gt;<i> audio)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why not use back pressure?: Some use-cases and some protocols this
</I>&gt;&gt;<i> doesn't make sense.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Examples:
</I>&gt;&gt;<i> - You're sending video and if the receiver can't keep up you want to
</I>&gt;&gt;<i> downgrade or upgrade the quality of the video, but if you don't know if you
</I>&gt;&gt;<i> can't tell how much it buffering.
</I>&gt;&gt;<i> - You're receiving from one connection and then broadcasting what you
</I>&gt;&gt;<i> received to multiple clients and you want to handle it by sending an error
</I>&gt;&gt;<i> to a client that doesn't keep up
</I>&gt;&gt;<i> - You're sending a real-time protocol and want to skip sending some data
</I>&gt;&gt;<i> that's no longer relevant if the buffer is too slow.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On a server what are the consequences:
</I>&gt;&gt;<i> Too much buffering in many transport write buffer can cause a server to
</I>&gt;&gt;<i> fail.  I don't know how to keep track of this to proactively without access
</I>&gt;&gt;<i> to the buffer sizes.  Resolutions can then be to, not accept new
</I>&gt;&gt;<i> connections when memory pressure is too high, kill connections with the
</I>&gt;&gt;<i> weakest/slowest clients or have a protocol that can have client switch
</I>&gt;&gt;<i> connections to new servers when instructed to spread out the load.
</I>&gt;&gt;<i> 1) I would like to hear on how people would solve this sort of problem in
</I>&gt;&gt;<i> Twisted for a server?
</I>&gt;&gt;<i> 2) I would like to hear people opinions on this in general.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Tobias Oberstein - BCC'ed you on this email because you seems to have
</I>&gt;&gt;<i> tackled similar problems (based on the mailing list) and would really love
</I>&gt;&gt;<i> to get your take on this too.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Glyph and Jean-Paul, you're also big on those threads so any opinions you
</I>&gt;&gt;<i> have would be appreciated as well.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Some of my background research
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2015-Janua">http://twistedmatrix.com/pipermail/twisted-python/2015-Janua</A>
</I>&gt;&gt;<i> ry/029064.html
</I>&gt;&gt;<i> * Later but good in the chain: <A HREF="http://twistedmatrix.com/piper">http://twistedmatrix.com/piper</A>
</I>&gt;&gt;<i> mail/twisted-python/2015-January/029071.html
</I>&gt;&gt;<i>   * Twisted receiving buffers swamped?
</I>&gt;&gt;<i>   * Summary: Great thread but runs into a tangent for a while and picks
</I>&gt;&gt;<i> up good at the end again discussing producer again and the need for
</I>&gt;&gt;<i> backpressure
</I>&gt;&gt;<i>   * Other:
</I>&gt;&gt;<i>     * <A HREF="http://crossbar.io/">http://crossbar.io/</A>
</I>&gt;&gt;<i>     * <A HREF="http://tavendo.com/">http://tavendo.com/</A>
</I>&gt;&gt;<i>   * Scenario: &quot;Twisted is reading off the TCP stack from the kernel and
</I>&gt;&gt;<i> buffering in userspace faster than the echo server is pushing out stuff to
</I>&gt;&gt;<i> the TCP stack into the kernel. Hence, no TCP backpressure results, netperf
</I>&gt;&gt;<i> happily sends more and more, and the memory of the Twisted process runs
</I>&gt;&gt;<i> away.&quot;
</I>&gt;&gt;<i>   * Confirmed: Data isn't Buffered in &quot;userspace inside Twisted, and
</I>&gt;&gt;<i> before data is handled by the app in dataReceived.&quot;
</I>&gt;&gt;<i> * <A HREF="https://twistedmatrix.com/pipermail/twisted-python/2010-Sept">https://twistedmatrix.com/pipermail/twisted-python/2010-Sept</A>
</I>&gt;&gt;<i> ember/022900.html
</I>&gt;&gt;<i>   * How to cap the buffering size of data to be sent in Protocol class
</I>&gt;&gt;<i>   * Summary: Same issue, very short no good info
</I>&gt;&gt;<i> * <A HREF="https://twistedmatrix.com/pipermail/twisted-python/2012-Marc">https://twistedmatrix.com/pipermail/twisted-python/2012-Marc</A>
</I>&gt;&gt;<i> h/025416.html
</I>&gt;&gt;<i>   * Limit on transport.write
</I>&gt;&gt;<i>   * Summary: Similar issue, very short no good info, glyph confirms that
</I>&gt;&gt;<i> transport.write buffers everything sent to it.
</I>&gt;&gt;<i> * <A HREF="https://twistedmatrix.com/pipermail/twisted-python/2012-Febr">https://twistedmatrix.com/pipermail/twisted-python/2012-Febr</A>
</I>&gt;&gt;<i> uary/025215.html
</I>&gt;&gt;<i>   * pushing out same message on 100k TCPs
</I>&gt;&gt;<i>   * Summary: Interesting discussion but different issue - interesting
</I>&gt;&gt;<i> aside about irc spanning trees for a large broadcasts
</I>&gt;&gt;<i> * <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2008-April">http://twistedmatrix.com/pipermail/twisted-python/2008-April</A>
</I>&gt;&gt;<i> /017503.html
</I>&gt;&gt;<i>   * Question on push/pull producers inter-workings, was : &quot;Is there a
</I>&gt;&gt;<i> simple Producer/Consumer example or tutorial?&quot;
</I>&gt;&gt;<i>   * Summary: Related and goes into what a producer is - an explanation of
</I>&gt;&gt;<i> it
</I>&gt;&gt;<i> * <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2004-May/007732.html">http://twistedmatrix.com/pipermail/twisted-python/2004-May/007732.html</A>
</I>&gt;&gt;<i>   * When do calls to transport.write() block ?
</I>&gt;&gt;<i>   * Summary: Discusses the right issue, talks about buffer call back if
</I>&gt;&gt;<i> full which would be great (if configurable)
</I>&gt;&gt;<i> * <A HREF="https://pythonhosted.org/qbuf/qbuf.twisted_support.MultiBuff">https://pythonhosted.org/qbuf/qbuf.twisted_support.MultiBuff</A>
</I>&gt;&gt;<i> erer-class.html
</I>&gt;&gt;<i>   * <A HREF="https://launchpad.net/qbuf">https://launchpad.net/qbuf</A>
</I>&gt;&gt;<i>   * Summary: c buffer implementation that's incomplete thought might be
</I>&gt;&gt;<i> promising
</I>&gt;&gt;<i> * <A HREF="http://stackoverflow.com/questions/21821119/twisted-producer">http://stackoverflow.com/questions/21821119/twisted-producer</A>
</I>&gt;&gt;<i> -to-many-clients-with-buffer
</I>&gt;&gt;<i>   * Summary: Was indicating a similar use-case but source doesn't seem to
</I>&gt;&gt;<i> exist on the internet
</I>&gt;&gt;<i> * <A HREF="http://twistedmatrix.com/documents/current/core/howto/producers.html">http://twistedmatrix.com/documents/current/core/howto/producers.html</A>
</I>&gt;&gt;<i>   * Summary: Documentation on Producer and Consumers but only help with a
</I>&gt;&gt;<i> backpressure scenario
</I>&gt;&gt;<i> * <A HREF="http://twistedmatrix.com/pipermail/twisted-python/2007-July/015690.html">http://twistedmatrix.com/pipermail/twisted-python/2007-July/015690.html</A>
</I>&gt;&gt;<i>   * Summary: Discussion on how producer-consumer API's work and future
</I>&gt;&gt;<i> enhancement no help
</I>&gt;&gt;<i> * MANY MORE THAT 100% NOT RELEVANT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Steve Morin | Hacker, Entrepreneur, Startup Advisor
</I>&gt;&gt;<i> twitter.com/SteveMorin | stevemorin.com
</I>&gt;&gt;<i> *Live the dream start a startup. Make the world ... a better place.*
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> *Steve Morin | Managing Partner - CTO*
</I>&gt;<i>
</I>&gt;<i> *Nvent*
</I>&gt;<i>
</I>&gt;<i> O 800-407-1156 ext 803 &lt;800-407-1156;803&gt; | M 347-453-5579
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">smorin at nventdata.com</A>  &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">smorin at nventdata.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i> *Enabling the Data Driven Enterprise*
</I>&gt;<i> *(Ask us how we can setup scalable open source realtime billion+
</I>&gt;<i> event/data collection/analytics infrastructure in weeks)*
</I>&gt;<i>
</I>&gt;<i> Service Areas: Management &amp; Strategy Consulting | Data Engineering | Data
</I>&gt;<i> Science &amp; Visualization
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20160819/b8e90bd8/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="063204.html">[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure
</A></li>
	<LI>Next message (by thread): <A HREF="063214.html">[Twisted-Python] How do you determine the buffer size of a transport - a use-case for not using back pressure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63205">[ date ]</a>
              <a href="thread.html#63205">[ thread ]</a>
              <a href="subject.html#63205">[ subject ]</a>
              <a href="author.html#63205">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
