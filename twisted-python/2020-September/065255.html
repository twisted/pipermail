<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Retry: Conch Issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Retry%3A%20Conch%20Issues&In-Reply-To=%3CCAAXGW-z-9xXfsZcKhrkV6pm7zWz-56jdBF_%3DuKCBg7Xemnx41g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065254.html">
   <LINK REL="Next"  HREF="065256.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Retry: Conch Issues</H1>
    <B>Robert DiFalco</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Retry%3A%20Conch%20Issues&In-Reply-To=%3CCAAXGW-z-9xXfsZcKhrkV6pm7zWz-56jdBF_%3DuKCBg7Xemnx41g%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Retry: Conch Issues">robert.difalco at gmail.com
       </A><BR>
    <I>Thu Sep 24 18:54:01 MDT 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065254.html">[Twisted-Python] Retry: Conch Issues
</A></li>
        <LI>Next message (by thread): <A HREF="065256.html">[Twisted-Python] Retry: Conch Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65255">[ date ]</a>
              <a href="thread.html#65255">[ thread ]</a>
              <a href="subject.html#65255">[ subject ]</a>
              <a href="author.html#65255">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you so much Aldi! Yes there are so many little decoupled pieces it's
difficult to figre out how to use them in concert. .Let's leave aside the
reconnecting option for a minute and just talk about how to percolate
errors up. Because currently I want to be able to always return from a
FileTransferClient call. By upleveling things do you mean like this?

Wait, ha, I actually don't know because the deferreds are one shot? Why
exactly is makeDirectory not firing any callbacks or errbacks and what can
I add at the Factory level to make it do so?

class MySSHClientFactory(SSHClientFactory):
    def clientConnectionLost(self, connector, reason):
        self.op.addErrback(reason)

    def makeDirectory(self, path, attrs):
        self.op = Deferred()
        def _cbSuccess(result):
            self.op.callback(result)

        return self.sftpClient.makeDirectory(path,
attrs).addCallback(_cbSuccess)d

That won't work. If you can give me a breadcrumb or idiom I can apply it
across everything. I'm just too new to twisted to know the correct idiom
here. Totally good with moving the methods up to the factory, just not sure
how.



On Thu, Sep 24, 2020 at 5:36 PM Adi Roiban &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A>&gt; wrote:

&gt;<i> Hi
</I>&gt;<i>
</I>&gt;<i> On Fri, 25 Sep 2020 at 00:15, Robert DiFalco &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">robert.difalco at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I am having troubles with Conch. I've been able to reproduce them in a
</I>&gt;&gt;<i> unit test and all the code is here along with requirements.txt:
</I>&gt;&gt;<i>    <A HREF="https://github.com/radifalco/conch_issues">https://github.com/radifalco/conch_issues</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm trying to reuse my connection, but if it is idle too long the server
</I>&gt;&gt;<i> shuts it down. What I don't understand is why the next call to
</I>&gt;&gt;<i> `FileTransferClient` does not call back or errback? It will just hang
</I>&gt;&gt;<i> forever even though the Factory and Transport know the connection was
</I>&gt;&gt;<i> closed (as evidenced by the log messages).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I don't ever want to hang, if I use FileTransferClient I would like it
</I>&gt;&gt;<i> always call a callback or errback. I feel like Conch is missing a deferred
</I>&gt;&gt;<i> somewhere but damned if I can find it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Have you checked
</I>&gt;<i> <A HREF="https://twistedmatrix.com/documents/current/core/howto/clients.html#reconnection">https://twistedmatrix.com/documents/current/core/howto/clients.html#reconnection</A>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> I see that `connector.connect()` is commented in your code.
</I>&gt;<i>
</I>&gt;<i> The theory is that once a client connection is lost, you will need to call
</I>&gt;<i> again the whole chain starting with reactor.connectTCP.
</I>&gt;<i>
</I>&gt;<i> ---------
</I>&gt;<i>
</I>&gt;<i> I know the pain here with SFTP as there is a lot of wrapping: TCP client,
</I>&gt;<i> SSH high level protocol, SSH session, SSH channel, SSH subsystem.
</I>&gt;<i>
</I>&gt;<i> One option is to use MySSHClientFactory as a proxy for any SFTP operation.
</I>&gt;<i> When the SSH channel is open and you have received the response from the
</I>&gt;<i> subsystem request, pass the SFTP client all the way down to the factory.
</I>&gt;<i> The factory will know when the connection is lost and then trigger a new
</I>&gt;<i> connection... which will update the SFTP client instance on the factory.
</I>&gt;<i>
</I>&gt;<i> That is, instead of getting the SFTP client, the SFTP client will be
</I>&gt;<i> pushed to the factory.
</I>&gt;<i>
</I>&gt;<i> I think that the main issue with your code is that it tries to work
</I>&gt;<i> directly with the SFTP client, instead of using the factory as a proxy for
</I>&gt;<i> SFTP operations.
</I>&gt;<i>
</I>&gt;<i> A protocol represents a single connection that is already made and it
</I>&gt;<i> can't reconnect itself.
</I>&gt;<i> The factory is responsible for handling new connections, or triggering new
</I>&gt;<i> connections.
</I>&gt;<i>
</I>&gt;<i> So, your high-level API is using a very low-level object.
</I>&gt;<i> The SFTP client represents an SSH connection that was already made,
</I>&gt;<i> authenticated and the SFTP subsystem requested.
</I>&gt;<i>
</I>&gt;<i> For my production code I am doing something like this:
</I>&gt;<i> MySSHClientFactory is instantiated with the reactor and the
</I>&gt;<i> SFTPClientOptions.
</I>&gt;<i> Then, when I want to list a directory I call
</I>&gt;<i> sftp_factory.listDir('some/path')
</I>&gt;<i> The factory can then check if it needs to get an SFTP client or reuse an
</I>&gt;<i> existing one.
</I>&gt;<i> A SFTP client is obtained by triggering a new connectTCP to the reactor
</I>&gt;<i> with `self` as the factory.
</I>&gt;<i>
</I>&gt;<i> Does it make sense?
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Adi Roiban
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20200924/ce0015e7/attachment.htm&gt;
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065254.html">[Twisted-Python] Retry: Conch Issues
</A></li>
	<LI>Next message (by thread): <A HREF="065256.html">[Twisted-Python] Retry: Conch Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65255">[ date ]</a>
              <a href="thread.html#65255">[ thread ]</a>
              <a href="subject.html#65255">[ subject ]</a>
              <a href="author.html#65255">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
