<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Retry: Conch Issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Retry%3A%20Conch%20Issues&In-Reply-To=%3CCAFycZ9dmy3EfC5Fz-62Mgr1sOZHknBApVQmfbAFsHH6EehEegA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065252.html">
   <LINK REL="Next"  HREF="065255.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Retry: Conch Issues</H1>
    <B>Adi Roiban</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Retry%3A%20Conch%20Issues&In-Reply-To=%3CCAFycZ9dmy3EfC5Fz-62Mgr1sOZHknBApVQmfbAFsHH6EehEegA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Retry: Conch Issues">adi at roiban.ro
       </A><BR>
    <I>Thu Sep 24 18:35:55 MDT 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065252.html">[Twisted-Python] Retry: Conch Issues
</A></li>
        <LI>Next message (by thread): <A HREF="065255.html">[Twisted-Python] Retry: Conch Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65254">[ date ]</a>
              <a href="thread.html#65254">[ thread ]</a>
              <a href="subject.html#65254">[ subject ]</a>
              <a href="author.html#65254">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

On Fri, 25 Sep 2020 at 00:15, Robert DiFalco &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">robert.difalco at gmail.com</A>&gt;
wrote:

&gt;<i> I am having troubles with Conch. I've been able to reproduce them in a
</I>&gt;<i> unit test and all the code is here along with requirements.txt:
</I>&gt;<i>    <A HREF="https://github.com/radifalco/conch_issues">https://github.com/radifalco/conch_issues</A>
</I>&gt;<i>
</I>&gt;<i> I'm trying to reuse my connection, but if it is idle too long the server
</I>&gt;<i> shuts it down. What I don't understand is why the next call to
</I>&gt;<i> `FileTransferClient` does not call back or errback? It will just hang
</I>&gt;<i> forever even though the Factory and Transport know the connection was
</I>&gt;<i> closed (as evidenced by the log messages).
</I>&gt;<i>
</I>&gt;<i> I don't ever want to hang, if I use FileTransferClient I would like it
</I>&gt;<i> always call a callback or errback. I feel like Conch is missing a deferred
</I>&gt;<i> somewhere but damned if I can find it.
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i> Have you checked
</I><A HREF="https://twistedmatrix.com/documents/current/core/howto/clients.html#reconnection">https://twistedmatrix.com/documents/current/core/howto/clients.html#reconnection</A>
?

I see that `connector.connect()` is commented in your code.

The theory is that once a client connection is lost, you will need to call
again the whole chain starting with reactor.connectTCP.

---------

I know the pain here with SFTP as there is a lot of wrapping: TCP client,
SSH high level protocol, SSH session, SSH channel, SSH subsystem.

One option is to use MySSHClientFactory as a proxy for any SFTP operation.
When the SSH channel is open and you have received the response from the
subsystem request, pass the SFTP client all the way down to the factory.
The factory will know when the connection is lost and then trigger a new
connection... which will update the SFTP client instance on the factory.

That is, instead of getting the SFTP client, the SFTP client will be pushed
to the factory.

I think that the main issue with your code is that it tries to work
directly with the SFTP client, instead of using the factory as a proxy for
SFTP operations.

A protocol represents a single connection that is already made and it can't
reconnect itself.
The factory is responsible for handling new connections, or triggering new
connections.

So, your high-level API is using a very low-level object.
The SFTP client represents an SSH connection that was already made,
authenticated and the SFTP subsystem requested.

For my production code I am doing something like this:
MySSHClientFactory is instantiated with the reactor and the
SFTPClientOptions.
Then, when I want to list a directory I call
sftp_factory.listDir('some/path')
The factory can then check if it needs to get an SFTP client or reuse an
existing one.
A SFTP client is obtained by triggering a new connectTCP to the reactor
with `self` as the factory.

Does it make sense?

-- 
Adi Roiban
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20200925/e5dbe4ce/attachment.htm&gt;
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065252.html">[Twisted-Python] Retry: Conch Issues
</A></li>
	<LI>Next message (by thread): <A HREF="065255.html">[Twisted-Python] Retry: Conch Issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65254">[ date ]</a>
              <a href="thread.html#65254">[ thread ]</a>
              <a href="subject.html#65254">[ subject ]</a>
              <a href="author.html#65254">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
