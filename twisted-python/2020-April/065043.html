<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Help with twisted.conch.manhole
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Help%20with%20twisted.conch.manhole&In-Reply-To=%3C9517e309-3a44-61b1-052b-9d4f5b2067ce%40thieprojects.ch%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065042.html">
   <LINK REL="Next"  HREF="065044.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Help with twisted.conch.manhole</H1>
    <B>Werner Thie</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Help%20with%20twisted.conch.manhole&In-Reply-To=%3C9517e309-3a44-61b1-052b-9d4f5b2067ce%40thieprojects.ch%3E"
       TITLE="[Twisted-Python] Help with twisted.conch.manhole">werner at thieprojects.ch
       </A><BR>
    <I>Sun Apr 19 11:05:25 MDT 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065042.html">[Twisted-Python] Help with twisted.conch.manhole
</A></li>
        <LI>Next message (by thread): <A HREF="065044.html">[Twisted-Python] Help with twisted.conch.manhole
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65043">[ date ]</a>
              <a href="thread.html#65043">[ thread ]</a>
              <a href="subject.html#65043">[ subject ]</a>
              <a href="author.html#65043">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Don't know if this is still state of the art, but I've been using this
off and on and please don't use

checkers.InMemoryUsernamePasswordDatabaseDontUse

HTH, Werner




#### controlling terminal command line server
#
#on port 9999. Connect with
#
#ssh <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">admin at localhost</A> -p 9999
#
#accept new keys and start work
#
from twisted.conch import manhole, manhole_ssh
from twisted.conch.ssh import keys, userauth, factory, connection
from twisted.conch.ssh.transport import SSHServerTransport
from twisted.cred import portal, checkers

&quot;&quot;&quot;
Generate these keys with

$ ckeygen -t rsa -f ssh-keys/ssh_host_rsa_key
$ ckeygen -t rsa -f ssh-keys/client_rsa

ssh_host_rsa_key.pub is the public key file
ssh_host_rsa_key     is the private key file
&quot;&quot;&quot;
publicKey = &quot;&quot;&quot;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAgQCoJSZjqVJdh36RoNvwsTMNlqk8heFV6DxNhhkw3uZ58uyrsnz+7JHGpu56tJAO39WMJPLQfdtyWxCy1P2RRKh65hGznvyt2UaAHdZDMqbNcMlupFPg8P4pCgR+/2M14QSopqysfjgXUJRfR/pD93Ofy0L2N5uEGipTjVAjKwxbzQ== <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">wthie at qubik.local</A>&quot;&quot;&quot;

privateKey = &quot;&quot;&quot;-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQCoJSZjqVJdh36RoNvwsTMNlqk8heFV6DxNhhkw3uZ58uyrsnz+
7JHGpu56tJAO39WMJPLQfdtyWxCy1P2RRKh65hGznvyt2UaAHdZDMqbNcMlupFPg
8P4pCgR+/2M14QSopqysfjgXUJRfR/pD93Ofy0L2N5uEGipTjVAjKwxbzQIDAQAB
AoGBAKD/8WI8HsGvm2GVxQMSqO+58xIgn0LCu/r/C9/fjo/2Kue8YDM4Ed1EudSE
T+vuJ2updVZtLFKzH6ochy8xrp9wbEPhhQqAl8OEvjFa932mSNqg69403qU57eu1
6j0gqE7Z8pQAyM685RwAv4UujRrT1Vi3EmHu8Rvl7/4MRn+BAkEAwBVzxD7XbEoi
lGCoKSvs2JczVIpOOp8s1FCAvsvbRBKzuqLI9N8J9ljM+SalLecalFqsDMJdx4b5
nfPPoK2wswJBAOAYfrih+3pKznkiW56oVlsTBw20baJpD7D9mRBUkURpu/6zaSLh
7mPP5nxnw+92jOmwXW/9/fqSmOT/wNKLAX8CQHxLZWYP5AZG0qmBAk/iBJkC/kwu
UwDMD44zqZvM/k3GbFbRD4ik6yVlwP1YbHqPmTt2kO6Qt25tgQkcw7YNrtECQQDG
xLNR7Utz03qEc3c0qTe/nIb7HvjHv8yNPsNPetNHDUoUxuoQaLncioF0A04Fzu96
MFcQiQeIBBPduwQ7O9TdAkEAvsQWuNmvVFTg0KQLP2Ity5wHSwoIRWjUq19ciHZu
acFIvir+6kDMWEooqY0uXfKx7UUWJAMCjVJztFoSp/jobw==
-----END RSA PRIVATE KEY-----&quot;&quot;&quot;

class ConchSSHFactory(factory.SSHFactory):
    &quot;&quot;&quot;
    This is the entry point of our SSH server implementation.

    The SSH transport layer is implemented by L{SSHTransport} and is the
    protocol of this factory.

    Here we configure the server's identity (host keys) and handlers for the
    SSH services:
    * L{connection.SSHConnection} handles requests for the channel multiplexing
      service.
    * L{userauth.SSHUserAuthServer} handlers requests for the user
      authentication service.
    &quot;&quot;&quot;
    protocol = SSHServerTransport

    services = {
        'ssh-userauth': userauth.SSHUserAuthServer,
        'ssh-connection': connection.SSHConnection
    }

    def __init__(self, portal):
        self.portal = portal
        self.publicKeys = {
            'ssh-rsa': keys.Key.fromString(data=publicKey)
        }
        self.privateKeys = {
            'ssh-rsa': keys.Key.fromString(data=privateKey)
        }


def get_manhole_factory(namespace, **passwords):
    realm = manhole_ssh.TerminalRealm()

    def get_manhole(_):
        return manhole.Manhole(namespace)

    realm.chainedProtocolFactory.protocolFactory = get_manhole
    p = portal.Portal(realm)
    checker = checkers.InMemoryUsernamePasswordDatabaseDontUse(**passwords)
    p.registerChecker(checker)
    return ConchSSHFactory(p)

console = get_manhole_factory(pbRoot.initCommands(), admin='admin')
internet.TCPServer(9999, console, interface='localhost').setServiceParent(application)





For memory debugging I found these few lines helpful

exc = [
  &quot;function&quot;,
  &quot;type&quot;,
  &quot;list&quot;,
  &quot;dict&quot;,
  &quot;tuple&quot;,
  &quot;wrapper_descriptor&quot;,
  &quot;module&quot;,
  &quot;method_descriptor&quot;,
  &quot;member_descriptor&quot;,
  &quot;instancemethod&quot;,
  &quot;builtin_function_or_method&quot;,
  &quot;frame&quot;,
  &quot;classmethod&quot;,
  &quot;classmethod_descriptor&quot;,
  &quot;_Environ&quot;,
  &quot;MemoryError&quot;,
  &quot;_Printer&quot;,
  &quot;_Helper&quot;,
  &quot;getset_descriptor&quot;,
  &quot;weakreaf&quot;
]

inc = [
]

prev = {}

def dumpObjects(delta=True, limit=0, include=inc, exclude=[]):
  global prev
  if include != [] and exclude != []:
    print 'cannot use include and exclude at the same time'
    return
  print 'working with:'
  print '   delta: ', delta
  print '   limit: ', limit
  print ' include: ', include
  print ' exclude: ', exclude
  objects = {}
  gc.collect()
  oo = gc.get_objects()
  for o in oo:
    if getattr(o, &quot;__class__&quot;, None):
      name = o.__class__.__name__
      if ((exclude == [] and include == [])       or \
          (exclude != [] and name not in exclude) or \
          (include != [] and name in include)):
        objects[name] = objects.get(name, 0) + 1
##    if more:
##      print o
  pk = prev.keys()
  pk.sort()
  names = objects.keys()
  names.sort()
  for name in names:
    if limit == 0 or objects[name] &gt; limit:
      if not prev.has_key(name):
        prev[name] = objects[name]
      dt = objects[name] - prev[name]
      if delta or dt != 0:
        print '%0.6d -- %0.6d -- ' % (dt, objects[name]),  name
      prev[name] = objects[name]

def getObjects(oname):
  &quot;&quot;&quot;
  gets an object list with all the named objects out of the sea of
  gc'ed objects
  &quot;&quot;&quot;
  olist = []
  objects = {}
  gc.collect()
  oo = gc.get_objects()
  for o in oo:
    if getattr(o, &quot;__class__&quot;, None):
      name = o.__class__.__name__
      if (name == oname):
        olist.append(o)
  return olist

On 4/19/20 00:03, salil GK wrote:
&gt;<i>     I am real need to debug my python application for memory issues. I
</I>&gt;<i> found that using twisted.conch.manhole we can get a telnet session to
</I>&gt;<i> python interpreter so that we can do some debugging sessions there. I
</I>&gt;<i> am using twisted 16.6 in my server. Could you some one please give me
</I>&gt;<i> some sample program for achieving this.
</I>&gt;<i>
</I>&gt;<i> Thanks ~S
</I>&gt;<i>
</I>&gt;<i> PS: I have posted this message in stack overflow. Sorry for cross
</I>&gt;<i> posting. I have joined this group only today.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20200419/b4713e77/attachment-0001.htm&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065042.html">[Twisted-Python] Help with twisted.conch.manhole
</A></li>
	<LI>Next message (by thread): <A HREF="065044.html">[Twisted-Python] Help with twisted.conch.manhole
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65043">[ date ]</a>
              <a href="thread.html#65043">[ thread ]</a>
              <a href="subject.html#65043">[ subject ]</a>
              <a href="author.html#65043">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
