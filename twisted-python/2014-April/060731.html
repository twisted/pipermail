<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Fwd: Trouble with session id reuse/disabling with	twisted TLS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Fwd%3A%20Trouble%20with%20session%20id%20reuse/disabling%20with%0A%09twisted%20TLS&In-Reply-To=%3CCADB1_gSG9Pqqb0jveS8GbmONiLBsCknONL4wo6fpw-5kGj9F_g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Fwd: Trouble with session id reuse/disabling with	twisted TLS</H1>
    <B>Henrik Thostrup Jensen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Fwd%3A%20Trouble%20with%20session%20id%20reuse/disabling%20with%0A%09twisted%20TLS&In-Reply-To=%3CCADB1_gSG9Pqqb0jveS8GbmONiLBsCknONL4wo6fpw-5kGj9F_g%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Fwd: Trouble with session id reuse/disabling with	twisted TLS">thostrup at gmail.com
       </A><BR>
    <I>Wed Apr 30 10:43:09 MDT 2014</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60731">[ date ]</a>
              <a href="thread.html#60731">[ thread ]</a>
              <a href="subject.html#60731">[ subject ]</a>
              <a href="author.html#60731">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

I have a twisted service, which uses TLS and I seeing some odd behaviour.

New connections are accepted fine, but if a client tries to re-use a
TLS session id with a new connection, the services rejects the
connection.

Poking at the TLS module I added the following line to help me figure
out what was wrong:

@@ -363,11 +365,13 @@
             except ZeroReturnError:
                 # TLS has shut down and no more TLS data will be received over
                 # this connection.
                 self._shutdownTLS()
                 # Passing in None means the user protocol's connnectionLost
                 # will get called with reason from underlying transport:
                 self._tlsShutdownFinished(None)
             except Error as e:
+                log.msg('_flushReceiveBIO Error: %s' % str(e),
system='protocols.TLS')
                 # Something went pretty wrong.  For example, this might be a
                 # handshake failure (because there were no shared
ciphers, because
                 # a certificate failed to verify, etc).  TLS can no
longer proceed.

(I think the above patch would be a nice addition to twisted as
figuring out what goes wrong in the TLS stack is currently quite
difficult).

This gives me the following:

2014-04-30 15:02:08+0200 [protocols.TLS] _flushReceiveBIO Error:
[('SSL routines', 'SSL_GET_PREV_SESSION', 'session id context
uninitialized')]

I am using the same (cached) context for all incoming connections.

Using openssl s_client -connect host:port I can see that the service
returns a session id and master key.

If I disable session cache with:

ctx.set_session_cache_mode(SSL.SESS_CACHE_OFF)

The s_client command still returns session-id and master-key. Which is
rather unexpected.
(I am not using the CertificateOptions class, just SSL.Context)

Code for context creation can be seen here:
<A HREF="https://github.com/NORDUnet/opennsa/blob/master/opennsa/ctxfactory.py">https://github.com/NORDUnet/opennsa/blob/master/opennsa/ctxfactory.py</A>
Without the disabling of session id.

Any idea to what I am doing wrong here?

This is with openssl 1.0.1-4ubuntu5.12, pyOpenSSL 14.1 and Twisted 13.1


  regards, Henrik


</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60731">[ date ]</a>
              <a href="thread.html#60731">[ thread ]</a>
              <a href="subject.html#60731">[ subject ]</a>
              <a href="author.html#60731">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
