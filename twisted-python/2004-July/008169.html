<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Writing a plug-in for an online game that uses UDP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Writing%20a%20plug-in%20for%20an%20online%20game%20that%20uses%20UDP&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008172.html">
   <LINK REL="Next"  HREF="008173.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Writing a plug-in for an online game that uses UDP</H1>
    <B>Ibrahim Mubarak</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Writing%20a%20plug-in%20for%20an%20online%20game%20that%20uses%20UDP&In-Reply-To="
       TITLE="[Twisted-Python] Writing a plug-in for an online game that uses UDP">ibmub80 at yahoo.com
       </A><BR>
    <I>Sun Jul 25 16:31:58 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008172.html">[Twisted-Python] reconnecting ConnectionPools
</A></li>
        <LI>Next message: <A HREF="008173.html">[Twisted-Python] Writing a plug-in for an online game that uses	UDP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8169">[ date ]</a>
              <a href="thread.html#8169">[ thread ]</a>
              <a href="subject.html#8169">[ subject ]</a>
              <a href="author.html#8169">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I am currently writing a server prototype for an online game called &quot;If I Were U&quot; (GPL). It will
be using UDP and a MySQL db. I was successful in writing the code as a plug-in. I love the idea of
being able to seperate in different files the levels of abstraction. But I am not sure of how to
go about the following:
I have an iiwuServer class derived from DatagramProtocol. I defined the datagramReceived method.
This method calls one of my other classes's methods which returns a deferred object (this is where
the connection to the db happens). I am trying to set the callback function for this deferred
object and I want it to be a method of iiwuServer as I need to access the transport member object
which in its turn writes out a datagram to the client. And I am not sure how to set up the
callbackArgs for it (the &quot;self&quot; argument for methods is where I am confused).

What am I doing wrong?

Also, if you have a couple of minutes, can u look at my other three code segments (found after the
iiwuServer) and tell me if you see anything that should be changed. Don't worry, the code is not
that long. The thing is that in the documentation, each part (UDP, plug-in, deferred, etc...) are
very well explained. But when I tried to put all that together, I got a little confused as I did
not see any examples of UDP plug-ins or more complex deferred callback functions.

All these segments are actually files in a folder called UDPServer. If you prefer that I send you
the directory tarred and zipped, let me know. All that is left out is the empty __init__.py file
in the folder.

Thanks a lot,
Ib
<A HREF="http://www.iiwu.org">http://www.iiwu.org</A>

Here is the code for the protocol (file name: iiwuserverprotocol.py):
////////CODE START\\\\\\\\
############################
##This is where the UDP packets are recieved and then sent to the server logic
############################
from twisted.internet.protocol import DatagramProtocol
from UDPServer import iiwuserverlogic

class iiwuServer(DatagramProtocol):
    iiwuservice = iiwuserverlogic.LoginService()
    def sendingOutput(self, result, host, port):
        &quot;&quot;&quot;
            A callback for the deferred object returned
        &quot;&quot;&quot;
        self.transport.write(str(result) + &quot;\n&quot; + str(self) + &quot;\n&quot;, (host, port))
        return
    
    def datagramReceived(self, data, (host, port)):
        msg = data.split()
        if len(msg) != 1 and len(msg) != 3:
            self.sendingOutput(&quot;error&quot; , host, port)
            return
        
        if msg[0] == &quot;log&quot; and len(msg) == 3:
            user = msg[1]
            pswd = msg[2]
            self.iiwuservice.logUser(user, pswd, host, port).addCallback(self.sendingOutput(self,
host, port))
            return 
        
        if msg[0] == &quot;get&quot;:
            self.iiwuservice.loggedUsers().addCallback(self.sendingOutput(self, host, port))
            return 
            
        return    
\\\\\\\\CODE END////////

Here is the code for the server's logic (file name: iiwuserverlogic.py):
////////CODE START\\\\\\\\
##############################
##This is where all the logic of the server lies
##############################
from twisted.python import components
from twisted.enterprise import adbapi 
class IService(components.Interface):
    &quot;&quot;&quot;
        An object that recieves messages.
    &quot;&quot;&quot;

class LoginService:
    &quot;&quot;&quot;
        Respond to different messages
    &quot;&quot;&quot;
    __implements__ = IService

    def __init__(self):
        &quot;&quot;&quot;
            Setting up the db connection pool
        &quot;&quot;&quot;
        self.dbpool = adbapi.ConnectionPool(&quot;MySQLdb&quot;, 'database_name', 'login', 'password')
        return
        
    def mysqlQuery(self, q):
        &quot;&quot;&quot;
            Run a MySql query and return the result
        &quot;&quot;&quot;
        result = self.dbpool.runQuery(q)
        return result  #Returning a Deferred object
        
    def logUser(self, name, pswd, ip, port):
        &quot;&quot;&quot;
            Connects to the DB and logs the user, returning nothing
        &quot;&quot;&quot;
        query = &quot;INSERT INTO users (name, pswd, ip, port) VALUES (%s, %s, %s, %s)&quot; % (name, pswd,
ip, port)
        return self.mysqlQuery(query)
        
    def loggedUsers(self):
        &quot;&quot;&quot;
            Connects to the DB and returns a list of the users logged in
        &quot;&quot;&quot;
        query = &quot;SELECT * FROM users&quot;
        return self.mysqlQuery(query)
\\\\\\\\CODE END////////

Here is the code for the tap construction (file name: servertap.py):
////////CODE START\\\\\\\\
from twisted.application import internet    # services that run TCP/SSL/etc.
from UDPServer import iiwuserverprotocol    # Protocol
from UDPServer import iiwuserverlogic       # Server code
from twisted.python import usage            # twisted command-line processing

class Options(usage.Options):
    &quot;&quot;&quot;
        Defining options when building the application
    &quot;&quot;&quot;
    optParameters = [[&quot;port&quot;, &quot;p&quot;, 8007, &quot;Port number to listen on for iiwuServer protocol.&quot;]]

def makeService(config):
    &quot;&quot;&quot;
        Return a service that will be attached to the application.
    &quot;&quot;&quot;
    protocol = iiwuserverprotocol.iiwuServer()
    port = int(config[&quot;port&quot;])          # UCP port to listen on
    # Finally, set up our protocol when events arrive on the specified port
    return internet.UDPServer(port, protocol)
\\\\\\\\CODE END////////

Finally, here is the plugins.tml file:
////////CODE START\\\\\\\\
register(&quot;IIWU Server TAP Builder&quot;,
         &quot;UDPServer.servertap&quot;,
         description=&quot;&quot;&quot;
         IIWU TAP builder module.
         &quot;&quot;&quot;            ,
         type=&quot;tap&quot;,
         tapname=&quot;iiwuserv&quot;)
\\\\\\\\CODE END////////



	
		
__________________________________
Do you Yahoo!?
New and Improved Yahoo! Mail - 100MB free storage!
<A HREF="http://promotions.yahoo.com/new_mail">http://promotions.yahoo.com/new_mail</A> 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008172.html">[Twisted-Python] reconnecting ConnectionPools
</A></li>
	<LI>Next message: <A HREF="008173.html">[Twisted-Python] Writing a plug-in for an online game that uses	UDP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8169">[ date ]</a>
              <a href="thread.html#8169">[ thread ]</a>
              <a href="subject.html#8169">[ subject ]</a>
              <a href="author.html#8169">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
