<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] sharing a dict between child processes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20sharing%20a%20dict%20between%20child%20processes&In-Reply-To=%3CCAJuJkHPzCQ_sGJKYPTC4S7sFK7-rY_p891h-hiPkJ38NLK8k0g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032491.html">
   <LINK REL="Next"  HREF="032493.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] sharing a dict between child processes</H1>
    <B>Waqar Khan</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20sharing%20a%20dict%20between%20child%20processes&In-Reply-To=%3CCAJuJkHPzCQ_sGJKYPTC4S7sFK7-rY_p891h-hiPkJ38NLK8k0g%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] sharing a dict between child processes">wk80333 at gmail.com
       </A><BR>
    <I>Wed Nov  6 09:35:27 MST 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032491.html">[Twisted-Python] sharing a dict between child processes
</A></li>
        <LI>Next message (by thread): <A HREF="032493.html">[Twisted-Python] sharing a dict between child processes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32492">[ date ]</a>
              <a href="thread.html#32492">[ thread ]</a>
              <a href="subject.html#32492">[ subject ]</a>
              <a href="author.html#32492">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Marteen,
  Thanks for the response.
When you say &quot;when one process mutates the dictionary while another is
looking up something or also mutating it.&quot;  Do you mean that a key/value
pair is getting modified or is it that a dict, in general, is getting
modified.
The first one is not really a concern as the key to value mapping is
unique(so all the processes will require the same value for same key). So
read/write  to dict doesnt really have to be &quot;threadsafe&quot; or anything like
that.
But, dict getting modified and made available across rest of the processes
will be common.

The thing is, the major cost of our task is I/O. So, when a request comes
in we fetch some data and then cache it. Now, each processes has their own
cache and that is very inefficient. One idea is to share the cache across
processes.
Does that make sense?
Thanks for the help.



On Wed, Nov 6, 2019 at 6:22 AM Maarten ter Huurne &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">maarten at treewalker.org</A>&gt;
wrote:

&gt;<i> On Wednesday, 6 November 2019 07:19:56 CET Waqar Khan wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt; So, I am writing a twisted server. This server spawn multiple child
</I>&gt;<i> &gt; processes using reactor spawnProcess that initializes a process
</I>&gt;<i> &gt; protocol.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Now, each of the childprocess receives some REST requests. Each
</I>&gt;<i> &gt; process has a dict that acts as cache.
</I>&gt;<i> &gt; Now, I want to share dict across processes.
</I>&gt;<i> &gt; In general, python has SharedMemoryManager in multiprocessing module
</I>&gt;<i> &gt; which would have helped.
</I>&gt;<i> &gt; <A HREF="https://docs.python.org/3/library/multiprocessing.shared_memory.html#m">https://docs.python.org/3/library/multiprocessing.shared_memory.html#m</A>
</I>&gt;<i> &gt; ultiprocessing.managers.SharedMemoryManager.SharedMemory But since I
</I>&gt;<i> &gt; am using twisted internal process implementation, how do I share this
</I>&gt;<i> &gt; dict across the processes so that all the processes use this common
</I>&gt;<i> &gt; cache?
</I>&gt;<i>
</I>&gt;<i> Keeping a dictionary in SharedMemoryManager seems far from trivial. I
</I>&gt;<i> don't think you can allocate arbitrary Python objects in the shared
</I>&gt;<i> memory and even if you could, you would run into problems when one
</I>&gt;<i> process mutates the dictionary while another is looking up something or
</I>&gt;<i> also mutating it.
</I>&gt;<i>
</I>&gt;<i> It could in theory work if you implement a custom lock-less dictionary,
</I>&gt;<i> but that would be a lot of work and hard to get right. Also having
</I>&gt;<i> shared memory mutations be synced between multiple CPU cores could
</I>&gt;<i> degrade performance, since keeping core-local CPU caches in sync is
</I>&gt;<i> expensive.
</I>&gt;<i>
</I>&gt;<i> Would it be an option to have only one process accept the REST requests,
</I>&gt;<i> check whether the result is in the cache and only distribute work to the
</I>&gt;<i> other processes if you get a cache miss? Typically the case where an
</I>&gt;<i> answer is cached is pretty fast, so perhaps you don't need multiple
</I>&gt;<i> processes to handle incoming requests.
</I>&gt;<i>
</I>&gt;<i> Bye,
</I>&gt;<i>                 Maarten
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20191106/434483aa/attachment.html&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032491.html">[Twisted-Python] sharing a dict between child processes
</A></li>
	<LI>Next message (by thread): <A HREF="032493.html">[Twisted-Python] sharing a dict between child processes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32492">[ date ]</a>
              <a href="thread.html#32492">[ thread ]</a>
              <a href="subject.html#32492">[ subject ]</a>
              <a href="author.html#32492">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
