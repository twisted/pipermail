<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] AMP Argument.toBox's proto argument is a locator,	not the proto?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20AMP%20Argument.toBox%27s%20proto%20argument%20is%20a%20locator%2C%0A%09not%20the%20proto%3F&In-Reply-To=%3CCAE_Hg6a6cPQMF4XXAHwLFSKL-%3DLEbDgVBM6t4Y93oMcmfuR6Ug%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] AMP Argument.toBox's proto argument is a locator,	not the proto?</H1>
    <B>Laurens Van Houtven</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20AMP%20Argument.toBox%27s%20proto%20argument%20is%20a%20locator%2C%0A%09not%20the%20proto%3F&In-Reply-To=%3CCAE_Hg6a6cPQMF4XXAHwLFSKL-%3DLEbDgVBM6t4Y93oMcmfuR6Ug%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] AMP Argument.toBox's proto argument is a locator,	not the proto?">_ at lvh.io
       </A><BR>
    <I>Mon Sep 30 03:45:39 MDT 2013</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59946">[ date ]</a>
              <a href="thread.html#59946">[ thread ]</a>
              <a href="subject.html#59946">[ subject ]</a>
              <a href="author.html#59946">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone,


I think I've hit one of those cases where AMP really seems to want
everything (locator, receiver, sender) to be an instance of t.p.amp.AMP :-(

I've written some code that tries to multiplex stream transports over AMP:

<A HREF="https://github.com/lvh/txampext/blob/multiplexing/txampext/multiplexing.py">https://github.com/lvh/txampext/blob/multiplexing/txampext/multiplexing.py</A>

The repo contains an example server and client, which demonstrate the issue:

<A HREF="https://github.com/lvh/txampext/blob/multiplexing/docs/examples/multiplexing_client.py">https://github.com/lvh/txampext/blob/multiplexing/docs/examples/multiplexing_client.py</A>
<A HREF="https://github.com/lvh/txampext/blob/multiplexing/docs/examples/multiplexing_server.py">https://github.com/lvh/txampext/blob/multiplexing/docs/examples/multiplexing_server.py</A>

In order to do some of this multiplexing, I need access to the protocol
instance inside the responder on the server side. Fortunately, I already
had some code that exposed box senders (after a lot of advice from Glyph).
I modified it to expose the protocol as well:

<A HREF="https://github.com/lvh/txampext/blob/multiplexing/txampext/exposed.py#L41">https://github.com/lvh/txampext/blob/multiplexing/txampext/exposed.py#L41</A>

However, it turns out fromBox gets called with the *responder locator* as
the &quot;proto&quot; argument, not the actual protocol.

The server has a pudb call that makes it easy (?!) to trace this down. The
CommandLocator class, inside doit (a function defined in
_wrapWithSerialization) passes &quot;self&quot; to command.parseArguments:

<A HREF="https://twistedmatrix.com/trac/browser/trunk/twisted/protocols/amp.py#L1015">https://twistedmatrix.com/trac/browser/trunk/twisted/protocols/amp.py#L1015</A>

This is the part where I think the contract is broken, since parseArguments
claims to want the protocol (well, it says it wants the AMP protocol,
which, subclassing everything, is also all of the things, of course), but
receives the responder locator.

What am I doing wrong? Is this a bug?

confusedly,
lvh
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20130930/027bb877/attachment-0002.html&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59946">[ date ]</a>
              <a href="thread.html#59946">[ thread ]</a>
              <a href="subject.html#59946">[ subject ]</a>
              <a href="author.html#59946">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
