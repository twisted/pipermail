<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted thumbnail server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20thumbnail%20server&In-Reply-To=%3CCACgdh2g_B1-b6Cz8dwgR1A8CUAHoSL14TJEX2vXTwTFuW8uRKA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="058731.html">
   <LINK REL="Next"  HREF="058735.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted thumbnail server</H1>
    <B>Paul Wiseman</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20thumbnail%20server&In-Reply-To=%3CCACgdh2g_B1-b6Cz8dwgR1A8CUAHoSL14TJEX2vXTwTFuW8uRKA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] twisted thumbnail server">poalman at gmail.com
       </A><BR>
    <I>Fri Nov  2 10:50:03 MDT 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="058731.html">[Twisted-Python] twisted thumbnail server
</A></li>
        <LI>Next message (by thread): <A HREF="058735.html">[Twisted-Python] Weekly Bug Summary
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58734">[ date ]</a>
              <a href="thread.html#58734">[ thread ]</a>
              <a href="subject.html#58734">[ subject ]</a>
              <a href="author.html#58734">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2 November 2012 16:13, Phil Mayers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">p.mayers at imperial.ac.uk</A>&gt; wrote:

&gt;<i> On 02/11/12 15:42, Paul Wiseman wrote:
</I>&gt;<i> &gt; I hope this will be an easy question for some of you guys :)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm trying to set up a simple server which will accept requests over GET
</I>&gt;<i> &gt; to create a thumbnail for an image, and server it back as the response.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The images are stored in two S3 buckets, the originals are in one bucket
</I>&gt;<i> &gt; (store), and the generated thumbnails are stored in another (thumb) as a
</I>&gt;<i> &gt; cache so that the work doesn't need to be repeated.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Currently I'm checking if the thumbnail already exists in the thumb
</I>&gt;<i> &gt; bucket. I'm redirecting the request if it is or if not I'm downloading
</I>&gt;<i> &gt; the image from store, generating the thumb using PIL, uploading the
</I>&gt;<i> &gt; thumbnail to the thumb bucket and then redirecting the request.
</I>&gt;<i>
</I>&gt;<i> This isn't a criticism, but I trust you are aware of the implications
</I>&gt;<i> and problems of doing work in threads?
</I>



I think so. I understand the whole idea of twisted is to schedule tasks in
an async way in a single main thread. I usually use quite a lot of threads
in my code and I'm just learning about this new async style of coding. I've
tried to avoid using threads as much as I can here but didn't think I could
get away from them based on the fact that PIL is blocking.


&gt;<i> FWIW we usually use a child process pool for intensive tasks; this has
</I>&gt;<i> the advantage you can sensibly kill a long-lived child (just kill the
</I>&gt;<i> process) and you side-step the lack of concurrency in the python
</I>&gt;<i> interpreter.
</I>&gt;<i>
</I>
&gt;<i> [In this case, I'd just start up a bunch of python interpreters using a
</I>&gt;<i> ProcessProtocol and use a simple request/response command protocol on
</I>&gt;<i> stdin/stdout - the child interpreters can be non-Twisted processes able
</I>&gt;<i> to block on PIL operations]
</I>&gt;<i>
</I>&gt;<i>
</I>I'd love to get this working using a processes pool rather than a thread
pool (I spent quite a lot of time trying to figure out how to do it in
twisted but haven't yet worked out how). As this server will be CPU bound
this will hopefully get more throughput and also side-step the memory leak
in PIL that I believe I'm seeing (although on second thought maybe not, the
over head of starting a new python interpreter each time wouldn't be
viable).

Are there any examples of how to use a process pool?


&gt;<i> If you really do want threads, is there any reason to not use the
</I>&gt;<i> Twisted threadpool stuff?
</I>&gt;<i>
</I>&gt;<i>
</I>I wasn't aware of a twisted thread pool, I think I've only come across
deferToThead, which I imagined was using a threadpool. (if so if there a
way to control the size?)


&gt;<i> It's often a personal/style choice, but I don't use StringIO for large
</I>&gt;<i> volumes of data personally (not Twisted-specific).
</I>&gt;<i>
</I>&gt;<i>
</I>I rarely use it either, but I needed a way to get the data into a file type
object for PIL without putting the data to disk. How would you recommend I
get the data between download / PIL / upload?


&gt;<i> I'm sure someone will mention tests ;o)
</I>

&gt;<i>
</I>
tests are something I've often, guiltily, neglected- maybe I should start
:<i>) I wouldn't really know where to start writing tests for anything more
</I>than trivial functions. I guess just have images and thumbnails that I know
are correct for that request, send them to the server and see if they
return a thumbnail that matches? something along those lines?


&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20121102/5ade186a/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="058731.html">[Twisted-Python] twisted thumbnail server
</A></li>
	<LI>Next message (by thread): <A HREF="058735.html">[Twisted-Python] Weekly Bug Summary
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58734">[ date ]</a>
              <a href="thread.html#58734">[ thread ]</a>
              <a href="subject.html#58734">[ subject ]</a>
              <a href="author.html#58734">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
