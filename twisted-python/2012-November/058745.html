<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted Conch - Flow control
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20Conch%20-%20Flow%20control&In-Reply-To=%3CCAOp9P3pk02ozo51QCgZkp4wsy14Nh-LgFL0N%3Dgdhssj2-repNg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="058742.html">
   <LINK REL="Next"  HREF="058746.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted Conch - Flow control</H1>
    <B>Itamar Turner-Trauring</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20Conch%20-%20Flow%20control&In-Reply-To=%3CCAOp9P3pk02ozo51QCgZkp4wsy14Nh-LgFL0N%3Dgdhssj2-repNg%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Twisted Conch - Flow control">itamar at futurefoundries.com
       </A><BR>
    <I>Wed Nov  7 05:30:49 MST 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="058742.html">[Twisted-Python] Twisted Conch - Flow control
</A></li>
        <LI>Next message (by thread): <A HREF="058746.html">[Twisted-Python] Twisted Conch - Flow control
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58745">[ date ]</a>
              <a href="thread.html#58745">[ thread ]</a>
              <a href="subject.html#58745">[ subject ]</a>
              <a href="author.html#58745">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Nov 6, 2012 at 10:49 PM, Matt Freeman &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">matt at nonuby.com</A>&gt; wrote:

&gt;<i> I asked this question on  Stackoverflow (even offered a bounty) and IRC:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://stackoverflow.com/questions/13117502/twisted-conch-flow-control">http://stackoverflow.com/questions/13117502/twisted-conch-flow-control</A>
</I>&gt;<i> --
</I>&gt;<i>
</I>&gt;<i> I have a Twisted Conch SSH server and the typical scenario is this:
</I>&gt;<i>
</I>&gt;<i> git via OpenSSH client &gt;&gt;--- WAN1 ---&gt;&gt; Twisted conch svr &gt;&gt;--- WAN2 --&gt;&gt;
</I>&gt;<i> Git server
</I>&gt;<i>
</I>&gt;<i> There will be occassions that the 'git push' is sending data faster over
</I>&gt;<i> WAN1 than I can proxy it over WAN2, so I need to tell the client to slow
</I>&gt;<i> down (well before any TCP packet loss causes adjustments the TCP window
</I>&gt;<i> size) to avoid buffering too much on the Twisted server. Reading the RFC
</I>&gt;<i> for SSH this is accomplished with not acknowledging via adj window this
</I>&gt;<i> will then cause the git push to block on syscall write to the pipe backed
</I>&gt;<i> by openssh.
</I>&gt;<i>
</I>&gt;<i> Looking at conch/ssh/connection.py:L216 in the method def
</I>&gt;<i> ssh_CHANNEL_DATA(self, packet): I can accomplish this with setting
</I>&gt;<i> localWindowSize to 0, and inflight data will still land as the predicate on
</I>&gt;<i> 230 should still pass (give localWindowLeft). I am wondering if this is the
</I>&gt;<i> correct approach or am I missing something blindly obvious with regards to
</I>&gt;<i> flow control with Twisted SSH Conch? *
</I>&gt;<i>
</I>&gt;<i> Note: I acknowledge there are methods placeholders for stopWriting and
</I>&gt;<i> startWriting on (channel) that I can override so I have hooks to control
</I>&gt;<i> the other side of the transmission 'git pull', but Im interested in first
</I>&gt;<i> leg. Also IPush/IPull producer dont seem applicable at this level and I
</I>&gt;<i> cant see how I can tie in these higher abstraction without butchering conch?
</I>&gt;<i>
</I>The general non-SSH specific answer is to use the producer API. Something
like:

    wan2transport.registerProducer(wan1transport, True)

Assuming WAN2 is also over SSH (it wasn't quite clear), SSHChannel ideally
should implement the producer and consumer APIs so you could do:

    wan2channel.registerProducer(wan1channel, True)

But, as you say, it doesn't implement those APIs. Thus it looks like you'd
want to subclass SSHChannel, and have wan2's SSHChannel.stop/startWriting
call pause/resumeProducing on the WAN1 channel's *transport*
(SSHConnection). Unless you have multiple channels in your incoming SSH
connection that you want to pause/resume separately, and it doesn't sound
like you do, this should work.

twisted.conch.scripts.conch.SSHSession has an example of this, more or
less, except that it's pausing reading from stdin rather than another SSH
connection.

-- 
Itamar Turner-Trauring, Future Foundries LLC
<A HREF="http://futurefoundries.com/">http://futurefoundries.com/</A> â€” Twisted consulting, training and support.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20121107/55506829/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="058742.html">[Twisted-Python] Twisted Conch - Flow control
</A></li>
	<LI>Next message (by thread): <A HREF="058746.html">[Twisted-Python] Twisted Conch - Flow control
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58745">[ date ]</a>
              <a href="thread.html#58745">[ thread ]</a>
              <a href="subject.html#58745">[ subject ]</a>
              <a href="author.html#58745">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
