<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted thumbnail server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20thumbnail%20server&In-Reply-To=%3CCACgdh2jqt_4xv25P4QTBX6341mC5Dm-tdRE%3DYjrL8LQ5vL7WKQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="058730.html">
   <LINK REL="Next"  HREF="058731.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted thumbnail server</H1>
    <B>Paul Wiseman</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20thumbnail%20server&In-Reply-To=%3CCACgdh2jqt_4xv25P4QTBX6341mC5Dm-tdRE%3DYjrL8LQ5vL7WKQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] twisted thumbnail server">poalman at gmail.com
       </A><BR>
    <I>Fri Nov  2 10:32:42 MDT 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="058730.html">[Twisted-Python] twisted thumbnail server
</A></li>
        <LI>Next message (by thread): <A HREF="058731.html">[Twisted-Python] twisted thumbnail server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58733">[ date ]</a>
              <a href="thread.html#58733">[ thread ]</a>
              <a href="subject.html#58733">[ subject ]</a>
              <a href="author.html#58733">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2 November 2012 15:57, Laurens Van Houtven &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">_ at lvh.cc</A>&gt; wrote:

&gt;<i> Yeah, very big +1 to showing the deferToThread version. I feel bad even
</I>&gt;<i> trying to spot potential threading issues here... It could be because the
</I>&gt;<i> default thread pool isn't very large, but you're making many requests.
</I>&gt;<i>
</I>&gt;<i> What functionality does boto have that txaws doesn't that you really need
</I>&gt;<i> here? Perhaps you can avoid blocking (and hence threads) at all.
</I>&gt;<i>
</I>&gt;<i>
</I>This is the deferToThread version:
<A HREF="https://github.com/GP89/thumbs/blob/defertothread/thumb.py">https://github.com/GP89/thumbs/blob/defertothread/thumb.py</A>

The thread pool size was 60, pretty arbitrary but (ignoring the memory
leaks) it should only have at most n images in memory at once where n is
the number of threads. If there's more requests that it can process they'll
just build up in the queue and not cause memory to fill up with downloaded
images (this was an initial problem I had).

My understanding is that txaws would only work in a twisted way, but as the
work in the thread has blocking code (the PIL bits) I just used boto as I'm
more familiar with it. I'm not sure how I'd use txaws in a thread or what
benefit that would have?

I'd love to avoid blocking and keep it all in 1 thread, but I don't know of
anyway to do the image resizing/rotation etc. without blocking.


&gt;<i>
</I>&gt;<i> On Fri, Nov 2, 2012 at 4:42 PM, Paul Wiseman &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">poalman at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I hope this will be an easy question for some of you guys :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm trying to set up a simple server which will accept requests over GET
</I>&gt;&gt;<i> to create a thumbnail for an image, and server it back as the response.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The images are stored in two S3 buckets, the originals are in one bucket
</I>&gt;&gt;<i> (store), and the generated thumbnails are stored in another (thumb) as a
</I>&gt;&gt;<i> cache so that the work doesn't need to be repeated.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Currently I'm checking if the thumbnail already exists in the thumb
</I>&gt;&gt;<i> bucket. I'm redirecting the request if it is or if not I'm downloading the
</I>&gt;&gt;<i> image from store, generating the thumb using PIL, uploading the thumbnail
</I>&gt;&gt;<i> to the thumb bucket and then redirecting the request.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm very new to twisted and was wondering if anyone who is more
</I>&gt;&gt;<i> experienced would be able to take a look at what I have so far and let me
</I>&gt;&gt;<i> know if anything is wrong/not ideal/will cause problems etc. or just
</I>&gt;&gt;<i> general style pointers? The more critical the better, as I said I'm very
</I>&gt;&gt;<i> new to this.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've just chucked it up on github:
</I>&gt;&gt;<i> <A HREF="https://github.com/GP89/thumbs/blob/master/thumb.py">https://github.com/GP89/thumbs/blob/master/thumb.py</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There's a definite memory leak right now which I believe is PIL, or
</I>&gt;&gt;<i> possibly StringIO objects not being disposed, hence all the random del
</I>&gt;&gt;<i> statements trying to cure it (unsuccessfully). Maybe there's something I'm
</I>&gt;&gt;<i> doing wrong in twisted that is causing things not to be cleaned up that I'm
</I>&gt;&gt;<i> not aware of as well.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I did try to use deferToThread, rather than my thread pool but the server
</I>&gt;&gt;<i> seemed to block up- I probably should have left it incase it was because I
</I>&gt;&gt;<i> was doing something obviously wrong. I think I'll make a branch quickly
</I>&gt;&gt;<i> with my deferToThread version.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks very much for any time you can lend!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Paul
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> cheers
</I>&gt;<i> lvh
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20121102/245957f1/attachment-0001.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="058730.html">[Twisted-Python] twisted thumbnail server
</A></li>
	<LI>Next message (by thread): <A HREF="058731.html">[Twisted-Python] twisted thumbnail server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58733">[ date ]</a>
              <a href="thread.html#58733">[ thread ]</a>
              <a href="subject.html#58733">[ subject ]</a>
              <a href="author.html#58733">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
