<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Quan Nguyen: Twisted Python questions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Quan%20Nguyen%3A%20Twisted%20Python%20questions&In-Reply-To=%3C7BB2F22B51197D40B59E42E2B076261929D52C3A%40OC11EXPO31.exchange.mit.edu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="058101.html">
   <LINK REL="Next"  HREF="058110.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Quan Nguyen: Twisted Python questions</H1>
    <B>Quan Nguyen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Quan%20Nguyen%3A%20Twisted%20Python%20questions&In-Reply-To=%3C7BB2F22B51197D40B59E42E2B076261929D52C3A%40OC11EXPO31.exchange.mit.edu%3E"
       TITLE="[Twisted-Python] Quan Nguyen: Twisted Python questions">qdnguyen at MIT.EDU
       </A><BR>
    <I>Tue Jun 12 14:53:50 MDT 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="058101.html">[Twisted-Python] I will try to beef up the mailing list's anti-spam	filters now
</A></li>
        <LI>Next message (by thread): <A HREF="058110.html">[Twisted-Python] Quan Nguyen: Twisted Python questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58103">[ date ]</a>
              <a href="thread.html#58103">[ thread ]</a>
              <a href="subject.html#58103">[ subject ]</a>
              <a href="author.html#58103">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I am new to Twisted. 
I am extending the twisted Echo server example by sending the data that the server receives from telnet into a child process that processes the data. The function outReceived in censoringProtocol is called when the child writes the result and the result is received. The process of passing data from parent to child and back to parent is done by having a while loop of stdin.readline() and stdout.write() in the child process. 
Specifically, I generate a deferred object each time I write to the child using the function sendData (which then calls writeToChild) and use a queue to manage the deferred objects. I add a callBack (printData) that will broadcast the result to all instances of Echo when outReceived is called. 

I have two questions: 
1/ Is this the right approach to communicate with the child process in order to achieve what I want? Are there any gotcha's?
2/ This server will be exposed to high loads. There will be many instances of Echo sending data to the child at a high rate. Are there any limitations that I have to watch for, such as the limit on child process's pipe sizes or anything else?

My code is down below, as well as in this link:
<A HREF="https://gist.github.com/2920032">https://gist.github.com/2920032</A>

Thank You for your time.
Quan Nguyen


from sys import executable
from os import environ
from twisted.internet import reactor, defer
from twisted.internet.protocol import Protocol
from twisted.internet.protocol import Factory
from twisted.internet import protocol
from twisted.protocols.basic import LineReceiver
import sys
import time
import Queue
import os

implementation = &quot;&quot;&quot;
import os
import time
import sys
import string
def censor():
        BW = [&quot;sfs&quot;, &quot;fsdfwe&quot;, &quot;tryt&quot;, &quot;sfsvx&quot;]
        while (True):
            a = sys.stdin.readline()
            if a:
                   for bannedWord in BW:
                        a = string.replace(a, bannedWord , '&lt;banned&gt;')
                   sys.stdout.write(a)
                   sys.stdout.flush()
&quot;&quot;&quot;

class Echo(LineReceiver):
        def lineReceived(self, data):
            d = self.factory.process.sendData(data+'\r\n')
            #reactor.callLater(3,d.addCallback, printData)
            d.addCallback(printData)
            prot.transport.write(data)

def createProcess():
    pp = censoringProtocol()
    Process = reactor.spawnProcess(pp, executable, [executable, &quot;-c&quot;, implementation], env=environ, childFDs = {0:&quot;w&quot;, 1:&quot;r&quot;, 2:&quot;r&quot;})
    pp.process = Process
    return pp    

class EchoFactory(Factory): 
      protocol = Echo 
      telnetConnectionList  = []
      process  = None
      deferQ   = None

      def __init__(self):
          EchoFactory.process = createProcess()
          EchoFactory.deferQ  = Queue.Queue()
      def buildProtocol (self, addr):
          newProtocol = Factory.buildProtocol(self, addr)
          EchoFactory.telnetConnectionList.append(newProtocol)
          return newProtocol

class censoringProtocol(protocol.ProcessProtocol):

    def __init__(self):
        self.process = None

    def connectionMade(self):
        print &quot;connectionMade!&quot;

    def outReceived(self, data):
        EchoFactory.deferQ.get().callback(data)

    def sendData(self,data):
        d = defer.Deferred()
        EchoFactory.deferQ.put(d)
        self.process.writeToChild(0, data)
        return d



reactor.listenTCP(11111, EchoFactory())
print 'in parent', os.getpid()
reactor.run()



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="058101.html">[Twisted-Python] I will try to beef up the mailing list's anti-spam	filters now
</A></li>
	<LI>Next message (by thread): <A HREF="058110.html">[Twisted-Python] Quan Nguyen: Twisted Python questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58103">[ date ]</a>
              <a href="thread.html#58103">[ thread ]</a>
              <a href="subject.html#58103">[ subject ]</a>
              <a href="author.html#58103">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
