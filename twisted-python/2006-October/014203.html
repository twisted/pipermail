<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Newbie question on how to send &quot;complex&quot; objects	over the wire
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Newbie%20question%20on%20how%20to%20send%20%22complex%22%20objects%0A%09over%20the%20wire&In-Reply-To=20061018005953.26151.650655603.divmod.quotient.5370%40ohm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014201.html">
   <LINK REL="Next"  HREF="014204.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Newbie question on how to send &quot;complex&quot; objects	over the wire</H1>
    <B>Franz Zieher</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Newbie%20question%20on%20how%20to%20send%20%22complex%22%20objects%0A%09over%20the%20wire&In-Reply-To=20061018005953.26151.650655603.divmod.quotient.5370%40ohm"
       TITLE="[Twisted-Python] Newbie question on how to send &quot;complex&quot; objects	over the wire">franz.zieher at gmail.com
       </A><BR>
    <I>Wed Oct 18 17:42:16 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="014201.html">[Twisted-Python] Newbie question on how to send &quot;complex&quot;	objects over the wire
</A></li>
        <LI>Next message: <A HREF="014204.html">[Twisted-Python] Newbie question on how to send &quot;complex&quot;	objects over the wire
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14203">[ date ]</a>
              <a href="thread.html#14203">[ thread ]</a>
              <a href="subject.html#14203">[ subject ]</a>
              <a href="author.html#14203">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>2006/10/18, Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt;:
&gt;<i>
</I>&gt;<i> On Tue, 17 Oct 2006 22:51:55 -0200, Felipe Almeida Lessa &lt;
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">felipe.lessa at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;2006/10/17, Franz Zieher &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">franz.zieher at gmail.com</A>&gt;:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;Can anybody provide a an example on how I would best send
</I>&gt;<i> &gt;&gt;a data structure (i.e. an ElemenTree from elementtree) over from
</I>&gt;<i> &gt;&gt;a server to a client process. I followed somewhat the example in
</I>&gt;<i> &gt;&gt;the documentation and used the perspective broker &quot;pb&quot; to send
</I>&gt;<i> &gt;&gt;an &quot;simple&quot; structure (some class with simple members)
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;When I changed to a more complex class definition, I obviously got
</I>&gt;<i> &gt;&gt;an InsecureJelly exception.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;I'm sure this question must have come up a number of times. I'm new
</I>&gt;<i> &gt;&gt;in using twisted and not everything is so obvious at the beginning to me
</I>&gt;<i> &gt;&gt;:-(
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I don't know if it may help you, but I think you should take a look at
</I>&gt;<i> &gt;Cerealizer ( <A HREF="http://home.gna.org/oomadness/en/cerealizer/index.html">http://home.gna.org/oomadness/en/cerealizer/index.html</A> )
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Using this together with PB would probably be counterproductive.
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>

Thanks for the help. I opted for Jean-Pauls suggestion.
It really allows for such a simple data transfer between a server
and a client. I included a compressed string. It very likely misses
a number of details, I post the changes again. Maybe it is helpful
for somebody else.

Franz :-)

----------- pbsimple.py

from twisted.spread import pb, jelly
from twisted.internet import reactor
import elementtree.ElementTree as ET
from path import path
import os, pickle
from StringIO import StringIO
from zlib import compress

class test:
  def __init__(self):
    x = 3.
    y = 4.
    data = ET.ElementTree()

class Bag:
  def setContent(self,content):
    # content must be serializable
    s_content = StringIO()
    pickle.dump(content,s_content)
    s_content.flush()
    self.content = compress(s_content.getvalue())

class CopyBag(Bag, pb.Copyable):
  pass

class Sender(pb.Root):
  def __init__(self, bag):
    self.bag = bag

  def remote_sendBag(self, remote):
    self.remote = remote
    d = remote.callRemote(&quot;takeBag&quot;, self.bag)
    d.addCallback(self.ok).addErrback(self.notOk)

  def ok(self, response):
    print &quot;info: %s&quot; % response
    d = self.remote.callRemote(&quot;finishTransfer&quot;)
    d.addErrback(self.notOk)
    return None

  def notOk(self, failure):
    if failure.type == jelly.InsecureJelly:
      print &quot;error: InsecureJelly&quot;
    elif failure.type == pb.PBConnectionLost:
      print &quot;info: data transfer finished&quot;
    else:
    print failure
    return None

def main():
  from pbsimple import CopyBag

  icae = iCAEconfig()
  bag = CopyBag()

  bag.setContent(test())
  sender = Sender(bag)

  factory = pb.PBServerFactory(sender)
  reactor.listenTCP(8789, factory)
  reactor.run()

if __name__ == '__main__':
  main()

----- pbsimpleclient.py

from twisted.spread import pb
from twisted.internet import reactor
from twisted.python import util
import os, pickle
from StringIO import StringIO
from zlib import decompress
import elementtree.ElementTree as ET

from pbsimple import Bag, CopyBag, test

class ReceiverBag(Bag,pb.RemoteCopy):
  pass

pb.setUnjellyableForClass(CopyBag, ReceiverBag)

class Receiver(pb.Referenceable):
  def remote_takeBag(self, bag):
    # deserialize the bag.content
    try:
      self.content = pickle.loads(decompress(bag.content))
      self.len = len(bag.content)
      return &quot;data arrived safe and sound&quot; # positive acknowledgement
    except:
      self.content = None
      self.len = 0
      print &quot;error: data could not be de-serialized&quot;
      reactor.stop()

  def remote_finishTransfer(self):
    print &quot;got bag of length:&quot;, self.len
    reactor.stop()

  def requestBag(self,remote):
    print &quot;asking server for sending the data bag&quot;
    remote.callRemote(&quot;sendBag&quot;,self)

def getContentFromServer():

  receiver = Receiver()
  factory = pb.PBClientFactory()
  reactor.connectTCP(&quot;localhost&quot;, 8789, factory,30)
  d = factory.getRootObject()
  d.addCallback(receiver.requestBag)
  reactor.run()
  return receiver.content

if __name__ == '__main__':
  content = getContentFromServer()
  if hasattr(content,'getroot'):
    ET.dump(content)
  else:
    print content
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20061018/6e3c7e6d/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20061018/6e3c7e6d/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014201.html">[Twisted-Python] Newbie question on how to send &quot;complex&quot;	objects over the wire
</A></li>
	<LI>Next message: <A HREF="014204.html">[Twisted-Python] Newbie question on how to send &quot;complex&quot;	objects over the wire
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14203">[ date ]</a>
              <a href="thread.html#14203">[ thread ]</a>
              <a href="subject.html#14203">[ subject ]</a>
              <a href="author.html#14203">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
