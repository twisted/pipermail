<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Daemon processes on windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Daemon%20processes%20on%20windows&In-Reply-To=m2my2w8lh3.fsf%40valheru.db3l.homeip.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020912.html">
   <LINK REL="Next"  HREF="020915.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Daemon processes on windows</H1>
    <B>Brian Granger</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Daemon%20processes%20on%20windows&In-Reply-To=m2my2w8lh3.fsf%40valheru.db3l.homeip.net"
       TITLE="[Twisted-Python] Daemon processes on windows">ellisonbg.net at gmail.com
       </A><BR>
    <I>Sun Nov  8 22:54:11 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020912.html">[Twisted-Python] Daemon processes on windows
</A></li>
        <LI>Next message: <A HREF="020915.html">[Twisted-Python] Daemon processes on windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20914">[ date ]</a>
              <a href="thread.html#20914">[ thread ]</a>
              <a href="subject.html#20914">[ subject ]</a>
              <a href="author.html#20914">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>David,


While this process is certainly doable, I'll also point out that on
&gt;<i> Windows, the more &quot;natural&quot; approach to this is to implement the
</I>&gt;<i> process as a service.  That also buys you some regular Windows
</I>&gt;<i> approaches to management (net stop/start from command line, services
</I>&gt;<i> UI from the control panel) and status inquiry (sc query from command
</I>&gt;<i> line).  So while it may be a little platform-specific code you're
</I>&gt;<i> final result will integrate more naturally into that environment for
</I>&gt;<i> any system administrators.
</I>&gt;<i>
</I>&gt;<i>
</I>It is very possible I might have to go this route.  We have some odd
requrements,
such as needing to run the server using the Windows Server 2008 HPC job
scheduler.
the job scheduler does some funky things and I am finding that some of the
&quot;usual&quot;
assumptions you make on Windows don't hold.  So at this point, I need all
the tricks
in my bad that I can get.  Thanks for the example!


&gt;<i> While I haven't done this with a twistd based Twisted service, I've
</I>&gt;<i> done it with a lot of Twisted code in general.  It's easiest if you have
</I>&gt;<i> pywin32 installed and can use it's utility service wrappers, for which
</I>&gt;<i> the pywin32 package has examples.
</I>&gt;<i>
</I>
OK, nice to know about these examples.


&gt;<i> I've tended to offload the service definition to its own module, and
</I>&gt;<i> have it just import and execute the main code (with the twisted
</I>&gt;<i> reactor.run call) after the service gets started - that way you can
</I>&gt;<i> also manually run the twisted code without involving any of the
</I>&gt;<i> service support, or to support execution on non-Windows platforms.
</I>&gt;<i>
</I>&gt;<i> Here's one example of a service object that invoices Twisted-based
</I>&gt;<i> code.  When stopping, you use callFromThread because the thread that
</I>&gt;<i> handles the request from the Windows service manager is separate from
</I>&gt;<i> the thread executing the main code (which is a thread created during
</I>&gt;<i> the startup process).
</I>&gt;<i>
</I>&gt;<i> That's also why you start the reactor without signal initialization,
</I>&gt;<i> since it'll be in a secondary thread.  In SvcDoRun is where you could
</I>&gt;<i> import platform-generic modules to set up your twisted code, and then
</I>&gt;<i> this code starts the reactor.
</I>&gt;<i>
</I>
Bummer, then I can't use this approach.  My &quot;server&quot; uses
reactor.spawnProcess
which needs the signal handlers to be installed (SIGCHLD specifically) to
work
properly... do you know if it can be done without the dual thread trick.

Thanks,

Brian

Oh, and I left some code in that shows retrieving service-specific
&gt;<i> parameters from the registry as is typical for Windows services
</I>&gt;<i> (stored in HKLM/System/CurrentControlSet/Services/&lt;svc_name&gt;/Parameters
</I>&gt;<i> if I recall corrrectly):
</I>&gt;<i>
</I>&gt;<i>                              - - - - -
</I>&gt;<i>
</I>&gt;<i> class DataImportService(win32serviceutil.ServiceFramework):
</I>&gt;<i>
</I>&gt;<i>    __version__ = '1.0.0'
</I>&gt;<i>
</I>&gt;<i>    _svc_name_ = 'fdi'
</I>&gt;<i>    _svc_display_name_ = 'SomeCompany Data Integration'
</I>&gt;<i>
</I>&gt;<i>    stopping = False
</I>&gt;<i>    debug = False
</I>&gt;<i>
</I>&gt;<i>    def __init__(self, *args, **kwargs):
</I>&gt;<i>        win32serviceutil.ServiceFramework.__init__(self, *args, **kwargs)
</I>&gt;<i>        self.initialize()
</I>&gt;<i>        self._stopped = threading.Event()
</I>&gt;<i>        self.log = None
</I>&gt;<i>
</I>&gt;<i>    def initialize(self):
</I>&gt;<i>        # This is separate from __init__ so during debugging the bootstrap
</I>&gt;<i>        # code can override __init__ but still finish initialization.
</I>&gt;<i>
</I>&gt;<i>    def _getOption(self, option, default):
</I>&gt;<i>        return win32serviceutil.GetServiceCustomOption(self._svc_name_,
</I>&gt;<i>                                                       option,
</I>&gt;<i>                                                       default)
</I>&gt;<i>
</I>&gt;<i>    def SvcStop(self):
</I>&gt;<i>        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
</I>&gt;<i>        print '%s Service stopping' % self._svc_display_name_
</I>&gt;<i>        reactor.callFromThread(reactor.stop)
</I>&gt;<i>        self._stopped.wait(5)
</I>&gt;<i>        print '%s Service stopped' % self._svc_display_name_
</I>&gt;<i>        if self.log:
</I>&gt;<i>            self.log.close()
</I>&gt;<i>
</I>&gt;<i>    def SvcDoRun(self):
</I>&gt;<i>        &quot;&quot;&quot;Main entry point for service execution&quot;&quot;&quot;
</I>&gt;<i>
</I>&gt;<i>        if hasattr(sys, 'frozen'):
</I>&gt;<i>            home_dir = os.path.dirname(sys.executable)
</I>&gt;<i>        else:
</I>&gt;<i>            home_dir = os.path.dirname(__file__)
</I>&gt;<i>
</I>&gt;<i>        # First, let's set up some logging
</I>&gt;<i>        if self.debug:
</I>&gt;<i>            dupstdout = True
</I>&gt;<i>            logprefix = None
</I>&gt;<i>        else:
</I>&gt;<i>            dupstdout = False
</I>&gt;<i>            logprefix = os.path.join(home_dir, 'logs', 'dataimport.log')
</I>&gt;<i>
</I>&gt;<i>        self.log = LogClass(logprefix, dupstdout)
</I>&gt;<i>
</I>&gt;<i>        # And then reroute stdout/stderr to that file object
</I>&gt;<i>        sys.stdout = self.log
</I>&gt;<i>        sys.stderr = self.log
</I>&gt;<i>
</I>&gt;<i>        print '%s Service %s starting' % (self._svc_display_name_,
</I>&gt;<i>                                          self.__version__)
</I>&gt;<i>
</I>&gt;<i>        try:
</I>&gt;<i>
</I>&gt;<i>            # Process config file
</I>&gt;<i>            config_file = self._getOption('config',
</I>&gt;<i>                                          os.path.join(home_dir, 'data',
</I>&gt;<i>                                                       'dataimport.ini'))
</I>&gt;<i>
</I>&gt;<i>            # ... other service-related initialization ...
</I>&gt;<i>
</I>&gt;<i>            # ... do any Twisted related initialization ...
</I>&gt;<i>
</I>&gt;<i>            # Start everything up
</I>&gt;<i>            reactor.callLater(0, self.log.write,
</I>&gt;<i>                              '%s Service operational\n' %
</I>&gt;<i>                              self._svc_display_name_)
</I>&gt;<i>            reactor.run(installSignalHandlers=False)
</I>&gt;<i>
</I>&gt;<i>            # We're shutting down.
</I>&gt;<i>
</I>&gt;<i>            # ... do any shutdown processing ...
</I>&gt;<i>
</I>&gt;<i>            # Flag that we're exiting so service thread can be more
</I>&gt;<i>            # accurate in terms of declaring shutdown.
</I>&gt;<i>            self._stopped.set()
</I>&gt;<i>
</I>&gt;<i>        except:
</I>&gt;<i>
</I>&gt;<i>            # For right now just log a traceback and abort
</I>&gt;<i>            log.err()
</I>&gt;<i>            # But try to gracefully close down log to let final traceback
</I>&gt;<i>            # information make it out to the log file.
</I>&gt;<i>            if self.log:
</I>&gt;<i>                self.log.close()
</I>&gt;<i>
</I>&gt;<i>                              - - - - -
</I>&gt;<i>
</I>&gt;<i> Your main startup code in the service wrapper module can use helper
</I>&gt;<i> functions from win32serviceutil for startup (see the pywin32 examples)
</I>&gt;<i> which provides some automatic support for installing/uninstalling the
</I>&gt;<i> service, or you can implement your own startup if you want to support
</I>&gt;<i> different options and what not.  This all works under py2exe as well
</I>&gt;<i> if you want to package things up and have a nice self-contained exe as
</I>&gt;<i> a Windows service.
</I>&gt;<i>
</I>&gt;<i> -- David
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20091108/985180fe/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20091108/985180fe/attachment.htm</A> 
</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020912.html">[Twisted-Python] Daemon processes on windows
</A></li>
	<LI>Next message: <A HREF="020915.html">[Twisted-Python] Daemon processes on windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20914">[ date ]</a>
              <a href="thread.html#20914">[ thread ]</a>
              <a href="subject.html#20914">[ subject ]</a>
              <a href="author.html#20914">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
