<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Daemon processes on windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Daemon%20processes%20on%20windows&In-Reply-To=%3C6ce0ac130911072122s475d1e19pa11868b1b964ad26%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053398.html">
   <LINK REL="Next"  HREF="053410.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Daemon processes on windows</H1>
    <B>Brian Granger</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Daemon%20processes%20on%20windows&In-Reply-To=%3C6ce0ac130911072122s475d1e19pa11868b1b964ad26%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Daemon processes on windows">ellisonbg.net at gmail.com
       </A><BR>
    <I>Sat Nov  7 22:22:15 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053398.html">[Twisted-Python] Daemon processes on windows
</A></li>
        <LI>Next message (by thread): <A HREF="053410.html">[Twisted-Python] Daemon processes on windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53404">[ date ]</a>
              <a href="thread.html#53404">[ thread ]</a>
              <a href="subject.html#53404">[ subject ]</a>
              <a href="author.html#53404">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Fantastic, thanks for sharing this code.  I will definitely have a look.  If
it turns out to
work for us, would you mind releasing this under a BSD license so we can
include
it in IPython (BSD open source project)?  In either case, the ideas will be
very helpful to us.

Cheers,

Brian

It is possible to daemonize a process on Windows. I experimented with
&gt;<i> adding that support to the twistd script, but got swamped with other
</I>&gt;<i> work and couldn't finish it. Below is the code that I have so far. You
</I>&gt;<i> can save it in a module and call the daemonize() function from your script.
</I>&gt;<i>
</I>&gt;<i> The process of daemonization is similar to the one on UNIX -- you have
</I>&gt;<i> to spawn a child process twice, the first child is responsible for
</I>&gt;<i> breaking away from any job objects (somewhat similar to becoming a
</I>&gt;<i> session leader on UNIX), becoming a new process group leader and closing
</I>&gt;<i> all handles (file descriptors) that might have been inherited.
</I>&gt;<i>
</I>&gt;<i> The second child has to open dummy std* files and a new (hidden)
</I>&gt;<i> console, otherwise the signals stop working. There is a slight
</I>&gt;<i> complication with window stations and desktops. Each console creates at
</I>&gt;<i> least one window and some other user objects, so we have to create
</I>&gt;<i> a separate desktop, or other processes would be able to manipulate them
</I>&gt;<i>  and send us arbitrary (Windows) messages.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i> Ziga
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> import os
</I>&gt;<i> import sys
</I>&gt;<i> import msvcrt
</I>&gt;<i>
</I>&gt;<i> import win32con
</I>&gt;<i> import win32process
</I>&gt;<i> import win32security
</I>&gt;<i> import win32service
</I>&gt;<i>
</I>&gt;<i> from twisted.python import win32
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def getPythonArgs():
</I>&gt;<i>     &quot;&quot;&quot;
</I>&gt;<i>     Return the list of command line args that were used to start
</I>&gt;<i>     the current Python interpreter and were not stored in C{sys.argv}.
</I>&gt;<i>
</I>&gt;<i>     These are the options that control the Python interpreter itself,
</I>&gt;<i>     like the Python executable, optimization level, warning filters,
</I>&gt;<i>     division behaviour and literal string handling.
</I>&gt;<i>     &quot;&quot;&quot;
</I>&gt;<i>     args = [sys.executable]
</I>&gt;<i>     for warnoption in sys.warnoptions:
</I>&gt;<i>         args.append(&quot;-W&quot;)
</I>&gt;<i>         args.append(warnoption)
</I>&gt;<i>     if type(1 / 2) is not int:
</I>&gt;<i>         args.append(&quot;-Qnew&quot;)
</I>&gt;<i>     if type(&quot;&quot;) is not str:
</I>&gt;<i>         args.append(&quot;-U&quot;)
</I>&gt;<i>     if not __debug__:
</I>&gt;<i>         if getPythonArgs.__doc__ is None:
</I>&gt;<i>             args.append(&quot;-OO&quot;)
</I>&gt;<i>         else:
</I>&gt;<i>             args.append(&quot;-O&quot;)
</I>&gt;<i>     return args
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def daemonize():
</I>&gt;<i>     args = [os.path.abspath(__file__)] + sys.argv
</I>&gt;<i>     executable = sys.executable
</I>&gt;<i>     cmdline = win32.quoteArguments(getPythonArgs() + args)
</I>&gt;<i>     inherit = False
</I>&gt;<i>
</I>&gt;<i>     flags = (win32process.CREATE_BREAKAWAY_FROM_JOB | # session leader
</I>&gt;<i>              win32process.CREATE_NEW_PROCESS_GROUP |  # group leader
</I>&gt;<i>              win32process.DETACHED_PROCESS) # no controlling terminal
</I>&gt;<i>
</I>&gt;<i>     info = win32process.STARTUPINFO()
</I>&gt;<i>     win32process.CreateProcess(executable, cmdline, None, None,
</I>&gt;<i>                                inherit, flags, None, None, info)
</I>&gt;<i>     # Do what exec* functions do, let the OS do the cleanup.
</I>&gt;<i>     os._exit(0)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def daemonize2():
</I>&gt;<i>     args = [sys.argv[1], &quot;--nodaemon&quot;] + sys.argv[2:]
</I>&gt;<i>     executable = sys.executable
</I>&gt;<i>     cmdline = win32.quoteArguments(getPythonArgs() + args)
</I>&gt;<i>     inherit = True
</I>&gt;<i>     # create an invisible console
</I>&gt;<i>     flags = (win32process.CREATE_NO_WINDOW
</I>&gt;<i>     attributes = win32security.SECURITY_ATTRIBUTES()
</I>&gt;<i>     attributes.bInheritHandle = True
</I>&gt;<i>     station = win32service.CreateWindowStation(None, 0,
</I>&gt;<i>                                                win32con.GENERIC_READ |
</I>&gt;<i>                                                win32con.GENERIC_WRITE,
</I>&gt;<i>                                                attributes)
</I>&gt;<i>     station.SetProcessWindowStation()
</I>&gt;<i>     sname = win32service.GetUserObjectInformation(station,
</I>&gt;<i>                                                   win32service.UOI_NAME)
</I>&gt;<i>     dname = str(os.getpid())
</I>&gt;<i>     desktop = win32service.CreateDesktop(dname, 0,
</I>&gt;<i>                                          win32con.GENERIC_READ |
</I>&gt;<i>                                          win32con.GENERIC_WRITE,
</I>&gt;<i>                                          attributes)
</I>&gt;<i>     desktop.SetThreadDesktop()
</I>&gt;<i>     null = os.open(&quot;NUL&quot;, os.O_RDWR)
</I>&gt;<i>     handle = msvcrt.get_osfhandle(null)
</I>&gt;<i>     info = win32process.STARTUPINFO()
</I>&gt;<i>     info.lpDesktop = &quot;%s\\%s&quot; % (sname, dname)
</I>&gt;<i>     info.dwFlags = win32process.STARTF_USESTDHANDLES
</I>&gt;<i>     info.hStdInput = info.hStdOutput = info.hStdError = handle
</I>&gt;<i>     win32process.CreateProcess(executable, cmdline, None, None,
</I>&gt;<i>                                inherit, flags, None, None, info)
</I>&gt;<i>     # Same as above, exit as fast as possible.
</I>&gt;<i>     os._exit(0)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;<i>     daemonize2()
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20091107/a17e106f/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053398.html">[Twisted-Python] Daemon processes on windows
</A></li>
	<LI>Next message (by thread): <A HREF="053410.html">[Twisted-Python] Daemon processes on windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53404">[ date ]</a>
              <a href="thread.html#53404">[ thread ]</a>
              <a href="subject.html#53404">[ subject ]</a>
              <a href="author.html#53404">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
