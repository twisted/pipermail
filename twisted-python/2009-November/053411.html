<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Daemon processes on windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Daemon%20processes%20on%20windows&In-Reply-To=%3C6ce0ac130911080935r267b59f9mfd9defbcde303ac6%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053410.html">
   <LINK REL="Next"  HREF="053415.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Daemon processes on windows</H1>
    <B>Brian Granger</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Daemon%20processes%20on%20windows&In-Reply-To=%3C6ce0ac130911080935r267b59f9mfd9defbcde303ac6%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Daemon processes on windows">ellisonbg.net at gmail.com
       </A><BR>
    <I>Sun Nov  8 10:35:57 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053410.html">[Twisted-Python] Daemon processes on windows
</A></li>
        <LI>Next message (by thread): <A HREF="053415.html">[Twisted-Python] Daemon processes on windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53411">[ date ]</a>
              <a href="thread.html#53411">[ thread ]</a>
              <a href="subject.html#53411">[ subject ]</a>
              <a href="author.html#53411">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sure, you can find a slightly updated version of the code in the attachment,
licensed under the two clause BSD license and without the syntax error.

Thank you very much for being willing to share this code under the BSD
license.  I will try this out and see if it does the job for us.



&gt;<i> It would be even better if you could try to integrate the functionality
</I>&gt;<i> into Twisted itself, if the core developers agree that it would be useful. I
</I>&gt;<i> opened a ticket for this:
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/trac/ticket/4073">http://twistedmatrix.com/trac/ticket/4073</A>
</I>&gt;<i>
</I>&gt;<i>
</I>Yes, it would be nice if this was in twisted itself.  I will probably
include it in IPython for now and see how it works for us - use that as a
medium term test of the approach.  I will provide feeback and any changes to
the twisted ticket as appropriate.

Thanks again,

Brian


&gt;<i> Regards,
</I>&gt;<i> Ziga
</I>&gt;<i>
</I>&gt;<i> # Copyright (c) 2009 Ziga Seilnacht. All rights reserved.
</I>&gt;<i> #
</I>&gt;<i> # Redistribution and use in source and binary forms, with or without
</I>&gt;<i> # modification, are permitted provided that the following conditions are
</I>&gt;<i> met:
</I>&gt;<i> #
</I>&gt;<i> # 1. Redistributions of source code must retain the above copyright notice,
</I>&gt;<i> #    this list of conditions and the following disclaimer.
</I>&gt;<i> # 2. Redistributions in binary form must reproduce the above copyright
</I>&gt;<i> notice,
</I>&gt;<i> #    this list of conditions and the following disclaimer in the
</I>&gt;<i> documentation
</I>&gt;<i> #    and/or other materials provided with the distribution.
</I>&gt;<i> #
</I>&gt;<i> # THIS SOFTWARE IS PROVIDED BY THE FREEBSD PROJECT ''AS IS'' AND ANY
</I>&gt;<i> EXPRESS OR
</I>&gt;<i> # IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
</I>&gt;<i> OF
</I>&gt;<i> # MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN
</I>&gt;<i> NO
</I>&gt;<i> # EVENT SHALL THE FREEBSD PROJECT OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
</I>&gt;<i> # INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
</I>&gt;<i> (INCLUDING,
</I>&gt;<i> # BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF
</I>&gt;<i> USE,
</I>&gt;<i> # DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
</I>&gt;<i> THEORY OF
</I>&gt;<i> # LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
</I>&gt;<i> NEGLIGENCE
</I>&gt;<i> # OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
</I>&gt;<i> # ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> import os
</I>&gt;<i> import sys
</I>&gt;<i> import msvcrt
</I>&gt;<i>
</I>&gt;<i> try:
</I>&gt;<i>    import win32con
</I>&gt;<i>    import win32process
</I>&gt;<i>    import win32security
</I>&gt;<i>    import win32service
</I>&gt;<i> except ImportError:
</I>&gt;<i>    win32process = None
</I>&gt;<i>
</I>&gt;<i> from twisted.python import win32
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def getPythonArgs():
</I>&gt;<i>    &quot;&quot;&quot;
</I>&gt;<i>    Return the list of command line args that were used to start
</I>&gt;<i>    the current Python interpreter and were not stored in C{sys.argv}.
</I>&gt;<i>
</I>&gt;<i>    These are the options that control the Python interpreter itself,
</I>&gt;<i>    like the Python executable, optimization level, warning filters,
</I>&gt;<i>    division behaviour and literal string handling.
</I>&gt;<i>    &quot;&quot;&quot;
</I>&gt;<i>    args = [sys.executable]
</I>&gt;<i>    for warnoption in sys.warnoptions:
</I>&gt;<i>        args.append(&quot;-W&quot;)
</I>&gt;<i>        args.append(warnoption)
</I>&gt;<i>    if type(1 / 2) is not int:
</I>&gt;<i>        args.append(&quot;-Qnew&quot;)
</I>&gt;<i>    if type(&quot;&quot;) is not str:
</I>&gt;<i>        args.append(&quot;-U&quot;)
</I>&gt;<i>    if not __debug__:
</I>&gt;<i>        if getPythonArgs.__doc__ is None:
</I>&gt;<i>            args.append(&quot;-OO&quot;)
</I>&gt;<i>        else:
</I>&gt;<i>            args.append(&quot;-O&quot;)
</I>&gt;<i>    return args
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def daemonize():
</I>&gt;<i>    args = [os.path.abspath(__file__)] + sys.argv
</I>&gt;<i>    executable = sys.executable
</I>&gt;<i>    cmdline = win32.quoteArguments(getPythonArgs() + args)
</I>&gt;<i>    inherit = False
</I>&gt;<i>    priority =
</I>&gt;<i> win32process.GetPriorityClass(win32process.GetCurrentProcess())
</I>&gt;<i>    flags = (win32process.CREATE_BREAKAWAY_FROM_JOB | # session leader
</I>&gt;<i>             win32process.CREATE_NEW_PROCESS_GROUP |  # group leader
</I>&gt;<i>             win32process.DETACHED_PROCESS |          # no controlling
</I>&gt;<i> terminal
</I>&gt;<i>             priority)
</I>&gt;<i>    info = win32process.STARTUPINFO()
</I>&gt;<i>    win32process.CreateProcess(executable, cmdline, None, None,
</I>&gt;<i>                               inherit, flags, None, None, info)
</I>&gt;<i>    # Do what exec* functions do, let the OS do the cleanup.
</I>&gt;<i>    os._exit(0)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def daemonize2():
</I>&gt;<i>    args = [sys.argv[1], &quot;--nodaemon&quot;] + sys.argv[2:]
</I>&gt;<i>    executable = sys.executable
</I>&gt;<i>    cmdline = win32.quoteArguments(getPythonArgs() + args)
</I>&gt;<i>    inherit = True
</I>&gt;<i>    priority =
</I>&gt;<i> win32process.GetPriorityClass(win32process.GetCurrentProcess())
</I>&gt;<i>    flags = (win32process.CREATE_NO_WINDOW | # create an invisible console
</I>&gt;<i>             win32process.CREATE_NEW_PROCESS_GROUP | # group leader
</I>&gt;<i>             priority)
</I>&gt;<i>    attributes = win32security.SECURITY_ATTRIBUTES()
</I>&gt;<i>    attributes.bInheritHandle = True
</I>&gt;<i>    station = win32service.CreateWindowStation(None, 0,
</I>&gt;<i>                                               win32con.GENERIC_READ |
</I>&gt;<i>                                               win32con.GENERIC_WRITE,
</I>&gt;<i>                                               attributes)
</I>&gt;<i>    station.SetProcessWindowStation()
</I>&gt;<i>    sname = win32service.GetUserObjectInformation(station,
</I>&gt;<i>                                                  win32service.UOI_NAME)
</I>&gt;<i>    dname = str(os.getpid())
</I>&gt;<i>    desktop = win32service.CreateDesktop(dname, 0,
</I>&gt;<i>                                         win32con.GENERIC_READ |
</I>&gt;<i>                                         win32con.GENERIC_WRITE,
</I>&gt;<i>                                         attributes)
</I>&gt;<i>    desktop.SetThreadDesktop()
</I>&gt;<i>    null = os.open(&quot;NUL&quot;, os.O_RDWR)
</I>&gt;<i>    handle = msvcrt.get_osfhandle(null)
</I>&gt;<i>    info = win32process.STARTUPINFO()
</I>&gt;<i>    info.lpDesktop = &quot;%s\\%s&quot; % (sname, dname)
</I>&gt;<i>    info.dwFlags = win32process.STARTF_USESTDHANDLES
</I>&gt;<i>    info.hStdInput = info.hStdOutput = info.hStdError = handle
</I>&gt;<i>    win32process.CreateProcess(executable, cmdline, None, None,
</I>&gt;<i>                               inherit, flags, None, None, info)
</I>&gt;<i>    # Same as above, exit as fast as posible.
</I>&gt;<i>    os._exit(0)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;<i>    daemonize2()
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20091108/cbd6bfb3/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053410.html">[Twisted-Python] Daemon processes on windows
</A></li>
	<LI>Next message (by thread): <A HREF="053415.html">[Twisted-Python] Daemon processes on windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53411">[ date ]</a>
              <a href="thread.html#53411">[ thread ]</a>
              <a href="subject.html#53411">[ subject ]</a>
              <a href="author.html#53411">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
