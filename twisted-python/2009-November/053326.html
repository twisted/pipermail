<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] PyObjC and Twisted command line script
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20PyObjC%20and%20Twisted%20command%20line%20script&In-Reply-To=%3Cm2bpjlaggv.fsf%40valheru.db3l.homeip.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053320.html">
   <LINK REL="Next"  HREF="053425.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] PyObjC and Twisted command line script</H1>
    <B>David Bolen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20PyObjC%20and%20Twisted%20command%20line%20script&In-Reply-To=%3Cm2bpjlaggv.fsf%40valheru.db3l.homeip.net%3E"
       TITLE="[Twisted-Python] PyObjC and Twisted command line script">db3l.net at gmail.com
       </A><BR>
    <I>Sun Nov  1 18:00:16 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053320.html">[Twisted-Python] PyObjC and Twisted command line script
</A></li>
        <LI>Next message (by thread): <A HREF="053425.html">[Twisted-Python] PyObjC and Twisted command line script
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53326">[ date ]</a>
              <a href="thread.html#53326">[ thread ]</a>
              <a href="subject.html#53326">[ subject ]</a>
              <a href="author.html#53326">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jonathan Stoppani &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jonathan at garetjax.info</A>&gt; writes:

&gt;<i> Hi Ronald,
</I>&gt;<i> thanks for the response. I already saw the examples on the pyobjc
</I>&gt;<i> website, but they (two) are all using Cocoa to do some GUI related
</I>&gt;<i> work.
</I>&gt;<i>
</I>&gt;<i> I don't have a gui and I use the console loop instead.
</I>&gt;<i>
</I>&gt;<i> I'm now trying to use the code attached to this ticket and it seems to
</I>&gt;<i> work, but I have to test it a little more.
</I>
Not sure which ticket is being referenced but which Twisted reactor
are you using?  I've had very good luck with the threadedselect
reactor, which shouldn't care if your main loop is a GUI or not.  You
interleave with AppHelper.callAfter, which I think should work fine
with both runConsoleEventLoopas well as the GUI runEventLoop

For my part, any OSX console apps I've had to do could just be pure
Twisted, with no need to integrate with an NSRunLoop, so I'm not that
familiar with how you best track startup/shutdown in those cases.

But fundamentally, you install the threadedselect reactor (do that
before any other code uses &quot;from twisted.internet import reactor&quot;),
then use &quot;reactor.interleave(AppHelper.callAfter)&quot; to tie the reactor
in to the normal event loop.  In the Cocoa/NSApplication scenario, I
use the applicationDidFinishLaunching notification to trigger this.

During shutdown, wait for the reactor to perform its shutdown so it
can close things down cleanly, using a reactor trigger to finalize the
event loop with &quot;AppHelper.stopEventLoop&quot;.  Again, presumably you'll
have some way to determine when this is appropriate in your console
event loop - in a Cocoa/NSApplication scenario, I use the
applicationShouldTerminate notification.  (I've tended to install the
trigger right at that point too, although it could also be done
earlier)

Here's a trivial example, where I kluge a startup event.  Presumably
the reason you are using runConsoleEventLoop is to use other native
event/input sources based operations, so you might have a more logical
place or event to identify when to start the twisted integration - all
that's required is that it be done after the main event loop is
running.  If not, while I chose a 1s startup delay in this example, it
was mostly to see the difference in timestamps - you can make the
initial callLater a timeout of 0, and it'll just run as soon as the
event loop gets started.

This example also just terminates after two Twisted-based delayed
events, but that would also be determined by your own application:

    &quot;&quot;&quot;Test console event loop app with Twisted threadedselect reactor&quot;&quot;&quot;

    import time

    from PyObjCTools import AppHelper

    from twisted.internet._threadedselect import install
    reactor = install()

    class Main(object):

        def startup(self):
            print time.ctime(), 'Main starting'
            reactor.callLater(1, self.callback)
            reactor.interleave(AppHelper.callAfter)

        def terminate(self):
            print time.ctime(), 'Shutting down reactor'
            reactor.addSystemEventTrigger('after', 'shutdown',
                                          AppHelper.stopEventLoop)
            reactor.stop()

        def callback(self):
            print time.ctime(), 'I was called by the reactor'
            reactor.callLater(1, self.terminate)


    if __name__ == &quot;__main__&quot;:

        main = Main()
        AppHelper.callLater(1, main.startup)

        print time.ctime(), 'Starting Event Loop'
        AppHelper.runConsoleEventLoop()
        print time.ctime(), 'Terminating'

When running, this produces:

    Sun Nov  1 19:53:16 2009 Starting Event Loop
    Sun Nov  1 19:53:17 2009 Main starting
    Sun Nov  1 19:53:18 2009 I was called by the reactor
    Sun Nov  1 19:53:19 2009 Shutting down reactor
    Sun Nov  1 19:53:19 2009 Terminating

-- David



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053320.html">[Twisted-Python] PyObjC and Twisted command line script
</A></li>
	<LI>Next message (by thread): <A HREF="053425.html">[Twisted-Python] PyObjC and Twisted command line script
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53326">[ date ]</a>
              <a href="thread.html#53326">[ thread ]</a>
              <a href="subject.html#53326">[ subject ]</a>
              <a href="author.html#53326">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
