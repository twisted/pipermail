<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Caching mechanism
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Caching%20mechanism&In-Reply-To=%3C23590079.406.1258363704530.JavaMail.www%40wwinf8302%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053494.html">
   <LINK REL="Next"  HREF="053427.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Caching mechanism</H1>
    <B>mardiros</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Caching%20mechanism&In-Reply-To=%3C23590079.406.1258363704530.JavaMail.www%40wwinf8302%3E"
       TITLE="[Twisted-Python] Caching mechanism">mardiros at laposte.net
       </A><BR>
    <I>Mon Nov 16 02:28:24 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053494.html">[Twisted-Python] Caching mechanism
</A></li>
        <LI>Next message (by thread): <A HREF="053427.html">[Twisted-Python] Need help with Twisted. Please
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53495">[ date ]</a>
              <a href="thread.html#53495">[ thread ]</a>
              <a href="subject.html#53495">[ subject ]</a>
              <a href="author.html#53495">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Here is the main part of my code

class CacheCleanerBaseMixin:
def __init__(self, cachetimer,cachelifetime):
self._cache = {}
self._cachelifetime = timedelta(0,cachelifetime)
self._cleaner = task.LoopingCall(self.cleanCache)
self._cleaner.start(cachetimer,now=False)
self._cleanrun = False

def cleanCache(self):
if not self._cleanrun:
self._cleanrun = True
log.msg('Clean the cache...', logLevel=logging.DEBUG)
expire = datetime.today()
i = 0
for k,v in self._cache.items():
if v[0] &lt; expire:
i+=1
del self._cache[k]
log.msg('%i items removed' % i, logLevel=logging.DEBUG)
self._cleanrun = False


class asyncmemoize(CacheCleanerBaseMixin):
def __init__(self, function,cachetimer=30,cachelifetime=60):
CacheCleanerBaseMixin.__init__(self, cachetimer,cachelifetime)
self.function = function

def __call__(self, *args, **kwargs):
key = (tuple(args), frozenset(kwargs.items()))
if key not in self._cache:
return self.function(SqlConnection(),*args, **kwargs).addCallback(self.callback,key)
else:
log.msg('Retrievieng the data from the cache',logLevel=logging.DEBUG)
return self._cache[key][1]

def callback(self,result,key):
try:
self._cache[key] = [datetime.today() + self._cachelifetime, result]
finally:
return result




class SqlConnection(object): 

_instance = None
def __new__(cls):
if cls._instance is None:
cls._instance = object.__new__(cls)
return cls._instance

def configure(self, dbdriver, dbdriverargs,
log_request=False,
cache_file='sqlcache.shelve',
pool_file='sqloperation.shelve',
pool_maxattempt=5,
pool_time=30):
self.log_request = log_request
self.pool = adbapi.ConnectionPool(dbdriver,**dbdriverargs) 

@asyncmemoize
def internal_runQuery(self,query,args=None):
rv = None
try:
if args:
rv = self.pool.runQuery(query,args)
else:
rv = self.pool.runQuery(query)
except:
log.err() 
return rv

def runQuery(self,query,args=None):
try:
d = defer.maybeDeferred(self.internal_runQuery, query,args)
return d
except:
log.err() 


---------------------------------------------------------------------------- 
Laposte.net fête ses 10 ans ! 

Gratuite, garantie à vie et déjà utilisée par des millions d'internautes... 
vous aussi, pour votre adresse e-mail, choisissez laposte.net. 

Laposte.net, bien + qu'une messagerie 
----------------------------------------------------------------------------



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053494.html">[Twisted-Python] Caching mechanism
</A></li>
	<LI>Next message (by thread): <A HREF="053427.html">[Twisted-Python] Need help with Twisted. Please
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53495">[ date ]</a>
              <a href="thread.html#53495">[ thread ]</a>
              <a href="subject.html#53495">[ subject ]</a>
              <a href="author.html#53495">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
