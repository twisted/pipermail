<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] synchronous/asynchronous api: possible interface
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20synchronous/asynchronous%20api%3A%20possible%20interface&In-Reply-To=%3C80c54aa0911130632l63cad82aq54a93cff139c8b02%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053481.html">
   <LINK REL="Next"  HREF="053472.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] synchronous/asynchronous api: possible interface</H1>
    <B>Doug Farrell</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20synchronous/asynchronous%20api%3A%20possible%20interface&In-Reply-To=%3C80c54aa0911130632l63cad82aq54a93cff139c8b02%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] synchronous/asynchronous api: possible interface">doug.farrell at gmail.com
       </A><BR>
    <I>Fri Nov 13 07:32:25 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053481.html">[Twisted-Python] Multi-reactor architecture
</A></li>
        <LI>Next message (by thread): <A HREF="053472.html">[Twisted-Python] synchronous/asynchronous api: possible	interface
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53470">[ date ]</a>
              <a href="thread.html#53470">[ thread ]</a>
              <a href="subject.html#53470">[ subject ]</a>
              <a href="author.html#53470">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I'd like to get some comments on the code below (including, &quot;don't be
a bonehead!&quot; &lt;g&gt;). I'm trying to write a API library for database
access that can be used by both synchronous (non-twisted, no reactor)
code and asynchronous (twisted, with reactor) code where the methods
of the library can called in either environment. What I'd like is the
method to return the results of the call (database query results) when
in synchronous mode, and a deferred that is a result of the database
call in asynchronous mode.

What I've done below is create a decorator class called CallerMode
that is used to decorate a function/method that normally returns a
deferred. If the CallerMode class is in synchronous mode it starts a
reactor to get the default callbacks to get called, which gets the
results or exceptions, and stops the reactor.

Am I being a dunce doing this kind of thing? Any suggestions,
comments, etc. are welcome.

Thanks!
Doug


import sys
from functools import wraps
from twisted.internet import reactor
from twisted.python import log
from twisted.web.client import getPage


class CallerMode(object):
    '''This is a decorator class to make calls to an api play nice
    in synchronous or asynchronous mode'''
    ASYNCH = 'asynch'
    SYNCH  = 'synch'
    STATE  = SYNCH

    def __init__(self):
        self.retval = None

    def __call__(self, f):
        '''This provides the decorator function wrapper, which will return
        a deferred for asynchronous mode and the results of the wrapped
        function in synchronous mode'''
        def CB(result):
            self.retval = result
            reactor.stop()
        def EB(failure):
            reactor.stop()
            failure.raiseException()
        @wraps(f)
        def func(*args, **kwargs):
            d = f(*args, **kwargs)
            if CallerMode.STATE == CallerMode.SYNCH:
                d.addCallback(CB).addErrback(EB)
                reactor.run()
            return self.retval if CallerMode.STATE == CallerMode.SYNCH else d
        return func


class Library(object):
    '''This is just a class to provide an API to call for data,
    in this case just using getPage() to get a deferred that gets some
    data, vs. having to set up a database for this test program
    '''
    def __init__(self):
        log.msg('MyLib has been initialized')
        self._retval = None

    @CallerMode()
    def page(self):
        return getPage('<A HREF="http://www.google.com">http://www.google.com</A>')


def doSomethingWithData(data):
    log.msg(data)


log.FileLogObserver.timeFormat = '%Y-%m-%d %H:%M:%S'
log.startLogging(sys.stdout)

lib = Library()

#CallerMode.STATE = CallerMode.ASYNCH
CallerMode.STATE = CallerMode.SYNCH

# call the library API method
result = lib.page()

# depending on the CallerMode, handle the results differently
if CallerMode.STATE == CallerMode.SYNCH:
    doSomethingWithData(result)
elif CallerMode.STATE == CallerMode.ASYNCH:
    result.addCallback(doSomethingWithData)
    reactor.run()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053481.html">[Twisted-Python] Multi-reactor architecture
</A></li>
	<LI>Next message (by thread): <A HREF="053472.html">[Twisted-Python] synchronous/asynchronous api: possible	interface
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53470">[ date ]</a>
              <a href="thread.html#53470">[ thread ]</a>
              <a href="subject.html#53470">[ subject ]</a>
              <a href="author.html#53470">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
