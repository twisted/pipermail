<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Daemon processes on windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Daemon%20processes%20on%20windows&In-Reply-To=%3C4AF62B45.8030105%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053397.html">
   <LINK REL="Next"  HREF="053404.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Daemon processes on windows</H1>
    <B>Å½iga Seilnacht</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Daemon%20processes%20on%20windows&In-Reply-To=%3C4AF62B45.8030105%40gmail.com%3E"
       TITLE="[Twisted-Python] Daemon processes on windows">ziga.seilnacht at gmail.com
       </A><BR>
    <I>Sat Nov  7 19:21:57 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053397.html">[Twisted-Python] Daemon processes on windows
</A></li>
        <LI>Next message (by thread): <A HREF="053404.html">[Twisted-Python] Daemon processes on windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53398">[ date ]</a>
              <a href="thread.html#53398">[ thread ]</a>
              <a href="subject.html#53398">[ subject ]</a>
              <a href="author.html#53398">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Brian Granger wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I have a server-like process that uses twisted.  I need it to daemonize
</I>&gt;<i> itself and on linux/os x I am simply
</I>&gt;<i> using the daemonize function from twistd.  This works fine.  What about
</I>&gt;<i> Windows though....I saw that the
</I>&gt;<i> win32 version of twistd doesn't have (unless I am missing it) the ability to
</I>&gt;<i> daemonize a process.
</I>&gt;<i> 
</I>&gt;<i> Is is simply impossible to daemonize a process on windows?  If so, is there
</I>&gt;<i> any way to have a child
</I>&gt;<i> process on windows ignore SIGINT send to the parent?
</I>&gt;<i> 
</I>&gt;<i> Cheers and thanks,
</I>&gt;<i> 
</I>&gt;<i> Brian
</I>&gt;<i> 
</I>
It is possible to daemonize a process on Windows. I experimented with 
adding that support to the twistd script, but got swamped with other 
work and couldn't finish it. Below is the code that I have so far. You 
can save it in a module and call the daemonize() function from your script.

The process of daemonization is similar to the one on UNIX -- you have 
to spawn a child process twice, the first child is responsible for 
breaking away from any job objects (somewhat similar to becoming a 
session leader on UNIX), becoming a new process group leader and closing 
all handles (file descriptors) that might have been inherited.

The second child has to open dummy std* files and a new (hidden) 
console, otherwise the signals stop working. There is a slight 
complication with window stations and desktops. Each console creates at 
least one window and some other user objects, so we have to create
a separate desktop, or other processes would be able to manipulate them 
  and send us arbitrary (Windows) messages.

Regards,
Ziga



import os
import sys
import msvcrt

import win32con
import win32process
import win32security
import win32service

from twisted.python import win32



def getPythonArgs():
     &quot;&quot;&quot;
     Return the list of command line args that were used to start
     the current Python interpreter and were not stored in C{sys.argv}.

     These are the options that control the Python interpreter itself,
     like the Python executable, optimization level, warning filters,
     division behaviour and literal string handling.
     &quot;&quot;&quot;
     args = [sys.executable]
     for warnoption in sys.warnoptions:
         args.append(&quot;-W&quot;)
         args.append(warnoption)
     if type(1 / 2) is not int:
         args.append(&quot;-Qnew&quot;)
     if type(&quot;&quot;) is not str:
         args.append(&quot;-U&quot;)
     if not __debug__:
         if getPythonArgs.__doc__ is None:
             args.append(&quot;-OO&quot;)
         else:
             args.append(&quot;-O&quot;)
     return args



def daemonize():
     args = [os.path.abspath(__file__)] + sys.argv
     executable = sys.executable
     cmdline = win32.quoteArguments(getPythonArgs() + args)
     inherit = False

     flags = (win32process.CREATE_BREAKAWAY_FROM_JOB | # session leader
              win32process.CREATE_NEW_PROCESS_GROUP |  # group leader
              win32process.DETACHED_PROCESS) # no controlling terminal

     info = win32process.STARTUPINFO()
     win32process.CreateProcess(executable, cmdline, None, None,
                                inherit, flags, None, None, info)
     # Do what exec* functions do, let the OS do the cleanup.
     os._exit(0)



def daemonize2():
     args = [sys.argv[1], &quot;--nodaemon&quot;] + sys.argv[2:]
     executable = sys.executable
     cmdline = win32.quoteArguments(getPythonArgs() + args)
     inherit = True
     # create an invisible console
     flags = (win32process.CREATE_NO_WINDOW
     attributes = win32security.SECURITY_ATTRIBUTES()
     attributes.bInheritHandle = True
     station = win32service.CreateWindowStation(None, 0,
                                                win32con.GENERIC_READ |
                                                win32con.GENERIC_WRITE,
                                                attributes)
     station.SetProcessWindowStation()
     sname = win32service.GetUserObjectInformation(station,
                                                   win32service.UOI_NAME)
     dname = str(os.getpid())
     desktop = win32service.CreateDesktop(dname, 0,
                                          win32con.GENERIC_READ |
                                          win32con.GENERIC_WRITE,
                                          attributes)
     desktop.SetThreadDesktop()
     null = os.open(&quot;NUL&quot;, os.O_RDWR)
     handle = msvcrt.get_osfhandle(null)
     info = win32process.STARTUPINFO()
     info.lpDesktop = &quot;%s\\%s&quot; % (sname, dname)
     info.dwFlags = win32process.STARTF_USESTDHANDLES
     info.hStdInput = info.hStdOutput = info.hStdError = handle
     win32process.CreateProcess(executable, cmdline, None, None,
                                inherit, flags, None, None, info)
     # Same as above, exit as fast as possible.
     os._exit(0)



if __name__ == &quot;__main__&quot;:
     daemonize2()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053397.html">[Twisted-Python] Daemon processes on windows
</A></li>
	<LI>Next message (by thread): <A HREF="053404.html">[Twisted-Python] Daemon processes on windows
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53398">[ date ]</a>
              <a href="thread.html#53398">[ thread ]</a>
              <a href="subject.html#53398">[ subject ]</a>
              <a href="author.html#53398">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
