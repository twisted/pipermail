<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Way to fix memory leaks of external c module
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Way%20to%20fix%20memory%20leaks%20of%20external%20c%20module&In-Reply-To=%3C510C5A8D-FC8D-4DCE-8021-1F902D069ED5%40chown.lv%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053576.html">
   <LINK REL="Next"  HREF="053578.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Way to fix memory leaks of external c module</H1>
    <B>MƒÅrisR</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Way%20to%20fix%20memory%20leaks%20of%20external%20c%20module&In-Reply-To=%3C510C5A8D-FC8D-4DCE-8021-1F902D069ED5%40chown.lv%3E"
       TITLE="[Twisted-Python] Way to fix memory leaks of external c module">maris at chown.lv
       </A><BR>
    <I>Sat Nov 28 06:05:10 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053576.html">[Twisted-Python] ANN: StreamHarvester-0.1 Beta
</A></li>
        <LI>Next message (by thread): <A HREF="053578.html">[Twisted-Python] Way to fix memory leaks of external c module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53577">[ date ]</a>
              <a href="thread.html#53577">[ thread ]</a>
              <a href="subject.html#53577">[ subject ]</a>
              <a href="author.html#53577">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello!
Currently I'm trying to write small xmlrpc server for html data processing. Processing is done by html tidy lib, but the problem is that it has massive memory leak. 
As processing is blocking operation I'm running it in thread, but after some time and huge html document processing daemon eats all memory.
I wondering if its possible to load utidylib in thread, do processing and after this kill thread and release memory? Or maybe something like deferToProcess?
Thanks in advance!



#!/usr/bin/env python
# -*- coding: utf-8 -*-

import utidylib

from twisted.internet import epollreactor
epollreactor.install()

from twisted.internet import protocol, defer, threads, reactor
from twisted.web import xmlrpc, server
from twisted.python import log, threadpool

import sys
reload(sys)
sys.setdefaultencoding('utf-8')

log.startLogging(sys.stdout)

import codecs

import gc
gc.enable()
gc.set_debug(gc.DEBUG_LEAK)
gc.set_threshold(1)

class TidyProtocol(xmlrpc.XMLRPC):

    def xmlrpc_tidify(self, data):
        defered = threads.deferToThread(self.tidyParse, data)
        defered.addCallback(self.returnToClient)
        return defered

    def tidyParse(self, data):
        options =  {
                        'drop-proprietary-attributes': '1',
                        'output-xhtml': '1',
                        'wrap': '0',
                        'bare': '0',
                        'clean': '1',
                        'doctype': 'omit',
                        'show-body-only': '1',
                        'word-2000': '0',
                        'escape-cdata': '0',
                        'hide-comments': '1',
                        'force-output': '1',
                        'alt-text': '',
                        'show-errors': '0',
                        'show-warnings': '0',
                        'tidy-mark': '0',
                        'char-encoding': 'utf8',
                    }

        if data['html'] == None:
            return None
        else:
            htmldata = data['html'].encode()
            print &quot;Tidy start&quot;
            return tidy.parseString(htmldata, **options)

    def returnToClient(self, data):
        gc.collect()
        print &quot;Tidy end, retunring result&quot;
        return data
        
if __name__ == '__main__':
    r = TidyProtocol()
    reactor.listenTCP(1100, server.Site(r))
    reactor.run()




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053576.html">[Twisted-Python] ANN: StreamHarvester-0.1 Beta
</A></li>
	<LI>Next message (by thread): <A HREF="053578.html">[Twisted-Python] Way to fix memory leaks of external c module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53577">[ date ]</a>
              <a href="thread.html#53577">[ thread ]</a>
              <a href="subject.html#53577">[ subject ]</a>
              <a href="author.html#53577">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
