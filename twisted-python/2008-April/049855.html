<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Stackless/Twisted integration again
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Stackless/Twisted%20integration%20again&In-Reply-To=%3C715951.52196.qm%40web34201.mail.mud.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="049852.html">
   <LINK REL="Next"  HREF="049853.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Stackless/Twisted integration again</H1>
    <B>Andrew Francis</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Stackless/Twisted%20integration%20again&In-Reply-To=%3C715951.52196.qm%40web34201.mail.mud.yahoo.com%3E"
       TITLE="[Twisted-Python] Stackless/Twisted integration again">andrewfr_ice at yahoo.com
       </A><BR>
    <I>Sun Apr  6 12:23:48 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="049852.html">[Twisted-Python] Stackless/Twisted integration again
</A></li>
        <LI>Next message (by thread): <A HREF="049853.html">[Twisted-Python] Deferreds and Tasklets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49855">[ date ]</a>
              <a href="thread.html#49855">[ thread ]</a>
              <a href="subject.html#49855">[ subject ]</a>
              <a href="author.html#49855">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Simon and Colleages: 

&gt;<i>I note he recommends running a twisted server as a
</I>&gt;<i>tasklet.
</I>
I do this so both the Twisted reactor and the
Stackless scheduler can run without blocking each
other....

The Twisted Reactor and the Stackless Schedule start
their respective systems. Both the Stackless and
Twisted run() method assume that the application has
finished once the run() method returns.

Here is simple example

import stackless
from   twisted.internet    import reactor

def hello():
    print &quot;hello mom&quot;

stackless.tasklet(hello)()
reactor.run()
stackless.run()

This programme will hang. Why? The Twisted reactor is
running in the main tasklet and returns only after it
has been stopped (which is never in this example).
Only after the reactor has finished, will the
stackless scheduler start. Of course, this is not the
behaviour we want.

&gt;<i>factory = pb.PBClientFactory
</I>&gt;<i>reactor.connectTCP('127.0.0.1', 1234, Factory)
</I>&gt;<i># Load other tasklets here
</I>&gt;<i>stackless.tasklet(reactor.iterate)(1)
</I>
I have never used iterate(). I am having a hard time
finding an example of iterate() in action. Perhaps I
am wrong but I would assume iterate() is used in
conjunction with something like reactor.interleave()
so that something like a GUI can function properly.

&gt;<i>From my understanding, your example would produce
</I>something because in the iteration followed by a one
second delay, the client can actually complete a call.
However this seems accidental.

&gt;<i>factory = pb.PBClientFactory
</I>&gt;<i>reactor.connectTCP('127.0.0.1', 1234, Factory)
</I>&gt;<i># Load other tasklets here
</I>&gt;<i>while 1:
</I>&gt;<i>    stackless.tasklet(reactor.iterate)(1)
</I>&gt;<i>    stackless.schedule()
</I>
I don't understand iterate() well enough but I think
this will accidentally work sometimes. I don't have
time to run your programme but off hand, this is what
I think is happening:

1) Reactor tasklet is created. Since other tasklets
are ahead of it, it is not running.

2) stackless.schedule() kicks off the scheduling,
yielding the main tasklet and allowing the next
schedulable tasklet to run

3) Eventually the Twisted reactor runs. It does stuff.
You get results. However I don't believe it will yield
after that.

&gt;<i>I want to make the reactor a tasklet so it is
</I>included &gt;in the scheduler. 

Simon, stackless.tasklet(reactor.run)() will make the
Twisted reactor into a tasklet. However you need a way
to make it yield occasionally. That is why I use
task.LoopingCall(stackless.schedule). One nice feature
of this approach is that I do not have to alter the
Reactor.

I remember playing with PB a while ago. Here is the
post:

<A HREF="http://twistedmatrix.com/pipermail/twisted-python/2007-September/016000.html">http://twistedmatrix.com/pipermail/twisted-python/2007-September/016000.html</A>

I am enclosing some sample code so you can play with
it. The code may be a bit clunky because I was still
learning. Heck I am still learning :-)

Cheers,
Andrew

P.S - You may want to take out the 61 second sleep in
the PBServer. And it was neat to actually meet Bruce
Eckel at PyCon.




      ____________________________________________________________________________________
You rock. That's why Blockbuster's offering you one month of Blockbuster Total Access, No Cost.  
<A HREF="http://tc.deals.yahoo.com/tc/blockbuster/text5.com">http://tc.deals.yahoo.com/tc/blockbuster/text5.com</A>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: PBExample.py
Type: text/x-python
Size: 2814 bytes
Desc: 3974082329-PBExample.py
URL: &lt;/pipermail/twisted-python/attachments/20080406/2e4b8211/attachment-0004.py&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: PBServer.py
Type: text/x-python
Size: 662 bytes
Desc: 2825570039-PBServer.py
URL: &lt;/pipermail/twisted-python/attachments/20080406/2e4b8211/attachment-0005.py&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="049852.html">[Twisted-Python] Stackless/Twisted integration again
</A></li>
	<LI>Next message (by thread): <A HREF="049853.html">[Twisted-Python] Deferreds and Tasklets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49855">[ date ]</a>
              <a href="thread.html#49855">[ thread ]</a>
              <a href="subject.html#49855">[ subject ]</a>
              <a href="author.html#49855">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
