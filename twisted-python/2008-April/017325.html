<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] adbapi, transactions and threading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20adbapi%2C%20transactions%20and%20threading&In-Reply-To=b53c932d0804040801x2e417d57red0884f6b41265ea%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017324.html">
   <LINK REL="Next"  HREF="017356.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] adbapi, transactions and threading</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20adbapi%2C%20transactions%20and%20threading&In-Reply-To=b53c932d0804040801x2e417d57red0884f6b41265ea%40mail.gmail.com"
       TITLE="[Twisted-Python] adbapi, transactions and threading">exarkun at divmod.com
       </A><BR>
    <I>Fri Apr  4 12:09:15 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="017324.html">[Twisted-Python] adbapi, transactions and threading
</A></li>
        <LI>Next message: <A HREF="017356.html">[Twisted-Python] adbapi, transactions and threading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17325">[ date ]</a>
              <a href="thread.html#17325">[ thread ]</a>
              <a href="subject.html#17325">[ subject ]</a>
              <a href="author.html#17325">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 4 Apr 2008 17:01:40 +0200, Atilla &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">theatilla at gmail.com</A>&gt; wrote:
&gt;<i>I hope it won't be too confusing. I'm basically trying to make sure
</I>&gt;<i>I've grasped the concept - do correct me on anything I am wrong about
</I>&gt;<i>or my way of thinking confuses you, please.
</I>&gt;<i>
</I>&gt;<i>I'm not used to running blocking calls and deferToThread a lot, so I
</I>&gt;<i>wanted to make sure I understand that correctly.
</I>&gt;<i>
</I>&gt;<i>Basically, the way I understand it - adbapi is just a deferToThread
</I>&gt;<i>wrapper around the normal python API, correct? As in - if I used
</I>&gt;<i>something different to access my database, for example - sqlalchemy, I
</I>&gt;<i>would only need to appropriately wrap that functionality with
</I>&gt;<i>deferToThread, just as adbapi does?
</I>
Yes.

&gt;<i>
</I>&gt;<i>That's one thing. Now - what I'm trying to do in essence is to load
</I>&gt;<i>some big chunk of data out of the DB, process it, and save it back.
</I>&gt;<i>I'd use a nice chain of deffered calls - one runQuery, one for the
</I>&gt;<i>processing, and one runOperation. However, I need transaction
</I>&gt;<i>functionality, so unless I'm mistaken, my only choice is
</I>&gt;<i>runInteraction.
</I>
Right.

&gt;<i>
</I>&gt;<i>Since that's automatically ran in a separate thread, I see it as a
</I>&gt;<i>monolithic piece of code -&gt; query, processing call, saving query -&gt; no
</I>&gt;<i>deffereds can take place there. Am I wrong on that one? Even if so -
</I>&gt;<i>it won't be that bad for me, since good part of the processing will be
</I>&gt;<i>handled by an external library (GIL released - says so, more cores
</I>&gt;<i>used, makes me happy).
</I>
Correct.

&gt;<i>
</I>&gt;<i>That leads me to the next question - when I've got long code to run
</I>&gt;<i>and it happens to use an external, thread-safe, C library, releasing
</I>&gt;<i>the GIL, I should probably always take care to defer it to thread, if
</I>&gt;<i>I wanted to take advantage of multiple cores, correct? Otherwise, I
</I>&gt;<i>wouldn't have any parallelism gains, which I can get, because of the
</I>&gt;<i>GIL release. And let's say that my processing code can take a while
</I>&gt;<i>sometimes.
</I>
Yep.

&gt;<i>
</I>&gt;<i>Which leads me to the other question - what should I do in the case
</I>&gt;<i>where I need to occasionally run big chunks of code. No blocking
</I>&gt;<i>calls, just crunch something down. Is deferToThread the only solution
</I>&gt;<i>for that? Is the idea to compose that as big deffered chains so other
</I>&gt;<i>processing might run normally, instead of wait for the big function to
</I>&gt;<i>exit? Because deferToThread will only get me anything, if there's a
</I>&gt;<i>blocking call inside, or if I mange to get parallelism out of it, if
</I>&gt;<i>it's something handled by GIL-released code.
</I>
deferToThread is one solution (you can use processes instead of threads,
but that's roughly the same idea).  Deferred aren't sensible for CPU-bound
tasks.  They just make the implementation slower and more complex, and they
probably _don't_ allow other tasks to run, since a Deferred is just a way
to track results, it doesn't imply any special scheduling.  This means the
different chunks of your computation will still run all at once and block
other tasks from running unless you explicitly insert scheduling logic.  If
that is interesting, then twisted.internet.task.coiterate may be interesting.
However, having a thread-safe CPU-bound task (preferably one which is all
self-contained and doesn't need to talk to other APIs, certainly not Twisted
APIs) and running it in a thread with deferToThread is sensible.

&gt;<i>
</I>&gt;<i>Sorry if I sound too confusing, I'm trying to wrap it all in my head
</I>&gt;<i>before I dive in handling the service.
</I>&gt;<i>
</I>
Not very confusing at all. :)

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017324.html">[Twisted-Python] adbapi, transactions and threading
</A></li>
	<LI>Next message: <A HREF="017356.html">[Twisted-Python] adbapi, transactions and threading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17325">[ date ]</a>
              <a href="thread.html#17325">[ thread ]</a>
              <a href="subject.html#17325">[ subject ]</a>
              <a href="author.html#17325">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
