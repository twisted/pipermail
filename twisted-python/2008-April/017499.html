<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Non returning deferred result.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Non%20returning%20deferred%20result.&In-Reply-To=1208500550.4347.20.camel%40wolfwood">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017498.html">
   <LINK REL="Next"  HREF="017501.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Non returning deferred result.</H1>
    <B>Crispin Wellington</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Non%20returning%20deferred%20result.&In-Reply-To=1208500550.4347.20.camel%40wolfwood"
       TITLE="[Twisted-Python] Non returning deferred result.">cwellington at ccg.murdoch.edu.au
       </A><BR>
    <I>Fri Apr 18 02:48:20 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="017498.html">[Twisted-Python] Non returning deferred result.
</A></li>
        <LI>Next message: <A HREF="017501.html">[Twisted-Python] Non returning deferred result.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17499">[ date ]</a>
              <a href="thread.html#17499">[ thread ]</a>
              <a href="subject.html#17499">[ subject ]</a>
              <a href="author.html#17499">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Just a quick update. Doing a &quot;reactor.iterate()&quot; after the callback
fixed the behavoir. ie.

--------
deferred.callback( http.Response(responsecode.OK,
				{'content-type': http_headers.MimeType('text', 'html')},
				&quot;Success!&quot; ) )
reactor.iterate()
--------

so my new question is, is this the best way to do this? Is there a
better way? Also is reactor.iterate() threadsafe? Are there potential
problems callinf reactor.iterate() from a thread spawned off the running
reactor thread?

Kind Regards

Crispin Wellington
&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">cwellington at ccg.murdoch.edu.au</A>&gt;


On Fri, 2008-04-18 at 06:35 +0000, Crispin Wellington wrote:
&gt;<i> Hey everyone,
</I>&gt;<i> 
</I>&gt;<i> Sorry about the subject line, its a difficult problem to sum up in a
</I>&gt;<i> single line subject. Give me a little time to explain.
</I>&gt;<i> 
</I>&gt;<i> I'm using twisted.web2. I have a generic webservice over http. It
</I>&gt;<i> receives a file via standard POST http upload. It saves this to disk
</I>&gt;<i> using non blocking stream setup as outlines in web2.static.FileServer.
</I>&gt;<i> 
</I>&gt;<i> Now I don't immediately return a response, because another thread then
</I>&gt;<i> processes this file and builds an output file. So I return a deferred
</I>&gt;<i> from my render() function. When the output file is finished building,
</I>&gt;<i> the deferred callback is triggered with the http.Response() object and
</I>&gt;<i> the response is finally returned to the waiting http connection.
</I>&gt;<i> 
</I>&gt;<i> This DOES work except for a little strange behavoir. When the deferred
</I>&gt;<i> callback is triggered, the client doesn't see any response, the
</I>&gt;<i> connection just stays open. Then if I connect to the webservices from
</I>&gt;<i> anywhere, even a bad URL, I get my response suddenly back.
</I>&gt;<i> 
</I>&gt;<i> It's as if the callback is not triggered until some TCP activity cause
</I>&gt;<i> the main reactor to pump the pending requests or something. Is there
</I>&gt;<i> anyway to get this deferred callback to be recognised and processed
</I>&gt;<i> immediately? I could do a kind of hack, where the deferred callback is
</I>&gt;<i> called, and then a quick connection is made to the webservice to &quot;pump&quot;
</I>&gt;<i> the message through, but it doesn't seem very 'right' to me.
</I>&gt;<i> 
</I>&gt;<i> Heres some summary of the approach incase the devil is in the details...
</I>&gt;<i> 
</I>&gt;<i> My Resource class:
</I>&gt;<i> ==================
</I>&gt;<i> class UploadFile(resource.PostableResource):
</I>&gt;<i> 	# 1 gig is max file upload size
</I>&gt;<i> 	maxSize=1 * 1024 * 1024 * 1024
</I>&gt;<i> 	
</I>&gt;<i> 	def render(self, ctx):
</I>&gt;<i> 		&quot;&quot;&quot;Create the job for this upload and return the relevent deferred&quot;&quot;&quot;
</I>&gt;<i> 		request = iweb.IRequest(ctx)
</I>&gt;<i> 		
</I>&gt;<i> 		job=Job()
</I>&gt;<i> 		deferred = job.SubmitInput(request.files)				
</I>&gt;<i> 		
</I>&gt;<i> 		return deferred
</I>&gt;<i> 		
</I>&gt;<i> 
</I>&gt;<i> My deferred callback:
</I>&gt;<i> =====================
</I>&gt;<i> deferred.callback( http.Response(responsecode.OK,
</I>&gt;<i> 				{'content-type': http_headers.MimeType('text', 'html')},
</I>&gt;<i> 				&quot;Success!&quot; ) )
</I>&gt;<i> 
</I>&gt;<i> My TopLevel:
</I>&gt;<i> ============
</I>&gt;<i> class Toplevel(resource.PostableResource):
</I>&gt;<i> 	addSlash = True
</I>&gt;<i> 	def render(self, ctx):
</I>&gt;<i> 		return http.Response(responsecode.OK,
</I>&gt;<i> 				{'content-type':
</I>&gt;<i> 						http_headers.MimeType('text', 'html')},
</I>&gt;<i> 						&quot;&quot;&quot;
</I>&gt;<i> &lt;html&gt;
</I>&gt;<i>     &lt;form action=&quot;<A HREF="http://localhost:8080/uploadfile&quot;">http://localhost:8080/uploadfile&quot;</A>
</I>&gt;<i>             enctype=&quot;multipart/form-data&quot;
</I>&gt;<i>             method=&quot;post&quot;&gt;
</I>&gt;<i>         filename: &lt;input type=&quot;file&quot; name=&quot;filename&quot;&gt;
</I>&gt;<i> 		filename2: &lt;input type=&quot;file&quot; name=&quot;filename2&quot;&gt;
</I>&gt;<i>         &lt;input type=&quot;submit&quot; value=&quot;submit&quot;&gt;
</I>&gt;<i>     &lt;/form&gt;
</I>&gt;<i> &lt;/html&gt;
</I>&gt;<i> &quot;&quot;&quot;)
</I>&gt;<i> 	child_upload = UploadFile(jobqueue)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My server startup:
</I>&gt;<i> ==================
</I>&gt;<i> # Create the resource we will be serving
</I>&gt;<i> test = Toplevel()
</I>&gt;<i> 
</I>&gt;<i> # Setup default common access logging
</I>&gt;<i> res = log.LogWrapperResource(test)
</I>&gt;<i> log.DefaultCommonAccessLoggingObserver().start()
</I>&gt;<i> 
</I>&gt;<i> # Create the site and application objects
</I>&gt;<i> site = server.Site(res)
</I>&gt;<i> application = service.Application(&quot;demo&quot;)
</I>&gt;<i> 
</I>&gt;<i> # Serve it via standard HTTP on port 8080
</I>&gt;<i> s = strports.service('tcp:8080', channel.HTTPFactory(site))
</I>&gt;<i> s.setServiceParent(application)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Im running the application as:
</I>&gt;<i> 
</I>&gt;<i> twistd -noy server.py
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Twisted v8.0.1+, actually, the lastest SVN head.
</I>&gt;<i> 
</I>&gt;<i> Any one with more knowledge of twisted's internals have any ideas on
</I>&gt;<i> what is happening? Does anyone have any good ideas on how to make the
</I>&gt;<i> deferred callback trigger an immediate response (without opening a new
</I>&gt;<i> TCP connection to kick it into gear)?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>&gt;<i> 
</I>&gt;<i> Regards
</I>&gt;<i> Crispin Wellington
</I>&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">cwellington at ccg.murdoch.edu.au</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> 
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017498.html">[Twisted-Python] Non returning deferred result.
</A></li>
	<LI>Next message: <A HREF="017501.html">[Twisted-Python] Non returning deferred result.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17499">[ date ]</a>
              <a href="thread.html#17499">[ thread ]</a>
              <a href="subject.html#17499">[ subject ]</a>
              <a href="author.html#17499">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
