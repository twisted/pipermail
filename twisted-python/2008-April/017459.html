<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted Advice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted%20Advice&In-Reply-To=3c3d11cf0804160522m3c9bf1b5ubf12959165cdbe61%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017456.html">
   <LINK REL="Next"  HREF="017457.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted Advice</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted%20Advice&In-Reply-To=3c3d11cf0804160522m3c9bf1b5ubf12959165cdbe61%40mail.gmail.com"
       TITLE="[Twisted-Python] Twisted Advice">exarkun at divmod.com
       </A><BR>
    <I>Wed Apr 16 09:47:40 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="017456.html">[Twisted-Python] Twisted Advice
</A></li>
        <LI>Next message: <A HREF="017457.html">[Twisted-Python] documentation / kqueue / feedback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17459">[ date ]</a>
              <a href="thread.html#17459">[ thread ]</a>
              <a href="subject.html#17459">[ subject ]</a>
              <a href="author.html#17459">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 16 Apr 2008 13:22:58 +0100, Paul Wilson &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">paulalexwilson at gmail.com</A>&gt; wrote:
&gt;<i>Hi!
</I>&gt;<i>
</I>&gt;<i>I am researching technologies for building an application development
</I>&gt;<i>framework with Python, and have been interested in Twisted to manage
</I>&gt;<i>the network communication side of things. However, I read something
</I>&gt;<i>yesterday that appears to undermine the applicability of twisted for
</I>&gt;<i>my work. I've done quite a bit of reading around the subject since,
</I>&gt;<i>and have ended up confusing myself!
</I>&gt;<i>
</I>&gt;<i>A remote client accesses my server to get instructions on how to
</I>&gt;<i>progress a customer &quot;interaction.&quot; The remote client is itself a
</I>&gt;<i>server driven by a telephone call and keytone input. The remote client
</I>&gt;<i>could be servicing N calls (channels) simultaneously, and thus my
</I>&gt;<i>server needs to support N simultaneous TCP connections. Pretty
</I>&gt;<i>standard stuff.
</I>&gt;<i>
</I>&gt;<i>I would like to provide an environment where developers can write call
</I>&gt;<i>servicing applications with no knowledge of the network. I had rested
</I>&gt;<i>on a coroutine approach, whereby a developer could write something
</I>&gt;<i>like this:
</I>&gt;<i>
</I>&gt;<i>   response, events = (yield getKeyPress(SomePromptAnnouncement))
</I>&gt;<i>
</I>
Just to clarify - this looks like a generator rather than a coroutine.

&gt;<i>With the response, the developer can do an undefined number of things,
</I>&gt;<i>taking an undefined amount of time. During this time, management
</I>&gt;<i>events can arrive on a separate port, to which the developer gets
</I>&gt;<i>knowledge of through the yield statement.
</I>&gt;<i>
</I>&gt;<i>On the other side of this generator is a scheduler which takes
</I>&gt;<i>instructions such as &quot;getKeyPress&quot; and passes it through twisted to
</I>&gt;<i>the remote client, such that it can play the announcement and get a
</I>&gt;<i>keypress. The scheduler gets the response and sends to back to the
</I>&gt;<i>generator, along with any events that have arrived on this separate
</I>&gt;<i>port.
</I>&gt;<i>
</I>&gt;<i>When a call/connection arrives, the client will send an opening
</I>&gt;<i>line(s) to which I was specify the correct LineRecieved method. This
</I>&gt;<i>will trigger some scheduler code defined elsewhere via a deferred,
</I>&gt;<i>which will prompt the developer's code for some instructions, such as
</I>&gt;<i>&quot;PlayPrompt&quot;. Am I correct in thinking that while a developer's code
</I>&gt;<i>is executing, all other connections are paused, and that the twisted
</I>&gt;<i>server will not accept new connections until it returns?
</I>
Yes, that's correct.  Twisted is single-threaded - it invokes event
handlers in the same thread it uses to monitor event sources.  As long
as an event handler is running, event sources are not monitored for
events and no other handlers will be invoked.

&gt;<i>
</I>&gt;<i>My original assumption was that Twisted would spawn a new thread
</I>&gt;<i>within which the scheduler would be set to run to manage the
</I>&gt;<i>communication for the duration of the customer call/interaction.
</I>&gt;<i>However, the approach taken by twisted is that if the developer's code
</I>&gt;<i>got itself in a muddle or infinite loop or took a very long time
</I>&gt;<i>accessing a database, the rest of the application would just be
</I>&gt;<i>frozen.
</I>
Generally speaking, Twisted will only create a thread when application
code asks it to.

&gt;<i>
</I>&gt;<i>I wrote a quick test app that defers to a function that sleeps then
</I>&gt;<i>returns its response line. During the 20 seconds that the test server
</I>&gt;<i>took to return a line, the server would not accept any other requests
</I>&gt;<i>until the sleep function ended.
</I>
The &quot;defers to a function&quot; language is a bit confusing.  However, your
conclusion sounds right.  If you block the reactor thread, nothing else
will happen.

&gt;<i>Clearly, I must be missing something; I have designed my application
</I>&gt;<i>upon the wrong axis. If so, I have some misunderstanding as to how to
</I>&gt;<i>properly structure an application like this upon Twisted. Or, twisted
</I>&gt;<i>is a framework whereby the response to a network event is expect to
</I>&gt;<i>arrive immediately.
</I>
It's not necessary for responses to arrive immediately.  Responses just
need to be obtained without blocking.  For example, if getting a response
involves talking to someone else over the network, then Twisted has some
networking APIs that don't block. ;)  Likewise, twisted.enterprise lets
you talk to a rdbm (it actually uses threads, but it mostly doesn't show
that to you).

&gt;<i>I have seen &quot;deferToThread&quot; mentioned but I cannot find enough
</I>&gt;<i>documentation to decide whether it's what I need or not. Or perhaps
</I>&gt;<i>callInThread() is what I need?
</I>
One of these may be appropriate.  You could decide that in your application
framework, user code is always run in a non-reactor thread.  This is easily
accomplished: your event handler just needs to invoke user code in a thread
instead of directly.  deferToThread lets you run a function in a thread and
gives you a Deferred which will be called back with the return value of the
function when it returns or which will errback if it raises an exception.  
callInThread is lower level, not exposing the result of the function.

&gt;<i>
</I>&gt;<i>Any suggestions about this would be very much appreciated. Even
</I>&gt;<i>better, if anybody knows of good documentation/tutorials they can
</I>&gt;<i>point me to, that would be appreciated also.
</I>
It sounds like you're looking for deferToThread or one of its friends.
Note however that just throwing user code into a thread doesn't mean
programmers can be oblivious to their environment.  It simply trades the
need to pay attention to when you block and for how long for the more
complex task of paying attention to thread safety.  If each task is
isolated from all others, this may be a good trade-off to make, but if
there's shared state it may not be.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017456.html">[Twisted-Python] Twisted Advice
</A></li>
	<LI>Next message: <A HREF="017457.html">[Twisted-Python] documentation / kqueue / feedback
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17459">[ date ]</a>
              <a href="thread.html#17459">[ thread ]</a>
              <a href="subject.html#17459">[ subject ]</a>
              <a href="author.html#17459">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
