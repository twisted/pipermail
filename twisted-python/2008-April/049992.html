<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted Advice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20Advice&In-Reply-To=%3C3c3d11cf0804170404k420a42ebr4ca70515f84ed322%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="049969.html">
   <LINK REL="Next"  HREF="049994.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted Advice</H1>
    <B>Paul Wilson</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20Advice&In-Reply-To=%3C3c3d11cf0804170404k420a42ebr4ca70515f84ed322%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Twisted Advice">paulalexwilson at gmail.com
       </A><BR>
    <I>Thu Apr 17 05:04:13 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="049969.html">[Twisted-Python] Twisted Advice
</A></li>
        <LI>Next message (by thread): <A HREF="049994.html">[Twisted-Python] Twisted Advice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49992">[ date ]</a>
              <a href="thread.html#49992">[ thread ]</a>
              <a href="subject.html#49992">[ subject ]</a>
              <a href="author.html#49992">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>  &gt;
</I>&gt;<i>  &gt;I would like to provide an environment where developers can write call
</I>&gt;<i>  &gt;servicing applications with no knowledge of the network. I had rested
</I>&gt;<i>  &gt;on a coroutine approach, whereby a developer could write something
</I>&gt;<i>  &gt;like this:
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;   response, events = (yield getKeyPress(SomePromptAnnouncement))
</I>&gt;<i>  &gt;
</I>&gt;<i>
</I>&gt;<i>  Just to clarify - this looks like a generator rather than a coroutine.
</I>&gt;<i>
</I>&gt;<i>  &gt;With the response, the developer can do an undefined number of things,
</I>&gt;<i>  &gt;taking an undefined amount of time. During this time, management
</I>&gt;<i>  &gt;events can arrive on a separate port, to which the developer gets
</I>&gt;<i>  &gt;knowledge of through the yield statement.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;On the other side of this generator is a scheduler which takes
</I>&gt;<i>  &gt;instructions such as &quot;getKeyPress&quot; and passes it through twisted to
</I>&gt;<i>  &gt;the remote client, such that it can play the announcement and get a
</I>&gt;<i>  &gt;keypress. The scheduler gets the response and sends to back to the
</I>&gt;<i>  &gt;generator, along with any events that have arrived on this separate
</I>&gt;<i>  &gt;port.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;When a call/connection arrives, the client will send an opening
</I>&gt;<i>  &gt;line(s) to which I was specify the correct LineRecieved method. This
</I>&gt;<i>  &gt;will trigger some scheduler code defined elsewhere via a deferred,
</I>&gt;<i>  &gt;which will prompt the developer's code for some instructions, such as
</I>&gt;<i>  &gt;&quot;PlayPrompt&quot;. Am I correct in thinking that while a developer's code
</I>&gt;<i>  &gt;is executing, all other connections are paused, and that the twisted
</I>&gt;<i>  &gt;server will not accept new connections until it returns?
</I>&gt;<i>
</I>&gt;<i>  Yes, that's correct.  Twisted is single-threaded - it invokes event
</I>&gt;<i>  handlers in the same thread it uses to monitor event sources.  As long
</I>&gt;<i>  as an event handler is running, event sources are not monitored for
</I>&gt;<i>  events and no other handlers will be invoked.
</I>&gt;<i>
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;My original assumption was that Twisted would spawn a new thread
</I>&gt;<i>  &gt;within which the scheduler would be set to run to manage the
</I>&gt;<i>  &gt;communication for the duration of the customer call/interaction.
</I>&gt;<i>  &gt;However, the approach taken by twisted is that if the developer's code
</I>&gt;<i>  &gt;got itself in a muddle or infinite loop or took a very long time
</I>&gt;<i>  &gt;accessing a database, the rest of the application would just be
</I>&gt;<i>  &gt;frozen.
</I>&gt;<i>
</I>&gt;<i>  Generally speaking, Twisted will only create a thread when application
</I>&gt;<i>  code asks it to.
</I>&gt;<i>
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;I wrote a quick test app that defers to a function that sleeps then
</I>&gt;<i>  &gt;returns its response line. During the 20 seconds that the test server
</I>&gt;<i>  &gt;took to return a line, the server would not accept any other requests
</I>&gt;<i>  &gt;until the sleep function ended.
</I>&gt;<i>
</I>&gt;<i>  The &quot;defers to a function&quot; language is a bit confusing.  However, your
</I>&gt;<i>  conclusion sounds right.  If you block the reactor thread, nothing else
</I>&gt;<i>  will happen.
</I>&gt;<i>
</I>&gt;<i>  &gt;Clearly, I must be missing something; I have designed my application
</I>&gt;<i>  &gt;upon the wrong axis. If so, I have some misunderstanding as to how to
</I>&gt;<i>  &gt;properly structure an application like this upon Twisted. Or, twisted
</I>&gt;<i>  &gt;is a framework whereby the response to a network event is expect to
</I>&gt;<i>  &gt;arrive immediately.
</I>&gt;<i>
</I>&gt;<i>  It's not necessary for responses to arrive immediately.  Responses just
</I>&gt;<i>  need to be obtained without blocking.  For example, if getting a response
</I>&gt;<i>  involves talking to someone else over the network, then Twisted has some
</I>&gt;<i>  networking APIs that don't block. ;)  Likewise, twisted.enterprise lets
</I>&gt;<i>  you talk to a rdbm (it actually uses threads, but it mostly doesn't show
</I>&gt;<i>  that to you).
</I>
&gt;<i>  &gt;I have seen &quot;deferToThread&quot; mentioned but I cannot find enough
</I>&gt;<i>  &gt;documentation to decide whether it's what I need or not. Or perhaps
</I>&gt;<i>  &gt;callInThread() is what I need?
</I>&gt;<i>
</I>&gt;<i>  One of these may be appropriate.  You could decide that in your application
</I>&gt;<i>  framework, user code is always run in a non-reactor thread.  This is easily
</I>&gt;<i>  accomplished: your event handler just needs to invoke user code in a thread
</I>&gt;<i>  instead of directly.  deferToThread lets you run a function in a thread and
</I>&gt;<i>  gives you a Deferred which will be called back with the return value of the
</I>&gt;<i>  function when it returns or which will errback if it raises an exception.
</I>&gt;<i>  callInThread is lower level, not exposing the result of the function.
</I>
Ahh. Okay; thanks for this. deferToThread looks like a good option
here and seems to fit what I'm looking for. From experience, can you
point me towards some good code that uses deferToThread?

&gt;<i>  &gt;
</I>&gt;<i>  &gt;Any suggestions about this would be very much appreciated. Even
</I>&gt;<i>  &gt;better, if anybody knows of good documentation/tutorials they can
</I>&gt;<i>  &gt;point me to, that would be appreciated also.
</I>&gt;<i>
</I>&gt;<i>  It sounds like you're looking for deferToThread or one of its friends.
</I>&gt;<i>  Note however that just throwing user code into a thread doesn't mean
</I>&gt;<i>  programmers can be oblivious to their environment.  It simply trades the
</I>&gt;<i>  need to pay attention to when you block and for how long for the more
</I>&gt;<i>  complex task of paying attention to thread safety.  If each task is
</I>&gt;<i>  isolated from all others, this may be a good trade-off to make, but if
</I>&gt;<i>  there's shared state it may not be.
</I>
Thanks for your reply; there are some subtle and difficult questions
to answer here. I'd like each instance of the developer's code to be
isolated with it's own state using threading.local, but ultimately
I'll use deferToThread to set it all up.

I assume that I can use some threadsafe implementation (if the GIL
doesn't enforce that anyway) of a dictionary to store the global
information between each call handling thread.

Thanks again for your time.

&gt;<i>  Jean-Paul
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="049969.html">[Twisted-Python] Twisted Advice
</A></li>
	<LI>Next message (by thread): <A HREF="049994.html">[Twisted-Python] Twisted Advice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#49992">[ date ]</a>
              <a href="thread.html#49992">[ thread ]</a>
              <a href="subject.html#49992">[ subject ]</a>
              <a href="author.html#49992">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
