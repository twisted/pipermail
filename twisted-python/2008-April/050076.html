<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Strange behavior when transferring large strings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Strange%20behavior%20when%20transferring%20large%20strings&In-Reply-To=%3C480EF639.3010008%40evotex.ch%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="050075.html">
   <LINK REL="Next"  HREF="050078.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Strange behavior when transferring large strings</H1>
    <B>Gabriel Rossetti</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Strange%20behavior%20when%20transferring%20large%20strings&In-Reply-To=%3C480EF639.3010008%40evotex.ch%3E"
       TITLE="[Twisted-Python] Strange behavior when transferring large strings">mailing_lists at evotex.ch
       </A><BR>
    <I>Wed Apr 23 02:41:29 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="050075.html">[Twisted-Python] Strange behavior when transferring large strings
</A></li>
        <LI>Next message (by thread): <A HREF="050078.html">[Twisted-Python] Strange behavior when transferring large strings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50076">[ date ]</a>
              <a href="thread.html#50076">[ thread ]</a>
              <a href="subject.html#50076">[ subject ]</a>
              <a href="author.html#50076">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Gabriel Rossetti wrote:
&gt;<i> Gabriel Rossetti wrote:
</I>&gt;&gt;<i> Hello,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have been trying to use the producer/consumer paradigm to transfer 
</I>&gt;&gt;<i> large strings. I've been having trouble because I have strange things 
</I>&gt;&gt;<i> going on, but I now suspect it isn't the P/C that's not working, 
</I>&gt;&gt;<i> because it works fine with smaller strings than the ones I'm having 
</I>&gt;&gt;<i> trouble with, so I suspect the problem comes from elsewhere. What 
</I>&gt;&gt;<i> happens is it starts off fine, but then the destination at some point 
</I>&gt;&gt;<i> only gets part of the string but the source has already sent 
</I>&gt;&gt;<i> everything, closed it's transport and called stopProducing(). Could 
</I>&gt;&gt;<i> there be some internal buffering problem, like I'm sending too much 
</I>&gt;&gt;<i> data at too high of a throughput, or maybe something like some sort 
</I>&gt;&gt;<i> of max time a socket can stay open or something? If I tell it to 
</I>&gt;&gt;<i> split the string up into smaller parts, it doesn't change anything, 
</I>&gt;&gt;<i> if I make the string smaller, whatever the size of each chunk, it 
</I>&gt;&gt;<i> transfers fine.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks,
</I>&gt;&gt;<i> Gabriel
</I>&gt;&gt;<i>
</I>&gt;<i> I removed the P/C code and used the previous version and the problem 
</I>&gt;<i> persists, if I send a XML msg (very small XML part) with a data 
</I>&gt;<i> payload containing a string generated like this :
</I>&gt;<i>
</I>&gt;<i>    initialMsg = &quot;&quot;.join([str(x) for x in range(5000)])
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> which is 10374 bytes of data (including the XML), this makes me 
</I>&gt;<i> suspect that there is maybe some sort of buffer or something that is 
</I>&gt;<i> full and doesn't have the time to empty and twisted stops working or 
</I>&gt;<i> something. I'm using the 2.5 version since Ubuntu hasn't upgraded (and 
</I>&gt;<i> apparently won't upgrade until the lenny) their version yet and I 
</I>&gt;<i> can't get it to compile from source (yes, I installed python-dev and 
</I>&gt;<i> build-essentials), so maybe it's a problem only to this version. Does 
</I>&gt;<i> anyone have an Idea of what the problem is? I'm using the following 
</I>&gt;<i> code to send messages, I don't think that's the problem but you never 
</I>&gt;<i> know :
</I>&gt;<i>
</I>&gt;<i>    def sendMessage(address, port, message, needAnswer=False):
</I>&gt;<i>
</I>&gt;<i>        d = defer.Deferred() if needAnswer else None
</I>&gt;<i>              class MessageSender(Protocol):
</I>&gt;<i>
</I>&gt;<i>            def sendMessage(self, msg):
</I>&gt;<i>                if domish.IElement.providedBy(msg):
</I>&gt;<i>                    msg = msg.toXml()
</I>&gt;<i>                       if isinstance(msg, unicode):
</I>&gt;<i>                    msg = msg.encode('utf-8')
</I>&gt;<i>                                  self.transport.write(msg)
</I>&gt;<i>                          def dataReceived(self, data):
</I>&gt;<i>                d.callback(data)
</I>&gt;<i>                  def gotProtocol(proto):
</I>&gt;<i>            proto.sendMessage(message)
</I>&gt;<i>            if(not needAnswer):
</I>&gt;<i>                proto.transport.loseConnection()
</I>&gt;<i>
</I>&gt;<i>        c = ClientCreator(reactor, MessageSender)
</I>&gt;<i>        c.connectTCP(address, port).addCallback(gotProtocol)
</I>&gt;<i>        return d
</I>&gt;<i>
</I>&gt;<i>   Gabriel
</I>&gt;<i>
</I>&gt;<i>
</I>Ok, so apparently it (Twisted, Python, the OS?) can buffer and send up 
to 16k, after that it splits the message up, thus this would explain the 
lockup, since the app expects a whole XML message and can't process the 
second part correctly. So if I understand it correctly, even when I use 
the P/C paradigm, it waits until the buffer is full before sending the 
message, so when I get the message on the other side, I only get part of 
it, the other half is a new message/data arrival, and thus like I said 
above, the XML is not correct.

Does anyone have an idea of how to solve this?

Thanks,
Gabriel


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="050075.html">[Twisted-Python] Strange behavior when transferring large strings
</A></li>
	<LI>Next message (by thread): <A HREF="050078.html">[Twisted-Python] Strange behavior when transferring large strings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50076">[ date ]</a>
              <a href="thread.html#50076">[ thread ]</a>
              <a href="subject.html#50076">[ subject ]</a>
              <a href="author.html#50076">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
