<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Non returning deferred result.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Non%20returning%20deferred%20result.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017611.html">
   <LINK REL="Next"  HREF="017499.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Non returning deferred result.</H1>
    <B>Crispin Wellington</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Non%20returning%20deferred%20result.&In-Reply-To="
       TITLE="[Twisted-Python] Non returning deferred result.">cwellington at ccg.murdoch.edu.au
       </A><BR>
    <I>Fri Apr 18 02:35:50 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="017611.html">[Twisted-Python] [RFC] Deprecation Policy
</A></li>
        <LI>Next message: <A HREF="017499.html">[Twisted-Python] Non returning deferred result.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17498">[ date ]</a>
              <a href="thread.html#17498">[ thread ]</a>
              <a href="subject.html#17498">[ subject ]</a>
              <a href="author.html#17498">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey everyone,

Sorry about the subject line, its a difficult problem to sum up in a
single line subject. Give me a little time to explain.

I'm using twisted.web2. I have a generic webservice over http. It
receives a file via standard POST http upload. It saves this to disk
using non blocking stream setup as outlines in web2.static.FileServer.

Now I don't immediately return a response, because another thread then
processes this file and builds an output file. So I return a deferred
from my render() function. When the output file is finished building,
the deferred callback is triggered with the http.Response() object and
the response is finally returned to the waiting http connection.

This DOES work except for a little strange behavoir. When the deferred
callback is triggered, the client doesn't see any response, the
connection just stays open. Then if I connect to the webservices from
anywhere, even a bad URL, I get my response suddenly back.

It's as if the callback is not triggered until some TCP activity cause
the main reactor to pump the pending requests or something. Is there
anyway to get this deferred callback to be recognised and processed
immediately? I could do a kind of hack, where the deferred callback is
called, and then a quick connection is made to the webservice to &quot;pump&quot;
the message through, but it doesn't seem very 'right' to me.

Heres some summary of the approach incase the devil is in the details...

My Resource class:
==================
class UploadFile(resource.PostableResource):
	# 1 gig is max file upload size
	maxSize=1 * 1024 * 1024 * 1024
	
	def render(self, ctx):
		&quot;&quot;&quot;Create the job for this upload and return the relevent deferred&quot;&quot;&quot;
		request = iweb.IRequest(ctx)
		
		job=Job()
		deferred = job.SubmitInput(request.files)				
		
		return deferred
		

My deferred callback:
=====================
deferred.callback( http.Response(responsecode.OK,
				{'content-type': http_headers.MimeType('text', 'html')},
				&quot;Success!&quot; ) )

My TopLevel:
============
class Toplevel(resource.PostableResource):
	addSlash = True
	def render(self, ctx):
		return http.Response(responsecode.OK,
				{'content-type':
						http_headers.MimeType('text', 'html')},
						&quot;&quot;&quot;
&lt;html&gt;
    &lt;form action=&quot;<A HREF="http://localhost:8080/uploadfile&quot;">http://localhost:8080/uploadfile&quot;</A>
            enctype=&quot;multipart/form-data&quot;
            method=&quot;post&quot;&gt;
        filename: &lt;input type=&quot;file&quot; name=&quot;filename&quot;&gt;
		filename2: &lt;input type=&quot;file&quot; name=&quot;filename2&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;submit&quot;&gt;
    &lt;/form&gt;
&lt;/html&gt;
&quot;&quot;&quot;)
	child_upload = UploadFile(jobqueue)


My server startup:
==================
# Create the resource we will be serving
test = Toplevel()

# Setup default common access logging
res = log.LogWrapperResource(test)
log.DefaultCommonAccessLoggingObserver().start()

# Create the site and application objects
site = server.Site(res)
application = service.Application(&quot;demo&quot;)

# Serve it via standard HTTP on port 8080
s = strports.service('tcp:8080', channel.HTTPFactory(site))
s.setServiceParent(application)




Im running the application as:

twistd -noy server.py



Twisted v8.0.1+, actually, the lastest SVN head.

Any one with more knowledge of twisted's internals have any ideas on
what is happening? Does anyone have any good ideas on how to make the
deferred callback trigger an immediate response (without opening a new
TCP connection to kick it into gear)?


Thanks

Regards
Crispin Wellington
&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">cwellington at ccg.murdoch.edu.au</A>&gt;





</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017611.html">[Twisted-Python] [RFC] Deprecation Policy
</A></li>
	<LI>Next message: <A HREF="017499.html">[Twisted-Python] Non returning deferred result.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17498">[ date ]</a>
              <a href="thread.html#17498">[ thread ]</a>
              <a href="subject.html#17498">[ subject ]</a>
              <a href="author.html#17498">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
