<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20and%20Thread%2C%0A%20thread%20not%20running%20when%20twisted%20app%20is%20running%20as%20service&In-Reply-To=%3CCAEeXt4P2Tiez-Fey1_ejY8EUu%2BWSP58bp4j0PzZ09y%3DtjEX_mQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065107.html">
   <LINK REL="Next"  HREF="065109.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20and%20Thread%2C%0A%20thread%20not%20running%20when%20twisted%20app%20is%20running%20as%20service&In-Reply-To=%3CCAEeXt4P2Tiez-Fey1_ejY8EUu%2BWSP58bp4j0PzZ09y%3DtjEX_mQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri May 22 07:39:54 MDT 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065107.html">[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service
</A></li>
        <LI>Next message (by thread): <A HREF="065109.html">[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65108">[ date ]</a>
              <a href="thread.html#65108">[ thread ]</a>
              <a href="subject.html#65108">[ subject ]</a>
              <a href="author.html#65108">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, May 21, 2020 at 4:46 PM Sereysethy TOUCH &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">touch.sereysethy at gmail.com</A>&gt;
wrote:

&gt;<i> I am on MacOS, it is a development phase, but deployment will be on Linux.
</I>&gt;<i>
</I>&gt;<i> It is hard to run dtrace/dtruss on MacOS due to the &quot;system integrity
</I>&gt;<i> protection&quot; on MacOS. I got some output but very limited information.
</I>&gt;<i>
</I>&gt;<i> So if there is a workaround you might suggest?
</I>&gt;<i>
</I>
I would definitely recommend nailing down the exact cause of the problem.
I think that system integrity protection can be bypassed, perhaps by
creating a virtualenv?  I am not particularly familiar with macOS but I'm
sure there's some good information somewhere out there.

If the problem is the blocking network operations performed by
`PolicyClient` then you'll probably have to move even the instantiation of
that class to a separate thread.  This is probably good anyway, since it's
not necessarily the case that it is safe to create the object in one thread
and then use it in another.  Better to create and use it all in the same
thread.

Jean-Paul


&gt;<i>
</I>&gt;<i> TS
</I>&gt;<i>
</I>&gt;<i> On Thu, May 21, 2020 at 10:20 PM Jean-Paul Calderone &lt;
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On Thu, May 21, 2020 at 3:56 PM Sereysethy TOUCH &lt;
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">touch.sereysethy at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi Jean-Paul,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I found the error after working on a short, self contained, correcte
</I>&gt;&gt;&gt;<i> example. It is not about twisted and normal thread in general, but
</I>&gt;&gt;&gt;<i> something else.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> After more tests, I come to realise that whenever I instantiate this
</I>&gt;&gt;&gt;<i> class PolicyClient from this library
</I>&gt;&gt;&gt;<i> <A HREF="https://github.com/ray-project/ray/blob/master/rllib/env/policy_client.py">https://github.com/ray-project/ray/blob/master/rllib/env/policy_client.py</A> in
</I>&gt;&gt;&gt;<i> my protocol or just anywhere, twisted app either freezes or terminates, and
</I>&gt;&gt;&gt;<i> this *only* happens when the app runs as a daemon, created using a
</I>&gt;&gt;&gt;<i> service (.tac file).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I hope you can take a look at the class PolicyClient, why it causes
</I>&gt;&gt;&gt;<i> problem to reactor main loop. Please point me to where the idea might come
</I>&gt;&gt;&gt;<i> from.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I can give you the example but not sure if it is enough, as the client
</I>&gt;&gt;&gt;<i> needs to connect to a server.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It looks like PolicyClient does a blocking HTTP request in __init__.
</I>&gt;&gt;<i> Since PolicyClient is instantiated in the reactor thread, this will block
</I>&gt;&gt;<i> the reactor.  Perhaps this call is hanging for some reason when the process
</I>&gt;&gt;<i> has daemonized?  This would be unusual but not unheard of.  For example,
</I>&gt;&gt;<i> there are macOS environments where a process does not have access to the
</I>&gt;&gt;<i> network if it is not associated with a windowing session.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What platform do you observe the problem on, and what more can you learn
</I>&gt;&gt;<i> about what the process does on its way to hanging (eg can you run strace on
</I>&gt;&gt;<i> it)?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Jean-Paul
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thank you,
</I>&gt;&gt;&gt;<i> TS
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Thu, May 21, 2020 at 5:23 PM Jean-Paul Calderone &lt;
</I>&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On Thu, May 21, 2020 at 10:58 AM Sereysethy TOUCH &lt;
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">touch.sereysethy at gmail.com</A>&gt; wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I am developing a twisted app, and it runs as a service using twistd
</I>&gt;&gt;&gt;&gt;&gt;<i> -y to start the app.
</I>&gt;&gt;&gt;&gt;&gt;<i> I am having a problem of running a thread. I know it is not
</I>&gt;&gt;&gt;&gt;&gt;<i> recommended to use thread, but the library that I use, the object created
</I>&gt;&gt;&gt;&gt;&gt;<i> is running in a thread.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Here is the problem:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> 1) if I start reactor by running reactor.run() directly, thread is
</I>&gt;&gt;&gt;&gt;&gt;<i> running fine
</I>&gt;&gt;&gt;&gt;&gt;<i> 2) if I run it as a service using twisted, the thread is not running,
</I>&gt;&gt;&gt;&gt;&gt;<i> it runs but it seems to be blocked, because I tried to write something to
</I>&gt;&gt;&gt;&gt;&gt;<i> file using time.sleep(), but file is empty.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Is there something that I miss? How can I debug this?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> A good next step would be to create at Short, Self Contained, Correct
</I>&gt;&gt;&gt;&gt;<i> (Compilable), Example &lt;<A HREF="http://sscce.org/">http://sscce.org/</A>&gt; and share it.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Jean-Paul
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Thank you,
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> TS
</I>&gt;&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-Python mailing list
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20200522/ee4ab853/attachment.htm&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065107.html">[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service
</A></li>
	<LI>Next message (by thread): <A HREF="065109.html">[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65108">[ date ]</a>
              <a href="thread.html#65108">[ thread ]</a>
              <a href="subject.html#65108">[ subject ]</a>
              <a href="author.html#65108">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
