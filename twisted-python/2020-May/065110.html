<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20and%20Thread%2C%0A%20thread%20not%20running%20when%20twisted%20app%20is%20running%20as%20service&In-Reply-To=%3CCAJB%3DZ84CPm6YFrS-TdDtCN6-bhWNCzFLvbNpkaLRzjMBLfWwjA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065109.html">
   <LINK REL="Next"  HREF="065099.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service</H1>
    <B>Sereysethy TOUCH</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20and%20Thread%2C%0A%20thread%20not%20running%20when%20twisted%20app%20is%20running%20as%20service&In-Reply-To=%3CCAJB%3DZ84CPm6YFrS-TdDtCN6-bhWNCzFLvbNpkaLRzjMBLfWwjA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service">touch.sereysethy at gmail.com
       </A><BR>
    <I>Fri May 22 13:50:03 MDT 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065109.html">[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service
</A></li>
        <LI>Next message (by thread): <A HREF="065099.html">[Twisted-Python] unified filesystem API
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65110">[ date ]</a>
              <a href="thread.html#65110">[ thread ]</a>
              <a href="subject.html#65110">[ subject ]</a>
              <a href="author.html#65110">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

After I tested it on Linux, everything works fine. So I think the problem
is related to MacOS restriction. I already reported the problem to the
maintainers, because the library is supposed to work on both Linux and
MacOS. But this new thread is killing the twisted main reactor.

By the way I have another question regarding ssh client. I developed an ssh
client, after authentication is made, I dont want to open a channel
directly in serviceStarted in connection, I want to keep the connection so
that I can use to open channel for doing exec later, my question is where
should I keep that connection? Currently in my transport I add a defer in
which it will be later called to create another object that I control, the
defer is called back in serviceStarted, which I pass the connection object.
I am not sure what is a correct way to do it. For now I feel like it is a
cycling reference: transport -&gt; connection -&gt; transport -&gt; my object to
control connection.

Thanks,
TS

On Fri, May 22, 2020 at 6:16 PM Barry Scott &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">barry.scott at forcepoint.com</A>&gt;
wrote:

&gt;<i> On Thursday, 21 May 2020 21:45:44 BST Sereysethy TOUCH wrote:
</I>&gt;<i> &gt; I am on MacOS, it is a development phase, but deployment will be on
</I>&gt;<i> Linux.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; It is hard to run dtrace/dtruss on MacOS due to the &quot;system integrity
</I>&gt;<i> &gt; protection&quot; on MacOS. I got some output but very limited information.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So if there is a workaround you might suggest?
</I>&gt;<i>
</I>&gt;<i> Why bother debugging it on macOS it never has to work there?
</I>&gt;<i>
</I>&gt;<i> If you are targetting linux then develop and test in linux I'd recommend.
</I>&gt;<i> I use VMware fusion on the mac and run VMs for the target
</I>&gt;<i> environements I need. Works very well.
</I>&gt;<i>
</I>&gt;<i> Barry
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; TS
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Thu, May 21, 2020 at 10:20 PM Jean-Paul Calderone &lt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; On Thu, May 21, 2020 at 3:56 PM Sereysethy TOUCH &lt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">touch.sereysethy at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt;&gt; Hi Jean-Paul,
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; I found the error after working on a short, self contained, correcte
</I>&gt;<i> &gt; &gt;&gt; example. It is not about twisted and normal thread in general, but
</I>&gt;<i> &gt; &gt;&gt; something else.
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; After more tests, I come to realise that whenever I instantiate this
</I>&gt;<i> &gt; &gt;&gt; class PolicyClient from this library
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> <A HREF="https://github.com/ray-project/ray/blob/master/rllib/env/policy_client.py">https://github.com/ray-project/ray/blob/master/rllib/env/policy_client.py</A>
</I>&gt;<i> &gt; &gt;&gt; in my protocol or just anywhere, twisted app either freezes or
</I>&gt;<i> &gt; &gt;&gt; terminates, and this *only* happens when the app runs as a daemon,
</I>&gt;<i> &gt; &gt;&gt; created using a service (.tac file).
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; I hope you can take a look at the class PolicyClient, why it causes
</I>&gt;<i> &gt; &gt;&gt; problem to reactor main loop. Please point me to where the idea might
</I>&gt;<i> &gt; &gt;&gt; come
</I>&gt;<i> &gt; &gt;&gt; from.
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; I can give you the example but not sure if it is enough, as the client
</I>&gt;<i> &gt; &gt;&gt; needs to connect to a server.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; It looks like PolicyClient does a blocking HTTP request in __init__.
</I>&gt;<i> &gt; &gt; Since PolicyClient is instantiated in the reactor thread, this will
</I>&gt;<i> block
</I>&gt;<i> &gt; &gt; the reactor.  Perhaps this call is hanging for some reason when the
</I>&gt;<i> &gt; &gt; process
</I>&gt;<i> &gt; &gt; has daemonized?  This would be unusual but not unheard of.  For
</I>&gt;<i> example,
</I>&gt;<i> &gt; &gt; there are macOS environments where a process does not have access to
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; network if it is not associated with a windowing session.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; What platform do you observe the problem on, and what more can you
</I>&gt;<i> learn
</I>&gt;<i> &gt; &gt; about what the process does on its way to hanging (eg can you run
</I>&gt;<i> strace
</I>&gt;<i> &gt; &gt; on
</I>&gt;<i> &gt; &gt; it)?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Jean-Paul
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;&gt; Thank you,
</I>&gt;<i> &gt; &gt;&gt; TS
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; On Thu, May 21, 2020 at 5:23 PM Jean-Paul Calderone &lt;
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt;&gt;&gt; On Thu, May 21, 2020 at 10:58 AM Sereysethy TOUCH &lt;
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">touch.sereysethy at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; Hello,
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; I am developing a twisted app, and it runs as a service using
</I>&gt;<i> twistd -y
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; to start the app.
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; I am having a problem of running a thread. I know it is not
</I>&gt;<i> recommended
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; to use thread, but the library that I use, the object created is
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; running in
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; a thread.
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; Here is the problem:
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; 1) if I start reactor by running reactor.run() directly, thread is
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; running fine
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; 2) if I run it as a service using twisted, the thread is not
</I>&gt;<i> running,
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; it runs but it seems to be blocked, because I tried to write
</I>&gt;<i> something
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; to
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; file using time.sleep(), but file is empty.
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; Is there something that I miss? How can I debug this?
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; A good next step would be to create at Short, Self Contained, Correct
</I>&gt;<i> &gt; &gt;&gt;&gt; (Compilable), Example &lt;<A HREF="http://sscce.org/">http://sscce.org/</A>&gt; and share it.
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; Jean-Paul
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; Thank you,
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; TS
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt; &gt;&gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt; &gt;&gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;&gt; _______________________________________________
</I>&gt;<i> &gt; &gt;&gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt; &gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt; &gt;&gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; _______________________________________________
</I>&gt;<i> &gt; &gt;&gt; Twisted-Python mailing list
</I>&gt;<i> &gt; &gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt; &gt;&gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; Twisted-Python mailing list
</I>&gt;<i> &gt; &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt; &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20200522/93cbb55a/attachment.htm&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065109.html">[Twisted-Python] Twisted and Thread, thread not running when twisted app is running as service
</A></li>
	<LI>Next message (by thread): <A HREF="065099.html">[Twisted-Python] unified filesystem API
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65110">[ date ]</a>
              <a href="thread.html#65110">[ thread ]</a>
              <a href="subject.html#65110">[ subject ]</a>
              <a href="author.html#65110">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
