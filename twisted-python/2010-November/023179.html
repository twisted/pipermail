<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] [Twisted]	#4747:	tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors	is broken in	many ways
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20%5BTwisted%5D%0A%09%234747%3A%09tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors%0A%09is%20broken%20in%09many%20ways&In-Reply-To=AANLkTikR2AjbyiDsG968mKWzWdrnRHYARDNiL8kscApi%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023178.html">
   <LINK REL="Next"  HREF="023180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] [Twisted]	#4747:	tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors	is broken in	many ways</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20%5BTwisted%5D%0A%09%234747%3A%09tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors%0A%09is%20broken%20in%09many%20ways&In-Reply-To=AANLkTikR2AjbyiDsG968mKWzWdrnRHYARDNiL8kscApi%40mail.gmail.com"
       TITLE="[Twisted-Python] [Twisted]	#4747:	tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors	is broken in	many ways">exarkun at twistedmatrix.com
       </A><BR>
    <I>Wed Nov 24 10:17:56 EST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="023178.html">[Twisted-Python] [Twisted] #4747: tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors is broken in many ways
</A></li>
        <LI>Next message: <A HREF="023180.html">[Twisted-Python] [Twisted] #4747: tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors is broken in many ways
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23179">[ date ]</a>
              <a href="thread.html#23179">[ thread ]</a>
              <a href="subject.html#23179">[ subject ]</a>
              <a href="author.html#23179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02:56 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">eric.faurot at gmail.com</A> wrote:
&gt;<i>On Wed, Nov 24, 2010 at 3:28 PM, Twisted &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">trac at twistedmatrix.com</A>&gt; 
</I>&gt;<i>wrote:
</I>&gt;&gt;<i>#4747: tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors is 
</I>&gt;&gt;<i>broken in many
</I>&gt;&gt;<i>ways
</I>&gt;&gt;<i>----------------------------+-----------------------------------------------
</I>&gt;&gt;<i>&#160; &#160; Reporter: &#160;soyt &#160; &#160; &#160; &#160;| &#160; &#160; &#160; &#160; &#160; Owner: &#160;soyt
</I>&gt;&gt;<i>&#160; &#160; &#160; &#160; Type: &#160;regression &#160;| &#160; &#160; &#160; &#160; &#160;Status: &#160;new
</I>&gt;&gt;<i>&#160; &#160; Priority: &#160;normal &#160; &#160; &#160;| &#160; &#160; &#160; Milestone: &#160;Twisted 10.2
</I>&gt;&gt;<i>&#160; &#160;Component: &#160;core &#160; &#160; &#160; &#160;| &#160; &#160; &#160; &#160;Keywords:
</I>&gt;&gt;<i>&#160; &#160; &#160; Branch: &#160; &#160; &#160; &#160; &#160; &#160; &#160;| &#160; Branch_author:
</I>&gt;&gt;<i>Launchpad_bug: &#160; &#160; &#160; &#160; &#160; &#160; &#160;|
</I>&gt;&gt;<i>----------------------------+-----------------------------------------------
</I>&gt;&gt;<i>Changes (by exarkun):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>&#160;* owner: &#160;glyph =&gt; soyt
</I>&gt;&gt;<i>&#160;* keywords: &#160;review =&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Comment:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>&#160;Thanks very much for the patch. &#160;We don't have any OpenBSD machines 
</I>&gt;&gt;<i>for
</I>&gt;&gt;<i>&#160;testing, or I suppose we would have noticed this sooner. :)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>&#160;To answer the question of what functionality it provides that's worth
</I>&gt;&gt;<i>&#160;testing... &#160;`_listOpenFDs` is used by the `reactor.spawnProcess` 
</I>&gt;&gt;<i>support
</I>&gt;&gt;<i>&#160;to find out which file descriptors need to be closed so that they 
</I>&gt;&gt;<i>aren't
</I>&gt;&gt;<i>&#160;inherited by the child process. &#160;So, it must work right otherwise the
</I>&gt;&gt;<i>&#160;child may inherit file descriptors you did not want it to inherit. 
</I>&gt;&gt;<i>This
</I>&gt;&gt;<i>&#160;is an optimization over trying to close (roughly) every integer in 
</I>&gt;&gt;<i>the
</I>&gt;&gt;<i>&#160;range (3, RLIMIT_NFILES), where RLIMIT_NFILES is often around 1024.
</I>&gt;<i>
</I>&gt;<i>So in my opinion, the function should really return the list of 
</I>&gt;<i>actually
</I>&gt;<i>opened files in all cases, and not fallback to a list of possible
</I>&gt;<i>list, otherwise
</I>&gt;<i>the test case makes no sense.
</I>
Maybe so.  Fortunately the problem really seems only to be with the 
_test_, right?  On OpenBSD the fallback case will really be used, and 
the file descriptors we want to close will be closed?
&gt;<i>Of course this means trying all fds as last resort
</I>&gt;<i>on platforms that don't provide a simpler way to do it.  Doing it there 
</I>&gt;<i>or
</I>&gt;<i>doing it by ignoring EBADF on close() later would be the same, as far 
</I>&gt;<i>as
</I>&gt;<i>&quot;suboptimization&quot; is concerned.
</I>
Right, and this is just what should happen on OpenBSD now.
&gt;<i>
</I>&gt;<i>Another (nicer?) possibility to achieve the &quot;close non standard fds&quot; 
</I>&gt;<i>would be
</I>&gt;<i>to use closefrom().
</I>&gt;&gt;<i>&#160;I don't think the patch is quite correct, since ''at most'' the one 
</I>&gt;&gt;<i>extra
</I>&gt;&gt;<i>&#160;`os.listdir` file descriptor should be in the result set. &#160;Anything 
</I>&gt;&gt;<i>more
</I>&gt;&gt;<i>&#160;than that indicates the desired functionality isn't being provided. 
</I>&gt;&gt;<i>The
</I>&gt;&gt;<i>&#160;more correct test assertion would be that the output is ''either''
</I>&gt;&gt;<i>&#160;range(3) or range(4). &#160;However, I'm not sure what you mean by the 
</I>&gt;&gt;<i>&quot;uses a
</I>&gt;&gt;<i>&#160;pair of interconnected pipes&quot; comment. &#160;Uses it for what? &#160;To 
</I>&gt;&gt;<i>implement
</I>&gt;&gt;<i>&#160;`os.listdir`?
</I>&gt;<i>
</I>&gt;<i>No, it's much worse :)
</I>&gt;<i>While trying to fix the issue, I was surpised to notice that python had 
</I>&gt;<i>5 opened
</I>&gt;<i>fds by default here... After digging a bit further, I found out it is
</I>&gt;<i>actually due to
</I>&gt;<i>python being linked with libpthread, which installs a pair of pipe at 
</I>&gt;<i>init...
</I>
Hopefully these are already marked as CLOEXEC, or lots of people would 
already be having lots of problems with them.  Despite that, they should 
be closed by `reactor.spawnProcess` (because that doesn't hurt and it's 
simpler than checking for CLOEXEC).  Then the only problem is that they 
are recreated in the child process and mess up the test's assumptions.

Perhaps another approach to testing this function would be to create a 
file descriptor and assert that:

  - That file descriptor is not open in the child process
  - stdin, stdout, and sterr are open in the child process

Only, without some care, one of the pthread pipe fds might end up 
looking like the probe descriptor, so maybe that can't really work.
&gt;&gt;<i>&#160;It would be nice if we didn't have to scan and close all of
</I>&gt;&gt;<i>&#160;range(RLIMIT_NFILES) on OpenBSD though. &#160;Do you know if there is any 
</I>&gt;&gt;<i>way
</I>&gt;&gt;<i>&#160;to get this information on that platform?
</I>&gt;<i>
</I>&gt;<i>For the general case no, but for the intended purpose I'd say use 
</I>&gt;<i>closefrom()
</I>
closefrom() doesn't appear to help.  Descriptors intended to be kept 
open may be mixed together with descriptors which must be closed.  This 
is because of the `childFDs` parameter to `reactor.spawnProcess`, which 
allows arbitrary file descriptors to be passed to the child.

Jean-Paul

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023178.html">[Twisted-Python] [Twisted] #4747: tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors is broken in many ways
</A></li>
	<LI>Next message: <A HREF="023180.html">[Twisted-Python] [Twisted] #4747: tw.inet.test.ProcessTestsBuilder.test_openFileDescriptors is broken in many ways
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23179">[ date ]</a>
              <a href="thread.html#23179">[ thread ]</a>
              <a href="subject.html#23179">[ subject ]</a>
              <a href="author.html#23179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
