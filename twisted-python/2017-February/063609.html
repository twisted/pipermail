<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] SMTP: Authenticating on Outbound emails only
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SMTP%3A%20Authenticating%20on%20Outbound%20emails%20only&In-Reply-To=%3CCAEeXt4MyuNdfMO4_YJHeuZe2NeXmcYNZiA_kE6Hcbh27SY95RA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031147.html">
   <LINK REL="Next"  HREF="063620.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] SMTP: Authenticating on Outbound emails only</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SMTP%3A%20Authenticating%20on%20Outbound%20emails%20only&In-Reply-To=%3CCAEeXt4MyuNdfMO4_YJHeuZe2NeXmcYNZiA_kE6Hcbh27SY95RA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] SMTP: Authenticating on Outbound emails only">exarkun at twistedmatrix.com
       </A><BR>
    <I>Thu Feb  9 11:36:10 MST 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031147.html">[Twisted-Python] SMTP: Authenticating on Outbound emails only
</A></li>
        <LI>Next message (by thread): <A HREF="063620.html">[Twisted-Python] SMTP: Authenticating on Outbound emails only
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63609">[ date ]</a>
              <a href="thread.html#63609">[ thread ]</a>
              <a href="subject.html#63609">[ subject ]</a>
              <a href="author.html#63609">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Feb 9, 2017 at 12:29 PM, Anthony Lukach &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">anthonylukach at gmail.com</A>&gt;
wrote:

&gt;<i> I am working on putting together an SMTP server implemented within
</I>&gt;<i> Twisted.  This will act as a conduit to my API, where there are two basic
</I>&gt;<i> flows:
</I>&gt;<i>
</I>&gt;<i> 1) A device that supports sending email can &quot;send&quot; an email through the
</I>&gt;<i> SMTP server. This is, in effect, the SMTP server handling the message as an
</I>&gt;<i> outbound request.  The device would authenticate with the server and then
</I>&gt;<i> provide it the message to be sent (which in reality will be uploaded to my
</I>&gt;<i> API).
</I>&gt;<i>
</I>&gt;<i> 2) A device can send an email to my SMTP server via their own SMTP server.
</I>&gt;<i> My server would receive the incoming message, parse its contents, and then
</I>&gt;<i> upload the data to my API. Naturally, these incoming messages would not be
</I>&gt;<i> required to authenticate with the server.
</I>&gt;<i>
</I>&gt;<i> I'm having trouble constructing the server in a way that outbound messages
</I>&gt;<i> require authentication but incoming messages do not.
</I>&gt;<i>
</I>
twisted.mail and cred support anonymous access.  I think that what you want
is to implement an avatar that can only accept messages for local delivery
and use that for anonymous users.  If an anonymous user tries to send mail
to a non-local user, they get back an error.  Either they made a mistake
and they should try again after authenticating or they're trying to abuse
the service and that's what you want.  That's case (2).  Then implement the
relay logic in another avatar and use that for authenticated users.  That's
case (1).

This relies on the fact that the realm you supply is responsible for
creating avatars and the realm gets told the avatarId for which it should
create an avatar - and the anonymous user can be differentiated from other
users by the avatarId.

Does that help?


&gt;<i> Can anyone direct me to an example of an SMTP server that is both
</I>&gt;<i> accepting inbound and outbound emails and authenticates only on outbound
</I>&gt;<i> emails?
</I>&gt;<i>
</I>&gt;<i>
</I>As it happens, yes...

This avatar supports local-only delivery:
<A HREF="https://github.com/twisted/quotient/blob/master/xquotient/mail.py#L51">https://github.com/twisted/quotient/blob/master/xquotient/mail.py#L51</A>
This one supports relaying:
<A HREF="https://github.com/twisted/quotient/blob/master/xquotient/mail.py#L528">https://github.com/twisted/quotient/blob/master/xquotient/mail.py#L528</A>
Here's the factory and portal setup code:
<A HREF="https://github.com/twisted/quotient/blob/master/xquotient/mail.py#L302">https://github.com/twisted/quotient/blob/master/xquotient/mail.py#L302</A>

The realm is a bit spread out and involves some Axiom-specific concepts
that you probably don't need to know... But let me know if the above three
links don't make things clear.

 Jean-Paul
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20170209/1449c70c/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031147.html">[Twisted-Python] SMTP: Authenticating on Outbound emails only
</A></li>
	<LI>Next message (by thread): <A HREF="063620.html">[Twisted-Python] SMTP: Authenticating on Outbound emails only
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63609">[ date ]</a>
              <a href="thread.html#63609">[ thread ]</a>
              <a href="subject.html#63609">[ subject ]</a>
              <a href="author.html#63609">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
