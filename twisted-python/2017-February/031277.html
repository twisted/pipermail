<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to restart Twisted service in-process
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20restart%20Twisted%20service%20in-process&In-Reply-To=%3C341541A6-C553-4CBA-85C5-016BEB4CBA8C%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031276.html">
   <LINK REL="Next"  HREF="031141.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to restart Twisted service in-process</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20restart%20Twisted%20service%20in-process&In-Reply-To=%3C341541A6-C553-4CBA-85C5-016BEB4CBA8C%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] How to restart Twisted service in-process">glyph at twistedmatrix.com
       </A><BR>
    <I>Tue Feb 28 19:52:16 MST 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="031276.html">[Twisted-Python] How to restart Twisted service in-process
</A></li>
        <LI>Next message: <A HREF="031141.html">[Twisted-Python] conch.ssh.SSHFactory publicKeys and getPublicKeys
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31277">[ date ]</a>
              <a href="thread.html#31277">[ thread ]</a>
              <a href="subject.html#31277">[ subject ]</a>
              <a href="author.html#31277">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Feb 28, 2017, at 8:11 AM, &#1056;&#1086;&#1084;&#1072;&#1085; &#1052;&#1077;&#1097;&#1077;&#1088;&#1103;&#1082;&#1086;&#1074; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">romanmescheryakov at yandex.ru</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hello everyone,
</I>&gt;<i> today I tried restarting twisted service using sys.execv, and it fails with the following message:
</I>&gt;<i>  
</I>&gt;<i> &gt; 2017-02-28T18:39:47+0300 [ready_to_setup#debug] Before os.execv: sys.executable is /usr/bin/python and sys.argv are ['/usr/local/bin/twistd', '-ny', 'master_player.tac']
</I>&gt;<i> &gt; Another twistd server is running, PID 1939
</I>&gt;<i>  
</I>&gt;<i> &gt; This could either be a previously started instance of your application or a
</I>&gt;<i> &gt; different application entirely. To start a new one, either run it in some other
</I>&gt;<i> &gt; directory, or use the --pidfile and --logfile parameters to avoid clashes.
</I>&gt;<i>  
</I>&gt;<i> My service is started in the following way:
</I>&gt;<i>  
</I>&gt;<i> PYTHONPATH=. twistd -ny master_player.tac
</I>&gt;<i>  
</I>&gt;<i> (i.e. without daemonization)
</I>&gt;<i> Code to restart is:
</I>&gt;<i>  
</I>&gt;<i> &gt; d = task.deferLater(self._reactor, seconds,
</I>&gt;<i> &gt;                     shared_code.restart_script, self._log, self._reactor)
</I>&gt;<i> &gt; # _restart_script_done should never be called
</I>&gt;<i> &gt; d.addCallback(self._restart_script_done).addErrback(self._restart_script_failure)
</I>&gt;<i>  
</I>&gt;<i> where shared_code.restart_script is:
</I>&gt;<i>  
</I>&gt;<i> &gt; def restart_script(logger, reactor):
</I>&gt;<i> &gt;     logger.info(&quot;Restarting script...&quot;)
</I>&gt;<i> &gt;     reactor.stop()
</I>&gt;<i> &gt;     sys.stdout.flush()
</I>&gt;<i> &gt;     #TODO: force logging system to flush all log files
</I>&gt;<i> &gt;     logger.debug(&quot;Before os.execv: sys.executable is {sysexec} and sys.argv are {argv}&quot;,
</I>&gt;<i> &gt;                 sysexec = sys.executable, argv = sys.argv)
</I>&gt;<i> &gt;     os.execv(sys.executable, [sys.executable] + sys.argv)
</I>&gt;<i>  
</I>&gt;<i> Could someone explain to me why does the &quot;Another twistd server is running&quot; error occur and how can I avoid it?
</I>
twistd writes a .pid file and then attempts to check whether another process on the system has the same PID contained in that file while starting up, to avoid conflicts.

Yours is an odd case, because the process with that process-ID is the _current_ process, and perhaps the check ought to even be modified to account for this.

Two other options you have are:

switch to `twist`, which doesn't write a pidfile
use the option &quot;--pidfile ''&quot; to disable writing a pidfile.

I strongly suggest the first option :).

-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20170228/4daee793/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20170228/4daee793/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031276.html">[Twisted-Python] How to restart Twisted service in-process
</A></li>
	<LI>Next message: <A HREF="031141.html">[Twisted-Python] conch.ssh.SSHFactory publicKeys and getPublicKeys
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31277">[ date ]</a>
              <a href="thread.html#31277">[ thread ]</a>
              <a href="subject.html#31277">[ subject ]</a>
              <a href="author.html#31277">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
