<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Sending a long string/buffer without copying it
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Sending%20a%20long%20string/buffer%20without%20copying%20it&In-Reply-To=6ce0ac130609281548r30c89fb7t3fcd10bb44604357%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014125.html">
   <LINK REL="Next"  HREF="014127.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Sending a long string/buffer without copying it</H1>
    <B>Jacob Gabrielson</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Sending%20a%20long%20string/buffer%20without%20copying%20it&In-Reply-To=6ce0ac130609281548r30c89fb7t3fcd10bb44604357%40mail.gmail.com"
       TITLE="[Twisted-Python] Sending a long string/buffer without copying it">jacob at cozi.com
       </A><BR>
    <I>Thu Sep 28 19:18:42 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="014125.html">[Twisted-Python] Sending a long string/buffer without copying it
</A></li>
        <LI>Next message: <A HREF="014127.html">[Twisted-Python] Sending a long string/buffer without copying it
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14126">[ date ]</a>
              <a href="thread.html#14126">[ thread ]</a>
              <a href="subject.html#14126">[ subject ]</a>
              <a href="author.html#14126">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm probably missing something, but your outgoing bytes have to be
copied at least once, anyway, into the kernel's address space (unless
you're using some kind of trick like sendfile()).  Clearly creating a
duplicate of the entire multi-MB string would be bad.  But as long as
the Producer kept returning the same, say, 4KB buffer (I'm assuming
that's possible?), you're only talking about one extra copy per write.
That *might* still be significant, but without measuring it it would be
very hard to say.

Just my $.02,

-- Jacob 

-----Original Message-----
From: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>
[mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] On Behalf Of Brian
Granger
Sent: Thursday, September 28, 2006 3:48 PM
To: Twisted general discussion
Subject: Re: [Twisted-Python] Sending a long string/buffer without
copying it

But a producer will just make sure the whole thing isn't copied at the
same time right?  It still does many smaller copies - while the memory
is saved there is still the performance hit.

I just wanted to make sure that I wan't missing something obvious.  I
think the right way of doing this is to use a true rw buffer, such as
those created by numpy.

On 9/28/06, Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt; wrote:
&gt;<i> On Thu, 28 Sep 2006 00:11:41 -0600, Brian Granger
</I>&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ellisonbg.net at gmail.com</A>&gt; wrote:
&gt;<i> &gt;HI,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;In one of my Twisted based applications, I need to send large string 
</I>&gt;<i> &gt;and buffers.  They can be 100's of MB's long (they come from large 
</I>&gt;<i> &gt;numpy arrays).  I would like to be able to send them *without making 
</I>&gt;<i> &gt;any copies* in the process.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;This seems to be dificult with the way that certain parts of Twisted 
</I>&gt;<i> &gt;are written:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;in protocols.basic many of the sendString/sendLine method having 
</I>&gt;<i> &gt;things that make a copy of the string or line to be send:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    def sendLine(self, line):
</I>&gt;<i> &gt;        &quot;&quot;&quot;Sends a line to the other end of the connection.
</I>&gt;<i> &gt;        &quot;&quot;&quot;
</I>&gt;<i> &gt;        return self.transport.write(line + self.delimiter)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;If line is 100MB, this just made a second 100MB string.  To make 
</I>&gt;<i> &gt;things worse, in my case a server needs to send this line to many 
</I>&gt;<i> &gt;clients that are connected.  The line gets copied for each client!  
</I>&gt;<i> &gt;If I have 10 clients, I have nearly a GB worth of extra memory 
</I>&gt;<i> &gt;allocated for this temporary copy.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;This problem is easy solve at the protocol level: you just do 
</I>&gt;<i> &gt;separate writes for the delimiter and the line.  Or if you are using 
</I>&gt;<i> &gt;a length prefixed protocol, write the length bytes and the string
</I>separately.
&gt;<i> &gt;
</I>&gt;<i> &gt;BUT....
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Even if I do that, it appears that Twisted is making copies elsewhere
</I>&gt;<i> &gt;- like in FileDescriptor.doWrite.  So, how can I send something 
</I>&gt;<i> &gt;without making a copy?  I don't mind making copies of slices, just 
</I>&gt;<i> &gt;not the whole thing.
</I>&gt;<i>
</I>&gt;<i> Don't pass the entire thing to a single call to transport.write() (or 
</I>&gt;<i> LineReceiver.sendLine).  Instead, write a producer.
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>
_______________________________________________
Twisted-Python mailing list
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014125.html">[Twisted-Python] Sending a long string/buffer without copying it
</A></li>
	<LI>Next message: <A HREF="014127.html">[Twisted-Python] Sending a long string/buffer without copying it
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14126">[ date ]</a>
              <a href="thread.html#14126">[ thread ]</a>
              <a href="subject.html#14126">[ subject ]</a>
              <a href="author.html#14126">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
