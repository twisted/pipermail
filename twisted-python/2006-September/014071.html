<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Removing _wait from Trial
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Removing%20_wait%20from%20Trial&In-Reply-To=d06a5cd30609240026y3b50e953s472e4dd4eb70fb06%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="014049.html">
   <LINK REL="Next"  HREF="014077.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Removing _wait from Trial</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Removing%20_wait%20from%20Trial&In-Reply-To=d06a5cd30609240026y3b50e953s472e4dd4eb70fb06%40mail.gmail.com"
       TITLE="[Twisted-Python] Removing _wait from Trial">glyph at divmod.com
       </A><BR>
    <I>Mon Sep 25 02:48:15 EDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="014049.html">[Twisted-Python] Removing _wait from Trial
</A></li>
        <LI>Next message: <A HREF="014077.html">[Twisted-Python] Twisted &amp; Qt
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14071">[ date ]</a>
              <a href="thread.html#14071">[ thread ]</a>
              <a href="subject.html#14071">[ subject ]</a>
              <a href="author.html#14071">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 24 Sep 2006 17:26:10 +1000, Jonathan Lange &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jml at mumak.net</A>&gt; wrote:
&gt;<i>So, I would like to remove _wait() from Trial and make it work like a
</I>&gt;<i>regular Twisted application. I've had all this stuff on my brain, and
</I>&gt;<i>have decided to dump it here for feedback. Here's how the plan looks
</I>&gt;<i>at the moment[1]:
</I>
&gt;<i>1. Deprecate the use of reactor-spinning things within tests. (Twisted 2.5)
</I>
YES.

&gt;<i>Unfortunately, some of Trial's cleanup code spins the reactor (see
</I>&gt;<i>t.trial.util._Janitor.do_cleanPending). This has to go.
</I>
You are saying this part of the plan will happen post-2.5, I assume?

&gt;<i>2. Tighten test cleanup errors. (Twisted 2.5)
</I>&gt;<i>
</I>&gt;<i>#2091 (ready for review) fulfils a long-standing promise. The &quot;reactor
</I>&gt;<i>unclean&quot; warnings have been turned into errors.
</I>
I would really like it to be possible to turn these errors into warnings by passing a command-line flag, mainly for the migration path between 2.4 and 2.5.  If you upgrade an application to Twisted 2.5 and then run your tests, and you get 100 failures, it would be nice to be able to run &quot;trial --unclean=warn_only&quot;, and focus on fixing any issues with the upgrade of APIs rather than just the test tool.  Even nicer to see that your tests still pass and you just need to update the tests to clean up after themselves.

Twisted's buildslaves should _NOT_ use this flag, nor should it still be present in 2.6.  I am suggesting it _ONLY_ as a migration tool.

&gt;<i>To remove _wait, we'll also have to remove the two calls to
</I>&gt;<i>reactor.iterate() from _Janitor (see #2092). That means that many
</I>&gt;<i>tests that *thought* they were cleaning up the reactor properly will
</I>&gt;<i>find out that they weren't. We can reduce the number of errors by
</I>&gt;<i>simulating reactor.iterate() using callLater. However, experiments
</I>&gt;<i>show that even with this bandaid, there will still be new errors in
</I>&gt;<i>the Twisted suite.
</I>
It sounds like a good process for getting changes like this through the Twisted suite might be:

 * prepare the branch
 * get it reviewed, but don't fix the tests yet
 * have a &quot;fix trial party&quot; where we encourage lots of other hackers to get together on IRC and contribute to the same branch
 * get it reviewed by someone who couldn't participant (bonus: incentive to participate is that you don't have to review a massive branch...)

&gt;<i>That means we will have to either:
</I>&gt;<i>a) surprise our users with new errors in their tests
</I>&gt;<i>b) find some way to introduce this gradually.
</I>
I think this might be another use-case for a flag.  Really, developers should be alerted to these changes as soon as possible (warnings are too easily ignored), but have a way to give themselves a little leeway to fix the problems before the next release.

&gt;<i>Obviously everyone[2] would prefer b). I've filed #2124 explaining how
</I>&gt;<i>that might work.
</I>
&gt;<i>3. Introduce asynchronous APIs to Trial (Twisted 2.6)
</I>&gt;<i>
</I>&gt;<i>Currently TestCase.run() is a blocking call. I wish it could remain a
</I>&gt;<i>blocking call, but it can't.
</I>
Why do you say you wish it could?  Isn't the whole point here to make it not be a blocking call?

&gt;<i>The branch for #1781 makes a SyncTestCase and an AsyncTestCase. run()
</I>&gt;<i>works in SyncTestCase and doesn't work in AsyncTestCase. For
</I>&gt;<i>AsyncTestCase, one uses runDeferred().
</I>
This all sounds fine.

&gt;<i>Although the branch for #1781 will need to be abandoned, these new
</I>&gt;<i>classes should be brought in for Twisted 2.6 (without breaking run()).
</I>&gt;<i>Naturally, this affects many, many tests in Trial.
</I>
Another potential place where a 'fix trial party' might be useful.

&gt;<i>4. Deprecate TestSuite.run and TestCase.run. (Twisted 2.6)
</I>&gt;<i>
</I>&gt;<i>Neither of these will work without wait[3] and they are both public
</I>&gt;<i>APIs. Also remove the calls to iterate() from _Janitor at this point.
</I>
In what sense are these APIs &quot;public&quot;?  Are there really people calling them outside of the 'trial' tool?

&gt;<i>5. Actually remove _wait. (Twisted 2.7)
</I>
&gt;<i>Add runDeferred() to TestSuite, make run() raise NotImplementedErrors
</I>&gt;<i>for TestCase and TestSuite. Alter TrialSuite to start and stop the
</I>&gt;<i>reactor.
</I>
Is there something significant about raising NotImplementedError?  Why aren't you just going to remove the method?

&gt;<i>I can't find a theory to explain why this change will break unexpected
</I>&gt;<i>tests in the Twisted suite. However, it will certainly happen. That
</I>&gt;<i>means that some tests in user code will probably break as well. I
</I>&gt;<i>don't know how we could make this any smoother.
</I>
Until we have a theory about how and why things are going to break, we shouldn't worry about making it smoother.  That's not to say that things aren't going to break, but the plan for smoothing things out is likely to depend upon the details of the breakage.

&gt;<i>Questions:
</I>&gt;<i>- What should I do with the ticket #1781?
</I>
It looks like it should have a milestone of Twisted-2.7, and stay as it is.

&gt;<i>- What should I do with the branch for #1781?
</I>
I'd have to review a bunch of other code to be sure, and I haven't, but I'd say &quot;keep merging it forward&quot;.  Maybe just dropping it and rewriting it later makes more sense, though.

&gt;<i>- What more can we do to reduce the number of tests that will break
</I>&gt;<i>when _wait is removed?
</I>
See above.

&gt;<i>[1] Incidentally, all of this would be superfluous if reactors were 
</I>&gt;<i>restartable.
</I>
A clean restart() API would be a possible way of fixing some things, but I think you are underestimating how much code would break with a clean restart() method, too.  For example: the threadpool would be stopped after each test.  Would that make any existing Twisted tests fail?  I don't know, but operating under your (probably correct) pessimistic assumption that any change to the test framework's interaction with the reactor will break some things, I'd have to say yes.

Then there is the issue that Bob recently brought up, which is that in a 'normal' Twisted application the reactor is only started once, and so it's not really a representative test to constantly be pausing and resuming it.  If we implement a restartable reactor it would probably be a good torture-test though.

Thanks for all the work on this issue.  Every time I look at it, I'm shocked by just how difficult this transition has been, and all the more thankful for your capable stewardship of it.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="014049.html">[Twisted-Python] Removing _wait from Trial
</A></li>
	<LI>Next message: <A HREF="014077.html">[Twisted-Python] Twisted &amp; Qt
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#14071">[ date ]</a>
              <a href="thread.html#14071">[ thread ]</a>
              <a href="subject.html#14071">[ subject ]</a>
              <a href="author.html#14071">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
