<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Uploading multiple files using ftpclient in Twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Uploading%20multiple%20files%20using%20ftpclient%20in%20Twisted&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022525.html">
   <LINK REL="Next"  HREF="022533.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Uploading multiple files using ftpclient in Twisted</H1>
    <B>Jaepyoung Kim</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Uploading%20multiple%20files%20using%20ftpclient%20in%20Twisted&In-Reply-To="
       TITLE="[Twisted-Python] Uploading multiple files using ftpclient in Twisted">jaepyoung.kim at gmail.com
       </A><BR>
    <I>Sat Jul 10 01:40:11 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022525.html">[Twisted-Python] Congrats to ITA
</A></li>
        <LI>Next message: <A HREF="022533.html">[Twisted-Python] Uploading multiple files using ftpclient in	Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22528">[ date ]</a>
              <a href="thread.html#22528">[ thread ]</a>
              <a href="subject.html#22528">[ subject ]</a>
              <a href="author.html#22528">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear twisted-python expert,

I am build engineer and I need to upload binary to ftp server.
Binary files are about 30 and each file size is about 30M.

The current script is uploading using ftplib and it takes time about 1 hour.
I want to change this script to use twisted asynchronous function.
I thought if I use asynchronous function in twisted like following,
then file uploading will be executed in parallel.
But this was executed sequentially. Uploading second file starts afer
completing first file upload.
Could you check what was wrong in my source code? Or Am I wrong in
understanding asynchronous function?


        for file in fileList:
    	ftpClient.cwd(&quot;/tmp&quot;).addCallbacks(uploadFiles, fail,
callbackArgs=(file,ftpClient))

Thanks,
Jaepyoung



Full source code:

def filesucess(ab):
    print ab

def uploadFiles(result, file,ftpClient):
    d1,d2=ftpClient.storeFile('/tmp/'+file)
    d1.addCallback(cbStore, file).addErrback(fileTransferFail)
    d1.addCallback(filesucess)
    return d2



def fileTransferFail(failure):
    failure.printTraceback()
    reactor.stop()


def showBuffer(result, bufferProtocol):
    print 'Got data:'
    print bufferProtocol.buffer.getvalue()


class Options(usage.Options):
    optParameters = [['host', 'h', 'localhost'],
                     ['port', 'p', 21],
                     ['username', 'u', 'user'],
                     ['password', None, 'password'],
                     ['passive', None, 0],
                     ['debug', 'd', 1],
                    ]
def cbStore(consumer, filename):
    fs = FileSender()
    print filename+&quot; cbstror&quot;
    d = fs.beginFileTransfer(open(filename, 'r'), consumer)
    d.addCallback(lambda _: consumer.finish()).addErrback(fileTransferFail)
    return d

def run():
    # Get config
    config = Options()
    config.parseOptions()
    config.opts['port'] = int(config.opts['port'])
    config.opts['passive'] = int(config.opts['passive'])
    config.opts['debug'] = int(config.opts['debug'])

    # Create the client
    FTPClient.debug = config.opts['debug']
    creator = ClientCreator(reactor, FTPClient, config.opts['username'],
                            config.opts['password'],
passive=config.opts['passive'])
    print config.opts['password']
    creator.connectTCP(config.opts['host'],
config.opts['port'],timeout=10).addCallback(connectionMade).addErrback(connectionFailed)
    reactor.run()


def connectionFailed(f):
    print &quot;Connection Failed:&quot;, f
    reactor.stop()

def connectionMade(ftpClient):
    # Get the current working directory
    ftpClient.pwd().addCallbacks(success, fail)
    fileList = os.listdir('./temp')
    for file in fileList:
    	ftpClient.cwd(&quot;/tmp&quot;).addCallbacks(uploadFiles, fail,
callbackArgs=(file,ftpClient))
    print &quot;connectionmade&quot;

</PRE>












<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022525.html">[Twisted-Python] Congrats to ITA
</A></li>
	<LI>Next message: <A HREF="022533.html">[Twisted-Python] Uploading multiple files using ftpclient in	Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22528">[ date ]</a>
              <a href="thread.html#22528">[ thread ]</a>
              <a href="subject.html#22528">[ subject ]</a>
              <a href="author.html#22528">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
