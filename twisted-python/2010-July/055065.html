<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted HTTP client supporting failover for multiple A records?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20HTTP%20client%20supporting%20failover%20for%0A%20multiple%20A%20records%3F&In-Reply-To=%3C1279197221.8628.119.camel%40pow%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="055064.html">
   <LINK REL="Next"  HREF="055066.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted HTTP client supporting failover for multiple A records?</H1>
    <B>Luke Marsden</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%20HTTP%20client%20supporting%20failover%20for%0A%20multiple%20A%20records%3F&In-Reply-To=%3C1279197221.8628.119.camel%40pow%3E"
       TITLE="[Twisted-Python] Twisted HTTP client supporting failover for multiple A records?">luke-lists at hybrid-logic.co.uk
       </A><BR>
    <I>Thu Jul 15 06:33:41 MDT 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="055064.html">[Twisted-Python] Twisted HTTP client supporting failover for multiple A records?
</A></li>
        <LI>Next message (by thread): <A HREF="055066.html">[Twisted-Python] Twisted HTTP client supporting failover for multiple A records?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55065">[ date ]</a>
              <a href="thread.html#55065">[ thread ]</a>
              <a href="subject.html#55065">[ subject ]</a>
              <a href="author.html#55065">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 2010-07-15 at 08:06 -0400, Itamar Turner-Trauring wrote:
&gt;<i> On Thu, 2010-07-15 at 10:46 +0100, Reza Lotun wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; As for connecting to hosts that resolve to multiple A records - I
</I>&gt;<i> &gt; presume as a means of load balancing via DNS round robin
</I>
We're actually using it to provide redundancy in this instance. In our
application any request for any site can be made to any (live) server,
so having dead servers in the pool of A records doesn't matter so long
as real web browsers failover to some other A record within a second,
which they do! <A HREF="http://crypto.stanford.edu/dns/dns-rebinding.pdf">http://crypto.stanford.edu/dns/dns-rebinding.pdf</A>

The problem is that my test application uses client.getPage which,
because it uses the reactor's standard DNS lookup mechanism, picks just
one A record and sticks to it. So, it reports connection errors (some
fraction of the time, as A records are randomised) even when the user of
a &quot;real&quot; web browser would not experience them. These errors go away
when the dead server(s) drop out of the DNS pool and reactor's lookups
stops returning the dead IP, but this takes some time.


&gt;<i> Gar. I should read better. Twisted uses a threadpool of gethostname by
</I>&gt;<i> default, but you can plug in your own resolver (e.g. you can use
</I>&gt;<i> twisted.names):
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://twistedmatrix.com/documents/10.1.0/api/twisted.internet.interfaces.IReactorPluggableResolver.html#installResolver">http://twistedmatrix.com/documents/10.1.0/api/twisted.internet.interfaces.IReactorPluggableResolver.html#installResolver</A>
</I>&gt;<i> 
</I>&gt;<i> The question is whether the client code re-resolves on each re-connect,
</I>&gt;<i> and whether the current lookup interface is sufficient for this use
</I>&gt;<i> case.
</I>&gt;<i> 
</I>&gt;<i> Alas, I'm pretty sure the answer is no.
</I>&gt;<i> 
</I>&gt;<i> You could however always just do the DNS lookup yourself, passing
</I>&gt;<i> resulting correct IP to connectTCP, just make sure you don't block (e.g.
</I>&gt;<i> by using deferToThread to call gethostbyname_ex).
</I>
Thanks Itamar, this is massively useful. I'll try subclassing
twisted.web.client.Agent to do its own DNS lookups with twisted.names so
as to be aware of the full list of A records returned. It would then
attempt all the IP addresses in turn until it finds one which works,
giving up only if all the IPs yield connection errors. This should
mirror the behaviour of the majority of web browsers &quot;in the wild&quot;.

Would you be interested in having this code contributed back to Twisted
if I can get it working? It might be a useful addition to the Agent.

-- 
Best Regards,
Luke Marsden
Hybrid Logic Ltd.

Web: <A HREF="http://www.hybrid-cluster.com/">http://www.hybrid-cluster.com/</A>
Hybrid Web Cluster - cloud web hosting based on FreeBSD and ZFS

Mobile: +447791750420



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="055064.html">[Twisted-Python] Twisted HTTP client supporting failover for multiple A records?
</A></li>
	<LI>Next message (by thread): <A HREF="055066.html">[Twisted-Python] Twisted HTTP client supporting failover for multiple A records?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55065">[ date ]</a>
              <a href="thread.html#55065">[ thread ]</a>
              <a href="subject.html#55065">[ subject ]</a>
              <a href="author.html#55065">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
