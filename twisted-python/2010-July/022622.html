<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] LDAP binds appears to succeed with no password
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20LDAP%20binds%20appears%20to%20succeed%20with%20no%20password&In-Reply-To=4C52BDBE.5090704%40franzoni.eu">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022620.html">
   <LINK REL="Next"  HREF="022623.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] LDAP binds appears to succeed with no password</H1>
    <B>Peter Westlake</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20LDAP%20binds%20appears%20to%20succeed%20with%20no%20password&In-Reply-To=4C52BDBE.5090704%40franzoni.eu"
       TITLE="[Twisted-Python] LDAP binds appears to succeed with no password">peter.westlake at pobox.com
       </A><BR>
    <I>Fri Jul 30 09:31:00 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022620.html">[Twisted-Python] LDAP binds appears to succeed with no password
</A></li>
        <LI>Next message: <A HREF="022623.html">[Twisted-Python] Asynchronous gzipped content decompression: best	approach
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22622">[ date ]</a>
              <a href="thread.html#22622">[ thread ]</a>
              <a href="subject.html#22622">[ subject ]</a>
              <a href="author.html#22622">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 30 Jul 2010 13:55 +0200, &quot;Alan Franzoni&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mailing at franzoni.eu</A>&gt;
wrote:
&gt;<i> On 7/30/10 12:54 PM, Peter Westlake wrote:
</I>&gt;<i> &gt; I'm using LDAP to authenticate users, and when I give it an empty
</I>&gt;<i> &gt; password, it appears to succeed! Can anyone see what I'm doing wrong?
</I>&gt;<i> &gt; I've added comments by the log messages that appear in the output.
</I>&gt;<i> 
</I>&gt;<i> Please post the full code, including how you're using such class. Also:
</I>
The rest of it is below.

&gt;<i> - log the entry you've found and that you're using to re-bind. It might
</I>&gt;<i> not be what you're expecting.
</I>
It is, though - it's my directory entry. See the output, below.

&gt;<i> - try the very same query using something like ldapsearch or Apache LDAP
</I>&gt;<i> Studio, and see whether the result differs.
</I>
With ldapsearch, it fails as expected. That's a bit different to my
code, though, because it only does a bind and a search. It isn't
trying to re-bind using the entry it finds.

LDAP Studio is a great find, thank you! And thank you for your help.

Peter.

Here's the test program:
-----------------------------------------------------------------------
auth.py:

from lda import LDAPAuthenticator

import getpass
from twisted.internet import reactor

import log

username = raw_input('Username: ')
password = getpass.getpass('Password: ')


def _success(entry):
    log.info('Successful authentication as %r' % username)
    return username

def _failure(f):
    log.info('Failed authentication as %r' % username, f)
    raise Exception('Authentication failed')

def stop(result):
    print 'Result', result
    reactor.stop()

authenticator= LDAPAuthenticator(
    hostname=LDAP_HOST,
    base_dn=LDAP_ROOT,
    attr='sAMAccountName',
    bind_dn=LDAP_BIND_DN,
    bind_pw=LDAP_BIND_PW
    )
try:
    print 'Before authenticate'
    d = authenticator.authenticate(username, password)
    print 'Called authenticate'
except Exception, e:
    print 'Exception was:'
    print e
    reactor.stop()

d.addCallbacks(_success, _failure)
d.addBoth(stop)

reactor.run()

--------------------------------------------------------------------------------
log.py:

# Simplified log for test purposes.

def info(*message):
    print message

def debug(*message):
    print message

def rep(e, *message):
    print message
    print 'Exception is:', e
-------------------------------------------------------------------------------
The output of the program:

$ python auth.py
Username: peterw
Password:
Before authenticate
('Empty password!!!!',)
Called authenticate
('Empty password',)
('Succeeded with an empty password!',)
('user_entry:',)
(LDAPEntryWithClient(dn='CN=Peter Westlake,OU=....',
attributes={'sAMAccountName':
JournaledLDAPAttributeSet('sAMAccountName', ['peterw'])}),)
('Login:', 'peterw')
(&quot;Successful authentication as 'peterw'&quot;,)
Result peterw
---------------------------------------------------------------------------------
The file I posted last time, for completeness and ease of reference:

lda.py:

from twisted.internet import reactor, defer
from ldaptor.protocols.ldap import ldapclient, ldapsyntax,
ldapconnector, ldaperrors
from ldaptor.protocols import pureldap as L

import log

class LDAPAuthenticator(object):
    def __init__(self, base_dn, hostname=None, attr='uid', bind_dn='',
                 bind_pw='', filter=L.LDAPFilter_present('cn')):
        self.hostname = hostname
        self.base_dn = base_dn
        self.attr = attr
        self.bind_dn = bind_dn
        self.bind_pw = bind_pw
        self.filter = filter
        self.cli = None

    @defer.inlineCallbacks
    def authenticate(self, username, password):
        if not password:
            log.info('Empty password!!!!')
        else:
            log.debug('Attempting to login as', username)

        c = ldapconnector.LDAPClientCreator(reactor,
        ldapclient.LDAPClient)
        self.client = yield c.connect(self.base_dn)

        yield ldapsyntax.LDAPEntry(self.client,
        self.bind_dn).bind(self.bind_pw)

        entries = []
        base = ldapsyntax.LDAPEntry(self.client, self.base_dn)

        yield base.search(
            filterObject=L.LDAPFilter_and(
                [L.LDAPFilter_equalityMatch(
                        attributeDesc=L.LDAPAttributeDescription(self.attr),
                        assertionValue=L.LDAPAssertionValue(username)
                    ),
                 self.filter,
                 ]),
            attributes = (self.attr,),  # No need to read the whole
            entry!
            callback=entries.append
        )
        n_entries = len(entries)
        if n_entries == 0:
            self.client.unbind()
            log.debug('Failed login for %s: no search results' %
            (username,))
            raise Exception('No search results!')
        elif n_entries &gt; 1:
            self.client.unbind()
            log.debug('Failed login as %s: %d search results for unique
            entry!' % (username, n_entries))
            raise Exception('%d search results for unique entry!' %
            n_entries)
        else:
            # The password matches if we can bind as this DN with it.
            try:
                if not password:
                    log.info('Empty password')
                user_entry = yield entries[0].bind(password)
                if not password:
                    log.info('Succeeded with an empty password!')
                    log.info('user_entry:')
                    log.info(user_entry)
                log.info('Login:', username)
            except ldaperrors.LDAPInvalidCredentials:
                log.info('Failed login for %s: invalid credentials' %
                username)
                raise
            except Exception, e:
                log.rep(e, 'Error while binding with user password')
                self.client.unbind()
                raise
            self.client.unbind()
            defer.returnValue(user_entry)
--------END-----------

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022620.html">[Twisted-Python] LDAP binds appears to succeed with no password
</A></li>
	<LI>Next message: <A HREF="022623.html">[Twisted-Python] Asynchronous gzipped content decompression: best	approach
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22622">[ date ]</a>
              <a href="thread.html#22622">[ thread ]</a>
              <a href="subject.html#22622">[ subject ]</a>
              <a href="author.html#22622">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
