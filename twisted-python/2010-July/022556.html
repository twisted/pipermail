<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] What is the minimum effort solution to	make	inetd-managed twisted-based application?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20What%20is%20the%20minimum%20effort%20solution%20to%0A%09make%09inetd-managed%20twisted-based%20application%3F&In-Reply-To=20100713143708.2105.59269190.divmod.xquotient.26%40localhost.localdomain">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022555.html">
   <LINK REL="Next"  HREF="022559.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] What is the minimum effort solution to	make	inetd-managed twisted-based application?</H1>
    <B>Alexey</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20What%20is%20the%20minimum%20effort%20solution%20to%0A%09make%09inetd-managed%20twisted-based%20application%3F&In-Reply-To=20100713143708.2105.59269190.divmod.xquotient.26%40localhost.localdomain"
       TITLE="[Twisted-Python] What is the minimum effort solution to	make	inetd-managed twisted-based application?">twisted-web at udmvt.ru
       </A><BR>
    <I>Tue Jul 13 12:52:52 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022555.html">[Twisted-Python] What is the minimum effort solution to	make	inetd-managed twisted-based application?
</A></li>
        <LI>Next message: <A HREF="022559.html">[Twisted-Python] What is the minimum effort solution to	make	inetd-managed twisted-based application?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22556">[ date ]</a>
              <a href="thread.html#22556">[ thread ]</a>
              <a href="subject.html#22556">[ subject ]</a>
              <a href="author.html#22556">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Jul 13, 2010 at 02:37:08PM -0000, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:
&gt;<i> On 12:57 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-web at udmvt.ru</A> wrote:
</I>&gt;<i> &gt;What is the minimal effort method for building protocol instance (maybe 
</I>&gt;<i> &gt;out of
</I>&gt;<i> &gt;already implemented protocol factory) using a transport, that uses
</I>&gt;<i> &gt;parent-inherited sockets (or any other already connected sockets) ?
</I>&gt;<i> &gt;I haven't yet found any single-line solution for that.
</I>&gt;<i> 
</I>&gt;<i> This isn't supported, but we'd like to support it.
</I>
Oops, the Bad news.

&gt;<i>  There's a ticket in 
</I>&gt;<i> the issue tracker, &lt;<A HREF="http://twistedmatrix.com/trac/ticket/4387">http://twistedmatrix.com/trac/ticket/4387</A>&gt;, related 
</I>&gt;<i> to this (but with a somewhat wider scope).
</I>
Well, that feature will benefit from the feature I need. By the way, twisted
architecture and abstractions allow one (for a limited number of protocols)
to transfer the state along with the FD of the opened connection.
Say, one may want to read HTTP headers and then send
the connection FD to another process along with the read headers, so it will
receive and &quot;re-read&quot; them with dataReceived(). Modification of HTTP protocol
code will not be required here. But we need a modified transport constructor.

&gt;<i> &gt;Right now I am looking at t.i.unix.Connector and t.i.unix.Port to 
</I>&gt;<i> &gt;understand
</I>&gt;<i> &gt;how do transports get constructed by them, but well, that is too 
</I>&gt;<i> &gt;complex for a single evening.
</I>&gt;<i> &gt;Should I really get into the details of implementing my own transport 
</I>&gt;<i> &gt;(or their constructors)
</I>&gt;<i> &gt;to do what I need? I'm sure there should be something, that I missed in 
</I>&gt;<i> &gt;the documentation
</I>&gt;<i> &gt;(or in the code?).
</I>&gt;<i> 
</I>&gt;<i> Despite not appearing to be private, things like t.i.unix.Connector and 
</I>&gt;<i> t.i.unix.Port aren't really intended for use by applications.
</I>
No, no, I'm only using them as a documentation about what transport looks like
from the inside of the twisted, to other parts of the framework.

&gt;<i> 
</I>&gt;<i> This is the right part of Twisted to be looking at if you want to 
</I>&gt;<i> contribute a patch which adds this feature, though.  And I encourage you 
</I>&gt;<i> to do that. :)
</I>
Well, I was trying to get into it during last evening, but it turned out to be
more appropriate to spend a week or two on that process. It looks, like
transport abstraction is not documented as a whole, only the user visible
parts, or better say, protocol visible parts. I am still not sure whether
it is advisable to subclass a base.BaseConnector or we can simply
create a transport instance without that &quot;complications&quot;. It looks like
BaseConnector contain some portion of code, that should be reused.

&gt;<i> 
</I>&gt;<i> The implementation should be fairly straight-forward.  Most things like 
</I>&gt;<i> Port and Client and Server have a &quot;createInternetSocket&quot; method.  All 
</I>&gt;<i> that's really necessary to use an externally created file descriptor is 
</I>&gt;<i> get &quot;createInternetSocket&quot; to return that descriptor instead of creating 
</I>&gt;<i> a new one (or skip the call to the method entirely and just use the 
</I>&gt;<i> descriptor you have already).
</I>&gt;<i> 
</I>&gt;<i> The biggest question I have is what the API should look like.  Somehow 
</I>&gt;<i> the file descriptor needs to get from your application code (which knows 
</I>&gt;<i> that inetd put an open TCP connection on fd 0) to the 
</I>&gt;<i> Port/Client/Server.
</I>
That depends. Are we going to limit that feature to socket FDs only, or
should we provide more specific interfaces for different type of files?
Two (pipe) FDs may be used to construct full-duplex half-closeable transport too.
Or may someone be interested also in master pty based transport? That would indeed require some
terminal-specific support to be present in the transport instance, wouldn't it?
Like transport.sendBreak()
Perhaps one may use a full-duplex transport constructed from a tty/slave-pty FD?
It may be useful to provide analogous interface for half-duplex connections too, IMHO.

I think it may look like
  connection = somenewmodulename.socketConnection(fd, protocolFactory, addrFamily, sockType, reactor=None)
or
  import socket
  connection = somenewmodulename.socketConnection(socket.fromfd(fd, addrFamily, sockType), protocolFactory, reactor=None)

Create a transport object and associate/build a new protocol instance with/on it.
For other FD types there should be different functions, returning instances
of other types.

Would you comment on that?

&gt;<i> 
</I>&gt;<i> The obvious options, adding another argument to 
</I>&gt;<i> listen/connectTCP/UNIX/etc, would work, but is somewhat ugly (you have 
</I>&gt;<i> the issue that existing mandatory arguments would just be ignored).
</I>&gt;<i> 
</I>&gt;<i> Another idea would be adding new methods entirely.  I don't know if 
</I>&gt;<i> that's much better, though.
</I>
Adding new methods to reactor? I thought it can live completely separate
from the reactor code and do not pollute reactor interface. Reactor is only
used in the process of attaching a FD to a transport when new transport
registers it's FDs in the reactor, so it can be an (optional?) argument
to a constructor. However, yes, API consistency may suffer from that.

&gt;<i> 
</I>&gt;<i> So, if we can come up with a nice API, I think this will be a pretty 
</I>&gt;<i> quick feature to implement.
</I>
I think it could be a set of functions inside a platform-dependent module
if that functions will be FD-type dependent.

&gt;<i> &gt;And by the way, I haven't found any socketpair(2) usage in the twisted 
</I>&gt;<i> &gt;framework (except for tests),
</I>&gt;<i> &gt;how can that be? Transport based on socketpair sockets will have the 
</I>&gt;<i> &gt;same
</I>&gt;<i> &gt;implementation, as I need. Is it true, that nobody in twisted community 
</I>&gt;<i> &gt;uses
</I>&gt;<i> &gt;anonymous preconnected sockets in real life?
</I>&gt;<i> 
</I>&gt;<i> Apparently. :)
</I>
Oops, surprise!..
BTW creating a socketpair and forking and then communicating via PB seems
like an elegant and convenient feature to me. Perhaps non-portable?

&gt;<i> &gt;
</I>&gt;<i> &gt;PS: I need socket-based transport, that is, full-duplex, half- 
</I>&gt;<i> &gt;closeable, with support
</I>&gt;<i> &gt;of getting the remote endpoint address and with ability to start TLS on 
</I>&gt;<i> &gt;top of it
</I>&gt;<i> &gt;and without implementing every that feature myself :)
</I>&gt;<i> 
</I>&gt;<i> Hopefully if we can figure out how to create a Twisted transport object 
</I>&gt;<i> from an existing file descriptor, you should have no trouble with the 
</I>&gt;<i> rest of these.
</I>
That's what I need, and I really hoped, that it is already implemented. What a surprise.
Surely, I would not mind contibuting to such a great project, but first I
would have to get more understanding of it's abstractions.

Alexey.

-- 
&#1089; &#1091;&#1074;&#1072;&#1078;&#1077;&#1085;&#1080;&#1077;&#1084;,
&#1040;&#1083;&#1077;&#1082;&#1089;&#1077;&#1081; &#1064;&#1087;&#1072;&#1075;&#1080;&#1085;
&#1089;&#1080;&#1089;&#1090;&#1077;&#1084;&#1085;&#1099;&#1081; &#1072;&#1076;&#1084;&#1080;&#1085;&#1080;&#1089;&#1090;&#1088;&#1072;&#1090;&#1086;&#1088;
&#1094;&#1077;&#1093;&#1072; &#1087;&#1077;&#1088;&#1077;&#1076;&#1072;&#1095;&#1080; &#1076;&#1072;&#1085;&#1085;&#1099;&#1093;
&#1090;&#1077;&#1093;&#1085;&#1080;&#1095;&#1077;&#1089;&#1082;&#1086;&#1075;&#1086; &#1094;&#1077;&#1085;&#1090;&#1088;&#1072; &#1090;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;&#1084;&#1091;&#1085;&#1080;&#1082;&#1072;&#1094;&#1080;&#1081;
&#1054;&#1040;&#1054; &quot;&#1042;&#1086;&#1083;&#1075;&#1072;&#1058;&#1077;&#1083;&#1077;&#1082;&#1086;&#1084;&quot; 
&#1092;&#1080;&#1083;&#1080;&#1072;&#1083; &#1074; &#1059;&#1076;&#1084;&#1091;&#1088;&#1090;&#1089;&#1082;&#1086;&#1081; &#1088;&#1077;&#1089;&#1087;&#1091;&#1073;&#1083;&#1080;&#1082;&#1077;.

</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022555.html">[Twisted-Python] What is the minimum effort solution to	make	inetd-managed twisted-based application?
</A></li>
	<LI>Next message: <A HREF="022559.html">[Twisted-Python] What is the minimum effort solution to	make	inetd-managed twisted-based application?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22556">[ date ]</a>
              <a href="thread.html#22556">[ thread ]</a>
              <a href="subject.html#22556">[ subject ]</a>
              <a href="author.html#22556">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
