<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] kqueue reactor / ticket #1918
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20kqueue%20reactor%20/%20ticket%20%231918&In-Reply-To=634914A010D0B943A035D226786325D42D0C0CE449%40EXVMBX020-12.exch020.serverdata.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024812.html">
   <LINK REL="Next"  HREF="024831.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] kqueue reactor / ticket #1918</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20kqueue%20reactor%20/%20ticket%20%231918&In-Reply-To=634914A010D0B943A035D226786325D42D0C0CE449%40EXVMBX020-12.exch020.serverdata.net"
       TITLE="[Twisted-Python] kqueue reactor / ticket #1918">glyph at twistedmatrix.com
       </A><BR>
    <I>Sun Nov  6 16:12:58 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="024812.html">[Twisted-Python] kqueue reactor / ticket #1918
</A></li>
        <LI>Next message: <A HREF="024831.html">[Twisted-Python] kqueue reactor / ticket #1918
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24817">[ date ]</a>
              <a href="thread.html#24817">[ thread ]</a>
              <a href="subject.html#24817">[ subject ]</a>
              <a href="author.html#24817">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Nov 5, 2011, at 1:46 PM, Tobias Oberstein wrote:

&gt;&gt;&gt;<i> Then, baseline. I've run the trial using select reactor in the
</I>&gt;&gt;&gt;<i> expectation of finding all tests passed.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> This is not the case, there are a couple of failed ones. Those are
</I>&gt;&gt;&gt;<i> also failed with the kqueue reactor, so I need to know whether I need
</I>&gt;&gt;&gt;<i> to inspect those or those are problems unrelated to the reactor, but of
</I>&gt;&gt;<i> general (platform?) nature.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Are you using Twisted 11? Many of these issues are, if I'm not mistaken,
</I>&gt;&gt;<i> fixed in trunk (though perhaps not all). So trunk is probably a better baseline
</I>&gt;&gt;<i> to work off of.
</I>&gt;<i> 
</I>&gt;<i> Ok, I'm using trunk now.
</I>&gt;<i> 
</I>&gt;<i> 1)
</I>&gt;<i> The errors in
</I>&gt;<i> 
</I>&gt;<i> twisted.python.test.test_components
</I>&gt;<i> 
</I>&gt;<i> are gone.
</I>&gt;<i> 
</I>&gt;<i> 2)
</I>&gt;<i> The errors in
</I>&gt;<i> 
</I>&gt;<i> twisted.internet.test.test_posixprocess
</I>&gt;<i> twisted.internet.test.test_process
</I>&gt;<i> 
</I>&gt;<i> are still there ... and they show up for select, poll and kqueue reactors.
</I>&gt;<i> 
</I>&gt;<i> They all somehow relate to &quot;open FDs&quot;:
</I>&gt;<i> 
</I>&gt;<i> twisted.internet.test.test_posixprocess
</I>&gt;<i>  FileDescriptorTests
</I>&gt;<i>    test_expectedFDs ...                                                 [FAIL]
</I>&gt;<i> 
</I>&gt;<i> twisted.internet.test.test_process
</I>&gt;<i>  PTYProcessTestsBuilder_KQueueReactor
</I>&gt;<i>    test_openFileDescriptors ...                                        [ERROR]
</I>&gt;<i>  PTYProcessTestsBuilder_PollReactor
</I>&gt;<i>    test_openFileDescriptors ...                                        [ERROR]
</I>&gt;<i>  PTYProcessTestsBuilder_SelectReactor
</I>&gt;<i>    test_openFileDescriptors ...                                        [ERROR]
</I>&gt;<i> ProcessTestsBuilder_SelectReactor
</I>&gt;<i>    test_openFileDescriptors ...                                        [ERROR]
</I>&gt;<i> 
</I>&gt;<i> This might more a FreeBSD related thing. ?
</I>
Yes.

These tests should pass; I am guessing this has something to do with the still-open ticket &lt;<A HREF="http://tm.tl/4747">http://tm.tl/4747</A>&gt;.  Maybe have a look at fixing that?

You might be able to work around it on your system this by mounting fdescfs at /dev/fd.  (This really ought to be the default, please bother someone in FreeBSD-land to make it so. :)).

It would be useful to include tracebacks with the errors.  &quot;trial --rterrors&quot; is useful, as it includes the tracebacks  especially if you are experiencing hanging with the tests.

&gt;<i> 3)
</I>&gt;<i> I think I've nailed down the Half-Close stuff.
</I>
Awesome.  Do you have a link to a changeset for that?  (Did I miss it earlier in the thread?)

&gt;<i> 4)
</I>&gt;<i> These are kqueue specific. Need to investigate further.
</I>
These are the ones to focus on for &lt;<A HREF="http://tm.tl/1918">http://tm.tl/1918</A>&gt;, then :).

&gt;<i> twisted.internet.test.test_fdset
</I>&gt;<i>  ReactorFDSetTestsBuilder_KQueueReactor
</I>&gt;<i>    test_lostFileDescriptor ...                                         [ERROR]
</I>&gt;<i>    test_removedFromReactor ...                                          [FAIL]
</I>&gt;<i> 
</I>&gt;<i> The first one comes up, since
</I>&gt;<i> 
</I>&gt;<i> removeReader()
</I>&gt;<i> 
</I>&gt;<i> is called for a FD which is gone,  and leads to a socket exception from fd = reader.fileno()
</I>
It sounds like you've narrowed this down pretty far!  Good work.

&gt;<i> 5)
</I>&gt;<i> These are kqueue specific. Need to investigate further.
</I>&gt;<i> 
</I>&gt;<i> twisted.conch.test.test_conch
</I>&gt;<i> 
</I>&gt;<i> The fail on the kqeue control call .. see below.
</I>&gt;<i> 
</I>&gt;<i> Any ideas what could be the reason?
</I>
I would suggest fixing the issues you outlined in point 4 first.  It's really unfortunate that reactor issues are being caught by conch tests.  The reactor tests should be comprehensive enough to catch everything in the reactor.

This may just be a side-effect of the other errors you're tracking down, so see if you can fix those, and then loop back to these.  If they disappear, then great.  If not, then we should have a test that specifically tests this functionality and doesn't rely on weird and difficult to diagnose errors in conch to find them.

Thanks again for working on this!

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20111106/e79ac761/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20111106/e79ac761/attachment.htm</A> 
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024812.html">[Twisted-Python] kqueue reactor / ticket #1918
</A></li>
	<LI>Next message: <A HREF="024831.html">[Twisted-Python] kqueue reactor / ticket #1918
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24817">[ date ]</a>
              <a href="thread.html#24817">[ thread ]</a>
              <a href="subject.html#24817">[ subject ]</a>
              <a href="author.html#24817">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
