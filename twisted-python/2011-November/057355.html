<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] data dispatch on massive connection counts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20data%20dispatch%20on%20massive%20connection%20counts&In-Reply-To=%3C634914A010D0B943A035D226786325D42D0C264675%40EXVMBX020-12.exch020.serverdata.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="057343.html">
   <LINK REL="Next"  HREF="057356.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] data dispatch on massive connection counts</H1>
    <B>Tobias Oberstein</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20data%20dispatch%20on%20massive%20connection%20counts&In-Reply-To=%3C634914A010D0B943A035D226786325D42D0C264675%40EXVMBX020-12.exch020.serverdata.net%3E"
       TITLE="[Twisted-Python] data dispatch on massive connection counts">tobias.oberstein at tavendo.de
       </A><BR>
    <I>Mon Nov 14 05:07:46 MST 2011</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="057343.html">[Twisted-Python] Creating a PKCS#11 Enabled SSL Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="057356.html">[Twisted-Python] data dispatch on massive connection counts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57355">[ date ]</a>
              <a href="thread.html#57355">[ thread ]</a>
              <a href="subject.html#57355">[ subject ]</a>
              <a href="author.html#57355">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am testing a WebSocket based pubsub system .. I have 2 questions .. any hints welcome!

Environment:
  + FreeBSD 8.2 i386
  + Python 2.7.2 32-bit
  + Twisted Trunk
  + new kqueue() reactor

The FreeBSD is tuned for massive connection numbers. I can connect 50k WS clients. Fine.


1) Massive dispatching

Essentially, what I'm currently doing is:

recvs = set([100k instances of protocol.Protocol])

data = &quot;...&quot;
for recv in recvs:
   recv.transport.write(data)

Now, writing mass-data to _one_ transport should be done using producer/consumer.

But in my case, the data itself is tiny (&lt;100 octets) and the same for all clients, but the number
of transports to dispatch that data to is massive.

The problem is: while above loop is running, other stuff is being delayed.

What would be the right approach to solve that?

One idea is to split the loop into 1k chunks and use reactor.callLater to have the sending
called again until all recvs are served.

Reentry of the reactor via reactor.callLater should make other stuff run in-between, right?

Can I use callLater(0, ..) .. that is no delay at all?

And is this approach recommended anyway?


2) Too many files.

As said, the FreeBSD is tuned for massive connections and I can connect 50k clients.

However, the Twisted application not only contains the WebSockets stuff, but also a
Twisted Web based web server.

Somewhere above 30k connections, I'm beginning to see:


twisted/web/server.py, line 132 in process
...
twisted/python/filepath.py, line 643 in open

&lt;type 'exceptions.IOError'&gt;: [Errno 24] Too many open files

However:

[<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">autobahn at autobahnhub</A> ~/AutobahnHub/service]$ sysctl kern.maxfiles
kern.maxfiles: 204800
[<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">autobahn at autobahnhub</A> ~/AutobahnHub/service]$ sysctl kern.maxfilesperproc
kern.maxfilesperproc: 200000
[<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">autobahn at autobahnhub</A> ~/AutobahnHub/service]$ sysctl kern.ipc.maxsockets
kern.ipc.maxsockets: 204800
[<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">autobahn at autobahnhub</A> ~/AutobahnHub/service]$ ulimit
unlimited

It should go well beyond 50k.

Doing an lsof on the app PID, I can see the 50k connected TCPs and &lt;100 open files.

Why is it denying opening more files?

Is there another limit specifically for files, and/or something tunable in Python/Twisted?





</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="057343.html">[Twisted-Python] Creating a PKCS#11 Enabled SSL Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="057356.html">[Twisted-Python] data dispatch on massive connection counts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57355">[ date ]</a>
              <a href="thread.html#57355">[ thread ]</a>
              <a href="subject.html#57355">[ subject ]</a>
              <a href="author.html#57355">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
