<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Oddities in calling loseConnection from tcp.Port.approveConnection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Oddities%20in%20calling%20loseConnection%20from%20tcp.Port.approveConnection&In-Reply-To=%3C20020402095231.GA6286%40ritsuko.xware.cx%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="033487.html">
   <LINK REL="Next"  HREF="033485.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Oddities in calling loseConnection from tcp.Port.approveConnection</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Oddities%20in%20calling%20loseConnection%20from%20tcp.Port.approveConnection&In-Reply-To=%3C20020402095231.GA6286%40ritsuko.xware.cx%3E"
       TITLE="[Twisted-Python] Oddities in calling loseConnection from tcp.Port.approveConnection">andrew-twisted at puzzling.org
       </A><BR>
    <I>Tue Apr  2 02:52:31 MST 2002</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="033487.html">[Twisted-Python] OT, sorry [was: Re: ANN: Twisted 0.16.0]
</A></li>
        <LI>Next message (by thread): <A HREF="033485.html">[Twisted-Python] Oddities in calling loseConnection from tcp.Port.approveConnection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33484">[ date ]</a>
              <a href="thread.html#33484">[ thread ]</a>
              <a href="subject.html#33484">[ subject ]</a>
              <a href="author.html#33484">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok, so I know approveConnection is probably going to be removed anyway,
but...

If I have a tcp.Port subclass which calls self.loseConnection() in
approveConnection (e.g. so that it will only accept one connection), then I
get two errors.  First is:
Traceback (most recent call last):
  File &quot;w:\andrew\cvs\Twisted\twisted\internet\main.py&quot;, line 206, in doSelect
    if not handfn or handfn() == -1:
  File &quot;w:\andrew\cvs\Twisted\twisted\internet\abstract.py&quot;, line 244, in fileno
    raise NotImplementedError(str(self.__class__)+' has no fileno method')
exceptions.NotImplementedError: twisted.protocols.ftp.FTPDataPort has no fileno method

I think the fix for this might be:
diff -u -r1.65 main.py
--- twisted/internet/main.py    1 Apr 2002 06:35:16 -0000       1.65
+++ twisted/internet/main.py    2 Apr 2002 09:41:07 -0000
@@ -203,7 +203,10 @@
             try:
                 why = getattr(selectable, method)()
                 handfn = getattr(selectable, 'fileno', None)
-                if not handfn or handfn() == -1:
+                try:
+                    if not handfn or handfn() == -1:
+                        why = CONNECTION_LOST
+                except NotImplementedError:
                     why = CONNECTION_LOST
             except:
                 log.deferr()

The second error is:
Traceback (most recent call last):
  File &quot;w:\andrew\cvs\Twisted\twisted\internet\main.py&quot;, line 215, in doSelect
    selectable.connectionLost()
  File &quot;w:\andrew\cvs\Twisted\twisted\internet\tcp.py&quot;, line 476, in connectionLost
    self.socket.close()
exceptions.AttributeError: FTPDataPort instance has no attribute 'socket'

This appears to be because connectionLost is called twice; once when I
originally called loseConnection and again from the select loop.  I'm not
sure what the correct fix is... I don't understand why the select loop is
calling it because removeReader is calling in loseConnection, but perhaps
connectionLost should check self.connected and gracefully deal with being
called twice?

I'll probably be doing my loseConnection from buildProtocol instead of
approveConnection soon, but I suspect that I'll hit these problems there as
well.

-Andrew.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="033487.html">[Twisted-Python] OT, sorry [was: Re: ANN: Twisted 0.16.0]
</A></li>
	<LI>Next message (by thread): <A HREF="033485.html">[Twisted-Python] Oddities in calling loseConnection from tcp.Port.approveConnection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#33484">[ date ]</a>
              <a href="thread.html#33484">[ thread ]</a>
              <a href="subject.html#33484">[ subject ]</a>
              <a href="author.html#33484">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
