<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted Memory Leaks &amp; Epoll
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted%20Memory%20Leaks%20%26%20Epoll&In-Reply-To=841030CD-6067-4B95-AB04-0FBBB01DB7F7%40zgroupplc.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015319.html">
   <LINK REL="Next"  HREF="015323.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted Memory Leaks &amp; Epoll</H1>
    <B>Alec Matusis</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Twisted%20Memory%20Leaks%20%26%20Epoll&In-Reply-To=841030CD-6067-4B95-AB04-0FBBB01DB7F7%40zgroupplc.com"
       TITLE="[Twisted-Python] Twisted Memory Leaks &amp; Epoll">matusis at matusis.com
       </A><BR>
    <I>Tue May  1 23:40:08 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015319.html">[Twisted-Python] Twisted Memory Leaks &amp; Epoll
</A></li>
        <LI>Next message: <A HREF="015323.html">[Twisted-Python] Twisted Memory Leaks &amp; Epoll
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15322">[ date ]</a>
              <a href="thread.html#15322">[ thread ]</a>
              <a href="subject.html#15322">[ subject ]</a>
              <a href="author.html#15322">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Our empirical experience with leaks is the following:
Python 2.4 never releases memory, but you can get very good results with
Twisted 2.2 when the servers are at high-load all the time. We have servers
that run at 70%+ CPU for more than a month without restarting.
When a server starts, it exhibits a memory increase from say 60MB in the
first hour to 70MB after the first 24 hours. The memory increase slows down,
asymptotically approaching some fixed value (which is possibly set by the
highest usage). Then it can run literally for months, never exceeding 80MB.

When there's a memory leak due to bad code, the best thing to do is to set
up a manhole, and inspect all objects. 
Also, manually decrementing reference counts like so:

def stat_collect():
    gc.collect()
    twisted.internet.reactor.callLater(config.gc_collect_interval,
stat_collect)

stat_collect()

helped us in one case.

With Twisted 2.5, we saw memory leaks for poll reactor for the same code
that was non-leaking on 2.2. 



&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> [mailto:twisted-python-
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bounces at twistedmatrix.com</A>] On Behalf Of Matthew Glubb
</I>&gt;<i> Sent: Tuesday, May 01, 2007 6:07 AM
</I>&gt;<i> To: Twisted general discussion
</I>&gt;<i> Subject: [Twisted-Python] Twisted Memory Leaks &amp; Epoll
</I>&gt;<i> 
</I>&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i> 
</I>&gt;<i> Dear All,
</I>&gt;<i> 
</I>&gt;<i> I have been benchmarking my twistd application (twisted.web.server)
</I>&gt;<i> and I am seeing increasing memory usage that is never freed. Before I
</I>&gt;<i> delve into GC and valgrind, I am interested in learning whether there
</I>&gt;<i> are any fundamental no-nos under twisted that might result in a leak.
</I>&gt;<i> I am relatively new to twisted and its entirely possible that I am
</I>&gt;<i> doing something wrong.
</I>&gt;<i> 
</I>&gt;<i> I am also interested in learning what the stability of the epoll
</I>&gt;<i> reactor is. I have come across a few (old) posts that pointed to it
</I>&gt;<i> being incomplete. Would the epoll reactor be a possible cause of a
</I>&gt;<i> memory leak? Leak aside, I have benchmarked my app up to 5000
</I>&gt;<i> simultaneous connections with no obvious drop in performance.
</I>&gt;<i> Switching to poll produces *terrible* results.
</I>&gt;<i> 
</I>&gt;<i> For the purposes of diagnosing the cause of the leak (C extension,
</I>&gt;<i> python, twisted, or my code) I have removed external library
</I>&gt;<i> dependencies and I have also swapped out reactors. The leak persists.
</I>&gt;<i> 
</I>&gt;<i> Does anyone have any good tips for diagnosing leaks under twisted?
</I>&gt;<i> For what its worth, I am conducting my tests under an AMD 64bit
</I>&gt;<i> architecture.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Matt
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> m a t t h e w   g l u b b
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________________________________
</I>&gt;<i> _
</I>&gt;<i> Z Group PLC
</I>&gt;<i> 
</I>&gt;<i> Tel: +44 (0) 8700 111 173
</I>&gt;<i> Fax: +44 (0) 8707 051 393
</I>&gt;<i> Txt: +44 (0) 7800 140 877
</I>&gt;<i> Web: &lt;<A HREF="http://www.zgroupplc.com/">http://www.zgroupplc.com/</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> This  email  and  any  files  transmitted  with it are  confidential
</I>&gt;<i> and
</I>&gt;<i> intended solely for the use of the individual or entity to whom they
</I>&gt;<i> are
</I>&gt;<i> addressed.  The opinions  expressed in this mail are those of the
</I>&gt;<i> author
</I>&gt;<i> and do not necessarily  represent the views of the company.  If you
</I>&gt;<i> have
</I>&gt;<i> received this email in error please notify &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">service at zgroupplc.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v1.4.1 (Darwin)
</I>&gt;<i> 
</I>&gt;<i> iD8DBQFGNztmyI6MkdKPngkRAnW5AJ9D8Lx2BN3Ds8BL33TL1TS1QnK1pgCgk2X5
</I>&gt;<i> 2HVOxP93ZJCWWLQ7Tver3wE=
</I>&gt;<i> =1nnG
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015319.html">[Twisted-Python] Twisted Memory Leaks &amp; Epoll
</A></li>
	<LI>Next message: <A HREF="015323.html">[Twisted-Python] Twisted Memory Leaks &amp; Epoll
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15322">[ date ]</a>
              <a href="thread.html#15322">[ thread ]</a>
              <a href="subject.html#15322">[ subject ]</a>
              <a href="author.html#15322">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
