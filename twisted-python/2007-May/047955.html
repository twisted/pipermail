<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] better way to do this?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20better%20way%20to%20do%20this%3F&In-Reply-To=%3C18e3f33d0705291524q6c418d28ga04f82f5cb3e3814%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="047963.html">
   <LINK REL="Next"  HREF="047956.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] better way to do this?</H1>
    <B>Eli Criffield</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20better%20way%20to%20do%20this%3F&In-Reply-To=%3C18e3f33d0705291524q6c418d28ga04f82f5cb3e3814%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] better way to do this?">elicriffield at gmail.com
       </A><BR>
    <I>Tue May 29 16:24:17 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="047963.html">[Twisted-Python] RE: Modifying a web proxy to use SSL
</A></li>
        <LI>Next message (by thread): <A HREF="047956.html">[Twisted-Python] better way to do this?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47955">[ date ]</a>
              <a href="thread.html#47955">[ thread ]</a>
              <a href="subject.html#47955">[ subject ]</a>
              <a href="author.html#47955">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>What i want to do is validate the &quot;From&quot; host of an xmlrpc server
against a list of allowed servers.

Sounds easy enough but &quot;connectionMade(self)&quot; Call is way back in
http.HTTPChannel. That is set as the protocol in http.HTTPFactory and
HTTPFactory is inherits by server.Site.

So whats the best way to change one little function in http.HTTPChannel ?

Here is what i have now, but the I have to include all of server.Site
in my example, even though its unchanged except it inherits
myHTTPFactory instead of http.HTTPFactory.

Is there a simpler way to do this?

Eli Criffield

--example---
#!/usr/bin/env python

from twisted.web import xmlrpc, server, http, resource
from twisted.internet import reactor
from twisted.python.log import startLogging
from sys import stdout
import copy

class Example(xmlrpc.XMLRPC):
    &quot;&quot;&quot;An example object to be published.&quot;&quot;&quot;

    def xmlrpc_echo(self, x):
        &quot;&quot;&quot;Return all passed args.&quot;&quot;&quot;
        print &quot;echo called&quot;
        return x

    def xmlrpc_add(self, a, b):
        &quot;&quot;&quot;Return sum of arguments.&quot;&quot;&quot;
        print &quot;add called&quot;
        return a + b

class myHTTPChannel(http.HTTPChannel):
    def connectionMade(self):
        print &quot;Check here if connection is allowed from&quot;,
self.transport.getPeer()
        self.setTimeout(self.timeOut)

class myHTTPFactory(http.HTTPFactory):
    protocol = myHTTPChannel


class mySite(myHTTPFactory):

    counter = 0
    requestFactory = server.Request
    displayTracebacks = True

    def __init__(self, resource, logPath=None, timeout=60*60*12):
        &quot;&quot;&quot;Initialize.
        &quot;&quot;&quot;
        http.HTTPFactory.__init__(self, logPath=logPath, timeout=timeout)
        self.sessions = {}
        self.resource = resource

    def _openLogFile(self, path):
        from twisted.python import logfile
        return logfile.LogFile(os.path.basename(path), os.path.dirname(path))

    def __getstate__(self):
        d = self.__dict__.copy()
        d['sessions'] = {}
        return d

    def _mkuid(self):
        &quot;&quot;&quot;(internal) Generate an opaque, unique ID for a user's session.
        &quot;&quot;&quot;
        import md5, random
        self.counter = self.counter + 1
        return md5.new(&quot;%s_%s&quot; % (str(random.random()) ,
str(self.counter))).hexdigest()

    def makeSession(self):
        &quot;&quot;&quot;Generate a new Session instance, and store it for future reference.
        &quot;&quot;&quot;
        uid = self._mkuid()
        session = self.sessions[uid] = Session(self, uid)
        session.checkExpiredLoop.start(1800)
        return session

    def getSession(self, uid):
        &quot;&quot;&quot;Get a previously generated session, by its unique ID.
        This raises a KeyError if the session is not found.
        &quot;&quot;&quot;
        return self.sessions[uid]

    def buildProtocol(self, addr):
        &quot;&quot;&quot;Generate a channel attached to this site.
        &quot;&quot;&quot;
        channel = http.HTTPFactory.buildProtocol(self, addr)
        channel.requestFactory = self.requestFactory
        channel.site = self
        return channel

    isLeaf = 0

    def render(self, request):
        &quot;&quot;&quot;Redirect because a Site is always a directory.
        &quot;&quot;&quot;
        request.redirect(request.prePathURL() + '/')
        request.finish()

    def getChildWithDefault(self, pathEl, request):
        &quot;&quot;&quot;Emulate a resource's getChild method.
        &quot;&quot;&quot;
        request.site = self
        return self.resource.getChildWithDefault(pathEl, request)

    def getResourceFor(self, request):
        &quot;&quot;&quot;Get a resource for a request.

        This iterates through the resource heirarchy, calling
        getChildWithDefault on each resource it finds for a path element,
        stopping when it hits an element where isLeaf is true.
        &quot;&quot;&quot;
        request.site = self
        # Sitepath is used to determine cookie names between distributed
        # servers and disconnected sites.
        request.sitepath = copy.copy(request.prepath)
        return resource.getChildForRequest(self.resource, request)



if __name__ == '__main__':
    r = Example()

    reactor.listenTCP(7080,mySite(r),ctx)
    startLogging(stdout)
    reactor.run()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="047963.html">[Twisted-Python] RE: Modifying a web proxy to use SSL
</A></li>
	<LI>Next message (by thread): <A HREF="047956.html">[Twisted-Python] better way to do this?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47955">[ date ]</a>
              <a href="thread.html#47955">[ thread ]</a>
              <a href="subject.html#47955">[ subject ]</a>
              <a href="author.html#47955">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
