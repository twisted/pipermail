<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Sequential use of asynchronous calls
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Sequential%20use%20of%20asynchronous%20calls&In-Reply-To=200705270820.41462.maarten%40treewalker.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015442.html">
   <LINK REL="Next"  HREF="015444.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Sequential use of asynchronous calls</H1>
    <B>Ben Artin</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Sequential%20use%20of%20asynchronous%20calls&In-Reply-To=200705270820.41462.maarten%40treewalker.org"
       TITLE="[Twisted-Python] Sequential use of asynchronous calls">ben at artins.org
       </A><BR>
    <I>Sun May 27 04:35:24 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015442.html">[Twisted-Python] Sequential use of asynchronous calls
</A></li>
        <LI>Next message: <A HREF="015444.html">[Twisted-Python] Sequential use of asynchronous calls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15443">[ date ]</a>
              <a href="thread.html#15443">[ thread ]</a>
              <a href="subject.html#15443">[ subject ]</a>
              <a href="author.html#15443">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Maybe it's more clear to call it @inlineCallbacks, since that is  
</I>&gt;<i> the name
</I>&gt;<i> under which it is available; @sequential was just me re-inventing it.
</I>
That's OK. I reinvented it and called it something else myself :-)

&gt;<i> I agree that adding &quot;yield None&quot; is an ugly fix, but why not just  
</I>&gt;<i> remove the
</I>&gt;<i> @inlineCallbacks decoration from such a function instead? I still  
</I>&gt;<i> don't
</I>&gt;<i> understand what the point is of decorating a non-generator function  
</I>&gt;<i> with
</I>&gt;<i> @inlineCallbacks.
</I>
There is no theoretical reason. Of course I can and remove the  
decorator, but that is not how my brain works when write the code,  
and I suspect I am not alone in this. This is how I usually write my  
code:

.oO(I am writing a function)
.oO(The function's interface is that it returns a deferred, so write  
@inlineCallbacks)

@inlineCallbacks
def functionName(args):

.oO(Now, what's the body going to be like?)
type type type type
twenty lines later:
.oO(Done!)

then I run the code, and find out that I have to either add a yield  
None or remove the decorator because as it happens, there's no yield  
or return in those twenty lines of code.

Now, the reason that my brain works this way is that I consider the  
fact that the function returns a deferred a part of its interface,  
and if I am using Python 2.5 (which I almost exclusively am), then  
@inlineCallbacks is by far the cleanest way to write Deferred-using  
code. It turns my control flow right-side out and it allows me to  
stop focusing on how I pass control around using deferreds and start  
focusing on the problem I am trying to solve.

To that end, requiring me to either add noise to my function's  
implementation (in the form of &quot;yield None&quot;) or to tweak the  
function's header because of a happenstance of its implementation is  
just distracting me away from writing my code and pulling my  
attention to something irrelevant.

Again, my argument is that the distinction between:

@inlineCallbacks
def functionName(args):
	...some code...
	yield None

and

@inlineCallbacks
def functionName(args):
	...some code...
	... without a return statement...

is completely irrelevant and serves no purpose except to distract me  
from my code. If I could find *any* case in which treating the latter  
case exactly the same as the former case is not what was intended,  
then I might be willing to concede that there is value in forcing the  
user to clarify what they meant; however I do not see that case.

&gt;&gt;<i> For example:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class TakesALongTime():
</I>&gt;&gt;<i> 	@sequential
</I>&gt;&gt;<i> 	def doSomething(self):
</I>&gt;&gt;<i> 		yield doPart1()
</I>&gt;&gt;<i> 		yield doPart2()
</I>&gt;&gt;<i> 		yield someResult
</I>&gt;<i>
</I>&gt;<i> This doesn't do what you might expect...
</I>&gt;<i>
</I>&gt;<i> Let's assume doPart1 and doPart2 return Deferreds, named d1 and d2.  
</I>&gt;<i> When
</I>&gt;<i> doSomething is called, inlineCallbacks will run doPart1, register  
</I>&gt;<i> itself on
</I>&gt;<i> d1 and return its own Deferred (dr) to the caller of doSomething.  
</I>&gt;<i> When the
</I>&gt;<i> reactor does the callback on d1, doPart2 will be called and  
</I>&gt;<i> inlineCallbacks
</I>&gt;<i> will register itself on d2. Finally, when the callback of d2 is  
</I>&gt;<i> called,
</I>&gt;<i> someResult will be discarded by inlineCallbacks and the callback of  
</I>&gt;<i> dr will
</I>&gt;<i> be called with result None.
</I>&gt;<i>
</I>&gt;<i> To do what you probably intended, the code would look like this:
</I>&gt;<i>
</I>&gt;<i> class TakesALongTime():
</I>&gt;<i> 	@defer.inlineCallbacks
</I>&gt;<i> 	def doSomething(self):
</I>&gt;<i> 		yield doPart1()
</I>&gt;<i> 		yield doPart2()
</I>&gt;<i> 		defer.returnValue(someResult)
</I>
Actually this in itself is IMO a bug in inlineCallbacks. The only  
reason why inlineCallbacks is implemented this way is that prior to  
Python 2.5 it was impossible to implement coroutines in terms of just  
the yield statement, and therefore some extra magic was needed to  
achieve the desired effect. If you read the coroutines PEP (&lt;http:// 
www.python.org/dev/peps/pep-0342/&gt;), you'll see that the syntax I  
used above is the syntax suggested by the PEP (and, not accidentally,  
also the syntax used by my own version of @inlineCallbacks)

&gt;<i> Note that the current implementation of @inlineCallbacks will raise  
</I>&gt;<i> an error
</I>&gt;<i> at &quot;invocation time&quot;, specifically when &quot;g.send&quot; or &quot;g.throw&quot; is  
</I>&gt;<i> called. I'm
</I>&gt;<i> proposing to change that so an error will be raised by the  
</I>&gt;<i> decorator instead
</I>&gt;<i> (&quot;decoration time&quot;, typically when the module is imported).
</I>
I understand. I am proposing that it's not an error, because there is  
no case in which it's ambiguous what the intent was.

Another argument I can make in favor of this idea is that:

@inlineCallbacks
def doSomething():
	raise SomeException()

works the way you'd think it would upon reading the code and therefore

@inlineCallbacks
def doSomething():
	return someValue

should also work the way you'd think it would upon reading the code.

&gt;<i> Should something be given an interpretation because there are no  
</I>&gt;<i> unintended
</I>&gt;<i> results, or because there are intended results?
</I>
I believe that anyone who writes code that returns a plain value out  
of a function decorated with @inlineCallbacks has a clear intent, and  
they merely did not fuss over the syntax of @inlineCallback. I  
further believe that is in no way beneficial to force people to fuss  
over that syntax, and in no way detrimental to allow them to just  
return a plain value (because there is no ambiguity). Therefore, it  
should be done.

Ben

--

&lt;<A HREF="http://artins.org/ben">http://artins.org/ben</A>&gt;

&quot;Computers! All they ever think of is hex!&quot;




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015442.html">[Twisted-Python] Sequential use of asynchronous calls
</A></li>
	<LI>Next message: <A HREF="015444.html">[Twisted-Python] Sequential use of asynchronous calls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15443">[ date ]</a>
              <a href="thread.html#15443">[ thread ]</a>
              <a href="subject.html#15443">[ subject ]</a>
              <a href="author.html#15443">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
