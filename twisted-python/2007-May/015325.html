<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] client side cert?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20client%20side%20cert%3F&In-Reply-To=18e3f33d0705012130q627492a9v3973f634580d7b04%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015324.html">
   <LINK REL="Next"  HREF="015330.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] client side cert?</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20client%20side%20cert%3F&In-Reply-To=18e3f33d0705012130q627492a9v3973f634580d7b04%40mail.gmail.com"
       TITLE="[Twisted-Python] client side cert?">glyph at divmod.com
       </A><BR>
    <I>Wed May  2 01:15:18 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015324.html">[Twisted-Python] client side cert?
</A></li>
        <LI>Next message: <A HREF="015330.html">[Twisted-Python] client side cert?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15325">[ date ]</a>
              <a href="thread.html#15325">[ thread ]</a>
              <a href="subject.html#15325">[ subject ]</a>
              <a href="author.html#15325">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04:30 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">elicriffield at gmail.com</A> wrote:
&gt;<i>I try to make the x590 object to feed to CertificateOptions from
</I>&gt;<i>t.i.s.Certifcate.loadPEM() but it doesn't like it. I see nowhere in
</I>&gt;<i>t.i.ssl to make a PKey object that t.i.s.CertificationOptions() wants.
</I>
&gt;<i>I've tried t.i.s.ContextFactory() but there is no options for
</I>&gt;<i>requiring a client side cert.
</I>&gt;<i>t.i.s.ClientContextFactory doesn't seem to have any options to tell it
</I>&gt;<i>what cert to use on the client side either, or how to verify the
</I>&gt;<i>server cert, I guess thats what t.i.s.CertificationOptions() is for
</I>&gt;<i>but it doesn't seem to work as documented.
</I>
The &quot;right&quot; way to do this (and by &quot;right&quot; I mean the way I intended and 
used when I originally wrote this code, but never documented in any way) 
is by using the &quot;PrivateCertificate&quot; object, which represents a paired 
public/private key, and its (poorly named, and by the way did I mention 
it's undocumented) &quot;options&quot; method, which creates the 
CertificateOptions object for you.

I can see from your example that you're already expecting the key and 
certificate to be in the same PEM file (like everyone does) so it could 
be as easy as this:

    from twisted.internet.ssl import PrivateCertificate
    pc = PrivateCertificate.loadPEM(file('test.cert', r').read())
    ctxFactory = pc.options()

although if you want to verify client certificates, options() also 
takes, as varargs, a tuple of certificate authorities.  However, a 
private certificate can also fill the role of a public certificate, so 
you can do:

    ctxFactory = pc.options(pc)

to use a self-signed certificate as its own authority.

This context factory can be used either for client or server 
connections, as shown below.

If you are doing anything interesting with SSL, you might want to have a 
look at the source in the file twisted/internet/_sslverify.py, 
especially the other (undocumented) methods of PrivateCertificate, which 
implements a bit of CA functionality.
&gt;<i>Is there some great documentation out there about how to do this with
</I>&gt;<i>twisted.internet.ssl that I'm missing?
</I>
Nope.  The documentation here is particularly thin, and to make matters 
work, there are certain operations that are unsupported due to bugs or 
non-wrapped functions in pyopenssl.

Please feel free to file a more specific documentation bug (and feel 
_double_ free to attach a patch) to add docstrings to _sslverify, and 
probably a separate bug to add an introductory document.

I'm a big fan of complete runnable examples, so here's something to get 
you started.  Hope that this helps:

--- cut here ---

from sys import stdout, argv

from twisted.python.filepath import FilePath
from twisted.python.log import startLogging

from twisted.internet.protocol import Protocol, Factory, ClientFactory

from twisted.internet import reactor
from twisted.internet.ssl import PrivateCertificate

class MyProto(Protocol):
    def connectionMade(self):
        self.transport.write(self.factory.stuff)
    def dataReceived(self, data):
        stdout.write('Received %r\n' % (data,))

theCert = PrivateCertificate.loadPEM(file('server.pem','r').read())
theOptions = theCert.options(theCert)

def server():
    f = Factory()
    f.stuff = 'hello, client'
    f.protocol = MyProto
    reactor.listenSSL(7080, f, theOptions)

def client():
    f = ClientFactory()
    f.stuff = 'hello, server'
    f.protocol = MyProto
    reactor.connectSSL('localhost', 7080, f, theOptions)

def main():
    startLogging(stdout)
    if argv[1] == 'server':
        server()
    else:
        client()
    reactor.run()

if __name__ == '__main__':
    main()
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20070502/0661da0e/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20070502/0661da0e/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015324.html">[Twisted-Python] client side cert?
</A></li>
	<LI>Next message: <A HREF="015330.html">[Twisted-Python] client side cert?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15325">[ date ]</a>
              <a href="thread.html#15325">[ thread ]</a>
              <a href="subject.html#15325">[ subject ]</a>
              <a href="author.html#15325">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
