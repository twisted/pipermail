<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Assigning AMP box senders &amp; receivers from the	responder
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Assigning%20AMP%20box%20senders%20%26%20receivers%20from%20the%0A%09responder&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025743.html">
   <LINK REL="Next"  HREF="025746.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Assigning AMP box senders &amp; receivers from the	responder</H1>
    <B>Laurens Van Houtven</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Assigning%20AMP%20box%20senders%20%26%20receivers%20from%20the%0A%09responder&In-Reply-To="
       TITLE="[Twisted-Python] Assigning AMP box senders &amp; receivers from the	responder">_ at lvh.cc
       </A><BR>
    <I>Tue Jul  3 03:08:41 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="025743.html">[Twisted-Python] ANN: Twisted DBus 1.0
</A></li>
        <LI>Next message: <A HREF="025746.html">[Twisted-Python] Assigning AMP box senders &amp; receivers from the	responder
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25735">[ date ]</a>
              <a href="thread.html#25735">[ thread ]</a>
              <a href="subject.html#25735">[ subject ]</a>
              <a href="author.html#25735">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have an AMP service that does cred-based auth with IBoxReceiver as the interface (see mantissa). On login, the user gets a different API depending if they're a staff member or not.

Additionally, I wrote a composing IResponderLocator. It takes a bunch of responder locators and calls them in sequence to see if they can provide a responder. The reason it exists is because I want to put behavior in their separate, related modules, but @Command.responder is only supposed to work at class definition time. Here's the implementation:

class ComposedLocator(object):
   &quot;&quot;&quot;
   A responder locator that consists of other locators.
   &quot;&quot;&quot;
   interface.implements(amp.IResponderLocator)

   class __metaclass__(type):
       def __new__(meta, name, bases, attrs):
           &quot;&quot;&quot;
           Makes sure every subclass gets its own set of locator classes.
           &quot;&quot;&quot;
           attrs[&quot;_locatorClasses&quot;] = []
           return type.__new__(meta, name, bases, attrs)


   def __init__(self, *args, **kwargs):
       self._locators = [l(*args, **kwargs) for l in self._locatorClasses]


   def locateResponder(self, name):
       &quot;&quot;&quot;
       Locates a responder from all the component responders.
       &quot;&quot;&quot;
       for locator in self._locators:
           responder = locator.locateResponder(name)
           if responder is not None:
               return responder


   @classmethod
   def component(cls, locatorClass):
       &quot;&quot;&quot;
       Registers a component locator.
       &quot;&quot;&quot;
       cls._locatorClasses.append(locatorClass)
       return locatorClass



This has worked fine so far, but I've hit something so annoying to fix that I'm wondering if I'm not doing something very stupid and overlooking the obvious.

I'm trying to implement a command called &quot;Become&quot; that allows a staff member to work as if he was the user himself. The most obvious way (to me at least) to do that  to create the customer API (an IBoxReceiver/amp.BoxDispatcher subclass) for that customer (that'd normally be the Realm's job -- but since we're already logged in as an administrator, we don't go through Cred again), and hook up the current connection with that box receiver. Yay, code reuse!

Except, no. Because of the composed locator detailed above, the responding method has no reference to the box sender and box receiver.  It's it's own little standalone object, with barely any AMP-specific knowledge. Ordinarily elegant, now annoying.

The only reason it ever worked before is because the default AMP implementation basically just involves subclassing everything into one object (self is self.boxReceiver is self.boxSender)

I don't see an obvious way to get a reference to the boxReceiver/boxSender from the responder method using documented APIs. Does this just mean I have to leak a reference to them all the way down? Am I doing something stupid?


cheers
lvh



</PRE>


























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025743.html">[Twisted-Python] ANN: Twisted DBus 1.0
</A></li>
	<LI>Next message: <A HREF="025746.html">[Twisted-Python] Assigning AMP box senders &amp; receivers from the	responder
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25735">[ date ]</a>
              <a href="thread.html#25735">[ thread ]</a>
              <a href="subject.html#25735">[ subject ]</a>
              <a href="author.html#25735">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
