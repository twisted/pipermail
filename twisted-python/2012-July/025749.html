<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Assigning AMP box senders &amp; receivers from the	responder
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Assigning%20AMP%20box%20senders%20%26%20receivers%20from%20the%0A%09responder&In-Reply-To=A770A729-2B1B-40AC-9BAE-79C62E16A4CF%40twistedmatrix.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025838.html">
   <LINK REL="Next"  HREF="025752.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Assigning AMP box senders &amp; receivers from the	responder</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Assigning%20AMP%20box%20senders%20%26%20receivers%20from%20the%0A%09responder&In-Reply-To=A770A729-2B1B-40AC-9BAE-79C62E16A4CF%40twistedmatrix.com"
       TITLE="[Twisted-Python] Assigning AMP box senders &amp; receivers from the	responder">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Jul  4 04:50:53 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="025838.html">[Twisted-Python] bug or my code? (getPage + Twisted Webserver =	Exception)
</A></li>
        <LI>Next message: <A HREF="025752.html">[Twisted-Python] ANN: Twisted DBus 1.0 =&gt; WebSocket/WAMP Bridge
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25749">[ date ]</a>
              <a href="thread.html#25749">[ thread ]</a>
              <a href="subject.html#25749">[ subject ]</a>
              <a href="author.html#25749">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Le Jul 4, 2012 &#224; 12:39 AM, Laurens Van Houtven &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">_ at lvh.cc</A>&gt; a &#233;crit :

&gt;<i> On 03 Jul 2012, at 23:53, Glyph wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Jul 3, 2012, at 12:08 AM, Laurens Van Houtven &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">_ at lvh.cc</A>&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I'm trying to implement a command called &quot;Become&quot; that allows a staff member to work as if he was the user himself. The most obvious way (to me at least) to do that  to create the customer API (an IBoxReceiver/amp.BoxDispatcher subclass) for that customer (that'd normally be the Realm's job -- but since we're already logged in as an administrator, we don't go through Cred again), and hook up the current connection with that box receiver. Yay, code reuse!
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Why not just go through cred again?  (If you look for 'Preauthenticated' in the Divmod code base you'll find that this is actually something of a design pattern.)
</I>&gt;<i> 
</I>&gt;<i> I haven't seen that class, I'll take a look.
</I>&gt;<i> 
</I>&gt;<i> I didn't want to go through fred again because I don't see the benefit. I'm not trying to do any authentication (that part's already done), admins don't know the relevant password, so it'd pretty much be IRealm.requestAvatar. I don't understand why portal, credentials checkers... come into play.
</I>
Uh, hrm.  Well, hypothetically the checker might have some extra knowledge about how to map a publicly visible user name into an avatar ID; avatar IDs aren't necessarily user names and in fact in the future I hope we can make them a bit more opaque.

In many cases you're right though, it is the same.  Really, this should just be a basic facility of cred so that protocols which need to communicate between authenticated users (SMTP, SIP, IRC, XMPP) can look up the relevant avatars without even having to think about what the right way to do it is :).

&gt;&gt;&gt;<i> I don't see an obvious way to get a reference to the boxReceiver/boxSender from the responder method using documented APIs. Does this just mean I have to leak a reference to them all the way down? Am I doing something stupid?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> This is why the lowest level of argument parsing is fromString*Proto* rather than just fromString.  You can write an Argument that doesn't actually look at the box and gives you any necessary properties from the protocol (or from the transport).  It was originally written so you can ask for the host and peer addresses for P2P stuff, but this is another possible use.
</I>&gt;<i> 
</I>&gt;<i> So what would this custom Argument be? Right now I take the user id of the user I'm trying to be.
</I>
OK, I was definitely missing a couple of steps here.

The custom Argument, in fromBox, can get a value from the CommandLocator, which is the 'protocol' in this case, because it's the CommandLocator which does the (de-)serialization.  So it's not quite enough to just use that API.  The docs here could stand to be improved - they say that this argument is an L{AMP} which is obviously wrong in your case.

Basically you need to give your ComposedLocator knowledge of its BoxSender, which it needs to propagate to its component locators, so that you can ask for it later from the Argument.  Given that I can see you might not want to mess with __init__, you can make this a separate method.  (If you want to really continue in the spirit of AMP's component separation, make ComposedLocator be an IBoxReceiver as well - in fact, BoxDispatcher does what you want, so you can inherit from (or compose!) it; you automatically get a boxSender attribute, which will just so happen to point to the AMP instance whose boxReceiver you want to change.

So, now your ComposedLocator has a boxSender, you can propagate it that value to its components as a public attribute and they can just mess with it on 'self'.  But that's no fun, because now everybody in the whole system can just violate these layers whenever they want (although that is kind of what you want to do).

So, what I was originally suggesting is that you can make everyone who wants to mess with the transport explicitly declare their intentions with a special argument type (as I originally suggested) by propagating it as a private attribute which ComposedLocator's layer of the code knows about.  So, like this:

class ComposedLocator(object):
    def startReceivingBoxes(self, boxSender):
        for locator in self._locators:
            locator._secretlyYouKnowAboutAMP = boxSender
        return super(ComposedLocator, self).startReceivingBoxes(boxSender)
class ShowMeTheProtocol(Argument):
    def fromBox(self, name, strings, objects, componentLocator):
        objects[name] = componentLocator._secretlyYouKnowAboutAMP
class Become(Command):
    arguments = [('boxSender', ShowMeTheProtocol())]

Clear yet? :)

&gt;&gt;<i> Sorry I don't have time to be more expansive at the moment, I hope that's enough to get you un-stuck,
</I>&gt;<i> 
</I>&gt;<i> Afraid not :( That's okay, I have different tests to go fix :)
</I>
Don't we all.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20120704/a1e2542b/attachment-0001.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20120704/a1e2542b/attachment-0001.htm</A> 
</PRE>
























<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025838.html">[Twisted-Python] bug or my code? (getPage + Twisted Webserver =	Exception)
</A></li>
	<LI>Next message: <A HREF="025752.html">[Twisted-Python] ANN: Twisted DBus 1.0 =&gt; WebSocket/WAMP Bridge
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25749">[ date ]</a>
              <a href="thread.html#25749">[ thread ]</a>
              <a href="subject.html#25749">[ subject ]</a>
              <a href="author.html#25749">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
