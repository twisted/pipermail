<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] FW: Large (GB) File Upload
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20FW%3A%20Large%20%28GB%29%20File%20Upload&In-Reply-To=20120728185541.19554.1891416950.divmod.xquotient.8%40localhost6.localdomain6">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025938.html">
   <LINK REL="Next"  HREF="025939.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] FW: Large (GB) File Upload</H1>
    <B>Michael Schlenker</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20FW%3A%20Large%20%28GB%29%20File%20Upload&In-Reply-To=20120728185541.19554.1891416950.divmod.xquotient.8%40localhost6.localdomain6"
       TITLE="[Twisted-Python] FW: Large (GB) File Upload">msc at contact.de
       </A><BR>
    <I>Tue Jul 31 05:42:22 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="025938.html">[Twisted-Python] FW: Large (GB) File Upload
</A></li>
        <LI>Next message: <A HREF="025939.html">[Twisted-Python] ANN: pythonpackages.com beta
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25946">[ date ]</a>
              <a href="thread.html#25946">[ thread ]</a>
              <a href="subject.html#25946">[ subject ]</a>
              <a href="author.html#25946">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Am 28.07.2012 20:55, schrieb <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>:
&gt;<i> On 04:09 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bob.novas at shinkuro.com</A> wrote:
</I>&gt;&gt;<i> Hi - I'd like some guidance, please, on writing a TCPServer that can
</I>&gt;&gt;<i> efficiently receive and process (to a database) large files received 
</I>&gt;&gt;<i>from a
</I>&gt;&gt;<i> browser client form (multipart/form-data).  I'd like to be able to 
</I>&gt;&gt;<i> process
</I>&gt;&gt;<i> the command and headers without waiting for allContentReceived, if 
</I>&gt;&gt;<i> possible.
</I>&gt;&gt;<i> In other words, I'd like to actually handle the incoming stream rather 
</I>&gt;&gt;<i> than
</I>&gt;&gt;<i> buffer it to a file or a string and then handle the Request when all 
</I>&gt;&gt;<i> content
</I>&gt;&gt;<i> is received.  Note that the server is used only by a local browser by a
</I>&gt;&gt;<i> single user.  It is not used by a large user populace.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is this possible? Are there any examples? Any guidance would be 
</I>&gt;&gt;<i> appreciated.
</I>&gt;&gt;<i> This was the best  I could find -
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/pipermail/twisted-">http://twistedmatrix.com/pipermail/twisted-</A> 
</I>&gt;&gt;<i> python/2007-July/015738.html, but
</I>&gt;&gt;<i> it's pretty dated.
</I>&gt;<i> 
</I>&gt;<i> There are a few answers.
</I>&gt;<i> 
</I>&gt;<i> One is &lt;<A HREF="http://twistedmatrix.com/trac/ticket/288">http://twistedmatrix.com/trac/ticket/288</A>&gt;, an enhancement 
</I>&gt;<i> request for a nice, documented API for handling request bodies as they 
</I>&gt;<i> arrive.
</I>&gt;<i> 
</I>&gt;<i> Another is to override Request.handleContentChunk, which is called each 
</I>&gt;<i> time request body bytes are received (and decoded).
</I>&gt;<i> 
</I>&gt;<i> A third is to override Request.gotLength and initialize the `content` 
</I>&gt;<i> attribute differently somehow.  The default implementation of 
</I>&gt;<i> `handleContentChunk` just calls `self.content.write` with the content 
</I>&gt;<i> chunk.
</I>This works fine, just needs some care when errors happen.
We use this in production for some years now, replacing the self.content
with a python object that wraps a file object.

Looks basically like this:
class Request(server.Request):
  def gotLength(self, length):
    if self.channel._command == 'POST':
       try:
	  # plug in our own writer
          self.content = fileStore.getWriter()
          self.total_length = length
       except Exception, e:
          reason = &quot;Exception in fileStore.getWriter&quot;
          log.err(e, reason)
          # plug in an error writer class
          self.content = ErrorWriter(http.INTERNAL_SERVER_ERROR, reason)

class ErrorWriter(object):
    &quot;&quot;&quot; Fake writer object that takes the request body in case of error
        in PUT or POST, and throws it away. Done in this way, because
        there is no way to signal the client it should stop sending data
        (expect: 100-continue header processing missing in Twisted, see
        <A HREF="http://twistedmatrix.com/trac/wiki/TwistedWebClient">http://twistedmatrix.com/trac/wiki/TwistedWebClient</A>)
    &quot;&quot;&quot;
    def __init__(self, code, reason):
        self.code = code
        self.reason = reason

    def write(self, data):
        pass

    def read(self):
        return ''

    def seek(self, offset, whence=0):
        pass

    def close(self):
        raise Exception(self.reason, self.code)

Michael

-- 
Michael Schlenker
Software Architect

CONTACT Software GmbH           Tel.:   +49 (421) 20153-80
Wiener Stra&#223;e 1-3               Fax:    +49 (421) 20153-41
28359 Bremen
<A HREF="http://www.contact.de/">http://www.contact.de/</A>          E-Mail: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">msc at contact.de</A>

Sitz der Gesellschaft: Bremen
Gesch&#228;ftsf&#252;hrer: Karl Heinz Zachries, Ralf Holtgrefe
Eingetragen im Handelsregister des Amtsgerichts Bremen unter HRB 13215

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025938.html">[Twisted-Python] FW: Large (GB) File Upload
</A></li>
	<LI>Next message: <A HREF="025939.html">[Twisted-Python] ANN: pythonpackages.com beta
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25946">[ date ]</a>
              <a href="thread.html#25946">[ thread ]</a>
              <a href="subject.html#25946">[ subject ]</a>
              <a href="author.html#25946">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
