<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] treq // Agent and Content-Length
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20treq%20//%20Agent%20and%20Content-Length&In-Reply-To=%3C7A4131AD-1698-4494-9730-0AE9A06CE2B1%40stufft.io%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] treq // Agent and Content-Length</H1>
    <B>Donald Stufft</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20treq%20//%20Agent%20and%20Content-Length&In-Reply-To=%3C7A4131AD-1698-4494-9730-0AE9A06CE2B1%40stufft.io%3E"
       TITLE="[Twisted-Python] treq // Agent and Content-Length">donald at stufft.io
       </A><BR>
    <I>Mon Mar  3 17:44:06 MST 2014</I>
    <P><UL>
        
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60567">[ date ]</a>
              <a href="thread.html#60567">[ thread ]</a>
              <a href="subject.html#60567">[ subject ]</a>
              <a href="author.html#60567">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Iâ€™m making a small proxy server in Twisted which is supposed to essentially
&quot;mask&quot; the original destination of an URL. Specifically it does the following:

1. Receives an HTTP request on /&lt;hmac&gt;/&lt;url encoded url&gt;
2. Verifies that the hmac in the URL matches the url decoded url
3. Makes an HTTP request to the url decoded url
4. Verify the response
   4a. Verify that the *on the wire* size is not greater than a set number of
       bytes, prior to downloading the body.
   4b. Verify that the content-type is acceptable prior to downloading the
       body.
5. Download the body of the response without modifying it (No Gzip decode)
6. Return the unmodified downloaded response as the resposne to the HTTP
   request in 1, as well as copying over several Response Headers.

This should be able to pass through ``Accept-Encoding`` from the request in
#1 to the request made in #3.

I've had a problem getting 4a to happen, no matter what I've tried if the
Content-Encoding is set to gzip it appears that the length of the response
is unknown. Additionally the &quot;connection headers&quot; are split out from the normal
headers, so I cannot seem to locate the original ``Content-Length`` header to
simply check that.

I got frustrated and implemented it using requests and that has worked OK. It
however uses deferToThread and I would like to get back to using the built
in tooling.

So my question is, how can I make Agent/treq do this?

The requests version of the code is here: <A HREF="https://gist.github.com/dstufft/7c8aac898de0ad359675">https://gist.github.com/dstufft/7c8aac898de0ad359675</A>
The treq versions of the code is here: <A HREF="https://gist.github.com/dstufft/0dffb12201d235f35bc7">https://gist.github.com/dstufft/0dffb12201d235f35bc7</A>

-----------------
Donald Stufft
PGP: 0x6E3CBCE93372DCFA // 7C6B 7C5D 5E2B 6356 A926 F04F 6E3C BCE9 3372 DCFA

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 801 bytes
Desc: Message signed with OpenPGP using GPGMail
URL: &lt;/pipermail/twisted-python/attachments/20140303/ec6a2893/attachment.sig&gt;
</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60567">[ date ]</a>
              <a href="thread.html#60567">[ thread ]</a>
              <a href="subject.html#60567">[ subject ]</a>
              <a href="author.html#60567">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
