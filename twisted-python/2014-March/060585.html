<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] improving foolscap's use of Twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20improving%20foolscap%27s%20use%20of%20Twisted&In-Reply-To=%3C20140308125258.6218.939246145.divmod.xquotient.266%40top%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="028123.html">
   <LINK REL="Next"  HREF="060586.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] improving foolscap's use of Twisted</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20improving%20foolscap%27s%20use%20of%20Twisted&In-Reply-To=%3C20140308125258.6218.939246145.divmod.xquotient.266%40top%3E"
       TITLE="[Twisted-Python] improving foolscap's use of Twisted">exarkun at twistedmatrix.com
       </A><BR>
    <I>Sat Mar  8 05:52:58 MST 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="028123.html">[Twisted-Python] improving foolscap's use of Twisted
</A></li>
        <LI>Next message (by thread): <A HREF="060586.html">[Twisted-Python] improving foolscap's use of Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60585">[ date ]</a>
              <a href="thread.html#60585">[ thread ]</a>
              <a href="subject.html#60585">[ subject ]</a>
              <a href="author.html#60585">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10:02 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dstainton415 at gmail.com</A> wrote:
&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Greetings,
</I>&gt;<i>
</I>&gt;<i>My goal is to get Brian Warner's foolscap library ported to Twisted
</I>&gt;<i>endpoints instead of the older Twisted api interfaces it currently
</I>&gt;<i>uses (ClientFactory and IConnector).
</I>&gt;<i>
</I>&gt;<i>This effort has been documented in foolscap trac ticket #203:
</I>&gt;<i><A HREF="http://foolscap.lothar.com/trac/ticket/203">http://foolscap.lothar.com/trac/ticket/203</A>
</I>&gt;<i>
</I>&gt;<i>and also part of Tahoe-LAFS trac ticket #517 - make tahoe Tor- and I2P- 
</I>&gt;<i>friendly:
</I>&gt;<i><A HREF="https://tahoe-lafs.org/trac/tahoe-lafs/ticket/517">https://tahoe-lafs.org/trac/tahoe-lafs/ticket/517</A>
</I>&gt;<i>
</I>&gt;<i>My question is this:
</I>&gt;<i>
</I>&gt;<i>Since Foolscap's TubConnectorClientFactory does rely
</I>&gt;<i>on clientConnectionFailed... What is the equivalent to this for the new
</I>&gt;<i>interfaces?
</I>&gt;<i>
</I>&gt;<i>I have tried to braindump all my foolscap twisted endpoint thoughts to
</I>&gt;<i>foolscap trac ticket #203 :
</I>&gt;<i><A HREF="http://foolscap.lothar.com/trac/ticket/203#comment:30">http://foolscap.lothar.com/trac/ticket/203#comment:30</A>
</I>&gt;<i><A HREF="http://foolscap.lothar.com/trac/ticket/203#comment:31">http://foolscap.lothar.com/trac/ticket/203#comment:31</A>
</I>&gt;<i>
</I>&gt;<i>If we look at line 1223 of
</I>&gt;<i><A HREF="https://github.com/warner/foolscap/blob/master/foolscap/negotiate.py">https://github.com/warner/foolscap/blob/master/foolscap/negotiate.py</A>
</I>&gt;<i>(at 0395476c7cb154f925d67abf6858a8200126352b)
</I>&gt;<i>
</I>&gt;<i>we see that there's this TubConnectorClientFactory:
</I>&gt;<i>class TubConnectorClientFactory(protocol.ClientFactory, object):
</I>&gt;<i>
</I>&gt;<i>and later at line 1384 it is used with connectTCP like this:
</I>&gt;<i>            f = TubConnectorClientFactory(self, host, lp)
</I>&gt;<i>            c = reactor.connectTCP(host, port, f)
</I>
It looks like TubConnector is the primary intended user of 
TubConnectorClientFactory.  In this case, you can simply move the logic 
from TubConnector.clientConnectionFailed to an errback on the Deferred 
returned by IStreamClientEndpoint.connect.  Or you can leave it where it 
is an just make clientConnectionFailed be that errback.

For example:

    f = TubConnectorClientFactory(self, host, lp)
    d = endpoint.connect(f)
    d.addErrback(self.clientConnectionFailed)

(removing the connector argument from clientConnectionFailed, of 
course).

You may want to apply a similar transformation to the *success* case 
here as well.  That is, move the code that initiates protocol actions on 
the connection to a callback on this Deferred instead of automatically 
starting those actions in buildProtocol (this gives greater flexibility 
in how the protocol is used - if you want to change the details of 
initialization you can do so by using a different callback on the 
endpoint's Deferred instead of having to mess around with the factory or 
the protocol to disable this stuff).

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="028123.html">[Twisted-Python] improving foolscap's use of Twisted
</A></li>
	<LI>Next message (by thread): <A HREF="060586.html">[Twisted-Python] improving foolscap's use of Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#60585">[ date ]</a>
              <a href="thread.html#60585">[ thread ]</a>
              <a href="subject.html#60585">[ subject ]</a>
              <a href="author.html#60585">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
