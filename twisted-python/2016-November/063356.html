<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Twisted 16.6.0rc1 Release Candidate	Announcement
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%2016.6.0rc1%20Release%20Candidate%0A%09Announcement&In-Reply-To=%3C3A3EF6E5-3B70-4BCB-884E-4B6B5D44796D%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="063355.html">
   <LINK REL="Next"  HREF="063357.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Twisted 16.6.0rc1 Release Candidate	Announcement</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Twisted%2016.6.0rc1%20Release%20Candidate%0A%09Announcement&In-Reply-To=%3C3A3EF6E5-3B70-4BCB-884E-4B6B5D44796D%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Twisted 16.6.0rc1 Release Candidate	Announcement">glyph at twistedmatrix.com
       </A><BR>
    <I>Tue Nov 22 19:03:07 MST 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="063355.html">[Twisted-Python] Twisted 16.6.0rc1 Release Candidate	Announcement
</A></li>
        <LI>Next message (by thread): <A HREF="063357.html">[Twisted-Python] Twisted 16.6.0rc1 Release Candidate	Announcement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63356">[ date ]</a>
              <a href="thread.html#63356">[ thread ]</a>
              <a href="subject.html#63356">[ subject ]</a>
              <a href="author.html#63356">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Nov 22, 2016, at 20:27, Mark Williams &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">markrwilliams at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On Tue, Nov 22, 2016 at 06:31:45PM -0500, Glyph Lefkowitz wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> OK, this whole time I thought we were talking about a sensible application of text_type to the API, perhaps with some leniency for bytes-ish-ness on python 2.  I haven't reviewed the PR, I was just responding to the concerns as raised on the list.
</I>&gt;<i> 
</I>&gt;<i> Sorry - I didn't mean to steer this towards API bike shedding.
</I>&gt;<i> 
</I>&gt;&gt;<i> If it's just randomly encoding on one version and not the other, and correct usage of the API depends on *users* doing 'if PY2:' in their own code, then perhaps Mark's concern is indeed well-founded and we should roll it back before 16.6.
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Tristan's exactly right.  Furthermore, if we decide to make IRCClient
</I>&gt;<i> call its various command methods with unicode strings on Python 2,
</I>&gt;<i> we'll be breaking backwards compatibility.  This is what I meant when
</I>&gt;<i> I wrote:
</I>&gt;<i> 
</I>&gt;<i> On Nov 20, 2016, at 19:35, Mark Williams &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">markrwilliams at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Yes.  Here's the lede: IRCClient should deal in bytes and we should
</I>&gt;&gt;<i> introduce a ProtocolWrapper-like thing that encodes and decodes
</I>&gt;&gt;<i> command prefixes and parameters.  It should implement an interface,
</I>&gt;&gt;<i> and we can start with an implementation that only knows about UTF-8.
</I>&gt;&gt;<i> The obvious advantage of this is that you can more easily write
</I>&gt;&gt;<i> IRCClients that work on both Python 2 and 3.
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> But it totally wasn't clear - sorry!
</I>&gt;<i> 
</I>&gt;<i> Of course, I also want IRC client implementation that lets me get at
</I>&gt;<i> bytes, but that's a discussion I'll move to a new thread.
</I>&gt;<i> 
</I>&gt;<i> Given the inconsistency between Python 2 and Python 3, do we proceed
</I>&gt;<i> with the revert?
</I>
Okay.  So.

The rule for reverts like this is: if you do something today, which is correct usage of the API and produces an observably correct result, will that be broken in the future if we fix it?  If so, then we need to revert because the interface as released is unsupportable.

As it stands, we have a matrix of 4 behaviors:


bytes
text(ascii)
text(nonascii)
py2
works
works
UnicodeDecodeError
py3
garbage
works
works

This... is actually... fine, surprisingly.

The right thing to do is to write code that passes text all the time.  If you do that right now, it'll work on py3 and raise an exception on py2, unless it happens to be ASCII, in which case it'll work.

If you write code that passes bytes on py3, it'll just be garbage.  But, we want to deprecate that anyway, and you can't get correct, usable behavior out of it, no matter what workarounds you stuff in; so it's a bug, and can be fixed like any bug.

Similarly if you pass non-ascii text on py3, you'll get a UnicodeDecodeError.

This is not a good situation, but it's totally fixable without breaking the interface.  We just fix the py2 version to accept text_type as well, and if Mark sneaks in a patch that makes py3 do the right thing with bytes, well, I don't know that I can stop him.

More importantly, it would probably be a smaller change to fix the methods (we could even fix them one at a time; say, action, join, etc) than to un-port and re-port the whole thing.

So: yes, it's broken, and in a worse way than I thought.  To get it to the point where we can actually implement logic consistently between two versions, we need to add a flag to IRCClient's constructor which is default-false on py2 and default-true on py3 which says &quot;give me text&quot;, so that callbacks like privmsg and joined can start receiving text_type on py2 as well as py3; right now it has to receive str because they've previously received str.  But that's a separate issue.

I am open to the idea that I have evaluated this incorrectly though, since this has been possibly the most confusing change since <A HREF="https://twistedmatrix.com/trac/ticket/411">https://twistedmatrix.com/trac/ticket/411</A> &lt;<A HREF="https://twistedmatrix.com/trac/ticket/411">https://twistedmatrix.com/trac/ticket/411</A>&gt;.  But as of right now I still think we shouldn't revert.

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20161122/a3233e3b/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="063355.html">[Twisted-Python] Twisted 16.6.0rc1 Release Candidate	Announcement
</A></li>
	<LI>Next message (by thread): <A HREF="063357.html">[Twisted-Python] Twisted 16.6.0rc1 Release Candidate	Announcement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63356">[ date ]</a>
              <a href="thread.html#63356">[ thread ]</a>
              <a href="subject.html#63356">[ subject ]</a>
              <a href="author.html#63356">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
