<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] reactor.stop() won't, threads and Queue to blame?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20reactor.stop%28%29%20won%27t%2C%20threads%20and%20Queue%20to%20blame%3F&In-Reply-To=%3C20041025090718.GG5033%40frobozz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="041409.html">
   <LINK REL="Next"  HREF="041412.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] reactor.stop() won't, threads and Queue to blame?</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20reactor.stop%28%29%20won%27t%2C%20threads%20and%20Queue%20to%20blame%3F&In-Reply-To=%3C20041025090718.GG5033%40frobozz%3E"
       TITLE="[Twisted-Python] reactor.stop() won't, threads and Queue to blame?">andrew-twisted at puzzling.org
       </A><BR>
    <I>Mon Oct 25 03:07:18 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="041409.html">[Twisted-Python] reactor.stop() won't, threads and Queue to blame?
</A></li>
        <LI>Next message (by thread): <A HREF="041412.html">[Twisted-Python] reactor.stop() won't, threads and Queue to blame?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41411">[ date ]</a>
              <a href="thread.html#41411">[ thread ]</a>
              <a href="subject.html#41411">[ subject ]</a>
              <a href="author.html#41411">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, Oct 24, 2004 at 10:59:09PM -0400, Clark C. Evans wrote:
[...]
&gt;<i> 
</I>&gt;<i> However, if you want to keep the Queue in the secondary thread,
</I>&gt;<i> you have one problem that is obvious to me:
</I>&gt;<i> 
</I>[...]
&gt;<i> |             print &quot;calling %s(%s,%s)&quot;%(meth.__name__,str(a),str(k))
</I>&gt;<i> |             d.callback(meth(*a,**k))
</I>&gt;<i> |             print &quot;callback done&quot;
</I>[...]
&gt;<i> 
</I>&gt;<i> You seem to be doing d.callback in the secondary thread, rather than
</I>&gt;<i> in the primary thread.  This could be causing some of the problems
</I>&gt;<i> you are experiencing.   It's not customary to use deferreds in any
</I>&gt;<i> other but the main thread.
</I>
Yep, that's the problem here.  Change this:
    d.callback(meth(*a,**k))
to this:
    reactor.callFromThread(d.callback, meth(*a, **k))

(Or perhaps less confusingly:
    result = meth(*a, **kw)
    reactor.callFromThread(d.callback, result)
)

&gt;<i> &gt;From a framework perspective, perhaps callback() should raise an 
</I>&gt;<i> error if it is called from anything other than the main thread?
</I>&gt;<i> Or perhaps even I'm not getting it.
</I>
There's no reason why Deferreds wouldn't work in another thread, if that's
what you want.  It's just that generally it's not what you want...
Deferreds are used in Twisted to deal with asynchronous operations; but in
non-event loop threads, you'd usually just block.  If for some reason there
were two event-loop threads in the one process, then Deferreds might be
useful in both.

Nothing about Deferreds is at all dependent on the reactor, except for the
ill-conceived setTimeout functionality.  If you want to run a callback chain
in another thread, then Twisted shouldn't stop you (but I would expect you
to very clearly comment your code to explain why, as it would be very
unusual).

This is just a long-winded way of saying that Deferred's implementation
should be completely thread ignorant, even though in practice they're only
used from the main thread.

The real error here wasn't using Deferred.callback in another thread, it was
using reactor.stop in that thread.

-Andrew.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="041409.html">[Twisted-Python] reactor.stop() won't, threads and Queue to blame?
</A></li>
	<LI>Next message (by thread): <A HREF="041412.html">[Twisted-Python] reactor.stop() won't, threads and Queue to blame?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41411">[ date ]</a>
              <a href="thread.html#41411">[ thread ]</a>
              <a href="subject.html#41411">[ subject ]</a>
              <a href="author.html#41411">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
