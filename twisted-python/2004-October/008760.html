<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Proposed change to buffering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Proposed%20change%20to%20buffering&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008757.html">
   <LINK REL="Next"  HREF="008765.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Proposed change to buffering</H1>
    <B>Itamar Shtull-Trauring</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Proposed%20change%20to%20buffering&In-Reply-To="
       TITLE="[Twisted-Python] Proposed change to buffering">itamar at itamarst.org
       </A><BR>
    <I>Mon Oct  4 11:36:42 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008757.html">[Twisted-Python] Weekly Bug Summary
</A></li>
        <LI>Next message: <A HREF="008765.html">[Twisted-Python] assignKeyAttr in row object
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8760">[ date ]</a>
              <a href="thread.html#8760">[ thread ]</a>
              <a href="subject.html#8760">[ subject ]</a>
              <a href="author.html#8760">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Now that we don't do write-at-once, lists are easier to use. 

Benefits: Allows protocols with many small writes to not have to do
their own buffering (e.g. http, imap4 as currently coded, PB, IRC,
telnet, etc. etc.)

Problems: Bit more overhead for large writes.

There's also a bit of code change in tcp.py for the SSL code.

Index: abstract.py
===================================================================
--- abstract.py	(revision 11908)
+++ abstract.py	(working copy)
@@ -43,7 +43,9 @@
         if not reactor:
             from twisted.internet import reactor
         self.reactor = reactor
-
+        self._tempDataBuffer = [] # will be added to dataBuffer in doWrite
+        self._tempDataLen = 0
+    
     def connectionLost(self, reason):
         &quot;&quot;&quot;The connection was lost.
 
@@ -81,6 +83,9 @@
         there; a result of 0 implies no write was done, and a result of None
         indicates that a write was done.
         &quot;&quot;&quot;
+        self.dataBuffer += &quot;&quot;.join(self._tempDataBuffer)
+        self._tempDataBuffer = []
+        self._tempDataLen = 0
         # Send as much data as you can.
         if self.offset:
             l = self.writeSomeData(buffer(self.dataBuffer, self.offset))
@@ -131,15 +136,16 @@
         if not self.connected:
             return
         if data:
-            self.dataBuffer = self.dataBuffer + data
+            self._tempDataBuffer.append(data)
+            self._tempDataLen += len(data)
             if self.producer is not None:
-                if len(self.dataBuffer) &gt; self.bufferSize:
+                if len(self.dataBuffer) + self._tempDataLen &gt; self.bufferSize:
                     self.producerPaused = 1
                     self.producer.pauseProducing()
             self.startWriting()
 
     def writeSequence(self, iovec):
-        self.write(&quot;&quot;.join(iovec))
+        self._tempDataBuffer.extend(iovec)
 
     def loseConnection(self):
         &quot;&quot;&quot;Close the connection at the next available opportunity.




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008757.html">[Twisted-Python] Weekly Bug Summary
</A></li>
	<LI>Next message: <A HREF="008765.html">[Twisted-Python] assignKeyAttr in row object
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8760">[ date ]</a>
              <a href="thread.html#8760">[ thread ]</a>
              <a href="subject.html#8760">[ subject ]</a>
              <a href="author.html#8760">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
