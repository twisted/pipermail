<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] reactor.stop() won't, threads and Queue to blame?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20reactor.stop%28%29%20won%27t%2C%20threads%20and%20Queue%20to%20blame%3F&In-Reply-To=ir44qkj3a38.fsf%40minos.phy.bnl.gov">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008900.html">
   <LINK REL="Next"  HREF="008903.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] reactor.stop() won't, threads and Queue to blame?</H1>
    <B>Clark C. Evans</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20reactor.stop%28%29%20won%27t%2C%20threads%20and%20Queue%20to%20blame%3F&In-Reply-To=ir44qkj3a38.fsf%40minos.phy.bnl.gov"
       TITLE="[Twisted-Python] reactor.stop() won't, threads and Queue to blame?">cce at clarkevans.com
       </A><BR>
    <I>Sun Oct 24 22:59:09 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008900.html">[Twisted-Python] reactor.stop() won't, threads and Queue to blame?
</A></li>
        <LI>Next message: <A HREF="008903.html">[Twisted-Python] reactor.stop() won't, threads and Queue to blame?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8901">[ date ]</a>
              <a href="thread.html#8901">[ thread ]</a>
              <a href="subject.html#8901">[ subject ]</a>
              <a href="author.html#8901">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Brett,

For starters, I'd keep the 'Queue' in the main thread, and
use callInThread to dispatch the function /w arguments.   Use
a d.callBoth (aka finally) to pop the next item from the queue
and then do a callInThread for it.

However, if you want to keep the Queue in the secondary thread,
you have one problem that is obvious to me:

On Sun, Oct 24, 2004 at 08:39:07PM -0400, Brett Viren wrote:
|<i> class CommandQueue:
</I>...
|<i>     def drain(self):
</I>|<i>         'Drain the command queue until CommandQueue.stop is True'
</I>|<i>         while not self.stop:
</I>|<i>             try:
</I>|<i>                 d,meth,a,k = self.queue.get(True,1)
</I>|<i>             except Empty:
</I>|<i>                 print &quot;  queue empty&quot;
</I>|<i>                 continue
</I>|<i>             print &quot;calling %s(%s,%s)&quot;%(meth.__name__,str(a),str(k))
</I>|<i>             d.callback(meth(*a,**k))
</I>|<i>             print &quot;callback done&quot;
</I>|<i>         print &quot;drain closing&quot;
</I>|<i>         return 0
</I>|<i> 
</I>|<i> def test1():
</I>|<i>     import time
</I>|<i>     cq = CommandQueue()
</I>|<i>     reactor.callInThread(cq.drain)
</I>|<i>
</I>
You seem to be doing d.callback in the secondary thread, rather than
in the primary thread.  This could be causing some of the problems
you are experiencing.   It's not customary to use deferreds in any
other but the main thread.

&gt;<i>From a framework perspective, perhaps callback() should raise an 
</I>error if it is called from anything other than the main thread?
Or perhaps even I'm not getting it.

Cheers!

Clark


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008900.html">[Twisted-Python] reactor.stop() won't, threads and Queue to blame?
</A></li>
	<LI>Next message: <A HREF="008903.html">[Twisted-Python] reactor.stop() won't, threads and Queue to blame?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8901">[ date ]</a>
              <a href="thread.html#8901">[ thread ]</a>
              <a href="subject.html#8901">[ subject ]</a>
              <a href="author.html#8901">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
