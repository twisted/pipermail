<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Sending other things than strings in UDP packets
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Sending%20other%20things%20than%20strings%20in%20UDP%20packets&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008776.html">
   <LINK REL="Next"  HREF="008778.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Sending other things than strings in UDP packets</H1>
    <B>Paul Campbell</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Sending%20other%20things%20than%20strings%20in%20UDP%20packets&In-Reply-To="
       TITLE="[Twisted-Python] Sending other things than strings in UDP packets">paul at ref.nmedia.net
       </A><BR>
    <I>Wed Oct  6 17:38:55 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008776.html">[Twisted-Python] epoll and other questions
</A></li>
        <LI>Next message: <A HREF="008778.html">[Twisted-Python] Sending other things than strings in UDP packets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8777">[ date ]</a>
              <a href="thread.html#8777">[ thread ]</a>
              <a href="subject.html#8777">[ subject ]</a>
              <a href="author.html#8777">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sending anything via any protocol is fairly easy with python in general.

There are two ways to do it depending on your particular goals.

The &quot;python way&quot; is as follows:

message = pickle.dumps(my structures)
my structures = pickle.loads(message)

Read the documentation on the pickle module for more information. And be
forewarned: pickle will dump/load ANYTHING. For safety reasons, there's also
a &quot;safe_pickle&quot; variant floating around.

The underlying banana protocol is really just another pickle module for use
inside PB. I haven't tried using it separately from PB though.

The other &quot;unpythonese&quot; way of doing it is using the struct module:

message = struct.pack(&quot;format&quot;, param1, param2, param3)
param1, param2, param3 = struct.unpack(&quot;format&quot;, message)

The advantage of the struct library is that you have complete and total control
over every byte so you can deal with non-python data.

In reality, I personally use both. pickle is great for providing a totally
unstructured interface to higher level protocols that have no desire in
looking directly at low level packet formats. struct does just the opposite.

For instance, here's a very simple UDP RPC module with no error checking
whatsoever, no safety, no handling of very long packets (or checking for
that case), no timeouts, or anything but a very basic rudimentary idea of
how to assemble an RPC protocol.

class UDPRPC(DatagramProtocol):
    REQUEST = 0
    RESPONSE = 1

    def start(self):
        &quot;&quot;&quot;Create a dictionary of pending RPC's&quot;&quot;&quot;
        self.pending = dict()

    def call(self, address, remote_class, remote_method, *remote_args, **remote_kargs):
        &quot;&quot;&quot;The actual RPC call local (stub) interface. Note that
           we can even get creative by overloading __calls__ and
           similar interfaces to make it look 100% like a real class.&quot;&quot;&quot;
	d = defer.Deferred() # Create a deferred return.
        # The following is an index to look up the RPC response later
        nonce = random.randomint(0, 2^32-1)
	index = struct.pack(&quot;!I!I!H&quot;, nonce, address[0], address[1])
        self.pending[index] = d # Store the deferred for the response to follow
        self.sendMessage(self.REQUEST, address,
            (remote_class, remote_method, remote_args, remote_kargs))
        return d
           
    def sendMessage(self, type, address, nonce, data):
        &quot;Do the conversion to a packet and send it.&quot;
        packet = chr(type)+struct.pack(&quot;!I&quot;, nonce)+
            pickle.dumps(data)
	transport.write(packet)
	return d

    def datagramReceived(self, packet, address):
        &quot;&quot;&quot;Handle incoming packets.&quot;&quot;&quot;
        type = ord(packet[0])
        nonce = struct.unpack(&quot;!I&quot;, packet[1:4])
        message = pickle.loads(packet[5:])
        if type == REQUEST: # Handling a remote call
            remote_class, remote_method, remote_args, remote_kargs = message
            result = remote_class.remote_method(*remote_args, **remote_kargs)
            self.sendMessage(self.RESPONSE, address, nonce, result)
        else: # Assume that this is the response, so return the deferred
            index = struct.pack(&quot;!I!I!H&quot;, nonce, address[0], address[1])
            caller = self.pending[index]
            del self.pending[index]
            caller.Callback(message)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008776.html">[Twisted-Python] epoll and other questions
</A></li>
	<LI>Next message: <A HREF="008778.html">[Twisted-Python] Sending other things than strings in UDP packets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8777">[ date ]</a>
              <a href="thread.html#8777">[ thread ]</a>
              <a href="subject.html#8777">[ subject ]</a>
              <a href="author.html#8777">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
