<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] TaskStopped error,	unsure of the cause and solution
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20TaskStopped%20error%2C%0A%09unsure%20of%20the%20cause%20and%20solution&In-Reply-To=%3CCACgdh2gvAmy3uWOWH9R94Bd4s2N2opBe1%2Bwnk33EJWshL4aXYA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="059006.html">
   <LINK REL="Next"  HREF="059018.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] TaskStopped error,	unsure of the cause and solution</H1>
    <B>Paul Wiseman</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20TaskStopped%20error%2C%0A%09unsure%20of%20the%20cause%20and%20solution&In-Reply-To=%3CCACgdh2gvAmy3uWOWH9R94Bd4s2N2opBe1%2Bwnk33EJWshL4aXYA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] TaskStopped error,	unsure of the cause and solution">poalman at gmail.com
       </A><BR>
    <I>Tue Feb 12 12:30:57 MST 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="059006.html">[Twisted-Python] TaskStopped error, unsure of the cause and solution
</A></li>
        <LI>Next message (by thread): <A HREF="059018.html">[Twisted-Python] TaskStopped error,	unsure of the cause and solution
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59017">[ date ]</a>
              <a href="thread.html#59017">[ thread ]</a>
              <a href="subject.html#59017">[ subject ]</a>
              <a href="author.html#59017">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8 February 2013 19:03,  &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
&gt;<i> On 03:12 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">poalman at gmail.com</A> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I've still not been able to reproduce this on demand.. the least
</I>&gt;&gt;<i>amount of request I've seen before getting the error is 6500 :/
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I've also seen this stack trace which I didn't notice before
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>2013-02-08 10:07:28+0000 [HTTP11ClientProtocol,client] Unhandled Error
</I>&gt;&gt;<i>        Traceback (most recent call last):
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/application/app.py&quot;,
</I>&gt;&gt;<i>line 323, in runReactorWithLogging
</I>&gt;&gt;<i>            reactor.run()
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/base.py&quot;,
</I>&gt;&gt;<i>line 1169, in run
</I>&gt;&gt;<i>            self.mainLoop()
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/base.py&quot;,
</I>&gt;&gt;<i>line 1181, in mainLoop
</I>&gt;&gt;<i>            self.doIteration(t)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/epollreactor.py&quot;,
</I>&gt;&gt;<i>line 379, in doPoll
</I>&gt;&gt;<i>            log.callWithLogger(selectable, _drdw, selectable, fd, event)
</I>&gt;&gt;<i>        --- &lt;exception caught here&gt; ---
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/python/log.py&quot;,
</I>&gt;&gt;<i>line 84, in callWithLogger
</I>&gt;&gt;<i>            return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/python/log.py&quot;,
</I>&gt;&gt;<i>line 69, in callWithContext
</I>&gt;&gt;<i>            return context.call({ILogContext: newCtx}, func, *args,
</I>&gt;&gt;<i>**kw)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/python/context.py&quot;,
</I>&gt;&gt;<i>line 118, in callWithContext
</I>&gt;&gt;<i>            return self.currentContext().callWithContext(ctx, func,
</I>&gt;&gt;<i>*args, **kw)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/python/context.py&quot;,
</I>&gt;&gt;<i>line 81, in callWithContext
</I>&gt;&gt;<i>            return func(*args,**kw)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/posixbase.py&quot;,
</I>&gt;&gt;<i>line 639, in _doReadOrWrite
</I>&gt;&gt;<i>            self._disconnectSelectable(selectable, why, inRead)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/posixbase.py&quot;,
</I>&gt;&gt;<i>line 258, in _disconnectSelectable
</I>&gt;&gt;<i>            selectable.readConnectionLost(f)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/tcp.py&quot;,
</I>&gt;&gt;<i>line 267, in readConnectionLost
</I>&gt;&gt;<i>            self.connectionLost(reason)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/tcp.py&quot;,
</I>&gt;&gt;<i>line 473, in connectionLost
</I>&gt;&gt;<i>            self._commonConnection.connectionLost(self, reason)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/tcp.py&quot;,
</I>&gt;&gt;<i>line 281, in connectionLost
</I>&gt;&gt;<i>abstract.FileDescriptor.connectionLost(self, reason)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/abstract.py&quot;,
</I>&gt;&gt;<i>line 182, in connectionLost            self.producer.stopProducing()
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/web/client.py&quot;,
</I>&gt;&gt;<i>line 760, in stopProducing            self._task.stop()
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/task.py&quot;,
</I>&gt;&gt;<i>line 460, in stop            self._completeWith(TaskStopped(),
</I>&gt;&gt;<i>Failure(TaskStopped()))
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/task.py&quot;,
</I>&gt;&gt;<i>line 439, in _completeWith
</I>&gt;&gt;<i>self._cooperator._removeTask(self)
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/task.py&quot;,
</I>&gt;&gt;<i>line 578, in _removeTask            self._delayedCall.cancel()
</I>&gt;&gt;<i>          File &quot;/usr/local/lib/python2.7/dist-
</I>&gt;&gt;<i>packages/Twisted-12.2.0-py2.7-linux-
</I>&gt;&gt;<i>x86_64.egg/twisted/internet/base.py&quot;,
</I>&gt;&gt;<i>line 89, in cancel
</I>&gt;&gt;<i>            raise error.AlreadyCalled
</I>&gt;&gt;<i>        twisted.internet.error.AlreadyCalled: Tried to cancel an
</I>&gt;&gt;<i>already-called event.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I'll keep trying to work out the issue, any suggestions on what I
</I>&gt;&gt;<i>might try to reproduce it or guesses at causes?
</I>&gt;<i>
</I>&gt;<i> Since it seems to be related to handling of lost connections, you may be
</I>&gt;<i> able to reproduce it more easily if you issue your requests to an HTTP
</I>&gt;<i> server which drops connections more often.  Presumably the production
</I>&gt;<i> service you're issuing requests too tries pretty hard to properly serve
</I>&gt;<i> responses to every request.  If you point `Agent` at a worse HTTP server
</I>&gt;<i> (eg, one you write using twisted.web and implement to close connections
</I>&gt;<i> prematurely at various points during the response) this may produce the
</I>&gt;<i> issue more quickly.
</I>&gt;<i>
</I>&gt;<i> You could also try hooking `Agent` up to one of the in-memory
</I>&gt;<i> reactors/transports.  The advantage of this is that it will be much
</I>&gt;<i> easier to &quot;close&quot; the connection at a specific point
</I>&gt;<i> (deterministically).  The disadvantage is that the in-memory
</I>&gt;<i> reactor/transport may not exactly replicate the real reactor/transport
</I>&gt;<i> behavior and so fail to reproduce the issue entirely.
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>
Hey, I'm more and more sure it's the PUT request, and I think you're
right it is likely to do with the server that I'm putting to (Google
Cloud Storage) doing something odd occasionally.

I'm trying to reproduce it with a small twisted client and server,
using a PUT request to send to the server but I can't seem to close
the connection uncleanly. How would you recommend I do that? I've
tried adding request.finish() on a callLater but that seems to finish
the connection in a clean way. How can I close the connection in the
way you suggest?

Also I put a bit in FileBodyProducer that looks at the stack when the
error starts to see where it was being called from, but it didn't help
me too much. This is the stack anyway

  File &quot;/usr/local/bin/twistd&quot;, line 5, in &lt;module&gt;
    pkg_resources.run_script('Twisted==12.2.0', 'twistd')
  File &quot;/usr/lib/python2.7/dist-packages/pkg_resources.py&quot;, line 499,
in run_script
    self.require(requires)[0].run_script(script_name, ns)
  File &quot;/usr/lib/python2.7/dist-packages/pkg_resources.py&quot;, line 1235,
in run_script
    execfile(script_filename, namespace, namespace)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/EGG-INFO/scripts/twistd&quot;,
line 14, in &lt;module&gt;
    run()
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/scripts/twistd.py&quot;,
line 27, in run
    app.run(runApp, ServerOptions)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/application/app.py&quot;,
line 652, in run
    runApp(config)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/scripts/twistd.py&quot;,
line 23, in runApp
    _SomeApplicationRunner(config).run()
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/application/app.py&quot;,
line 390, in run
    self.postApplication()
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/scripts/_twistd_unix.py&quot;,
line 231, in postApplication
    self.startReactor(None, self.oldstdout, self.oldstderr)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/application/app.py&quot;,
line 402, in startReactor
    self.config, oldstdout, oldstderr, self.profiler, reactor)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/application/app.py&quot;,
line 323, in runReactorWithLogging
    reactor.run()
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/internet/base.py&quot;,
line 1169, in run
    self.mainLoop()
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/internet/base.py&quot;,
line 1181, in mainLoop
    self.doIteration(t)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/internet/epollreactor.py&quot;,
line 379, in doPoll
    log.callWithLogger(selectable, _drdw, selectable, fd, event)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/python/log.py&quot;,
line 84, in callWithLogger
    return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/python/log.py&quot;,
line 69, in callWithContext
    return context.call({ILogContext: newCtx}, func, *args, **kw)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/python/context.py&quot;,
line 118, in callWithContext
    return self.currentContext().callWithContext(ctx, func, *args, **kw)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/python/context.py&quot;,
line 81, in callWithContext
    return func(*args,**kw)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/internet/posixbase.py&quot;,
line 639, in _doReadOrWrite
    self._disconnectSelectable(selectable, why, inRead)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/internet/posixbase.py&quot;,
line 258, in _disconnectSelectable
    selectable.readConnectionLost(f)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/internet/tcp.py&quot;,
line 267, in readConnectionLost
    self.connectionLost(reason)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/internet/tcp.py&quot;,
line 473, in connectionLost
    self._commonConnection.connectionLost(self, reason)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/internet/tcp.py&quot;,
line 287, in connectionLost
    protocol.connectionLost(reason)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/internet/endpoints.py&quot;,
line 99, in connectionLost
    return self._wrappedProtocol.connectionLost(reason)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/web/_newclient.py&quot;,
line 859, in dispatcher
    return func(*args, **kwargs)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/web/_newclient.py&quot;,
line 1458, in _connectionLost_TRANSMITTING
    self._currentRequest.stopWriting()
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/web/_newclient.py&quot;,
line 760, in stopWriting
    _callAppFunction(self.bodyProducer.stopProducing)
  File &quot;/usr/local/lib/python2.7/dist-packages/Twisted-12.2.0-py2.7-linux-x86_64.egg/twisted/web/_newclient.py&quot;,
line 191, in _callAppFunction
    function()
  File &quot;main.tac&quot;, line 65, in stopProducing
    log_stack()
  File &quot;main.tac&quot;, line 55, in log_stack
    stack_trace = traceback.format_stack(frame)


&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="059006.html">[Twisted-Python] TaskStopped error, unsure of the cause and solution
</A></li>
	<LI>Next message (by thread): <A HREF="059018.html">[Twisted-Python] TaskStopped error,	unsure of the cause and solution
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59017">[ date ]</a>
              <a href="thread.html#59017">[ thread ]</a>
              <a href="subject.html#59017">[ subject ]</a>
              <a href="author.html#59017">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
