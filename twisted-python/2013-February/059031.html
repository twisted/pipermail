<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Unable to write to &quot;stuck&quot; TCP client connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Unable%20to%20write%20to%20%22stuck%22%20TCP%20client%20connections&In-Reply-To=%3CCAGr0%3D%2BHc_2JueASrC9pODixkZRxphrwodMJ3WyOK9_QwT5HaTA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="059043.html">
   <LINK REL="Next"  HREF="059032.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Unable to write to &quot;stuck&quot; TCP client connections</H1>
    <B>Wenxiang Wu</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Unable%20to%20write%20to%20%22stuck%22%20TCP%20client%20connections&In-Reply-To=%3CCAGr0%3D%2BHc_2JueASrC9pODixkZRxphrwodMJ3WyOK9_QwT5HaTA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Unable to write to &quot;stuck&quot; TCP client connections">wenxiang at zopim.com
       </A><BR>
    <I>Sun Feb 24 17:22:28 MST 2013</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="059043.html">[Twisted-Python] combine local and remote calls in perspective	brokers
</A></li>
        <LI>Next message (by thread): <A HREF="059032.html">[Twisted-Python] Unable to write to &quot;stuck&quot; TCP client	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59031">[ date ]</a>
              <a href="thread.html#59031">[ thread ]</a>
              <a href="subject.html#59031">[ subject ]</a>
              <a href="author.html#59031">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I am encountering a weird bug, where some TCP client connections get into a
state where the server is able to read data sent from the client, but not
able to send any data with transport.write().

With some help from the #twitsed IRC channel, I was able to gather the
following information regarding the bug. While I'm still unable to provide
steps to reporduce this bug, I am able to reliably find clients who are in
this state. I am running 24 instances of the twisted server (Epoll reactor)
running on Ubuntu, with a peak traffic of &gt;130k users. At any instance,
there are &lt; 20 TCP connections stuck in this state.

Here is some information about the bug:

1. transport.write() does not send anything down the socket
2. transport.doWrite() will send all the data that has been buffered up,
and then stop sending any new data.
3. transport.writeSomeData() will send data
3. reactor.getWriters() will return a list of transports that are all stuck
in this state, and the writers will remain in this list.
4. Calling reactor.removeWriter(transport) will &quot;unstuck&quot; the transport and
data gets streamed once again.
5. A small number of clients will receive data for a while, and return to
this stuck state. Most return to normal once reactor.removeWriter() is
called.
6. Based on the suggestion from IRC user _habnabit, I used strace after
removing the writer, here is the output:

(4:52:09 PM) thewrongboy: epoll_ctl(3, EPOLL_CTL_MOD, 6504, {EPOLLIN,
{u32=6504, u64=22205092589476200}}) = 0
(4:52:09 PM) thewrongboy: epoll_ctl(3, EPOLL_CTL_MOD, 6504,
{EPOLLIN|EPOLLOUT, {u32=6504, u64=22205092589476200}}) = 0
 (4:52:09 PM) thewrongboy: epoll_ctl(3, EPOLL_CTL_MOD, 6504, {EPOLLIN,
{u32=6504, u64=22205092589476200}}) = 0
(4:52:09 PM) thewrongboy: epoll_ctl(3, EPOLL_CTL_MOD, 6504,
{EPOLLIN|EPOLLOUT, {u32=6504, u64=22205092589476200}}) = 0
 (4:52:09 PM) thewrongboy: epoll_ctl(3, EPOLL_CTL_MOD, 6504, {EPOLLIN,
{u32=6504, u64=22205092589476200}}) = 0

For now, I am using a LoopingCall to check and remove transports that are
stuck in getWriters().

I am using Twisted 12.3.0 on Ubuntu 12.04 - 3.2.0-35-generic #55-Ubuntu SMP
Wed Dec 5 17:42:16 UTC 2012 x86_64 x86_64 x86_64 GNU/Linux.

Has anyone else experienced this weird problem? I'd love to provide more
information regarding this bug.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20130224/60f47b66/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="059043.html">[Twisted-Python] combine local and remote calls in perspective	brokers
</A></li>
	<LI>Next message (by thread): <A HREF="059032.html">[Twisted-Python] Unable to write to &quot;stuck&quot; TCP client	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#59031">[ date ]</a>
              <a href="thread.html#59031">[ thread ]</a>
              <a href="subject.html#59031">[ subject ]</a>
              <a href="author.html#59031">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
