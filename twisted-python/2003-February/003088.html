<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Serving files, again
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Serving%20files%2C%20again&In-Reply-To=20030226195031.GA21673%40meson.dyndns.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003087.html">
   <LINK REL="Next"  HREF="003120.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Serving files, again</H1>
    <B>Clark C. Evans</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Serving%20files%2C%20again&In-Reply-To=20030226195031.GA21673%40meson.dyndns.org"
       TITLE="[Twisted-Python] Serving files, again">cce at clarkevans.com
       </A><BR>
    <I>Wed Feb 26 16:06:57 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="003087.html">[Twisted-Python] Serving files, again
</A></li>
        <LI>Next message: <A HREF="003120.html">[Twisted-Python] Serving files, again
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3088">[ date ]</a>
              <a href="thread.html#3088">[ thread ]</a>
              <a href="subject.html#3088">[ subject ]</a>
              <a href="author.html#3088">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Jp, this is helpful.

On Wed, Feb 26, 2003 at 02:50:31PM -0500, Jp Calderone wrote:
|<i>   We usually consider IO on local fixed disks to be fast enough.  In any
</I>|<i> case, select() in POSIX tells you that files are always ready for reading,
</I>|<i> so being smarter about it requires using a different mechanism (which is
</I>|<i> entirely possible, but requires a different reactor, not to mention platform
</I>|<i> support).
</I>
The files that I need to serve up are quite big (some are a meg or more),
and it would be bad to block other resources while the file loads into
memory via file.read() or for the time it takes for the client to 
completely consume the file.

|<i>   BTW, deferring to a thread would not be the way to go.  Something similar
</I>|<i> to twisted.spread.util.Pager would probably be appropriate, or maybe
</I>|<i> something that implements IProducer.  Or maybe just a chain of Deferreds :)
</I>|<i> No need to go into threads for this, though.
</I>
Ok.  So this would be the equivalent of a &quot;file generator&quot; which
returns its content in say 4K chunks?  This would work by returning
a callback which (a) wrote out 4K and then (b) deferred itself again?

class deferredreader:
    def __init__(self,filename,chunksize = 4096):
        self.filename  = filename
        self.file      = None
        self.chunksize = 4096
    def callback(self,req):
        if not self.file:
            self.file = open(filename,&quot;r&quot;)
            return DEFERRED
        chunk = self.file.read(self.chunksize)
        if chunk: 
            req.write(chunk) 
            return DEFERRED
        else:
            return &quot;&quot;

(written but not tested)

Is this the Jist of it?  It still has the problem that file.read 
is a blocking call; I suppose for unix platforms you could use
&quot;poll()&quot; to not block.  This is probably resonable; on the server
side you don't block, while for desktop windows clients it blocks.

Is this what you were thinking with the chain of deferreds?

Best,

Clark


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003087.html">[Twisted-Python] Serving files, again
</A></li>
	<LI>Next message: <A HREF="003120.html">[Twisted-Python] Serving files, again
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3088">[ date ]</a>
              <a href="thread.html#3088">[ thread ]</a>
              <a href="subject.html#3088">[ subject ]</a>
              <a href="author.html#3088">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
