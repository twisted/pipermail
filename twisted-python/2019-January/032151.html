<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Negative error code breaks twisted.conch
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Negative%20error%20code%20breaks%20twisted.conch&In-Reply-To=%3CC35ADE90-FB55-4F35-9988-BF23E8F48427%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032150.html">
   <LINK REL="Next"  HREF="032152.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Negative error code breaks twisted.conch</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Negative%20error%20code%20breaks%20twisted.conch&In-Reply-To=%3CC35ADE90-FB55-4F35-9988-BF23E8F48427%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Negative error code breaks twisted.conch">glyph at twistedmatrix.com
       </A><BR>
    <I>Tue Jan 15 00:41:43 MST 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032150.html">[Twisted-Python] Negative error code breaks twisted.conch
</A></li>
        <LI>Next message (by thread): <A HREF="032152.html">[Twisted-Python] Negative error code breaks twisted.conch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32151">[ date ]</a>
              <a href="thread.html#32151">[ thread ]</a>
              <a href="subject.html#32151">[ subject ]</a>
              <a href="author.html#32151">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

&gt;<i> On Jan 14, 2019, at 7:23 AM, Peter Westlake &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">peter.westlake at pobox.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> An SSCCE:
</I>&gt;<i> 
</I>&gt;<i> from twisted.internet import error
</I>&gt;<i> from twisted.python import failure
</I>&gt;<i> from twisted.conch.ssh.session import SSHSessionProcessProtocol
</I>&gt;<i> from mock import MagicMock
</I>&gt;<i> 
</I>&gt;<i> err = error.ProcessTerminated(-1)
</I>&gt;<i> fail = failure.Failure(err)
</I>&gt;<i> session = MagicMock()
</I>&gt;<i> proto = SSHSessionProcessProtocol(session)
</I>&gt;<i> proto.processEnded(fail)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> That fails with:
</I>&gt;<i> 
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i>   File &quot;.../negexit.py&quot;, line 10, in &lt;module&gt;
</I>&gt;<i>     proto.processEnded(fail)
</I>&gt;<i>   File &quot;/usr/lib64/python2.7/site-packages/twisted/conch/ssh/session.py&quot;, line 279, in processEnded
</I>&gt;<i>     struct.pack('&gt;L', err.exitCode))
</I>&gt;<i> struct.error: integer out of range for 'L' format code
</I>&gt;<i> 
</I>&gt;<i> I'm running an SSH server on Windows, where negative exit codes can happen.
</I>&gt;<i> 
</I>&gt;<i> Passing negative numbers to a &quot;&gt;L&quot; format was allowed in Python before 2.6, where the number was treated as an unsigned int of the same bit pattern. It was deprecated in 2.6, and became an error in 2.7. It's only just become a problem for me because I'm updating a 10 year old SSH server that has been running under 2.4 all this time.
</I>&gt;<i> 
</I>&gt;<i> Presumably the fix is to bit-mask the exitCode? I was able to work around the error by doing that in a copy of _dumbwin32proc.py which was copied into the project (historical reasons, don't ask) but it would be nice to have a proper upstream fix. Not least because I want to purge the copied-in file, as you can imagine.
</I>
This is a great bug!  Thanks for raising it.  Sounds like the fix is to simply reinterpret it as unsigned.  <A HREF="https://en.wikipedia.org/wiki/Exit_status#Windows:">https://en.wikipedia.org/wiki/Exit_status#Windows:</A> &lt;<A HREF="https://en.wikipedia.org/wiki/Exit_status#Windows:">https://en.wikipedia.org/wiki/Exit_status#Windows:</A>&gt;

&gt;&gt;&gt;<i> Windows uses 32-bit unsigned integers as exit codes,[11] although the command interpreter treats them as signed.[12] If a process fails initialization, a Windows system error code may be returned.[13][14]
</I>
Please do submit this fix upstream (file a ticket on Trac, open a PR, etc), it seems like one of the easier ones to integrate :-).

-g
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190114/4ab8f868/attachment.html&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032150.html">[Twisted-Python] Negative error code breaks twisted.conch
</A></li>
	<LI>Next message (by thread): <A HREF="032152.html">[Twisted-Python] Negative error code breaks twisted.conch
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32151">[ date ]</a>
              <a href="thread.html#32151">[ thread ]</a>
              <a href="subject.html#32151">[ subject ]</a>
              <a href="author.html#32151">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
