<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] txsni + alpn + acme (letsencrypt)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20txsni%20%2B%20alpn%20%2B%20acme%20%28letsencrypt%29&In-Reply-To=%3C359C403B-F290-4253-8200-642320F92C6D%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032216.html">
   <LINK REL="Next"  HREF="064680.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] txsni + alpn + acme (letsencrypt)</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20txsni%20%2B%20alpn%20%2B%20acme%20%28letsencrypt%29&In-Reply-To=%3C359C403B-F290-4253-8200-642320F92C6D%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] txsni + alpn + acme (letsencrypt)">glyph at twistedmatrix.com
       </A><BR>
    <I>Sat Mar 23 15:47:53 MDT 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032216.html">[Twisted-Python] txsni + alpn + acme (letsencrypt)
</A></li>
        <LI>Next message (by thread): <A HREF="064680.html">[Twisted-Python] txsni + alpn + acme (letsencrypt)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64678">[ date ]</a>
              <a href="thread.html#64678">[ thread ]</a>
              <a href="subject.html#64678">[ subject ]</a>
              <a href="author.html#64678">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mar 23, 2019, at 7:21 AM, Daniel Holth &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dholth at gmail.com</A>&gt; wrote:
&gt;<i> 
</I>&gt;<i> Hello. Can you help me to learn to debug tls problems in twisted?
</I>
Hi Daniel!  Thanks so much for trying to improve this aspect of the Twisted ecosystem.

&gt;<i> I was disappointed that txacme, an automatic way to get certificates for twisted web, stopped working, so I'm trying to add a responder for the new challenge type.
</I>
This situation is definitely bad; as JP tersely put it on <A HREF="https://github.com/twisted/txacme/issues/148,">https://github.com/twisted/txacme/issues/148,</A> &quot;The published documentation makes it appear as though the server endpoint works though it has apparently been broken for about a year&quot;.

But to prevent onlookers from thinking the situation is even worse than it is, please allow me to clarify:

txacme still &quot;works&quot; in the sense that it supports the http-01 challenge (which is still supported for the forseeable future, AFAIK), and its challenge/response implementation also powers <A HREF="https://pypi.org/project/lancer/">https://pypi.org/project/lancer/</A> &lt;<A HREF="https://pypi.org/project/lancer/">https://pypi.org/project/lancer/</A>&gt;, which uses the dns-01 challenge.  However, its endpoints (and particularly its string endpoint plugin) doesn't support this challenge directly.

The thing that's broken is sni-01, which was disabled globally by Let's Encrypt for security reasons: <A HREF="https://www.zdnet.com/article/lets-encrypt-disables-tls-sni-01-validation/">https://www.zdnet.com/article/lets-encrypt-disables-tls-sni-01-validation/</A> &lt;<A HREF="https://www.zdnet.com/article/lets-encrypt-disables-tls-sni-01-validation/">https://www.zdnet.com/article/lets-encrypt-disables-tls-sni-01-validation/</A>&gt;

One approach to fixing this is to implement a string endpoint syntax that listens on port 80 and supports HTTP-01 rather than trying to make TLS support TLS-ALPN-01.

See discussion here: <A HREF="https://github.com/twisted/txacme/issues/129">https://github.com/twisted/txacme/issues/129</A> &lt;<A HREF="https://github.com/twisted/txacme/issues/129">https://github.com/twisted/txacme/issues/129</A>&gt;.

Brian Warner already has a branch here: <A HREF="https://github.com/warner/txacme/tree/129-http01-endpoint">https://github.com/warner/txacme/tree/129-http01-endpoint</A> &lt;<A HREF="https://github.com/warner/txacme/tree/129-http01-endpoint">https://github.com/warner/txacme/tree/129-http01-endpoint</A>&gt; but has not made a PR yet.  Perhaps you could resurrect this code, polish anything that needs polishing, and get it integrated and released :).

&gt;<i> It sends a special certificate if the CA negotiates acme using alpn, proving domain control, then you get a certificate.
</I>
&gt;<i> Seems to work with openssl s_client but letsencrypt says &quot;no application protocol&quot;. Anyone know where that error comes from?
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://github.com/glyph/txsni/pull/26">https://github.com/glyph/txsni/pull/26</A> &lt;<A HREF="https://github.com/glyph/txsni/pull/26">https://github.com/glyph/txsni/pull/26</A>&gt;
</I>I suspect one thing you might be running into is this: <A HREF="https://github.com/pyca/pyopenssl/issues/769">https://github.com/pyca/pyopenssl/issues/769</A> &lt;<A HREF="https://github.com/pyca/pyopenssl/issues/769">https://github.com/pyca/pyopenssl/issues/769</A>&gt;, i.e. the issue that caused Certbot to revert their own ALPN support: <A HREF="https://github.com/certbot/certbot/pull/6100">https://github.com/certbot/certbot/pull/6100</A> &lt;<A HREF="https://github.com/certbot/certbot/pull/6100">https://github.com/certbot/certbot/pull/6100</A>&gt;.  This is an OpenSSL bug and there's not a whole lot Twisted can do about it.  See here where I ran into it myself, for this exact same reason: <A HREF="https://github.com/openssl/openssl/issues/7660#issuecomment-462104869">https://github.com/openssl/openssl/issues/7660#issuecomment-462104869</A> &lt;<A HREF="https://github.com/openssl/openssl/issues/7660#issuecomment-462104869">https://github.com/openssl/openssl/issues/7660#issuecomment-462104869</A>&gt;

Even if you're not hitting this specific problem, continuing down this road (implementing the ALPN challenge using OpenSSL) is unfortunately a bad idea.

Fundamentally, the ALPN callback in OpenSSL is poorly designed, and optimized for the very specific negotiation process that HTTP/2 requires.  The guidance from people familiar with OpenSSL is - and I know this sounds like a joke, I wish I were kidding here, but no, this is seriously the recommendation - implement your own parser for the ClientHello, extract the ALPN field yourself, then construct an OpenSSL connection object based on what you find there, and hand it the bytes you just parsed.

Given the mechanics of the challenge message (i.e.: it's going to be in the initial clienthello) you could probably cheese it with a regex just to get something working.

I hope this was helpful.  Good luck, and please keep us posted on your efforts!

-g

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190323/82514dec/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032216.html">[Twisted-Python] txsni + alpn + acme (letsencrypt)
</A></li>
	<LI>Next message (by thread): <A HREF="064680.html">[Twisted-Python] txsni + alpn + acme (letsencrypt)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64678">[ date ]</a>
              <a href="thread.html#64678">[ thread ]</a>
              <a href="subject.html#64678">[ subject ]</a>
              <a href="author.html#64678">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
