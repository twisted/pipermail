<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] stop/start client connections with loseConnection in ReconnectingClientFactory
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20stop/start%20client%20connections%20with%0A%20loseConnection%20in%20ReconnectingClientFactory&In-Reply-To=%3CCANzH6eunhEm%2BLrSvEus7cbhg6LkotSX70UBGkctfYO9QR0H-Bw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064710.html">
   <LINK REL="Next"  HREF="064676.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] stop/start client connections with loseConnection in ReconnectingClientFactory</H1>
    <B>Sean DiZazzo</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20stop/start%20client%20connections%20with%0A%20loseConnection%20in%20ReconnectingClientFactory&In-Reply-To=%3CCANzH6eunhEm%2BLrSvEus7cbhg6LkotSX70UBGkctfYO9QR0H-Bw%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] stop/start client connections with loseConnection in ReconnectingClientFactory">sean.dizazzo at gmail.com
       </A><BR>
    <I>Fri Mar 22 14:08:35 MDT 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064710.html">[Twisted-Python] stop/start client connections with loseConnection in ReconnectingClientFactory
</A></li>
        <LI>Next message (by thread): <A HREF="064676.html">[Twisted-Python] stop/start client connections with loseConnection in ReconnectingClientFactory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64674">[ date ]</a>
              <a href="thread.html#64674">[ thread ]</a>
              <a href="subject.html#64674">[ subject ]</a>
              <a href="author.html#64674">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>You may want to look at twisted.application.internet.ClientService
&lt;<A HREF="https://twistedmatrix.com/documents/18.7.0/api/twisted.application.internet.ClientService.html">https://twistedmatrix.com/documents/18.7.0/api/twisted.application.internet.ClientService.html</A>&gt;.
It uses the new endpoints instead of the `connectTCP()` stuff.  Not sure if
it applies in your situation, but it has all of the retry logic built in,
so that may make it easier to work with.


On Fri, Mar 22, 2019 at 10:08 AM Chris Satterthwaite &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris at cmsconstruct.com</A>&gt;
wrote:

&gt;<i> Hello community,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> First of all - thanks for an awesome platform!  I’m brand new to this
</I>&gt;<i> community, but have been using Twisted a couple years.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *Reason for posting:*
</I>&gt;<i>
</I>&gt;<i> I’ve hit a condition with ReconnectingClientFactory that I’m not sure is
</I>&gt;<i> per design.  I have a work around right now, but need your perspective.
</I>&gt;<i> Seems like there should be a better/right way to do this.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *Attempted design:*
</I>&gt;<i>
</I>&gt;<i> I’d like to have long running TCP clients (forever until stopped), with a
</I>&gt;<i> long running TCP server.  When a long running client hits a problem with a
</I>&gt;<i> dependency (database is down, kafka bus unavailable, external API not
</I>&gt;<i> responding, etc), I want the client to go offline for a while and then come
</I>&gt;<i> back online… an automated, self-recovery type action.  Since it’s not ok to
</I>&gt;<i> start/stop/restart the Twisted Reactor, I am letting the client finish
</I>&gt;<i> whatever it can do, disconnect from the service, destruct the dependencies,
</I>&gt;<i> wait for a period of time, and then attempt a clean re-initialization of
</I>&gt;<i> those dependencies along with reconnecting to the Twisted Server.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *Problem case:*
</I>&gt;<i>
</I>&gt;<i> I’m using the ReconnectingClientFactory in my client.  When the client
</I>&gt;<i> hits a problem, it calls transport.loseConnection().  But whenever the
</I>&gt;<i> client calls this, after the disconnect – it does not reconnect;
</I>&gt;<i> stopFactory is called and everything exits.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *Work around:*
</I>&gt;<i>
</I>&gt;<i> I noticed some Twisted source code that works off factory.numPorts.  If
</I>&gt;<i> numPorts is 1 and the client loses the connection, it goes to 0 and calls
</I>&gt;<i> the cleanup.  So I conditionally increase this number right before
</I>&gt;<i> intentionally disconnecting, and then reset that after reconnecting.  This
</I>&gt;<i> solves the problem, but it’s a hack.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I’ll attach the test scripts to this post (if attachments are allowed),
</I>&gt;<i> but the main code is with these functions in the factory:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>                 def clientConnectionLost(self, connector, reason):
</I>&gt;<i>
</I>&gt;<i>                                 print('  factory clientConnectionLost:
</I>&gt;<i> reason: {}'.format(reason))
</I>&gt;<i>
</I>&gt;<i>                                 # if self.disconnectedOnPurpose:
</I>&gt;<i>
</I>&gt;<i>                                 #             ## Hack to keep reactor alive
</I>&gt;<i>
</I>&gt;<i>                                 #             print('  factory
</I>&gt;<i> clientConnectionLost: increasing numPorts')
</I>&gt;<i>
</I>&gt;<i>                                 #             self.numPorts += 1
</I>&gt;<i>
</I>&gt;<i>                                 #             self.numPortsChanged = True
</I>&gt;<i>
</I>&gt;<i>                                 #             self.disconnectedOnPurpose =
</I>&gt;<i> False
</I>&gt;<i>
</I>&gt;<i>                                 print('  ... simulate client going idle
</I>&gt;<i> before attempting restart...')
</I>&gt;<i>
</I>&gt;<i>                                 time.sleep(5)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ReconnectingClientFactory.clientConnectionLost(self, connector, reason)
</I>&gt;<i>
</I>&gt;<i>                                 print('  factory clientConnectionLost:
</I>&gt;<i> end.\n')
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>                 def clientConnectionMade(self):
</I>&gt;<i>
</I>&gt;<i>                                 print('  factory clientConnectionMade:
</I>&gt;<i> starting numPorts: {}'.format(self.numPorts))
</I>&gt;<i>
</I>&gt;<i>                                 # if self.numPortsChanged :
</I>&gt;<i>
</I>&gt;<i>                                 #             ## Resetting from hacked
</I>&gt;<i> value
</I>&gt;<i>
</I>&gt;<i>                                 #             print('  factory
</I>&gt;<i> clientConnectionMade: decreasing numPorts')
</I>&gt;<i>
</I>&gt;<i>                                 #             self.numPorts -= 1
</I>&gt;<i>
</I>&gt;<i>                                 #             self.numPortsChanged = False
</I>&gt;<i>
</I>&gt;<i>                                 print('  factory clientConnectionMade:
</I>&gt;<i> finished numPorts: {}'.format(self.numPorts))
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>                 def cleanup(self):
</I>&gt;<i>
</I>&gt;<i>                                 print('factory cleanup: calling
</I>&gt;<i> loseConnection')
</I>&gt;<i>
</I>&gt;<i>                                 if self.connectedClient is not None:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> self.connectedClient.transport.loseConnection()
</I>&gt;<i>
</I>&gt;<i>                                                 self.disconnectedOnPurpose
</I>&gt;<i> = True
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> With the above lines commented out, once the cleanup call does
</I>&gt;<i> transport.loseConnection(), the factory stops at the end of
</I>&gt;<i> clientConnectionLost.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *Sample scripts/logs:*
</I>&gt;<i>
</I>&gt;<i> I’ve tried to create short test scripts and corresponding logs (with the
</I>&gt;<i> client failing, and then with it restarting when I use the workaround).
</I>&gt;<i> I’ve cut out several thousand lines to get down to something simple for the
</I>&gt;<i> example test scripts, but I know the client is still a little long.  Again,
</I>&gt;<i> I’m not sure if attachments work on the mailing list, but I’ll attempt to
</I>&gt;<i> attach the client/server scripts with the corresponding pass/fail logs.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -Chris
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190322/82ffd17c/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064710.html">[Twisted-Python] stop/start client connections with loseConnection in ReconnectingClientFactory
</A></li>
	<LI>Next message (by thread): <A HREF="064676.html">[Twisted-Python] stop/start client connections with loseConnection in ReconnectingClientFactory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64674">[ date ]</a>
              <a href="thread.html#64674">[ thread ]</a>
              <a href="subject.html#64674">[ subject ]</a>
              <a href="author.html#64674">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
