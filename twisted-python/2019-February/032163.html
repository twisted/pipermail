<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] SMTPClient disconnects following STARTTLS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SMTPClient%20disconnects%20following%20STARTTLS&In-Reply-To=%3C5BE021A5-F598-4455-B2A3-9E8CAE708E12%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032160.html">
   <LINK REL="Next"  HREF="032161.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] SMTPClient disconnects following STARTTLS</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SMTPClient%20disconnects%20following%20STARTTLS&In-Reply-To=%3C5BE021A5-F598-4455-B2A3-9E8CAE708E12%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] SMTPClient disconnects following STARTTLS">glyph at twistedmatrix.com
       </A><BR>
    <I>Sun Feb 10 00:35:42 MST 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032160.html">[Twisted-Python] SMTPClient disconnects following STARTTLS
</A></li>
        <LI>Next message (by thread): <A HREF="032161.html">[Twisted-Python] trouble installing 18.9.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32163">[ date ]</a>
              <a href="thread.html#32163">[ thread ]</a>
              <a href="subject.html#32163">[ subject ]</a>
              <a href="author.html#32163">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

&gt;<i> On Feb 5, 2019, at 7:15 AM, Burak Arslan &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">burak.arslan at arskom.com.tr</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I'm trying to deliver mail using twisted.mail.sendmail (version 18.9.0)
</I>
Thanks for using Twisted, and thanks for already being on the latest version!

&gt;<i> Delivery attempts to some servers fail either with disconnections or
</I>&gt;<i> timeouts following the STARTTLS command. When I disable STARTTLS (by
</I>&gt;<i> patching tryTLS()) message delivery succeeds.
</I>&gt;<i> 
</I>&gt;<i> So is there a way to log the TLS handshake process to be able to
</I>&gt;<i> understand why the TLS connection cannot resume? Any suggestions for
</I>&gt;<i> troubleshooting this? A dry ConnectionDone doesn't tell much.
</I>
If you really want to log the handshake itself, you could try starting with Wireshark, which would at least tell you something about the contents of said handshake.  However, this may not be all that useful initially.

There are lots of potential problems here.  One is that ESMTPSender uses TLSv1_METHOD[1], which may be provoking your peers into dropping the connection because it's too old a version.  You haven't said anything about how you're building your client context, and there are several other potential problems with the default.

Another potential problem is that I don't know how you've set up Twisted's logging.  If Twisted were logging a traceback, would you see it?

In general this is a very difficult problem to debug, email is non-deterministic and scary, but it upgrades from &quot;difficult&quot; to &quot;impossible&quot; without seeing the sample code doing the sending :-).

&gt;<i> Is it possible to make t.m.sendmail() attempt another delivery without
</I>&gt;<i> STARTTLS?
</I>
If you do this, you're quite likely to end up in a situation where your messages are far more likely to be flagged as spam by your ESP.  STARTTLS is generally considered a positive signal for deliverability.  (See <A HREF="https://starttls-everywhere.org">https://starttls-everywhere.org</A> &lt;<A HREF="https://starttls-everywhere.org/">https://starttls-everywhere.org/</A>&gt;).

&gt;<i> Best regards,
</I>&gt;<i> Burak ARSLAN
</I>
Hopefully some of my guesses were helpful, but I'm looking forward to seeing your code, and hopeful that someone on the list can help you work through to the point where you can deliver some mail :).

-g

[1]: At the time ESMTPSender was written, TLSv1_METHOD was a bold, forward-looking SSL_METHOD to select!  It was the most recent version of the protocol, and explicitly opted out of vulnerable SSLv2 and SSLv3 protocol versions.  However, the OpenSSL API is nothing if not deeply unfortunate, so this has metastasized over time into an incredibly ancient and bad SSL_METHOD; the correct one that you want is SSLv23_METHOD which means &quot;negotiate TLS version&quot; (and practically no current version of OpenSSL will negotiate either SSLv2 *or* SSLv3 with this method, since they're broken and deprecated).
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190209/e3660830/attachment.html&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032160.html">[Twisted-Python] SMTPClient disconnects following STARTTLS
</A></li>
	<LI>Next message (by thread): <A HREF="032161.html">[Twisted-Python] trouble installing 18.9.0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32163">[ date ]</a>
              <a href="thread.html#32163">[ thread ]</a>
              <a href="subject.html#32163">[ subject ]</a>
              <a href="author.html#32163">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
