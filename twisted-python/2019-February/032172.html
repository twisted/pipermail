<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] why can't a callback be called with a deferred?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20why%20can%27t%20a%20callback%20be%20called%20with%20a%20deferred%3F&In-Reply-To=%3C2F447265-3737-47F9-A328-589F9C375252%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="032171.html">
   <LINK REL="Next"  HREF="032173.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] why can't a callback be called with a deferred?</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20why%20can%27t%20a%20callback%20be%20called%20with%20a%20deferred%3F&In-Reply-To=%3C2F447265-3737-47F9-A328-589F9C375252%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] why can't a callback be called with a deferred?">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Feb 21 00:32:54 MST 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="032171.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
        <LI>Next message (by thread): <A HREF="032173.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32172">[ date ]</a>
              <a href="thread.html#32172">[ thread ]</a>
              <a href="subject.html#32172">[ subject ]</a>
              <a href="author.html#32172">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

&gt;<i> On Feb 20, 2019, at 11:03 PM, Chris Withers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris at withers.org</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On 21/02/2019 06:55, Glyph wrote:
</I>&gt;&gt;&gt;<i> The methods being hooked don't necessarily return deferreds.
</I>&gt;<i> 
</I>&gt;<i> Glyph, this bit ^^^
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> I'd like it to be an explicit choice of the caller, ie:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> result = yield SomeProtocol.onMessage.called()
</I>&gt;&gt;&gt;<i> # okay, we got here, we know onMessage was called,
</I>&gt;&gt;&gt;<i> # now we might want to tick a clock, or otherwise simulate
</I>&gt;&gt;&gt;<i> # async state manipulation.
</I>&gt;&gt;&gt;<i> # now I want to make sure the deferred chain on the onMessage result has been completed:
</I>&gt;&gt;&gt;<i> yield result
</I>&gt;&gt;<i> I'm not sure I understand your example here. 
</I>&gt;<i> 
</I>&gt;<i> Yeah, this is part of carly, that I posted earlier. It stems from the need to get the results of method calls when you have no reference to the object being calls, or sometimes a result that's a deferred you need to wait on, particularly in a test, but have no way of doing so.
</I>
I just can't parse this sentence.

Breaking it down:

&gt;<i> you have no reference to the object being calls,
</I>
How do you have no reference to the object being called? Aren't you calling it?

&gt;<i> or sometimes a result that's a deferred you need to wait on, particularly in a test, but have no way of doing so
</I>
But... you do have a way of doing so.  You yield it from inlineCallbacks or you add a callback to it.

In any case you either have a Deferred or you don't; if you do, then it's clear you should wait on it, if you don't, then it's clear you should not wait on it.  If you want an API that allows some user code to do either, that's what 'maybeDeferred' is for.

&gt;<i> If you're feeling brave, have a read of:
</I>&gt;<i> <A HREF="https://github.com/cjw296/carly/blob/master/carly/hook.py">https://github.com/cjw296/carly/blob/master/carly/hook.py</A>
</I>&gt;<i> 
</I>&gt;&gt;<i> The assertion in question only happens if you call returnValue or do a return with a Deferred directly; this example doesn't do either of those things.
</I>&gt;<i> 
</I>&gt;<i> This is the test situation where I hit this issue:
</I>&gt;<i> <A HREF="https://github.com/cjw296/carly/blob/master/tests/test_untracked_deferred.py#L28-L35">https://github.com/cjw296/carly/blob/master/tests/test_untracked_deferred.py#L28-L35</A>
</I>&gt;<i> 
</I>&gt;<i> I'd originally wanted to have that read:
</I>&gt;<i> 
</I>&gt;<i>    @inlineCallbacks
</I>&gt;<i>    def test1(self):
</I>&gt;<i>        ...
</I>&gt;<i>        result = yield pita.asyncMethod.called()
</I>&gt;<i>        with ShouldRaise(Exception(1)):
</I>&gt;<i>            yield result
</I>&gt;<i> 
</I>&gt;<i> Now, which I'm actually happier with the end result here, I think the above it legit, if unusual, and that assert trips it up.
</I>
Some type annotations might make it a bit clearer what the two states here are :).  As it is, it looks to me you want a Deferred to come *out* of a 'yield', which should definitely never happen.  If this assert were to be removed, it would be done in such a way that would implicitly wait for the Deferred in question to fire: you should never receive a Deferred as an argument to a function, or as the result of an (inlineCallbacks) 'yield' or (async def) 'await'.  It breaks the whole model of what 'awaiting' means.

-g
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190220/56ad0744/attachment.html&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="032171.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
	<LI>Next message (by thread): <A HREF="032173.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#32172">[ date ]</a>
              <a href="thread.html#32172">[ thread ]</a>
              <a href="subject.html#32172">[ subject ]</a>
              <a href="author.html#32172">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
