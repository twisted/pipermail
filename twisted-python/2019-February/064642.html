<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] why can't a callback be called with a deferred?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20why%20can%27t%20a%20callback%20be%20called%20with%20a%20deferred%3F&In-Reply-To=%3CCAEeXt4PjQf1AODsuu%2BHVjHAAw8L0BqueGhwzBeVqL7J5GazzmQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064641.html">
   <LINK REL="Next"  HREF="064643.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] why can't a callback be called with a deferred?</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20why%20can%27t%20a%20callback%20be%20called%20with%20a%20deferred%3F&In-Reply-To=%3CCAEeXt4PjQf1AODsuu%2BHVjHAAw8L0BqueGhwzBeVqL7J5GazzmQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] why can't a callback be called with a deferred?">exarkun at twistedmatrix.com
       </A><BR>
    <I>Wed Feb 27 07:45:35 MST 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064641.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
        <LI>Next message (by thread): <A HREF="064643.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64642">[ date ]</a>
              <a href="thread.html#64642">[ thread ]</a>
              <a href="subject.html#64642">[ subject ]</a>
              <a href="author.html#64642">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Feb 27, 2019 at 9:34 AM Scott, Barry &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">barry.scott at forcepoint.com</A>&gt;
wrote:

&gt;<i> On Tuesday, 26 February 2019 06:34:28 GMT Glyph wrote:
</I>&gt;<i> &gt; &gt; On Feb 25, 2019, at 3:32 AM, Scott, Barry &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">barry.scott at forcepoint.com</A>&gt;
</I>&gt;<i> &gt; &gt; wrote:&gt;
</I>&gt;<i> &gt; &gt; On Tuesday, 19 February 2019 11:00:57 GMT Chris Withers wrote:
</I>&gt;<i> &gt; &gt;&gt; Hi All,
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; There's this assert:
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> <A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/internet/defer.">https://github.com/twisted/twisted/blob/trunk/src/twisted/internet/defer.</A>
</I>&gt;<i> &gt; &gt;&gt; py# L459
</I>&gt;<i> &gt; &gt;&gt;
</I>&gt;<i> &gt; &gt;&gt; ...and I'd like to understand why it's there.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; We hit this assert when porting from very old twisted to current
</I>&gt;<i> twisted.
</I>&gt;<i> &gt; &gt; In all cases the problem was with our code that used deferreds in a
</I>&gt;<i> poor,
</I>&gt;<i> &gt; &gt; not well understood way. After refactoring we are a lot happier with
</I>&gt;<i> the
</I>&gt;<i> &gt; &gt; resulting code as it easier to maintain now.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks for the feedback, Barry!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; It would still be great to figure out, if we can, how we might make the
</I>&gt;<i> &gt; error message a bit more legible to folks with less knowledge of
</I>&gt;<i> Twisted's
</I>&gt;<i> &gt; internals.
</I>&gt;<i>
</I>&gt;<i> Let suppose that I need work done by doWork function.
</I>&gt;<i> It returns a deferred for me to hang call backs and error backs on.
</I>&gt;<i>
</I>&gt;<i>         d = doWork()
</I>&gt;<i>         d.addCallback(handleWorkDone)
</I>&gt;<i>
</I>&gt;<i> In my handleWorkDone I expect to get the result of doWork completing.
</I>&gt;<i>
</I>&gt;<i> The assert fires if instead of a result value is returned a Deferred is
</I>&gt;<i> returned. This I consider a bug in the doWork() implementation.
</I>&gt;<i>
</I>
This doesn't sound right.  Can you provide an example implementation of
doWork that provokes this behavior?  Here's an implementation that seems
like it matches your description and which does not provoke the behavior:

    def doWork():
        d = Deferred()
        d.callback(&quot;result&quot;)
        return d

    d = doWork()
    d.addCallback(handleWorkDone)

This doesn't trigger the assert.  This calls handleWorkDone with &quot;result&quot;.
If you simplify the code so the Deferred interaction remains the same but
all the extraneous code is removed, it looks like this:

    d = Deferred()
    d.callback(&quot;result&quot;)
    d.addCallback(handleWorkDone)

which *must* work or Deferred is completely useless.

Jean-Paul



&gt;<i>
</I>&gt;<i> What must happen in doWork is that it must arrange that
</I>&gt;<i> any Deferred it used internally has an addCallback used to
</I>&gt;<i> cause the d returned to the user to complete. Leaking the
</I>&gt;<i> any internal Deferred() objects must not happen to the user
</I>&gt;<i> of doWork.
</I>&gt;<i>
</I>&gt;<i> def doWork():
</I>&gt;<i>         d = Deferred()
</I>&gt;<i>
</I>&gt;<i>         def completeWork(result, d):
</I>&gt;<i>                 d.callback(result)
</I>&gt;<i>
</I>&gt;<i>         inner_d = doAsyncWork()
</I>&gt;<i>         inner_d.addCallback(completeWork, d)
</I>&gt;<i>
</I>&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i> The error message would need to say something like:
</I>&gt;<i> &quot;Cannot return a Deferred as a result. Did you forgot to addCallback to
</I>&gt;<i> the
</I>&gt;<i> deferred?&quot;
</I>&gt;<i>
</I>&gt;<i> Maybe add something to docs based on the above and refer to it in the
</I>&gt;<i> message?
</I>&gt;<i>
</I>&gt;<i> Barry
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190227/dd5a99e4/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064641.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
	<LI>Next message (by thread): <A HREF="064643.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64642">[ date ]</a>
              <a href="thread.html#64642">[ thread ]</a>
              <a href="subject.html#64642">[ subject ]</a>
              <a href="author.html#64642">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
