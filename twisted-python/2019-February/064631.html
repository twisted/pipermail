<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] why can't a callback be called with a deferred?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20why%20can%27t%20a%20callback%20be%20called%20with%20a%20deferred%3F&In-Reply-To=%3C7D6C45E2-2B0E-4448-A077-189AE6484E73%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="064630.html">
   <LINK REL="Next"  HREF="064632.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] why can't a callback be called with a deferred?</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20why%20can%27t%20a%20callback%20be%20called%20with%20a%20deferred%3F&In-Reply-To=%3C7D6C45E2-2B0E-4448-A077-189AE6484E73%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] why can't a callback be called with a deferred?">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Feb 20 23:55:24 MST 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="064630.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
        <LI>Next message (by thread): <A HREF="064632.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64631">[ date ]</a>
              <a href="thread.html#64631">[ thread ]</a>
              <a href="subject.html#64631">[ subject ]</a>
              <a href="author.html#64631">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

&gt;<i> On Feb 19, 2019, at 5:34 AM, Chris Withers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris at withers.org</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On 19/02/2019 11:41, Adi Roiban wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I think it was introduced to catch some common bad usage patterns ...
</I>&gt;&gt;<i> like yours :)
</I>&gt;<i> 
</I>&gt;<i> Not a massively helpful comment.
</I>
I think what Adi was trying to get at here is that this is exactly the sort of type confusion that this assert was intended to defend against.

That said, the bare assert in question was definitely written with the implementor's sort of &quot;this should never happen&quot; hat on, not the &quot;let's report a useful error to the user&quot; hat.  So it could certainly stand to be improved regardless.

&gt;&gt;<i> If you want to chain the deferreds, use the dedicated helper
</I>&gt;&gt;<i> <A HREF="https://twistedmatrix.com/documents/current/core/howto/defer.html#chaining-deferreds">https://twistedmatrix.com/documents/current/core/howto/defer.html#chaining-deferreds</A> &lt;<A HREF="https://twistedmatrix.com/documents/current/core/howto/defer.html#chaining-deferreds">https://twistedmatrix.com/documents/current/core/howto/defer.html#chaining-deferreds</A>&gt;
</I>
&gt;&gt;<i> Deferred are not always 100% resolved/called.
</I>&gt;&gt;<i> You might have a deferred called, but the current result might be
</I>&gt;&gt;<i> another deferred... so it has no final result yet.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ----
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> so in your case, instead of `returnValue(result)` use
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> result = yield result
</I>&gt;&gt;<i> returnValue(result)
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> in this way, the result is resolved :)
</I>&gt;<i> 
</I>&gt;<i> The methods being hooked don't necessarily return deferreds.
</I>&gt;<i> I'd like it to be an explicit choice of the caller, ie:
</I>&gt;<i> 
</I>&gt;<i> result = yield SomeProtocol.onMessage.called()
</I>&gt;<i> # okay, we got here, we know onMessage was called,
</I>&gt;<i> # now we might want to tick a clock, or otherwise simulate
</I>&gt;<i> # async state manipulation.
</I>&gt;<i> # now I want to make sure the deferred chain on the onMessage result has been completed:
</I>&gt;<i> yield result
</I>
I'm not sure I understand your example here.  The assertion in question only happens if you call returnValue or do a return with a Deferred directly; this example doesn't do either of those things.

I think you could fix the linked example code to still do what you want by simply doing `returnValue(yield result)`?

-g
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20190220/171a900a/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="064630.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
	<LI>Next message (by thread): <A HREF="064632.html">[Twisted-Python] why can't a callback be called with a deferred?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#64631">[ date ]</a>
              <a href="thread.html#64631">[ thread ]</a>
              <a href="subject.html#64631">[ subject ]</a>
              <a href="author.html#64631">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
