<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Subproject releases
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Subproject%20releases&In-Reply-To=434DC691.3060709%40divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011677.html">
   <LINK REL="Next"  HREF="011701.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Subproject releases</H1>
    <B>James Y Knight</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Subproject%20releases&In-Reply-To=434DC691.3060709%40divmod.com"
       TITLE="[Twisted-Python] Subproject releases">foom at fuhm.net
       </A><BR>
    <I>Tue Oct 18 00:04:06 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="011677.html">[Twisted-Python] Subproject releases
</A></li>
        <LI>Next message: <A HREF="011701.html">[Twisted-Python] Subproject releases
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11692">[ date ]</a>
              <a href="thread.html#11692">[ thread ]</a>
              <a href="subject.html#11692">[ subject ]</a>
              <a href="author.html#11692">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Oct 12, 2005, at 10:29 PM, Glyph Lefkowitz wrote:
&gt;<i> Hmm.  Trial interaction is something I haven't messed with yet; I
</I>&gt;<i> haven't put trial directory below a __path__ entry.
</I>&gt;<i>
</I>&gt;<i> Arguably this is simply a bug in Trial that should be fixed, though.
</I>&gt;<i>
</I>
The main problem here is that trial's &quot;recursively find all test  
modules for me&quot; mode is based upon a recursive walk of the filesystem  
below a certain path. Currently, &quot;trial twisted&quot; does the following:
1) import the module named (&quot;twisted&quot;)
2) os.path.walk over all files under the directory of that module's  
__file__ (&quot;twisted/&quot;)
3) filter out (a) any directory which doesn't contain an __init__.*,  
and (b) any files that don't match test_*.py.
4) backwards convert the path of the matched files to a module name  
with some poor heuristics (reflect.filenameToModuleName).
5) try to import said module.

This completely breaks down in the case where packages use __path__.  
The new hierarchy has the following:
Root/
Root/twisted/
Root/twisted/__init__.py (has __path__=&quot;core/twisted/&quot;,&quot;web2/twisted/&quot;)
core/
core/twisted/
core/twisted/__init__.py
core/twisted/test/
core/twisted/test/__init__.py
core/twisted/test/test_tcp.py
web2/
web2/twisted/
web2/twisted/web2/
web2/twisted/web2/__init__.py
web2/twisted/web2/test/
web2/twisted/web2/test/__init__.py
web2/twisted/web2/test/test_http.py

So, given that layout, currently, &quot;trial twisted&quot; would get  
twisted.__file__ == &quot;Root/twisted/__init__.py&quot;, take the dirname,  
&quot;Root/twisted/&quot;, and walk that hierarchy looking for tests (and there  
aren't any there. Oops). Okay, let's specify the directory explicitly  
-- I'll say &quot;trial web2/twisted/web2/test/&quot;. Now, that doesn't work  
right either, because it's impossible to backwards convert an  
arbitrary filename to the python module name it's expecting to be  
imported under. filenameToModuleName in this case would return  
&quot;web2.test.test_http&quot;, which is wrong.

So, my solution:
I changed the recursive process to actually import every package (not  
every module!), so it can use the package's __path__ attribute to  
find submodules. This works, mostly.

One issue is that it causes trial to emit an import error message  
from trying to import twisted.internet.iocpreactor and  
twisted.internet.serialport (because they aren't importable on my  
system). This is necessary -- trial does not know they don't have a  
__path__ attribute before importing them, so it has no way of telling  
that they don't have test modules hidden inside. It would similarly  
be a bad idea to simply ignore all import errors of packages, as then  
real errors may be silenced. This could be simply solvable via a  
special attribute like &quot;no_tests_in_packages= ['iocpreactor',  
'serialport']&quot; to twisted/internet/__init__ so trial knows not to  
bother trying to import those.

The other issue is that test files expecting to be imported as  
modules _still_ won't work if specified by filename. But, I think  
that's just a fact of life -- it is not possible in general to do the  
correct back conversion. AFAICT we will just have to accept this  
slight functionality loss and recommend that everybody specify module  
names rather than file names (at least for running twisted's tests --  
it's only broken when filenameToModuleName is wrong). Also, Trial  
*does* run the file specified even if it can't figure out how to  
import it, so if the test code doesn't actually depend on having its  
real module name (e.g. it doesn't use things like relative imports or  
__name__), it will also still work.

James


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011677.html">[Twisted-Python] Subproject releases
</A></li>
	<LI>Next message: <A HREF="011701.html">[Twisted-Python] Subproject releases
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11692">[ date ]</a>
              <a href="thread.html#11692">[ thread ]</a>
              <a href="subject.html#11692">[ subject ]</a>
              <a href="author.html#11692">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
