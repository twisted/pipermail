<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] question about threading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20question%20about%20threading&In-Reply-To=ED54CBDE-54CF-43A9-82AF-1B157A1F17FE%40bubblehouse.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="011769.html">
   <LINK REL="Next"  HREF="011768.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] question about threading</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20question%20about%20threading&In-Reply-To=ED54CBDE-54CF-43A9-82AF-1B157A1F17FE%40bubblehouse.org"
       TITLE="[Twisted-Python] question about threading">glyph at divmod.com
       </A><BR>
    <I>Tue Oct 25 11:27:51 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="011769.html">[Twisted-Python] Re: question about threading
</A></li>
        <LI>Next message: <A HREF="011768.html">[Twisted-Python] question about threading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11767">[ date ]</a>
              <a href="thread.html#11767">[ thread ]</a>
              <a href="subject.html#11767">[ subject ]</a>
              <a href="author.html#11767">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On Tue, 25 Oct 2005 11:05:21 -0400, Phil Christensen &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">phil at bubblehouse.org</A>&gt; wrote:
&gt;<i>hey folks,
</I>
Let me start from the other end of your message:

&gt;<i>the client object holds a reference to the protocol object, and  sendCommand 
</I>&gt;<i>basically just executes:
</I>&gt;<i>
</I>&gt;<i>         print &quot;Sending &quot; + message + &quot; to &quot; + str(self.protocol.source)
</I>&gt;<i>         self.protocol.transport.write(message + &quot;\0&quot;)
</I>          ^
The reactor is not thread safe, and thus this call to 'write' has undefined (and bad) behavior.  You _MUST_ use the reactor thread APIs; they're not optional conveniences, they're the only way you can use threads with Twisted :)

&gt;<i>i need to spawn a thread 
</I>
danger, danger will robinson.  Here is where your trouble started :).  Actually you *don't* need to spawn a thread, you need to spawn a process - twisted supports processes - and I can't guarantee that os.system will work properly from within a Twisted application.  Handling of SIGCHILD has proven to be a sticky wicket in the past.

&gt;<i>i know there's a bunch of reactor methods that deal with threads, but  i've 
</I>&gt;<i>never used them before, and i'm not sure which one will fix this  issue.&quot;
</I>
There are really only 2: callInThread and callFromThread.  There is a convenience API, twisted.internet.threads.deferToThread, which might be what you wanted, if what you wanted was in fact a thread.  However, you want spawnProcess in any event.  As I said, os.system may not work at _all_ from within Twisted, depending on your operating system.

&gt;<i>here's my thread subclass:
</I>
Don't subclass thread.  Twisted implements its own threadpool; use callInThread with what used to be your 'run' function.

&gt;<i>     def run(self):
</I>&gt;<i>         pres = event.getActivePresentation()
</I>&gt;<i>         t = datetime.datetime.now()
</I>&gt;<i>         base_name = 'sample-file-name'
</I>&gt;<i>         out_html = file('/tmp/' + base_name + '.html', 'w')
</I>&gt;<i>         # [snip snip snip]
</I>&gt;<i>         # write some html to the file
</I>&gt;<i>         out_html.close()
</I>          ^

          This bit could actually be threaded, if it's slow and blocking.  My suggestion: If it's for a demo, just block.

&gt;<i>         os.system('html2ps /tmp/' + base_name + '.html &gt; /tmp/' +  base_name 
</I>&gt;<i>+ '.ps')  # &gt; /tmp/' + base_name + '_ps.log')
</I>
Since reactor.spawnProcess might be a bit tedious for simply running this here, try this:

          twisted.internet.utils.getProcessOutput('/usr/bin/html2ps', ['html2ps', ...).addCallback(keepGoing)

&gt;<i>         os.system('mkdir data/transcripts/' + str(pres.id))
</I>          ^ UGH!  Why are you spawning another process here??  os.mkdir, please.
          
&gt;<i>         os.system('ps2pdf /tmp/' + base_name + '.ps data/ transcripts/' + 
</I>&gt;<i>str(pres.id) + '/' + base_name + '.pdf &gt; /tmp/' +  base_name + '_pdf.log')
</I>          ^ Another getProcessOutput here.  Return the resultant Deferred from within your keepGoing callback...

&gt;<i>         lock = threading.Lock()
</I>&gt;<i>         lock.acquire()
</I>          ^ Hooray, now you can forget about this garbage

&gt;<i>         self.client.sendCommand('presentTranscript', ['/ transcripts/' + 
</I>&gt;<i>str(pres.id) + '/' + base_name + '.pdf'])
</I>&gt;<i>         lock.release()
</I>          ^ Do this in the final callback of the Deferred that you've just created.

I hope this helped.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="011769.html">[Twisted-Python] Re: question about threading
</A></li>
	<LI>Next message: <A HREF="011768.html">[Twisted-Python] question about threading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#11767">[ date ]</a>
              <a href="thread.html#11767">[ thread ]</a>
              <a href="subject.html#11767">[ subject ]</a>
              <a href="author.html#11767">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
