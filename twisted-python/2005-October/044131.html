<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: [Twisted-commits] r14683 - Make the	toMainThread Queue unlimited in size, instead of max size 1.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20%5BTwisted-commits%5D%20r14683%20-%20Make%20the%0A%09toMainThread%20Queue%20unlimited%20in%20size%2C%20instead%20of%20max%20size%201.&In-Reply-To=%3C200510101106.24167.tdickenson%40devmail.geminidataloggers.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044130.html">
   <LINK REL="Next"  HREF="044166.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: [Twisted-commits] r14683 - Make the	toMainThread Queue unlimited in size, instead of max size 1.</H1>
    <B>Toby Dickenson</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Re%3A%20%5BTwisted-commits%5D%20r14683%20-%20Make%20the%0A%09toMainThread%20Queue%20unlimited%20in%20size%2C%20instead%20of%20max%20size%201.&In-Reply-To=%3C200510101106.24167.tdickenson%40devmail.geminidataloggers.co.uk%3E"
       TITLE="[Twisted-Python] Re: [Twisted-commits] r14683 - Make the	toMainThread Queue unlimited in size, instead of max size 1.">tdickenson at devmail.geminidataloggers.co.uk
       </A><BR>
    <I>Mon Oct 10 04:06:24 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044130.html">[Twisted-Python] Re: [Twisted-commits] r14683 - Make	thetoMainThread Queue unlimited in size, instead of max size 1. 
</A></li>
        <LI>Next message (by thread): <A HREF="044166.html">[Twisted-Python] Re: [Twisted-commits] r14683 - Make the	toMainThread Queue unlimited in size, instead of max size 1.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44131">[ date ]</a>
              <a href="thread.html#44131">[ thread ]</a>
              <a href="subject.html#44131">[ subject ]</a>
              <a href="author.html#44131">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Friday 07 October 2005 18:31, James Y Knight wrote:
&gt;<i> 
</I>&gt;<i> On Oct 7, 2005, at 11:05 AM, Stephen Thorne wrote:
</I>&gt;<i> &gt; Make the toMainThread Queue unlimited in size, instead of max size 1.
</I>&gt;<i> &gt; This can cause deadlocks.
</I>&gt;<i> 
</I>&gt;<i> Why does it cause deadlocks? 
</I>
I see one possible deadlock, but Im suprised you dont see other different 
symptoms first:

In the blocking select thread:
1. _doSelectInThread calls _sendToMain, it calls mainWaker to wake up the 
foreign event loop, then returns

In the main thread
2. some application code (?) calls doIteration
3. doIteration calls _sendToThread(_doIterationInThread
4. doIteration calls toMainThread.get(), expecting to block until 'its' 
iteration is complete. However it immediately receives the message sent in 
step 1.
5. doIteration returns
6. The foreign event loop gets round to calling _interleave because of the 
request sent in step 1.
7. _interleave calls toMainThread.get_nowait. This raises a Queue.Empty 
exception, which escapes up to the foreign event loop integration code.

In the blocking select thread

8. _doSelectInThread is called because of the request in step 3.
9. _doSelectInThread calls sendToMain. This never gets removed from the Queue.

At this point:

* The reactor is stalled indefinitely because _interleave raised an exception 
before it called _sendToThread(_doIterationInThread.

* Any subsequent calls to doIteration will cause _doThreadIteration to 
deadlock in sendToMain.


I believe the right solution involves replacing get_nowait with a regular get 
in _interleave.

I guess it is not a problem that doIteration sometimes does not perform a 
whole iteration. There has never been a guarantee about how much work is done 
each iteration of the reactor loop, right?



-- 
Toby Dickenson


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044130.html">[Twisted-Python] Re: [Twisted-commits] r14683 - Make	thetoMainThread Queue unlimited in size, instead of max size 1. 
</A></li>
	<LI>Next message (by thread): <A HREF="044166.html">[Twisted-Python] Re: [Twisted-commits] r14683 - Make the	toMainThread Queue unlimited in size, instead of max size 1.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44131">[ date ]</a>
              <a href="thread.html#44131">[ thread ]</a>
              <a href="subject.html#44131">[ subject ]</a>
              <a href="author.html#44131">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
