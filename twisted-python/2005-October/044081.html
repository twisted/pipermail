<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Unicode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Unicode&In-Reply-To=%3C20051004083757.3914.504871509.divmod.quotient.23801%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="044089.html">
   <LINK REL="Next"  HREF="044086.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Unicode</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Unicode&In-Reply-To=%3C20051004083757.3914.504871509.divmod.quotient.23801%40ohm%3E"
       TITLE="[Twisted-Python] Unicode">glyph at divmod.com
       </A><BR>
    <I>Tue Oct  4 02:37:57 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="044089.html">[Twisted-Python] Unicode
</A></li>
        <LI>Next message (by thread): <A HREF="044086.html">[Twisted-Python] Unicode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44081">[ date ]</a>
              <a href="thread.html#44081">[ thread ]</a>
              <a href="subject.html#44081">[ subject ]</a>
              <a href="author.html#44081">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 03 Oct 2005 18:19:44 -0600, Ken Kinder &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ken at kenkinder.com</A>&gt; wrote:

&gt;<i>The purpose of Python's unicode type is transparent exchange of string
</I>&gt;<i>objects, whether those string objects are of type str or type unicode.
</I>&gt;<i>Pretending that isn't so and raising a TypeError is not helpful. I would
</I>&gt;<i>urge you to AT LEAST provide a detailed explanation in that error,
</I>&gt;<i>explaining the philosophical disagreement you have with Python's
</I>&gt;<i>unicode-string conversion behavior and have a flag you can set to
</I>&gt;<i>disable that check.
</I>
&gt;<i>From <A HREF="http://docs.python.org/api/stringObjects.html:">http://docs.python.org/api/stringObjects.html:</A>
</I>
    &quot;Only string objects are supported; no Unicode objects should be passed.&quot;

So there is a precedent for this in the very APIs you are citing :).

You seem to have misunderstood the intent of Python's unicode support.  Python allows byte strings to be treated in the same way as character strings in the areas where such a transposition is useful and semantically valid; in some cases it (uncharacteristically) guesses based on the default encoding.  I say &quot;uncharacteristically&quot; because Python refuses the temptation to guess when presented with, say, an array object containing bytes, integers, or a list of smaller strings.  Automatic conversion is not the norm in Python.

I see others have already relayed you to the FAQ.  Please read the articles attached to it.

As long as I'm writing a list post about this though, let me include another example which may explain why this is an absolutely horrible idea.  There are basically 2 modes that .write() could use to accept a unicode object; one where it would cause random exceptions at runtime based on input, or one where it would generate corrupt data on the network.

Let's say I've got a very simple protocol that writes 2 bytes indicating the length of a string, then a string, like so:

 def writeChunk(self, x):
  self.transport.write(struct.pack(&quot;!H&quot;, len(x)))
  self.transport.write(x)

If 'x' were a unicode object in this case, we could do one of 2 things:

 A - Write it to the transport as UTF-8/UTF-16 (an encoding that can accept any unicode data)
 B - Write it to the transport using ascii/charmap (the default encoding, or an encoding that will only produce single-byte characters.

Given option A, this code will appear to work until it is passed a unicode string with a code point &gt; '\u00ff'.  At that point, the 'length' prefix will be incorrect; since len() works in terms of code points and not bytes, a phrase like u'Shoot me with a \u2022' will be truncated by the receiving end, possibly into a string which can't even be decoded:

&gt;&gt;&gt;<i> len(u'Shoot me with a \u2022')
</I>17
&gt;&gt;&gt;<i> len(u'Shoot me with a \u2022'.encode('utf8'))
</I>19
&gt;&gt;&gt;<i> len(u'Shoot me with a \u2022'.encode('utf16'))
</I>36
&gt;&gt;&gt;<i> u'Shoot me with a \u2022'.encode('utf16')[:17].decode('utf16')
</I>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in ?
  File &quot;/usr/lib/python2.4/encodings/utf_16.py&quot;, line 16, in decode
    return codecs.utf_16_decode(input, errors, True)
UnicodeDecodeError: 'utf16' codec can't decode byte 0x65 in position 16: truncated data


Using option B, we won't produce any invalid data on the network, but we will have to raise exceptions when presented with any *actual* unicode data (as opposed to just ASCII stuck into a unicode-type object):

&gt;&gt;&gt;<i> u'Shoot me with a \u2022'.encode()
</I>Traceback (most recent call last):
  File &quot;&lt;stdin&gt;&quot;, line 1, in ?
UnicodeEncodeError: 'ascii' codec can't encode character u'\u2022' in position 16: ordinal not in range(128)

In either case, simple tests where your code is passed english ASCII &quot;unicode&quot; strings will pass, but any actual exercise of unicode for the purpose it was designed (i.e. creating a clear distinction between transport encoding and character set) will fail horribly and possibly inexplicably.

I hope that now you can see why &quot;a flag you can set to disable that check&quot; could not possibly help anyone, and the code will remain as it is.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="044089.html">[Twisted-Python] Unicode
</A></li>
	<LI>Next message (by thread): <A HREF="044086.html">[Twisted-Python] Unicode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#44081">[ date ]</a>
              <a href="thread.html#44081">[ thread ]</a>
              <a href="subject.html#44081">[ subject ]</a>
              <a href="author.html#44081">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
