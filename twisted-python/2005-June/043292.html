<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Fwd: [Twisted-commits] r11032 - Made LineReceiver about 3x as fast, and clarified some of the docstrings.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Fwd%3A%20%5BTwisted-commits%5D%20r11032%20-%20Made%20LineReceiver%0A%20about%203x%20as%20fast%2C%20and%20clarified%20some%20of%20the%20docstrings.&In-Reply-To=%3C20050618185820.5047.1935189464.divmod.quotient.5049%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043294.html">
   <LINK REL="Next"  HREF="043295.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Fwd: [Twisted-commits] r11032 - Made LineReceiver about 3x as fast, and clarified some of the docstrings.</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Fwd%3A%20%5BTwisted-commits%5D%20r11032%20-%20Made%20LineReceiver%0A%20about%203x%20as%20fast%2C%20and%20clarified%20some%20of%20the%20docstrings.&In-Reply-To=%3C20050618185820.5047.1935189464.divmod.quotient.5049%40ohm%3E"
       TITLE="[Twisted-Python] Fwd: [Twisted-commits] r11032 - Made LineReceiver about 3x as fast, and clarified some of the docstrings.">exarkun at divmod.com
       </A><BR>
    <I>Sat Jun 18 12:58:20 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043294.html">[Twisted-Python] twisted.web2 0.1.0 released
</A></li>
        <LI>Next message (by thread): <A HREF="043295.html">[Twisted-Python] Fwd: [Twisted-commits] r11032 - Made	LineReceiver about 3x as fast, and clarified some of the docstrings.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43292">[ date ]</a>
              <a href="thread.html#43292">[ thread ]</a>
              <a href="subject.html#43292">[ subject ]</a>
              <a href="author.html#43292">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Begin forwarded message:

&gt;<i> From: James Knight &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">foom at wolfwood.twistedmatrix.com</A>&gt;
</I>&gt;<i> Date: Tue, 06 Jul 2004 13:53:09 -0600
</I>&gt;<i> To: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-commits at twistedmatrix.com</A>
</I>&gt;<i> Subject: [Twisted-commits] r11032 - Made LineReceiver about 3x as fast,
</I>	and clarified some of the docstrings.
&gt;<i> Reply-to: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>
</I>&gt;<i> 
</I>&gt;<i> Author: foom
</I>&gt;<i>Date: Tue Jul  6 13:53:08 2004
</I>&gt;<i>New Revision: 11032
</I>&gt;<i>
</I>&gt;<i>Modified:
</I>&gt;<i>   trunk/twisted/protocols/basic.py
</I>&gt;<i>Log:
</I>&gt;<i>Made LineReceiver about 3x as fast, and clarified some of the docstrings.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Modified: trunk/twisted/protocols/basic.py
</I>&gt;<i>==============================================================================
</I>&gt;<i>--- trunk/twisted/protocols/basic.py	(original)
</I>&gt;<i>+++ trunk/twisted/protocols/basic.py	Tue Jul  6 13:53:08 2004
</I>&gt;<i>@@ -204,24 +204,31 @@
</I>&gt;<i>         rawDataReceived, depending on mode.)
</I>&gt;<i>         &quot;&quot;&quot;
</I>&gt;<i>         self.__buffer = self.__buffer+data
</I>&gt;<i>+        lastoffset=0
</I>&gt;<i>         while self.line_mode:
</I>&gt;<i>-            try:
</I>&gt;<i>-                line, self.__buffer = self.__buffer.split(self.delimiter, 1)
</I>&gt;<i>-            except ValueError:
</I>&gt;<i>+            offset=self.__buffer.find(self.delimiter, lastoffset)
</I>&gt;<i>+            if offset == -1:
</I>&gt;<i>+                self.__buffer=self.__buffer[lastoffset:]
</I>&gt;<i>                 if len(self.__buffer) &gt; self.MAX_LENGTH:
</I>&gt;<i>-                    line, self.__buffer = self.__buffer, ''
</I>&gt;<i>+                    line=self.__buffer
</I>&gt;<i>+                    self.__buffer=''
</I>&gt;<i>                     return self.lineLengthExceeded(line)
</I>&gt;<i>                 break
</I>&gt;<i>-            else:
</I>&gt;<i>-                linelength = len(line)
</I>&gt;<i>-                if linelength &gt; self.MAX_LENGTH:
</I>&gt;<i>-                    line, self.__buffer = self.__buffer, ''
</I>&gt;<i>-                    return self.lineLengthExceeded(line)
</I>&gt;<i>-                why = self.lineReceived(line)
</I>&gt;<i>-                if why or self.transport and self.transport.disconnecting:
</I>&gt;<i>-                    return why
</I>&gt;<i>+
</I>&gt;<i>+            line=self.__buffer[lastoffset:offset]
</I>&gt;<i>+            lastoffset=offset+len(self.delimiter)
</I>&gt;<i>+
</I>&gt;<i>+            if len(line) &gt; self.MAX_LENGTH:
</I>&gt;<i>+                line=self.__buffer[lastoffset:]
</I>&gt;<i>+                self.__buffer=''
</I>&gt;<i>+                return self.lineLengthExceeded(line)
</I>&gt;<i>+            why = self.lineReceived(line)
</I>&gt;<i>+            if why or self.transport and self.transport.disconnecting:
</I>&gt;<i>+                self.__buffer = self.__buffer[lastoffset:]
</I>&gt;<i>+                return why
</I>&gt;<i>         else:
</I>&gt;<i>-            data, self.__buffer = self.__buffer, ''
</I>&gt;<i>+            data=self.__buffer[lastoffset:]
</I>&gt;<i>+            self.__buffer=''
</I>&gt;<i>             if data:
</I>&gt;<i>                 return self.rawDataReceived(data)
</I>&gt;<i>
</I>
This changes dataReceived to call down into user code while the LineReceiver's instance attributes are in an inconsistent state.  This can lead to duplicate data delivery if dataReceived is called into from lineReceived.  Normally this sounds like a ridiculous thing to do, but notice the implementation of resumeProducing():

     def resumeProducing(self):
         self.paused = False
         self.dataReceived('')
         self.transport.resumeProducing()

Since resumeProducing is called immediately when a producer is registered, this means LineReceivers can no longer register themselves as producers for their transports from lineReceived, which is a much more reasonable thing to do.

Demonstration of the bug in action attached.

Jp
-------------- next part --------------
A non-text attachment was scrubbed...
Name: linetest.py
Type: text/x-python
Size: 618 bytes
Desc: not available
URL: &lt;/pipermail/twisted-python/attachments/20050618/e47e28dd/attachment-0002.py&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043294.html">[Twisted-Python] twisted.web2 0.1.0 released
</A></li>
	<LI>Next message (by thread): <A HREF="043295.html">[Twisted-Python] Fwd: [Twisted-commits] r11032 - Made	LineReceiver about 3x as fast, and clarified some of the docstrings.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43292">[ date ]</a>
              <a href="thread.html#43292">[ thread ]</a>
              <a href="subject.html#43292">[ subject ]</a>
              <a href="author.html#43292">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
