<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Could I serve normal TCP and TLS services on	the same port?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Could%20I%20serve%20normal%20TCP%20and%20TLS%20services%20on%0A%09the%20same%20port%3F&In-Reply-To=%3C1118724252.5388.14.camel%40norbert%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043185.html">
   <LINK REL="Next"  HREF="043216.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Could I serve normal TCP and TLS services on	the same port?</H1>
    <B>Justin Warren</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Could%20I%20serve%20normal%20TCP%20and%20TLS%20services%20on%0A%09the%20same%20port%3F&In-Reply-To=%3C1118724252.5388.14.camel%40norbert%3E"
       TITLE="[Twisted-Python] Could I serve normal TCP and TLS services on	the same port?">daedalus at eigenmagic.com
       </A><BR>
    <I>Mon Jun 13 22:44:12 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043185.html">[Twisted-Python] Could I serve normal TCP and TLS services on the	same port?
</A></li>
        <LI>Next message (by thread): <A HREF="043216.html">[Twisted-Python] Could I serve normal TCP and TLS services on the	same port?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43215">[ date ]</a>
              <a href="thread.html#43215">[ thread ]</a>
              <a href="subject.html#43215">[ subject ]</a>
              <a href="author.html#43215">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 2005-06-10 at 16:14 +0800, Eric Hsu wrote:
&gt;<i> Hi Justin,
</I>&gt;<i> 
</I>&gt;<i> Thank you for you quick reply :)
</I>&gt;<i> 
</I>&gt;<i> &gt; What is the problem you are trying to solve here?
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I mean, in theory, yes, you could do what you're proposing. Why do you
</I>&gt;<i> &gt; want to, though?
</I>&gt;<i> 
</I>&gt;<i> I'm trying to write a TURN server:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://www.ietf.org/internet-drafts/draft-rosenberg-midcom-turn-07.txt">http://www.ietf.org/internet-drafts/draft-rosenberg-midcom-turn-07.txt</A>
</I>&gt;<i> 
</I>&gt;<i> The TURN client which is behind a NAT will ask the TURN server (with
</I>&gt;<i> public address) to allocate a public transport address for it to
</I>&gt;<i> receive data from outside.
</I>&gt;<i> 
</I>&gt;<i> There're two requests while the client trying to allocate a public
</I>&gt;<i> transport address from the TURN server:
</I>&gt;<i>  * Share Secret Request: over TLS; to obtain a one-time username and
</I>&gt;<i> passwd and keep the passwd as the share secret of both side (the
</I>&gt;<i> server and the client)
</I>&gt;<i>  * Allocate Request: to allocate a public transport address from the server
</I>&gt;<i> 
</I>&gt;<i> As the draft said:
</I>&gt;<i> 
</I>&gt;<i> &quot;A TURN server MUST be prepared to receive  Binding (should be
</I>&gt;<i> Allocate - eric) Requests over TCP and UDP.&quot; (P10)
</I>&gt;<i> 
</I>&gt;<i> &quot;The Allocate Request MUST be sent to the same IP address and port as the Shared
</I>&gt;<i> Secret Request. This is because one time passwords are expected to be
</I>&gt;<i> host-specific.&quot; (P20)
</I>&gt;<i> 
</I>&gt;<i> That means both the Share Secret Request (over TLS) and Allocate
</I>&gt;<i> Request will be sent to the same IP and port of the server.
</I>&gt;<i> 
</I>&gt;<i> Then, the draft said:
</I>&gt;<i> 
</I>&gt;<i> &quot;The client SHOULD close its connection when it has completed
</I>&gt;<i> allocating username and passwords.&quot; (P19)
</I>
Ok, so you shut down the session here.

&gt;<i> So, while the client sends the Allocate Request to the server over
</I>&gt;<i> TCP, the process would look like this (assuming the server is
</I>&gt;<i> listening on port 12345 for TLS connection):
</I>&gt;<i> 
</I>&gt;<i> * the client sends the Share Secret Request to server:12345 _over TLS_
</I>&gt;<i> and obtains a one-time username and passwd
</I>&gt;<i> * the client closes the TLS connection
</I>&gt;<i> * the client sends the Allocate Request to server:12345 _again_ to
</I>&gt;<i> allocate a public transport address...
</I>
My reading of this (without having read the actual RFC) would result in
this kind of sequence:

C: connect to server via TCP
S: accept connection
C/S: start TLS
-- TLS negotiation happens --
C: Share Secret Request
S: gives out one time username/password
C: cool! thanks!
S: close connection

So the TCP session actually gets shut down here. The client then does
the Allocate Request, presumably using the username/password combo it
got before.

C: connect to server via TCP
S: accept connection
C: Allocate request
... and so on.

&gt;<i> It seems that I have to implement what I've mentioned in my previous mail?
</I>&gt;<i> I'm not a native English speaker, and TURN is only a draft, maybe I've
</I>&gt;<i> misunderstood something?
</I>
So you SHOULD be closing the connection after doing the username and
password allocation, which I'm reading as being within the TLS session.
This means the shutdown of TLS happens when the TCP connection is ended.
The next connection will be standard bare TCP.

This means all you have to do is work out how to turn TLS *on* when you
get a TCP connection. You don't have to work out how to turn it off
within the same TCP session, because you actually end the session and
reconnect. Much easier. :)

-- 
Justin Warren &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">daedalus at eigenmagic.com</A>&gt;



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043185.html">[Twisted-Python] Could I serve normal TCP and TLS services on the	same port?
</A></li>
	<LI>Next message (by thread): <A HREF="043216.html">[Twisted-Python] Could I serve normal TCP and TLS services on the	same port?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43215">[ date ]</a>
              <a href="thread.html#43215">[ thread ]</a>
              <a href="subject.html#43215">[ subject ]</a>
              <a href="author.html#43215">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
