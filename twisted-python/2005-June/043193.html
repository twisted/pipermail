<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twistd stopService processing question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twistd%20stopService%20processing%20question&In-Reply-To=%3C1118443646.6958.15.camel%40linux.site%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043203.html">
   <LINK REL="Next"  HREF="043196.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twistd stopService processing question</H1>
    <B>Ross Jekel</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twistd%20stopService%20processing%20question&In-Reply-To=%3C1118443646.6958.15.camel%40linux.site%3E"
       TITLE="[Twisted-Python] twistd stopService processing question">ross at sourcelabs.com
       </A><BR>
    <I>Fri Jun 10 16:47:26 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043203.html">[Twisted-Python] Problem: spawnProcess() never ending when	installSignalHandlers=False
</A></li>
        <LI>Next message (by thread): <A HREF="043196.html">[Twisted-Python] Using lineReceived with HTTP requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43193">[ date ]</a>
              <a href="thread.html#43193">[ thread ]</a>
              <a href="subject.html#43193">[ subject ]</a>
              <a href="author.html#43193">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am building and xmlBlaster XML-RPC client/server to interact with the
xmlBlaster server. xmlBlaster really works best if the client sends a
disconnect API call before shutting down, otherwise you sometimes won't
be able to reconnect the client until the next heartbeat timesout.

I thought the best place way to do this would be to create a simple
service that could get notified via stopService(), then return the
deferred from the xmlrpc.Proxy.callRemote function for the XML-RPC
xmlBlaster disconnect API call.

The issue is that if I do this, everything seems to work but I get this
error raised when I ^C my service:

2005/06/10 15:30 PDT [QueryProtocol,client] Traceback (most recent call
last):
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/defer.py&quot;, line
328, in _runCallbacks
            self.result = callback(self.result, *args, **kw)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/base.py&quot;, line
384, in _cbContinueSystemEvent
            self._continueSystemEvent(eventType)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/base.py&quot;, line
392, in _continueSystemEvent
            callable(*args, **kw)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/base.py&quot;, line
353, in disconnectAll
            failure.Failure(main.CONNECTION_LOST))
        --- &lt;exception caught here&gt; ---
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/python/log.py&quot;, line 56,
in callWithLogger
            return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/python/log.py&quot;, line 41,
in callWithContext
            return context.call({ILogContext: newCtx}, func, *args,
**kw)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/python/context.py&quot;, line
52, in callWithContext
            return self.currentContext().callWithContext(ctx, func,
*args, **kw)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/python/context.py&quot;, line
31, in callWithContext
            return func(*args,**kw)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/tcp.py&quot;, line
557, in connectionLost
            self.connector.connectionLost(reason)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/base.py&quot;, line
655, in connectionLost
            self.factory.clientConnectionLost(self, reason)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/web/xmlrpc.py&quot;, line
294, in clientConnectionLost
            self.deferred.errback(reason)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/defer.py&quot;, line
276, in errback
            self._startRunCallbacks(fail)
          File
&quot;/usr/local/lib/python2.4/site-packages/twisted/internet/defer.py&quot;, line
303, in _startRunCallbacks
            raise AlreadyCalledError
        twisted.internet.defer.AlreadyCalledError:

I suppose I can probably ignore this but it makes it look like my
service isn't shutting down cleanly.

Any advice here? I include code snippets below to give you an idea what
I'm doing.

Ross

class SimpleService(service.Service):
    def stopService(self):
        global blaster
        return blaster.disconnect().addCallback(
            lambda res: service.Service.stopService(self))


# Create the application
a = service.Application(&quot;SMTP Server&quot;)

# Create a service wrapper so we can get notified of stopService
SimpleService().setServiceParent(service.IServiceCollection(a))

# Create an XML-RPC client/server for xmlBlaster
# TODO - come up with better server site creation
print 'INFO; Creating XML-RPC client/server'
s = SimpleSite()
blaster = xmlBlaster.xmlBlaster('<A HREF="http://127.0.0.2:8080">http://127.0.0.2:8080</A>', s)
internet.TCPServer(blaster.serverPort,
  server.Site(s)).setServiceParent(a)


xmlBlaster looks like this:

class xmlBlaster(xmlrpc.Proxy, xmlrpc.XMLRPC):
    def __init__(self, url, parent, serverPort = 7080):
        xmlrpc.Proxy.__init__(self, url)
        xmlrpc.XMLRPC.__init__(self)
        self.orig_url = url
        self.sessionId = None
        self.serverPort = serverPort
        self.subscriptions = {}
        parent.putChild('RC2', self)

    def disconnect(self):
        return self.callRemote('authenticate.disconnect',
            self.sessionId,
            &quot;&lt;qos/&gt;).addCallback(self.__cbDisconnected)

    def __cbDisconnected(self, result):
        self.sessionId = None




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043203.html">[Twisted-Python] Problem: spawnProcess() never ending when	installSignalHandlers=False
</A></li>
	<LI>Next message (by thread): <A HREF="043196.html">[Twisted-Python] Using lineReceived with HTTP requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43193">[ date ]</a>
              <a href="thread.html#43193">[ thread ]</a>
              <a href="subject.html#43193">[ subject ]</a>
              <a href="author.html#43193">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
