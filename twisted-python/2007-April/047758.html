<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] The Trial of the DirtyReactorError
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20The%20Trial%20of%20the%20DirtyReactorError&In-Reply-To=%3C733E34B2-A470-4ABE-9B3F-AC1C789DF719%40zgroupplc.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="047756.html">
   <LINK REL="Next"  HREF="047760.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] The Trial of the DirtyReactorError</H1>
    <B>Matthew Glubb</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20The%20Trial%20of%20the%20DirtyReactorError&In-Reply-To=%3C733E34B2-A470-4ABE-9B3F-AC1C789DF719%40zgroupplc.com%3E"
       TITLE="[Twisted-Python] The Trial of the DirtyReactorError">matt at zgroupplc.com
       </A><BR>
    <I>Fri Apr 13 03:15:28 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="047756.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
        <LI>Next message (by thread): <A HREF="047760.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47758">[ date ]</a>
              <a href="thread.html#47758">[ thread ]</a>
              <a href="subject.html#47758">[ subject ]</a>
              <a href="author.html#47758">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Hi All,

Following on from my DirtyReactorError errors whilst running unit  
tests under trial I opted, as glyph suggested, to call listenTCP  
inside the ServerFactory in order to keep track of the port and shut  
it down cleanly.

On 12 Apr 2007, at 19:56, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A> wrote:

&gt;<i> If they are &quot;always shut down&quot;, what event currently shuts them  
</I>&gt;<i> down? Have your test trigger that event.  If they're one-shot, then  
</I>&gt;<i> perhaps the method that calls listenTCP should be on the factory  
</I>&gt;<i> itself, making it even easier to keep track of the Port instance it  
</I>&gt;<i> is associated with.
</I>
This causes me a problem. When a client connection is lost, I want to  
shutdown the server. The only way that I can see to do this is by the  
connectionLost event calling a method in my ServerFactory that shuts  
down the listening port:

class Echo(basic.LineOnlyReceiver):

     def connectionLost(self, reason):
         self.factory.shutdown(reason)

class EchoServerFactory(protocol.ServerFactory):
     protocol = Echo
     port = None

     def __init__(self, port):
         self.port = reactor.listenTCP(port, self)

     def shutdown(self, reason):
         self.port.stopListening()

*However*, this results in the following error:

twisted.trial.util.PendingTimedCallsError: pendingTimedCalls still  
pending (consider setting twisted.internet.base.DelayedCall.debug =  
True): &lt;DelayedCall 24706704 [-0.00161504745483s] called=0  
cancelled=0 Port.connectionLost(&lt;twisted.python.failure.Failure  
&lt;class 'twisted.internet.error.ConnectionDone'&gt;&gt;)

Obviously, tcp.Port.stopListening() results in the  
Echo.connectionLost event being triggered, which in turn calls  
EchoServerFactory.shutdown(), which triggers an additional  
Echo.connectionLost event. It seems that tcp.Port.connected is not  
being updated quickly enough to prevent the additional pendingTimedCalls

My question therefore is how is it possible to cleanly shut down a  
server when a client connection is lost?

Apologies if I am being a complete idiot about this. I am still a  
relatively twisted newbie ;)

Regards,

Matt


m a t t h e w   g l u b b

________________________________________________________________________
Z Group PLC

Tel: +44 (0) 8700 111 173
Fax: +44 (0) 8707 051 393
Txt: +44 (0) 7800 140 877
Web: &lt;<A HREF="http://www.zgroupplc.com/">http://www.zgroupplc.com/</A>&gt;

This  email  and  any  files  transmitted  with it are  confidential and
intended solely for the use of the individual or entity to whom they are
addressed.  The opinions  expressed in this mail are those of the author
and do not necessarily  represent the views of the company.  If you have
received this email in error please notify &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">service at zgroupplc.com</A>&gt;



-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.1 (Darwin)

iD8DBQFGH0ozyI6MkdKPngkRAk0xAJ0ZmZk6FsRAkrzP2WJYy4lrIOvJiACeJSwP
AEAEWw/w2vexi4AHOqdba4M=
=NSmv
-----END PGP SIGNATURE-----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="047756.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
	<LI>Next message (by thread): <A HREF="047760.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47758">[ date ]</a>
              <a href="thread.html#47758">[ thread ]</a>
              <a href="subject.html#47758">[ subject ]</a>
              <a href="author.html#47758">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
