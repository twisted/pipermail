<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] The Trial of the DirtyReactorError
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20The%20Trial%20of%20the%20DirtyReactorError&In-Reply-To=733E34B2-A470-4ABE-9B3F-AC1C789DF719%40zgroupplc.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015250.html">
   <LINK REL="Next"  HREF="015253.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] The Trial of the DirtyReactorError</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20The%20Trial%20of%20the%20DirtyReactorError&In-Reply-To=733E34B2-A470-4ABE-9B3F-AC1C789DF719%40zgroupplc.com"
       TITLE="[Twisted-Python] The Trial of the DirtyReactorError">exarkun at divmod.com
       </A><BR>
    <I>Fri Apr 13 11:22:05 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015250.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
        <LI>Next message: <A HREF="015253.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15252">[ date ]</a>
              <a href="thread.html#15252">[ thread ]</a>
              <a href="subject.html#15252">[ subject ]</a>
              <a href="author.html#15252">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 13 Apr 2007 10:15:28 +0100, Matthew Glubb &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">matt at zgroupplc.com</A>&gt; wrote:
&gt;<i>-----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i>Hash: SHA1
</I>&gt;<i>
</I>&gt;<i>Hi All,
</I>&gt;<i>
</I>&gt;<i>Following on from my DirtyReactorError errors whilst running unit  tests 
</I>&gt;<i>under trial I opted, as glyph suggested, to call listenTCP  inside the 
</I>&gt;<i>ServerFactory in order to keep track of the port and shut  it down cleanly.
</I>&gt;<i>
</I>&gt;<i>On 12 Apr 2007, at 19:56, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A> wrote:
</I>&gt;&gt;<i>If they are &quot;always shut down&quot;, what event currently shuts them  down? Have 
</I>&gt;&gt;<i>your test trigger that event.  If they're one-shot, then  perhaps the 
</I>&gt;&gt;<i>method that calls listenTCP should be on the factory  itself, making it 
</I>&gt;&gt;<i>even easier to keep track of the Port instance it  is associated with.
</I>&gt;<i>
</I>&gt;<i>This causes me a problem. When a client connection is lost, I want to 
</I>&gt;<i>shutdown the server. The only way that I can see to do this is by the 
</I>&gt;<i>connectionLost event calling a method in my ServerFactory that shuts  down 
</I>&gt;<i>the listening port:
</I>&gt;<i>
</I>&gt;<i>class Echo(basic.LineOnlyReceiver):
</I>&gt;<i>
</I>&gt;<i>     def connectionLost(self, reason):
</I>&gt;<i>         self.factory.shutdown(reason)
</I>&gt;<i>
</I>&gt;<i>class EchoServerFactory(protocol.ServerFactory):
</I>&gt;<i>     protocol = Echo
</I>&gt;<i>     port = None
</I>&gt;<i>
</I>&gt;<i>     def __init__(self, port):
</I>&gt;<i>         self.port = reactor.listenTCP(port, self)
</I>&gt;<i>
</I>&gt;<i>     def shutdown(self, reason):
</I>&gt;<i>         self.port.stopListening()
</I>&gt;<i>
</I>&gt;<i>*However*, this results in the following error:
</I>&gt;<i>
</I>&gt;<i>twisted.trial.util.PendingTimedCallsError: pendingTimedCalls still  pending 
</I>&gt;<i>(consider setting twisted.internet.base.DelayedCall.debug =  True): 
</I>&gt;<i>&lt;DelayedCall 24706704 [-0.00161504745483s] called=0  cancelled=0 
</I>&gt;<i>Port.connectionLost(&lt;twisted.python.failure.Failure  &lt;class 
</I>&gt;<i>'twisted.internet.error.ConnectionDone'&gt;&gt;)
</I>&gt;<i>
</I>&gt;<i>Obviously, tcp.Port.stopListening() results in the  Echo.connectionLost 
</I>&gt;<i>event being triggered, which in turn calls  EchoServerFactory.shutdown(), 
</I>&gt;<i>which triggers an additional  Echo.connectionLost event. It seems that 
</I>&gt;<i>tcp.Port.connected is not  being updated quickly enough to prevent the 
</I>&gt;<i>additional pendingTimedCalls
</I>&gt;<i>
</I>
Port.stopListening can return a Deferred if shutdown is not immediately
completed.  In this case, you need to have trial wait for this Deferred
to fire before letting the test finish.  Also, Port.stopListening does
not cause Echo.connectionLost to be called.  Shutting down a port only
prevents new connections from being made to it, it does not disconnect
any existing connections.  Even if it did, it would be a bug if it gave
duplication connection lost notifications to any protocol. ;)

&gt;<i>My question therefore is how is it possible to cleanly shut down a  server 
</I>&gt;<i>when a client connection is lost?
</I>
You might also consider disabling the port when the connection is /made/.
This reduces the size of the window available for a second connection to
be made, and as I mentioned above, has no affect on the already-established
connection.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015250.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
	<LI>Next message: <A HREF="015253.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15252">[ date ]</a>
              <a href="thread.html#15252">[ thread ]</a>
              <a href="subject.html#15252">[ subject ]</a>
              <a href="author.html#15252">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
