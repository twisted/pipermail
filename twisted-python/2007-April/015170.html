<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Synchronization techniques
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Synchronization%20techniques&In-Reply-To=E0987C5F-E9A2-4AF6-B504-BACB97F637A4%40keystonewood.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015169.html">
   <LINK REL="Next"  HREF="015171.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Synchronization techniques</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Synchronization%20techniques&In-Reply-To=E0987C5F-E9A2-4AF6-B504-BACB97F637A4%40keystonewood.com"
       TITLE="[Twisted-Python] Synchronization techniques">glyph at divmod.com
       </A><BR>
    <I>Thu Apr  5 11:47:50 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015169.html">[Twisted-Python] Synchronization techniques
</A></li>
        <LI>Next message: <A HREF="015171.html">[Twisted-Python] Synchronization techniques
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15170">[ date ]</a>
              <a href="thread.html#15170">[ thread ]</a>
              <a href="subject.html#15170">[ subject ]</a>
              <a href="author.html#15170">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01:53 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">daniel at keystonewood.com</A> wrote:
&gt;<i>On Apr 5, 2007, at 5:53 AM, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A> wrote:
</I>&gt;&gt;<i> &gt;&gt;I'm afraid that the feature you want doesn't make any sense and  is, 
</I>&gt;&gt;<i>in a
</I>&gt;&gt;<i> &gt;&gt;broad sense, impossible.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;Maybe it's impossible for you to see things the way I see them 
</I>&gt;&gt;<i>because you
</I>&gt;&gt;<i> &gt;have become drunk on Twisted Kool-Aide.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>You are making it sound like you are bringing a fresh new idea to  the 
</I>&gt;&gt;<i>discussion here, which I've never heard before and am unwilling  to 
</I>&gt;&gt;<i>consider because I'm inflexible in my thinking.  That's not  what's 
</I>&gt;&gt;<i>happening.
</I>&gt;<i>
</I>&gt;<i>I'm sorry I wrote that...it was inflammatory and did not bring any 
</I>&gt;<i>value to the conversation. Please accept my apology.
</I>
Thank you, I very much appreciate the sentiment!  I'm glad to see you 
also only quoted the actually useful / productive parts of my response 
too ;).
&gt;<i>The external &quot;blocking&quot; resource is just a shell script that takes 
</I>&gt;<i>some time t run. It does not acquire any shared resources that would 
</I>&gt;<i>result in dead lock and it will always return (maybe with an error, 
</I>&gt;<i>but it will return) unless something terrible happens (e.g. plug is 
</I>&gt;<i>pulled on server, fire, etc.).
</I>
I thought I understood what was going on, but now I'm confused again. 
Why do you need mutual exclusion at all if it doesn't acquire any shared 
resources?  Couldn't you just run it concurrently?
&gt;<i>It would be more maintainable because it would look just like normal 
</I>&gt;<i>sequential python code:
</I>
Yes, it would *look* like sequential python code.  But it wouldn't be 
:<i>).  There's a heck of a lot that can happen in acquire(); your whole 
</I>application could run for ten minutes on that one line of code.  Worst 
of all, it would only happen in extreme situations, so testing or 
debugging issues that are caused by it becomes even more difficult.

&lt;snip blocking code&gt;
&gt;<i>This is very simple and very easy to maintain. It could be written 
</I>&gt;<i>with inlineCallbacks fairly easily as well:
</I>&gt;<i>
</I>&gt;<i>yield lock.acquire()
</I>&gt;<i>try:
</I>&gt;<i>     yield process.check_call(...)
</I>&gt;<i>     yeild process.check_call(...)
</I>&gt;<i>finally:
</I>&gt;<i>     lock.release()
</I>&gt;<i>
</I>&gt;<i>That's pretty nice (so nice I might just rewrite my code that way).
</I>
I'm glad you think so.  I was originally not too happy about 
inlineCallbacks (its predecessors did not do so well) but I keep seeing 
examples like this which it makes look much nicer.
&gt;<i>My complaint is that the code must have knowledge of the twisted 
</I>&gt;<i>environment (why else would it yield the result of process.check_call 
</I>&gt;<i>()?). I do not really see the conceptual difference between these two 
</I>&gt;<i>code blocks except one yields to and one calls into the reactor event 
</I>&gt;<i>loop. Is there some other inherent problem with the first example? Of 
</I>&gt;<i>course you need to make sure that the code inside the try/finally 
</I>&gt;<i>block does not try to acquire the lock again, but that's a basic 
</I>&gt;<i>concurrency problem which can even happen in the next example.
</I>
This is really the key thing.  If you're running your code in the 
Twisted environment, and you want it to be correct, it really must know 
about the Twisted environment.  The simple presence of the 'yield' 
keyword at every level where a Deferred is being returned forces you to 
acknowledge, &quot;yes, I know that a context switch may occur here&quot;. 
Without it, any function could suddenly and radically change the 
assumptions that all of its callers were allowed to make.
&gt;<i>Moving on, in a fully deferred world we have this:
</I>
&lt;snip ugly stuff&gt;
&gt;<i>... you get the picture.
</I>&gt;<i>
</I>&gt;<i>Notice the code to acquire/release the lock--there are three  different 
</I>&gt;<i>calls to lock.release() in there, and they all must be  carefully 
</I>&gt;<i>sorted out to make sure that exactly one of them will be  called in any 
</I>&gt;<i>given scenario --that's hard to maintain.
</I>
There are other ways to deal with that.  maybeDeferred, for example, 
will make sure you always get a Deferred back and that it looks vaguely 
correct.
&gt;<i>Right, that would work and that's exactly what subprocess.check_call () 
</I>&gt;<i>(the real python built-in version) would do. Unfortunately twisted 
</I>&gt;<i>does not work with the subprocess module--spawnProcess() is the only 
</I>&gt;<i>alternative I found that actually works and that means I have to use  a 
</I>&gt;<i>deferred.
</I>
The only thing I have to say about that is:
    <A HREF="http://twistedmatrix.com/trac/ticket/733">http://twistedmatrix.com/trac/ticket/733</A>
&gt;&gt;<i>Another solution here would be for Twisted to have a nice  convenience 
</I>&gt;&gt;<i>API for dispatching tasks to a process pool.  Right now  setting up a 
</I>&gt;&gt;<i>process pool is conceptually easy but mechanically  difficult; you 
</I>&gt;&gt;<i>have to do a lot of typing and make a lot of  irrelevant decisions 
</I>&gt;&gt;<i>(AMP or PB or pickle? stdio or sockets?).
</I>&gt;<i>
</I>&gt;<i>That sounds nice.
</I>
Something I'd be doing in my copious spare time, if I had any.
&gt;<i>I understand that PB is fully symmetrical. In my case I am only using 
</I>&gt;<i>half (client makes request, server responds). Would it make sense to 
</I>&gt;<i>relax the constraints when PB is used in this way?
</I>
I don't know if it would be feasible to do the work required for PB, due 
to other, less fundamental implementation issues.  However, it was a 
design goal of AMP that it be possible to implement a &quot;naive&quot;, only-a 
-few-lines-of-Python version for drop-in ease-of-use comparable to 
XMLRPC while still providing the actual &quot;good&quot; version in Twisted 
itself.  I have heard rumors to the effect that Eric Mangold actually 
wrote such a thing, but I don't know where it is.
&gt;&gt;<i>#2545.
</I>&gt;<i>
</I>&gt;<i>This looks very interesting. I'll try to help out with this effort if 
</I>&gt;<i>I can find some time.
</I>
Thanks.
&gt;<i>Thanks for taking time to read my ramblings and understand the 
</I>&gt;<i>problems that I am having (even if we don't quite agree on the 
</I>&gt;<i>simplest solutions). Your input is valuable, and I am indebted to you 
</I>&gt;<i>for providing free support in your spare time.
</I>
Thanks very much for taking the time to acknowledge this.  You leave me 
here with the impression that writing these emails was time well spent. 
And, thanks in advance for working on any of those tickets I gave you 
links to ;-).
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20070405/da4f9e94/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20070405/da4f9e94/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015169.html">[Twisted-Python] Synchronization techniques
</A></li>
	<LI>Next message: <A HREF="015171.html">[Twisted-Python] Synchronization techniques
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15170">[ date ]</a>
              <a href="thread.html#15170">[ thread ]</a>
              <a href="subject.html#15170">[ subject ]</a>
              <a href="author.html#15170">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
