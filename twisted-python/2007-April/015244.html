<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> Trial adbapi tip. Was: [Twisted-Python] The Trial of the	DirtyReactorError
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Trial%20adbapi%20tip.%20Was%3A%20%5BTwisted-Python%5D%20The%20Trial%20of%20the%0A%09DirtyReactorError&In-Reply-To=B88241EF-A5CF-4E90-A972-F3250E7E6ABD%40zgroupplc.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015253.html">
   <LINK REL="Next"  HREF="015254.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>Trial adbapi tip. Was: [Twisted-Python] The Trial of the	DirtyReactorError</H1>
    <B>Justin Warren</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Trial%20adbapi%20tip.%20Was%3A%20%5BTwisted-Python%5D%20The%20Trial%20of%20the%0A%09DirtyReactorError&In-Reply-To=B88241EF-A5CF-4E90-A972-F3250E7E6ABD%40zgroupplc.com"
       TITLE="Trial adbapi tip. Was: [Twisted-Python] The Trial of the	DirtyReactorError">daedalus at eigenmagic.com
       </A><BR>
    <I>Thu Apr 12 19:35:41 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015253.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
        <LI>Next message: <A HREF="015254.html">[Twisted-Python] Implementing an event manager in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15244">[ date ]</a>
              <a href="thread.html#15244">[ thread ]</a>
              <a href="subject.html#15244">[ subject ]</a>
              <a href="author.html#15244">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 2007-04-12 at 17:53 +0100, Matthew Glubb wrote:
&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i> 
</I>&gt;<i> Hi All,
</I>&gt;<i> 
</I>&gt;<i> I have to say that I am largely getting along famously with Twisted  
</I>&gt;<i> (and Python) now.
</I>&gt;<i> 
</I>&gt;<i> I have started writing unit tests for my application and when I run  
</I>&gt;<i> them using trial I sometimes get DirtyReactorErrors ('reactor left in  
</I>&gt;<i> unclean state'). This is a nice error. It tells me that I am not  
</I>&gt;<i> shutting down resources correctly which would otherwise be left  
</I>&gt;<i> hanging around and be difficult to debug.
</I>
On this note, I have a little tip to anyone new to writing Trial tests,
as I am:

If you use adbapi to talk to a database, be aware that it uses a
threadpool in order to make something that is synchronous into something
asynchronous. In an ordinary program, the threadpool is started and shut
down for you by the reactor, but it probably won't be in your tests
because of the way the reactor works with trial. I am using a
twisted.enterprise.adbapi.ConnectionPool, for example.

What you need is to call ConnectionPool.start() from within your
unittest setUp(), and to call ConnectionPool.close() in tearDown(). This
explicitly starts and stops the threadpool at the appropriate times.
&gt;<i>From memory, the start() will kindof automatically get called when you
</I>set up the object, but close() will not. If you don't explicitly call
close(), trial will 'hang' because it's actually waiting for the
threadpool to exit, which never happens. You don't get a 'reactor left
in unclean state' error.

I hope that saves someone the couple of hours of head scratching and
reading code that I went through.

-- 
Justin Warren &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">daedalus at eigenmagic.com</A>&gt;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015253.html">[Twisted-Python] The Trial of the DirtyReactorError
</A></li>
	<LI>Next message: <A HREF="015254.html">[Twisted-Python] Implementing an event manager in twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15244">[ date ]</a>
              <a href="thread.html#15244">[ thread ]</a>
              <a href="subject.html#15244">[ subject ]</a>
              <a href="author.html#15244">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
