<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Synchronization techniques
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Synchronization%20techniques&In-Reply-To=%3C20070404174302.7769.1269595541.divmod.xquotient.2072%40joule.divmod.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="047663.html">
   <LINK REL="Next"  HREF="047670.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Synchronization techniques</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Synchronization%20techniques&In-Reply-To=%3C20070404174302.7769.1269595541.divmod.xquotient.2072%40joule.divmod.com%3E"
       TITLE="[Twisted-Python] Synchronization techniques">glyph at divmod.com
       </A><BR>
    <I>Wed Apr  4 11:43:02 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="047663.html">[Twisted-Python] Re: Synchronization techniques
</A></li>
        <LI>Next message (by thread): <A HREF="047670.html">[Twisted-Python] Synchronization techniques
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47659">[ date ]</a>
              <a href="thread.html#47659">[ thread ]</a>
              <a href="subject.html#47659">[ subject ]</a>
              <a href="author.html#47659">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 04:35 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">daniel at keystonewood.com</A> wrote:
&gt;<i>On Apr 3, 2007, at 8:42 PM, Itamar Shtull-Trauring wrote:
</I>&gt;&gt;<i>On Tue, 2007-04-03 at 17:07 -0400, Daniel Miller wrote:
</I>&gt;&gt;&gt;&gt;<i>twisted.internet.defer.DeferredLock and some of the related classes
</I>&gt;&gt;&gt;&gt;<i>are
</I>&gt;&gt;&gt;&gt;<i>what you ought to be using.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Unfortunately that only gets me half way there. DeferredLock.acquire
</I>&gt;&gt;&gt;<i>() returns a deferred. How do I return the result of a deferred from
</I>&gt;&gt;&gt;<i>a PB remote_xxx() function?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Just return the Deferred from the remote_xxx() function.
</I>&gt;<i>
</I>&gt;<i>Thanks, I didn't know I could return a deferred from a PB remote_xxx () 
</I>&gt;<i>method. That detail doesn't seem to be documented in the  Perspective 
</I>&gt;<i>Broker documentation, which I have read quite a few  times.
</I>
The PB documentation is not too great.  Perhaps this paper would be 
helpful to you, if you haven't seen it:

<A HREF="http://www.lothar.com/tech/papers/PyCon-2003/pb-pycon/pb.html#auto7">http://www.lothar.com/tech/papers/PyCon-2003/pb-pycon/pb.html#auto7</A>

    &quot;&quot;&quot;
    In addition, the remote method can itself return a Deferred instead 
of an
    actual return value. When that Deferreds fires, the data given to the
    callback will be serialized and returned to the original caller.
    &quot;&quot;&quot;
&gt;<i>Maybe this could be highlighted in the &quot;Complete Example&quot; [0]  section 
</I>&gt;<i>of the PB usage documentation? The examples use the  TwistedQuotes 
</I>&gt;<i>application, and the IQuoter.getQuote() method always  returns a string 
</I>&gt;<i>(at least I couldn't find any implementations that  return a deferred).
</I>
Please feel free to write some patches for the documentation, or open a 
doc bug describing this issue in more detail.  It's definitely an under- 
documented feature of PB.
&gt;<i>However, that would require rewriting most if not  all implementations 
</I>&gt;<i>of IQuoter to return deferred's and/or the code  that calls 
</I>&gt;<i>IQuoter.getQuote(), which demonstrates the viral nature of  twisted 
</I>&gt;<i>when used in conjunction with other libraries.
</I>
I don't think that would really be the terrible burden that you suggest, 
considering the relatively small amount of tutorial documentation that 
implements or calls IQuoter.  One could also propose a separate 
interface, IDeferredQuoter, to make the distinction clearer.
&gt;<i>So anyway, I rewrote my server-side library to do it the twisted way 
</I>&gt;<i>and return deferred's instead trying rig up some way of waiting for 
</I>&gt;<i>them. I still think it would be super useful to be able to pseudo- 
</I>&gt;<i>block on a deferred (i.e. allow the reactor to process other events 
</I>&gt;<i>while waiting for the deferred). It is very annoying to have to 
</I>&gt;<i>rewrite many layers of code when twisted is introduced into a  program. 
</I>&gt;<i>I did find gthreadless.py, and maybe that would do it.  Unfortunately 
</I>&gt;<i>discussion on that seems to have been dropped some time  ago...
</I>
I'm afraid that the feature you want doesn't make any sense and is, in a 
broad sense, impossible.  There are some things like it which might be 
possible - for example, <A HREF="http://twistedmatrix.com/trac/ticket/2545">http://twistedmatrix.com/trac/ticket/2545</A> - but 
the reactor is not reentrant and in some sense could not be made 
reentrant.

Consider this innocuous looking block of code:

    from twisted.internet.protocol import Protocol
    from make_believe import magicallyBlockOn

    class MagicalProtocol(Protocol):
        def dataReceived(self, data):
            commands = (self.buf + data).split()
            self.buf = commands[-1]
            for command in commands[:-1]:
                if command == 'QUIT':
                    self.transport.loseConnection()
                    return
                else:
                    # Deferreds are hard, let's go shopping
                    page = 
magicallyBlockOn(getPage(&quot;<A HREF="http://example.com/%s">http://example.com/%s</A>&quot; %
                                                    (command,)))
                    self.transport.write(&quot;SIZE:&quot;+len(page))

If you were using Deferreds to track the result of the 'getPage' 
operation, you could cancel the callbacks that write to the transport in 
connectionLost.  However, with magical blocking, one dataReceived method 
might be interleaved with another.  That means that every time through 
the loop, you have to check to see if the transport has already been 
disconnected - the code as presented here is buggy and will spuriously 
fail depending on the order of the connection being lost and the remote 
page being retrieved.

In this example I've been careful to accumulate all the buffer- 
management and parsing logic at the top of the method, before any 
potential re-entrancy can happen, but other code (most everything in 
Twisted's existing protocol implementations, not to mention just about 
all application code) would not be so lucky.

It might be quite feasible to implement a microthreaded runtime 
environment that lived on _top_ of Twisted and explicitly accounted for 
issues like these, but that would not really be substantially different 
than 2.5+inlineCallbacks.
&gt;<i>For the record, I've included updated versions of the previously 
</I>&gt;<i>posted code below. I'd be happy if someone pointed out if I'm doing 
</I>&gt;<i>anything wrong (with respect to twisted) in this code.
</I>
Nothing immediately jumps out at me.  I've had to write similar code in 
the past, though, and when I've had to do that, an explicit state 
machine for the state of the subprocess (or whatever asynchronous 
resource must be acquired) has been easier to deal with than a lock- 
oriented approach to it.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20070404/a5152cc2/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="047663.html">[Twisted-Python] Re: Synchronization techniques
</A></li>
	<LI>Next message (by thread): <A HREF="047670.html">[Twisted-Python] Synchronization techniques
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#47659">[ date ]</a>
              <a href="thread.html#47659">[ thread ]</a>
              <a href="subject.html#47659">[ subject ]</a>
              <a href="author.html#47659">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
