<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Synchronization techniques
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Synchronization%20techniques&In-Reply-To=F929DDF9-5640-4DC6-9D41-AFA878B4C412%40keystonewood.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015162.html">
   <LINK REL="Next"  HREF="015164.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Synchronization techniques</H1>
    <B>Brian Granger</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Synchronization%20techniques&In-Reply-To=F929DDF9-5640-4DC6-9D41-AFA878B4C412%40keystonewood.com"
       TITLE="[Twisted-Python] Synchronization techniques">ellisonbg.net at gmail.com
       </A><BR>
    <I>Thu Apr  5 01:54:04 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015162.html">[Twisted-Python] Synchronization techniques
</A></li>
        <LI>Next message: <A HREF="015164.html">[Twisted-Python] Synchronization techniques
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15163">[ date ]</a>
              <a href="thread.html#15163">[ thread ]</a>
              <a href="subject.html#15163">[ subject ]</a>
              <a href="author.html#15163">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>
</I>&gt;<i> &gt; &gt;So anyway, I rewrote my server-side library to do it the twisted
</I>&gt;<i> &gt; way  and
</I>&gt;<i> &gt; &gt;return deferred's instead trying rig up some way of waiting for
</I>&gt;<i> &gt; them. I
</I>&gt;<i> &gt; &gt;still think it would be super useful to be able to pseudo- block on a
</I>&gt;<i> &gt; &gt;deferred (i.e. allow the reactor to process other events  while
</I>&gt;<i> &gt; waiting for
</I>&gt;<i> &gt; &gt;the deferred). It is very annoying to have to  rewrite many layers
</I>&gt;<i> &gt; of code
</I>&gt;<i> &gt; &gt;when twisted is introduced into a  program. I did find
</I>&gt;<i> &gt; gthreadless.py, and
</I>&gt;<i> &gt; &gt;maybe that would do it.  Unfortunately discussion on that seems to
</I>&gt;<i> &gt; have been
</I>&gt;<i> &gt; &gt;dropped some time  ago...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm afraid that the feature you want doesn't make any sense and is,
</I>&gt;<i> &gt; in a broad sense, impossible.
</I>&gt;<i>
</I>&gt;<i> Maybe it's impossible for you to see things the way I see them
</I>&gt;<i> because you have become drunk on Twisted Kool-Aide. In my specific
</I>&gt;<i> case I am running twisted in a single-threaded environment with a
</I>&gt;<i> single synchronized resource where each request that needs to access
</I>&gt;<i> that resource must gain an exclusive lock before doing anything with
</I>&gt;<i> it (a classic locking scenario). This is not &quot;I'm being lazy and I do
</I>&gt;<i> not want to learn how to use Deferreds.&quot; Rather, it is a requirement
</I>&gt;<i> that is dictated by the system with which I am communicating (it does
</I>&gt;<i> not support concurrent access through the API provided by the
</I>&gt;<i> vendor).
</I>
We have a very similar situation in IPython.  We have a twisted server
that is managing access to a bunch of other processes (talking over
PB) that each don't support concurrent access.

&gt;<i> Thus, my code would be much simpler (both to write and
</I>&gt;<i> maintain) if I had blockOn(), and it would not have any risk of dead
</I>&gt;<i> lock or other such concurrency bugs.
</I>
I do disagree with this.  In our case, we simply use a FIFO queue
based on Deferreds to manage multiple requests to a single resource
that does not support concurrent access.  It is very simple and
explicit.  Even if you had blockOn() you would still have to have
queue to manage the multiple requests, right?  I don't at all see why
it would be simpler if blockOn existed.

&gt;<i> You're &quot;Deferreds are hard&quot; comment is an insult. You make it sound
</I>&gt;<i> like I don't want to think. If I didn't want to think I wouldn't be
</I>&gt;<i> be a software developer.
</I>
Just for the record:  I think Deferreds _are_ hard, even damn hard -
at least if you want to do something non-trivial that has robust error
handling.  Some of the callback/errback decision trees we have in our
code are insane and took days to get right and test fully.  The point
is that doing these complex things would be even more insane without
twisted.

&gt;<i> Everything I've read about this issue suggests that the twisted
</I>&gt;<i> developers just don't want to give people what they want because it
</I>&gt;<i> would allow them to shoot themselves in the foot (for example, by
</I>&gt;<i> using blockOn() in a multi-threaded environment or in inappropriate
</I>&gt;<i> places such as the example above).
</I>
Personally, I would love a completely robust blockOn to exist.  I
would use it in certain cases.  But the bottom line is that many
people have tried to do this, but that have all failed.  Their
collective wisdom (with which I agree) is that it can't be done
without completely redesigning twisted's internals - if at all -
without breaking the overall programming model in twisted.  Most of us
are not ready to throw the baby out with the bathwater.

&gt;<i> Most people that would use blockOn() would probably use it in an
</I>&gt;<i> entirely synchronous fashion where there would only be one deferred
</I>&gt;<i> being processed at any given time. In these cases blockOn() would
</I>&gt;<i> work just fine (if inefficiently). From your point of view that
</I>&gt;<i> probably totally defeats the purpose of using twisted, but as I have
</I>&gt;<i> pointed out above there are other useful features in twisted beside
</I>&gt;<i> its deferred mechanism (PB).
</I>
I thought the same thing when I first wrote the version of blockOn
that we tried in IPython.  As time went along though, I quickly
discovered that these assumptions are simply wrong.  It doesn't work
just fine.

&gt;<i> The concept that I am thinking of seems entirely possible, although I
</I>&gt;<i> am sure it would require rewriting existing reactor implementations.
</I>&gt;<i> However, in the long run that seems like a small cost if twisted
</I>&gt;<i> could be more widely adopted because it would play nicer with
</I>&gt;<i> existing non-async code.
</I>
Currently my own gut feeling is that there is something intrinsic to
Twisted's asynchronous programming model that makes a construct like
blockOn impossible to implement (even if you re-wrote a reactor)
without introducing new types of deadlocks and indeterminant behavior
into the system.  Thus it is not simply an issue of us not being smart
enough to figure out how to do it.  It seems more fundamental than
that.

Actually, I think I see why (at least in part) it is problematic.  If
blockOn exists, the following can happen:

def compute(a, b):
    d = a.computeSomething()
    # Lets say that b.state = 1 as of here
    result = blockOn(d)
    # Because the reactor just ran for an iondeterminant amount of
time, b.state could have
    # changed - or maybe not.
    # Thus the return value of this function is essentially a random result.
    return b.state + result

To eliminate such indeterminacies, new constructs would need to be
created to handle such situations:

def compute(a, b):
    d = a.computeSomething()
    # Lets say that b.state = 1 as of here
    acquire(b.state)    # This gets a lock on b.state
    result = blockOn(d)
    result += b.state
    # b.state =1 still
    release(b.state)   # release the lock
    return result

But now you can get deadlocks as blockOn switches to another code
path.  Things start to look just like threads at this point and the
Kool-Aide starts to taste bitter.

Brian


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015162.html">[Twisted-Python] Synchronization techniques
</A></li>
	<LI>Next message: <A HREF="015164.html">[Twisted-Python] Synchronization techniques
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15163">[ date ]</a>
              <a href="thread.html#15163">[ thread ]</a>
              <a href="subject.html#15163">[ subject ]</a>
              <a href="author.html#15163">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
