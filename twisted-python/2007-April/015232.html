<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Threadpool analysis?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Threadpool%20analysis%3F&In-Reply-To=CAE5C43D-9FC3-43C1-A960-68BBB034EDD7%402xlp.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015231.html">
   <LINK REL="Next"  HREF="015235.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Threadpool analysis?</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Threadpool%20analysis%3F&In-Reply-To=CAE5C43D-9FC3-43C1-A960-68BBB034EDD7%402xlp.com"
       TITLE="[Twisted-Python] Threadpool analysis?">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Wed Apr 11 19:22:53 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015231.html">[Twisted-Python] Threadpool analysis?
</A></li>
        <LI>Next message: <A HREF="015235.html">[Twisted-Python] Threadpool analysis?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15232">[ date ]</a>
              <a href="thread.html#15232">[ thread ]</a>
              <a href="subject.html#15232">[ subject ]</a>
              <a href="author.html#15232">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jonathan Vanasco wrote:
&gt;<i> 
</I>&gt;<i> On Apr 11, 2007, at 5:02 PM, Phil Mayers wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Why are you using a threadpool with Twisted?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I'm not using one directly -- I'm using deferToThread , which twisted 
</I>&gt;<i> manages via its own threadpool.  Stuff is locking up, so i'm using 
</I>&gt;<i> manhole to try and see wtf is going on.
</I>
Ok. What are you running in deferToThread?

More generally, you said things keep locking up. How, what are the 
symptoms? What OS and version are you using, how many outstanding 
requests have you deferToThread'ed, etc.

Answering your original question more directly, you can monitor basic 
info about that usage like so:

import time

COUNT = 0

def myDeferToThread(*p, **kw):
     global COUNT
     COUNT += 1
     stime = time.time()
     def cb(val):
         etime = time.time()
         global COUNT
         COUNT -= 1
         print &quot;deferToThread returned in %.1fsec&quot; % (etime-stime,)
         return val
     return deferToThread(*p, **kw).addCallback(cb)

You can using a task.LoopingCall to report the outstanding number 
periodically. You can even get sophisticated and use an increasing 
sequence number like so:

OUTSTANDING = {}
SEQUENCE = 0

def myDeferToThread(*p, **kw):
     global SEQUENCE
     global OUTSTANDING
     SEQUENCE += 1
     argstr = 'p=%r kw=%r' % (p, kw)
     OUTSTANDING[SEQUENCE] = argstr
     def cb(val):
         args = OUTSTANDING[SEQUENCE]
         del OUTSTANDING[SEQUENCE]
         print &quot;%s returned&quot; % (args,)
         return val
     return deferToThread(*p, **kw).addCallback(cb)

...or something along those lines.

Some of which might help you.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015231.html">[Twisted-Python] Threadpool analysis?
</A></li>
	<LI>Next message: <A HREF="015235.html">[Twisted-Python] Threadpool analysis?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15232">[ date ]</a>
              <a href="thread.html#15232">[ thread ]</a>
              <a href="subject.html#15232">[ subject ]</a>
              <a href="author.html#15232">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
