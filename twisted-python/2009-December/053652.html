<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] A resizable cooperator class for queuing and dispatching jobs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20resizable%20cooperator%20class%20for%20queuing%20and%0A%20dispatching%20jobs&In-Reply-To=%3C4B207222.6070008%40krondo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053657.html">
   <LINK REL="Next"  HREF="053655.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] A resizable cooperator class for queuing and dispatching jobs</H1>
    <B>Dave Peticolas</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20resizable%20cooperator%20class%20for%20queuing%20and%0A%20dispatching%20jobs&In-Reply-To=%3C4B207222.6070008%40krondo.com%3E"
       TITLE="[Twisted-Python] A resizable cooperator class for queuing and dispatching jobs">dave at krondo.com
       </A><BR>
    <I>Wed Dec  9 20:59:30 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053657.html">[Twisted-Python] A resizable cooperator class for queuing	and	dispatching jobs
</A></li>
        <LI>Next message (by thread): <A HREF="053655.html">[Twisted-Python] A resizable cooperator class for queuing	and	dispatching jobs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53652">[ date ]</a>
              <a href="thread.html#53652">[ thread ]</a>
              <a href="subject.html#53652">[ subject ]</a>
              <a href="author.html#53652">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Terry Jones wrote:
&gt;<i> I just wrote a fun class that lets you
</I>&gt;<i> 
</I>&gt;<i>    - submit jobs to be dispatched to a queue
</I>&gt;<i>    - manage how many tasks are in progress at once
</I>&gt;<i>    - dynamically adjust that number
</I>&gt;<i>    - shut down cleanly, including
</I>&gt;<i>    - recovering jobs that were queued but hadn't been dispatched
</I>&gt;<i> 
</I>&gt;<i> This uses a combination of a DeferredQueue, a task.Cooperator, and the
</I>&gt;<i> DeferredPool I posted on Monday. For now I named it ResizableDispatchQueue
</I>&gt;<i> (not a great name, suggestions welcome). You can pick it up from
</I>&gt;<i> <A HREF="http://pastebin.com/f7dc9320e">http://pastebin.com/f7dc9320e</A>
</I>&gt;<i> 
</I>&gt;<i> I can think of lots of uses. Here's a simple example.
</I>&gt;<i> 
</I>&gt;<i> You want to write a server with a web interface that allows people to enter
</I>&gt;<i> their phone number so you can send them an SMS. You anticipate lots of
</I>&gt;<i> people will use the service. But sending SMS messages is quite slow, and
</I>&gt;<i> the company that you ship those jobs off to is concerned that you'll
</I>&gt;<i> overrun their service (or maybe they have an API limit, etc). So you need
</I>&gt;<i> to queue up jobs locally and send them off at a certain rate. You'd like to
</I>&gt;<i> be able to adjust that rate up or down. You also want to be able to shut
</I>&gt;<i> your service down cleanly (i.e., not in the middle of a task), and when you
</I>&gt;<i> restart it you want to be able to re-queue the jobs that were queued last
</I>&gt;<i> time but which hadn't gone out.
</I>&gt;<i> 
</I>&gt;<i> For example, suppose your function that sends the SMS is called sendSMS and
</I>&gt;<i> that it takes a (number, message) tuple arg. Then:
</I>&gt;<i> 
</I>&gt;<i>     dispatcher = ResizableDispatchQueue(sendSMS)
</I>&gt;<i>     # Tell it to send at most 5 things at once.
</I>&gt;<i>     dispatcher.start(5)      # Same as dispatcher.width = 5
</I>&gt;<i> 
</I>&gt;<i>     # Later... send off some SMS messages.
</I>&gt;<i>     dispatcher.put((2127399921, 'Hello...'))
</I>&gt;<i>     dispatcher.put((5052929919, 'Test...'))
</I>&gt;<i>     
</I>&gt;<i>     # Later, bump up to 10 simultaneous jobs.
</I>&gt;<i>     dispatcher.width = 10
</I>&gt;<i> 
</I>&gt;<i>     # Oops, turns out we're sending too fast, turn it down a little.
</I>&gt;<i>     dispatcher.narrow(3)
</I>&gt;<i> 
</I>&gt;<i>     # Get a copy of the list of pending jobs.
</I>&gt;<i>     jobs = dispatcher.pending()
</I>&gt;<i> 
</I>&gt;<i>     # Arrange to increase the number of jobs in an hour's time.
</I>&gt;<i>     reactor.callLater(3600, dispatcher.setWidth, 20)
</I>&gt;<i> 
</I>&gt;<i>     # Time to shutdown. Wait for any tasks underway to complete, and save
</I>&gt;<i>     # the list of jobs not yet dispatched.
</I>&gt;<i> 
</I>&gt;<i>     def saveJobs(jobs):
</I>&gt;<i>         pickle.dump(jobs, ...)
</I>&gt;<i> 
</I>&gt;<i>     d = dispatcher.stop()
</I>&gt;<i>     d.addCallback(saveJobs)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On restart you just unpickle the old job list and pass its items to
</I>&gt;<i> dispatcher.put().
</I>&gt;<i> 
</I>&gt;<i> I have a small test suite that's a bit weird (it schedules various things
</I>&gt;<i> and tests how long the overall job takes and what's still pending when stop
</I>&gt;<i> is called). It could be much better, but it does at least illustrate that
</I>&gt;<i> the code seems to work. Let me know if you want it.
</I>
This is really nifty. I know I could use this.


&gt;<i> There's also the issue about what to do when the dispatch function hits an
</I>&gt;<i> error.  An option could be added to re-queue the job, but it's perhaps
</I>&gt;<i> better to let the dispatch function do that along with whatever else it
</I>&gt;<i> needs.
</I>
One reason to have a separate error handler is to support generic
error-handling strategies, like 're-try N times and then send an
email here', etc. Though maybe you could do that with decorators
on the dispatch function. It does mean the dispatch function needs
to know about the task queue, though.


&gt;<i> As usual, I'd be happy to hear comments and suggestions. I'll probably
</I>&gt;<i> adjust this so the DeferredQueue uses a priority queue.
</I>
Having written something like this, though not as general or as elegant,
several times, I've found that pause() and resume() is a very useful
API. That's not the same as setting the width to 0 and then back again,
as pause() and resume() don't require you to know or remember the
current width of the queue.

dave


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053657.html">[Twisted-Python] A resizable cooperator class for queuing	and	dispatching jobs
</A></li>
	<LI>Next message (by thread): <A HREF="053655.html">[Twisted-Python] A resizable cooperator class for queuing	and	dispatching jobs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53652">[ date ]</a>
              <a href="thread.html#53652">[ thread ]</a>
              <a href="subject.html#53652">[ subject ]</a>
              <a href="author.html#53652">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
