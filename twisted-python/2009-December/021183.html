<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] complete producer/consumer example
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20complete%20producer/consumer%20example&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021209.html">
   <LINK REL="Next"  HREF="021187.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] complete producer/consumer example</H1>
    <B>Benjamin Rutt</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20complete%20producer/consumer%20example&In-Reply-To="
       TITLE="[Twisted-Python] complete producer/consumer example">rutt.4 at osu.edu
       </A><BR>
    <I>Mon Dec 14 20:54:54 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="021209.html">[Twisted-Python] plugin system
</A></li>
        <LI>Next message: <A HREF="021187.html">[Twisted-Python] complete producer/consumer example
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21183">[ date ]</a>
              <a href="thread.html#21183">[ thread ]</a>
              <a href="subject.html#21183">[ subject ]</a>
              <a href="author.html#21183">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>How does the below example look as a complete producer/consumer example?  If
it's well received, perhaps we can add it to the online documentation at
<A HREF="http://twistedmatrix.com/documents/current/core/howto/producers.html">http://twistedmatrix.com/documents/current/core/howto/producers.html</A> in the
&quot;Further Reading&quot; section?  I always felt that the producer/consumer (a.k.a.
high volume streaming) docs lacked a real example that users could download
and run.

#!/sw/external/python-2.6.1/bin/python
&quot;&quot;&quot;Serve as a sample implementation of a twisted producer/consumer
system, with a simple TCP server which asks the user how many random
integers they want, and it sends the result set back to the user, one
result per line.&quot;&quot;&quot;

import random

from zope.interface import implements
from twisted.internet import interfaces, reactor
from twisted.internet.protocol import Factory
from twisted.protocols.basic import LineReceiver

class Producer:
    &quot;&quot;&quot;Send back the requested number of random integers to the client.&quot;&quot;&quot;
    implements(interfaces.IPushProducer)
    def __init__(self, proto, cnt):
        self._proto = proto
        self._goal = cnt
        self._produced = 0
        self._paused = False
    def pauseProducing(self):
        &quot;&quot;&quot;When we've produced data too fast, pauseProducing() will be
called (reentrantly from within resumeProducing's transport.write
method, most likely), so set a flag that causes production to pause
temporarily.&quot;&quot;&quot;
        self._paused = True
        print('pausing connection from %s' %
(self._proto.transport.getPeer()))
    def resumeProducing(self):
        self._paused = False
        while not self._paused and self._produced &lt; self._goal:
            next_int = random.randint(0, 10000)
            self._proto.transport.write('%d\r\n' % (next_int))
            self._produced += 1
        if self._produced == self._goal:
            self._proto.transport.unregisterProducer()
            self._proto.transport.loseConnection()
    def stopProducing(self):
        pass

class ServeRandom(LineReceiver):
    &quot;&quot;&quot;Serve up random data.&quot;&quot;&quot;
    def connectionMade(self):
        print('connection made from %s' % (self.transport.getPeer()))
        self.transport.write('how many random integers do you want?\r\n')
    def lineReceived(self, line):
        cnt = int(line.strip())
        producer = Producer(self, cnt)
        self.transport.registerProducer(producer, True)
        producer.resumeProducing()
    def connectionLost(self, reason):
        print('connection lost from %s' % (self.transport.getPeer()))
factory = Factory()
factory.protocol = ServeRandom
reactor.listenTCP(1234, factory)
print('listening on 1234...')
reactor.run()

Use on the client:

$ telnet localhost 1234
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
how many random integers do you want?
5
431
7201
3289
9604
6659
Connection closed by foreign host.
$

Use on the server (observe how the server pauses production sometimes - this
happens when a large data set is requested by the client):

$ ./streaming.py
listening on 1234...
connection made from IPv4Address(TCP, '127.0.0.1', 54859)
connection lost from IPv4Address(TCP, '127.0.0.1', 54859)
connection made from IPv4Address(TCP, '127.0.0.1', 54864)
pausing connection from IPv4Address(TCP, '127.0.0.1', 54864)
pausing connection from IPv4Address(TCP, '127.0.0.1', 54864)
pausing connection from IPv4Address(TCP, '127.0.0.1', 54864)
pausing connection from IPv4Address(TCP, '127.0.0.1', 54864)
connection lost from IPv4Address(TCP, '127.0.0.1', 54864)
[...]

Thanks.
-- 
Benjamin Rutt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20091214/d8e325b1/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20091214/d8e325b1/attachment.htm</A> 
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="021209.html">[Twisted-Python] plugin system
</A></li>
	<LI>Next message: <A HREF="021187.html">[Twisted-Python] complete producer/consumer example
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21183">[ date ]</a>
              <a href="thread.html#21183">[ thread ]</a>
              <a href="subject.html#21183">[ subject ]</a>
              <a href="author.html#21183">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
