<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] A resizable cooperator class for queuing and	dispatching jobs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20resizable%20cooperator%20class%20for%20queuing%20and%0A%09dispatching%20jobs&In-Reply-To=%3C19231.8959.296355.40332%40jon.es%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="053645.html">
   <LINK REL="Next"  HREF="053633.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] A resizable cooperator class for queuing and	dispatching jobs</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20resizable%20cooperator%20class%20for%20queuing%20and%0A%09dispatching%20jobs&In-Reply-To=%3C19231.8959.296355.40332%40jon.es%3E"
       TITLE="[Twisted-Python] A resizable cooperator class for queuing and	dispatching jobs">terry at jon.es
       </A><BR>
    <I>Tue Dec  8 21:09:35 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="053645.html">[Twisted-Python] Twistd logging
</A></li>
        <LI>Next message (by thread): <A HREF="053633.html">[Twisted-Python] A resizable cooperator class for queuing and	dispatching jobs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53629">[ date ]</a>
              <a href="thread.html#53629">[ thread ]</a>
              <a href="subject.html#53629">[ subject ]</a>
              <a href="author.html#53629">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I just wrote a fun class that lets you

   - submit jobs to be dispatched to a queue
   - manage how many tasks are in progress at once
   - dynamically adjust that number
   - shut down cleanly, including
   - recovering jobs that were queued but hadn't been dispatched

This uses a combination of a DeferredQueue, a task.Cooperator, and the
DeferredPool I posted on Monday. For now I named it ResizableDispatchQueue
(not a great name, suggestions welcome). You can pick it up from
<A HREF="http://pastebin.com/f7dc9320e">http://pastebin.com/f7dc9320e</A>

I can think of lots of uses. Here's a simple example.

You want to write a server with a web interface that allows people to enter
their phone number so you can send them an SMS. You anticipate lots of
people will use the service. But sending SMS messages is quite slow, and
the company that you ship those jobs off to is concerned that you'll
overrun their service (or maybe they have an API limit, etc). So you need
to queue up jobs locally and send them off at a certain rate. You'd like to
be able to adjust that rate up or down. You also want to be able to shut
your service down cleanly (i.e., not in the middle of a task), and when you
restart it you want to be able to re-queue the jobs that were queued last
time but which hadn't gone out.

For example, suppose your function that sends the SMS is called sendSMS and
that it takes a (number, message) tuple arg. Then:

    dispatcher = ResizableDispatchQueue(sendSMS)
    # Tell it to send at most 5 things at once.
    dispatcher.start(5)      # Same as dispatcher.width = 5

    # Later... send off some SMS messages.
    dispatcher.put((2127399921, 'Hello...'))
    dispatcher.put((5052929919, 'Test...'))
    
    # Later, bump up to 10 simultaneous jobs.
    dispatcher.width = 10

    # Oops, turns out we're sending too fast, turn it down a little.
    dispatcher.narrow(3)

    # Get a copy of the list of pending jobs.
    jobs = dispatcher.pending()

    # Arrange to increase the number of jobs in an hour's time.
    reactor.callLater(3600, dispatcher.setWidth, 20)

    # Time to shutdown. Wait for any tasks underway to complete, and save
    # the list of jobs not yet dispatched.

    def saveJobs(jobs):
        pickle.dump(jobs, ...)

    d = dispatcher.stop()
    d.addCallback(saveJobs)


On restart you just unpickle the old job list and pass its items to
dispatcher.put().

I have a small test suite that's a bit weird (it schedules various things
and tests how long the overall job takes and what's still pending when stop
is called). It could be much better, but it does at least illustrate that
the code seems to work. Let me know if you want it.

There's also the issue about what to do when the dispatch function hits an
error.  An option could be added to re-queue the job, but it's perhaps
better to let the dispatch function do that along with whatever else it
needs.

As usual, I'd be happy to hear comments and suggestions. I'll probably
adjust this so the DeferredQueue uses a priority queue.

Terry


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="053645.html">[Twisted-Python] Twistd logging
</A></li>
	<LI>Next message (by thread): <A HREF="053633.html">[Twisted-Python] A resizable cooperator class for queuing and	dispatching jobs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#53629">[ date ]</a>
              <a href="thread.html#53629">[ thread ]</a>
              <a href="subject.html#53629">[ subject ]</a>
              <a href="author.html#53629">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
