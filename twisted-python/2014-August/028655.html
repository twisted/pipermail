<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Experimenting with tubes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Experimenting%20with%20tubes&In-Reply-To=%3C20140820005819.0db347af%40tm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028626.html">
   <LINK REL="Next"  HREF="028658.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Experimenting with tubes</H1>
    <B>Jan Pobrislo</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Experimenting%20with%20tubes&In-Reply-To=%3C20140820005819.0db347af%40tm%3E"
       TITLE="[Twisted-Python] Experimenting with tubes">ccx at webprojekty.cz
       </A><BR>
    <I>Tue Aug 19 16:58:19 MDT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="028626.html">[Twisted-Python] Experimenting with tubes
</A></li>
        <LI>Next message: <A HREF="028658.html">[Twisted-Python] Experimenting with tubes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28655">[ date ]</a>
              <a href="thread.html#28655">[ thread ]</a>
              <a href="subject.html#28655">[ subject ]</a>
              <a href="author.html#28655">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 14 Aug 2014 14:29:56 -0700
Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:

&gt;<i> On Aug 11, 2014, at 6:51 AM, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ccx at webprojekty.cz</A> wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; Hello, I've been playing with the new tubes that are being
</I>&gt;<i> &gt; implemented:
</I>&gt;<i> &gt; <A HREF="http://comments.gmane.org/gmane.comp.python.twisted/27248">http://comments.gmane.org/gmane.comp.python.twisted/27248</A>
</I>&gt;<i> &gt; <A HREF="https://twistedmatrix.com/trac/ticket/1956">https://twistedmatrix.com/trac/ticket/1956</A>
</I>&gt;<i> 
</I>&gt;<i> Thanks so much for taking the time to play with it, and taking some
</I>&gt;<i> time to write feedback.
</I>&gt;<i> 
</I>&gt;<i> &gt; Here are few things that I did with it. I won't publish the full
</I>&gt;<i> &gt; code now, as in it's current shape it could implode eyeballs of
</I>&gt;<i> &gt; twisted devs and possibly make them summon some of the elder gods,
</I>&gt;<i> &gt; but I'll see if I can produce something less vile as I merge the
</I>&gt;<i> &gt; ongoing changes to the tubes branch.
</I>&gt;<i> 
</I>&gt;<i> I'd be interested to see the code nevertheless.  If you had to do
</I>&gt;<i> eyeball-imploding antics to get Tubes to work well for your use-case,
</I>&gt;<i> being able to have a look at that would help us evaluate whether
</I>&gt;<i> those antics were required by the code, encouraged by misfeatures of
</I>&gt;<i> the API design, or just issues with lack of documentation.
</I>
It's mostly me not really documenting anything, not writing tests and
littering it with debug statements (which will go away as soon as I
find time to improve my debugging module so it can monkeypatch them).

<A HREF="http://wpr.cz/ccx/bzr/tubes7/">http://wpr.cz/ccx/bzr/tubes7/</A> for my changes only
<A HREF="http://wpr.cz/ccx/bzr/tubes7-merge-2/">http://wpr.cz/ccx/bzr/tubes7-merge-2/</A> for changes on top of the bzr
mirror of the svn branch

example usage:
<A HREF="http://wpr.cz/ccx/paste/2014-08-19/2/">http://wpr.cz/ccx/paste/2014-08-19/2/</A>
<A HREF="http://wpr.cz/ccx/paste/2014-08-19/3/">http://wpr.cz/ccx/paste/2014-08-19/3/</A>
<A HREF="http://wpr.cz/ccx/paste/2014-08-19/4/">http://wpr.cz/ccx/paste/2014-08-19/4/</A>
<A HREF="http://wpr.cz/ccx/paste/2014-08-19/5/">http://wpr.cz/ccx/paste/2014-08-19/5/</A>


&gt;<i> &gt; So far I wrote relatively simple app that read logfiles, parse them
</I>&gt;<i> &gt; and insert what they got out of them into a database.
</I>&gt;<i> 
</I>&gt;<i> If it's actually reading a file, another nice to-do would be an
</I>&gt;<i> IFount provider that provides the contents of a file with appropriate
</I>&gt;<i> flow control, and maybe a thread or process in the background to do
</I>&gt;<i> the file I/O.  Another thing you could contribute to the branch,
</I>&gt;<i> possibly?  :-)  How did you implement this?
</I>
At the moment I don't mind the blockingness of the calls. I did write a
ThreadReader and ThreadWriter though for my earlier tubes-alike with
Queue-based loop.

What is more interesting challenge (and we discussed this earlier on
irc) would be generic async file api. I suggested implementing 9p2000
back then and I still think it is a good starting point... but nothing
I have spare time for at the moment.


&gt;<i> I'm not sure I totally understand the case that you're describing
</I>&gt;<i> right now.  Can you perhaps contribute a unit test which demonstrates
</I>&gt;<i> why this line of code is necessary?
</I>
I'd love to, alas I'll be bit preocuppied with some more urgent matters
for following week or two. The short version is &quot;flowStopped just
didn't get passed through the series otherwise&quot;.


&gt;<i> Are you running into &lt;<A HREF="https://twistedmatrix.com/trac/ticket/7546">https://twistedmatrix.com/trac/ticket/7546</A>&gt;?
</I>
Most probably, as far as I can tell from the vague description.


&gt;<i> That ... definitely sounds kind of gross.  As does actually setting
</I>&gt;<i> the nextFount attribute directly on the fan.Out.
</I>
Indeed. The point of the experiment was not produce nice code but to
see if there are any major pitfalls using the tubes API.


&gt;<i> twisted.web.client.Agent has a solution to this where there's a
</I>&gt;<i> multi-failure object that aggregates multiple errors into one thing.
</I>&gt;<i> I think we have to do something similar.  Unfortunately this is a
</I>&gt;<i> very confusing interface in addition to being poorly documented and
</I>&gt;<i> relies on private classes that expose ostensibly public attributes.
</I>&gt;<i> We need to very carefully document this within fan.In.
</I>
Some nice abstraction of multiple failures would be indeed handy. I'm
pretty sure DeferredList could use one too.

 
&gt;<i> &gt; As for data representation that I choose to pass between each tube
</I>&gt;<i> &gt; I've started with simple namedtuples and following that I've built
</I>&gt;<i> &gt; a simple &quot;datatype&quot; class somewhat reminiscent of
</I>&gt;<i> &gt; <A HREF="https://github.com/hynek/characteristic">https://github.com/hynek/characteristic</A>
</I>&gt;<i> &gt; which I learned of few moments after I finished polishing my own
</I>&gt;<i> &gt; implementation. What I have there is added layer above namedtuples
</I>&gt;<i> &gt; that autogenerate zope Interfaces (so I can have adaptation), do
</I>&gt;<i> &gt; field type and value validation/adaptation and possibly (as a
</I>&gt;<i> &gt; future extension) provide easy way to make them into AMP commands
</I>&gt;<i> &gt; so the series can be split into communicating processes as needed.
</I>&gt;<i> &gt; (What would be interesting imo is something like ampoule for tubes,
</I>&gt;<i> &gt; or perhaps a ThreadTube and SubprocessTube for performing blocking
</I>&gt;<i> &gt; operations)
</I>&gt;<i> 
</I>&gt;<i> I think it's likely we'll acquire a dependency on Characteristic
</I>&gt;<i> sometime soon, I have promised to look at the issues on
</I>&gt;<i> &lt;<A HREF="https://github.com/hynek/characteristic/pull/13">https://github.com/hynek/characteristic/pull/13</A>&gt; and try to address
</I>&gt;<i> them already :).
</I>
What makes me ponder is how to work with multiple types of messages
being passed through. Traditionally in twisted one would use different
methods for handling each one, eg. IRCClient has userJoined, userLeft,
and so on. If we keep tubes as they are with a single received() method
then somehow we need to be able to tell those messages apart,
deconstruct them and mainly document them and test for proper handling
of all cases.

Instinctively I started looking for algebraic data types, but making
those work on python is high-level metaprogramming magic and that
either implies python3.3+ or AST rewriting:
<A HREF="https://github.com/lihaoyi/macropy">https://github.com/lihaoyi/macropy</A>

Perhaps what would be bearable is AST-based checker (integrated into
testcases perhaps) that would do exhaustiveness and field name checking
for such complex data - so all users of a tube/fount producing some
type woud be flagged whenever the type signature of it changes.

Other possible resolution is to mantain the multi-method approach and
make tubes into pausing mechanism only. I think it could work somewhat
like:

@pauseable
def lineReceived(line):
    ...
    # get reference object of specified interface
    # and wait until it is unpaused
    (yield IIRCClient).userJoined(...)

The first obvious downside of this approach that I see is that we now
need proxy objects for generic fan-in/out.

&gt;<i> &gt; Also maybe of note is the implementation of Pipes in Async library
</I>&gt;<i> &gt; for OCaml which I've been examining lately. What they seem to do
</I>&gt;<i> &gt; there is that they push values downstream and the function called
</I>&gt;<i> &gt; in each processing step may return deferred signifying a pause is
</I>&gt;<i> &gt; requested until this deferred is fired. For those interested in the
</I>&gt;<i> &gt; details you can refer to:
</I>&gt;<i> &gt; <A HREF="https://ocaml.janestreet.com/ocaml-core/111.25.00/doc/async/#Std.Pipe">https://ocaml.janestreet.com/ocaml-core/111.25.00/doc/async/#Std.Pipe</A>
</I>&gt;<i> &gt; and the relevant section of Real World OCaml book (available
</I>&gt;<i> &gt; online).
</I>&gt;<i> 
</I>&gt;<i> Creating a token for every single call to .receive() makes life
</I>&gt;<i> hard.  Deferred could go to some trouble to be a cheaper token to
</I>&gt;<i> pass around (especially on PyPy) but doing it this way is also
</I>&gt;<i> error-prone as a mistaken error-handler in the Deferred chain means
</I>&gt;<i> that the default behavior of buggy code un-hooks your loop and leaves
</I>&gt;<i> idle data sources that will never be cleaned up.
</I>
How does current approach prevent that? From what I see unhandled
exception in non-well written drain can do the very much same. Tubes
are handled specially so it can be prevented there.


&gt;<i> I worked quite a bit with the 'Streams' interface in web2 on Calendar
</I>&gt;<i> Server, and my conclusion there is that while this is better than
</I>&gt;<i> nothing (it was very nice to be able to just return a Stream rather
</I>&gt;<i> than cobble together something that returned NOT_DONE_YET every time)
</I>&gt;<i> it was (A) slow and (B) error prone.  Tubes are designed specifically
</I>&gt;<i> to avoid this error.  Although you can return Deferreds internally,
</I>&gt;<i> no consumer ever needs to write the callback-loop that calls .read()
</I>&gt;<i> again from a callback on .read().
</I>
I agree that something like tubes is needed, but it can be a
upper-level layer over something simple as flow-signalling callbacks.

Anyway, linked mostly for inspiration.

What I'd really like to see though is some rationale for current design
choices of tubes - eg. list of reasons the previous attempts failed and
how does each next address the issues. :-)

- ccxcz

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028626.html">[Twisted-Python] Experimenting with tubes
</A></li>
	<LI>Next message: <A HREF="028658.html">[Twisted-Python] Experimenting with tubes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28655">[ date ]</a>
              <a href="thread.html#28655">[ thread ]</a>
              <a href="subject.html#28655">[ subject ]</a>
              <a href="author.html#28655">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
