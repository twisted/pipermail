<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Serving WSGIResource via SSL endpoint
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Serving%20WSGIResource%20via%20SSL%20endpoint&In-Reply-To=%3CCAJjaOEPYkUOopGWAx0QpKeDETpqrtd09_xcKQV0eWL%3Dbxd-fDA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="061089.html">
   <LINK REL="Next"  HREF="061093.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Serving WSGIResource via SSL endpoint</H1>
    <B>Piper Masden</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Serving%20WSGIResource%20via%20SSL%20endpoint&In-Reply-To=%3CCAJjaOEPYkUOopGWAx0QpKeDETpqrtd09_xcKQV0eWL%3Dbxd-fDA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Serving WSGIResource via SSL endpoint">piper.masden at gmail.com
       </A><BR>
    <I>Fri Aug 15 10:32:50 MDT 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="061089.html">[Twisted-Python] Serving WSGIResource via SSL endpoint
</A></li>
        <LI>Next message (by thread): <A HREF="061093.html">[Twisted-Python] Serving WSGIResource via SSL endpoint
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61092">[ date ]</a>
              <a href="thread.html#61092">[ thread ]</a>
              <a href="subject.html#61092">[ subject ]</a>
              <a href="author.html#61092">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Aug 15, 2014 at 2:15 AM, Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:

&gt;<i> On Aug 14, 2014, at 3:54 PM, Piper Masden &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">piper.masden at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i>   The core of the code looks like this:
</I>&gt;<i>
</I>&gt;<i>     resource = WSGIResource(reactor, reactor.getThreadPool(),
</I>&gt;<i> WSGIHandler())
</I>&gt;<i>     endpoint = 'tcp:port=8000'
</I>&gt;<i>     server = strports.service(endpoint, server.Site(resource))
</I>&gt;<i>     server.setServiceParent(application)
</I>&gt;<i>
</I>&gt;<i>   This has worked great for a while. However, we have some views that we
</I>&gt;<i> require https on, and so this dev server doesn't allow us to get to those
</I>&gt;<i> views at all. I generated a .key file and a .crt file with openssl, and
</I>&gt;<i> then cat'd them together to make a pem, and then changed the endpoint to
</I>&gt;<i> be...
</I>&gt;<i>
</I>&gt;<i>     endpoint = 'ssl:port=8000:privateKey=/path/to/key.pem'
</I>&gt;<i>
</I>&gt;<i>   Now when I open my browser and type <A HREF="https://localhost:8000,">https://localhost:8000,</A> chrome just
</I>&gt;<i> hangs. I don't really know how to diagnose this, because I don't really
</I>&gt;<i> know anything about SSL (it's all just magic security goodness to me). I
</I>&gt;<i> don't necessarily need a direct answer (though it will certainly make me
</I>&gt;<i> look good to all the other devs), but maybe some pointers in the right
</I>&gt;<i> direction would help.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This isn't really enough information to diagnose a problem, but here are
</I>&gt;<i> some things you could try:
</I>&gt;<i>
</I>&gt;<i> openssl s_client -connect localhost:8000
</I>&gt;<i> curl -vvvv <A HREF="https://localhost:8000/">https://localhost:8000/</A>
</I>&gt;<i>
</I>&gt;<i> These should output some stuff about your TLS connection, and will perhaps
</I>&gt;<i> emit an error message which looks obvious to you.  If not, seeing some of
</I>&gt;<i> that output might be useful to help diagnose it.  Also, trying other web
</I>&gt;<i> browsers is always helpful.
</I>&gt;<i>
</I>
I tried Firefox and Safari right after I Chrome. I did have it slightly
working once, where I could get it connect, and if I hit the &quot;Stop&quot; button,
the browser would draw the served data. I thought that might have been
because the media server wasn't serving media via https, and the browser
was confused. When I tried to enable that, it stopped working altogether
(Chrome just says &quot;Establishing secure connection&quot; until it times out).

Here's my code now (I added Tobias' suggestion to not use the pem file):

    resource = WSGIResource(reactor, reactor.getThreadPool(), WSGIHandler())
    endpoint = 'ssl:port=8000:privateKey=server.key:certKey=server.crt'
    server = strports.service(endpoint, server.Site(resource))

When I use the openssl command you gave me, I get this:

    &gt; openssl s_client -connect localhost:8000
    CONNECTED(00000003)
    ^C

(I had to Ctrl-C it, because it just stuck there)

When I do the curl command, I get this:

    &gt; curl -vvvv <A HREF="https://localhost:8000/">https://localhost:8000/</A>
    * Adding handle: conn: 0x7fd0f9813600
    * Adding handle: send: 0
    * Adding handle: recv: 0
    * Curl_addHandleToPipeline: length: 1
    * - Conn 0 (0x7fd0f9813600) send_pipe: 1, recv_pipe: 0
    * About to connect() to localhost port 8000 (#0)
    *   Trying ::1...
    *   Trying 127.0.0.1...
    * Connected to localhost (127.0.0.1) port 8000 (#0)
    ^C

(I have to Ctrl-C it too)

Maybe I generated my certs wrong or something? I just did

    openssl req -nodes -new -x509 -keyout server.key -out server.crt

...which I basically took from a OpenSSL HOWTO because I have no idea what
I'm doing.


&gt;<i>
</I>&gt;<i> You might also try replacing your SSL string endpoint description with a
</I>&gt;<i> TXSNI endpoint plugin: &lt;<A HREF="https://github.com/glyph/txsni">https://github.com/glyph/txsni</A>&gt;.  This is just a
</I>&gt;<i> little easier to get right because of how it reads certificates (for
</I>&gt;<i> example you don't need to get your private key, chain cert, and main cert
</I>&gt;<i> in the right order, as long as they're all in the appropriate file.
</I>&gt;<i>
</I>
If I can't get this to work, I may bug you about txsni. I think this is a
case me just not knowing anything about OpenSSL (and the internets having
wildly varying levels of explanations) and probably doing something not
very smart. If I can learn something about OpenSSL while I facepalm, I'd
rather do that.

-Piper
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20140815/81624f62/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="061089.html">[Twisted-Python] Serving WSGIResource via SSL endpoint
</A></li>
	<LI>Next message (by thread): <A HREF="061093.html">[Twisted-Python] Serving WSGIResource via SSL endpoint
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61092">[ date ]</a>
              <a href="thread.html#61092">[ thread ]</a>
              <a href="subject.html#61092">[ subject ]</a>
              <a href="author.html#61092">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
