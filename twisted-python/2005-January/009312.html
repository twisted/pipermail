<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] ProcessProtocol randomly not returning all of	stdout
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20ProcessProtocol%20randomly%20not%20returning%20all%20of%0A%09stdout&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009311.html">
   <LINK REL="Next"  HREF="009313.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] ProcessProtocol randomly not returning all of	stdout</H1>
    <B>Justin Johnson</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20ProcessProtocol%20randomly%20not%20returning%20all%20of%0A%09stdout&In-Reply-To="
       TITLE="[Twisted-Python] ProcessProtocol randomly not returning all of	stdout">justinjohnson at gmail.com
       </A><BR>
    <I>Thu Jan 13 14:47:05 EST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="009311.html">[Twisted-Python] Re: [Twisted-commits] r12864 - Temporarily	workaround z.i bug.
</A></li>
        <LI>Next message: <A HREF="009313.html">[Twisted-Python] ProcessProtocol randomly not returning all of	stdout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9312">[ date ]</a>
              <a href="thread.html#9312">[ thread ]</a>
              <a href="subject.html#9312">[ subject ]</a>
              <a href="author.html#9312">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I recently started running into a problem where my process protocol
isn't extracting stdout accurately in all cases.  I have a method on a
service that loops through a list and runs a command, passing in each
item on the list one at a time.  Out of ~50 items in the list, and
thus ~50 invocations of the command, one or two will fail to extract
all of stdout from the command.  Instead the first character of stdout
is extracted and that is it.

The process protocol I'm using is below.  Does anyone see anything
wrong with the code?  I am using the win32event reactor and Twisted
1.3.0.


from twisted.internet import reactor
from twisted.internet import protocol, error, defer
from twisted.python import log

from ratcontrol import errors, config

import os, sys

class BasicProcessProtocol(protocol.ProcessProtocol):
    def __init__(self):
        self.deferred = defer.Deferred()
        self.stdout = &quot;&quot;
        self.stderr = &quot;&quot;
        self.status = 0

    def connectionMade(self):
        self.transport.closeStdin()

    def outReceived(self, data):
        self.stdout += data

    def errReceived(self, data):
        self.stderr += data

    def processEnded(self, reason):
        if reason.check(error.ProcessDone):
            self.status = 0
            # pass the items we want down the callback chain
            self.deferred.callback((self.status, self.stdout, self.stderr))
        else:
            self.status = 1
            theError = errors.CmdError(self.cmd, self.status,
self.stdout, self.stderr)
            log.msg(theError)
            self.deferred.errback(theError)

def openProcess(cmd_and_args):
        cmd = cmd_and_args[0]
        args = cmd_and_args[1:]

        # Spawn the process using the reactor so we don't block
        proto = BasicProcessProtocol()
        proto.cmd = cmd_and_args
        reactor.spawnProcess(proto, cmd, cmd_and_args, env=os.environ)
        return proto.deferred


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009311.html">[Twisted-Python] Re: [Twisted-commits] r12864 - Temporarily	workaround z.i bug.
</A></li>
	<LI>Next message: <A HREF="009313.html">[Twisted-Python] ProcessProtocol randomly not returning all of	stdout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9312">[ date ]</a>
              <a href="thread.html#9312">[ thread ]</a>
              <a href="subject.html#9312">[ subject ]</a>
              <a href="author.html#9312">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
