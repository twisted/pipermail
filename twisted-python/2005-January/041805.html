<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Deferred style question.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Deferred%20style%20question.&In-Reply-To=%3C200501072113.15988.anthony%40interlink.com.au%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="041804.html">
   <LINK REL="Next"  HREF="041806.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Deferred style question.</H1>
    <B>Anthony Baxter</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Deferred%20style%20question.&In-Reply-To=%3C200501072113.15988.anthony%40interlink.com.au%3E"
       TITLE="[Twisted-Python] Deferred style question.">anthony at interlink.com.au
       </A><BR>
    <I>Fri Jan  7 03:13:15 MST 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="041804.html">[Twisted-Python] Deferred style question.
</A></li>
        <LI>Next message (by thread): <A HREF="041806.html">[Twisted-Python] Deferred style question.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41805">[ date ]</a>
              <a href="thread.html#41805">[ thread ]</a>
              <a href="subject.html#41805">[ subject ]</a>
              <a href="author.html#41805">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>After I posted the previous, two obvious points occurred to me:

  1. This is easy enough to modify to a generally useful 'DeferredCache'
      class
  2. Said class is a nice example of a decorator &lt;wink&gt;

So, see the attached for a DeferredCache decorator. It's not perfect,
because it currently doesn't do keyword arguments, and all arguments
to the operation must be hashable. This could be fixed, although it 
would make the code a bit nastier.

-- 
Anthony Baxter     &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">anthony at interlink.com.au</A>&gt;
It's never too late to have a happy childhood.
-------------- next part --------------

# XXX To be done: 
#     Caching relies on all arguments to the operation being cachable.
#     Caching doesn't handle keyword arguments.

from twisted.internet import defer


class DeferredCache:
    &quot;&quot;&quot; Wraps a call that returns a deferred in a cache. Any subsequent
        calls with the same argument will wait for the first call to 
        finish.
    &quot;&quot;&quot;

    def __init__(self, op):
        self.op = op
        self.cache = {}

    def cb_triggerUserCallback(self, res, deferred):
        deferred.callback(res)
        return res

    def __call__(self, *args):
        # Currently not in progress - start it
        if not self.cache.has_key(args):
            # XXX check it returns a deferred?
            opdef = self.op(*args)
            self.cache[args] = opdef

        userdef = defer.Deferred()
        self.cache[args].addCallback(lambda x: 
                                    self.cb_triggerUserCallback(x, userdef))
        return userdef


@DeferredCache
def longRunningOperation(value):
    # Stub pointless operation - returns the value passed, after a 2s delay
    opdef = defer.Deferred()
    print &quot;Operation called for&quot;, value
    reactor.callLater(2, lambda :opdef.callback(value))
    return opdef

# Alternatively, if you don't like decorators or are on &lt; Python 2.4
#longRunningOperation = DeferredCache(longRunningOperation)


# Testing stuff


def gotAResult(res):
    print &quot;I got a result!&quot;, res

def makeACall():
    print &quot;making a call for 'x'&quot;
    d = longRunningOperation('x')
    d.addCallback(gotAResult)

def startTheFun():
    makeACall()
    reactor.callLater(1, makeACall)
    reactor.callLater(4, makeACall)
    reactor.callLater(5, makeACall)

if __name__ == &quot;__main__&quot;:
    from twisted.internet import reactor
    reactor.callLater(0, startTheFun)
    reactor.run()
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="041804.html">[Twisted-Python] Deferred style question.
</A></li>
	<LI>Next message (by thread): <A HREF="041806.html">[Twisted-Python] Deferred style question.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41805">[ date ]</a>
              <a href="thread.html#41805">[ thread ]</a>
              <a href="subject.html#41805">[ subject ]</a>
              <a href="author.html#41805">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
