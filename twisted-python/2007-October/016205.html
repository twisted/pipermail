<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Need some help with my first Twisted program
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Need%20some%20help%20with%20my%20first%20Twisted%20program&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016204.html">
   <LINK REL="Next"  HREF="016206.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Need some help with my first Twisted program</H1>
    <B>McCann, Brian</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Need%20some%20help%20with%20my%20first%20Twisted%20program&In-Reply-To="
       TITLE="[Twisted-Python] Need some help with my first Twisted program">bmccann at andmore.com
       </A><BR>
    <I>Fri Oct 19 16:53:00 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="016204.html">[Twisted-Python] Need some help with my first Twisted program
</A></li>
        <LI>Next message: <A HREF="016206.html">[Twisted-Python] Need some help with my first Twisted program
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16205">[ date ]</a>
              <a href="thread.html#16205">[ thread ]</a>
              <a href="subject.html#16205">[ subject ]</a>
              <a href="author.html#16205">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> 

&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> 
</I>&gt;<i> [mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] On Behalf 
</I>&gt;<i> Of Jean-Paul Calderone
</I>&gt;<i> Sent: Friday, October 19, 2007 4:29 PM
</I>&gt;<i> To: Twisted general discussion
</I>&gt;<i> Subject: Re: [Twisted-Python] Need some help with my first 
</I>&gt;<i> Twisted program
</I>&gt;<i> 
</I>&gt;<i> On Fri, 19 Oct 2007 16:13:20 -0400, &quot;McCann, Brian&quot; 
</I>&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bmccann at andmore.com</A>&gt; wrote:
</I>&gt;<i> &gt;I'm looking for what is probably an simple solution I can't 
</I>&gt;<i> figure out
</I>&gt;<i> &gt;on my own.  I'm writing an SSH server based on the example on the web
</I>&gt;<i> &gt;(using conch).  I'm trying to figure out how to detect when 
</I>&gt;<i> the client
</I>&gt;<i> &gt;exists (for example, when I just close out PuTTY), but I 
</I>&gt;<i> can't get this
</I>&gt;<i> &gt;to work right.  Looking through the API docs I found 
</I>&gt;<i> &quot;connectionLost()&quot;,
</I>&gt;<i> &gt;which I put in my protocol class (EchoProtocol in the 
</I>&gt;<i> example), but it's
</I>&gt;<i> &gt;never getting called.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Can someone please tell me what I'm doing wrong?
</I>&gt;<i> 
</I>&gt;<i> You seem to be on the right track.  However, you haven't 
</I>&gt;<i> supplied enough
</I>&gt;<i> details for anyone to be sure why it isn't behaving as you 
</I>&gt;<i> expect.  If you
</I>&gt;<i> can post a minimal example of a program which you think 
</I>&gt;<i> should be working
</I>&gt;<i> (ie, giving you connection lost notification) but isn't, then 
</I>&gt;<i> someone can
</I>&gt;<i> probably point you to a solution.
</I>&gt;<i> 
</I>&gt;<i> Jean-Paul
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Sorry about that.  Here is most of what is involved.  (Code below)  I
would think that when I close my PuTTY window, the connectionLost
function in the EchoProtocol would be called...but clearly I'm missing
some crucial step.

--Brian

from twisted.cred import portal, checkers
from twisted.conch import error, avatar
from twisted.conch.checkers import SSHPublicKeyDatabase
from twisted.conch.ssh import factory, userauth, connection, keys,
session
from twisted.internet import reactor, protocol, defer
from twisted.python import log
from zope.interface import implements
import sys
import socket
import threading

log.startLogging(sys.stderr)

&quot;&quot;&quot;Example of running another protocol over an SSH channel.
log in with username &quot;user&quot; and password &quot;password&quot;.
&quot;&quot;&quot;
class defaultdict(dict):
    def __init__(self, default=None):
        dict.__init__(self)
        self.default = default
    def __getitem__(self, key):
        try:
            return dict.__getitem__(self, key)
        except KeyError:
            return self.default


class ExampleAvatar(avatar.ConchUser):

    def __init__(self, username):
        avatar.ConchUser.__init__(self)
        self.username = username
        self.channelLookup.update({'session':session.SSHSession})

class ExampleRealm:
    implements(portal.IRealm)

    def requestAvatar(self, avatarId, mind, *interfaces):
        return interfaces[0], ExampleAvatar(avatarId), lambda: None

class EchoProtocol(protocol.Protocol):
    &quot;&quot;&quot;this is our example protocol that we will run over SSH
    &quot;&quot;&quot;
    def connectionMade(self):
        self.transport.write(&quot;Connected!\r\n&quot;)
        self.commandBuffer = &quot;&quot;

    def connectionLost(self,reason):
        print &quot;lost:%s&quot; %reason
        self.serialServerSocket.close()
        self.alive = False
        self.serialSocketReadThread.join()
                
        
publicKey = 'ssh-rsa
AAAAB3NzaC1yc2EAAAABIwAAAGEArzJx8OYOnJmzf4tfBEvLi8DVPrJ3/c9k2I/Az64fxjHf
9imyRJbixtQhlH9lfNjUIx+4LmrJH5QNRsFporcHDKOTwTTYLh5KmRpslkYHRivcJSkbh/C+
BR3utDS555mV'

privateKey = &quot;&quot;&quot;-----BEGIN RSA PRIVATE KEY-----
MIIByAIBAAJhAK8ycfDmDpyZs3+LXwRLy4vA1T6yd/3PZNiPwM+uH8Yx3/YpskSW
4sbUIZR/ZXzY1CMfuC5qyR+UDUbBaaK3Bwyjk8E02C4eSpkabJZGB0Yr3CUpG4fw
vgUd7rQ0ueeZlQIBIwJgbh+1VZfr7WftK5lu7MHtqE1S1vPWZQYE3+VUn8yJADyb
Z4fsZaCrzW9lkIqXkE3GIY+ojdhZhkO1gbG0118sIgphwSWKRxK0mvh6ERxKqIt1
xJEJO74EykXZV4oNJ8sjAjEA3J9r2ZghVhGN6V8DnQrTk24Td0E8hU8AcP0FVP+8
PQm/g/aXf2QQkQT+omdHVEJrAjEAy0pL0EBH6EVS98evDCBtQw22OZT52qXlAwZ2
gyTriKFVoqjeEjt3SZKKqXHSApP/AjBLpF99zcJJZRq2abgYlf9lv1chkrWqDHUu
DZttmYJeEfiFBBavVYIF1dOlZT0G8jMCMBc7sOSZodFnAiryP+Qg9otSBjJ3bQML
pSTqy7c3a2AScC/YyOwkDaICHnnD3XyjMwIxALRzl0tQEKMXs6hH8ToUdlLROCrP
EhQ0wahUTCk1gKA4uPD6TMTChavbh4K63OvbKg==
-----END RSA PRIVATE KEY-----&quot;&quot;&quot;


class InMemoryPublicKeyChecker(SSHPublicKeyDatabase):

    def checkKey(self, credentials):
        return credentials.username == 'user' and \
            keys.getPublicKeyString(data=publicKey) == credentials.blob

class ExampleSession:
    
    def __init__(self, avatar):
        &quot;&quot;&quot;
        We don't use it, but the adapter is passed the avatar as its
first
        argument.
        &quot;&quot;&quot;

    def getPty(self, term, windowSize, attrs):
        pass
    
    def execCommand(self, proto, cmd):
        raise Exception(&quot;no executing commands&quot;)

    def openShell(self, trans):
        ep = EchoProtocol()
        ep.makeConnection(trans)
        trans.makeConnection(session.wrapProtocol(ep))

    def eofReceived(self):
        pass

    def closed(self):
        pass

from twisted.python import components
components.registerAdapter(ExampleSession, ExampleAvatar,
session.ISession)

class ExampleFactory(factory.SSHFactory):
    publicKeys = {
        'ssh-rsa': keys.getPublicKeyString(data=publicKey)
    }
    privateKeys = {
        'ssh-rsa': keys.getPrivateKeyObject(data=privateKey)
    }
    services = {
        'ssh-userauth': userauth.SSHUserAuthServer,
        'ssh-connection': connection.SSHConnection
    }
    

portal = portal.Portal(ExampleRealm())
passwdDB = checkers.InMemoryUsernamePasswordDatabaseDontUse()
passwdDB.addUser('user', 'password')
portal.registerChecker(passwdDB)
portal.registerChecker(InMemoryPublicKeyChecker())
ExampleFactory.portal = portal


if __name__ == '__main__':
    reactor.listenTCP(5022, ExampleFactory())
    reactor.run()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016204.html">[Twisted-Python] Need some help with my first Twisted program
</A></li>
	<LI>Next message: <A HREF="016206.html">[Twisted-Python] Need some help with my first Twisted program
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16205">[ date ]</a>
              <a href="thread.html#16205">[ thread ]</a>
              <a href="subject.html#16205">[ subject ]</a>
              <a href="author.html#16205">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
