<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] asyncronous access to serial ports under windows
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20asyncronous%20access%20to%20serial%20ports%20under%20windows&In-Reply-To=1193454653.28874.234.camel%40brown.esteem.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016226.html">
   <LINK REL="Next"  HREF="016224.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] asyncronous access to serial ports under windows</H1>
    <B>Tom Brown</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20asyncronous%20access%20to%20serial%20ports%20under%20windows&In-Reply-To=1193454653.28874.234.camel%40brown.esteem.com"
       TITLE="[Twisted-Python] asyncronous access to serial ports under windows">brown at esteem.com
       </A><BR>
    <I>Mon Oct 29 13:19:26 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="016226.html">[Twisted-Python] asyncronous access to serial ports under windows
</A></li>
        <LI>Next message: <A HREF="016224.html">[Twisted-Python] IPushProducer - medium volume streaming
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16246">[ date ]</a>
              <a href="thread.html#16246">[ thread ]</a>
              <a href="subject.html#16246">[ subject ]</a>
              <a href="author.html#16246">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 2007-10-26 at 20:10 -0700, Tom Brown wrote:
&gt;<i> On Fri, 2007-10-26 at 15:42 -0700, Tom Brown wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I've been able to create an application in Linux that reads/writes
</I>&gt;<i> &gt; multiple serial ports asyncronously. The setup code that does this looks
</I>&gt;<i> &gt; like this:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt; from twisted.internet.qtreactor import install
</I>&gt;<i> &gt; a = QApplication(argv)
</I>&gt;<i> &gt; install(a)
</I>&gt;<i> &gt; from twisted.internet import reactor
</I>&gt;<i> &gt; from twisted.internet.serialport import SerialPort
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt;   ports, badPorts = getGoodPorts()
</I>&gt;<i> &gt;   if not ports:
</I>&gt;<i> &gt;     exit(1)
</I>&gt;<i> &gt;   data = ConfigData(join(sep, 'etc', 'qa.conf'))
</I>&gt;<i> &gt;   dbInfo = copy(data['qadata'])
</I>&gt;<i> &gt;   getLogin(dbInfo)
</I>&gt;<i> &gt;   w = MainWindow(data, dbInfo, ports)
</I>&gt;<i> &gt;   w.show()
</I>&gt;<i> &gt;   reactor.addSystemEventTrigger('after', 'shutdown', a.quit)
</I>&gt;<i> &gt;   a.connect(a, SIGNAL('lastWindowClosed()'), reactor.stop)
</I>&gt;<i> &gt;   for portObj in w.portObjs:
</I>&gt;<i> &gt;     SerialPort(portObj.scanner, portObj.port, reactor, baudrate=38400)
</I>&gt;<i> &gt;     portObj.sendLine()
</I>&gt;<i> &gt;   reactor.run()
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Where the portObj.scanner is an instance of a descendent of Protocol.
</I>&gt;<i> &gt; Like I said, the above code works under Linux. Then I tried porting this
</I>&gt;<i> &gt; to Windows. The first problem I came across is that the qtreactor.py
</I>&gt;<i> &gt; would not work. I had to subclass QTReactor from Win32Reactor. It runs
</I>&gt;<i> &gt; without errors. However, I am not reading anything off of the serial
</I>&gt;<i> &gt; port. I can see the lights blink on the port when the portObj.sendLine()
</I>&gt;<i> &gt; is called, so I believe I am writing to it ok and data is coming back.
</I>&gt;<i> &gt; The data is just not read by the application. I think it must have
</I>&gt;<i> &gt; something to do with the SerialPort instance not getting an even that
</I>&gt;<i> &gt; data is ready. I suspect this is a Windows issue in that Windows is not
</I>&gt;<i> &gt; signaling an event when data is ready to read on the serial port.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Does anybody have any experience with this? Is there a work around? Am I
</I>&gt;<i> &gt; doing something wrong?
</I>&gt;<i> 
</I>&gt;<i> Well, I found out that it has something to do with the qtreactor. If I
</I>&gt;<i> use just a Win32Reactor, it will read/write the serial port just fine. I
</I>&gt;<i> played around with writing to the serial port using
</I>&gt;<i> scanner.transport.write('\n') and found that
</I>&gt;<i> Win32Reactor.doWaitForMultipleEvents() is called when a Win32Reactor is
</I>&gt;<i> used. It is not called when a QTReactor(Win32Reactor) is used. The
</I>&gt;<i> question is why is this the case?
</I>
Ok, I was able to find a solution to my problem. I had to make some
changes to the original qt4reactor.py (which I renamed to qtreactor.py
and copied over the original twisted qtreactor.py). The changes I made
are:

1) Subclassed QTReactor from Win32Reactor.
2) Commented out the following methods so the base class methods are
used:
  addReader()
  addWriter()
  removeReader()
  removeWriter()
  removeAll()
3) Modified the QTReactor.simulate() method so it calls doIteration()
after calling runUntilCurrent().

I've tested this with two devices and it works great. After I test this
in a production environment with six devices, I can create a patch
against the original qt4reactor.py. I'd like to make this available to
others who might need it. Where is the best place to post the patch?
This mailing list?

Thanks,
Tom




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016226.html">[Twisted-Python] asyncronous access to serial ports under windows
</A></li>
	<LI>Next message: <A HREF="016224.html">[Twisted-Python] IPushProducer - medium volume streaming
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16246">[ date ]</a>
              <a href="thread.html#16246">[ thread ]</a>
              <a href="subject.html#16246">[ subject ]</a>
              <a href="author.html#16246">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
