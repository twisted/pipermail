<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to switch users in SSH session.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20switch%20users%20in%20SSH%20session.&In-Reply-To=OFD206E0F8.6BF050E8-ON8025736F.0053C00D-8025736F.0053C3E7%40LocalDomain">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016129.html">
   <LINK REL="Next"  HREF="016137.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to switch users in SSH session.</H1>
    <B>Ross.McKerchar at sophos.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20switch%20users%20in%20SSH%20session.&In-Reply-To=OFD206E0F8.6BF050E8-ON8025736F.0053C00D-8025736F.0053C3E7%40LocalDomain"
       TITLE="[Twisted-Python] How to switch users in SSH session.">Ross.McKerchar at sophos.com
       </A><BR>
    <I>Tue Oct  9 12:41:47 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="016129.html">[Twisted-Python] Marking as review
</A></li>
        <LI>Next message: <A HREF="016137.html">[Twisted-Python] UDP with multiple connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16134">[ date ]</a>
              <a href="thread.html#16134">[ thread ]</a>
              <a href="subject.html#16134">[ subject ]</a>
              <a href="author.html#16134">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Paul_S_Johnson at mnb.uscourts.gov Paul_S_Johnson at mnb.uscourts.gov 
Thu Sep 27 16:00:14 EDT 200:

&gt;<i> After much wrangling and a small miracle I have managed to write an 
</I>object 
&gt;<i> that fetches the output of three commands in the order given through an 
</I>&gt;<i> SSH connection. How come I cannot switch users? Some of the information 
</I>I 
&gt;<i> need can only be fetched through a root account and security is such 
</I>that 
&gt;<i> I cannot log in remotely from a root account but must switch once logged 
</I>
&gt;<i> in from an account with less than root privileges.
</I>
I've been trying something similar. As you've probably found out you cant 
just write in the password to su - you'll get an error &quot;Standard in must 
be a tty&quot;. Basically I think su needs a shell to work.

Consequently, before sending your password, you'll need to request a 
shell. I would've been utterly clueless about this if it wasn't for the 
post @
<A HREF="http://twistedmatrix.com/pipermail/twisted-python/2007-July/015793.html,">http://twistedmatrix.com/pipermail/twisted-python/2007-July/015793.html,</A> 
from which I managed to extract the crucial code:

term = 'ansi'
winsz = struct.pack('4H', 80, 100, 80, 100)
winSize = struct.unpack('4H', winsz)
ptyReqData = session.packRequest_pty_req(term, winSize, '')
self.conn.sendRequest(self, 'pty-req', ptyReqData)
self.conn.sendRequest(self, 'shell', '')

Sticking this in your SSHChannel.channelOpen method will allow you to get 
a shell. Unfortunately you then have to interact with the session in an 
expect-like manner which turns the whole procedure into one big easily 
broken hack. Basically I just write &quot;su -&quot; and wait for my method 
dataReceived to return &quot;password:&quot; at which point I write in the password.

Another point to mention is that the ssh session is still not root, the 
root functionality is being provided by the shell instance. Consequently 
any new channels opened up will not be root so you cant easily use this 
method to scp file's that are only readable for root. You can of course 
cat from the shell session but then you have issues with line wrapping and 
reliably figuring out when the file ends and your shell prompt begins.

I looked into trying to do some setreuid/setuid magic in the hope that I 
could issue a command from my root shell prompt that would elevate the 
whole ssh process to root allowing all my channels root priviliges. 
However I soon got well out of my depth and decided it wasn't possible, at 
least by me :)

So, as far as I can see, it's not possible, if your server doesn't allow 
root access to open up a channel that has root priviliges. The only way to 
do it is in the aformentioned messy way via a shell &amp; su (which I gave up 
on when my regular expression took up two lines on my screen and still 
didn't reliable match half the shell prompts it needed to).

I would love somebody to prove me wrong and let me know of a nice way 
round this.

Of course - these problems are nothing to do with twisted and all to do 
with the way ssh works.

-ross

-- 
Ross McKerchar
Systems Analyst, Sophos

Tel: 01235 559933
Web: <A HREF="http://www.sophos.com">http://www.sophos.com</A>
Sophos - security and control

Sophos Plc, The Pentagon, Abingdon Science Park, Abingdon,
OX14 3YP, United Kingdom.

Company Reg No 2096520. VAT Reg No GB 348 3873 20.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20071009/6d11204a/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20071009/6d11204a/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016129.html">[Twisted-Python] Marking as review
</A></li>
	<LI>Next message: <A HREF="016137.html">[Twisted-Python] UDP with multiple connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16134">[ date ]</a>
              <a href="thread.html#16134">[ thread ]</a>
              <a href="subject.html#16134">[ subject ]</a>
              <a href="author.html#16134">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
