<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] 2006, 'MySQL server has gone away'
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%202006%2C%20%27MySQL%20server%20has%20gone%20away%27&In-Reply-To=8b93c05a0710150506n241bf0edy8a37700e6bfd3e9a%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016176.html">
   <LINK REL="Next"  HREF="016179.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] 2006, 'MySQL server has gone away'</H1>
    <B>Phil Christensen</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%202006%2C%20%27MySQL%20server%20has%20gone%20away%27&In-Reply-To=8b93c05a0710150506n241bf0edy8a37700e6bfd3e9a%40mail.gmail.com"
       TITLE="[Twisted-Python] 2006, 'MySQL server has gone away'">phil at bubblehouse.org
       </A><BR>
    <I>Mon Oct 15 10:46:38 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="016176.html">[Twisted-Python] 2006, 'MySQL server has gone away'
</A></li>
        <LI>Next message: <A HREF="016179.html">[Twisted-Python] [newbie] server script with client functionality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16178">[ date ]</a>
              <a href="thread.html#16178">[ thread ]</a>
              <a href="subject.html#16178">[ subject ]</a>
              <a href="author.html#16178">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Oct 15, 2007, at 8:06 AM, Yoann Aubineau wrote:

&gt;<i> 2007/9/20, Phil Christensen &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">phil at bubblehouse.org</A>&gt;:
</I>&gt;&gt;<i> On Sep 20, 2007, at 7:39 AM, Werner Thie wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hi all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> While using mySQL V 5.0.33 and MySQL-python-1.2.2 with twisted/
</I>&gt;&gt;&gt;<i> adbapi with the following connection params
</I>&gt;&gt;<i> [snip snip snip]
</I>&gt;&gt;&gt;<i> I noticed (2006, 'MySQL server has gone away') errors, which seem
</I>&gt;&gt;&gt;<i> to be not recoverable from an adbapi standpoint.
</I>&gt;&gt;<i> [snip snip snip]
</I>&gt;&gt;&gt;<i> Questions:
</I>&gt;&gt;&gt;<i> - are there any adverse effects in applying this patch and setting
</I>&gt;&gt;&gt;<i> reconnect: 1 in DB_ARGS?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> - is there a better, safer way to avoid this nasty error?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thxs, Werner
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I believe this is what the 'cp_reconnect' keyword argument to the
</I>&gt;&gt;<i> ConnectionPool constructor does.
</I>&gt;<i>
</I>&gt;<i> In case it helps:
</I>&gt;<i>
</I>&gt;<i> The cp_reconnect keyword is mandatory but not sufficient for what I've
</I>&gt;<i> experienced. At least with MySQL server version 4.1.7, a disconnection
</I>&gt;<i> raises a generic OperationalError which one has to parse to know what
</I>&gt;<i> actually happened.
</I>&gt;<i>
</I>&gt;<i> Hence the need to subclass ConnectionPool and surcharge
</I>&gt;<i> _runInteraction for adding the ability to retry on MySQL connection
</I>&gt;<i> lost. Or maybe is there a better way to do that?
</I>
Are the lost connections you're experiencing due to server idle  
timeouts, or actual network issues? I believe Werner was referring to  
MySQL 5.0+ &quot;security feature&quot; that automatically closes idle  
connections after 8 hours. We discussed this a little further in this  
thread:

	<A HREF="http://twistedmatrix.com/pipermail/twisted-web/2007-October/003541.html">http://twistedmatrix.com/pipermail/twisted-web/2007-October/003541.html</A>

If it is an idle timeout you're running into, you might be able to  
turn it off. Apparently in older versions of MySQL it's possible to  
turn this feature off, although that depends on your take as to  
whether leaving a db connection open is a significant security risk  
or not.

&gt;<i> ---- CODE ----
</I>&gt;<i>
</I>&gt;<i> import twisted.enterprise.adbapi
</I>&gt;<i> try:
</I>&gt;<i>     from MySQLdb import OperationalError
</I>&gt;<i> except ImportError:
</I>&gt;<i>     OperationalError = None
</I>&gt;<i>
</I>&gt;<i> class EnhancedConnectionPool(adbapi.ConnectionPool):
</I>&gt;<i>     def _runInteraction(self, *args, **kwargs):
</I>&gt;<i>         try:
</I>&gt;<i>             d = abdapi.ConnectionPool._runInteraction(self, *args,  
</I>&gt;<i> **kwargs)
</I>&gt;<i>         except OperationalError, e:
</I>&gt;<i>             errormsg = str(e).lower()
</I>&gt;<i>             messages = (
</I>&gt;<i>                 &quot;lost connection to mysql server during query&quot;,
</I>&gt;<i>                 &quot;server has gone away&quot;
</I>&gt;<i>             )
</I>&gt;<i>             for msg in messages:
</I>&gt;<i>                 if msg in errormsg:
</I>&gt;<i>                     d = abdapi.ConnectionPool._runInteraction(self,
</I>&gt;<i> *args, **kwargs)
</I>&gt;<i>                     return d
</I>&gt;<i>             else:
</I>&gt;<i>                 raise
</I>&gt;<i>         return d
</I>&gt;<i>
</I>&gt;<i> ---- / CODE ----
</I>
The only issue with this approach -- what happens if you've got more  
than one dead connection in the pool? You're still going to need code  
further up the call stack that can deal with the possibility of a  
failed query.

The other thing to consider is that the adbapi layer already detects  
broken connections in a database-agnostic fashion. If a query fails  
for any reason, a rollback occurs (if possible) and then a known good  
query (&quot;SELECT 1&quot;) is attempted. If either of those steps fails,  
ConnectionLost is raised.

If this behavior is different for you, I'd be interested to know your  
MySQLdb version...I had some very strange issues with prior versions  
that were only fixed with 1.2.2.

Granted, your method is slightly more efficient at the expense of the  
MySQLdb dependency, but if you're going to need to detect the lost  
connections at the application level anyways, you might as well stick  
with the stock ConnectionPool.

-phil


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016176.html">[Twisted-Python] 2006, 'MySQL server has gone away'
</A></li>
	<LI>Next message: <A HREF="016179.html">[Twisted-Python] [newbie] server script with client functionality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16178">[ date ]</a>
              <a href="thread.html#16178">[ thread ]</a>
              <a href="subject.html#16178">[ subject ]</a>
              <a href="author.html#16178">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
