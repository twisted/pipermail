<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20A%20kinder%20and%20more%20consistent%0A%09defer.inlineCallbacks&In-Reply-To=18726.63546.421944.685251%40jon.es">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018735.html">
   <LINK REL="Next"  HREF="018738.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20A%20kinder%20and%20more%20consistent%0A%09defer.inlineCallbacks&In-Reply-To=18726.63546.421944.685251%40jon.es"
       TITLE="[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks">glyph at divmod.com
       </A><BR>
    <I>Fri Nov 21 22:18:06 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018735.html">[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
</A></li>
        <LI>Next message: <A HREF="018738.html">[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18737">[ date ]</a>
              <a href="thread.html#18737">[ thread ]</a>
              <a href="subject.html#18737">[ subject ]</a>
              <a href="author.html#18737">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 21 Nov, 06:04 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">terry at jon.es</A> wrote:
&gt;<i>Here's a suggestion for making inlineCallbacks more consistent and less
</I>&gt;<i>confusing.  Let's suppose you're writing something like this:
</I>
Let's put this a bit less vaguely: inlineCallbacks appears to have a 
bug: 'raise' before 'yield' in a generator results in a synchronous 
exception rather than an errback, although its documentation does not 
explain this.

inlineCallbacks is also unhelpful in debugging a particular type of 
error - it doesn't tell you what happened if you unintentionally 
returned something other than a generator, it just blows up without your 
code on the stack, and no mention of your code in the error message.

These are definitely interesting problems.  I think there should 
probably be a ticket for each one.  I don't like your solution, though.
&gt;<i>1. func may not yield. In that case, you either get an AttributeError 
</I>&gt;<i>when
</I>&gt;<i>inlineCallbacks tries to send().
</I>
Following you so far.
&gt;<i>Or worse, the call to send might actually
</I>&gt;<i>work, and do who knows what. I.e., func() could return an object with a
</I>&gt;<i>send method but which is not a generator.
</I>
Now I'm not sure what you're talking about.  Do you have a lot of very 
dangerous objects lying around with methods called 'send'?  ;-)

This is an important behavior which should continue to be supported.  If 
we don't, then users will get surprising behavior if they try to mix 
inlineCallbacks with other decorators that modify generators.  A 
&quot;generator-like&quot; object (iterable with 'send') should be good enough.
&gt;<i>For some fun, run some code that
</I>&gt;<i>calls the following decorated function
</I>
In this particular case, there may be a third ticket to file, i.e. to 
refuse to accept objects that implement __call__ and send but not 
__iter__ and next; however, this infinite loop seems really, really 
obscure.  Have you actually hit it in real life?
&gt;<i>2. func might raise before it get to its first yield. In that case 
</I>&gt;<i>you'll
</I>&gt;<i>get an exception thrown when the inlineCallbacks decorator tries to 
</I>&gt;<i>create
</I>&gt;<i>the wrapper function:
</I>
Definitely problematic.  Code expecting to handle errors with an errback 
should not need to have an except: block as well.
&gt;<i>There's a simple and consistent way to handle both of these. Just have
</I>&gt;<i>inlineCallbacks do some initial work based on what it has been passed:
</I>
isinstance() is bad for the reasons I mentioned above.
&gt;<i>This has the advantage that (barring e.g., a KeyboardInterrupt in the
</I>&gt;<i>middle of things) you'll *always* get a deferred back when you call an
</I>&gt;<i>inlineCallbacks decorated function. That deferred might have already 
</I>&gt;<i>called
</I>&gt;<i>or erred back (corresponding to cases 1 and 2 above).
</I>
This property, however, I definitely think is a desirable one.
&gt;<i>And case 2 happens to me too. Having inlinecallbacks try/except the 
</I>&gt;<i>call to
</I>&gt;<i>func is nicer because it means I don't have to be quite so defensive in
</I>&gt;<i>coding. So instead of me having to write
</I>&gt;<i>
</I>&gt;<i>    try:
</I>&gt;<i>        d = func()
</I>&gt;<i>    except Exception:
</I>&gt;<i>        # ???
</I>
IMHO the most important thing discussed here.  Not quite sure how to do 
this change in a compatible way; some people might be depending on this 
weird behavior.  @inlineCallbacks2?  @inlineCallbacks(beGood=YES)? 
Suggestions are appreciated.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018735.html">[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
</A></li>
	<LI>Next message: <A HREF="018738.html">[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18737">[ date ]</a>
              <a href="thread.html#18737">[ thread ]</a>
              <a href="subject.html#18737">[ subject ]</a>
              <a href="author.html#18737">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
