<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20kinder%20and%20more%20consistent%0A%09defer.inlineCallbacks&In-Reply-To=%3C18727.9571.946049.640024%40jon.es%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051240.html">
   <LINK REL="Next"  HREF="051243.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks</H1>
    <B>Terry Jones</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20A%20kinder%20and%20more%20consistent%0A%09defer.inlineCallbacks&In-Reply-To=%3C18727.9571.946049.640024%40jon.es%3E"
       TITLE="[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks">terry at jon.es
       </A><BR>
    <I>Fri Nov 21 14:17:23 MST 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051240.html">[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
</A></li>
        <LI>Next message (by thread): <A HREF="051243.html">[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51242">[ date ]</a>
              <a href="thread.html#51242">[ thread ]</a>
              <a href="subject.html#51242">[ subject ]</a>
              <a href="author.html#51242">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;&gt;&gt;&gt;&gt;<i> &quot;Drew&quot; == Drew Smathers &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">drew.smathers at gmail.com</A>&gt; writes:
</I>Drew&gt; On Fri, Nov 21, 2008 at 1:04 PM, Terry Jones &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">terry at jon.es</A>&gt; wrote:

Drew&gt; Why not just return a Deferred from the function and not decorate it.
Drew&gt; Or document the function as returning a value if it doesn't block.

In that case (1) I'm considering what happens if you take the last yield
out of a function decorated with inlineCallbacks. You might do it via
commenting something out for testing, or you might do it just as a matter
of course in changing the behavior of the function.

If you do either of those, inlineCallbacks will raise an exception. With
the suggestion I sent, it will just run as expected: the original function
will be called, and you'll get the value it returns back as the result of
the returned deferred.

Drew&gt; Essentially this is equivalent to _not_ decorating your function and
Drew&gt; returning a Deferred via defer.succeed(value) or defer.fail(error).
Drew&gt; I'm still not sure why it's necessary to stitch this kind of behavior
Drew&gt; into inlineCallbacks().

It's not necessary, it just makes inlineCallbacks gracefully cover two
cases that it currently throws exceptions on, and it makes inlineCallbacks
always return a deferred, which is arguably also an advantage.

Drew&gt; From my perspective inlineCallbacks() simply equates: &quot;I want to do
Drew&gt; more than one asynchronous operation inline and here's some syntactic
Drew&gt; sugar using yield as an expression.&quot;

Right. I'm just making what's happening underneath a little more forgiving
and consistent in these two edge cases where things go awry.

The main point, to me, is that code changes over time. So you write a
function and use inlineCallbacks decorator for syntactic sugar. Then you,
or someone else, comes along a while later and change a few things. If you
take out the last yield without noticing, or your change throws an
exception before the first yield, then you've broken things and it may not
be clear why. In the first case, you get an exception thrown from deep
inside inlineCallbacks, and many/most people would have some trouble
figuring out what's going on. There's no need for that though.

&gt;&gt;<i> This has the advantage that (barring e.g., a KeyboardInterrupt in the
</I>&gt;&gt;<i> middle of things) you'll *always* get a deferred back when you call an
</I>&gt;&gt;<i> inlineCallbacks decorated function. That deferred might have already
</I>&gt;&gt;<i> called or erred back (corresponding to cases 1 and 2 above).
</I>
Drew&gt; You will always get a Deferred  back if the function is a generator.

But if you take out the last deferred, it's no longer a generator. And if
an exception happens before the first yield you don't get a deferred back
because the exception is raised before the inlineCallbacks created function
gets its first value from your generator.

They're just two simple scenarios that can be dealt with more cleanly.  If
it wasn't clear, the inlineCallbacks created function is identical. Your
code is still run identically. There's just a little pre-processing to see
if it even needs to be run.

Drew&gt; That's what unit tests are for :) But I'm not sure how you could
Drew&gt; easily wind up in this scenario considering generators don't allow
Drew&gt; return with an argument.

Right. But a function can just fall off the end, implicitly returning
None.

And I gave two examples, plus simple code, that illustrates how both of the
problems I'm addressing can arise. It's not about having return in a
function. One part is about turning a generator into a non-generator by
removing the final yield. The other's just about introducing an exception
into your code. I've run into both situations, more than once, and in both
had the reaction that inlineCallbacks could have been more accomodating or
helpful in how it behaves.

Fortunately I can just use my own version!  :-)

Sorry if I wasn't being clear enough first time round.

Regards,
Terry


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051240.html">[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
</A></li>
	<LI>Next message (by thread): <A HREF="051243.html">[Twisted-Python] A kinder and more consistent	defer.inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51242">[ date ]</a>
              <a href="thread.html#51242">[ thread ]</a>
              <a href="subject.html#51242">[ subject ]</a>
              <a href="author.html#51242">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
