<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Deferreds vs sys.getrecursionlimit()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Deferreds%20vs%20sys.getrecursionlimit%28%29&In-Reply-To=%3C20081118000405.20272.1013994295.divmod.quotient.6912%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051214.html">
   <LINK REL="Next"  HREF="051218.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Deferreds vs sys.getrecursionlimit()</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Deferreds%20vs%20sys.getrecursionlimit%28%29&In-Reply-To=%3C20081118000405.20272.1013994295.divmod.quotient.6912%40ohm%3E"
       TITLE="[Twisted-Python] Deferreds vs sys.getrecursionlimit()">exarkun at divmod.com
       </A><BR>
    <I>Mon Nov 17 17:04:05 MST 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051214.html">[Twisted-Python] Deferreds vs sys.getrecursionlimit()
</A></li>
        <LI>Next message (by thread): <A HREF="051218.html">[Twisted-Python] Deferreds vs sys.getrecursionlimit()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51215">[ date ]</a>
              <a href="thread.html#51215">[ thread ]</a>
              <a href="subject.html#51215">[ subject ]</a>
              <a href="author.html#51215">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 17 Nov 2008 15:49:41 -0800, Brian Warner &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">warner at lothar.com</A>&gt; wrote:
&gt;&gt;<i> Ideally, Deferred just shouldn't have this problem. If we can't eliminate
</I>&gt;&gt;<i> the problem entirely, then we can at least add a more useful error message
</I>&gt;&gt;<i> which can explain how you can start debugging.
</I>&gt;<i>
</I>&gt;<i>Yeah, when I last looked into this (a couple years ago), I figured that the
</I>&gt;<i>Deferred doesn't have enough information to safely optimize out the
</I>&gt;<i>tail-call. You never know who else might have a handle on the Deferred and
</I>&gt;<i>might add a new callback to it. It once occurred to me that it might be
</I>&gt;<i>easier to do this safely if Deferred were broken up into two pieces (like E's
</I>&gt;<i>Promise/Resolver pair: basically one side would get .callback and .errback,
</I>&gt;<i>while the other side would get .addCallbacks/etc), but I didn't pursue that
</I>&gt;<i>thought very far.
</I>
Of course, the best response to this would be an implementation of the
iterative version of _runCallbacks.  However, I do think it is possible
to get rid of this recursion.  It doesn't really matter who else might
have a reference to either Deferred involved.  The new frame going onto
the stack is just another Deferred._runCallbacks (unless a subclass
overrides it, but DeferredList is the only subclass in Twisted, and we
should really deprecated it, and continue to discourage people from
subclassing Deferred, and _runCallbacks is private anyway so there).
The recurser (ie, the Deferred._runCallbacks doing the `self.result.addBoth(
self._continue)Â´ knows how the recursee (ie, the Deferred having addBoth
called on it) behaves - just like itself.  The obvious transformation
(inlining a bunch of code from outside of _runCallbacks into _runCallbacks)
will result in something that's really ugly, but it should work.  And I
think there is probably an approach that's less ugly, too.

This addresses only one of the problems you raised, but it's the one I
think Glyph was talking about eliminating by changing the implementation
of Deferred.

It's possible there's a way to remove the other one with an implementation
change to Deferred as well (but it's not as clear to me what that change is
yet).  However, it's much easier to avoid that one by writing code in a
slightly different way.

eventual-send is one different way, but there are also other more efficient
approaches which are also always correct.  These generally take the form
of avoiding creating a giant stack of Deferreds in the first place by only
changing each Deferred which would have been &quot;interior&quot; on that stack to
the one immediately beneath it and chaining the bottom directly to the top.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051214.html">[Twisted-Python] Deferreds vs sys.getrecursionlimit()
</A></li>
	<LI>Next message (by thread): <A HREF="051218.html">[Twisted-Python] Deferreds vs sys.getrecursionlimit()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51215">[ date ]</a>
              <a href="thread.html#51215">[ thread ]</a>
              <a href="subject.html#51215">[ subject ]</a>
              <a href="author.html#51215">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
