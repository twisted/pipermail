<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Trying to proxy through multiple IPs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Trying%20to%20proxy%20through%20multiple%20IPs&In-Reply-To=20081104100443.GI12038%40steerpike.home.puzzling.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018628.html">
   <LINK REL="Next"  HREF="018636.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Trying to proxy through multiple IPs</H1>
    <B>Michael</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Trying%20to%20proxy%20through%20multiple%20IPs&In-Reply-To=20081104100443.GI12038%40steerpike.home.puzzling.org"
       TITLE="[Twisted-Python] Trying to proxy through multiple IPs">ms at cerenity.org
       </A><BR>
    <I>Tue Nov  4 06:25:28 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018628.html">[Twisted-Python] Trying to proxy through multiple IPs
</A></li>
        <LI>Next message: <A HREF="018636.html">[Twisted-Python] FirstError handling from defer.gatherResults()?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18630">[ date ]</a>
              <a href="thread.html#18630">[ thread ]</a>
              <a href="subject.html#18630">[ subject ]</a>
              <a href="author.html#18630">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Just going back to the closure issue, it's probably worth mentioning an issue 
with closures that people used to them in other languages sometimes get 
caught by.

On Tuesday 04 November 2008 10:04:43 Andrew Bennetts wrote:
&gt;<i> class ProxyFactory(http.HTTPFactory):
</I>&gt;<i>
</I>&gt;<i> &#160; &#160; def __init__(self, ip):
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160;self.protocol = Proxy
</I>&gt;<i>          self.protocol.requestFactory = ProxyRequest
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160;self.protocol.requestFactory.bindIP = ip
</I>
This is also safer than using what python views as a closure - because 
closures in python don't capture all the free variables unlike closures in 
other languages. 

The original poster's code...

&gt;<i> class ProxyFactory(http.HTTPFactory):
</I>&gt;<i>     def class_factory(self, bindIP):
</I>&gt;<i>         def closure(ip):
</I>&gt;<i>             klass2 = ProxyRequest
</I>
... is not safe, due to the ProxyRequest free variable.


Example:

def ProxyRequest(who): print &quot;hello&quot;, who

class demo(object):
    def __init__(self, f=&quot;world&quot;):
        def mkClosure(f):
            def X():
                ProxyRequest(f)
            return X
        self._C = mkClosure(f)
    def C(self):
        (self._C)()

X=demo()
X.C()

def ProxyRequest(who):
   print &quot;game over&quot;

X.C()

Running this results in:
hello world
game over

In most other languages with closures I've used this would result in:

hello world
hello world

This issue remains in python 3.0, for those wondering.

The only safe way of doing this is to capture a local value and use that 
instead:

class demo(object):
    def __init__(self, f=&quot;world&quot;):
        pr = proxyRequest
        def closure(f):
            def X():
                pr(f)
            return X
        self._C = closure(f)

... if you have to use a closure.


Michael.
-- 
<A HREF="http://yeoldeclue.com/blog">http://yeoldeclue.com/blog</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018628.html">[Twisted-Python] Trying to proxy through multiple IPs
</A></li>
	<LI>Next message: <A HREF="018636.html">[Twisted-Python] FirstError handling from defer.gatherResults()?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18630">[ date ]</a>
              <a href="thread.html#18630">[ thread ]</a>
              <a href="subject.html#18630">[ subject ]</a>
              <a href="author.html#18630">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
