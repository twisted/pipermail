<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] freeing the reactor to do other jobs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20freeing%20the%20reactor%20to%20do%20other%20jobs&In-Reply-To=8496caf30811070529t70a999acx96711d1af63eb12b%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018659.html">
   <LINK REL="Next"  HREF="018658.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] freeing the reactor to do other jobs</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20freeing%20the%20reactor%20to%20do%20other%20jobs&In-Reply-To=8496caf30811070529t70a999acx96711d1af63eb12b%40mail.gmail.com"
       TITLE="[Twisted-Python] freeing the reactor to do other jobs">exarkun at divmod.com
       </A><BR>
    <I>Fri Nov  7 08:59:23 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018659.html">[Twisted-Python] freeing the reactor to do other jobs
</A></li>
        <LI>Next message: <A HREF="018658.html">[Twisted-Python] freeing the reactor to do other jobs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18657">[ date ]</a>
              <a href="thread.html#18657">[ thread ]</a>
              <a href="subject.html#18657">[ subject ]</a>
              <a href="author.html#18657">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 7 Nov 2008 08:29:50 -0500, Jeff Dyke &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jeff.dyke at gmail.com</A>&gt; wrote:
&gt;<i>I'm using the XMLRPC server in twisted and a few methods call other,
</I>&gt;<i>sometimes long running, functions/methods.  I'm trying to get my brain
</I>&gt;<i>around how to free the reactor to respond to other requests while this
</I>&gt;<i>is happening.
</I>&gt;<i>
</I>&gt;<i>A scenario.  A call is made to the server, which selects say 10K rows
</I>&gt;<i>from a db and needs to check each row against a table and if they do
</I>&gt;<i>not exist, insert them.
</I>&gt;<i>
</I>&gt;<i>&quot;&quot;&quot; Oversimplified version of the process &quot;&quot;&quot;
</I>&gt;<i>def getData(self,user_id):
</I>&gt;<i>    rows = self.getUserData(user_id)
</I>&gt;<i>    for row in rows:
</I>&gt;<i>        if self.existsInQueue(row['some_id']):
</I>&gt;<i>            continue
</I>&gt;<i>        else:
</I>&gt;<i>             self.insertQueue(row)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>I want the caller to wait on a result from this process, but I also
</I>&gt;<i>want the reactor to be able to handle other requests as they come in.
</I>&gt;<i>This function is not directly registered in the xmlrpc server with
</I>&gt;<i>xmlrpc_getData, but is called by that type of method after validation
</I>&gt;<i>that it is allowed to run in this context.
</I>&gt;<i>
</I>&gt;<i>What i've seen when this has thousands of rows to process is that the
</I>&gt;<i>reactor is tied up and can not respond to requests until complete.
</I>&gt;<i>Which obviously leads to me believe that I'm not using twisted
</I>&gt;<i>correctly/to its potential.  I have read the deferred/asynchronous doc
</I>&gt;<i>pages...but am having a hard time getting my head around it and would
</I>&gt;<i>appreciate any advice.
</I>&gt;<i>
</I>&gt;<i>When i don't specifically need the caller to get the final result,
</I>&gt;<i>i've been suing deferToThread, but feel in some of those instances i
</I>&gt;<i>could possibly write better code, rather then sending to a thread.
</I>
One thing you might not have discovered yet is that even if you use
deferToThread, you can still give the final result to the caller.  The
XML-RPC support in Twisted supports Deferreds - meaning that if an
xmlrpc_ method returns a Deferred, then no response is sent to the
XML-RPC request until that Deferred fires, and then the result is sent
as the XML-RPC response.

Since most libraries for interacting with RDBMs using SQL present a
blocking interface, Twisted includes twisted.internet.adbapi, a thin
layer on top of DB-API 2.0 which runs all of the blocking stuff in a
threadpool.  If most of your time is being spent waiting for rows from
a database, then adbapi might help you out, and since adbapi gives you
Deferreds, this is trivial to integrate into an XML-RPC server.

For other blocking tasks - it depends.  If the task is blocking on an
event, then transforming that event into a callback (probably using a
Deferred, since Deferreds are a good tool to use to manage callbacks)
and then putting your code into a callback instead of blocking on the
event is the right thing to do.  How exactly you turn a particular
event into a callback depends on the details of the event, though.  If
the blocking task is CPU bound, then running it in another thread or
another process can make sense.  It's also possible to insert explicit
control-flow yields into the implementation of the CPU bound task (at
least, sometimes) so that the reactor can service other event sources
as the calculation progresses.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018659.html">[Twisted-Python] freeing the reactor to do other jobs
</A></li>
	<LI>Next message: <A HREF="018658.html">[Twisted-Python] freeing the reactor to do other jobs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18657">[ date ]</a>
              <a href="thread.html#18657">[ thread ]</a>
              <a href="subject.html#18657">[ subject ]</a>
              <a href="author.html#18657">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
