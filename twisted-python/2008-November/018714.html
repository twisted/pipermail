<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Exception handling in t.e.adbapi
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Exception%20handling%20in%20t.e.adbapi&In-Reply-To=gg2biv%24gi9%241%40ger.gmane.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018713.html">
   <LINK REL="Next"  HREF="018718.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Exception handling in t.e.adbapi</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Exception%20handling%20in%20t.e.adbapi&In-Reply-To=gg2biv%24gi9%241%40ger.gmane.org"
       TITLE="[Twisted-Python] Exception handling in t.e.adbapi">exarkun at divmod.com
       </A><BR>
    <I>Wed Nov 19 19:45:42 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018713.html">[Twisted-Python] Exception handling in t.e.adbapi
</A></li>
        <LI>Next message: <A HREF="018718.html">[Twisted-Python] Re: Exception handling in t.e.adbapi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18714">[ date ]</a>
              <a href="thread.html#18714">[ thread ]</a>
              <a href="subject.html#18714">[ subject ]</a>
              <a href="author.html#18714">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 19 Nov 2008 16:38:54 -0800, Don Dwiggins &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ddwiggins at advpubtech.com</A>&gt; wrote:
&gt;<i>I've been using adbapi (with pyodbc talking to MS SQL Server) successfully 
</I>&gt;<i>in a Windows service.  I've discovered that occasionally, the network 
</I>&gt;<i>between the service and the database machine goes down and comes back up 
</I>&gt;<i>(either that or the database server itself cycles down and back up).  When 
</I>&gt;<i>this happens, any pyodbc connections hanging around are corrupted, so that 
</I>&gt;<i>the next query gets an exception (class pyodbc.Error).  Currently, the best 
</I>&gt;<i>thing I can do is to restart the service.
</I>&gt;<i>
</I>&gt;<i>I'm trying to rewrite the service to be able to catch, analyze, and respond 
</I>&gt;<i>to exceptions from pyodbc.  In particular, in the case above, it's possible 
</I>&gt;<i>to reconnect and retry the query.  If the network connection is still down, 
</I>&gt;<i>I'd like to log it, send a message to alert someone, or whatever.
</I>
How do you tell the difference between a network error which prevented a
statement from being executed by the SQL server and a network error which
only prevented the response indicating that the statement was successfully
executed from being returned to you?  If you can't tell the difference, how
do you ensure that you don't re-execute statements which modify the database
causing corruption of your data?

&gt;<i>I've rewritten a ConnectionPool.runQuery call to use runInteraction to call 
</I>&gt;<i>a function (in a thread) that works with the cursor created in 
</I>&gt;<i>runInteraction to execute the query.  The function wraps the 
</I>&gt;<i>cursor.execute(...) in a try-except.  I can successfully catch the 
</I>&gt;<i>exception, and I try to recover by doing cursor.reconnect(), then 
</I>&gt;<i>cursor.reopen(), and finally cursor.execute(...) again.  I'm finding that 
</I>&gt;<i>this fails with a &quot;wrong connection for thread&quot; exception.  I haven't been 
</I>&gt;<i>able to figure out why that should happen; more importantly, I'm not sure 
</I>&gt;<i>that I'm going about this in the right way. Any insights or pointers to code 
</I>&gt;<i>that does this kind of thing would be appreciated.
</I>
I've never used pyodbc, but presumably the exception indicates you're
using the objects in a thread where they're not allowed to be used.  You
should find out what the threading restrictions of the module are and
then see where you're violating them.  One thing to keep in mind is that
ConnectionPool uses a ThreadPool.  That means you're never guaranteed that
two different functions will run in the same thread.  Whichever thread in
the pool is free will run the next task.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018713.html">[Twisted-Python] Exception handling in t.e.adbapi
</A></li>
	<LI>Next message: <A HREF="018718.html">[Twisted-Python] Re: Exception handling in t.e.adbapi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18714">[ date ]</a>
              <a href="thread.html#18714">[ thread ]</a>
              <a href="subject.html#18714">[ subject ]</a>
              <a href="author.html#18714">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
