<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] MemoryError in twisted causes the program to exit,	or not
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20MemoryError%20in%20twisted%20causes%20the%20program%20to%20exit%2C%0A%09or%20not&In-Reply-To=%3CCAMWA1_oDnNCpWA-NuATdKQPREr1nALwBZrbTJ1-TCo18SkVPQw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="058573.html">
   <LINK REL="Next"  HREF="058559.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] MemoryError in twisted causes the program to exit,	or not</H1>
    <B>Benjamin Rutt</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20MemoryError%20in%20twisted%20causes%20the%20program%20to%20exit%2C%0A%09or%20not&In-Reply-To=%3CCAMWA1_oDnNCpWA-NuATdKQPREr1nALwBZrbTJ1-TCo18SkVPQw%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] MemoryError in twisted causes the program to exit,	or not">rutt.4 at osu.edu
       </A><BR>
    <I>Thu Sep 27 20:41:36 MDT 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="058573.html">[Twisted-Python] dynamic FTP realm
</A></li>
        <LI>Next message (by thread): <A HREF="058559.html">[Twisted-Python] MemoryError in twisted causes the program to	exit, or not
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58558">[ date ]</a>
              <a href="thread.html#58558">[ thread ]</a>
              <a href="subject.html#58558">[ subject ]</a>
              <a href="author.html#58558">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, I am trying to understand what will happen in my long-running twisted
server program when the available memory is low.

If I run the following program with increasing numeric seeds as arguments,
0, 1, 2, 3, 4, … , some of the time the out of memory condition will crash
and exit the program right away (when the MemoryError is raised inside
twisted core code), and other times it will just carry on with an
UnhandledError (if the MemoryError is raised inside my hi() function below).

Sample code:

---
#!/usr/bin/env python

import sys, resource, random, traceback

from twisted.internet         import reactor

resource.setrlimit(resource.RLIMIT_AS, (180 * 1024 * 1024,
resource.RLIM_INFINITY))

data = []
random.seed(int(sys.argv[1]))

def hi():
    data.append('x' * random.randint(1, 10000))
    reactor.callLater(0, hi)

def main():
    reactor.callLater(0, hi)

reactor.callWhenRunning(main)
reactor.run()
 ---

I am using python 2.7.1, twisted 11.0.0.

Sample runs follow:

bash$ n=0; while true; do echo &quot;starting rep $n&quot;; ./twisted-oom.py $n;
n=$(($n+1)); echo; done
starting rep 0
Traceback (most recent call last):
  File “./twisted-oom.py&quot;, line 21, in &lt;module&gt;
    reactor.run()
  File
&quot;/sw/external/twisted-py27-11.0.0/lib/python/twisted/internet/base.py&quot;,
line 1162, in run
    self.mainLoop()
  File
&quot;/sw/external/twisted-py27-11.0.0/lib/python/twisted/internet/base.py&quot;,
line 1177, in mainLoop
    log.err()
  File &quot;/sw/external/twisted-py27-11.0.0/lib/python/twisted/python/log.py&quot;,
line 197, in err
    _stuff = failure.Failure()
MemoryError

starting rep 1
Traceback (most recent call last):
  File &quot;. /twisted-oom.py&quot;, line 21, in &lt;module&gt;
    reactor.run()
  File
&quot;/sw/external/twisted-py27-11.0.0/lib/python/twisted/internet/base.py&quot;,
line 1162, in run
    self.mainLoop()
  File
&quot;/sw/external/twisted-py27-11.0.0/lib/python/twisted/internet/base.py&quot;,
line 1177, in mainLoop
    log.err()
MemoryError

starting rep 2
Unhandled Error
Traceback (most recent call last):
  File &quot;./twisted-oom.py&quot;, line 21, in &lt;module&gt;
    reactor.run()
  File
&quot;/sw/external/twisted-py27-11.0.0/lib/python/twisted/internet/base.py&quot;,
line 1162, in run
    self.mainLoop()
  File
&quot;/sw/external/twisted-py27-11.0.0/lib/python/twisted/internet/base.py&quot;,
line 1171, in mainLoop
    self.runUntilCurrent()
--- &lt;exception caught here&gt; ---
  File
&quot;/sw/external/twisted-py27-11.0.0/lib/python/twisted/internet/base.py&quot;,
line 793, in runUntilCurrent
    call.func(*call.args, **call.kw)
  File &quot;/home/ruttbe/dev/oneoff/twisted-oom.py&quot;, line 14, in hi
    data.append('x' * random.randint(1, 10000))
exceptions.MemoryError:

On the first two runs, the program exited quickly, but on the last rep
(&quot;starting rep 2&quot;), it just carried on running with the reactor still
running.  It would be nice if there was a way to make the out of memory
behavior consistent, so I would know that it would either always carry on
running with a MemoryError stack trace, or always crash out and end the
program.  Maybe runUntilCurrent should not catch MemoryError from user code
and should let it propagate out?  Also wondering if there are other
different behaviors in other areas of the code (such as callbacks into user
code such as dataReceived, outReceived, lineReceived, etc.).  i.e. is the
observed behavior (that MemoryError in user code is caught and MemoryError
in twisted core is not) intentional, or an accident?

Thanks,
-- 
Benjamin Rutt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20120927/d6b78e3d/attachment-0001.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="058573.html">[Twisted-Python] dynamic FTP realm
</A></li>
	<LI>Next message (by thread): <A HREF="058559.html">[Twisted-Python] MemoryError in twisted causes the program to	exit, or not
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58558">[ date ]</a>
              <a href="thread.html#58558">[ thread ]</a>
              <a href="subject.html#58558">[ subject ]</a>
              <a href="author.html#58558">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
