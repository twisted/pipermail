<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Asynchronous code in a context manager
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Asynchronous%20code%20in%20a%20context%20manager&In-Reply-To=%3C1521803817.3234826.1313425600.055CCD14%40webmail.messagingengine.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="031858.html">
   <LINK REL="Next"  HREF="064322.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Asynchronous code in a context manager</H1>
    <B>Peter Westlake</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Asynchronous%20code%20in%20a%20context%20manager&In-Reply-To=%3C1521803817.3234826.1313425600.055CCD14%40webmail.messagingengine.com%3E"
       TITLE="[Twisted-Python] Asynchronous code in a context manager">peter.westlake at pobox.com
       </A><BR>
    <I>Fri Mar 23 05:16:57 MDT 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="031858.html">[Twisted-Python] we can stop depending on pypiwin32
</A></li>
        <LI>Next message (by thread): <A HREF="064322.html">[Twisted-Python] Asynchronous code in a context manager
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31860">[ date ]</a>
              <a href="thread.html#31860">[ thread ]</a>
              <a href="subject.html#31860">[ subject ]</a>
              <a href="author.html#31860">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a context manager whose __exit__ method needs to run some asynchronous Twisted code. Using Crochet's @wait_for very nearly works:

no_setup()

class Example(object):
    def __exit__(t, v, tb):
            return self.cleanup()

   @wait_for
   @inlineCallbacks
    def cleanup(self):
           yield .....
           returnValue(False)

    ....

Then
     with e as Example():

This gets an error because the cleanup function is being called in the reactor thread. Using reactor.callInThread(self.cleanup()) makes it work up to a point, but it doesn't wait for the thread to finish. Is there a way to make this work? The alternative is simply to call the cleanup function explicitly from the with statement, and have the __exit__ handler throw an error if you forget. So any solution needs to be cleaner than that, or there's no point. I'm beginning to suspect that this is the case!

Peter.

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="031858.html">[Twisted-Python] we can stop depending on pypiwin32
</A></li>
	<LI>Next message (by thread): <A HREF="064322.html">[Twisted-Python] Asynchronous code in a context manager
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31860">[ date ]</a>
              <a href="thread.html#31860">[ thread ]</a>
              <a href="subject.html#31860">[ subject ]</a>
              <a href="author.html#31860">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
