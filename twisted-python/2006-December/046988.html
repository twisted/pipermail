<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] delay_connect problems in twisted.enterprise.adbapi
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20delay_connect%20problems%20in%20twisted.enterprise.adbapi&In-Reply-To=%3C9bb390e70612072039r425951f8g6cc6c39ccd012cc2%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="046987.html">
   <LINK REL="Next"  HREF="046989.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] delay_connect problems in twisted.enterprise.adbapi</H1>
    <B>Rob Hoadley</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20delay_connect%20problems%20in%20twisted.enterprise.adbapi&In-Reply-To=%3C9bb390e70612072039r425951f8g6cc6c39ccd012cc2%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] delay_connect problems in twisted.enterprise.adbapi">hoadley at gmail.com
       </A><BR>
    <I>Thu Dec  7 21:39:24 MST 2006</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="046987.html">[Twisted-Python] Re: Twisted-Python Digest, Vol 33, Issue 6
</A></li>
        <LI>Next message (by thread): <A HREF="046989.html">[Twisted-Python] delay_connect problems in	twisted.enterprise.adbapi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46988">[ date ]</a>
              <a href="thread.html#46988">[ thread ]</a>
              <a href="subject.html#46988">[ subject ]</a>
              <a href="author.html#46988">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I'm having a problem using twisted.enterprise.adbapi.

The problem has to do with the 'delay_connect' option I send with my db
connection kwargs.  I want to send sybase connection appname and hostname
info.  The only way I can do this is using the delayed connect option.

I have the following standalone program example that works just fine:

vrdb = vr_db('billing_db', 'appname')
# vr_db just is a helper class for logical dbname -&gt; db connection info

db_kwargs  = vrdb.return_kwargs()

db_kwargs['cp_min'] = 1  # one thread min
db_kwargs['cp_max'] = 1  # one thread max  = only one db connection
db_kwargs['cp_reconnect'] = 1  # reconnect if die
db_kwargs['cp_noisy'] =  1
db_kwargs['delay_connect'] = 1 #  do the delayed connect
db_kwargs['cp_openfun'] = vrdb._vrdbOptions

print db_kwargs
dbpool = adbapi.ConnectionPool(vrdb.return_import_name(), **db_kwargs)

# _vrdbOptions adds the following two things to the connection
# conn.set_property (Sybase.CS_HOSTNAME, self.hostname)
# conn.set_property(Sybase.CS_APPNAME, self.appname)


a = storage(dbpool, d)
a.run()
reactor.run()

run does a sql query.

   def run(self):
        ''' utility method if the script is called directly '''
        self.get_campaign_info('id', 588103).addCallback( self.print_result
).addErrback(self.error_happened)

This works fine and dandy.  With the hostname and appname showing up in my
sp_who optput (show's you who's logged in from where with what appname )

Now my problem is when I use the database connection part in
makeService(config) and pass a dbpool to a service, my service starts up
fine,  but when
I have a database operation I get this:



2006/12/07 15:46:17 PST [-] [Failure instance: Traceback:
twisted.enterprise.adbapi.ConnectionLost:
        /usr/lib/python2.4/threading.py:422:run

/usr/lib/python2.4/site-packages/twisted/python/threadpool.py:148:_worker

/usr/lib/python2.4/site-packages/twisted/python/context.py:59:callWithContext


/usr/lib/python2.4/site-packages/twisted/python/context.py:37:callWithContext
        --- &lt;exception caught here&gt; ---

/usr/lib/python2.4/site-packages/twisted/internet/threads.py:25:_putResultInDeferred


/usr/lib/python2.4/site-packages/twisted/enterprise/adbapi.py:379:_runInteraction

/usr/lib/python2.4/site-packages/twisted/enterprise/adbapi.py:64:rollback
        ]


So I've reverted my code to pass db_kwargs['delay_connect'] = 0 and it's
working fine as long as I don't try the delay_connect.   I'm  hoping someone
has seen this before and can point me in the right direction.  I'd really
like to have my appname and hostname show up on the db side.

I'm using twisted, sybase 12.5,  and the most recent Sybase module.  The
only difference is the way I'm connecting is one program is a tap created
from mktap and the other a standalone script.

&gt;&gt;&gt;<i> import Sybase
</I>&gt;&gt;&gt;<i> Sybase.__version__
</I>'0.37'
&gt;&gt;&gt;<i> import twisted
</I>&gt;&gt;&gt;<i> twisted.__version__
</I>'2.4.0'

Thanks

-rob
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20061207/f777d907/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="046987.html">[Twisted-Python] Re: Twisted-Python Digest, Vol 33, Issue 6
</A></li>
	<LI>Next message (by thread): <A HREF="046989.html">[Twisted-Python] delay_connect problems in	twisted.enterprise.adbapi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46988">[ date ]</a>
              <a href="thread.html#46988">[ thread ]</a>
              <a href="subject.html#46988">[ subject ]</a>
              <a href="author.html#46988">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
