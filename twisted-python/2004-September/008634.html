<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Memory leak//problem in twisted write procedures
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Memory%20leak//problem%20in%20twisted%20write%20procedures&In-Reply-To=200409162003.38140.josh%40chatgris.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008633.html">
   <LINK REL="Next"  HREF="008635.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Memory leak//problem in twisted write procedures</H1>
    <B>exarkun at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Memory%20leak//problem%20in%20twisted%20write%20procedures&In-Reply-To=200409162003.38140.josh%40chatgris.com"
       TITLE="[Twisted-Python] Memory leak//problem in twisted write procedures">exarkun at divmod.com
       </A><BR>
    <I>Thu Sep 16 20:29:48 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008633.html">[Twisted-Python] Memory leak//problem in twisted write procedures
</A></li>
        <LI>Next message: <A HREF="008635.html">[Twisted-Python] Memory leak//problem in twisted write procedures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8634">[ date ]</a>
              <a href="thread.html#8634">[ thread ]</a>
              <a href="subject.html#8634">[ subject ]</a>
              <a href="author.html#8634">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 16 Sep 2004 20:03:38 -0400, Joshua Moore-Oliva &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">josh at chatgris.com</A>&gt; wrote:
&gt;<i>I believe I have identified a memory problem in twisted.
</I>&gt;<i> 
</I>&gt;<i> [snip]
</I>&gt;<i> 
</I>&gt;<i> However, I have since been hit with an apparent memory leak.  After reading through the twisted source (specifically the write routines in twisted/internet/abstract.py) 
</I>&gt;<i> I believe I have come across the problem.
</I>&gt;<i> 
</I>&gt;<i> ***
</I>&gt;<i> 
</I>&gt;<i> the write implementation continually increases it's write databuffer, only freeing up memory when the data buffer is all sent
</I>&gt;<i> 
</I>&gt;<i> However, successive write operations append data to the data buffer..  So if a program is able to keep the data buffer from ever completely emptying (which mine is)
</I>&gt;<i> then the data buffer will forever grow, resulting in a memory problem.
</I>&gt;<i> 
</I>&gt;<i> I have added some output to print out the length of the data buffer and the offset, and after only 10 minutes of running the numbers are already
</I>&gt;<i> 
</I>&gt;<i> offset == 76906496 
</I>&gt;<i> 
</I>&gt;<i> dataBuffer len == 120768384
</I>&gt;<i> 
</I>&gt;<i> ***
</I>&gt;<i> 
</I>
  Whether or not &quot;leak&quot; is the appropriate term for this is debatable.  That aside, it is somewhat undesirable, but it is completely avoidable without making any changes to Twisted*.  There are two concepts involved, Producers and Consumers.  The transport is a Consumer in this case, and whatever protocol you have that is writing to it is the Producer.  The Consumer will notify the Producer when it would be a good idea to write more bytes.  Since this will only happen when the write buffer is empty, it avoids the problem of an ever growing buffer in the transport.

  Producers and Consumers aren't _too_ well documented, but the relevant interfaces are quite simple:

<A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.IProducer.html">http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.IProducer.html</A>
<A HREF="http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.IConsumer.html">http://twistedmatrix.com/documents/current/api/twisted.internet.interfaces.IConsumer.html</A>

  There are a few examples throughout Twisted itself.  One such (FileSender, at the end of bottom of the module):

<A HREF="http://cvs.twistedmatrix.com/cvs/trunk/twisted/protocols/basic.py?view=markup&amp;rev=11450&amp;root=Twisted">http://cvs.twistedmatrix.com/cvs/trunk/twisted/protocols/basic.py?view=markup&amp;rev=11450&amp;root=Twisted</A>


&gt;<i> Now, reading through the source to fix this problem, the fastest solution (requiring the least change to the existing code) would be to splice//reduce the size of the 
</I>&gt;<i> dataBuffer after offset exceeds a certain number.
</I>&gt;<i> 
</I>
  It is the easiest change to make, but it leads to detrimental string copying behavior.  Which this is a minor concern in the case where many small writes are being made while the buffer is large (because huge amounts of copying is already going on), it is a noticable slowdown in the more common case when the buffer is typically empty or almost empty.

  Jp

  * A change _should_ be made to Twisted eventually.  A good solution would involve a zero-copy buffering system, such as a list.  There is an implementation of this, but it involves so many nasty hacks that I don't feel it is worth including.  Shortly after 2.0 I plan to find time to clean up many of the low-level TCP implementation details, as they have grown increasingly crufty over the last year.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008633.html">[Twisted-Python] Memory leak//problem in twisted write procedures
</A></li>
	<LI>Next message: <A HREF="008635.html">[Twisted-Python] Memory leak//problem in twisted write procedures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8634">[ date ]</a>
              <a href="thread.html#8634">[ thread ]</a>
              <a href="subject.html#8634">[ subject ]</a>
              <a href="author.html#8634">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
