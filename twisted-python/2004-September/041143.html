<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Memory leak//problem in twisted write procedures
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Memory%20leak//problem%20in%20twisted%20write%20procedures&In-Reply-To=%3C200409162044.28955.josh%40chatgris.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="041142.html">
   <LINK REL="Next"  HREF="041147.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Memory leak//problem in twisted write procedures</H1>
    <B>Joshua Moore-Oliva</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Memory%20leak//problem%20in%20twisted%20write%20procedures&In-Reply-To=%3C200409162044.28955.josh%40chatgris.com%3E"
       TITLE="[Twisted-Python] Memory leak//problem in twisted write procedures">josh at chatgris.com
       </A><BR>
    <I>Thu Sep 16 18:44:28 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="041142.html">[Twisted-Python] Memory leak//problem in twisted write procedures
</A></li>
        <LI>Next message (by thread): <A HREF="041147.html">[Twisted-Python] domish.Element and deepcopy problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41143">[ date ]</a>
              <a href="thread.html#41143">[ thread ]</a>
              <a href="subject.html#41143">[ subject ]</a>
              <a href="author.html#41143">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i>   Whether or not &quot;leak&quot; is the appropriate term for this is debatable.  
</I>
I agree there, hence my use of Memory leak//problem :)

&gt;<i> 
</I>
&gt;<i> &gt; Now, reading through the source to fix this problem, the fastest solution (requiring the least change to the existing code) would be to splice//reduce the size of the 
</I>&gt;<i> &gt; dataBuffer after offset exceeds a certain number.
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i>   It is the easiest change to make, but it leads to detrimental string copying behavior.  
</I>&gt;&gt;<i>   Which this is a minor concern in the case where many small writes are being made while the buffer is large (because huge amounts of copying is already going on), 
</I>&gt;&gt;<i>   it is a noticable slowdown in the more common case when the buffer is typically empty or almost empty.  
</I>
I do not think my idea was properly communicated..

An interim change I think could work quite well along these lines 

from the abstract.py file
def doWrite(self):

      ...
        # If there is nothing left to send,
        if self.offset == len(self.dataBuffer):
            self.dataBuffer = &quot;&quot;
            self.offset = 0
            ...
       elif self.offset &gt; 1000000: #This would be best pre-defined somewhere
           self.dataBuffer = self.dataBuffer[self.offset:]
           self.offset=0
        
        return result

Note that these changes are just done in 'real-time' while writing my email, no guarantees that the change will even let pythons tartup without syntax errors :)

However, notice the check for offset &gt; a particular value.

This would prevent performance degredation for the more common case where the buffer is typically empty or almost empty, as the string would only be 
reduced in the event that too much memory was being wasted (even 10MB would be a good limit)

&gt;<i> 
</I>&gt;<i>   Jp
</I>&gt;<i> 
</I>&gt;<i>   * A change _should_ be made to Twisted eventually.  A good solution would involve a zero-copy buffering system, such as a list.  There is an implementation of this, but it involves so many nasty hacks that I don't feel it is worth including.  Shortly after 2.0 I plan to find time to clean up many of the low-level TCP implementation details, as they have grown increasingly crufty over the last year.
</I>
I agree with you that a list would be the best solution in the long term, but the above proposed solution would remove the current problem, as well as not affecting the more
common small buffer cases.

Joshua Moore-Oliva


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="041142.html">[Twisted-Python] Memory leak//problem in twisted write procedures
</A></li>
	<LI>Next message (by thread): <A HREF="041147.html">[Twisted-Python] domish.Element and deepcopy problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41143">[ date ]</a>
              <a href="thread.html#41143">[ thread ]</a>
              <a href="subject.html#41143">[ subject ]</a>
              <a href="author.html#41143">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
