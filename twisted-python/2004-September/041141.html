<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Memory leak//problem in twisted write procedures
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Memory%20leak//problem%20in%20twisted%20write%20procedures&In-Reply-To=%3C200409162003.38140.josh%40chatgris.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="041149.html">
   <LINK REL="Next"  HREF="041142.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Memory leak//problem in twisted write procedures</H1>
    <B>Joshua Moore-Oliva</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Memory%20leak//problem%20in%20twisted%20write%20procedures&In-Reply-To=%3C200409162003.38140.josh%40chatgris.com%3E"
       TITLE="[Twisted-Python] Memory leak//problem in twisted write procedures">josh at chatgris.com
       </A><BR>
    <I>Thu Sep 16 18:03:38 MDT 2004</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="041149.html">[Twisted-Python] Re: PyHeartbeat cookbook recipe
</A></li>
        <LI>Next message (by thread): <A HREF="041142.html">[Twisted-Python] Memory leak//problem in twisted write procedures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41141">[ date ]</a>
              <a href="thread.html#41141">[ thread ]</a>
              <a href="subject.html#41141">[ subject ]</a>
              <a href="author.html#41141">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I believe I have identified a memory problem in twisted.

A quick background..

I've been developing a program that has to use mssql for reasons beyond my control.

Due to the chaotic nature of mssql tds implementations, I created a program to pipe queries through to a windows box.

In the beginning, I was using asyn* for my communications, however asyn* was very inefficient when writing large amounts of data as after each write the
string would be spliced to remove the data written.

I then moved to twisted to use it's far more efficient buffer implementation, and the performance problems went away.

However, I have since been hit with an apparent memory leak.  After reading through the twisted source (specifically the write routines in twisted/internet/abstract.py) 
I believe I have come across the problem.

***

the write implementation continually increases it's write databuffer, only freeing up memory when the data buffer is all sent

However, successive write operations append data to the data buffer..  So if a program is able to keep the data buffer from ever completely emptying (which mine is)
then the data buffer will forever grow, resulting in a memory problem.

I have added some output to print out the length of the data buffer and the offset, and after only 10 minutes of running the numbers are already

offset == 76906496 

dataBuffer len == 120768384

***

Now, reading through the source to fix this problem, the fastest solution (requiring the least change to the existing code) would be to splice//reduce the size of the 
dataBuffer after offset exceeds a certain number.

However, I'm not too intimate with the source..  I will try that above solution to see if it does any good..  otherwise, i think that this is a fairly serious bug that should be addressed
by someone more intimate with the source.

Thanks, Joshua Moore-Oliva


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="041149.html">[Twisted-Python] Re: PyHeartbeat cookbook recipe
</A></li>
	<LI>Next message (by thread): <A HREF="041142.html">[Twisted-Python] Memory leak//problem in twisted write procedures
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#41141">[ date ]</a>
              <a href="thread.html#41141">[ thread ]</a>
              <a href="subject.html#41141">[ subject ]</a>
              <a href="author.html#41141">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
