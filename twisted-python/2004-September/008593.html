<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Performance issue in reactor.callLater
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Performance%20issue%20in%20reactor.callLater&In-Reply-To=80F37A35-01C7-11D9-AC9C-000A95A50FB2%40fuhm.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008587.html">
   <LINK REL="Next"  HREF="008594.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Performance issue in reactor.callLater</H1>
    <B>Stefan Behnel</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Performance%20issue%20in%20reactor.callLater&In-Reply-To=80F37A35-01C7-11D9-AC9C-000A95A50FB2%40fuhm.net"
       TITLE="[Twisted-Python] Performance issue in reactor.callLater">behnel_ml at gkec.informatik.tu-darmstadt.de
       </A><BR>
    <I>Thu Sep  9 03:21:35 EDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008587.html">[Twisted-Python] Performance issue in reactor.callLater
</A></li>
        <LI>Next message: <A HREF="008594.html">[Twisted-Python] Performance issue in reactor.callLater
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8593">[ date ]</a>
              <a href="thread.html#8593">[ thread ]</a>
              <a href="subject.html#8593">[ subject ]</a>
              <a href="author.html#8593">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
James Y Knight schrieb:
&gt;<i> However, I'm unconvinced about the reasoning in:
</I>&gt;<i> 
</I>&gt;&gt;<i> Ok, I thought about it. And I believe the best way to do this is to 
</I>&gt;&gt;<i> write a specialized heap version. I copied the heapq implementation 
</I>&gt;&gt;<i> and adapted it so that it keeps track of the position in the heap for 
</I>&gt;&gt;<i> each DelayedCall. That makes it possible to remove a call without 
</I>&gt;&gt;<i> linear overhead and in log(N) time.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> To me, it seems like the right thing is what I think you had before:
</I>&gt;<i> 1) on cancel, mark it canceled
</I>
That works. However, in cases with many pending delayed calls leaving the cancelled ones on the heap may unnecessarily increase the heap size quite a bit, so I figured it might be better to keep the size low. But I admit that this is an undermotivated decision.

I personally had the case of an ACK tracker where my first approach was to start a timeout for each ACK and then cancel it. But when I saw the desastrous performance of the original Twisted implementation I quickly wrote my own queue for it. Anyway, in such a case you'd have a lot of cancelled delayed calls on the heap and they'd unnecessarily increase the time for new insertions (which is done, as I said, as late as possible, but before the run-loop).

I played with the idea of giving cancel() a new boolean parameter &quot;quick_cancel&quot; that would skip the removal step if set to True. All you'd need to (re-)add in that case would be the check in the runUntilCurrent loop if the current call was cancelled. That may be a good compromise.


&gt;<i> 2) on delay, mark it delayed
</I>
That doesn't work.


&gt;<i> 3) when about to run a DelayedCall, if it is cancelled, ignore it. If it 
</I>&gt;<i> is delayed, reinsert it into the heap in the proper place.
</I>&gt;<i> 
</I>&gt;<i> Why did you change to the current method from that?
</I>
Delaying a call breaks the heap invariant and therefore may hinder new insertions. There is a simple work around for delay: Store the delay time somewhere in the object and set it when we find the call as first item. /Then/ move it to the right position. This lessens the number of reinsertions if the call is delayed more often. Could be worth it.

However, this doesn't work for reset. Reset accepts an arbitrary time value that may be lower than the original. A work around here could be to correct the heap position in either direction when the time value changes, but that is about as much work as removing and reinserting it.


I chose the current solution as I figured it would be a good trade-off between code complexity, special cases and performance. The quick_cancel thing is easy to implement (4 lines), though.

Could I have other opinions on this?

Stefan



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008587.html">[Twisted-Python] Performance issue in reactor.callLater
</A></li>
	<LI>Next message: <A HREF="008594.html">[Twisted-Python] Performance issue in reactor.callLater
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8593">[ date ]</a>
              <a href="thread.html#8593">[ thread ]</a>
              <a href="subject.html#8593">[ subject ]</a>
              <a href="author.html#8593">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
