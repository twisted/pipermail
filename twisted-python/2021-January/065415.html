<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Thread Cancelled
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Thread%20Cancelled&In-Reply-To=%3CCAAXGW-z5F%2B1a_u7gvBG1JSzpvLmjOapHa9AeZB4uJt8JtamckQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065419.html">
   <LINK REL="Next"  HREF="065416.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Thread Cancelled</H1>
    <B>Robert DiFalco</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Thread%20Cancelled&In-Reply-To=%3CCAAXGW-z5F%2B1a_u7gvBG1JSzpvLmjOapHa9AeZB4uJt8JtamckQ%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Thread Cancelled">robert.difalco at gmail.com
       </A><BR>
    <I>Sun Jan 24 10:44:36 MST 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065419.html">[Twisted-Python] Questions about Project Leadership committee
</A></li>
        <LI>Next message (by thread): <A HREF="065416.html">[Twisted-Python] Thread Cancelled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65415">[ date ]</a>
              <a href="thread.html#65415">[ thread ]</a>
              <a href="subject.html#65415">[ subject ]</a>
              <a href="author.html#65415">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, I apologize this question is a little vague. I'm looking for pointers.
I have a klein route that makes an underlying deferToThread call with a
simple single thread (an IO based sync call I can't change, a boto3 sqs
write). The thread pool is simple, just a couple of threads, nothing fancy.

VERY rarely it appears that Klein cancels the thread. What techniques can I
use to figure out why my thread is being Canceled? There's nothing in the
failure to tell me &quot;who, why, or where&quot; it was canceled. Also, I cannot get
this down to a reproducible case, but here's the boto3 sqs wrapper, this
fall back works fine, but it's a band-aide for an error I can't track down.:

def write(self, payload):
    &quot;&quot;&quot;
    Write message to SQS async from thread pool. If twisted cancels the
    thread, instead write synchronously.

    def _retrySynchronously(error):
        if error.type != CancelledError:
            return error

        log.warn(&quot;Async SQS write cancelled. Calling synchronously.&quot;)
        return defer.succeed(self._writeSyncFallback(payload))

    deferredCall = self._deferToThread(self.sqs.write, payload)
    deferredCall.addErrback(_retrySynchronously)
    return deferredCall

def _writeSyncFallback(self, payload):
    return self.sqs.write(payload)

The _deferToThread call just uses my own thread pool with 2 threads, but is
otherwise stock.

Is there a level of logging I'm missing or some other thing that would tell
me why the thread is being canceled? The retry works great and Klein does
not return an error from the route.

Thanks in advance.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20210124/9ecc0d44/attachment-0001.htm&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065419.html">[Twisted-Python] Questions about Project Leadership committee
</A></li>
	<LI>Next message (by thread): <A HREF="065416.html">[Twisted-Python] Thread Cancelled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65415">[ date ]</a>
              <a href="thread.html#65415">[ thread ]</a>
              <a href="subject.html#65415">[ subject ]</a>
              <a href="author.html#65415">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
