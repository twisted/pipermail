<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Thread Cancelled
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Thread%20Cancelled&In-Reply-To=%3CCAMTx_3Az-pUea7fC%3DFyAhrBkN657iok_ab%2ByftPVn40c730JOw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="065415.html">
   <LINK REL="Next"  HREF="065417.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Thread Cancelled</H1>
    <B>Colin Dunklau</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Thread%20Cancelled&In-Reply-To=%3CCAMTx_3Az-pUea7fC%3DFyAhrBkN657iok_ab%2ByftPVn40c730JOw%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Thread Cancelled">colin.dunklau at gmail.com
       </A><BR>
    <I>Sun Jan 24 12:31:51 MST 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="065415.html">[Twisted-Python] Thread Cancelled
</A></li>
        <LI>Next message (by thread): <A HREF="065417.html">[Twisted-Python] Thread Cancelled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65416">[ date ]</a>
              <a href="thread.html#65416">[ thread ]</a>
              <a href="subject.html#65416">[ subject ]</a>
              <a href="author.html#65416">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, Jan 24, 2021 at 11:45 AM Robert DiFalco &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">robert.difalco at gmail.com</A>&gt;
wrote:

&gt;<i> Hi, I apologize this question is a little vague. I'm looking for pointers.
</I>&gt;<i> I have a klein route that makes an underlying deferToThread call with a
</I>&gt;<i> simple single thread (an IO based sync call I can't change, a boto3 sqs
</I>&gt;<i> write). The thread pool is simple, just a couple of threads, nothing fancy.
</I>&gt;<i>
</I>&gt;<i> VERY rarely it appears that Klein cancels the thread. What techniques can
</I>&gt;<i> I use to figure out why my thread is being Canceled? There's nothing in the
</I>&gt;<i> failure to tell me &quot;who, why, or where&quot; it was canceled. Also, I cannot get
</I>&gt;<i> this down to a reproducible case, but here's the boto3 sqs wrapper, this
</I>&gt;<i> fall back works fine, but it's a band-aide for an error I can't track down.:
</I>&gt;<i>
</I>&gt;<i> def write(self, payload):
</I>&gt;<i>     &quot;&quot;&quot;
</I>&gt;<i>     Write message to SQS async from thread pool. If twisted cancels the
</I>&gt;<i>     thread, instead write synchronously.
</I>&gt;<i>
</I>&gt;<i>     def _retrySynchronously(error):
</I>&gt;<i>         if error.type != CancelledError:
</I>&gt;<i>             return error
</I>&gt;<i>
</I>&gt;<i>         log.warn(&quot;Async SQS write cancelled. Calling synchronously.&quot;)
</I>&gt;<i>         return defer.succeed(self._writeSyncFallback(payload))
</I>&gt;<i>
</I>&gt;<i>     deferredCall = self._deferToThread(self.sqs.write, payload)
</I>&gt;<i>     deferredCall.addErrback(_retrySynchronously)
</I>&gt;<i>     return deferredCall
</I>&gt;<i>
</I>&gt;<i> def _writeSyncFallback(self, payload):
</I>&gt;<i>     return self.sqs.write(payload)
</I>&gt;<i>
</I>&gt;<i> The _deferToThread call just uses my own thread pool with 2 threads, but
</I>&gt;<i> is otherwise stock.
</I>&gt;<i>
</I>&gt;<i> Is there a level of logging I'm missing or some other thing that would
</I>&gt;<i> tell me why the thread is being canceled? The retry works great and Klein
</I>&gt;<i> does not return an error from the route.
</I>&gt;<i>
</I>&gt;<i> Thanks in advance.
</I>&gt;<i>
</I>&gt;<i>
</I>I think we'll need to see more code for this, specifically the caller of
that `write` method, and its callers, etc. Note that the thread itself
isn't being cancelled, the Deferred you get from _deferToThread is... so
you'll most likely need to find out what code interacts with that object to
progress in isolating this.

In my quick skim of the deferToThread and ThreadPool source, I can't find
any explicit cancellations. While that certainly doesn't rule it out, it
does make me think you're more likely to find the issue by inspecting the
callers involved.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20210124/55094bb6/attachment.htm&gt;
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="065415.html">[Twisted-Python] Thread Cancelled
</A></li>
	<LI>Next message (by thread): <A HREF="065417.html">[Twisted-Python] Thread Cancelled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#65416">[ date ]</a>
              <a href="thread.html#65416">[ thread ]</a>
              <a href="subject.html#65416">[ subject ]</a>
              <a href="author.html#65416">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
