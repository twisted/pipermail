<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] intermittent problem: not accepting new	connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20intermittent%20problem%3A%20not%20accepting%20new%0A%09connections&In-Reply-To=043501c91384%244c2c6b00%24e4854100%24%40com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018361.html">
   <LINK REL="Next"  HREF="018363.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] intermittent problem: not accepting new	connections</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20intermittent%20problem%3A%20not%20accepting%20new%0A%09connections&In-Reply-To=043501c91384%244c2c6b00%24e4854100%24%40com"
       TITLE="[Twisted-Python] intermittent problem: not accepting new	connections">exarkun at divmod.com
       </A><BR>
    <I>Wed Sep 10 16:44:15 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018361.html">[Twisted-Python] intermittent problem: not accepting new connections
</A></li>
        <LI>Next message: <A HREF="018363.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18362">[ date ]</a>
              <a href="thread.html#18362">[ thread ]</a>
              <a href="subject.html#18362">[ subject ]</a>
              <a href="author.html#18362">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 10 Sep 2008 13:32:06 -0700, Alec Matusis &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">matusis at yahoo.com</A>&gt; wrote:
&gt;<i>I have had a twisted epoll server that was heavily used, such that it
</I>&gt;<i>saturated CPU (100% shown by &quot;top&quot;, about 5000 connections, intense message
</I>&gt;<i>relaying).
</I>&gt;<i>I am using twisted 2.5.0 that I patched for epoll bug.
</I>&gt;<i>It was run on python 2.4.4 , 2.6.11 kernel on a single core xeon 3.0 GHz
</I>&gt;<i>CPU. This server has been on for many months, and it has been rock-stable.
</I>&gt;<i>
</I>&gt;<i>A couple of days ago I migrated that server to a newer machine: same patched
</I>&gt;<i>twisted 2.5.0, same python 2.4.4, newer 2.6.24 kernel and a quad core xeon
</I>&gt;<i>L5420 CPU.
</I>&gt;<i>CPU usage dropped from 100% to 30%, as expected, with the same rate of
</I>&gt;<i>client connections.
</I>&gt;<i>
</I>&gt;<i>However the server now has the following intermittent problem: about twice a
</I>&gt;<i>day, it stops accepting new connections for a short period of 5-10 minutes.
</I>&gt;<i>
</I>&gt;<i>telnet times out, I get this:
</I>&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">root at serv2</A>:/proc/net/netfilter# telnet localhost 5229
</I>&gt;<i>
</I>&gt;<i>Trying 127.0.0.1...
</I>&gt;<i>
</I>&gt;<i>Existing connections are not cut, they server receives/delivers messages
</I>&gt;<i>to/from them just fine.
</I>&gt;<i>These short periods of not accepting connections do not correlate with
</I>&gt;<i>increased CPU load or with the overall number of connections to the server.
</I>&gt;<i>
</I>&gt;<i>I have had a problem with the same symptoms before, when a server process
</I>&gt;<i>run out of its quota of file descriptors.
</I>&gt;<i>However, there were clear messages in the twisted log at that time, and
</I>&gt;<i>upping the ulimits solved the problem.
</I>&gt;<i>This time, there are no errors in ANY logs (twisted log. /var/log/messages,
</I>&gt;<i>etc)
</I>
Do non-error log messages continue to appear in the Twisted log?  ie, is
it clear that the logging system is still working, or could it have failed
in some way, obscuring any exception reports?

&gt;<i>
</I>&gt;<i>I am out of ideas on what this could be, because my setup is exactly the
</I>&gt;<i>same as I have been using in the last year, except for a faster CPU and a
</I>&gt;<i>newer kernel?
</I>&gt;<i>
</I>&gt;<i>I suspect that there are some new uncaught accept() exceptions in
</I>&gt;<i>internet/tcp.py in the part where it's looking for EMFILE, ENOBUFS, ENFILE,
</I>&gt;<i>ENOMEM, ECONNABORTED errors.
</I>&gt;<i>
</I>
Any new unhandled errno values should definitely result in an exception
being logged (notice that the `raise&#180; which follows the checks for
various errno values is inside a try/except which logs any exception).

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018361.html">[Twisted-Python] intermittent problem: not accepting new connections
</A></li>
	<LI>Next message: <A HREF="018363.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18362">[ date ]</a>
              <a href="thread.html#18362">[ thread ]</a>
              <a href="subject.html#18362">[ subject ]</a>
              <a href="author.html#18362">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
