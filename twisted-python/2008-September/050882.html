<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] intermittent problem: not accepting new	connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20intermittent%20problem%3A%20not%20accepting%20new%0A%09connections&In-Reply-To=%3C7a01f6c00809111817v609ff43kede137ed7ab900a5%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="050881.html">
   <LINK REL="Next"  HREF="050887.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] intermittent problem: not accepting new	connections</H1>
    <B>Alvin Delagon</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20intermittent%20problem%3A%20not%20accepting%20new%0A%09connections&In-Reply-To=%3C7a01f6c00809111817v609ff43kede137ed7ab900a5%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] intermittent problem: not accepting new	connections">adelagon at gmail.com
       </A><BR>
    <I>Thu Sep 11 19:17:13 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="050881.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
        <LI>Next message (by thread): <A HREF="050887.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50882">[ date ]</a>
              <a href="thread.html#50882">[ thread ]</a>
              <a href="subject.html#50882">[ subject ]</a>
              <a href="author.html#50882">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We had a similar problem like this, might as well share it with you guys:

Our Jabber server stopped taking in new connections due to our iptables at
some point in time (even lost some packets). We have an ip routing scheme
where ports 25,80,5223,10873 routed to 5222. Whenever this happens, we get
error error from our syslogs:

&quot;&quot;ip_conntrack: table full, dropping packet&quot;

<A HREF="http://support.imagestream.com/Resolving_ip_conntrack_table_full_Errors.html">http://support.imagestream.com/Resolving_ip_conntrack_table_full_Errors.html</A>

Might as well check dmesg if you have something like this. What we did is
disable iptables and removed its kernel modules.

On Fri, Sep 12, 2008 at 3:57 AM, Alec Matusis &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">matusis at yahoo.com</A>&gt; wrote:

&gt;<i> &gt; How does ulimit -a compare between old and new machine?
</I>&gt;<i>
</I>&gt;<i> ulimit is only higher on the new machine, I upped it. Also, from my
</I>&gt;<i> experience, running into  ulimits produces log messages.
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at serv2</A> ~&gt; cat /proc/23678/limits
</I>&gt;<i>
</I>&gt;<i> Limit                     Soft Limit           Hard Limit           Units
</I>&gt;<i>
</I>&gt;<i> Max cpu time              unlimited            unlimited            ms
</I>&gt;<i>
</I>&gt;<i> Max file size             unlimited            unlimited            bytes
</I>&gt;<i>
</I>&gt;<i> Max data size             unlimited            unlimited            bytes
</I>&gt;<i>
</I>&gt;<i> Max stack size            8388608              unlimited            bytes
</I>&gt;<i>
</I>&gt;<i> Max core file size        0                    unlimited            bytes
</I>&gt;<i>
</I>&gt;<i> Max resident set          1073741824           1073741824           bytes
</I>&gt;<i>
</I>&gt;<i> Max processes             126976               126976
</I>&gt;<i> processes
</I>&gt;<i> Max open files            25000                25000                files
</I>&gt;<i>
</I>&gt;<i> Max locked memory         32768                32768                bytes
</I>&gt;<i>
</I>&gt;<i> Max address space         unlimited            unlimited            bytes
</I>&gt;<i>
</I>&gt;<i> Max file locks            unlimited            unlimited            locks
</I>&gt;<i>
</I>&gt;<i> Max pending signals       126976               126976               signals
</I>&gt;<i>
</I>&gt;<i> Max msgqueue size         819200               819200               bytes
</I>&gt;<i>
</I>&gt;<i> Max nice priority         0                    0
</I>&gt;<i> Max realtime priority     0                    0
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; If you need to accept more than about
</I>&gt;<i> &gt; 64k connections (not necessarily concurrent) in less than TIME-WAIT
</I>&gt;<i> &gt; seconds, you might run out of ports.
</I>&gt;<i>
</I>&gt;<i> &gt; How does netstat look like?
</I>&gt;<i>
</I>&gt;<i> I have to wait for another outage tonight, to get more definite results on
</I>&gt;<i> this.
</I>&gt;<i> So far, I have had only one very brief outage at 7:46am
</I>&gt;<i> I was asleep, but I have some new data logged.
</I>&gt;<i> I have two servers, one on port 5222 (problematic one, let's call it serv1
</I>&gt;<i> ), and one on 5228 (that has no problems, call it serv2 ).
</I>&gt;<i> I made a script that measures the number of connections on each type of
</I>&gt;<i> server respectively like this:
</I>&gt;<i>
</I>&gt;<i> while [ 1 ]
</I>&gt;<i> do
</I>&gt;<i>  sleep 5
</I>&gt;<i>  netstat -ant | grep ESTABLISHED | awk '/:5228 /{a += 1}/:5222 /{b += 1}
</I>&gt;<i> END
</I>&gt;<i> {print strftime(&quot; %d %b %Y %H:%M:%S&quot;, systime(
</I>&gt;<i> ))&quot;   serv2: &quot;a&quot;   serv1: &quot;b&quot; total: &quot;a+b }'
</I>&gt;<i> done
</I>&gt;<i>
</I>&gt;<i> This is what happened around 7:46am (lines that have &quot;+&quot; in front indicate
</I>&gt;<i> anomaly):
</I>&gt;<i>
</I>&gt;<i>  11 Sep 2008 07:41:29   serv2: 2756   serv1: 1064 total: 3820
</I>&gt;<i>  11 Sep 2008 07:41:36   serv2: 2764   serv1: 1062 total: 3826
</I>&gt;<i>  11 Sep 2008 07:41:44   serv2: 2784   serv1: 1049 total: 3833
</I>&gt;<i>  11 Sep 2008 07:41:51   serv2: 2756   serv1: 1055 total: 3811
</I>&gt;<i>  11 Sep 2008 07:41:59   serv2: 2760   serv1: 1066 total: 3826
</I>&gt;<i>  11 Sep 2008 07:42:06   serv2: 2777   serv1: 1050 total: 3827
</I>&gt;<i>  11 Sep 2008 07:42:14   serv2: 2769   serv1: 1054 total: 3823
</I>&gt;<i>  11 Sep 2008 07:42:21   serv2: 2751   serv1: 1055 total: 3806
</I>&gt;<i>  11 Sep 2008 07:42:29   serv2: 2760   serv1: 1050 total: 3810
</I>&gt;<i>  11 Sep 2008 07:42:36   serv2: 2747   serv1: 1040 total: 3787
</I>&gt;<i>  11 Sep 2008 07:42:44   serv2: 2737   serv1: 1046 total: 3783
</I>&gt;<i>  11 Sep 2008 07:42:51   serv2: 2739   serv1: 1046 total: 3785
</I>&gt;<i>  11 Sep 2008 07:42:59   serv2: 2743   serv1: 1037 total: 3780
</I>&gt;<i>  11 Sep 2008 07:43:07   serv2: 2720   serv1: 1041 total: 3761
</I>&gt;<i>  11 Sep 2008 07:43:14   serv2: 2714   serv1: 1047 total: 3761
</I>&gt;<i>  11 Sep 2008 07:43:22   serv2: 2721   serv1: 1045 total: 3766
</I>&gt;<i>  11 Sep 2008 07:43:29   serv2: 2697   serv1: 1056 total: 3753
</I>&gt;<i>  11 Sep 2008 07:43:37   serv2: 2710   serv1: 1059 total: 3769
</I>&gt;<i> +11 Sep 2008 07:43:44   serv2: 2765   serv1: 1304 total: 4069
</I>&gt;<i> +11 Sep 2008 07:43:53   serv2: 2854   serv1: 1904 total: 4758
</I>&gt;<i> +11 Sep 2008 07:44:01   serv2: 2714   serv1: 2190 total: 4904
</I>&gt;<i> +11 Sep 2008 07:44:09   serv2: 2715   serv1: 2202 total: 4917
</I>&gt;<i> +11 Sep 2008 07:44:17   serv2: 2779   serv1: 1891 total: 4670
</I>&gt;<i> +11 Sep 2008 07:44:26   serv2: 2812   serv1: 2284 total: 5096
</I>&gt;<i> +11 Sep 2008 07:44:36   serv2: 2828   serv1: 3496 total: 6324
</I>&gt;<i> +11 Sep 2008 07:44:46   serv2: 2715   serv1: 4327 total: 7042
</I>&gt;<i> +11 Sep 2008 07:44:56   serv2: 2638   serv1: 3499 total: 6137
</I>&gt;<i> +11 Sep 2008 07:45:05   serv2: 2714   serv1: 2396 total: 5110
</I>&gt;<i> +11 Sep 2008 07:45:15   serv2: 2776   serv1: 1464 total: 4240
</I>&gt;<i> +11 Sep 2008 07:45:25   serv2: 2728   serv1: 1604 total: 4332
</I>&gt;<i> +11 Sep 2008 07:45:35   serv2: 2708   serv1: 1566 total: 4274
</I>&gt;<i> +11 Sep 2008 07:45:45   serv2: 2750   serv1: 1680 total: 4430
</I>&gt;<i> +11 Sep 2008 07:45:54   serv2: 2755   serv1: 1311 total: 4066
</I>&gt;<i> +11 Sep 2008 07:46:04   serv2: 2704   serv1: 1178 total: 3882
</I>&gt;<i>  11 Sep 2008 07:46:13   serv2: 2644   serv1: 1024 total: 3668
</I>&gt;<i>  11 Sep 2008 07:46:22   serv2: 2573   serv1: 981 total: 3554
</I>&gt;<i>  11 Sep 2008 07:46:30   serv2: 2739   serv1: 1051 total: 3790
</I>&gt;<i>  11 Sep 2008 07:46:39   serv2: 2773   serv1: 1043 total: 3816
</I>&gt;<i>  11 Sep 2008 07:46:46   serv2: 2548   serv1: 959 total: 3507
</I>&gt;<i>  11 Sep 2008 07:46:54   serv2: 2773   serv1: 1044 total: 3817
</I>&gt;<i>  11 Sep 2008 07:47:02   serv2: 2745   serv1: 1027 total: 3772
</I>&gt;<i>  11 Sep 2008 07:47:10   serv2: 2591   serv1: 960 total: 3551
</I>&gt;<i>  11 Sep 2008 07:47:17   serv2: 2721   serv1: 1002 total: 3723
</I>&gt;<i>  11 Sep 2008 07:47:25   serv2: 2753   serv1: 1030 total: 3783
</I>&gt;<i>  11 Sep 2008 07:47:32   serv2: 2773   serv1: 1029 total: 3802
</I>&gt;<i>  11 Sep 2008 07:47:40   serv2: 2768   serv1: 1025 total: 3793
</I>&gt;<i>  11 Sep 2008 07:47:47   serv2: 2764   serv1: 1021 total: 3785
</I>&gt;<i>  11 Sep 2008 07:47:55   serv2: 2750   serv1: 1021 total: 3771
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Each server also reports the maximum numbers of authenticated connected
</I>&gt;<i> clients to the database.
</I>&gt;<i> Even though serv1 peaked at 07:44:46  at 4327 &quot;ESTABLISHED&quot; connections,
</I>&gt;<i> the
</I>&gt;<i> number of normally authenticated clients in the database for this time
</I>&gt;<i> period is only 1100, which does not reflect this weird connections spike.
</I>&gt;<i> Since I was asleep at 7:46am, I did not have a chance to investigate what
</I>&gt;<i> those connections actually were.
</I>&gt;<i>
</I>&gt;<i> &gt; Anyone know what happens to new
</I>&gt;<i> &gt; connection attempts to a server in this condition?
</I>&gt;<i>
</I>&gt;<i> One thing that I noticed yesterday, that when server was in this condition,
</I>&gt;<i> telnet simply hang, as if no ACK packet was received back:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at serv2</A> ~&gt; telnet localhost 5222
</I>&gt;<i> Trying 127.0.0.1...
</I>&gt;<i>
</I>&gt;<i> and nothing
</I>&gt;<i>
</I>&gt;<i> This behavior or telnet seems to be unique to the case when ACK is not
</I>&gt;<i> received in the handshake, I verified that with tcpdump. To contrast that,
</I>&gt;<i> if nothing listens on the destination port for example, telnet gives:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at serv2</A> ~&gt; telnet localhost 50007
</I>&gt;<i> Trying 127.0.0.1...
</I>&gt;<i> telnet: connect to address 127.0.0.1: Connection refused
</I>&gt;<i> telnet: Unable to connect to remote host: Connection refused
</I>&gt;<i>
</I>&gt;<i> which corresponds to RST packet that kernel returns in that case.
</I>&gt;<i> I tried to write a 5 line mucked up server with accept() not returning any
</I>&gt;<i> packets, and failed.
</I>&gt;<i>
</I>&gt;<i> &gt; -----Original Message-----
</I>&gt;<i> &gt; From: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> [mailto:twisted-python-
</I>&gt;<i> &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bounces at twistedmatrix.com</A>] On Behalf Of Jean-Paul Calderone
</I>&gt;<i> &gt; Sent: Thursday, September 11, 2008 6:47 AM
</I>&gt;<i> &gt; To: Twisted general discussion
</I>&gt;<i> &gt; Subject: Re: [Twisted-Python] intermittent problem: not accepting new
</I>&gt;<i> &gt; connections
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Thu, 11 Sep 2008 14:31:38 +0100, &quot;Paul C. Nendick&quot;
</I>&gt;<i> &gt; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">paul.nendick at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt;Not necessarily related to what you've described, but I'll share
</I>&gt;<i> &gt; &gt;something that's helped a good deal on my most-heavily hit twisted
</I>&gt;<i> &gt; &gt;servers. Presuming you're using Linux:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; echo 1 &gt; /proc/sys/net/ipv4/tcp_tw_recycle
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;from <A HREF="http://lartc.org/howto/lartc.kernel.obscure.html">http://lartc.org/howto/lartc.kernel.obscure.html</A> :
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;&quot;Enable fast recycling TIME-WAIT sockets. Default value is 1. It
</I>&gt;<i> &gt; &gt;should not be changed without advice/request of technical experts&quot;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;My expert advice: only use this on machines connected on a low-latency
</I>&gt;<i> &gt; &gt;LAN. It *will* break internet-facing interfaces. It halves the
</I>&gt;<i> &gt; &gt;constant used by the Nagle algorithm:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;<A HREF="http://en.wikipedia.org/wiki/Nagle">http://en.wikipedia.org/wiki/Nagle</A>'s_algorithm&lt;<A HREF="http://en.wikipedia.org/wiki/Nagle%27s_algorithm">http://en.wikipedia.org/wiki/Nagle%27s_algorithm</A>&gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This is somewhat interesting.  It suggests a potential problem which
</I>&gt;<i> &gt; I hadn't thought about before.  If you need to accept more than about
</I>&gt;<i> &gt; 64k connections (not necessarily concurrent) in less than TIME-WAIT
</I>&gt;<i> &gt; seconds, you might run out of ports.  Anyone know what happens to new
</I>&gt;<i> &gt; connection attempts to a server in this condition?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Alec, any idea if your server could be getting into this state every
</I>&gt;<i> &gt; once in a while?  This is an appealing hypothesis, since it wouldn't
</I>&gt;<i> &gt; necessarily happen at peak connection time (but potentially shortly
</I>&gt;<i> &gt; after a peak), would resolve itself given a short period of time,
</I>&gt;<i> &gt; wouldn't necessarily prevent all new connection attempts, since old
</I>&gt;<i> &gt; TIME-WAIT sockets would be gradually timing out (so your other low-
</I>&gt;<i> &gt; volume servers might still appear to be working normally), wouldn't
</I>&gt;<i> &gt; interfere with already established connections, and might not change
</I>&gt;<i> &gt; the userspace-visible syscall behavior (depending on what Linux does
</I>&gt;<i> &gt; in this case, but I wouldn't be surprised if connection failures due
</I>&gt;<i> &gt; to this never showed up in an accept(2) result).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Jean-Paul
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; Twisted-Python mailing list
</I>&gt;<i> &gt; <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> &gt; <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>


-- 
<A HREF="http://www.alvinatorsplayground.blogspot.com/">http://www.alvinatorsplayground.blogspot.com/</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20080912/f608c826/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="050881.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
	<LI>Next message (by thread): <A HREF="050887.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50882">[ date ]</a>
              <a href="thread.html#50882">[ thread ]</a>
              <a href="subject.html#50882">[ subject ]</a>
              <a href="author.html#50882">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
