<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] intermittent problem: not accepting	new	connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20intermittent%20problem%3A%20not%20accepting%0A%09new%09connections&In-Reply-To=7a01f6c00809111817v609ff43kede137ed7ab900a5%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018374.html">
   <LINK REL="Next"  HREF="018381.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] intermittent problem: not accepting	new	connections</H1>
    <B>Alec Matusis</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20intermittent%20problem%3A%20not%20accepting%0A%09new%09connections&In-Reply-To=7a01f6c00809111817v609ff43kede137ed7ab900a5%40mail.gmail.com"
       TITLE="[Twisted-Python] intermittent problem: not accepting	new	connections">matusis at yahoo.com
       </A><BR>
    <I>Mon Sep 15 07:43:23 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018374.html">[Twisted-Python] intermittent problem: not accepting new	connections
</A></li>
        <LI>Next message: <A HREF="018381.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18379">[ date ]</a>
              <a href="thread.html#18379">[ thread ]</a>
              <a href="subject.html#18379">[ subject ]</a>
              <a href="author.html#18379">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I wanted to post that I solved the problem, and it's unrelated to Twisted.

I noticed that this server had sudden increases in the numbers of
ESTABLISHED connections in netstat, but not in the number of authenticated
connections reported by twisted to the database. These increases correlated
with the connection outages.
Creating a shell script that monitors the connection rate, and invoking
tcpdump and sorting/counting the source IPs when it increases, showed that
this server was pounded twice a day for 3-5min from a small set of IPs with
new connections at about 100 conns/sec, that sent some junk data (these
connections timed out in twisted, because that junk never contained my line
separator, and I am using LineOnlyReceiver protocol). This was hardly an
attack against my server, because this new server was assigned an IP that I
have never used before- I guess this is just an internet reality ;)

Even though this does not look like SYN attacks (few connections were in
SYN_RCVD state), for some reason enabling net.ipv4.tcp_syncookies=1 made
everything normal. When these bizarre connections began to pile uo, I
started seeing 
&quot;possible SYN flooding on port 5222. Sending cookies.&quot;
in /var/log/messages , and the connectivity outages stopped

I am sorry for the confusion, I was emboldened by finding the epoll bug back
in April, but this time Twisted continues to rock, and it's just a stupid
Ubuntu's tcp setting.



From: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>
[mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] On Behalf Of Alvin Delagon
Sent: Thursday, September 11, 2008 6:17 PM
To: Twisted general discussion
Subject: Re: [Twisted-Python] intermittent problem: not accepting new
connections

We had a similar problem like this, might as well share it with you guys:

Our Jabber server stopped taking in new connections due to our iptables at
some point in time (even lost some packets). We have an ip routing scheme
where ports 25,80,5223,10873 routed to 5222. Whenever this happens, we get
error error from our syslogs:

&quot;&quot;ip_conntrack: table full, dropping packet&quot;

<A HREF="http://support.imagestream.com/Resolving_ip_conntrack_table_full_Errors.html">http://support.imagestream.com/Resolving_ip_conntrack_table_full_Errors.html</A>

Might as well check dmesg if you have something like this. What we did is
disable iptables and removed its kernel modules.
On Fri, Sep 12, 2008 at 3:57 AM, Alec Matusis &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">matusis at yahoo.com</A>&gt; wrote:
&gt;<i> How does ulimit -a compare between old and new machine?
</I>ulimit is only higher on the new machine, I upped it. Also, from my
experience, running into &#160;ulimits produces log messages.

<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at serv2</A> ~&gt; cat /proc/23678/limits

Limit &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; Soft Limit &#160; &#160; &#160; &#160; &#160; Hard Limit &#160; &#160; &#160; &#160; &#160; Units

Max cpu time &#160; &#160; &#160; &#160; &#160; &#160; &#160;unlimited &#160; &#160; &#160; &#160; &#160; &#160;unlimited &#160; &#160; &#160; &#160; &#160; &#160;ms

Max file size &#160; &#160; &#160; &#160; &#160; &#160; unlimited &#160; &#160; &#160; &#160; &#160; &#160;unlimited &#160; &#160; &#160; &#160; &#160; &#160;bytes

Max data size &#160; &#160; &#160; &#160; &#160; &#160; unlimited &#160; &#160; &#160; &#160; &#160; &#160;unlimited &#160; &#160; &#160; &#160; &#160; &#160;bytes

Max stack size &#160; &#160; &#160; &#160; &#160; &#160;8388608 &#160; &#160; &#160; &#160; &#160; &#160; &#160;unlimited &#160; &#160; &#160; &#160; &#160; &#160;bytes

Max core file size &#160; &#160; &#160; &#160;0 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;unlimited &#160; &#160; &#160; &#160; &#160; &#160;bytes

Max resident set &#160; &#160; &#160; &#160; &#160;1073741824 &#160; &#160; &#160; &#160; &#160; 1073741824 &#160; &#160; &#160; &#160; &#160; bytes

Max processes &#160; &#160; &#160; &#160; &#160; &#160; 126976 &#160; &#160; &#160; &#160; &#160; &#160; &#160; 126976
processes
Max open files &#160; &#160; &#160; &#160; &#160; &#160;25000 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;25000 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;files

Max locked memory &#160; &#160; &#160; &#160; 32768 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;32768 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;bytes

Max address space &#160; &#160; &#160; &#160; unlimited &#160; &#160; &#160; &#160; &#160; &#160;unlimited &#160; &#160; &#160; &#160; &#160; &#160;bytes

Max file locks &#160; &#160; &#160; &#160; &#160; &#160;unlimited &#160; &#160; &#160; &#160; &#160; &#160;unlimited &#160; &#160; &#160; &#160; &#160; &#160;locks

Max pending signals &#160; &#160; &#160; 126976 &#160; &#160; &#160; &#160; &#160; &#160; &#160; 126976 &#160; &#160; &#160; &#160; &#160; &#160; &#160; signals

Max msgqueue size &#160; &#160; &#160; &#160; 819200 &#160; &#160; &#160; &#160; &#160; &#160; &#160; 819200 &#160; &#160; &#160; &#160; &#160; &#160; &#160; bytes

Max nice priority &#160; &#160; &#160; &#160; 0 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0
Max realtime priority &#160; &#160; 0 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;0


&gt;<i> If you need to accept more than about
</I>&gt;<i> 64k connections (not necessarily concurrent) in less than TIME-WAIT
</I>&gt;<i> seconds, you might run out of ports.
</I>&gt;<i> How does netstat look like?
</I>I have to wait for another outage tonight, to get more definite results on
this.
So far, I have had only one very brief outage at 7:46am
I was asleep, but I have some new data logged.
I have two servers, one on port 5222 (problematic one, let's call it serv1
), and one on 5228 (that has no problems, call it serv2 ).
I made a script that measures the number of connections on each type of
server respectively like this:

while [ 1 ]
do
&#160;sleep 5
&#160;netstat -ant | grep ESTABLISHED | awk '/:5228 /{a += 1}/:5222 /{b += 1} END
{print strftime(&quot; %d %b %Y %H:%M:%S&quot;, systime(
))&quot; &#160; serv2: &quot;a&quot; &#160; serv1: &quot;b&quot; total: &quot;a+b }'
done

This is what happened around 7:46am (lines that have &quot;+&quot; in front indicate
anomaly):

&#160;11 Sep 2008 07:41:29 &#160; serv2: 2756 &#160; serv1: 1064 total: 3820
&#160;11 Sep 2008 07:41:36 &#160; serv2: 2764 &#160; serv1: 1062 total: 3826
&#160;11 Sep 2008 07:41:44 &#160; serv2: 2784 &#160; serv1: 1049 total: 3833
&#160;11 Sep 2008 07:41:51 &#160; serv2: 2756 &#160; serv1: 1055 total: 3811
&#160;11 Sep 2008 07:41:59 &#160; serv2: 2760 &#160; serv1: 1066 total: 3826
&#160;11 Sep 2008 07:42:06 &#160; serv2: 2777 &#160; serv1: 1050 total: 3827
&#160;11 Sep 2008 07:42:14 &#160; serv2: 2769 &#160; serv1: 1054 total: 3823
&#160;11 Sep 2008 07:42:21 &#160; serv2: 2751 &#160; serv1: 1055 total: 3806
&#160;11 Sep 2008 07:42:29 &#160; serv2: 2760 &#160; serv1: 1050 total: 3810
&#160;11 Sep 2008 07:42:36 &#160; serv2: 2747 &#160; serv1: 1040 total: 3787
&#160;11 Sep 2008 07:42:44 &#160; serv2: 2737 &#160; serv1: 1046 total: 3783
&#160;11 Sep 2008 07:42:51 &#160; serv2: 2739 &#160; serv1: 1046 total: 3785
&#160;11 Sep 2008 07:42:59 &#160; serv2: 2743 &#160; serv1: 1037 total: 3780
&#160;11 Sep 2008 07:43:07 &#160; serv2: 2720 &#160; serv1: 1041 total: 3761
&#160;11 Sep 2008 07:43:14 &#160; serv2: 2714 &#160; serv1: 1047 total: 3761
&#160;11 Sep 2008 07:43:22 &#160; serv2: 2721 &#160; serv1: 1045 total: 3766
&#160;11 Sep 2008 07:43:29 &#160; serv2: 2697 &#160; serv1: 1056 total: 3753
&#160;11 Sep 2008 07:43:37 &#160; serv2: 2710 &#160; serv1: 1059 total: 3769
+11 Sep 2008 07:43:44 &#160; serv2: 2765 &#160; serv1: 1304 total: 4069
+11 Sep 2008 07:43:53 &#160; serv2: 2854 &#160; serv1: 1904 total: 4758
+11 Sep 2008 07:44:01 &#160; serv2: 2714 &#160; serv1: 2190 total: 4904
+11 Sep 2008 07:44:09 &#160; serv2: 2715 &#160; serv1: 2202 total: 4917
+11 Sep 2008 07:44:17 &#160; serv2: 2779 &#160; serv1: 1891 total: 4670
+11 Sep 2008 07:44:26 &#160; serv2: 2812 &#160; serv1: 2284 total: 5096
+11 Sep 2008 07:44:36 &#160; serv2: 2828 &#160; serv1: 3496 total: 6324
+11 Sep 2008 07:44:46 &#160; serv2: 2715 &#160; serv1: 4327 total: 7042
+11 Sep 2008 07:44:56 &#160; serv2: 2638 &#160; serv1: 3499 total: 6137
+11 Sep 2008 07:45:05 &#160; serv2: 2714 &#160; serv1: 2396 total: 5110
+11 Sep 2008 07:45:15 &#160; serv2: 2776 &#160; serv1: 1464 total: 4240
+11 Sep 2008 07:45:25 &#160; serv2: 2728 &#160; serv1: 1604 total: 4332
+11 Sep 2008 07:45:35 &#160; serv2: 2708 &#160; serv1: 1566 total: 4274
+11 Sep 2008 07:45:45 &#160; serv2: 2750 &#160; serv1: 1680 total: 4430
+11 Sep 2008 07:45:54 &#160; serv2: 2755 &#160; serv1: 1311 total: 4066
+11 Sep 2008 07:46:04 &#160; serv2: 2704 &#160; serv1: 1178 total: 3882
&#160;11 Sep 2008 07:46:13 &#160; serv2: 2644 &#160; serv1: 1024 total: 3668
&#160;11 Sep 2008 07:46:22 &#160; serv2: 2573 &#160; serv1: 981 total: 3554
&#160;11 Sep 2008 07:46:30 &#160; serv2: 2739 &#160; serv1: 1051 total: 3790
&#160;11 Sep 2008 07:46:39 &#160; serv2: 2773 &#160; serv1: 1043 total: 3816
&#160;11 Sep 2008 07:46:46 &#160; serv2: 2548 &#160; serv1: 959 total: 3507
&#160;11 Sep 2008 07:46:54 &#160; serv2: 2773 &#160; serv1: 1044 total: 3817
&#160;11 Sep 2008 07:47:02 &#160; serv2: 2745 &#160; serv1: 1027 total: 3772
&#160;11 Sep 2008 07:47:10 &#160; serv2: 2591 &#160; serv1: 960 total: 3551
&#160;11 Sep 2008 07:47:17 &#160; serv2: 2721 &#160; serv1: 1002 total: 3723
&#160;11 Sep 2008 07:47:25 &#160; serv2: 2753 &#160; serv1: 1030 total: 3783
&#160;11 Sep 2008 07:47:32 &#160; serv2: 2773 &#160; serv1: 1029 total: 3802
&#160;11 Sep 2008 07:47:40 &#160; serv2: 2768 &#160; serv1: 1025 total: 3793
&#160;11 Sep 2008 07:47:47 &#160; serv2: 2764 &#160; serv1: 1021 total: 3785
&#160;11 Sep 2008 07:47:55 &#160; serv2: 2750 &#160; serv1: 1021 total: 3771


Each server also reports the maximum numbers of authenticated connected
clients to the database.
Even though serv1 peaked at 07:44:46 &#160;at 4327 &quot;ESTABLISHED&quot; connections, the
number of normally authenticated clients in the database for this time
period is only 1100, which does not reflect this weird connections spike.
Since I was asleep at 7:46am, I did not have a chance to investigate what
those connections actually were.

&gt;<i> Anyone know what happens to new
</I>&gt;<i> connection attempts to a server in this condition?
</I>One thing that I noticed yesterday, that when server was in this condition,
telnet simply hang, as if no ACK packet was received back:

<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at serv2</A> ~&gt; telnet localhost 5222
Trying 127.0.0.1...
and nothing

This behavior or telnet seems to be unique to the case when ACK is not
received in the handshake, I verified that with tcpdump. To contrast that,
if nothing listens on the destination port for example, telnet gives:

<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at serv2</A> ~&gt; telnet localhost 50007
Trying 127.0.0.1...
telnet: connect to address 127.0.0.1: Connection refused
telnet: Unable to connect to remote host: Connection refused

which corresponds to RST packet that kernel returns in that case.
I tried to write a 5 line mucked up server with accept() not returning any
packets, and failed.

&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> [mailto:twisted-python-
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bounces at twistedmatrix.com</A>] On Behalf Of Jean-Paul Calderone
</I>&gt;<i> Sent: Thursday, September 11, 2008 6:47 AM
</I>&gt;<i> To: Twisted general discussion
</I>&gt;<i> Subject: Re: [Twisted-Python] intermittent problem: not accepting new
</I>&gt;<i> connections
</I>&gt;<i>
</I>&gt;<i> On Thu, 11 Sep 2008 14:31:38 +0100, &quot;Paul C. Nendick&quot;
</I>&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">paul.nendick at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;Not necessarily related to what you've described, but I'll share
</I>&gt;<i> &gt;something that's helped a good deal on my most-heavily hit twisted
</I>&gt;<i> &gt;servers. Presuming you're using Linux:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; echo 1 &gt; /proc/sys/net/ipv4/tcp_tw_recycle
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;from <A HREF="http://lartc.org/howto/lartc.kernel.obscure.html">http://lartc.org/howto/lartc.kernel.obscure.html</A> :
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&quot;Enable fast recycling TIME-WAIT sockets. Default value is 1. It
</I>&gt;<i> &gt;should not be changed without advice/request of technical experts&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;My expert advice: only use this on machines connected on a low-latency
</I>&gt;<i> &gt;LAN. It *will* break internet-facing interfaces. It halves the
</I>&gt;<i> &gt;constant used by the Nagle algorithm:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;<A HREF="http://en.wikipedia.org/wiki/Nagle's_algorithm">http://en.wikipedia.org/wiki/Nagle's_algorithm</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> This is somewhat interesting. &#160;It suggests a potential problem which
</I>&gt;<i> I hadn't thought about before. &#160;If you need to accept more than about
</I>&gt;<i> 64k connections (not necessarily concurrent) in less than TIME-WAIT
</I>&gt;<i> seconds, you might run out of ports. &#160;Anyone know what happens to new
</I>&gt;<i> connection attempts to a server in this condition?
</I>&gt;<i>
</I>&gt;<i> Alec, any idea if your server could be getting into this state every
</I>&gt;<i> once in a while? &#160;This is an appealing hypothesis, since it wouldn't
</I>&gt;<i> necessarily happen at peak connection time (but potentially shortly
</I>&gt;<i> after a peak), would resolve itself given a short period of time,
</I>&gt;<i> wouldn't necessarily prevent all new connection attempts, since old
</I>&gt;<i> TIME-WAIT sockets would be gradually timing out (so your other low-
</I>&gt;<i> volume servers might still appear to be working normally), wouldn't
</I>&gt;<i> interfere with already established connections, and might not change
</I>&gt;<i> the userspace-visible syscall behavior (depending on what Linux does
</I>&gt;<i> in this case, but I wouldn't be surprised if connection failures due
</I>&gt;<i> to this never showed up in an accept(2) result).
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>

_______________________________________________
Twisted-Python mailing list
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>



-- 
<A HREF="http://www.alvinatorsplayground.blogspot.com/">http://www.alvinatorsplayground.blogspot.com/</A>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018374.html">[Twisted-Python] intermittent problem: not accepting new	connections
</A></li>
	<LI>Next message: <A HREF="018381.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18379">[ date ]</a>
              <a href="thread.html#18379">[ thread ]</a>
              <a href="subject.html#18379">[ subject ]</a>
              <a href="author.html#18379">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
