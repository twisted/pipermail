<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] intermittent problem: not accepting	new	connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20intermittent%20problem%3A%20not%20accepting%0A%09new%09connections&In-Reply-To=%3C06c801c91448%24b1a8f290%2414fad7b0%24%40com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="050880.html">
   <LINK REL="Next"  HREF="050882.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] intermittent problem: not accepting	new	connections</H1>
    <B>Alec Matusis</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20intermittent%20problem%3A%20not%20accepting%0A%09new%09connections&In-Reply-To=%3C06c801c91448%24b1a8f290%2414fad7b0%24%40com%3E"
       TITLE="[Twisted-Python] intermittent problem: not accepting	new	connections">matusis at yahoo.com
       </A><BR>
    <I>Thu Sep 11 13:57:51 MDT 2008</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="050880.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
        <LI>Next message (by thread): <A HREF="050882.html">[Twisted-Python] intermittent problem: not accepting new	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50881">[ date ]</a>
              <a href="thread.html#50881">[ thread ]</a>
              <a href="subject.html#50881">[ subject ]</a>
              <a href="author.html#50881">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> How does ulimit -a compare between old and new machine?
</I>
ulimit is only higher on the new machine, I upped it. Also, from my
experience, running into  ulimits produces log messages. 

<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at serv2</A> ~&gt; cat /proc/23678/limits 

Limit                     Soft Limit           Hard Limit           Units

Max cpu time              unlimited            unlimited            ms

Max file size             unlimited            unlimited            bytes

Max data size             unlimited            unlimited            bytes

Max stack size            8388608              unlimited            bytes

Max core file size        0                    unlimited            bytes

Max resident set          1073741824           1073741824           bytes

Max processes             126976               126976
processes 
Max open files            25000                25000                files

Max locked memory         32768                32768                bytes

Max address space         unlimited            unlimited            bytes

Max file locks            unlimited            unlimited            locks

Max pending signals       126976               126976               signals

Max msgqueue size         819200               819200               bytes

Max nice priority         0                    0                    
Max realtime priority     0                    0                    


&gt;<i> If you need to accept more than about
</I>&gt;<i> 64k connections (not necessarily concurrent) in less than TIME-WAIT
</I>&gt;<i> seconds, you might run out of ports.  
</I>
&gt;<i> How does netstat look like?
</I>
I have to wait for another outage tonight, to get more definite results on
this.
So far, I have had only one very brief outage at 7:46am
I was asleep, but I have some new data logged.
I have two servers, one on port 5222 (problematic one, let's call it serv1
), and one on 5228 (that has no problems, call it serv2 ).
I made a script that measures the number of connections on each type of
server respectively like this:

while [ 1 ]
do
 sleep 5
 netstat -ant | grep ESTABLISHED | awk '/:5228 /{a += 1}/:5222 /{b += 1} END
{print strftime(&quot; %d %b %Y %H:%M:%S&quot;, systime(
))&quot;   serv2: &quot;a&quot;   serv1: &quot;b&quot; total: &quot;a+b }'
done

This is what happened around 7:46am (lines that have &quot;+&quot; in front indicate
anomaly):

 11 Sep 2008 07:41:29   serv2: 2756   serv1: 1064 total: 3820
 11 Sep 2008 07:41:36   serv2: 2764   serv1: 1062 total: 3826
 11 Sep 2008 07:41:44   serv2: 2784   serv1: 1049 total: 3833
 11 Sep 2008 07:41:51   serv2: 2756   serv1: 1055 total: 3811
 11 Sep 2008 07:41:59   serv2: 2760   serv1: 1066 total: 3826
 11 Sep 2008 07:42:06   serv2: 2777   serv1: 1050 total: 3827
 11 Sep 2008 07:42:14   serv2: 2769   serv1: 1054 total: 3823
 11 Sep 2008 07:42:21   serv2: 2751   serv1: 1055 total: 3806
 11 Sep 2008 07:42:29   serv2: 2760   serv1: 1050 total: 3810
 11 Sep 2008 07:42:36   serv2: 2747   serv1: 1040 total: 3787
 11 Sep 2008 07:42:44   serv2: 2737   serv1: 1046 total: 3783
 11 Sep 2008 07:42:51   serv2: 2739   serv1: 1046 total: 3785
 11 Sep 2008 07:42:59   serv2: 2743   serv1: 1037 total: 3780
 11 Sep 2008 07:43:07   serv2: 2720   serv1: 1041 total: 3761
 11 Sep 2008 07:43:14   serv2: 2714   serv1: 1047 total: 3761
 11 Sep 2008 07:43:22   serv2: 2721   serv1: 1045 total: 3766
 11 Sep 2008 07:43:29   serv2: 2697   serv1: 1056 total: 3753
 11 Sep 2008 07:43:37   serv2: 2710   serv1: 1059 total: 3769
+11 Sep 2008 07:43:44   serv2: 2765   serv1: 1304 total: 4069
+11 Sep 2008 07:43:53   serv2: 2854   serv1: 1904 total: 4758
+11 Sep 2008 07:44:01   serv2: 2714   serv1: 2190 total: 4904
+11 Sep 2008 07:44:09   serv2: 2715   serv1: 2202 total: 4917
+11 Sep 2008 07:44:17   serv2: 2779   serv1: 1891 total: 4670
+11 Sep 2008 07:44:26   serv2: 2812   serv1: 2284 total: 5096
+11 Sep 2008 07:44:36   serv2: 2828   serv1: 3496 total: 6324
+11 Sep 2008 07:44:46   serv2: 2715   serv1: 4327 total: 7042
+11 Sep 2008 07:44:56   serv2: 2638   serv1: 3499 total: 6137
+11 Sep 2008 07:45:05   serv2: 2714   serv1: 2396 total: 5110
+11 Sep 2008 07:45:15   serv2: 2776   serv1: 1464 total: 4240
+11 Sep 2008 07:45:25   serv2: 2728   serv1: 1604 total: 4332
+11 Sep 2008 07:45:35   serv2: 2708   serv1: 1566 total: 4274
+11 Sep 2008 07:45:45   serv2: 2750   serv1: 1680 total: 4430
+11 Sep 2008 07:45:54   serv2: 2755   serv1: 1311 total: 4066
+11 Sep 2008 07:46:04   serv2: 2704   serv1: 1178 total: 3882
 11 Sep 2008 07:46:13   serv2: 2644   serv1: 1024 total: 3668
 11 Sep 2008 07:46:22   serv2: 2573   serv1: 981 total: 3554
 11 Sep 2008 07:46:30   serv2: 2739   serv1: 1051 total: 3790
 11 Sep 2008 07:46:39   serv2: 2773   serv1: 1043 total: 3816
 11 Sep 2008 07:46:46   serv2: 2548   serv1: 959 total: 3507
 11 Sep 2008 07:46:54   serv2: 2773   serv1: 1044 total: 3817
 11 Sep 2008 07:47:02   serv2: 2745   serv1: 1027 total: 3772
 11 Sep 2008 07:47:10   serv2: 2591   serv1: 960 total: 3551
 11 Sep 2008 07:47:17   serv2: 2721   serv1: 1002 total: 3723
 11 Sep 2008 07:47:25   serv2: 2753   serv1: 1030 total: 3783
 11 Sep 2008 07:47:32   serv2: 2773   serv1: 1029 total: 3802
 11 Sep 2008 07:47:40   serv2: 2768   serv1: 1025 total: 3793
 11 Sep 2008 07:47:47   serv2: 2764   serv1: 1021 total: 3785
 11 Sep 2008 07:47:55   serv2: 2750   serv1: 1021 total: 3771


Each server also reports the maximum numbers of authenticated connected
clients to the database.
Even though serv1 peaked at 07:44:46  at 4327 &quot;ESTABLISHED&quot; connections, the
number of normally authenticated clients in the database for this time
period is only 1100, which does not reflect this weird connections spike. 
Since I was asleep at 7:46am, I did not have a chance to investigate what
those connections actually were.

&gt;<i> Anyone know what happens to new
</I>&gt;<i> connection attempts to a server in this condition?
</I>
One thing that I noticed yesterday, that when server was in this condition,
telnet simply hang, as if no ACK packet was received back:

<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at serv2</A> ~&gt; telnet localhost 5222
Trying 127.0.0.1...

and nothing

This behavior or telnet seems to be unique to the case when ACK is not
received in the handshake, I verified that with tcpdump. To contrast that,
if nothing listens on the destination port for example, telnet gives:

<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alecm at serv2</A> ~&gt; telnet localhost 50007
Trying 127.0.0.1...
telnet: connect to address 127.0.0.1: Connection refused
telnet: Unable to connect to remote host: Connection refused

which corresponds to RST packet that kernel returns in that case.
I tried to write a 5 line mucked up server with accept() not returning any
packets, and failed.

&gt;<i> -----Original Message-----
</I>&gt;<i> From: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> [mailto:twisted-python-
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">bounces at twistedmatrix.com</A>] On Behalf Of Jean-Paul Calderone
</I>&gt;<i> Sent: Thursday, September 11, 2008 6:47 AM
</I>&gt;<i> To: Twisted general discussion
</I>&gt;<i> Subject: Re: [Twisted-Python] intermittent problem: not accepting new
</I>&gt;<i> connections
</I>&gt;<i> 
</I>&gt;<i> On Thu, 11 Sep 2008 14:31:38 +0100, &quot;Paul C. Nendick&quot;
</I>&gt;<i> &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">paul.nendick at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;Not necessarily related to what you've described, but I'll share
</I>&gt;<i> &gt;something that's helped a good deal on my most-heavily hit twisted
</I>&gt;<i> &gt;servers. Presuming you're using Linux:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; echo 1 &gt; /proc/sys/net/ipv4/tcp_tw_recycle
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;from <A HREF="http://lartc.org/howto/lartc.kernel.obscure.html">http://lartc.org/howto/lartc.kernel.obscure.html</A> :
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&quot;Enable fast recycling TIME-WAIT sockets. Default value is 1. It
</I>&gt;<i> &gt;should not be changed without advice/request of technical experts&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;My expert advice: only use this on machines connected on a low-latency
</I>&gt;<i> &gt;LAN. It *will* break internet-facing interfaces. It halves the
</I>&gt;<i> &gt;constant used by the Nagle algorithm:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;<A HREF="http://en.wikipedia.org/wiki/Nagle">http://en.wikipedia.org/wiki/Nagle</A>'s_algorithm
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> This is somewhat interesting.  It suggests a potential problem which
</I>&gt;<i> I hadn't thought about before.  If you need to accept more than about
</I>&gt;<i> 64k connections (not necessarily concurrent) in less than TIME-WAIT
</I>&gt;<i> seconds, you might run out of ports.  Anyone know what happens to new
</I>&gt;<i> connection attempts to a server in this condition?
</I>&gt;<i> 
</I>&gt;<i> Alec, any idea if your server could be getting into this state every
</I>&gt;<i> once in a while?  This is an appealing hypothesis, since it wouldn't
</I>&gt;<i> necessarily happen at peak connection time (but potentially shortly
</I>&gt;<i> after a peak), would resolve itself given a short period of time,
</I>&gt;<i> wouldn't necessarily prevent all new connection attempts, since old
</I>&gt;<i> TIME-WAIT sockets would be gradually timing out (so your other low-
</I>&gt;<i> volume servers might still appear to be working normally), wouldn't
</I>&gt;<i> interfere with already established connections, and might not change
</I>&gt;<i> the userspace-visible syscall behavior (depending on what Linux does
</I>&gt;<i> in this case, but I wouldn't be surprised if connection failures due
</I>&gt;<i> to this never showed up in an accept(2) result).
</I>&gt;<i> 
</I>&gt;<i> Jean-Paul
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="050880.html">[Twisted-Python] intermittent problem: not accepting	new	connections
</A></li>
	<LI>Next message (by thread): <A HREF="050882.html">[Twisted-Python] intermittent problem: not accepting new	connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50881">[ date ]</a>
              <a href="thread.html#50881">[ thread ]</a>
              <a href="subject.html#50881">[ subject ]</a>
              <a href="author.html#50881">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
