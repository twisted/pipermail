<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] UDP vs TCP for bittorrent-style file transfer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20UDP%20vs%20TCP%20for%20bittorrent-style%20file%20transfer&In-Reply-To=d6bdc39c0809211806s748e825dx750635310d5b0584%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018406.html">
   <LINK REL="Next"  HREF="018397.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] UDP vs TCP for bittorrent-style file transfer</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20UDP%20vs%20TCP%20for%20bittorrent-style%20file%20transfer&In-Reply-To=d6bdc39c0809211806s748e825dx750635310d5b0584%40mail.gmail.com"
       TITLE="[Twisted-Python] UDP vs TCP for bittorrent-style file transfer">glyph at divmod.com
       </A><BR>
    <I>Mon Sep 22 14:24:52 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018406.html">[Twisted-Python] UDP vs TCP for bittorrent-style file transfer
</A></li>
        <LI>Next message: <A HREF="018397.html">[Twisted-Python] Twisted sprint next Sunday
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18410">[ date ]</a>
              <a href="thread.html#18410">[ thread ]</a>
              <a href="subject.html#18410">[ subject ]</a>
              <a href="author.html#18410">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01:06 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">tiredashell at gmail.com</A> wrote:
&gt;&gt;<i>It's not easier to get UDP through NATs.  It's just as hard or harder.
</I>&gt;<i>
</I>&gt;<i>It must be a widely held error, then, because it's what I hear every 
</I>&gt;<i>time
</I>&gt;<i>the subject arises. My understanding was that since UDP doesn't have 
</I>&gt;<i>the
</I>&gt;<i>concept of &quot;streams,&quot; most NATs will allow all UDP packets through to a
</I>&gt;<i>given port one it is first hole-punched.
</I>
If you are a piece of software behind a NAT, and you want to accept a 
connection from a peer, there are three things you can do:

  1. Require some explicit configuration from the user; ask them to punch 
a hole through their NAT and tell you what port to use.  This is by far 
the easiest for you, but considered unacceptable since its default 
configuration will usually be broken.
  2. Use a protocol like UPnP or Nat-PMP to get around the user's router. 
This will work on a minority of deployed endpoints, but when it does 
work it will work great, and your application can just make regular TCP 
connections.
  3. Punch a hole, abusing the router's NAT routing rules in order to get 
it to think it's making a connection when it is actually accepting one. 
There are about six different ways to do this, but you can do it with 
UDP *or* TCP.  Different routers support different schemes, and I don't 
just mean &quot;some support TCP, some support UDP&quot;: UDP port mapping 
_usually_ works a certain way, but there are exceptions.  You should at 
least read the papers referenced here:  <A HREF="http://midcom-">http://midcom-</A> 
p2p.sourceforge.net/

In order to build a truly robust application you will need to do all of 
the above.  Even if you do #2 and #3 perfectly, there are a surprising 
percentage of home routers (say, 5-10%) which are just buggy and won't 
route your traffic properly to another NAT no matter what you do, so you 
always need to provide a &quot;just tell the NAT what to do manually&quot; option. 
(Or, forward your traffic through some known-to-work intermediary.)
&gt;<i>Nat traversal aside, I'm also concerned about performance, and since 
</I>&gt;<i>TCP
</I>&gt;<i>doesn't make in-order delivery optional, I'm still tempted to stick 
</I>&gt;<i>with
</I>&gt;<i>UDP...
</I>
TCP will, in general, &quot;perform&quot; better than UDP, because TCP can cheat 
whereas UDP can't.  Your ISP can (and probably does, according to rumors 
I've heard from people who have worked on such things) deploy &quot;smart&quot; 
routers which can prioritize traffic using the additional information 
present in TCP headers which UDP doesn't provide.  Plus, there are 
things that your operating system is doing (as James already mentioned) 
that are extensions to the core TCP spec.

If you don't understand _at least_ enough about TCP to have implemented 
it yourself once, then you probably don't understand enough to make the 
decision to use UDP for performance reasons.  I am saying this because 
it was at the point where I actually implemented TCP myself that I 
gained this insight :).

I started a project a while ago to try to abstract away all this NAT- 
traversal nonsense and present an API for making a connection to a peer- 
to-peer user over whatever methods are available.  It's definitely in 
need of some maintenance, but if you're already using Twisted I think 
you'll find it easier to get started with this than to build your own 
P2P framework from the ground up: 
<A HREF="http://divmod.org/trac/wiki/DivmodVertex">http://divmod.org/trac/wiki/DivmodVertex</A>

Good luck!


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018406.html">[Twisted-Python] UDP vs TCP for bittorrent-style file transfer
</A></li>
	<LI>Next message: <A HREF="018397.html">[Twisted-Python] Twisted sprint next Sunday
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18410">[ date ]</a>
              <a href="thread.html#18410">[ thread ]</a>
              <a href="subject.html#18410">[ subject ]</a>
              <a href="author.html#18410">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
