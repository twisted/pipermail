<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Bloody Twisted Tree (VFS)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Bloody%20Twisted%20Tree%20%28VFS%29&In-Reply-To=20080706151209.25821.82528526.divmod.xquotient.12221%40joule.divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="018041.html">
   <LINK REL="Next"  HREF="018045.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Bloody Twisted Tree (VFS)</H1>
    <B>Jonathan Lange</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Bloody%20Twisted%20Tree%20%28VFS%29&In-Reply-To=20080706151209.25821.82528526.divmod.xquotient.12221%40joule.divmod.com"
       TITLE="[Twisted-Python] Bloody Twisted Tree (VFS)">jml at mumak.net
       </A><BR>
    <I>Sun Jul  6 19:26:00 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="018041.html">[Twisted-Python] Bloody Twisted Tree (VFS)
</A></li>
        <LI>Next message: <A HREF="018045.html">[Twisted-Python] Bloody Twisted Tree (VFS)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18044">[ date ]</a>
              <a href="thread.html#18044">[ thread ]</a>
              <a href="subject.html#18044">[ subject ]</a>
              <a href="author.html#18044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Jul 7, 2008 at 1:12 AM,  &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On 07:32 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jml at mumak.net</A> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Sat, Jul 5, 2008 at 3:27 AM, Andy Gayton &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andy at thecablelounge.com</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On Mon, Jun 30, 2008 at 9:06 PM, Jonathan Lange &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jml at mumak.net</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;&gt;<i>  * The primitive interface for IO should be producer/consumers,
</I>&gt;&gt;&gt;<i> replacing readChunk, writeChunk.  This interface is primitive enough
</I>&gt;&gt;&gt;<i> to express all other interfaces, while still providing the opportunity
</I>&gt;&gt;&gt;<i> to optimize streaming performance.  The producer/consumer interface
</I>&gt;&gt;&gt;<i> will need to take an offset to allow readChunk and writeChunk to be
</I>&gt;&gt;&gt;<i> implemented.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It would be nice to have things so that readChunks and writeChunks
</I>&gt;&gt;<i> (plural) could be implemented, to avoid potato programming.
</I>&gt;<i>
</I>&gt;<i> I don't think this is actually going to be a practical consideration, if I
</I>&gt;<i> correctly understand what you mean.  For one thing, the producer/consumer
</I>&gt;<i> interface is going to be something (very vaguely) like this:
</I>&gt;<i>
</I>&gt;<i>   remoteFile.writeFrom(producer[, offset, length])
</I>&gt;<i>   remoteFile.readInto(consumer[, offset, length])
</I>&gt;<i>
</I>&gt;<i> This means that if you've got a really giant file, the implementation could
</I>&gt;<i> pretty trivially optimize delivering it to you in the most efficient
</I>&gt;<i> possible way, keeping all the relevant buffers full at every opportunity.
</I>&gt;<i>  Given that stream-based I/O is somewhat inherently serial, it's difficult
</I>&gt;<i> to get less potato-y than that.
</I>&gt;<i>
</I>&gt;<i> writeChunks, if I understand it, would be pretty trivially implementable by
</I>&gt;<i> saying
</I>&gt;<i>
</I>&gt;<i>   remoteFile.writeFrom(MultiChunkProducer(chunks))
</I>&gt;<i>
</I>&gt;<i> Mapping 'readChunks' and 'writeChunks' to readv and writev in my head, I'm
</I>&gt;<i> not really sure what a 'readChunks' would actually do, since we copy memory
</I>&gt;<i> every time we sneeze in Python anyway.  We're not going to have preallocated
</I>&gt;<i> buffers to read into.
</I>
Well, one theoretical advantage is that it can avoid roundtrips in
cases where the remote file server supports a readv-style operation. I
can't think of any servers that do this at the moment (maybe the bzr
smart server? does http 1.1 allow this?), so maybe it's not an issue.

&gt;&gt;<i> This reminds me, it would be good for VFS to have an exception for
</I>&gt;&gt;<i> &quot;this operation isn't supported&quot; (say with symlinks on fat32) and
</I>&gt;&gt;<i> another exception for &quot;supportable, but not actually implemented yet&quot;.
</I>&gt;<i>
</I>&gt;<i> I don't think it's useful to distinguish between these two types of
</I>&gt;<i> exception at *runtime*.  The use-case I can see for distinguishing is
</I>&gt;<i> letting a programmer know that they should figure out something that might
</I>&gt;<i> be tricky to implement and write some wrappers or submit some patches.
</I>&gt;<i>  Perhaps a separate error message, rather than a separate exception type?
</I>&gt;<i>  Do you have a different use-case?
</I>&gt;<i>
</I>
The first kind should skip tests, the second kind should fail tests.

&gt;<i> One related thing that we spoke about in person was pushing this negotiation
</I>&gt;<i> of file-system features backwards to the initialization step, so that
</I>&gt;<i> applications which needed unusual filesystem attributes could fail quickly
</I>&gt;<i> with a clear error message if they weren't supported by the underlying
</I>&gt;<i> platform.
</I>
This sounds like a good idea, provided that there are still clear
runtime errors and that you can skip the negotiation.

Use cases for this would be a virtual filesystem that's glued together
from other virtual filesystems, each of which has different
capabilities.

&gt;<i> (&quot;WebDAV requires extended filesystem attributes, and your
</I>&gt;<i> backend, SFTP, does not provide that feature.&quot;, &quot;txGnuStow requires symbolic
</I>
Actually, some versions of SFTP do provide it. I'm not sure that there
are any implementations though :)

&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  * we still need to decide whether path resolution should be moved to
</I>&gt;&gt;&gt;<i> a separate interface, instead of being part of the node's interface.
</I>&gt;<i>
</I>&gt;&gt;<i> I'm not 100% sure what this means? Does this relate to possibly
</I>&gt;&gt;<i> combining with FilePath?
</I>&gt;<i>
</I>&gt;<i> The tongue-in-cheek name that radix gave to this interface was
</I>&gt;<i> 'filepath.pathdelta'.  It's related to filepath in the sense that FilePath,
</I>&gt;<i> ZipPath, et. al. could benefit from using the same interface to talk about
</I>&gt;<i> relative pathnames rather than manipulating lists of strings.  One can,
</I>&gt;<i> after all, abstractly do operations like &quot;child()&quot; and &quot;parent()&quot; without
</I>&gt;<i> knowing a lot about the base implementation of the filesystem in question.
</I>
Well, the world needs a decent one of these.

&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  * there's concern over the package name.  twisted.tree has
</I>&gt;&gt;&gt;<i> considerable support :)
</I>&gt;<i>
</I>&gt;&gt;<i> I kind of like that. I'm not sure what the concern is with 'vfs' though.
</I>&gt;<i>
</I>&gt;<i> &quot;twisted.vfs&quot; sounds incredibly boring and unpronounceable.  It would be the
</I>&gt;<i> first twisted.&lt;acronym&gt; package, and it's not really related to any other
</I>&gt;<i> technology ambiguously named &quot;vfs&quot;.
</I>&gt;<i>
</I>&gt;<i> However, this reminds me about another concern which I did not remember to
</I>&gt;<i> raise while Andy was here.  Should this really be twisted.&lt;anything&gt; at all?
</I>&gt;<i>  I'd like twisted &lt;x&gt; &quot;dot products&quot; to generally be an application which
</I>&gt;<i> does something &lt;x&gt;-ish.  I'm aware that not every package follows this rule,
</I>&gt;<i> but the ones that don't are either (A) unmaintained and slated for removal,
</I>&gt;<i> or (B) part of the core, not independent subprojects, as &quot;vfs&quot; seems slated
</I>&gt;<i> to be.
</I>&gt;<i>
</I>&gt;<i> Put a different way: what should 'twistd tree' do?  My suggestion would be a
</I>&gt;<i> simple multi-protocol file server: HTTP, FTP (although probably disable that
</I>&gt;<i> by default), SFTP, maybe a &quot;native&quot; protocol for providing a generalized
</I>&gt;<i> backend for any Twisted application that uses the 'tree' API, so that we can
</I>&gt;<i> write a proxy that exposes every arbitrary combination of features from the
</I>&gt;<i> protocols it's talking to.
</I>&gt;<i>
</I>&gt;<i> If everyone agrees with this, then great.  However, if we never intend for
</I>&gt;<i> this to go beyond providing an API that other systems hook into, maybe it
</I>&gt;<i> should go somewhere subordinate to another project; twisted.internet.files
</I>&gt;<i> perhaps?
</I>&gt;<i>
</I>
So, this is the thing that *I'm* least worried about.

I think it should just be an API, and that it should be done so that
other Twisted components can depend on it. Beyond that, it's package
location is unimportant.

&gt;&gt;<i> Here's some random stuff that I wanted to at least mention:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Error translation. This should translate the exception types, but it
</I>&gt;&gt;<i> should also translate values, so the error contains the virtual path.
</I>&gt;<i>
</I>&gt;<i> This sounds like a specific enough thing that you could file a ticket that
</I>&gt;<i> described the exact behavior that you wanted.  It doesn't sound contentious
</I>&gt;<i> at all to me, so unless you think there's some hidden confusion there... go
</I>&gt;<i> ahead?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> - Deferreds. You don't mention them at all, but the lack of
</I>&gt;&gt;<i> asynchronous interfaces was one of the biggest problems we had with
</I>&gt;&gt;<i> twisted.vfs.
</I>&gt;<i>
</I>&gt;<i> I believe that the consensus on asynchronicity is that all of the
</I>&gt;<i> synchronous stuff should be FilePath's job.  In the glorious future of
</I>&gt;<i> twisted.tree, everything will be async.  As discussed above, this doesn't
</I>&gt;<i> always mean Deferreds, it also means producers and consumers.
</I>&gt;<i>
</I>
Good good.

&gt;<i> One thing we didn't talk about in person: handling extremely large
</I>&gt;<i> directories.  We had spoken about children() returning a Deferred of a list;
</I>&gt;<i> I think it would be nice if it actually had a producer/consumer API of its
</I>&gt;<i> own.  Maybe this is too much of a corner case to worry about in average
</I>&gt;<i> applications (i.e. we could provide a give-me-a-deferred convenience API)
</I>&gt;<i> but it would be nice if it were *possible* to implement things that were
</I>&gt;<i> efficient against really big networked directories.
</I>&gt;&gt;<i>
</I>
Yes. This would be very nice.

&gt;&gt;<i> - URL Escaping. I got bitten by this recently. It's obviously not a
</I>&gt;&gt;<i> general VFS problem, but it's an issue with enough of them that it
</I>&gt;&gt;<i> should be considered when defining interfaces.
</I>&gt;<i>
</I>&gt;<i> I *think* that this should be pretty easily dealt with in a pretty generic
</I>&gt;<i> way by having a clearly-defined set of string escaping rules depending on
</I>&gt;<i> which protocol you're using.  It's a general VFS issue in the sense that
</I>&gt;<i> there are escaping issues with &quot;/&quot; on regular filesystems, after all.  Or at
</I>&gt;<i> least, there are error-reporting issues with characters like &quot;/&quot;, &quot;;&quot;, and
</I>&gt;<i> &quot;:&quot; on certain FSes.
</I>&gt;<i>
</I>
Good. I just wanted to flag it.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="018041.html">[Twisted-Python] Bloody Twisted Tree (VFS)
</A></li>
	<LI>Next message: <A HREF="018045.html">[Twisted-Python] Bloody Twisted Tree (VFS)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#18044">[ date ]</a>
              <a href="thread.html#18044">[ thread ]</a>
              <a href="subject.html#18044">[ subject ]</a>
              <a href="author.html#18044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
