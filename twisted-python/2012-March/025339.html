<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] HTTPS proxy with twisted?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20HTTPS%20proxy%20with%20twisted%3F&In-Reply-To=4F5E174E.5060305%40imperial.ac.uk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025338.html">
   <LINK REL="Next"  HREF="025342.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] HTTPS proxy with twisted?</H1>
    <B>Steve Chapel</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20HTTPS%20proxy%20with%20twisted%3F&In-Reply-To=4F5E174E.5060305%40imperial.ac.uk"
       TITLE="[Twisted-Python] HTTPS proxy with twisted?">schapel at umich.edu
       </A><BR>
    <I>Mon Mar 12 12:11:10 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="025338.html">[Twisted-Python] HTTPS proxy with twisted?
</A></li>
        <LI>Next message: <A HREF="025342.html">[Twisted-Python] HTTPS proxy with twisted?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25339">[ date ]</a>
              <a href="thread.html#25339">[ thread ]</a>
              <a href="subject.html#25339">[ subject ]</a>
              <a href="author.html#25339">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Well, the HTTPS proxy actually not an assignment. Getting the HTTPS 
proxy working is just the starting point we need before we can do any 
research, and at this point the research project is due in four weeks. 
If you can point to some twisted code for an HTTPS proxy or 
documentation for how to write one, that won't be giving us undue help 
but will enable us to have a chance to get the research done at all. At 
this point, I'm thinking of using a regular Python program because I 
found a MITM proxy already written, so we could start the research right 
away.

-- Steve


On 03/12/2012 11:33 AM, Phil Mayers wrote:
&gt;<i> On 11/03/12 16:18, Steve Chapel wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I will need to write an HTTPS proxy, which will examine the certificates
</I>&gt;&gt;<i> sent from the web server and determine whether the certificate is valid
</I>&gt;&gt;<i> or invalid. If the proxy determines if the certificate is valid, I will
</I>&gt;&gt;<i> need to resign the document. I suppose this will require that the proxy
</I>&gt;&gt;<i> be a certificate authority and will generate certificates for websites,
</I>&gt;&gt;<i> which the proxy will then use to sign the documents. Will this be
</I>&gt;&gt;<i> something that twisted can do easily? If so, where can I find
</I>&gt;&gt;<i> documentation for how to do this?
</I>&gt;<i> This is a pretty hard question to answer in this form, and depends on
</I>&gt;<i> what you mean by &quot;easily&quot;. Since you say it's classwork I'm reluctant to
</I>&gt;<i> say too much, but...
</I>&gt;<i>
</I>&gt;<i> Fundamentally, the only &quot;difficult&quot; bit of this project in terms of
</I>&gt;<i> Twisted capabilities is finding the original destination address of your
</I>&gt;<i> intercepted connections (so that you can do a &quot;lookaside&quot; connection and
</I>&gt;<i> verify / impersonate the far-end cert)
</I>&gt;<i>
</I>&gt;<i> Presumably you'll be using something like Linux/IPTables to do this:
</I>&gt;<i>
</I>&gt;<i> iptables t nat -A PREROUTING \
</I>&gt;<i>     -p tcp --dport 443 -j REDIRECT --to-port&lt;twisted&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> In that case, you can find the original destination address by calling:
</I>&gt;<i>
</I>&gt;<i> socket.getsockopt(self.transport.fileno(), SOL_IP, SO_ORIGINAL_DST, 16)
</I>&gt;<i>
</I>&gt;<i> ...in your transport &quot;connectionMade&quot;. You will presumably then want to
</I>&gt;<i> start up an SSL connection to the original IP (or draw from cache) to
</I>&gt;<i> find the far-end cert attributes (note: plural), call out to your local
</I>&gt;<i> MITM CA for an impersonated cert/key, then call startTLS in server mode
</I>&gt;<i> using a context holding the fake cert/key.
</I>&gt;<i>
</I>&gt;<i> This isn't very hard, and Twisted has everything you need (accept TCP
</I>&gt;<i> connections, make outgoing SSL, find server certs, call out to
</I>&gt;<i> subprocess, startTLS in server mode) except the SO_ORIGINAL_DST stuff
</I>&gt;<i> (which is easy to add in).
</I>&gt;<i>
</I>&gt;<i> Anyway, I hope this helps; good luck with the assignment!
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i> Phil
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025338.html">[Twisted-Python] HTTPS proxy with twisted?
</A></li>
	<LI>Next message: <A HREF="025342.html">[Twisted-Python] HTTPS proxy with twisted?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25339">[ date ]</a>
              <a href="thread.html#25339">[ thread ]</a>
              <a href="subject.html#25339">[ subject ]</a>
              <a href="author.html#25339">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
