<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] accurate periodic call
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20accurate%20periodic%20call&In-Reply-To=9A4A540809FC414FB909E3C44D3A53C54AEF0FC4%40veles.kzps.si">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025349.html">
   <LINK REL="Next"  HREF="025352.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] accurate periodic call</H1>
    <B>Zoran Bo&#353;njak</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20accurate%20periodic%20call&In-Reply-To=9A4A540809FC414FB909E3C44D3A53C54AEF0FC4%40veles.kzps.si"
       TITLE="[Twisted-Python] accurate periodic call">Zoran.Bosnjak at sloveniacontrol.si
       </A><BR>
    <I>Wed Mar 14 07:57:02 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="025349.html">[Twisted-Python] Basic Resource Tree question
</A></li>
        <LI>Next message: <A HREF="025352.html">[Twisted-Python] accurate periodic call
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25350">[ date ]</a>
              <a href="thread.html#25350">[ thread ]</a>
              <a href="subject.html#25350">[ subject ]</a>
              <a href="author.html#25350">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all,
Thanks for all your comments.

I have filed a ticket regarding this issue:
<A HREF="http://twistedmatrix.com/trac/ticket/5552">http://twistedmatrix.com/trac/ticket/5552</A>

I hope it will be accepted as a problem.

regards,
Zoran

________________________________________
From: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A> [<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python-bounces at twistedmatrix.com</A>] on behalf of Zoran Bo&#353;njak [<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Zoran.Bosnjak at sloveniacontrol.si</A>]
Sent: Sunday, February 19, 2012 5:49 PM
To: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>
Subject: [Twisted-Python] accurate periodic call

Hello all,
I was astonished to find out that looping call period depends on the system time by default. The periodic tick can even stall for a long time, if the system time jumps backwards during program execution. It turned out that this is in fact a python problem (not providing a monotonic time, at least not for posix).

I urgently need accurate periodic call in my program and I've found the solution below that seems to be working. I kindly ask you for your comments:
- Is this monotonic_time implementation OK from python perspective?
- Is monkey patch to the reactor OK or is there any other solution more appropriate in this case (I do not want to patch each looping call, but once in the application)?
- Does this patch have any negative influence to the rest of the reactor?
- How would you implement a periodic function call in twisted application (as accurate as possible)?
- Any chance to see something implemented inside twisted and/or python, so that applications don't need this kind of tricks?

Thanks a lot for your comments.

Zoran

#! /usr/bin/env python

from twisted.internet import task
from twisted.internet import reactor
import os
import time
import ctypes

# python MONOTONIC time, borrowed here
# <A HREF="http://stackoverflow.com/questions/1205722/how-do-i-get-monotonic-time-durations-in-python">http://stackoverflow.com/questions/1205722/how-do-i-get-monotonic-time-durations-in-python</A>
if os.name == 'posix':

    CLOCK_MONOTONIC = 1 # see &lt;linux/time.h&gt;

    class timespec(ctypes.Structure):
        _fields_ = [
            ('tv_sec', ctypes.c_long),
            ('tv_nsec', ctypes.c_long)
        ]

    librt = ctypes.CDLL('librt.so.1', use_errno=True)
    clock_gettime = librt.clock_gettime
    clock_gettime.argtypes = [ctypes.c_int, ctypes.POINTER(timespec)]

    def monotonic_time():
        t = timespec()
        if clock_gettime(CLOCK_MONOTONIC, ctypes.pointer(t)) != 0:
            errno_ = ctypes.get_errno()
            raise OSError(errno_, os.strerror(errno_))
        return t.tv_sec + t.tv_nsec * 1e-9

    # monkey patch the reactor
    reactor.seconds = monotonic_time

# TODO: check for other platforms!!
else:
    monotonic_time = time.time

def tick():
    &quot;&quot;&quot;This function is suppose to execute once a second,
    regardless of the system time.&quot;&quot;&quot;

    print 'tick', monotonic_time()

loop = task.LoopingCall(tick)
loop.start(1.0)

reactor.run()

_______________________________________________
Twisted-Python mailing list
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025349.html">[Twisted-Python] Basic Resource Tree question
</A></li>
	<LI>Next message: <A HREF="025352.html">[Twisted-Python] accurate periodic call
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25350">[ date ]</a>
              <a href="thread.html#25350">[ thread ]</a>
              <a href="subject.html#25350">[ subject ]</a>
              <a href="author.html#25350">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
