<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] cfreactor and global state
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20cfreactor%20and%20global%20state&In-Reply-To=%3CE85DA6DC-3245-454E-8EE4-E2897FB77126%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="057819.html">
   <LINK REL="Next"  HREF="057820.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] cfreactor and global state</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20cfreactor%20and%20global%20state&In-Reply-To=%3CE85DA6DC-3245-454E-8EE4-E2897FB77126%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] cfreactor and global state">glyph at twistedmatrix.com
       </A><BR>
    <I>Sat Mar 17 20:15:34 MDT 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="057819.html">[Twisted-Python] cfreactor and global state
</A></li>
        <LI>Next message (by thread): <A HREF="057820.html">[Twisted-Python] Basic Resource Tree question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57840">[ date ]</a>
              <a href="thread.html#57840">[ thread ]</a>
              <a href="subject.html#57840">[ subject ]</a>
              <a href="author.html#57840">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mar 13, 2012, at 10:44 PM, Itamar Turner-Trauring wrote:

&gt;<i> twisted.internet.test.reactormixins says:
</I>&gt;<i> CFReactor uses APIs which manipulate global state, so it's not safe to run its own reactor-builder tests under itself.
</I>&gt;<i> 
</I>&gt;<i> We also don't have a buildslave running under cfreactor. Which means it's currently completely untested. I filed a ticket to fix that - <A HREF="https://bugs.launchpad.net/twisted-buildbot-configuration/+bug/954680">https://bugs.launchpad.net/twisted-buildbot-configuration/+bug/954680</A>
</I>
Not completely untested. If you search a recent OS X build log, for example &lt;<A HREF="http://buildbot.twistedmatrix.com/builders/osx10.6-py2.6-select/builds/1952/steps/select/logs/stdio">http://buildbot.twistedmatrix.com/builders/osx10.6-py2.6-select/builds/1952/steps/select/logs/stdio</A>&gt;, you will see lots of &quot;_CFReactor&quot; tests that pass.

Ironically a builder run under CFReactor itself will test less code related to the CFReactor, because it will only run the haphazard tests that test the global reactor by returning Deferreds rather than running the reactor.  But it does test different stuff, so there's value in having it run both ways.

&gt;<i> That still leaves the problem with global state though. Since we want to move towards having tests create new reactors, that's problematic. What global state does it manipulate, and what can we do about it?
</I>
It manipulates the CoreFoundation run loop for its thread.  Ironically, the reason that this is the case is that CF's API, much like Twisted itself, is not reentrant.  If you're interested, &lt;<A HREF="http://developer.apple.com/library/mac/#documentation/CoreFoundation/Reference/CFRunLoopRef/Reference/reference.html">http://developer.apple.com/library/mac/#documentation/CoreFoundation/Reference/CFRunLoopRef/Reference/reference.html</A>&gt; is a pretty comprehensive reference.

We can't really do anything about it unless we can make Twisted start a new thread for each reactorbuilder test and then destroy the thread at the end.  Or, unless we mock the whole CF API - which, honestly, isn't that hard, there aren't a ton of functions and they do pretty straightforward stuff.

-glyph


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20120317/11c4f020/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="057819.html">[Twisted-Python] cfreactor and global state
</A></li>
	<LI>Next message (by thread): <A HREF="057820.html">[Twisted-Python] Basic Resource Tree question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57840">[ date ]</a>
              <a href="thread.html#57840">[ thread ]</a>
              <a href="subject.html#57840">[ subject ]</a>
              <a href="author.html#57840">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
