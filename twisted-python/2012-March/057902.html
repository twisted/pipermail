<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] the good, the log, and the ugly
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20the%20good%2C%20the%20log%2C%20and%20the%20ugly&In-Reply-To=%3C20120326143830.3561.285840820.divmod.xquotient.9%40localhost6.localdomain6%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="057884.html">
   <LINK REL="Next"  HREF="057903.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] the good, the log, and the ugly</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20the%20good%2C%20the%20log%2C%20and%20the%20ugly&In-Reply-To=%3C20120326143830.3561.285840820.divmod.xquotient.9%40localhost6.localdomain6%3E"
       TITLE="[Twisted-Python] the good, the log, and the ugly">exarkun at twistedmatrix.com
       </A><BR>
    <I>Mon Mar 26 08:38:30 MDT 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="057884.html">[Twisted-Python] the good, the log, and the ugly
</A></li>
        <LI>Next message (by thread): <A HREF="057903.html">[Twisted-Python] the good, the log, and the ugly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57902">[ date ]</a>
              <a href="thread.html#57902">[ thread ]</a>
              <a href="subject.html#57902">[ subject ]</a>
              <a href="author.html#57902">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02:11 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A> wrote:
&gt;<i>Right now, we have a pretty bad logging idiom.  All over Twisted, 
</I>&gt;<i>you'll find stuff like this:
</I>&gt;<i>
</I>&gt;<i>log.msg(&quot;twistd %s (%s %s) starting up.&quot; % (copyright.version,
</I>&gt;<i>                                            sys.executable,
</I>&gt;<i>runtime.shortPythonVersion()))
</I>&gt;<i>...
</I>&gt;<i>log.msg(&quot;Loading %s...&quot; % filename)
</I>&gt;<i>...
</I>&gt;<i>log.msg(&quot;Received unhandled keyID: %r&quot; % (keyID,))
</I>&gt;<i>
</I>&gt;<i>In other words, log messages that take structured information, but then 
</I>&gt;<i>smash it into a not-particularly-distinctive string and spit it out 
</I>&gt;<i>into a line-delimited file.
</I>&gt;<i>
</I>&gt;<i>The Twisted log system has, from its very beginning, supported a better 
</I>&gt;<i>style of formatting, which is:
</I>&gt;<i>
</I>&gt;<i>log.msg(format=&quot;twistd %(version)s (%(executable)s %(short)s) starting 
</I>&gt;<i>up.&quot;,
</I>&gt;<i>        version=copyright.version, executable=sys.executable,
</I>&gt;<i>        short=runtime.shortPythonVersion()))
</I>&gt;<i>...
</I>&gt;<i>log.msg(format=&quot;Loading %(filename)s...&quot;, filename=filename)
</I>&gt;<i>...
</I>&gt;<i>log.msg(format=&quot;Received unhandled keyID: %(keyID)r&quot;, keyID=keyID)
</I>&gt;<i>
</I>&gt;<i>There are lots of other features which this style of logging could 
</I>&gt;<i>support, as well, with relatively minor tweaks, such as trivial 
</I>&gt;<i>enhancements like:
</I>&gt;<i>
</I>&gt;<i>def logger(module, audience, importance):
</I>&gt;<i>    def logIt(**kw):
</I>&gt;<i>        log.msg(module=module, audience=audience, importance=importance, 
</I>&gt;<i>**kw)
</I>&gt;<i>    return logIt
</I>&gt;<i>...
</I>&gt;<i>info = logger(__name__, ADMIN, NORMAL)
</I>&gt;<i>bugreport = logger(__name__, DEVEL, HIGH)
</I>&gt;<i>debug = logger(__name__, DEVEL, LOW)
</I>&gt;<i>...
</I>&gt;<i>info(format=&quot;twistd %(version)s (%(executable)s %(short)s) starting 
</I>&gt;<i>up.&quot;,
</I>&gt;<i>     version=copyright.version, executable=sys.executable,
</I>&gt;<i>     short=runtime.shortPythonVersion()))
</I>&gt;<i>
</I>&gt;<i>This would then allow us to build systems which internally filter 
</I>&gt;<i>messages, avoid expensive string formatting and copying when it's not 
</I>&gt;<i>necessary, tune logging to different levels for different parts of the 
</I>&gt;<i>package hierarchy, and have intelligent real-time log analysis that 
</I>&gt;<i>inspects the objects being logged without having to apply regexes or 
</I>&gt;<i>other static-string-inspection methods to figure out which messages are 
</I>&gt;<i>interesting.  Calendar Server implements some of these features for its 
</I>&gt;<i>logging system, and they've been very useful there.  Various Divmod 
</I>&gt;<i>projects have implemented run-time statistics tracking via that Twisted 
</I>&gt;<i>logging system, and that worked pretty well too.  It would be good to 
</I>&gt;<i>start taking advantage of the good parts of Twisted's logging system 
</I>&gt;<i>within Twisted itself.
</I>&gt;<i>
</I>&gt;<i>Doing this in a consistent way would also open up the possibility of 
</I>&gt;<i>localizing our log messages, which is currently not really plausible. 
</I>&gt;<i>And also, of logging in a format which lost less information; for 
</I>&gt;<i>example, instead of actually doing textToEventDict, simply dumping a 
</I>&gt;<i>simplified form of the event dict itself to some structured format that 
</I>&gt;<i>could be reliably parsed – something like JSON – for easier parsing and 
</I>&gt;<i>analysis later.
</I>&gt;<i>
</I>&gt;<i>However, in order to be able to take advantage of these features when 
</I>&gt;<i>they're added, we need to start avoiding premature string formatting 
</I>&gt;<i>everywhere that we can today.  If you're writing log messages within 
</I>&gt;<i>twisted (or within a twisted application or library) please adopt the 
</I>&gt;<i>format=, x=, y= style of logging messages so that log observers can 
</I>&gt;<i>actually see into the objects being logged and do interesting things 
</I>&gt;<i>with them.
</I>&gt;<i>
</I>&gt;<i>We should also file some tickets about improving the documentation to 
</I>&gt;<i>indicate this style, for writing a new interface to logging which 
</I>&gt;<i>mandates this style, and for adding layers on top of that to provide 
</I>&gt;<i>more useful functionality like the aforementioned per-module or per- 
</I>&gt;<i>audience filtering.  I have long despaired of filing such tickets 
</I>&gt;<i>because they each seem like boil-the-ocean tasks, changing every single 
</I>&gt;<i>call-site of log.msg (there are more than 500 as of today, just in 
</I>&gt;<i>Twisted itself, and thousands more in other applications I'm sure).
</I>&gt;<i>
</I>&gt;<i>I'm going to try to get started on record my desired behavior for 
</I>&gt;<i>logging as tickets soon though, so Twisted can at least have some 
</I>&gt;<i>really good logging tools eventually.
</I>
I agree with just about everything here, except I think we should be 
able to do better than the `format=&quot;opaque string&quot;´ part.

Logging in the style you outlined here preserves the structure of the 
information, but it omits any consistent way to identify what the 
structure is.  It seems to leave only two possibilities:

  - Compare the format string to certain well-known format strings and 
use a match (if found) to make decisions based on a priori knowledge 
about the additional items in the log event.

  - Compare the set of keys in the log event to certain well-known sets 
and use a match there to make the same kind of decision.

Neither of these sounds like a good thing.

Divmod experimented with marking log events with interfaces that 
documented the structure and semantics of the log event carrying them. 
This didn't get very far, and perhaps had problems of its own, but even 
it seemed preferable to either of the above options.

Jean-Paul
&gt;<i>-glyph
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="057884.html">[Twisted-Python] the good, the log, and the ugly
</A></li>
	<LI>Next message (by thread): <A HREF="057903.html">[Twisted-Python] the good, the log, and the ugly
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57902">[ date ]</a>
              <a href="thread.html#57902">[ thread ]</a>
              <a href="subject.html#57902">[ subject ]</a>
              <a href="author.html#57902">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
