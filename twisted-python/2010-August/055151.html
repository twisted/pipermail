<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] inlineCallbacks yield tuple support
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20inlineCallbacks%20yield%20tuple%20support&In-Reply-To=%3C4C5B7C1C.3020404%40naumen.ru%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="055150.html">
   <LINK REL="Next"  HREF="055152.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] inlineCallbacks yield tuple support</H1>
    <B>Сергей Магафуров</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20inlineCallbacks%20yield%20tuple%20support&In-Reply-To=%3C4C5B7C1C.3020404%40naumen.ru%3E"
       TITLE="[Twisted-Python] inlineCallbacks yield tuple support">smagafurov at naumen.ru
       </A><BR>
    <I>Thu Aug  5 21:06:04 MDT 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="055150.html">[Twisted-Python] Get trial to use the docstring?
</A></li>
        <LI>Next message (by thread): <A HREF="055152.html">[Twisted-Python] strange bug with... something :)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55151">[ date ]</a>
              <a href="thread.html#55151">[ thread ]</a>
              <a href="subject.html#55151">[ subject ]</a>
              <a href="author.html#55151">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This example shows what i want:

@defer.inlineCallbacks
def create_audio_link(tel, addr1, addr2):
     try:
         connection1, connection2 = yield (tel.connect(addr1), tel.connect(addr2))
     except ConnectionError, exc:
         ... some error work ...
     else:
         return tel.create_audiolink(connection1, connection2)

At now we can do this with DeferredList but it is complex (compare with 
first example):

@defer.inlineCallbacks
def create_audio_link(tel, addr1, addr2):
     try:
         try:
             r = yield DeferredList([tel.connect(addr1), tel.connect(addr2)], fireOnOneErrback=1, consumeErrors=1)
         except FirstError, exc:
             raise exc.subFailure.value
         else:
             connection1, connection2 = tuple(_r for _s, _r in r)
     except ConnectionError, exc:
         ... some error work ...
     else:
         return tel.create_audiolink(connection1, connection2)

Approximate solution (idea) is patch in defer.py:

def _inlineCallbacks(result, g, deferred):
             ... skipped ...

         if isinstance(result, Deferred):
             # a deferred was yielded, get the result.

             ... skipped ...

             waiting[0] = True
             waiting[1] = None

         if isinstance(result, tuple):
             # a tuple was yielded, get the result.
             result = DeferredList(result, fireOnOneErrback=1, consumeErrors=1)
             def gotResult(r):
                 if isinstance(r, failure.Failure):
                     r = r.value.subFailure
                 else:
                     r = tuple(_r for _s, _r in r)
                 if waiting[0]:
                     waiting[0] = False
                     waiting[1] = r
                 else:
                     _inlineCallbacks(r, g, deferred)

             result.addBoth(gotResult)
             if waiting[0]:
                 # Haven't called back yet, set flag so that we get reinvoked
                 # and return from the loop
                 waiting[0] = False
                 return deferred

             result = waiting[1]
             # Reset waiting to initial values for next loop.  gotResult uses
             # waiting, but this isn't a problem because gotResult is only
             # executed once, and if it hasn't been executed yet, the return
             # branch above would have been taken.


             waiting[0] = True
             waiting[1] = None


     return deferred

I post this as ticket but was redirected to mailing-list
<A HREF="http://twistedmatrix.com/trac/ticket/4627">http://twistedmatrix.com/trac/ticket/4627</A>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20100806/a23a3d0b/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="055150.html">[Twisted-Python] Get trial to use the docstring?
</A></li>
	<LI>Next message (by thread): <A HREF="055152.html">[Twisted-Python] strange bug with... something :)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55151">[ date ]</a>
              <a href="thread.html#55151">[ thread ]</a>
              <a href="subject.html#55151">[ subject ]</a>
              <a href="author.html#55151">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
