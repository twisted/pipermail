<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] inlineCallbacks cascading cancelling and more
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20inlineCallbacks%20cascading%20cancelling%20and%20more&In-Reply-To=2ACA618E-A238-4B64-8C13-4E17521C1C49%40twistedmatrix.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022694.html">
   <LINK REL="Next"  HREF="022697.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] inlineCallbacks cascading cancelling and more</H1>
    <B>Sergey Magafurov</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20inlineCallbacks%20cascading%20cancelling%20and%20more&In-Reply-To=2ACA618E-A238-4B64-8C13-4E17521C1C49%40twistedmatrix.com"
       TITLE="[Twisted-Python] inlineCallbacks cascading cancelling and more">smagafurov at naumen.ru
       </A><BR>
    <I>Tue Aug 17 01:49:32 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022694.html">[Twisted-Python] inlineCallbacks cascading cancelling and more
</A></li>
        <LI>Next message: <A HREF="022697.html">[Twisted-Python] inlineCallbacks cascading cancelling and more
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22696">[ date ]</a>
              <a href="thread.html#22696">[ thread ]</a>
              <a href="subject.html#22696">[ subject ]</a>
              <a href="author.html#22696">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> First, generally: the most important thing to provide here are unit 
</I>&gt;<i> tests with very clear documentation expressing why you would want 
</I>&gt;<i> these things to work.  The test code you provided is unclear because 
</I>&gt;<i> it does not succeed or fail, it just does some things, and then does 
</I>&gt;<i> some other things, without explaining /why/ I would want to do those 
</I>&gt;<i> things.  Given that the implementation of Deferred is changing a lot 
</I>&gt;<i> now (see &lt;<A HREF="http://twistedmatrix.com/trac/ticket/411">http://twistedmatrix.com/trac/ticket/411</A>&gt;), if we agree with 
</I>&gt;<i> your features, the implementation may have to change completely.  So, 
</I>&gt;<i> it is important to have tests that describe just the behavior change, 
</I>&gt;<i> not the implementation.
</I>Agree! I precisely trying to suggest behavior, not the implementation :)
&gt;&gt;<i> Wanted features:
</I>&gt;&gt;<i> 1. Ability to delete callbacks (delCallbacks)
</I>&gt;<i>
</I>&gt;<i> Can you please explain *why* you would want this?  Deleting callbacks 
</I>&gt;<i> from a Deferred would break a lot of assumptions about the way that 
</I>&gt;<i> Deferreds are used (at any particular point in the callback chain, you 
</I>&gt;<i> should be able to infer what the return type should be just by looking 
</I>&gt;<i> at the code, not running it).
</I>&gt;<i>
</I>&gt;<i> So, it is very unlikely that we will add the ability to delete 
</I>&gt;<i> arbitrary callbacks.
</I>
&gt;&gt;<i> 3. Ability to add/del hooks on deferred's finishing with errback 
</I>&gt;&gt;<i> or callback (addFinalizer/delFinalizer)
</I>&gt;<i>
</I>&gt;<i> You can already do this with weakref callbacks.  Why would you need 
</I>&gt;<i> Deferred to provide an alternate mechanism?
</I>
I will try to explain why i want this features with example.
My task is about telephony.
Some user makes call and we want to acquire some TextToSpeach resource 
and AutomaticSpeachRecognition resource to do some automatic 
conversation with user.
We start playing music to user, launch long process to acquire this 
(expensive!) resources. After they have acquired, we establish audio 
links. After they established we speak something to user and start 
recognition. See NOTE in code.

@inlineCallbacks
def incoming_call(self, call):
     call.start_play('music')
     try:
         tts, asr = yield self.acquire_tts_for(call), 
self.acquire_asr_for(call) # tuple yield feature!
     except TimeoutError:
         # this occurs if TimeoutError raises in `self.acquire_tts_for` 
or `self.acquire_asr_for`
         # i.e. DeferredList(..., fireOnOneErrback=1)
         call.transfer_to('operator')
         # NOTE: at this point I want to automatically _recursively_ (to 
deep) stop all deferred processes
         # starting inside `self.acquire_tts_for` and `self.acquire_asr_for`
         # because I don't need their results (and expensive resources!) 
any more
     else:
         try:
             yield tts.speak('what you want? say me after signal')
             yield asr.start_recognition()
             call.start_play('signal')
             result = yield asr.wait_recognition_result()
             ... do something with result ...
         finally:
             tts.release()
             asr.release()

@inlineCallbacks
def acquire_tts_for(self, call):
     tts_connection = yield self.tts.acquire_connection(timeout=10) # 
may raise TimeoutError inside
     yield call.make_audio_link_with(tts_connection, 'in', timeout=10) # 
may raise TimeoutError inside
     return tts_connection

@inlineCallbacks
def acquire_asr_for(self, call):
     asr_connection = yield self.asr.acquire_connection(timeout=10) # 
may raise TimeoutError inside
     yield call.make_audio_link_with(asr_connection, 'out', timeout=10) 
# may raise TimeoutError inside
     return asr_connection

To do this code to work:
1. Deferred()s must have feature to be informed that somebody does't 
need their result any more (delCallbacks)
2. Deferred()s must track their usage, and automatically cancels (and 
therefore calls their finalizers, see below) when they not used any more 
(nobody needs their result any more)
3. inlineCallbacks must release (delCallbacks) their child Defered()s 
when it doesn't need their result any more, this allows them to 
autimatically cancelling (if they dont needed somebody else). To do this 
inlineCallbacks must add some hook (addFinalizer) to parent Deferred and 
release child Deferreds when parent Deferred finished 
(callbacked/errbacked and therefore cancelled due cancel call errback). 
Why we need addFinalizer mechanism? Because addCallbacks means that 
Deferred is used, that somebody needs their result. But addFinalizer 
means that we don't neeed result, we just want to know when Deferred 
finished (to release our child resources for example).

One more thing we may do with this features. What if our User hangs up 
call? What if our tcp connection lost (with that we have receive 
incoming call)? All resources (ASR and TTS) must be released as soon as 
possible! yields inside incoming_call must raise some ShuttingdownError 
for example. We may do this with above features.

&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>    
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20100817/e8f38c30/attachment-0001.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20100817/e8f38c30/attachment-0001.htm</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022694.html">[Twisted-Python] inlineCallbacks cascading cancelling and more
</A></li>
	<LI>Next message: <A HREF="022697.html">[Twisted-Python] inlineCallbacks cascading cancelling and more
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22696">[ date ]</a>
              <a href="thread.html#22696">[ thread ]</a>
              <a href="subject.html#22696">[ subject ]</a>
              <a href="author.html#22696">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
