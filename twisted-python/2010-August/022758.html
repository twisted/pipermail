<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] git clone with spawnProcess() can prevent socket data flow, any clue why?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20git%20clone%20with%20spawnProcess%28%29%20can%20prevent%20socket%0A%20data%20flow%2C%20any%20clue%20why%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022747.html">
   <LINK REL="Next"  HREF="022759.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] git clone with spawnProcess() can prevent socket data flow, any clue why?</H1>
    <B>Martin Nordholts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20git%20clone%20with%20spawnProcess%28%29%20can%20prevent%20socket%0A%20data%20flow%2C%20any%20clue%20why%3F&In-Reply-To="
       TITLE="[Twisted-Python] git clone with spawnProcess() can prevent socket data flow, any clue why?">enselic at gmail.com
       </A><BR>
    <I>Sat Aug 28 03:34:24 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022747.html">[Twisted-Python] Twisted and SOAP
</A></li>
        <LI>Next message: <A HREF="022759.html">[Twisted-Python] git clone with spawnProcess() can prevent socket data flow, any clue why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22758">[ date ]</a>
              <a href="thread.html#22758">[ thread ]</a>
              <a href="subject.html#22758">[ subject ]</a>
              <a href="author.html#22758">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

I am getting a weird problem where git cloning with 
reactor.spawnProcess() fails for some repositories. It appears as if 
Twisted blocks reading from the server socket that git packs should come on.

I originally got the problem with buildbot, but I have has isolated the 
problem further to Twisted. The following program can be used to 
reproduce the problem:

  #!/usr/bin/python

  from twisted.internet import reactor, protocol

  class ProcessPrinter(protocol.ProcessProtocol):
      def connectionMade(self):
          print &quot;::connectionMade&quot;

      def outReceived(self, data):
          print &quot;::outReceived&quot;
          print data

      def errReceived(self, data):
          print &quot;::errReceived&quot;
          print data

      def processEnded(self, status_object):
          print &quot;::processEnded&quot;
          print &quot;exit code %d&quot; % status_object.value.exitCode
          reactor.stop()

  def spawn_after_run():
      argv = ['/usr/bin/git', 'clone', '<A HREF="git://git.gnome.org/gimp']">git://git.gnome.org/gimp']</A>
      reactor.spawnProcess(ProcessPrinter(), argv[0], argv)

  reactor.callLater(0, spawn_after_run);
  reactor.run();

If a debugger is attached to the spawned git process, it can be seen 
that the process blocks on read() on the socket that is supposed to be 
fed with git packs from the server.

I have done a tcpdump of the traffic between my computer and the git 
server, and there *is* successful communication going on. More 
specifically, the git client receives the refs the server has, and sends 
the refs it wants, which is acknowledged by the server, but for some 
reason it still eventually blocks on read().

Curiously enough, if the program is changed to clone e.g. 
'<A HREF="git://git.gnome.org/gegl'">git://git.gnome.org/gegl'</A> instead of '<A HREF="git://git.gnome.org/gimp',">git://git.gnome.org/gimp',</A> it 
works! The GIMP repo is much bigger than the GEGL one, which might be 
the trigger for the bug, but I don't understand why it would matter.

I see this problem on Fedora 13 x86_64, both with the distro version 
Twisted 0.8.2, and with the latest stable release Twisted 10.1.0. My 
personal guess is that it has something to do with how spawnProcess() 
manages the fds or the child process.

Does anyone have any guess of what is going on?
Can you reproduce it on other systems?

Thanks in advance for any input.

Regards,
Martin



</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022747.html">[Twisted-Python] Twisted and SOAP
</A></li>
	<LI>Next message: <A HREF="022759.html">[Twisted-Python] git clone with spawnProcess() can prevent socket data flow, any clue why?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22758">[ date ]</a>
              <a href="thread.html#22758">[ thread ]</a>
              <a href="subject.html#22758">[ subject ]</a>
              <a href="author.html#22758">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
