<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Problem Reading a Directory with Conch/SFTP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Problem%20Reading%20a%20Directory%20with%20Conch/SFTP&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024426.html">
   <LINK REL="Next"  HREF="024440.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Problem Reading a Directory with Conch/SFTP</H1>
    <B>Jeffrey Ollie</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Problem%20Reading%20a%20Directory%20with%20Conch/SFTP&In-Reply-To="
       TITLE="[Twisted-Python] Problem Reading a Directory with Conch/SFTP">jeff at ocjtech.us
       </A><BR>
    <I>Mon Aug 22 16:02:25 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="024426.html">[Twisted-Python] Weekly Bug Summary
</A></li>
        <LI>Next message: <A HREF="024440.html">[Twisted-Python] Problem Reading a Directory with Conch/SFTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24429">[ date ]</a>
              <a href="thread.html#24429">[ thread ]</a>
              <a href="subject.html#24429">[ subject ]</a>
              <a href="author.html#24429">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm re-writing a client that downloads some data from a 3rd party
using SFTP.  The old client was written using Paramiko but I'd like to
rewrite it using Twisted and Conch.  Right now I'm running into an
issue trying to get a directory listing from the remote server:

2011-08-22 13:35:03-0500 [SSHChannel session (0) on SSHService
ssh-connection on _WrappingProtocol,client] Unhandled Error
	Traceback (most recent call last):
	  File &quot;/usr/lib64/python2.7/site-packages/twisted/python/log.py&quot;,
line 84, in callWithLogger
	    return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
	  File &quot;/usr/lib64/python2.7/site-packages/twisted/python/log.py&quot;,
line 69, in callWithContext
	    return context.call({ILogContext: newCtx}, func, *args, **kw)
	  File &quot;/usr/lib64/python2.7/site-packages/twisted/python/context.py&quot;,
line 118, in callWithContext
	    return self.currentContext().callWithContext(ctx, func, *args, **kw)
	  File &quot;/usr/lib64/python2.7/site-packages/twisted/python/context.py&quot;,
line 81, in callWithContext
	    return func(*args,**kw)
	--- &lt;exception caught here&gt; ---
	  File &quot;/usr/lib64/python2.7/site-packages/twisted/conch/ssh/filetransfer.py&quot;,
line 53, in dataReceived
	    f(data)
	  File &quot;/usr/lib64/python2.7/site-packages/twisted/conch/ssh/filetransfer.py&quot;,
line 711, in packet_STATUS
	    msg, data = getNS(data)
	  File &quot;/usr/lib64/python2.7/site-packages/twisted/conch/ssh/common.py&quot;,
line 36, in getNS
	    l, = struct.unpack('!L',s[c:c+4])
	struct.error: unpack requires a string argument of length 4

The problem seems to be that the remote SFTP implementation isn't
returning complete status response message - it doesn't include the
error message and the language identifier.  I made a quite ugly
workaround:

diff --git a/twisted/conch/ssh/filetransfer.py b/twisted/conch/ssh/filetransfer.
index 81a86fd..ed55b27 100644
--- a/twisted/conch/ssh/filetransfer.py
+++ b/twisted/conch/ssh/filetransfer.py
@@ -708,8 +708,15 @@ class FileTransferClient(FileTransferBase):
         d, data = self._parseRequest(data)
         code, = struct.unpack('!L', data[:4])
         data = data[4:]
-        msg, data = getNS(data)
-        lang = getNS(data)
+        if len(data) &gt;= 4:
+            msg, data = getNS(data)
+            if len(data) &gt;= 4:
+                lang = getNS(data)
+            else:
+                lang = ''
+        else:
+            msg = ''
+            lang = ''
         if code == FX_OK:
             d.callback((msg, lang))
         elif code == FX_EOF:

Looking through the Paramiko code[1] it looks like it pads SFTP
messages that are shorter than expected with null bytes.  From what I
saw in the  SFTP I-D[2], a status message that doesn't include the
error message and language code could be construed as legal even
though they are not specifically marked as optional.


[1] <A HREF="https://github.com/robey/paramiko/blob/master/paramiko/message.py#L103">https://github.com/robey/paramiko/blob/master/paramiko/message.py#L103</A>
[2] <A HREF="http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-4">http://tools.ietf.org/html/draft-ietf-secsh-filexfer-13#section-4</A>

-- 
Jeff Ollie

</PRE>













<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024426.html">[Twisted-Python] Weekly Bug Summary
</A></li>
	<LI>Next message: <A HREF="024440.html">[Twisted-Python] Problem Reading a Directory with Conch/SFTP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24429">[ date ]</a>
              <a href="thread.html#24429">[ thread ]</a>
              <a href="subject.html#24429">[ subject ]</a>
              <a href="author.html#24429">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
