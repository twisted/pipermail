<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Keeping a list of connected PB clients
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Keeping%20a%20list%20of%20connected%20PB%20clients&In-Reply-To=%3C3af8969a0611251133o275f120fg9b7eb36867188098%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="046908.html">
   <LINK REL="Next"  HREF="046918.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Keeping a list of connected PB clients</H1>
    <B>Yi Qiang</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Keeping%20a%20list%20of%20connected%20PB%20clients&In-Reply-To=%3C3af8969a0611251133o275f120fg9b7eb36867188098%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Keeping a list of connected PB clients">yqiang at gmail.com
       </A><BR>
    <I>Sat Nov 25 12:33:01 MST 2006</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="046908.html">[Twisted-Python] Keeping a list of connected PB clients
</A></li>
        <LI>Next message (by thread): <A HREF="046918.html">[Twisted-Python] Keeping a list of connected PB clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46915">[ date ]</a>
              <a href="thread.html#46915">[ thread ]</a>
              <a href="subject.html#46915">[ subject ]</a>
              <a href="author.html#46915">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/24/06, Phil Christensen &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">phil at bubblehouse.org</A>&gt; wrote:

&gt;<i> The place where you want to do all this is really in your Realm
</I>&gt;<i> instance. I think it's possible to create a PB server that doesn't
</I>&gt;<i> require login, but I've never had any need for it, so you're kind of
</I>&gt;<i> on your own there.
</I>

Hi Phil,
Thanks for the reply.  My implementation is very similar to what you
described below.  I am having the clients pass in a 'mind' object that's
representative of them, which is good enough to keep track of some
information.  What I am having trouble with is getting access to the clients
IP address.  This is not something I can pass in in the PBClientFactory's
login method, since many computers are NAT'ed.

&gt;<i> class MyRealm:
</I>&gt;<i> &gt;     &quot;&quot;&quot;
</I>&gt;<i> &gt;     Holds a reference to the main service object.
</I>&gt;<i> &gt;     &quot;&quot;&quot;
</I>&gt;<i> &gt;     __implements__ = portal.IRealm
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def __init__(self, service):
</I>&gt;<i> &gt;         &quot;&quot;&quot;
</I>&gt;<i> &gt;         Create a realm with the given service.
</I>&gt;<i> &gt;         &quot;&quot;&quot;
</I>&gt;<i> &gt;         self.service = service
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     def requestAvatar(self, avatarId, mind, *interfaces):
</I>&gt;<i> &gt;         &quot;&quot;&quot;
</I>&gt;<i> &gt;         This function is called after the user has verified their
</I>&gt;<i> &gt;         identity. It returns an object that represents the user
</I>&gt;<i> &gt;         in the system, i.e., an avatar.
</I>&gt;<i> &gt;         &quot;&quot;&quot;
</I>&gt;<i> &gt;         if pb.IPerspective in interfaces:
</I>&gt;<i> &gt;             avatar = self._getPBAvatar(avatarId, mind)
</I>&gt;<i> &gt;             ####################### &lt;-- RIGHT HERE
</I>&gt;<i> &gt;             return pb.IPerspective, avatar, avatar.logout
</I>&gt;<i> &gt;         else:
</I>&gt;<i> &gt;             raise NotImplementedError(&quot;no interface&quot;)
</I>&gt;<i>
</I>&gt;<i> This is where you want to maintain your client list. The hardest part
</I>&gt;<i> is deciding on a place to put it that will be accessible from all
</I>&gt;<i> your code; I usually use a singleton pattern of some kind, where I
</I>&gt;<i> can import a module that holds onto client references and provides
</I>&gt;<i> functions to manipulate/retrieve that list.
</I>

Yes, this is something I do have trouble with.  I will look into the
singleton pattern.  It would be nicer if there was a convenient way to
bubble up the  list of clients.

So, that point where I put all those hashes is a pretty good place to
&gt;<i> add clients your client queue. The 'mind' argument is usually a
</I>&gt;<i> reference to the client on the other end, assuming your client passes
</I>&gt;<i> it properly. My client does this:
</I>&gt;<i>
</I>&gt;<i> &gt;     # self.client is a Referenceable on the client side.
</I>&gt;<i> &gt;     defer = self.factory.login(credentials.UsernamePassword
</I>&gt;<i> &gt; (username, password), self.client)
</I>&gt;<i> &gt;     defer.addCallback(connected_callback, self)
</I>

I do the same thing.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> There's a lot of flexibility there. You could move the
</I>&gt;<i> clienttracker.append call right inside your Avatar constructor -- the
</I>&gt;<i> only reason I didn't is because my server supports a number of
</I>&gt;<i> protocols besides PB, and I wanted to deal with them universally.
</I>&gt;<i>
</I>&gt;<i> One thing this approach doesn't do is keep track of clients that
</I>&gt;<i> connect, but fail authentication. To do that, you'd need to subclass
</I>&gt;<i> Broker, but that's a tough one. I looked into this once before, and
</I>&gt;<i> it certainly appears doable -- in the end, a Broker is still a
</I>&gt;<i> Protocol, which means it has a transport property you can get client
</I>&gt;<i> addresses out of.
</I>

This is exactly what I need to do so I can associate a client with both
their username and ip address.  I have access to the broker if I subclass
PBServerFactory, but I am not sure how to access it from the Realm, or if it
is possible at all.

Any suggestions would be appreciated!

Thanks,
Yi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20061125/d59f9b6a/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="046908.html">[Twisted-Python] Keeping a list of connected PB clients
</A></li>
	<LI>Next message (by thread): <A HREF="046918.html">[Twisted-Python] Keeping a list of connected PB clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#46915">[ date ]</a>
              <a href="thread.html#46915">[ thread ]</a>
              <a href="subject.html#46915">[ subject ]</a>
              <a href="author.html#46915">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
