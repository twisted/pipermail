<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to get the Python socket object for an TLS	connection?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20get%20the%20Python%20socket%20object%20for%20an%20TLS%0A%09connection%3F&In-Reply-To=%3C50C8852A.8000605%40contact.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="058818.html">
   <LINK REL="Next"  HREF="058820.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to get the Python socket object for an TLS	connection?</H1>
    <B>Michael Schlenker</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20How%20to%20get%20the%20Python%20socket%20object%20for%20an%20TLS%0A%09connection%3F&In-Reply-To=%3C50C8852A.8000605%40contact.de%3E"
       TITLE="[Twisted-Python] How to get the Python socket object for an TLS	connection?">msc at contact.de
       </A><BR>
    <I>Wed Dec 12 06:22:50 MST 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="058818.html">[Twisted-Python] twisted logo use?
</A></li>
        <LI>Next message (by thread): <A HREF="058820.html">[Twisted-Python] How to get the Python socket object for an TLS connection?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58819">[ date ]</a>
              <a href="thread.html#58819">[ thread ]</a>
              <a href="subject.html#58819">[ subject ]</a>
              <a href="author.html#58819">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

i use twisted for some volume streaming over fat pipes (10 GE) and need
to tweak the rcv and send buffer sizes when streaming via
socket.setsockopt(). Otherwise Twisted spends lots of time calling the
producer with tiny blocksizes and writing those tiny buffers to the tiny
OS buffer. Speedup for streaming was around 40x when using a large
buffer instead of default block and buffer sizes, so this is really needed.

I'm using Twisted 12.2.

It works fine when using reactor.listenTCP(), but fails when using
reactor.listenSSL() because transport.getHandle() does not return a
socket object in that case (i get some SSL.Connection object instead).

I already saw the TLSMemoryBIOProtocol, so there should be some way to
get at the real socket object. Do i just need to skip the listenSSL()
step and use the steps outlined in
<A HREF="http://twistedmatrix.com/documents/12.2.0/api/twisted.protocols.tls.html">http://twistedmatrix.com/documents/12.2.0/api/twisted.protocols.tls.html</A> ?

import os
import socket
from twisted.internet import reactor
from twisted.web import server, http, resource
from twisted.internet.ssl import DefaultOpenSSLContextFactory

port = 2000
bufsize = 4*1024*1024

class HTTPChannel(http.HTTPChannel):
  def connectionMade(self):
      sock = self.transport.getHandle()
      # this fails, but works when using listenTCP()
      sock.setsockopt(socket.SOL_SOCKET, socket.SO_RCVBUF, bufsize)

def main():
    keyfile = os.path.join('certs', 'server-key.pem')
    certfile = os.path.join('certs', 'server.pem')
    ctx = DefaultOpenSSLContextFactory(keyfile, certfile)
    site = server.Site(resource.NoResource())
    site.protocol = HTTPChannel
    reactor.listenSSL(port, site, ctx)
    reactor.run()

Michael

-- 
Michael Schlenker
Software Architect

CONTACT Software GmbH           Tel.:   +49 (421) 20153-80
Wiener Straße 1-3               Fax:    +49 (421) 20153-41
28359 Bremen
<A HREF="http://www.contact.de/">http://www.contact.de/</A>          E-Mail: <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">msc at contact.de</A>

Sitz der Gesellschaft: Bremen
Geschäftsführer: Karl Heinz Zachries, Ralf Holtgrefe
Eingetragen im Handelsregister des Amtsgerichts Bremen unter HRB 13215


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="058818.html">[Twisted-Python] twisted logo use?
</A></li>
	<LI>Next message (by thread): <A HREF="058820.html">[Twisted-Python] How to get the Python socket object for an TLS connection?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#58819">[ date ]</a>
              <a href="thread.html#58819">[ thread ]</a>
              <a href="subject.html#58819">[ subject ]</a>
              <a href="author.html#58819">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
