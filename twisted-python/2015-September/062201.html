<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Converting str to bytes in Py3 port
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Converting%20str%20to%20bytes%20in%20Py3%20port&In-Reply-To=%3C04F5FB77-45F5-4721-ACEE-89C3F04E7035%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="029712.html">
   <LINK REL="Next"  HREF="029713.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Converting str to bytes in Py3 port</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Converting%20str%20to%20bytes%20in%20Py3%20port&In-Reply-To=%3C04F5FB77-45F5-4721-ACEE-89C3F04E7035%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Converting str to bytes in Py3 port">glyph at twistedmatrix.com
       </A><BR>
    <I>Tue Sep  8 01:44:17 MDT 2015</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="029712.html">[Twisted-Python] Converting str to bytes in Py3 port
</A></li>
        <LI>Next message (by thread): <A HREF="029713.html">[Twisted-Python] Auto-Re:  Converting str to bytes in Py3 port
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62201">[ date ]</a>
              <a href="thread.html#62201">[ thread ]</a>
              <a href="subject.html#62201">[ subject ]</a>
              <a href="author.html#62201">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Sep 2, 2015, at 3:38 AM, Adi Roiban &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">adi at roiban.ro</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> While reviewing the latest patch related to porting Twisted to py3 I
</I>&gt;<i> saw that many values which were supposed to hold just text were ported
</I>&gt;<i> as bytes.
</I>
This is fairly ambiguous, since it depends quite closely on what exact values they were.

&gt;<i> The argument for this conversion was that Twisted is a low level
</I>&gt;<i> framework and that other high level framworks like Treq or Klein
</I>&gt;<i> should implement the required code so that end user can just use text.
</I>
When high-level 

&gt;<i> For example the HTTP response messages are not bytes, even if the RFC
</I>&gt;<i> specified that they should only contain text with a single encoding.
</I>
By &quot;response messages&quot; do you mean

response headers (which are ASCII-punned bytes, or text with a restricted character set, depending on your philosophical disposition)
response bodies (which are unambiguously bytes, unless you interpret them according to their content-type, in which case they are arbitrary objects, one type of which may be text)
response status codes (which are sort of like headers, except not, except maybe they're integers)
response status text (which are arguably text, but do not feature an encoding, and are therefore in the same grey area as headers)

?

&gt;<i> I have little experience with twisted.web, so maybe there are many
</I>&gt;<i> users of twisted.web which use binary data for response messages or
</I>&gt;<i> maybe there is a good use case for putting random bytes in the HTTP
</I>&gt;<i> response message.
</I>
The main use-case is the Python zen, &quot;refuse the temptation to guess&quot;.  Treq and Klein can provide good default ways to interpret things, but some applications will need to get underneath those defaults and treat things differently.

&gt;<i> If for twisted.web there are Treq or Klein to implement the user
</I>&gt;<i> friendly interfaces, I don't know what can be used for twisted.conch
</I>
Clearly we need to write some new code.

&gt;<i> In the ticket for porting twisted.conch.ssh.key to py3 [1] the name of
</I>&gt;<i> the ssh key algorithms like 'ssh-rsa' or 'ssh-dsa', encryption
</I>&gt;<i> algorithm names like AES-128-CBC and ssh key components like p, q, y,
</I>&gt;<i> x, n, e are now all bytes.
</I>&gt;<i> 
</I>&gt;<i> Do you think that this is ok?
</I>
Yes, and here's why: those values are all enumerated constants.  They come off the wire as bytes, in no particular encoding (these happen to be ASCII, but is there a guarantee that all future algorithm names will also be?), and then they have to be treated specially.  A good, high-level API for this would use twisted.python.constants, and not bother application code with bytes or text.  Given that what is implemented is all pretty low-level, bytes make sense.

That said, if there were a good case for ASCII being the declared encoding and having some authoritative sense that that's what we should use, then we should use it.  Except that the 2.x types already use bytes, and so we'd have to either go with &quot;native str&quot; (which is a very problematic type, and should be avoided for everything except Python identifiers and docstrings, or things that need to be processed into them.)

&gt;<i> Why allow or encourage people to use random bytes for fields which
</I>&gt;<i> should contain human readable text?
</I>
If you encounter an entity that can read the string &quot;ssh-rsa&quot; and truly comprehend it, chances are good you are not dealing with a human.

&gt;<i> For HTTP response line and response headers I think that all values should be text and encoded in ISO-8859-1.
</I>
&gt;<i> RFC 4819 [2] only talks about using US-ASCII for all names used in the
</I>&gt;<i> SSH public key subsystem.
</I>&gt;<i> Why use bytes to represent these names?
</I>
You might be correct according to the specification (although it remains to be seen if you're right as far as implementations are concerned); however, why would it be useful to decode these values into bytes?  Should we be processing them as text?  In what context?

&gt;<i> RFC 4716 specifies that header tags must be US-ASCII while header
</I>&gt;<i> value UTF-8 ... while all IANA names are US-ASCII.... and names in the
</I>&gt;<i> private namespace (<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">name at domain</A>) should also be US-ASCII.
</I>
&gt;<i> As a reviewer I don't know that is the degin/architecture choose by
</I>&gt;<i> Twisted and how to review such changes.
</I>
It is not necessarily possible to rationalize every decision that has been made thus far as being part of one grand plan.  For one thing, many of them have been taken by different people.  For another, we learn things as we go along, and so some of the decisions made thus far are now recognized as mistakes.  So at this point I think it is best that you just state your preferred design and we discuss the pros and cons of that.

To the extent that there has been a conscious design strategy, it's something like this: every API needs one layer at which it needs to treat most of its data as bytes.  (Sadly) few Twisted APIs have nice, discrete higher layers with objects that represent meaningful user actions rather than protocol trivia.  So the existing strategy has been around making the lower levels consistently manipulate bytes everywhere, in the hope that we will promote these objects to more high-level types in a different layer later (hence the &quot;well, in klein and treq...&quot; answers).

&gt;<i> As a developer I prefer to have as much text as possible so that I can
</I>&gt;<i> do text manipulation operation on these values and directly include
</I>&gt;<i> them in logs or error messages.
</I>
OK, so the main utility of treating them as text is being able to concatenate them into diagnostic messages?  Can this not be done with bytes equally well?  This is the main thing to focus on, I think: concrete useful things you could do with text in these places where bytes are sub-optimal.

&gt;<i> I assume that all the people involved in writing the RFC had a good
</I>&gt;<i> reason to require those fields to be text rather than any bytes.
</I>&gt;<i> 
</I>&gt;<i> Thanks for your feedback!
</I>
Thank you for prompting this conversation, adi, we do need a better communicated strategy around how we handle text and encodings when protocols stipulate that the things they're dealing with are text.

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20150908/2fcb45f3/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="029712.html">[Twisted-Python] Converting str to bytes in Py3 port
</A></li>
	<LI>Next message (by thread): <A HREF="029713.html">[Twisted-Python] Auto-Re:  Converting str to bytes in Py3 port
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62201">[ date ]</a>
              <a href="thread.html#62201">[ thread ]</a>
              <a href="subject.html#62201">[ subject ]</a>
              <a href="author.html#62201">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
