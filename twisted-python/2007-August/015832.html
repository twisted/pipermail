<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Running twisted.trial unittests using nose
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Running%20twisted.trial%20unittests%20using%20nose&In-Reply-To=20070806141718.GL22324%40steerpike.home.puzzling.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015829.html">
   <LINK REL="Next"  HREF="015833.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Running twisted.trial unittests using nose</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Running%20twisted.trial%20unittests%20using%20nose&In-Reply-To=20070806141718.GL22324%40steerpike.home.puzzling.org"
       TITLE="[Twisted-Python] Running twisted.trial unittests using nose">glyph at divmod.com
       </A><BR>
    <I>Mon Aug  6 23:15:20 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015829.html">[Twisted-Python] Running twisted.trial unittests using nose
</A></li>
        <LI>Next message: <A HREF="015833.html">[Twisted-Python] Running twisted.trial unittests using nose
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15832">[ date ]</a>
              <a href="thread.html#15832">[ thread ]</a>
              <a href="subject.html#15832">[ subject ]</a>
              <a href="author.html#15832">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6 Aug, 02:17 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrew-twisted at puzzling.org</A> wrote:
&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A> wrote:
</I>&gt;<i>[...]
</I>&gt;&gt;<i>Twisted application does, and which is not _really_ supported by the
</I>&gt;&gt;<i>framework: re-start the reactor repeatedly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Eventually, 'trial' itself will not do this, and will behave as a
</I>&gt;&gt;<i>&quot;normal&quot; Twisted application.
</I>
Let's start with a point of agreement:
&gt;<i>The reactor can't be comprehensively unittested until multiple
</I>&gt;<i>reactors/restartable reactors are supported anyway, so it should be 
</I>&gt;<i>done.  This
</I>&gt;<i>would also make it possible to consider testing multiple different 
</I>&gt;<i>reactor
</I>&gt;<i>implementations in a single test run.
</I>
This is absolutely true.  The limiting factors on the code being used 
this way are simply (A) a lack of reasonable tests, and (B) some 
misguided micro-optimizations in the reactor which no longer help 
anyway.  There is nothing in anyone's preferred design for Trial, mine 
included, that would preclude such a thing.

Multiple reactors should, indeed must, eventually be supported.  It 
would be nice if someone who really wanted it would implement it though, 
instead of just talking about it ;).
&gt;<i>I don't think this is the right approach.  The right approach is to fix 
</I>&gt;<i>Twisted
</I>&gt;<i>to support multiple simultaneous reactors, so that your Twisted test 
</I>&gt;<i>runner that
</I>&gt;<i>wants to do stuff with a reactor is isolated from the tests, and vice 
</I>&gt;<i>versa.
</I>&gt;<i>The tests should then use a fresh reactor for each test.  It's simple 
</I>&gt;<i>and robust.
</I>
Your suggested implementation reinforces the antipattern of &quot;tests are 
special and need 'waitFor' or 'blockOn' because they can't be written 
otherwise&quot;.  Then, of course, newbies ask why the tests can have this 
but their protocol implementation (which really needs it, seriously, 
it's not like *any* other application using Twisted) can't.  Aside from 
the fact that it might actually work / be tested, it is the same (as far 
as I'm concerned) as much of the brokenness that Trial has dealt with 
for quite some time.

Much code within and without Twisted uses, and will continue for the 
forseeable future to use, &quot;from twisted.internet import reactor&quot; to 
access the reactor.  One might hope that this usage would eventually be 
replaced by something better, but it's not clear if this (or an 
equivalent spelling) could ever be *completely* eliminated.  I quite 
like Jim Fulton's suggestion for adding an ITransport.reactor attribute 
and using that in most places where the global import is currently used. 
However, even if we had a comprehensive somehow non-global way to get at 
a reactor available today, there would still be a *very* lengthy 
transition period to a new API.  The question will remain what to do 
about that code.

My main objection here, though, is that I'd really like to be able to 
add nifty Twisted-using features to Trial, and it's basically impossible 
right now, due in large part to the fact that the reactor keeps starting 
and stopping.  Creating a new reactor for each test is going to create 
confusing semantics for code written using established idioms, because 
either the framework is going to go to a lot of trouble to fool 
everything into using trial's idea of the reactor the tests should be 
using (which begs the question: how do you test trial itself, if it has 
a reference to the &quot;real&quot; reactor?), or it's going to require special 
hacks to get at the &quot;real&quot; reactor which still won't behave in an event- 
driven way if a test (shock, horror) actually does want to do some real 
I/O itself.  Although I am *personally* focusing on how to write better 
and more isolated unit tests using trial, I know of a small number of 
people using it as an integration testing tool that does tons of I/O to 
external systems and I think that is an interesting use-case and should 
be better supported, not worse.

Perhaps the 'trial' tool itself is a misguided design though, and 
'disttrial' will simply replace it in short order.  If this is the case, 
then the tests are running in a subprocess anyway, and there's no reason 
to run any code in-process with the tests, except for things to gather 
metrics.  In that case, the 'disttrial' tool itself is a real Twisted 
program, and the subprocess fakes just enough to get by:

<A HREF="http://twistedmatrix.com/trac/browser/branches/disttrial-1784/twisted/trial/dist/slavetrial.py#L60">http://twistedmatrix.com/trac/browser/branches/disttrial-1784/twisted/trial/dist/slavetrial.py#L60</A>

That *particular* hack makes me cringe, but I think the overall 
architecture may satisfy us both better in the end.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015829.html">[Twisted-Python] Running twisted.trial unittests using nose
</A></li>
	<LI>Next message: <A HREF="015833.html">[Twisted-Python] Running twisted.trial unittests using nose
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15832">[ date ]</a>
              <a href="thread.html#15832">[ thread ]</a>
              <a href="subject.html#15832">[ subject ]</a>
              <a href="author.html#15832">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
