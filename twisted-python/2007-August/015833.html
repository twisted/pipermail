<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Running twisted.trial unittests using nose
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Running%20twisted.trial%20unittests%20using%20nose&In-Reply-To=20070807031520.21185.1803443590.divmod.xquotient.348%40joule.divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015832.html">
   <LINK REL="Next"  HREF="015853.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Running twisted.trial unittests using nose</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Running%20twisted.trial%20unittests%20using%20nose&In-Reply-To=20070807031520.21185.1803443590.divmod.xquotient.348%40joule.divmod.com"
       TITLE="[Twisted-Python] Running twisted.trial unittests using nose">andrew-twisted at puzzling.org
       </A><BR>
    <I>Tue Aug  7 01:01:46 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015832.html">[Twisted-Python] Running twisted.trial unittests using nose
</A></li>
        <LI>Next message: <A HREF="015853.html">[Twisted-Python] Running twisted.trial unittests using nose
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15833">[ date ]</a>
              <a href="thread.html#15833">[ thread ]</a>
              <a href="subject.html#15833">[ subject ]</a>
              <a href="author.html#15833">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I get the feeling you misunderstand what I'm saying we should do.

<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at divmod.com</A> wrote:
&gt;<i> On 6 Aug, 02:17 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrew-twisted at puzzling.org</A> wrote:
</I>[...]
&gt;<i> &gt;I don't think this is the right approach.  The right approach is to fix 
</I>&gt;<i> &gt;Twisted
</I>&gt;<i> &gt;to support multiple simultaneous reactors, so that your Twisted test 
</I>&gt;<i> &gt;runner that
</I>&gt;<i> &gt;wants to do stuff with a reactor is isolated from the tests, and vice 
</I>&gt;<i> &gt;versa.
</I>&gt;<i> &gt;The tests should then use a fresh reactor for each test.  It's simple 
</I>&gt;<i> &gt;and robust.
</I>&gt;<i> 
</I>&gt;<i> Your suggested implementation reinforces the antipattern of &quot;tests are 
</I>&gt;<i> special and need 'waitFor' or 'blockOn' because they can't be written 
</I>&gt;<i> otherwise&quot;.  Then, of course, newbies ask why the tests can have this 
</I>
Not at all.  I never said that tests should be using techniques like
'waitFor'/'blockOn'.

I think the current API that test methods return Deferreds is just fine.  I am
not proposing that people writing tests should be starting and stopping reactors
(unless of course they are unit testing the starting and stopping of
reactors...).  I am proposing that TwistedTestCase.run should be doing this
internally.

&gt;<i> but their protocol implementation (which really needs it, seriously, 
</I>&gt;<i> it's not like *any* other application using Twisted) can't.  Aside from 
</I>&gt;<i> the fact that it might actually work / be tested, it is the same (as far 
</I>&gt;<i> as I'm concerned) as much of the brokenness that Trial has dealt with 
</I>&gt;<i> for quite some time.
</I>
I definitely am not suggesting that tests should be significantly different to
any other code.

(Incidentally, there are times when multiple reactors would be useful outside of
Trial.)

&gt;<i> Much code within and without Twisted uses, and will continue for the 
</I>&gt;<i> forseeable future to use, &quot;from twisted.internet import reactor&quot; to 
</I>&gt;<i> access the reactor.  One might hope that this usage would eventually be 
</I>&gt;<i> replaced by something better, but it's not clear if this (or an 
</I>&gt;<i> equivalent spelling) could ever be *completely* eliminated.  I quite 
</I>&gt;<i> like Jim Fulton's suggestion for adding an ITransport.reactor attribute 
</I>&gt;<i> and using that in most places where the global import is currently used. 
</I>&gt;<i> However, even if we had a comprehensive somehow non-global way to get at 
</I>&gt;<i> a reactor available today, there would still be a *very* lengthy 
</I>&gt;<i> transition period to a new API.  The question will remain what to do 
</I>&gt;<i> about that code.
</I>
Sure.  We will be living with the concept of a default global reactor for a long
time.

That doesn't mean it can't be made restartable.

&gt;<i> My main objection here, though, is that I'd really like to be able to 
</I>&gt;<i> add nifty Twisted-using features to Trial, and it's basically impossible 
</I>&gt;<i> right now, due in large part to the fact that the reactor keeps starting 
</I>&gt;<i> and stopping.  Creating a new reactor for each test is going to create 
</I>&gt;<i> confusing semantics for code written using established idioms, because 
</I>&gt;<i> either the framework is going to go to a lot of trouble to fool 
</I>&gt;<i> everything into using trial's idea of the reactor the tests should be 
</I>&gt;<i> using (which begs the question: how do you test trial itself, if it has 
</I>&gt;<i> a reference to the &quot;real&quot; reactor?), or it's going to require special 
</I>&gt;<i> hacks to get at the &quot;real&quot; reactor which still won't behave in an event- 
</I>&gt;<i> driven way if a test (shock, horror) actually does want to do some real 
</I>&gt;<i> I/O itself.  Although I am *personally* focusing on how to write better 
</I>&gt;<i> and more isolated unit tests using trial, I know of a small number of 
</I>&gt;<i> people using it as an integration testing tool that does tons of I/O to 
</I>&gt;<i> external systems and I think that is an interesting use-case and should 
</I>&gt;<i> be better supported, not worse.
</I>
I don't understand this.

Having a separate reactor for Trial and for the system-under-test (SUT) makes
Trial *more* testable.

Your point about &#8220;confusing semantics for code written using established idioms&#8221;
is just the inevitable result of supporting a default global reactor.  That's
not Trial's fault, it's Twisted's.  The way for Trial to cope with it gracefully
is to add support for multiple simultaneous reactors to Twisted, and then make
Trial use the non-global one for its own use, and let the tests keep using the
global one, so that legacy code will be unaffected.

I do not see how doing large amounts of I/O in test methods will be made any
worse by this design.

&gt;<i> Perhaps the 'trial' tool itself is a misguided design though, and 
</I>&gt;<i> 'disttrial' will simply replace it in short order.  If this is the case, 
</I>&gt;<i> then the tests are running in a subprocess anyway, and there's no reason 
</I>&gt;<i> to run any code in-process with the tests, except for things to gather 
</I>&gt;<i> metrics.  In that case, the 'disttrial' tool itself is a real Twisted 
</I>&gt;<i> program, and the subprocess fakes just enough to get by:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://twistedmatrix.com/trac/browser/branches/disttrial-1784/twisted/trial/dist/slavetrial.py#L60">http://twistedmatrix.com/trac/browser/branches/disttrial-1784/twisted/trial/dist/slavetrial.py#L60</A>
</I>&gt;<i> 
</I>&gt;<i> That *particular* hack makes me cringe, but I think the overall 
</I>&gt;<i> architecture may satisfy us both better in the end.
</I>
Right, it's a hack that gives us multiple reactors by putting Trial and the SUT
in separate processes, so that Trial and the SUT are using different reactors.
I'm saying that if we supported multiple reactors in the same process we could
and should use that feature to do the same thing: give Trial and the SUT
different reactors.

(Whether or not you share the same reactor instance between multiple tests is a
separate issue.  I think experience has taught us that doing that is fragile,
which is why I also advocate for a new reactor instance for each test, but
that's really an orthogonal issue.)

-Andrew.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015832.html">[Twisted-Python] Running twisted.trial unittests using nose
</A></li>
	<LI>Next message: <A HREF="015853.html">[Twisted-Python] Running twisted.trial unittests using nose
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15833">[ date ]</a>
              <a href="thread.html#15833">[ thread ]</a>
              <a href="subject.html#15833">[ subject ]</a>
              <a href="author.html#15833">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
