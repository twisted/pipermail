<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] protocol and transport question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20protocol%20and%20transport%20question&In-Reply-To=46CAC64A.6020600%40unipex.it">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015903.html">
   <LINK REL="Next"  HREF="015915.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] protocol and transport question</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20protocol%20and%20transport%20question&In-Reply-To=46CAC64A.6020600%40unipex.it"
       TITLE="[Twisted-Python] protocol and transport question">exarkun at divmod.com
       </A><BR>
    <I>Tue Aug 21 08:02:27 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015903.html">[Twisted-Python] protocol and transport question
</A></li>
        <LI>Next message: <A HREF="015915.html">[Twisted-Python] protocol and transport question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15905">[ date ]</a>
              <a href="thread.html#15905">[ thread ]</a>
              <a href="subject.html#15905">[ subject ]</a>
              <a href="author.html#15905">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 21 Aug 2007 13:02:34 +0200, Luca Politti &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">luca at unipex.it</A>&gt; wrote:
&gt;<i>Hi all,
</I>&gt;<i>I have a problem with a simple client/server communication: I have a
</I>&gt;<i>server that send the data through &quot;transport&quot; (my class inherit from
</I>&gt;<i>twisted.internet.protocol.Protocol), every 0.4 seconds. On the client
</I>&gt;<i>(that now, for test propose are on the same machine) some time I receive
</I>&gt;<i>two messages concatenated from the server like it send on the same time.
</I>&gt;<i>Other times, I receive it correctly (in different moments).
</I>
For message-oriented protocols (what you seem to be implementing), it
is necessary to have some &quot;framing&quot; mechanism - a way to tell where a
message ends and the next begins.  You can't rely on time to tell
messages apart over TCP, since TCP makes few guarantees about when it
will do things.

&gt;<i>I tried to debug this situations with print some messages, and I see
</I>&gt;<i>that twisted sometimes wait &quot;a time&quot; before send data through the
</I>&gt;<i>channel:
</I>
Bytes written to a TCP transport will be sent (almost) as soon as they
can be.  They are not (in the current implementation) sent before the
transport.write() call returns, but they will be sent the next time the
reactor regains execution control.  Unless your application is blocking
the reactor from running (ie, performing some long running task), this
means the reactor will try to send your data at most a few milliseconds
after your write call.  It is not necessarily the case that the send will
succeed at that time, though.  In such a case, the reactor will buffer
the data and try to send it again later.

&gt;<i>
</I>&gt;<i>on the server, on twisted.internet.tcp.Connection on writeSomeData I add:
</I>&gt;<i>print &quot;CCCCCCCCCCCCCCCCC&quot;, repr(data), time.time()
</I>&gt;<i>try:
</I>&gt;<i>     # Limit length of buffer to try to send, because some OSes are too
</I>&gt;<i>....
</I>&gt;<i>
</I>&gt;<i>on my code:
</I>&gt;<i>print &quot;BBBBBBBBBBBBBBBBBBB&quot;, repr(msg), time.time()
</I>&gt;<i>self.transport.write(str(msg))
</I>
writeSomeData and transport.write don't necessarily have a one-to-one
correspondence to each other, so this debug output might be a bit
misleading.

&gt;<i> [snip]
</I>&gt;<i>
</I>&gt;<i>How solve it? Is there a method for say to twisted (transport) to not
</I>&gt;<i>wait to send the data? (flush the buffer?)
</I>
Since there's no buffering except when absolutely necessary, there's no
way to flush.

So there are three things to watch out for:

  * You must use a framing mechanism in order to differentiate your
    messages.  This might be as simple as having them all be the same
    length, or it might mean including a length prefix (see the
    NetstringReceiver or Int{8,16,32}StringReceiver protocols in
    twisted.protocols.base for examples of this), or it might be
    something more complex.

  * Don't block the reactor.  If you want to wait a while, use the
    callLater method of the reactor, not time.sleep.  If you have
    to call a function that will block for a long time before it
    returns, find an asynchronous version instead, or use the reactor's
    threadpool.

  * Don't call reactor methods from any thread except the one which
    is running the reactor.  This will have unpredictable results and
    generally be broken.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015903.html">[Twisted-Python] protocol and transport question
</A></li>
	<LI>Next message: <A HREF="015915.html">[Twisted-Python] protocol and transport question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15905">[ date ]</a>
              <a href="thread.html#15905">[ thread ]</a>
              <a href="subject.html#15905">[ subject ]</a>
              <a href="author.html#15905">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
