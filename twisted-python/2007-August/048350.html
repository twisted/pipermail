<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] locking threads when deferToThread is used
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20locking%20threads%20when%20deferToThread%20is%20used&In-Reply-To=%3C20070808120457.4947.1236737990.divmod.quotient.20171%40ohm%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="048349.html">
   <LINK REL="Next"  HREF="048407.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] locking threads when deferToThread is used</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20locking%20threads%20when%20deferToThread%20is%20used&In-Reply-To=%3C20070808120457.4947.1236737990.divmod.quotient.20171%40ohm%3E"
       TITLE="[Twisted-Python] locking threads when deferToThread is used">exarkun at divmod.com
       </A><BR>
    <I>Wed Aug  8 06:04:57 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="048349.html">[Twisted-Python] locking threads when deferToThread is used
</A></li>
        <LI>Next message (by thread): <A HREF="048407.html">[Twisted-Python] Persistent SSH Class for Twisted needed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48350">[ date ]</a>
              <a href="thread.html#48350">[ thread ]</a>
              <a href="subject.html#48350">[ subject ]</a>
              <a href="author.html#48350">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 08 Aug 2007 13:11:09 +0200, Ladislav Andel &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ladaan at iptel.org</A>&gt; wrote:
&gt;<i>Jean-Paul Calderone wrote:
</I>&gt;&gt;<i>On Wed, 08 Aug 2007 09:56:16 +0200, Ladislav Andel &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ladaan at iptel.org</A>&gt; 
</I>&gt;&gt;<i>wrote:
</I>&gt;&gt;&gt;<i>Hi,
</I>&gt;&gt;&gt;<i>I'm writing an application which will be periodically testing servers.
</I>&gt;&gt;&gt;<i>I will have a global list of these servers(domain names) and need to do
</I>&gt;&gt;&gt;<i>few tasks.
</I>&gt;&gt;&gt;<i>1) DNS checks - I will use asynchronous twisted-names for it
</I>&gt;&gt;&gt;<i>- in case there is a difference comparing to the list it should update the 
</I>&gt;&gt;&gt;<i>list(then also in DB)
</I>&gt;&gt;&gt;<i>2) ICMP pings - should be also possible to do it asynchronously
</I>&gt;&gt;&gt;<i>3) Blocking function which will be pinging with SIP requests
</I>&gt;&gt;&gt;<i>- here I will use function deferToThread to make it non-blocking.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Questions:
</I>&gt;&gt;&gt;<i>1) How do I lock each thread when writing to a global list in twisted?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Don't.  Don't share state between different threads.  If you need to mutate
</I>&gt;&gt;<i>state as a result of code which has run in a thread, do it in the reactor
</I>&gt;&gt;<i>thread based on the result of the Deferred returned by deferToThread.
</I>&gt;<i>I'm aiming to use results of the Deffered returned by deferToThread.
</I>&gt;<i>Can you give me an example of combining two Deferred results?
</I>&gt;<i>This will be done through callbacks but what if the blocking application 
</I>&gt;<i>gives me result in 5 sec
</I>&gt;<i>and e.g. DNS check in 1 sec.
</I>
twisted.internet.defer.gatherResults takes a list of Deferreds and returns
a Deferred which fires with a list of results.  If you want to wait for both
results, you can use this.  If you only want the first result, whichever
that may be, then you just need to write a little class that acknowledges
the first Deferred's callback and disregards callbacks from any subsequent
Deferreds.

&gt;&gt;<i>Also, why do you need threads to send SIP messages?
</I>&gt;<i>I use third party application where I'm just handling parameters to the 
</I>&gt;<i>application.
</I>&gt;<i>I know it's possible to do it somehow easily via twisted but I don't have 
</I>&gt;<i>time to explore it now.
</I>&gt;<i>I'm also quite new to python and also to twisted so that's why I don't want 
</I>&gt;<i>to get involved in something more
</I>&gt;<i>complex for now.
</I>
Alright.

&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>2) How will I put together all three results mentioned above in the global 
</I>&gt;&gt;&gt;<i>list
</I>&gt;&gt;&gt;<i>- is it by using function callLater ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Don't use globals.  You can just put your state variables on an instance of
</I>&gt;&gt;<i>a class.  There's nothing unique to Twisted about this.  I'm not sure how
</I>&gt;&gt;<i>callLater would be involved.  callLater is for scheduling functions to run
</I>&gt;&gt;<i>based on timing events.
</I>&gt;<i>Can you give me a little example?
</I>
I'm not really sure what you have in mind, but maybe an approach along these
lines would be useful:

class PingTracker:
    def __init__(self):
        self.dns = None
        self.sip = None
        self.ping = None

    def check(self, host):
        checks = []
        checks.append(checkDNS().addCallback(self.setDNSResult))
        checks.append(checkSIP().addCallback(self.setSIPResult))
        checks.append(checkPing().addCallback(self.setPingResult))
        return gatherResults(checks)

    def setDNSResult(self, result):
        self.dns = result

    ...

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="048349.html">[Twisted-Python] locking threads when deferToThread is used
</A></li>
	<LI>Next message (by thread): <A HREF="048407.html">[Twisted-Python] Persistent SSH Class for Twisted needed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48350">[ date ]</a>
              <a href="thread.html#48350">[ thread ]</a>
              <a href="subject.html#48350">[ subject ]</a>
              <a href="author.html#48350">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
