<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Where to start: log reader/analysis
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Where%20to%20start%3A%20log%20reader/analysis&In-Reply-To=8b93c05a0708060157j2ffa75c1u170aecaea5a36f6c%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015819.html">
   <LINK REL="Next"  HREF="015868.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Where to start: log reader/analysis</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Where%20to%20start%3A%20log%20reader/analysis&In-Reply-To=8b93c05a0708060157j2ffa75c1u170aecaea5a36f6c%40mail.gmail.com"
       TITLE="[Twisted-Python] Where to start: log reader/analysis">exarkun at divmod.com
       </A><BR>
    <I>Mon Aug  6 07:49:53 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015819.html">[Twisted-Python] Where to start: log reader/analysis
</A></li>
        <LI>Next message: <A HREF="015868.html">[Twisted-Python] Where to start: log reader/analysis
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15822">[ date ]</a>
              <a href="thread.html#15822">[ thread ]</a>
              <a href="subject.html#15822">[ subject ]</a>
              <a href="author.html#15822">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 6 Aug 2007 10:57:19 +0200, Yoann Aubineau &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">yoann.aubineau at wengo.com</A>&gt; wrote:
&gt;<i>Hi Andrew,
</I>&gt;<i>
</I>&gt;<i>I wrote a class that follows a file (eg. log file) and provides an iterator
</I>&gt;<i>to walk through it. Don't know if it may be of any use for you (or others).
</I>
Hi Yoann, thanks for sharing.

&gt;<i>
</I>&gt;<i>class FileFollower(object):
</I>&gt;<i>    &quot;&quot;&quot;Iterate through a file while it is updated.
</I>&gt;<i>
</I>&gt;<i>    &gt;&gt;&gt; file = FileFollower(&quot;/tmp/testfile&quot;)
</I>&gt;<i>    &gt;&gt;&gt; file.interval = 5
</I>&gt;<i>    &gt;&gt;&gt; for line in file:
</I>&gt;<i>    ...     print line
</I>&gt;<i>    &quot;&quot;&quot;
</I>&gt;<i>
</I>&gt;<i>    interval = 1
</I>&gt;<i>
</I>&gt;<i>    def __init__(self, filename, interval=None):
</I>&gt;<i>        self.filename = filename
</I>&gt;<i>        self.interval = interval or self.interval
</I>&gt;<i>        self.stat = None
</I>&gt;<i>        self.offset = 0
</I>&gt;<i>        self.lines = []
</I>&gt;<i>        self.running = True
</I>&gt;<i>
</I>&gt;<i>    #
</I>&gt;<i>    # File following
</I>&gt;<i>
</I>&gt;<i>    def follow(self):
</I>&gt;<i>        while self.running:
</I>&gt;<i>            if self.hasChanged():
</I>&gt;<i>                data = self.readChange()
</I>&gt;<i>                if data:
</I>&gt;<i>                    self.dataReceived(data)
</I>&gt;<i>                    break
</I>&gt;<i>            time.sleep(self.interval)
</I>&gt;<i>
</I>&gt;<i>    def hasChanged(self):
</I>&gt;<i>        stat = os.stat(self.filename)
</I>&gt;<i>        if stat != self.stat:
</I>&gt;<i>            self.stat = stat
</I>&gt;<i>            return True
</I>&gt;<i>        return False
</I>&gt;<i>
</I>&gt;<i>    def readChange(self):
</I>&gt;<i>        file = open(self.filename)
</I>&gt;<i>        file.seek(self.offset)
</I>&gt;<i>        data = file.read()
</I>&gt;<i>        self.offset = file.tell()
</I>&gt;<i>        file.close()
</I>&gt;<i>        return data
</I>&gt;<i>
</I>&gt;<i>    #
</I>&gt;<i>    # Data buffering
</I>&gt;<i>
</I>&gt;<i>    def dataReceived(self, data):
</I>&gt;<i>        lines = data.split(os.linesep)
</I>&gt;<i>        lines = lines[:-1]
</I>&gt;<i>        for line in lines:
</I>&gt;<i>            self.lineReceived(line)
</I>&gt;<i>
</I>&gt;<i>    def lineReceived(self, line):
</I>&gt;<i>        self.lines.append(line)
</I>&gt;<i>
</I>&gt;<i>    #
</I>&gt;<i>    # Iterator implementation
</I>&gt;<i>
</I>&gt;<i>    def __iter__(self):
</I>&gt;<i>        return self
</I>&gt;<i>
</I>&gt;<i>    def next(self):
</I>&gt;<i>        if not self.lines:
</I>&gt;<i>            self.follow()
</I>&gt;<i>        line = self.lines.pop(0)
</I>&gt;<i>        return line
</I>&gt;<i>
</I>
In order to make this class more usable within a Twisted application, I'd
make a few suggestions:

Separate the transport from the protocol.  All of the methods in the area
commented &quot;file following&quot; are basically transport methods: they know how
to get the underlying bytes (by polling and eventually reading).  The
protocol implementation is basically the dataReceived and lineReceived
methods.  With separation between the transport and the protocol, you
don't even need to implement these, since you can just use LineReceiver
from twisted.protocols.basic.

Do the polling in a cooperative way.  Using an infinite for loop and a
time.sleep call has the consequence of tying up an entire thread.  This
means nothing else can happen unless you run the follow method of this
class in a new, dedicated thread.  If you use the reactor to schedule
the checks instead, then this can be used alongside other Twisted code
without having to deal with threading.  twisted.internet.task.LoopingCall
might be of particular interest.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015819.html">[Twisted-Python] Where to start: log reader/analysis
</A></li>
	<LI>Next message: <A HREF="015868.html">[Twisted-Python] Where to start: log reader/analysis
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15822">[ date ]</a>
              <a href="thread.html#15822">[ thread ]</a>
              <a href="subject.html#15822">[ subject ]</a>
              <a href="author.html#15822">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
