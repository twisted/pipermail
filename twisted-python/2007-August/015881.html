<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] again deferToThreads
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20again%20deferToThreads&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015877.html">
   <LINK REL="Next"  HREF="015882.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] again deferToThreads</H1>
    <B>Ladislav Andel</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20again%20deferToThreads&In-Reply-To="
       TITLE="[Twisted-Python] again deferToThreads">ladaan at iptel.org
       </A><BR>
    <I>Thu Aug 16 08:52:49 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015877.html">[Twisted-Python] Cookies in Client?
</A></li>
        <LI>Next message: <A HREF="015882.html">[Twisted-Python] scheduling timers with long intervals
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15881">[ date ]</a>
              <a href="thread.html#15881">[ thread ]</a>
              <a href="subject.html#15881">[ subject ]</a>
              <a href="author.html#15881">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,
I have a two functions which I run in one thread called via deferToThread.
There is function called siptest_f and function pingNode test.
siptest_f returns a dictionary and pingNode returns the average time out 
of 3 received packets.
Below is code I use. I run it through reactor event loop which is not 
shown here.
My problem is that the function on its own returns correct results but 
if use it within following code
I get always different results and mostly wrong.
There should probably be some way of locking but I'm not sure how to do 
it correctly.
If you have any other suggestions, there are welcomed.

Lada

------------------------------------------------------------------------

def serverTest(dns_res, index):
    &quot;&quot;&quot; Function for SIP testing &quot;&quot;&quot;
   
    from twisted.internet import threads
    from siptest import siptest_f
    from icmp_ping2 import pingNode
#    import thread
   
   
    print &quot;here will be siptest for &quot;, dns_res
    #stdoutmutex = thread.allocate_lock()

    def test(dns_res, test_opts):
        if dns_res:
            icmpres =  pingNode(alive=0, timeout=1.0, ipv6=0, number=3, 
node=dns_res, flood=0, size=56)
            sipres = siptest_f(dns_res, test_opts)
       
           # stdoutmutex.acquire()  
            sipres['ICMP'] = icmpres
           # stdoutmutex.release()
           
            return sipres
        raise ValueError(&quot;Error occured&quot;)   
   
    def sipResult(d):

        print d
        #return d

    def printError(failure):
        print failure

    sd = threads.deferToThread(test, dns_res, test_opts)

    sd.addCallback(sipResult)
    sd.addErrback(printError)



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015877.html">[Twisted-Python] Cookies in Client?
</A></li>
	<LI>Next message: <A HREF="015882.html">[Twisted-Python] scheduling timers with long intervals
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15881">[ date ]</a>
              <a href="thread.html#15881">[ thread ]</a>
              <a href="subject.html#15881">[ subject ]</a>
              <a href="author.html#15881">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
