<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Reactor takes a long time to shutdown
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Reactor%20takes%20a%20long%20time%20to%20shutdown&In-Reply-To=46D0182E.7060106%40the-moon.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015923.html">
   <LINK REL="Next"  HREF="015940.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Reactor takes a long time to shutdown</H1>
    <B>Chris Miles</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Reactor%20takes%20a%20long%20time%20to%20shutdown&In-Reply-To=46D0182E.7060106%40the-moon.net"
       TITLE="[Twisted-Python] Reactor takes a long time to shutdown">miles.chris at gmail.com
       </A><BR>
    <I>Mon Aug 27 17:33:30 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="015923.html">[Twisted-Python] Reactor takes a long time to shutdown
</A></li>
        <LI>Next message: <A HREF="015940.html">[Twisted-Python] Reactor takes a long time to shutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15937">[ date ]</a>
              <a href="thread.html#15937">[ thread ]</a>
              <a href="subject.html#15937">[ subject ]</a>
              <a href="author.html#15937">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Richard,

I tried your code and it works fine for me.  The script always exits  
right away after scanning all ports.  I tried various hosts and  
various port ranges.

I'm running Python 2.4.4, Twisted 2.5.0, on OS X.

btw: I would warn against port scanning public sites such as google;  
you don't want to trip an IDS and cop the wrath of a network admin.

Hope this helps.

Cya at PyConUK.

Cheers,
Chris

On 25 Aug 2007, at 12:53, Richard Wall wrote:

&gt;<i> I'm giving a talk &quot;An introduction to Twisted&quot; at PyconUK and am  
</I>&gt;<i> trying to come up with some simple examples.
</I>&gt;<i>
</I>&gt;<i> One of these, is the attached PortCheck module, that is supposed to  
</I>&gt;<i> attempt connection to a range of ports and report whether they're  
</I>&gt;<i> open, closed, filtered (timeout).
</I>&gt;<i>
</I>&gt;<i> It works okay when run against localhost, or another machine on my  
</I>&gt;<i> local network, but I've noticed that when I run it against an  
</I>&gt;<i> internet host, the reactor takes ages to shutdown after scanning  
</I>&gt;<i> all the ports. I wondered if there was anything obviously wrong  
</I>&gt;<i> with the code.
</I>&gt;<i>
</I>&gt;<i> Run it as follows from bash: python portcheck.py www.google.co.uk  
</I>&gt;<i> {1..1000}
</I>&gt;<i>
</I>&gt;<i> Thanks in advance for any suggestions.
</I>&gt;<i>
</I>&gt;<i> -RichardW.
</I>&gt;<i> &quot;&quot;&quot;
</I>&gt;<i> A module to demonstrate some of the simplest twisted client code  
</I>&gt;<i> possible
</I>&gt;<i> @author: Richard Wall &lt;richard (at) the-moon.net&gt;
</I>&gt;<i> &quot;&quot;&quot;
</I>&gt;<i> import sys
</I>&gt;<i>
</I>&gt;<i> from twisted.internet import reactor
</I>&gt;<i> from twisted.internet.defer import DeferredList
</I>&gt;<i> from twisted.internet.task import Cooperator
</I>&gt;<i> from twisted.internet.protocol import ClientCreator, Protocol
</I>&gt;<i> from twisted.internet.error import ConnectionRefusedError,  
</I>&gt;<i> TimeoutError
</I>&gt;<i>
</I>&gt;<i> STATUS_OPEN = &quot;open&quot;
</I>&gt;<i> STATUS_CLOSED = &quot;closed&quot;
</I>&gt;<i> STATUS_TIMEOUT = &quot;timeout&quot;
</I>&gt;<i>
</I>&gt;<i> MAX_SIMULTANEOUS_CONNECTIONS = 100
</I>&gt;<i>
</I>&gt;<i> def getPortStatus(host, port, timeout=1):
</I>&gt;<i>     &quot;&quot;&quot;
</I>&gt;<i>     Return a deferred that is called back with one of: open,  
</I>&gt;<i> closed, timeout
</I>&gt;<i>     @param host: The hostname or IP with which to attempt a connection
</I>&gt;<i>     @param port: The port to connect
</I>&gt;<i>     @param timeout: Number of seconds to wait for connection before  
</I>&gt;<i> giving up
</I>&gt;<i>     @return: A deferred which will call back with one of
</I>&gt;<i>              STATUS_{OPEN,CLOSED,TIMEOUT}
</I>&gt;<i>     &quot;&quot;&quot;
</I>&gt;<i>
</I>&gt;<i>     cli = ClientCreator(reactor, Protocol)
</I>&gt;<i>
</I>&gt;<i>     d = cli.connectTCP(host, port, timeout=timeout)
</I>&gt;<i>
</I>&gt;<i>     def cb(proto):
</I>&gt;<i>         proto.transport.loseConnection()
</I>&gt;<i>         return STATUS_OPEN
</I>&gt;<i>
</I>&gt;<i>     def eb(err):
</I>&gt;<i>         expectedErrors = {
</I>&gt;<i>             ConnectionRefusedError: STATUS_CLOSED,
</I>&gt;<i>             TimeoutError: STATUS_TIMEOUT
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         e = err.trap(*expectedErrors.keys())
</I>&gt;<i>         if e:
</I>&gt;<i>             return expectedErrors[e]
</I>&gt;<i>
</I>&gt;<i>     d.addCallbacks(cb, eb)
</I>&gt;<i>
</I>&gt;<i>     return d
</I>&gt;<i>
</I>&gt;<i> def main(argv):
</I>&gt;<i>     &quot;&quot;&quot;
</I>&gt;<i>     Command line access to the getPortStatus function. Pass me a  
</I>&gt;<i> hostname and
</I>&gt;<i>     one or more ports and I will report their status.
</I>&gt;<i>     &quot;&quot;&quot;
</I>&gt;<i>     host = argv[1]
</I>&gt;<i>     ports = map(int, argv[2:])
</I>&gt;<i>
</I>&gt;<i>     def cb(status, host, port):
</I>&gt;<i>          sys.stdout.write(&quot;%s:%d %s\n&quot;%(host,port,status))
</I>&gt;<i>
</I>&gt;<i>     def eb(err):
</I>&gt;<i>         sys.stderr.write(&quot;%s\n&quot; % err.value)
</I>&gt;<i>
</I>&gt;<i>     def portStatusGenerator(host, ports):
</I>&gt;<i>         for p in ports:
</I>&gt;<i>             d = getPortStatus(host, p)
</I>&gt;<i>             d.addCallbacks(cb, eb, (host, p))
</I>&gt;<i>             yield d
</I>&gt;<i>
</I>&gt;<i>     # Limit parallelism otherwise we run out of file descriptors
</I>&gt;<i>     # See <A HREF="http://jcalderone.livejournal.com/24285.html">http://jcalderone.livejournal.com/24285.html</A>
</I>&gt;<i>     work = portStatusGenerator(host, ports)
</I>&gt;<i>     coop = Cooperator()
</I>&gt;<i>     d = DeferredList(
</I>&gt;<i>             [coop.coiterate(work) for i in xrange 
</I>&gt;<i> (MAX_SIMULTANEOUS_CONNECTIONS)])
</I>&gt;<i>
</I>&gt;<i>     d.addCallback(lambda ign: reactor.stop())
</I>&gt;<i>     reactor.run()
</I>&gt;<i>
</I>&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;<i>     sys.exit(main(sys.argv))
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20070827/b4838d1e/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20070827/b4838d1e/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015923.html">[Twisted-Python] Reactor takes a long time to shutdown
</A></li>
	<LI>Next message: <A HREF="015940.html">[Twisted-Python] Reactor takes a long time to shutdown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15937">[ date ]</a>
              <a href="thread.html#15937">[ thread ]</a>
              <a href="subject.html#15937">[ subject ]</a>
              <a href="author.html#15937">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
