<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] SSL: Getting the client certificate
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SSL%3A%20Getting%20the%20client%20certificate&In-Reply-To=%3C46D1C5E4.3080207%40dirk-loss.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="048448.html">
   <LINK REL="Next"  HREF="048434.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] SSL: Getting the client certificate</H1>
    <B>Dirk Loss</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20SSL%3A%20Getting%20the%20client%20certificate&In-Reply-To=%3C46D1C5E4.3080207%40dirk-loss.de%3E"
       TITLE="[Twisted-Python] SSL: Getting the client certificate">lists at dirk-loss.de
       </A><BR>
    <I>Sun Aug 26 12:26:44 MDT 2007</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="048448.html">[Twisted-Python] Reactor takes a long time to shutdown
</A></li>
        <LI>Next message (by thread): <A HREF="048434.html">[Twisted-Python] SSL: Getting the client certificate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48433">[ date ]</a>
              <a href="thread.html#48433">[ thread ]</a>
              <a href="subject.html#48433">[ subject ]</a>
              <a href="author.html#48433">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

following Eli Criffields nice example [1] I implemented a small SSL
server with Twisted. My server should not only verify the client
certificate, but also check the Common Name (CN) against a whitelist.
All this should happen before any user data is exchanged.

Verifying the client certificate worked nicely, but I couldn't access
its contents: transport.getPeerCertificate() always returned 'None'.
Apparently Eli had the same problem [2].

After some testing with PyOpenSSL now I think I have found a solution:

Before we can get the client certificate, we have to make sure that the
SSL handshake has taken place. (If it hasn't, there simply is no client
certificate to deal with yet.) This can be done by calling the
do_handshake() method of the underlying socket. The SSL handshake takes
some time so we will have to try several times.

Here's an (incomplete) example showing the interesting part:
- - cut ---
import OpenSSL

class MyProtocol(Protocol):

     def connectionMade(self):

         # Make sure that SSL handshake has taken place
         while True:
             try:
                 self.transport.socket.do_handshake()
                 break
             except OpenSSL.SSL.WantReadError:
                 pass

         clientCert = self.transport.getPeerCertificate()
         if clientCert is None:
             log.msg(&quot;No client cert available.&quot;)
         else:
             subject = clientCert.get_subject()
             log.msg(&quot;Subject: %s&quot; % subject)
             log.msg(&quot;Common Name: %s&quot; % subject.CN)
- - cut ---

If you see a nicer way to wait for the SSL handshake please let me
know. Using time.sleep() didn't work for me.

Side note:
Getting the certificate in a dataReceived() instead of connectionMade()
works without manually doing the handshake. I think this is because the
underlying PyOpenSSL recv() method handles the handshake for us. But at
least for my purpose it makes more sense to verify the client cert
right upon connection, before any user data is exchanged.

Regards,
Dirk

[1] <A HREF="http://archives.free.net.ph/message/20070511.203607.36001e38.en.html">http://archives.free.net.ph/message/20070511.203607.36001e38.en.html</A>
[2] <A HREF="http://archives.free.net.ph/message/20070607.211438.9354342f.en.html">http://archives.free.net.ph/message/20070607.211438.9354342f.en.html</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="048448.html">[Twisted-Python] Reactor takes a long time to shutdown
</A></li>
	<LI>Next message (by thread): <A HREF="048434.html">[Twisted-Python] SSL: Getting the client certificate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#48433">[ date ]</a>
              <a href="thread.html#48433">[ thread ]</a>
              <a href="subject.html#48433">[ subject ]</a>
              <a href="author.html#48433">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
