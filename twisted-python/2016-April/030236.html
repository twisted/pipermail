<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Problem with Deferreds
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Problem%20with%20Deferreds&In-Reply-To=%3CCAKF%3D%2BdhozabFY7ZbtM%2BKK2t%3DL%2BAGJz9jDk3y-BR%3DwQ8yQiPq6A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="030235.html">
   <LINK REL="Next"  HREF="030237.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Problem with Deferreds</H1>
    <B>Kevin Conway</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Problem%20with%20Deferreds&In-Reply-To=%3CCAKF%3D%2BdhozabFY7ZbtM%2BKK2t%3DL%2BAGJz9jDk3y-BR%3DwQ8yQiPq6A%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Problem with Deferreds">kevinjacobconway at gmail.com
       </A><BR>
    <I>Sat Apr  2 08:00:12 MDT 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="030235.html">[Twisted-Python] Problem with Deferreds
</A></li>
        <LI>Next message: <A HREF="030237.html">[Twisted-Python] Problem with Deferreds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30236">[ date ]</a>
              <a href="thread.html#30236">[ thread ]</a>
              <a href="subject.html#30236">[ subject ]</a>
              <a href="author.html#30236">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Chris,

tl;dr: Returning a value from 'dataReceived', or any of its extensions such
as 'lineReceived' in the 'LineReceiver' Protocol subclass, triggers a
disconnect and uses the returned value as the 'reason'. A 'reason' must be
an Exception or t.p.Failure object as other values will trigger this error.

Are you quite certain that your last line is not getting printed? I'm not
sure exactly where this feature is documented, but returning any non-None
value from a Protocol's 'dataReceived' method can result in this behaviour.
The t.protocols.basic.LineReceiver calls 'lineReceived' from 'dataReceived'
and returns any value it gets from your implementation. The value returned
from 'dataReceived' is passed along to the transport's 'doRead' which,
again, returns it to the portion of the reactor handling selectables. The
reactor assumes that anything returned from a transport during a read or
write operation is a bad thing and disconnects the transport. During the
disconnect process the reactor is generating a t.p.failure.Failure object
and passing in your returned value as the 'why' which is expected to be an
Exception or Failure and not a Deferred. Try returning None instead of your
Deferred. That should resolve this particular issue.

On Sat, Apr 2, 2016 at 4:39 AM Chris Norman &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris.norman2 at googlemail.com</A>&gt;
wrote:

&gt;<i> Hi all,
</I>&gt;<i> I recently got over myself and forced myself to read about Deferreds
</I>&gt;<i> rather than using threading opperations.
</I>&gt;<i>
</I>&gt;<i> I've used them successfully in a couple of places, but this one has me
</I>&gt;<i> flummoxed:
</I>&gt;<i>
</I>&gt;<i> Here's the code for the Deferred and it's sub-commands:
</I>&gt;<i>
</I>&gt;<i>   def do_command(self, cmd, **kwargs):
</I>&gt;<i>    &quot;&quot;&quot;Process a command in true Deferred style.&quot;&quot;&quot;
</I>&gt;<i>    if cmd.permissions(self.connection):
</I>&gt;<i>     cmd(self.connection, **kwargs)
</I>&gt;<i>    else:
</I>&gt;<i>     logger.warning('Blocked from running command %s which is secured
</I>&gt;<i> with %s.', cmd.__name__, cmd.permissions.__name__)
</I>&gt;<i>     raise CommandError('You have insufficient privileges to perform this
</I>&gt;<i> action. The staff have been notified.')
</I>&gt;<i>
</I>&gt;<i>   def handle_error(self, err):
</I>&gt;<i>    &quot;&quot;&quot;Handle an error from do_command.&quot;&quot;&quot;
</I>&gt;<i>    if isinstance(err, CommandError):
</I>&gt;<i>     return self.send_error(e.message, disconnect = e.disconnect)
</I>&gt;<i>    else:
</I>&gt;<i>     self.log(e, level = 'exception')
</I>&gt;<i>     self.send_error('Sorry, but a problem with the server means your
</I>&gt;<i> command was not executed. The staff have been notified.')
</I>&gt;<i>
</I>&gt;<i>   def lineReceived(self, line):
</I>&gt;<i>    &quot;&quot;&quot;Parse an incoming command.&quot;&quot;&quot;
</I>&gt;<i>    global lines
</I>&gt;<i>    lines += 1 # Increment the line count.
</I>&gt;<i>    data = line.decode(settings.ENCODING)
</I>&gt;<i>    try:
</I>&gt;<i>     command, kwargs = json.loads(data)
</I>&gt;<i>     if not isinstance(command, string_types) or not isinstance(kwargs,
</I>&gt;<i> dict):
</I>&gt;<i>      raise TypeError('Expecting [str, dict]. Got [%s, %s] instead.' %
</I>&gt;<i> (type(command), type(kwargs)))
</I>&gt;<i>    except (TypeError, ValueError) as e:
</I>&gt;<i>     self.log('Invalid command string: %s', data, level = 'error')
</I>&gt;<i>     self.log(e, level = 'exception')
</I>&gt;<i>     return self.send_error('Invalid command.', disconnect = True)
</I>&gt;<i>    cmd = commands.commands.get(command, None)
</I>&gt;<i>    if cmd  is None:
</I>&gt;<i>     self.log('Unrecognised command: %s.', command, level = 'warning')
</I>&gt;<i>    elif self.connection.player or not cmd.login_required:
</I>&gt;<i>     d = defer.Deferred()
</I>&gt;<i>     print('Adding callback.')
</I>&gt;<i>     d.addCallback(self.do_command, **kwargs)
</I>&gt;<i>     print('Adding errback.')
</I>&gt;<i>     d.addErrback(self.handle_error)
</I>&gt;<i>     print('Calling callback.')
</I>&gt;<i>     d.callback(cmd)
</I>&gt;<i>     print('Called.') # Never gets this far.
</I>&gt;<i>     return d
</I>&gt;<i>    else:
</I>&gt;<i>     return self.send_error('Not authenticated.', disconnect = True)
</I>&gt;<i>
</I>&gt;<i> Here's the traceback I get when the callback gets called:
</I>&gt;<i>
</I>&gt;<i> Unhandled Error
</I>&gt;<i> Traceback (most recent call last):
</I>&gt;<i>    File &quot;server/functions.py&quot;, line 88, in server_start
</I>&gt;<i>      reactor.run()
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/internet/base.py&quot;,
</I>&gt;<i> line 1194, in run
</I>&gt;<i>      self.mainLoop()
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/internet/base.py&quot;,
</I>&gt;<i> line 1206, in mainLoop
</I>&gt;<i>      self.doIteration(t)
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/internet/epollreactor.py&quot;,
</I>&gt;<i> line 396, in doPoll
</I>&gt;<i>      log.callWithLogger(selectable, _drdw, selectable, fd, event)
</I>&gt;<i> --- &lt;exception caught here&gt; ---
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/python/log.py&quot;,
</I>&gt;<i> line 101, in callWithLogger
</I>&gt;<i>      return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/python/log.py&quot;,
</I>&gt;<i> line 84, in callWithContext
</I>&gt;<i>      return context.call({ILogContext: newCtx}, func, *args, **kw)
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/python/context.py&quot;,
</I>&gt;<i> line 118, in callWithContext
</I>&gt;<i>      return self.currentContext().callWithContext(ctx, func, *args, **kw)
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/python/context.py&quot;,
</I>&gt;<i> line 81, in callWithContext
</I>&gt;<i>      return func(*args,**kw)
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/internet/posixbase.py&quot;,
</I>&gt;<i> line 610, in _doReadOrWrite
</I>&gt;<i>      self._disconnectSelectable(selectable, why, inRead)
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/internet/posixbase.py&quot;,
</I>&gt;<i> line 258, in _disconnectSelectable
</I>&gt;<i>      selectable.connectionLost(failure.Failure(why))
</I>&gt;<i>    File
</I>&gt;<i>
</I>&gt;<i> &quot;/usr/local/lib/python3.5/site-packages/Twisted-16.0.0-py3.5.egg/twisted/python/failure.py&quot;,
</I>&gt;<i> line 232, in __init__
</I>&gt;<i>      tb = self.value.__traceback__
</I>&gt;<i> builtins.AttributeError: 'Deferred' object has no attribute '__traceback__'
</I>&gt;<i>
</I>&gt;<i> Anyone have any ideas?
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i>
</I>&gt;<i> Chris
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20160402/8e939840/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20160402/8e939840/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="030235.html">[Twisted-Python] Problem with Deferreds
</A></li>
	<LI>Next message: <A HREF="030237.html">[Twisted-Python] Problem with Deferreds
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#30236">[ date ]</a>
              <a href="thread.html#30236">[ thread ]</a>
              <a href="subject.html#30236">[ subject ]</a>
              <a href="author.html#30236">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
