<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] web.client.readBody
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20web.client.readBody&In-Reply-To=%3C71304C75-EB29-48B6-9F16-5BC1B0F13BC6%40lukasa.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="062703.html">
   <LINK REL="Next"  HREF="062707.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] web.client.readBody</H1>
    <B>Cory Benfield</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20web.client.readBody&In-Reply-To=%3C71304C75-EB29-48B6-9F16-5BC1B0F13BC6%40lukasa.co.uk%3E"
       TITLE="[Twisted-Python] web.client.readBody">cory at lukasa.co.uk
       </A><BR>
    <I>Mon Apr  4 02:03:24 MDT 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="062703.html">[Twisted-Python] web.client.readbody
</A></li>
        <LI>Next message (by thread): <A HREF="062707.html">[Twisted-Python] web.client.readbody
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62706">[ date ]</a>
              <a href="thread.html#62706">[ thread ]</a>
              <a href="subject.html#62706">[ subject ]</a>
              <a href="author.html#62706">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On 3 Apr 2016, at 14:35, John Aherne &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">johnaherne at rocs.co.uk</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> I have been using deliverBody to process in responses but decided that readBody might be a better fit.
</I>&gt;<i> 
</I>&gt;<i> So far it works with http, but as soon as I switch to https it fails.
</I>&gt;<i> 
</I>&gt;<i> I get a response http code 200 OK but no data.
</I>&gt;<i> 
</I>&gt;<i> I've puzzled over this but can't see what the problem is.
</I>&gt;<i> 
</I>&gt;<i> Has anyone else seen this problem and found out what the solution is.
</I>&gt;<i> 
</I>&gt;<i> Thanks
</I>
The problem is an interaction in readBody. Your logs actually contain the key clue:

&gt;<i> LENGTH twisted.web.iweb.UNKNOWN_LENGTH
</I>
This indicates that the remote server (which, while your logs don’t outright say it, is clearly a Google server) is doing something particularly stupid: that is, they’re sending a response that is neither chunked nor content-length-delimited. This means that message completion can only be signalled by the closing of the connection once the response is complete.

Twisted, correctly, gets a bit nervous about this: it’s very difficult to tell the actual completion of the response from any number of error conditions where the connection gets abruptly torn down. For this reason, the docstring of IResponse.deliverBody says that in a case like this: &quot;The protocol's connectionLost method will be called with: PotentialDataLoss, which indicates that it cannot be determined if the entire response body has been delivered.”

When readBody’s protocol connectionLost method is called with PotentialDataLoss, it calls the errback with PartialDownloadError, which is what you’re seeing. The body of the response is available on the PartialDownloadError as PartialDownloadError.response, so if you’re interested in continuing to use readBody you’ll probably want to register an errback on the deferred that checks for this error and handles it appropriately: in your case, probably by converting the error to a safe response and then calling the callback!

In this instance, I’d *also* recommend that you reach out to whatever Google service is sending this response. RFC 7230 says that a server SHOULD send a Content-Length header if not sending a Transfer-Encoding: chunked header, and points out that not doing so exists primarily for backward compatibility with HTTP/1.0.

I hope that all helps!

Cory

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 801 bytes
Desc: Message signed with OpenPGP using GPGMail
URL: &lt;/pipermail/twisted-python/attachments/20160404/79109fd3/attachment.sig&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="062703.html">[Twisted-Python] web.client.readbody
</A></li>
	<LI>Next message (by thread): <A HREF="062707.html">[Twisted-Python] web.client.readbody
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62706">[ date ]</a>
              <a href="thread.html#62706">[ thread ]</a>
              <a href="subject.html#62706">[ subject ]</a>
              <a href="author.html#62706">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
