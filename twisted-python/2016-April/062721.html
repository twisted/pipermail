<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Windows spawnProcess - Child process inherits files and sockets (POSIX does not)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Windows%20spawnProcess%20-%20Child%20process%20inherits%0A%20files%20and%20sockets%20%28POSIX%20does%20not%29&In-Reply-To=%3CCAEgpGv6D0QDTEdo%3DOX-SDNfwYuMJrN%2BE09KHpG367hiJwkF%3D4g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="030255.html">
   <LINK REL="Next"  HREF="062722.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Windows spawnProcess - Child process inherits files and sockets (POSIX does not)</H1>
    <B>Oliver Palmer</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Windows%20spawnProcess%20-%20Child%20process%20inherits%0A%20files%20and%20sockets%20%28POSIX%20does%20not%29&In-Reply-To=%3CCAEgpGv6D0QDTEdo%3DOX-SDNfwYuMJrN%2BE09KHpG367hiJwkF%3D4g%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Windows spawnProcess - Child process inherits files and sockets (POSIX does not)">oliverpalmer at opalmer.com
       </A><BR>
    <I>Wed Apr  6 21:57:18 MDT 2016</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="030255.html">[Twisted-Python] Windows spawnProcess - Child process inherits files and sockets (POSIX does not)
</A></li>
        <LI>Next message (by thread): <A HREF="062722.html">[Twisted-Python] Windows spawnProcess - Child process inherits files and sockets (POSIX does not)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62721">[ date ]</a>
              <a href="thread.html#62721">[ thread ]</a>
              <a href="subject.html#62721">[ subject ]</a>
              <a href="author.html#62721">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Owner of pywincffi here, I'd certainly welcome a PR or two for pywincffi
with the necessary functions/constants/etc so you don't have to manage that
code and I'd be happy to help write it too.  I think the consensus is
Twisted is going to eventually replace calls into pywin32 with calls into
pywincffi rather than implement all of that code inside of Twisted itself.
I've already started doing this in a couple of places,
twisted.python.lockfile
&lt;<A HREF="https://github.com/twisted/twisted/compare/trunk...opalmer:windows-cffi">https://github.com/twisted/twisted/compare/trunk...opalmer:windows-cffi</A>&gt;
being the one I'm actively working on because it's simpler to start with.
But the code inside of dumbwin32proc.py and _win32handleinherit.py are both
high on my list to convert too so it probably makes sense that we work on
this together if you're open to it.

Anyway as for some of your questions and points I've tried to reply to some
of them below.  I will admit, it's slanted towards making as much of this a
possible a part of pywincffi having plugged away at the 'what to do about
pywin32' and 'how to make Windows API calls more pythonic' quite a bit now
so keep that in mind.

&gt;<i> After all of this -- including some frustration, I confess -- I decided
</I>to go ahead and create a cffi ABI-mode variation of my original patch,
anyway: it passes the same tests and, much like the ctypes approach, works
nicely on my environment: Win 7 32, Win 2008R2 64, Win XP 32 (!!!), Python
2.7.11 32, Twisted 16.1, cffi 1.5.2.

Looking at your code, some of it could be put into pywincffi already.  It
would need more tests and some additional code so the API calls are closer
to what's already in the project (type checking, default arguments,
documentation, etc) but overall it seems like you've already done the major
work of understanding how it all fits together.  The other advantages of
putting this code into pywincffi is testing and releases are easier because
the project is using AppVeyor to test all PRs and build the wheel files for
most major Python versions including both 32 and 64 bit variants.  From
Twisted's perspective, it's just a dependency on another library.

&gt;<i> Just for kicks I compared the performance of the ctypes vs cffi
</I>implementation: ...

Have you tried a comparison between out-of-line modules and those using
dlopen?  I imagine they'd end up being pretty similar in the end
performance wise but I am a little curious.  In pywincffi I started out
using dlopen but moved away from it because I needed to write some extra
code which couldn't be included from a header.  The other advantage I saw
is that you don't have to rely on the DLL being present and/or Windows
being able to locate it so you can include code which might only
be available if you have some extra library installed.

&gt;<i> This makes sense given that the code is mostly calling out to DLLs and,
</I>AFAICT, cffi does the nice extra work of validating/converting types back
and forth.

It usually does handle type conversion nicely but it can also do odd things
depending on the Python version (like bytes vs. unicode vs. strings) if
you're not careful.  The other issue is user input which can sometimes
result in odd error messages at the C-level that are difficult to
understand or correct without specific knowledge of the underlying code.
In non-public APIs this is not as big of an issue because the code is task
specific but in something like pywincffi or Twisted where people can use
APIs in unexpected ways the automatic conversion/validation can be somewhat
lacking (again, something I wanted to centralize and improve in pywincffi).

&gt;<i> It is mostly based on SysInternals information at
</I><A HREF="http://forum.sysinternals.com/howto-enumerate-handles_topic18892.html.">http://forum.sysinternals.com/howto-enumerate-handles_topic18892.html.</A>
There are many other references across the web to those undocumented
options and data structures. But none of those come from formal Microsoft
documents, that I could find.

Some of the people on that site either have contacts within Microsoft or
have worked for Microsoft at one point so I usually trust what's there if
it's the only source.  The other place I often look is the ReactOS project
where they've managed to reverse engineer quite a bit of the Windows kernel
which can either hint at the info you need or validate what you already
know.

&gt;<i> Wrapping up: I'm really not sure how to more forward with this: not only
</I>does pywin32 not provide the needed APIs, but also one of those APIs --
documented -- is being used in an undocumented fashion.

IMHO (again, with some bias), I think implementing the calls you need in
pywincffi is the first step.  If the calls are undocumented it would also
be a good place to do the necessary research, testing and development I
think in isolation from Twisted itself so it's clear we're going in the
right direction.  Once that's done a patch set for Twisted, which calls
into pywincffi, can be opened and tested across the supported platforms.
This makes the patch set smaller but also makes it easier to understand
what if anything the new code breaks.


Regardless, even if you don't want to go the route of putting this into
pywincffi thanks for working on this because it helps in some of the work
I'm doing too.

---Oliver



On Tue, Apr 5, 2016 at 5:11 PM, exvito here &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">ex.vitorino at gmail.com</A>&gt; wrote:

&gt;<i> On Thu, Mar 31, 2016 at 10:27 PM, Glyph &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Before submitting a patch for review, I'm looking for preliminary
</I>&gt;&gt;<i> feedback, assuming you agree that the Windows vs POSIX semantics should be
</I>&gt;&gt;<i> the same (if not, why?).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After much thought: Yes.  They should be the same.  The reason they're
</I>&gt;&gt;<i> not is largely ignorance of the relevant APIs and abstractions on Windows,
</I>&gt;&gt;<i> not any desire that they differ.  The one place they have to differ a
</I>&gt;&gt;<i> little bit is handle inheritance: we need to figure out some way to express
</I>&gt;&gt;<i> the 'childFDs' mapping in terms of both file descriptors and handles.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Agreed. My code does not go into 'childFDs' mapping territory, though. All
</I>&gt;<i> it does is prevent all file- and socket-handles from being inherited by the
</I>&gt;<i> child process -- other than the pipes used for STDIO communication.
</I>&gt;<i>
</I>&gt;<i> My patch calls a few Windows APIs via ctypes, however, as far as I can
</I>&gt;&gt;<i> tell, Twisted on Windows requires pywin32 and, recently, there has been
</I>&gt;&gt;<i> some discussion around dropping that dependency and moving towards
</I>&gt;&gt;<i> something based on cffi.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ctypes is dangerous and error-prone.  If you screw up the bit-width of a
</I>&gt;&gt;<i> type, or the type in a header changes on some future version, ctypes gives
</I>&gt;&gt;<i> you no way of finding out until some poor user's process segfaults, and
</I>&gt;&gt;<i> usually not at the relevant call site.  So we'd prefer not to maintain more
</I>&gt;&gt;<i> ctypes-using code.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The APIs in pywin32 very closely mirror the underlying Windows API, so
</I>&gt;&gt;<i> for addressing this issue, please just go ahead and use pywin32 APIs;
</I>&gt;&gt;<i> porting them to a new API along with everything else should be relatively
</I>&gt;&gt;<i> straightforward.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> If we do move forward with that change, we will probably use
</I>&gt;&gt;<i> <A HREF="https://pypi.python.org/pypi/pywincffi">https://pypi.python.org/pypi/pywincffi</A> and not move anything within
</I>&gt;&gt;<i> Twisted.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Agreed with your ctypes comment -- I've been hit by such faults which
</I>&gt;<i> &quot;magically&quot; went away using cffi when coding against Windows TAPI.
</I>&gt;<i>
</I>&gt;<i> pywin32, unfortunatelly, does not include two Windows APIs (out of four)
</I>&gt;<i> my code requires -- I just grepped the source for latest release I could
</I>&gt;<i> find on SourceForge, 220.
</I>&gt;<i>
</I>&gt;<i> For completeness, the missing APIs are NtQuerySystemInformation [1] and
</I>&gt;<i> NtQueryObject [2].
</I>&gt;<i> The others are GetHandleInformation [3] and SetHandleInformation [4].
</I>&gt;<i>
</I>&gt;<i> What would you say the way forward is? Should I submit the patch for
</I>&gt;&gt;<i> review anyway? Is there any other work that needs to be done first that I
</I>&gt;&gt;<i> may contribute to?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, just go ahead and write the patch.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Given that pywin32 does not provide two of the required APIs, maybe this
</I>&gt;<i> issue is somewhat blocked.
</I>&gt;<i>
</I>&gt;<i> Adding to that is the fact that one particular API call in my code --
</I>&gt;<i> NtQuerySystemInformation [1] -- is being used with what seems to be an
</I>&gt;<i> undocumented option -- SystemHandleInformation (enum = 16) -- and
</I>&gt;<i> returning, again, an apparently undocumented data structure --
</I>&gt;<i> SYSTEM_HANDLE_INFORMATION. I downloaded and installed the available SDKs
</I>&gt;<i> and WDKs (driver dev kits) from Microsoft and could not find any reference
</I>&gt;<i> to those particular options or data structures.
</I>&gt;<i>
</I>&gt;<i> My code was created after much investigation on how to obtain the list of
</I>&gt;<i> open handles for the current process.
</I>&gt;<i> The gist of it is:
</I>&gt;<i> - Call NtQuerySystemInformation with the SystemInformationClass arg set
</I>&gt;<i> to SystemHandleInformation.
</I>&gt;<i> - This returns all (!!!) of the handles in the system (no need for special
</I>&gt;<i> privileges).
</I>&gt;<i> - Filter those out by the current process PID and type, such that only
</I>&gt;<i> files and sockets are left.
</I>&gt;<i> - Use the GetHandleInformation to get the inheritance flag and clear it
</I>&gt;<i> with SetHandleInformation if needed.
</I>&gt;<i>
</I>&gt;<i> It is mostly based on SysInternals information at
</I>&gt;<i> <A HREF="http://forum.sysinternals.com/howto-enumerate-handles_topic18892.html.">http://forum.sysinternals.com/howto-enumerate-handles_topic18892.html.</A>
</I>&gt;<i> There are many other references across the web to those undocumented
</I>&gt;<i> options and data structures. But none of those come from formal Microsoft
</I>&gt;<i> documents, that I could find.
</I>&gt;<i>
</I>&gt;<i> An alternative approach, which I also tried, for completeness sake, was to
</I>&gt;<i> try and Get/SetHandleInformation on all possible handles -- this is
</I>&gt;<i> completely unfeasible given that handles are at least 32 bit numbers.
</I>&gt;<i>
</I>&gt;<i> After all of this -- including some frustration, I confess -- I decided to
</I>&gt;<i> go ahead and create a cffi ABI-mode variation of my original patch, anyway:
</I>&gt;<i> it passes the same tests and, much like the ctypes approach, works nicely
</I>&gt;<i> on my environment: Win 7 32, Win 2008R2 64, Win XP 32 (!!!), Python 2.7.11
</I>&gt;<i> 32, Twisted 16.1, cffi 1.5.2.
</I>&gt;<i>
</I>&gt;<i> Just for kicks I compared the performance of the ctypes vs cffi
</I>&gt;<i> implementation:
</I>&gt;<i> - The ctypes code runs in 0.014s - 0.016s.
</I>&gt;<i> - The cffi code runs in 0.03s - 0.04s.
</I>&gt;<i>
</I>&gt;<i> This makes sense given that the code is mostly calling out to DLLs and,
</I>&gt;<i> AFAICT, cffi does the nice extra work of validating/converting types back
</I>&gt;<i> and forth.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Wrapping up: I'm really not sure how to more forward with this: not only
</I>&gt;<i> does pywin32 not provide the needed APIs, but also one of those APIs --
</I>&gt;<i> documented -- is being used in an undocumented fashion.
</I>&gt;<i>
</I>&gt;<i> Even though I'd love to submit a patch, I don't think we're at that point
</I>&gt;<i> yet. However, for posterity's sake and if anyone wants to take a look at
</I>&gt;<i> the code, it is avalable at <A HREF="https://github.com/exvito/twisted">https://github.com/exvito/twisted</A> in branches
</I>&gt;<i> win32-fix-handle-inherit-cffi and win32-fix-handle-inherit-ctypes. They add
</I>&gt;<i> two tests to twisted/test/test_process.py, one line to
</I>&gt;<i> twisted/internet/_dumbwin32proc.py and one module named
</I>&gt;<i> twisted/internet/_win32handleinherit.py
</I>&gt;<i>
</I>&gt;<i> I'd love to hear feedback or ideas on this.
</I>&gt;<i> Thanks again
</I>&gt;<i>
</I>&gt;<i> [1]
</I>&gt;<i> <A HREF="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724509(v=vs.85">https://msdn.microsoft.com/en-us/library/windows/desktop/ms724509(v=vs.85</A>).aspx
</I>&gt;<i> [2] <A HREF="https://msdn.microsoft.com/en-us/library/bb432383(v=vs.85">https://msdn.microsoft.com/en-us/library/bb432383(v=vs.85</A>).aspx
</I>&gt;<i> [3]
</I>&gt;<i> <A HREF="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724329(v=vs.85">https://msdn.microsoft.com/en-us/library/windows/desktop/ms724329(v=vs.85</A>).aspx
</I>&gt;<i> [4]
</I>&gt;<i> <A HREF="https://msdn.microsoft.com/en-us/library/windows/desktop/ms724935(v=vs.85">https://msdn.microsoft.com/en-us/library/windows/desktop/ms724935(v=vs.85</A>).aspx
</I>&gt;<i> --
</I>&gt;<i> exvito
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20160406/f799f13b/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="030255.html">[Twisted-Python] Windows spawnProcess - Child process inherits files and sockets (POSIX does not)
</A></li>
	<LI>Next message (by thread): <A HREF="062722.html">[Twisted-Python] Windows spawnProcess - Child process inherits files and sockets (POSIX does not)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#62721">[ date ]</a>
              <a href="thread.html#62721">[ thread ]</a>
              <a href="subject.html#62721">[ subject ]</a>
              <a href="author.html#62721">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
