<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Large Transfers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Large%20Transfers&In-Reply-To=%3C200305100903.18677.uwe%40oss4u.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="036502.html">
   <LINK REL="Next"  HREF="036518.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Large Transfers</H1>
    <B>Uwe C. Schroeder</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Large%20Transfers&In-Reply-To=%3C200305100903.18677.uwe%40oss4u.com%3E"
       TITLE="[Twisted-Python] Large Transfers">uwe at oss4u.com
       </A><BR>
    <I>Sat May 10 10:03:18 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="036502.html">[Twisted-Python] Large Transfers
</A></li>
        <LI>Next message (by thread): <A HREF="036518.html">[Twisted-Python] Large Transfers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36511">[ date ]</a>
              <a href="thread.html#36511">[ thread ]</a>
              <a href="subject.html#36511">[ subject ]</a>
              <a href="author.html#36511">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Saturday 10 May 2003 08:17 am, Glyph Lefkowitz wrote:
&gt;<i> On Saturday, May 10, 2003, at 08:59 AM, Uwe C. Schroeder wrote:
</I>&gt;<i> &gt; Is this really a good thing to do ? Shouldn't pb see that the
</I>&gt;<i> &gt; arguments are
</I>&gt;<i> &gt; larger than 640k and start paging ?
</I>&gt;<i>
</I>&gt;<i> No, because this would violate lots of order-of-execution guarantees
</I>&gt;<i> that PB normally provides.
</I>&gt;<i>
</I>&gt;<i> Let's say that you did
</I>&gt;<i>
</I>&gt;<i> 	foo.callRemote(&quot;call1&quot;, &quot;x&quot; * 1024 * 1024)
</I>&gt;<i> 	foo.callRemote(&quot;call2&quot;, &quot;x&quot;)
</I>&gt;<i>
</I>&gt;<i> You would expect 'call1' to execute before 'call2', right?  but no -
</I>&gt;<i> because call1 began paging its arguments, call2 will be sent
</I>&gt;<i> interleaved (the desired result for paged calls) and would execute
</I>&gt;<i> first.
</I>
Hmmm - you'd call foo.callRemote(&quot;call2&quot;, &quot;x&quot;) in the callback of the first 
call, since both calls return a defered. You can't rely on the first call 
being completed before issuing the next one. Well, you can, but that is not 
quite safe. If the two calls depend on each other you have to call the second 
one in the callback of the first one. If the calls are not related, the 
execution order isn't that important (well, at least I can't think of a case 
right now where it would be)

&gt;<i>
</I>&gt;<i> The same thing would be true of sending return values.
</I>&gt;<i>
</I>&gt;<i> &gt; What I'm doing is to hand down XML data which is database-generated on
</I>&gt;<i> &gt; the
</I>&gt;<i> &gt; server side. Whenever a user requests a too large resultset the
</I>&gt;<i> &gt; network layer
</I>&gt;<i> &gt; fails. On the other hand the resultset already is in memory, so why
</I>&gt;<i> &gt; not jut
</I>&gt;<i> &gt; transfer it ?
</I>&gt;<i> &gt; I realize that his is probably bad design
</I>
&gt;<i> If your goal is to facilitate bad design with huge gobs of XML, PB is
</I>&gt;<i> probably not for you.  There are a number of other protocols which are
</I>&gt;<i> designed for exactly this kind of application - HTTP, XML/RPC, SOAP,
</I>&gt;<i> depending on your level of complexity.  Twisted provides native support
</I>&gt;<i> for the first 2, and SOAP could probably be added without too much
</I>&gt;<i> trouble.
</I>
Yep, XML/RPC might be the right thing. SOAP has nice features but I don't like 
the bulky approach.


&gt;<i> &gt; , but it's the easiest way to
</I>&gt;<i> &gt; transfer this information. Sure I can write the stuff to a temporary
</I>&gt;<i> &gt; file and
</I>&gt;<i> &gt; page it over, however this defies the purpose, since then the original
</I>&gt;<i> &gt; call
</I>&gt;<i> &gt; results in a message to go get the file. This means I need at least 4
</I>&gt;<i> &gt; callbacks for any given call (the original ok callback, then another
</I>&gt;<i> &gt; one for
</I>&gt;<i> &gt; the possible paging as well as 2 error callbacks, one for each call)
</I>&gt;<i>
</I>&gt;<i> The error-handling needs to be improved, but this is what
</I>&gt;<i> 'twisted.spread.util.getAllPages' is for.  You only need one callback.
</I>
Didn't see that one.

&gt;<i> &gt; I can extend the problem by compressing the parameters with zlib (
</I>&gt;<i> &gt; which I'm
</I>&gt;<i> &gt; doing anyways), but at some point I will hit the limit.
</I>&gt;<i>
</I>&gt;<i> Hard limits like this one should never be pushed so closely.  If your
</I>&gt;<i> data is more than, say, 60k, you should probably be looking at paging
</I>&gt;<i> it.  More than 500k and you are definitely abusing the protocol.
</I>
no argument about that

&gt;<i> &gt; The other problem this creates is a timing issue. Since I have to make
</I>&gt;<i> &gt; several
</I>&gt;<i> &gt; calls in order to transfer the resultset, I have to delay database
</I>&gt;<i> &gt; calls
</I>&gt;<i> &gt; until the whole resultset is valid.
</I>&gt;<i> &gt; To put it more technically:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; self.perspective.transfer_large_result(small_int,label,large_result_arr
</I>&gt;<i> &gt; ay)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; will fail if large_result_array exceeds 640k. However small_int and
</I>&gt;<i> &gt; label can
</I>&gt;<i> &gt; be transferred. The only way to do this is
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; if numberofbytes(large_result_set) &gt;= 640k:
</I>
&gt;<i> Wrong.  If numberofbytes(large_result_set) + banana_epsilon(()) +
</I>&gt;<i> pb_call_overhead ...
</I>
yeah - just wwanted to keep it simple :-)

&gt;<i> This is not a number that you can calculate reliably.  640k is a hard
</I>&gt;<i> high limit.
</I>&gt;<i>
</I>&gt;<i> &gt; self.perspective.transfer_first_part(small_int,label).callback(self.sma
</I>&gt;<i> &gt; llpart_ok)
</I>&gt;<i>
</I>&gt;<i> I don't understand.  Do you want to get the whole result at once?  Or
</I>&gt;<i> do you want to send it only when necessary?  If you want to send it
</I>&gt;<i> only when necessary then aren't these two steps required anyway?  If
</I>&gt;<i> not, then can't you use the methods in twisted.spread.util to retrieve
</I>&gt;<i> the pager when you would normally be retrieving a string, in the same
</I>&gt;<i> step?
</I>
I do not WANT to get the whole thing, sadly I NEED the whole thing.


&gt;<i> It would be helpful for my understanding if you would use real method
</I>&gt;<i> names like &quot;addCallback&quot; and &quot;callRemote&quot; here.  I don't have any idea
</I>&gt;<i> what 'self.perspective' is, or whether 'transfer_first_part' is
</I>&gt;<i> supposed to be remote or local.
</I>
well, I thought that would be clear. perspective is a pb.Perspective, callback 
is addCallback. The whole thing is on the initiating side, which could be 
server or client, since those chunks get sent in both directions and I have 
the initiating side actively SEND it and not the receiver fetch it.

&gt;<i>
</I>&gt;<i> &gt; and in smallpart_ok
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; self.page_the_rest(large_result_array).callback(self.whole_stuff_transf
</I>&gt;<i> &gt; ered)
</I>&gt;<i>
</I>&gt;<i> Again, not really sure what you're saying.  Why not -
</I>&gt;<i>
</I>&gt;<i> 	from twisted.spread import util
</I>&gt;<i> 	util.getAllPages(serverThingy, &quot;getStuff&quot;, small_int,
</I>&gt;<i> label).addCallback(lambda l: ''.join(l)).addCallback(gotABigString)
</I>&gt;<i>
</I>&gt;<i> &gt; This is an enormous overhead.
</I>&gt;<i>
</I>&gt;<i> as far as I understand it, the only overhead you require is that line
</I>&gt;<i> above.  But I admit I do not understand it terribly well.
</I>
Me neither :-) I'll do some tests to see if I can put that in easily. I'd 
prefere a solution that uses standard Twisted without modifying it.

&gt;<i> &gt; What even strikes me more is that this size limit not even prevents
</I>&gt;<i> &gt; large
</I>&gt;<i> &gt; memory consumption - since the object is already there and in cBanana
</I>&gt;<i> &gt; the
</I>&gt;<i> &gt; object is already stored in the buffer.
</I>&gt;<i>
</I>&gt;<i> Where is 'there'?
</I>&gt;<i>
</I>&gt;<i> On the side of the connection that wishes to send the data, it's in
</I>&gt;<i> memory.  If you modify the sending side locally, the whole string may
</I>&gt;<i> even be in your outgoing buffer there, but on the receiving side only
</I>&gt;<i> the beginning will be, since upon receiving the length it will
</I>&gt;<i> terminate the connection.  (At least, I don't think TCP normally sends
</I>&gt;<i> multi-megabyte packets.)
</I>
Nope, TCP doesn't. Why will it terminate the connection ? 

&gt;<i> &gt; I think I'll just remove all size limits and go thru the (unwanted)
</I>&gt;<i> &gt; way to create a own package.
</I>&gt;<i>
</I>&gt;<i> Please, don't do this.  If PB is not working with your application, use
</I>&gt;<i> something else.  This kind of a brute-force solution will undoubtedly
</I>&gt;<i> cause problems down the road, and the people most suited to help you
</I>&gt;<i> with them will not be interested in doing so.
</I>&gt;<i>
</I>&gt;<i> There's nothing wrong with a hybrid approach, either.  You could
</I>&gt;<i> transfer the file over HTTP rather than in the PB connection, but still
</I>&gt;<i> use PB as your control protocol.  You could implement an even simpler
</I>&gt;<i> file-transfer protocol reminiscent of HTTP/0.9 rather than use
</I>&gt;<i> Twisted's full HTTP layer.
</I>
For some reasons beyond my influence I can't use more than one port. If I 
could talk &quot;them&quot; into using several ports I'd love to do that. For that 
reason I have to find a way to handle everything with one port. XML/RPC was 
my original protocol choice, however I think pb is much nicer :-)


	UC

--
Open Source Solutions 4U, LLC	2570 Fleetwood Drive
Phone:  +1 650 872 2425		San Bruno, CA 94066
Cell:   +1 650 302 2405		United States
Fax:    +1 650 872 2417



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="036502.html">[Twisted-Python] Large Transfers
</A></li>
	<LI>Next message (by thread): <A HREF="036518.html">[Twisted-Python] Large Transfers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#36511">[ date ]</a>
              <a href="thread.html#36511">[ thread ]</a>
              <a href="subject.html#36511">[ subject ]</a>
              <a href="author.html#36511">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
