<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Race condition in callInThread()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Race%20condition%20in%20callInThread%28%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="010942.html">
   <LINK REL="Next"  HREF="010944.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Race condition in callInThread()</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Race%20condition%20in%20callInThread%28%29&In-Reply-To="
       TITLE="[Twisted-Python] Race condition in callInThread()">exarkun at divmod.com
       </A><BR>
    <I>Fri Jul  8 21:29:41 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="010942.html">[Twisted-Python] Could not create and run a Windows Service with	Twisted 2.0.1 &amp; Python 2.4.1
</A></li>
        <LI>Next message: <A HREF="010944.html">[Twisted-Python] conch example of sftp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10943">[ date ]</a>
              <a href="thread.html#10943">[ thread ]</a>
              <a href="subject.html#10943">[ subject ]</a>
              <a href="author.html#10943">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>James kindly added a failing test for the nasty behavior of twisted.python.threadpool.ThreadPool._startSomeWorkers().  It seems this will be difficult to fix completely without making API-incompatible changes all the way up to reactor.callInThread, though.

Fixing it for *most* cases is straightforward enough:

Index: twisted/python/threadpool.py
===================================================================
--- twisted/python/threadpool.py        (revision 14112)
+++ twisted/python/threadpool.py        (working copy)
@@ -99,10 +99,10 @@
         return state
     
     def _startSomeWorkers(self):
-        if self.workers &gt;= self.max:
-            return
-        # FIXME: Wait for any waiters to eat of the queue.
-        while self.workers &lt; self.max and self.q.qsize() &gt; 0:
+        while (
+            self.workers &lt; self.max and # Don't create too many
+            len(self.waiters) &lt; self.q.qsize() # but create enough
+            ):
             self.startAWorker()
 
     def dispatch(self, owner, func, *args, **kw):

But this isn't a complete fix.  Annoyingly, the area it doesn't cover very well is exactly what the unit test covers most aggressively.  The problem is the implementation of _worker: it calls back into user code before adjusting the ThreadPool's state to indicate that it is no longer busy.  Since the concept of result callback/errbacks isn't present in _worker, fixing this would involve expanding the API to pass callback/errback functions all the way down so that _worker can invoke them at the right time.

At least, as far as I can tell.

Another option is to loosen up the test, so that it passes even if the ThreadPool creates one extra thread.  Unfortunately, even though the unit test will only ever create one extra thread, user code could create as many as the ThreadPool allows to exist total, by just adding multiple work units to the queue in a single callback on the Deferred returned by deferToThread.

Thoughts?

Jp


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="010942.html">[Twisted-Python] Could not create and run a Windows Service with	Twisted 2.0.1 &amp; Python 2.4.1
</A></li>
	<LI>Next message: <A HREF="010944.html">[Twisted-Python] conch example of sftp
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#10943">[ date ]</a>
              <a href="thread.html#10943">[ thread ]</a>
              <a href="subject.html#10943">[ subject ]</a>
              <a href="author.html#10943">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
