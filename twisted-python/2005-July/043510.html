<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] threadedselectreactor - shutting down the foreign	event loop
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20threadedselectreactor%20-%20shutting%20down%20the%20foreign%0A%09event%20loop&In-Reply-To=%3C200507181054.57558.tdickenson%40devmail.geminidataloggers.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="043509.html">
   <LINK REL="Next"  HREF="043511.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] threadedselectreactor - shutting down the foreign	event loop</H1>
    <B>Toby Dickenson</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20threadedselectreactor%20-%20shutting%20down%20the%20foreign%0A%09event%20loop&In-Reply-To=%3C200507181054.57558.tdickenson%40devmail.geminidataloggers.co.uk%3E"
       TITLE="[Twisted-Python] threadedselectreactor - shutting down the foreign	event loop">tdickenson at devmail.geminidataloggers.co.uk
       </A><BR>
    <I>Mon Jul 18 03:54:57 MDT 2005</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="043509.html">[Twisted-Python] question about twisted conch (SSH) and wxPython
</A></li>
        <LI>Next message (by thread): <A HREF="043511.html">[Twisted-Python] threadedselectreactor - shutting down the	foreign event loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43510">[ date ]</a>
              <a href="thread.html#43510">[ thread ]</a>
              <a href="subject.html#43510">[ subject ]</a>
              <a href="author.html#43510">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Im looking at moving my PyQt app to threadedselectreactor. Previously I was 
keeping twisted and Qt in seperate threads. Avoiding the need to cross that 
thread boundary has been a great simplification, but Im having some problems 
relating to the shutdown of my foreign event loop.

The examples such as 
<A HREF="http://svn.twistedmatrix.com/cvs/trunk/doc/core/examples/threadedselect/pygamedemo.py?view=auto&amp;rev=13596">http://svn.twistedmatrix.com/cvs/trunk/doc/core/examples/threadedselect/pygamedemo.py?view=auto&amp;rev=13596</A>
handle this by:
a. Calling reactor.stop() when there is a GUI shutdown request, 
b. Using reactor.addSystemEventTrigger to shut down the foreign event loop 
after reactor shutdown.

That approach seems untenable for me, for several reasons:
1. Too invasive. I dont want to pollute Qt code with Twisted details.
2. If my app is runing as a COM server then Pythoncom handles the main loop, 
not Qt. More pollution.
3. The reactor doesnt get shutdown if the foreign event loop shuts down for 
some other reason. This leads to deadlocks when the threading module tries to 
join the threads managed by the threadpool module, because the threadpool 
does know to close those threads.

Im having moderate success with the following alternative structure which 
closes the reactor *after* whatever foreign event loop has exited, but it 
feels like I am relying on undocumented reactor implementation accidents 
here:

from twisted.internet.threadedselectreactor import install as twisted_install
reactor = twisted_install()
reactor.interleave(trigger)
try:
        my_event_loop_in_here()
finally:
	# Request that the reactor stops itself. Internally the
        # reactor uses self.callLater, so shutdown is not complete
        # when this method returns.
        reactor.stop()
        # One call to reactor.iterate is sufficient to complete
        # All reactor shutdown events. 
        reactor.iterate()
        # Reactor is now fully shutdown

Is there a better approach?

Should something like my finally block be included as a method of 
threadedselectreactor?

Is it right for reactor.stop to return before the shutdown is complete?

-- 
Toby Dickenson


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="043509.html">[Twisted-Python] question about twisted conch (SSH) and wxPython
</A></li>
	<LI>Next message (by thread): <A HREF="043511.html">[Twisted-Python] threadedselectreactor - shutting down the	foreign event loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#43510">[ date ]</a>
              <a href="thread.html#43510">[ thread ]</a>
              <a href="subject.html#43510">[ subject ]</a>
              <a href="author.html#43510">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
