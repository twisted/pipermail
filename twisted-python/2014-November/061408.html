<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Sending longer messages in AMP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Sending%20longer%20messages%20in%20AMP&In-Reply-To=%3CCALL7chkXB-b%2B5kiZt0ocU%2Bbeaaxr35zxejhtrodYjTdkMfvMcg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="061406.html">
   <LINK REL="Next"  HREF="028943.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Sending longer messages in AMP</H1>
    <B>Gavin Panella</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Sending%20longer%20messages%20in%20AMP&In-Reply-To=%3CCALL7chkXB-b%2B5kiZt0ocU%2Bbeaaxr35zxejhtrodYjTdkMfvMcg%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Sending longer messages in AMP">gavin at gromper.net
       </A><BR>
    <I>Fri Nov 14 04:59:02 MST 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="061406.html">[Twisted-Python] Sending longer messages in AMP
</A></li>
        <LI>Next message (by thread): <A HREF="028943.html">[Twisted-Python] is it possible to change the isolation level of a	psycopg2 connection under enterprise.adbapi ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61408">[ date ]</a>
              <a href="thread.html#61408">[ thread ]</a>
              <a href="subject.html#61408">[ subject ]</a>
              <a href="author.html#61408">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13 November 2014 18:19,  &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
&gt;<i> On 02:57 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">gavin at gromper.net</A> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We're using AMP and are starting to hit TooLong errors when scaling
</I>&gt;&gt;<i> our application. In one respect it's a sign that we should do
</I>&gt;&gt;<i> something like paging large requests and responses, but that's a lot
</I>&gt;&gt;<i> more work, and comes with its own problems. We also don't need
</I>&gt;&gt;<i> particularly large payloads: right now, a limit of ~500kiB would
</I>&gt;&gt;<i> allow us to scale as far as we need and beyond.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've put together a fork of Twisted's AMP implementation that uses
</I>&gt;&gt;<i> 32-bit length prefixes everywhere, though it limits the maximum
</I>&gt;&gt;<i> message size to 2MiB. Every other aspect of it is the same so it's a
</I>&gt;&gt;<i> drop-in replacement, as long as both ends of a connection use it.
</I>&gt;&gt;<i> However, there's no negotiation phase so it's completely incompatible
</I>&gt;&gt;<i> on the wire. The overhead of a few extra bytes is negligible for our
</I>&gt;&gt;<i> use cases, where the networks are all assumed to be low-latency
</I>&gt;&gt;<i> high-bandwidth LANs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Are there any reasons that we shouldn't be doing this? Was there a
</I>&gt;&gt;<i> good reason for 16-bit length prefixes that still holds? Should we be
</I>&gt;&gt;<i> doing something else?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The short length limit is in place to encourage two things:
</I>&gt;<i>
</I>&gt;<i>  * messages that can be processed in a
</I>&gt;<i>    cooperative-multitasking-friendly way
</I>&gt;<i>
</I>&gt;<i>  * the AMP channel can reliably used to multiplex multiple operations
</I>&gt;<i>
</I>&gt;<i> The limit encourages the former by limiting the total amount of data
</I>&gt;<i> it's possible to receive in a single command. Of course, you can still
</I>&gt;<i> do ridiculously complicated work based on a small bit of data so this
</I>&gt;<i> doesn't guarantee that no matter what you do you'll be safe. But doing
</I>&gt;<i> even something simple on a ridiculously large amount of data is
</I>&gt;<i> probably guaranteed to take a while.
</I>&gt;<i>
</I>&gt;<i> The limit encourages the latter by putting a limit on the data that
</I>&gt;<i> needs to be transferred to complete any one command (or answer).
</I>&gt;<i> Again, this isn't a guarantee of safety (you could always have a `for
</I>&gt;<i> i in range(1e10): callRemote(...)` loop and clog up the channel for
</I>&gt;<i> ages) but it pushes things a bit more in that direction.
</I>&gt;<i>
</I>&gt;<i> At ClusterHQ we *also* maintained a fork of AMP with this limit
</I>&gt;<i> raised. Basically, it worked. It did let us get into the kind of
</I>&gt;<i> trouble that the limit was supposed to try to avoid (in particular it
</I>&gt;<i> let us send around messages that would take longer and longer to be
</I>&gt;<i> processed - in a system where keeping latency down was actually sort
</I>&gt;<i> of important; fortunately we had *worse* problems introducing latency
</I>&gt;<i> so this in particular never bit us too hard ;).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I assume that the answers are all no, would someone find this
</I>&gt;&gt;<i> protocol useful if we submitted it for inclusion in Twisted itself?
</I>&gt;<i>
</I>&gt;<i> There are better solutions to the problem. The trouble is that they're
</I>&gt;<i> also more work to implement. ;) I think Twisted should hold out for
</I>&gt;<i> the better solutions though, not adopt a like-AMP-but-with-different-
</I>&gt;<i> hard-coded-limits solution.
</I>&gt;<i>
</I>&gt;<i> What are the better solutions? Library support for paging, basically.
</I>&gt;<i> Or, to consider things more generally, library support for streaming.
</I>&gt;<i> The AMP implementation in Twisted (note, not the *protocol*) should be
</I>&gt;<i> extended to make it easy to pass arbitrarily large streams of data
</I>&gt;<i> around - suitably broken into smaller pieces at the box level.
</I>&gt;<i>
</I>&gt;<i> As of right now, the way I'd do that is by introducing a new argument
</I>&gt;<i> type (or two) supporting `IProducer` and `IConsumer`. Pass in an
</I>&gt;<i> `IProducer` and the library will take the necessary steps to read data
</I>&gt;<i> out of it, chunk it up into &lt;=16kB chunks, and re-assemble them on the
</I>&gt;<i> receiving side (as another `IProducer`).
</I>&gt;<i>
</I>&gt;<i> There are two reasons I'm not working on this right now (apart from
</I>&gt;<i> the standard reasons of not having time to do so ;):
</I>&gt;<i>
</I>&gt;<i>  1) IProducer / IConsumer aren't amenable to this kind of decoupling.
</I>&gt;<i> You can register a producer with a consumer but you can't register a
</I>&gt;<i> consumer with a producer. By the time you give the IProducer to AMP,
</I>&gt;<i> it's too late to tell it you want it to send its data into the AMP
</I>&gt;<i> implementation for the necessary handling. We worked around this in
</I>&gt;<i> twisted.web.client.Agent by introducing a new IProducer-like
</I>&gt;<i> interface. It solves the basic problem but it doesn't go any further
</I>&gt;<i> to improve the usability of the interfaces.
</I>&gt;<i>
</I>&gt;<i>  2) Tubes. Glyph is working on a replacement for IProducer/IConsumer
</I>&gt;<i> that does go a lot further to improve usability. With this promise of
</I>&gt;<i> a bright, prosperous future looming, it's hard to get excited about
</I>&gt;<i> implementing for AMP a just-barely-good-enough solution like the one
</I>&gt;<i> used by Agent (in particular, with the knowledge that the tubes
</I>&gt;<i> solution will be API incompatible and we'll most likely want to
</I>&gt;<i> deprecate the IProducer/IConsumer thing).
</I>
Thank you for such a comprehensive reply. It's really helped.

As a result we're going to stick with the 16-bit AMP, by changing the
calls we're making. In one particular case we'll change our code to
regularly (with a throttle) fetch small batches from a priority queue
instead of getting all-the-things periodically. That'll avoid the need
to switch to 32-bit AMP, and will also be good for the responsiveness of
the overall application.

The Tubes stuff is interesting. As that matures we may look at doing the
work to bring Tubes and AMP together.

Gavin.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="061406.html">[Twisted-Python] Sending longer messages in AMP
</A></li>
	<LI>Next message (by thread): <A HREF="028943.html">[Twisted-Python] is it possible to change the isolation level of a	psycopg2 connection under enterprise.adbapi ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61408">[ date ]</a>
              <a href="thread.html#61408">[ thread ]</a>
              <a href="subject.html#61408">[ subject ]</a>
              <a href="author.html#61408">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
