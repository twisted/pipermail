<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Using sqlalchemy in twisted.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Using%20sqlalchemy%20in%20twisted.&In-Reply-To=%3CF4366C21-62E0-479F-98DF-A13F77BFCF41%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051785.html">
   <LINK REL="Next"  HREF="051792.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Using sqlalchemy in twisted.</H1>
    <B>Valentino Volonghi</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Using%20sqlalchemy%20in%20twisted.&In-Reply-To=%3CF4366C21-62E0-479F-98DF-A13F77BFCF41%40gmail.com%3E"
       TITLE="[Twisted-Python] Using sqlalchemy in twisted.">dialtone at gmail.com
       </A><BR>
    <I>Wed Mar  4 12:04:58 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051785.html">[Twisted-Python] Using sqlalchemy in twisted.
</A></li>
        <LI>Next message (by thread): <A HREF="051792.html">[Twisted-Python] Using sqlalchemy in twisted.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51791">[ date ]</a>
              <a href="thread.html#51791">[ thread ]</a>
              <a href="subject.html#51791">[ subject ]</a>
              <a href="author.html#51791">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1


On Mar 4, 2009, at 3:28 AM, Peter Cai wrote:

&gt;<i> The code doesn't work.   When I limit the thread numbers to 1
</I>&gt;<i>
</I>&gt;<i>    reactor.suggestThreadPoolSize(1)
</I>&gt;<i>
</I>&gt;<i> Everything goes fine.  Other wise the server would be blocked and must
</I>&gt;<i> be killed by &quot;kill 9 ...&quot;.
</I>&gt;<i>
</I>&gt;<i> The result conflicts with my understanding of sqlalchemy.  Since I
</I>&gt;<i> don't share any object between threads, there should be no problem!
</I>
I'm pretty sure you can't say this with full certainty and actually  
you are
just wrong based on the code you showed. deferToThread doesn't use
the same thread every time you call it, there's absolutely no guarantee
in that and sqlalchemy keeps state around in that thread related to that
object it returned. If you want to do any operations you need either to
detach the object from the session before returning it and do any  
modification
on the same object in another thread after reattaching it (pretty  
cumbersome).

Or write your own threadpool that gives names to threads so that you can
have a guarantee that you always call the same thread when working with
a bunch of objects.

Nonetheless though sqlalchemy is a huge project and I'm pretty sure it  
has
some deadlocks and race conditions around which means that even taking
care of these issues you'll have other problems when dealing with the  
orm.

If you want to use sqlalchemy don't use its orm but just the query  
builder,
it's the only sane way to integrate with twisted. Which anyway IMHO is  
the
best way to use it anyway because it uses a lot less memory since it  
doesn't
have to always cache objects because you control everything and can make
that call when you really need it.

&gt;<i> Ah....  It always have risk to use something you haven't tried
</I>&gt;<i> before ....
</I>&gt;<i> I think I have no choice but always set thread pool size to 1 ...
</I>

Not entirely true.

- --
Valentino Volonghi aka Dialtone
Now running MacOS X 10.5
Home Page: <A HREF="http://www.twisted.it">http://www.twisted.it</A>
<A HREF="http://www.adroll.com">http://www.adroll.com</A>

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.9 (Darwin)

iEYEARECAAYFAkmu0NoACgkQ9Llz28widGXBawCg32svBsLqsIRLzvzOThgR4sA0
5UkAoIgNfyUDPl9c0nwSud0sem3aKjz5
=2XIX
-----END PGP SIGNATURE-----


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051785.html">[Twisted-Python] Using sqlalchemy in twisted.
</A></li>
	<LI>Next message (by thread): <A HREF="051792.html">[Twisted-Python] Using sqlalchemy in twisted.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51791">[ date ]</a>
              <a href="thread.html#51791">[ thread ]</a>
              <a href="subject.html#51791">[ subject ]</a>
              <a href="author.html#51791">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
