<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] strange server crash
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20strange%20server%20crash&In-Reply-To=%3C032a01c9aa9a%2494b70e40%24be252ac0%24%40com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051884.html">
   <LINK REL="Next"  HREF="051881.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] strange server crash</H1>
    <B>Alec Matusis</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20strange%20server%20crash&In-Reply-To=%3C032a01c9aa9a%2494b70e40%24be252ac0%24%40com%3E"
       TITLE="[Twisted-Python] strange server crash">matusis at yahoo.com
       </A><BR>
    <I>Sat Mar 21 21:02:03 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051884.html">[Twisted-Python] Re: [Stackless] Stackless Twisted shocking
</A></li>
        <LI>Next message (by thread): <A HREF="051881.html">[Twisted-Python] strange server crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51880">[ date ]</a>
              <a href="thread.html#51880">[ thread ]</a>
              <a href="subject.html#51880">[ subject ]</a>
              <a href="author.html#51880">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have been operating a busy twisted TCP server for quite some time (1
year+).

Yesterday, it strangely crashed under peak load for that day (it has been
under more load in the past).  

 

# grep segfault /var/log/messages

Mar 20 19:12:15 serv2 kernel: [17687209.144548] twistd[10701]: segfault at 8
rip 41eccf rsp 7fff33675270 error 6

 

I cannot understand the reason of the crash, except that its some very rare
race condition.

While the code is quite cumbersome, here are some general details:

 

8 min before the crash, the server started giving repeated error on clients
disconnect, that I have never seen before in the last year.

 

It first produced this twice:

 

2009/03/20 19:04 -0700 [ClientProtocol,318930,70.132.227.150] Unhandled
Error

        Traceback (most recent call last):

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/application/a
pp.py&quot;, line 113, in runReactorWithLogging

            reactor.run()

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posi
xbase.py&quot;, line 220, in run

            self.mainLoop()

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posi
xbase.py&quot;, line 231, in mainLoop

            self.doIteration(t)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/epol
lreactor.py&quot;, line 181, in doPoll

            log.callWithLogger(selectable, _drdw, selectable, fd, event)

        --- &lt;exception caught here&gt; ---

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/log.py
&quot;, line 48, in callWithLogger

            return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/log.py
&quot;, line 33, in callWithContext

            return context.call({ILogContext: newCtx}, func, *args, **kw)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/contex
t.py&quot;, line 59, in callWithContext

            return self.currentContext().callWithContext(ctx, func, *args,
**kw)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/contex
t.py&quot;, line 37, in callWithContext

            return func(*args,**kw)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/epol
lreactor.py&quot;, line 212, in _doReadOrWrite

            self._disconnectSelectable(selectable, why, inRead)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posi
xbase.py&quot;, line 252, in _disconnectSelectable

            selectable.readConnectionLost(f)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/tcp.
py&quot;, line 405, in readConnectionLost

            self.connectionLost(reason)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/tcp.
py&quot;, line 416, in connectionLost

            protocol.connectionLost(reason)

          File &quot;/nail/live/im/myserv/protocols.py&quot;, line 170, in
connectionLost

            self.session.logout()

          File &quot;/nail/live/im/myserv/service.py&quot;, line 1199, in logout

            if self.nick in session.sellers:

        exceptions.AttributeError: Deferred instance has no attribute
'sellers'

 

and then a different error in the same line with the same call stack, that
was repeated about 1000 times for different logging out clients:

 

2009/03/20 19:04 -0700 [ClientProtocol,326158,99.245.246.187] Unhandled
Error

        Traceback (most recent call last):

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/application/a
pp.py&quot;, line 113, in runReactorWithLogging

            reactor.run()

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posi
xbase.py&quot;, line 220, in run

            self.mainLoop()

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posi
xbase.py&quot;, line 231, in mainLoop

            self.doIteration(t)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/epol
lreactor.py&quot;, line 181, in doPoll

            log.callWithLogger(selectable, _drdw, selectable, fd, event)

        --- &lt;exception caught here&gt; ---

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/log.py
&quot;, line 48, in callWithLogger

            return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/log.py
&quot;, line 33, in callWithContext

            return context.call({ILogContext: newCtx}, func, *args, **kw)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/contex
t.py&quot;, line 59, in callWithContext

            return self.currentContext().callWithContext(ctx, func, *args,
**kw)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/python/contex
t.py&quot;, line 37, in callWithContext

            return func(*args,**kw)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/epol
lreactor.py&quot;, line 212, in _doReadOrWrite

            self._disconnectSelectable(selectable, why, inRead)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/posi
xbase.py&quot;, line 252, in _disconnectSelectable

            selectable.readConnectionLost(f)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/tcp.
py&quot;, line 405, in readConnectionLost

            self.connectionLost(reason)

          File
&quot;/nail/encap/Twisted-2.5.0/lib/python2.4/site-packages/twisted/internet/tcp.
py&quot;, line 416, in connectionLost

            protocol.connectionLost(reason)

          File &quot;/nail/live/im/myserv/protocols.py&quot;, line 170, in
connectionLost

            self.session.logout()

          File &quot;/nail/live/im/myserv/service.py&quot;, line 1199, in logout

            if self.nick in session.sellers:

        exceptions.AttributeError: WLResultSet instance has no attribute
'sellers'

 

This last error repeated about 1000 times for different clients, after which
the segfault occurred.

The problem is, that session is an instance of a Session class that is
defined in the code, it is NEITHER a Deferred NOR an instance  of
WLResultSet class- these are completely different classes, and theres no
possible way in the code for variable session to become an instance of
Deferred.

The code is approximately like this:

 

def logout(self):

self.on_logout(self.do_logout) 

for session in self.service.client_sessions: ß self.service.client_sessions
is a dictionary of custom Session class instances

if self.nick in session.sellers:  ß error here, it claims that session is a
Deferred or sometimes an instance of a completely unrelated class

                                                #Some statements 

 

The function self.on_logout sometimes (rarely) dispatches a deferred (it has
maybeDeferred in it), such that its argument self.on_logout is called when
that deferred returns (otherwise its called synchronously).

 

My question is, is it possible to muck up deferred in such a way, that after
dispatching a deferred chain inside  self.on_logout(self.do_logout) , the
remaining statements would be executed in some  unexpected local scope, such
that I would see these weird errors where my for loop iterator would
suddenly go over Deferred instances, instead of the dictionary of Session
instances that I define in the code ?? 

 

Also, why did these errors lead to segfault of the whole twisted process
after 8 minutes?

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20090321/825facf2/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051884.html">[Twisted-Python] Re: [Stackless] Stackless Twisted shocking
</A></li>
	<LI>Next message (by thread): <A HREF="051881.html">[Twisted-Python] strange server crash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51880">[ date ]</a>
              <a href="thread.html#51880">[ thread ]</a>
              <a href="subject.html#51880">[ subject ]</a>
              <a href="author.html#51880">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
