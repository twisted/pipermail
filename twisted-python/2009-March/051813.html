<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] sending large files from web2 http server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20sending%20large%20files%20from%20web2%20http%20server&In-Reply-To=%3Cf055221a0903061025h2c9ca26ftbadd18b566d47446%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051801.html">
   <LINK REL="Next"  HREF="051829.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] sending large files from web2 http server</H1>
    <B>David Reid</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20sending%20large%20files%20from%20web2%20http%20server&In-Reply-To=%3Cf055221a0903061025h2c9ca26ftbadd18b566d47446%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] sending large files from web2 http server">dreid at dreid.org
       </A><BR>
    <I>Fri Mar  6 11:25:53 MST 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051801.html">[Twisted-Python] sending large files from web2 http server
</A></li>
        <LI>Next message (by thread): <A HREF="051829.html">[Twisted-Python] sending large files from web2 http server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51813">[ date ]</a>
              <a href="thread.html#51813">[ thread ]</a>
              <a href="subject.html#51813">[ subject ]</a>
              <a href="author.html#51813">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Mar 5, 2009 at 7:45 AM, Jean-Paul Calderone &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt;wrote:

&gt;<i> On Thu, 05 Mar 2009 16:20:27 +0100, Markus Wanner &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">markus at bluegap.ch</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm trying to stream longish data via web2, but experience sudden stalls
</I>&gt;&gt;<i> in data transfer, followed by a connection abort after a certain
</I>&gt;&gt;<i> timeout. I can't completely reproduce the issue, yet, but figured that
</I>&gt;&gt;<i> the size of the blocks I'm returning via the stream's read method
</I>&gt;&gt;<i> affects the failure rate (an stream.IByteStream implementation).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've tried with chunk sizes between 1 MiB down to 256 bytes. At that
</I>&gt;&gt;<i> rate, I suddenly get the following unhandled errors, which don't seem to
</I>&gt;&gt;<i> have to do much with my code.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I haven't looked at how web2 handles IByteStream providers, but my first
</I>&gt;<i> guess would be that this is an example of a somewhat common bug where
</I>&gt;<i> Deferreds are chained to an arbitrary length based on application data
</I>&gt;<i> and when there's too much application data, the chain gets too long (a
</I>&gt;<i> limit imposed by how much recursion is possible when unwinding the chain),
</I>&gt;<i> and you get this failure.
</I>

I think this probably has something to do with the fact the IByteStream.read
may optionally return a Deferred making it quite easy to write code that
accidentally chain Deferreds to infinity and beyond.  Such as if you're
calling IByteStream.read in the callback of another Deferred and returning
the result.  Sometimes the read method will return a Deferred, sometimes
it'll just return your data.  Without reading the implementation of the
provider you're using it's not easy to know which it'll do when.

While the specific bug you're encountering may or may not be in your
application code (I haven't read it, please post a minimal example if you
can) it illuminates a fundamental flaw of the twisted.web2.stream APIs.
(It's a flaw we understand, and there is a ticket I can't find right now
that documents how it should work there may even be a branch dialtone worked
on that could possibly fix it.)

If this email doesn't help you find your problem please do post a minimal
example and I promise I'll read it today.

-David
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20090306/8663a686/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051801.html">[Twisted-Python] sending large files from web2 http server
</A></li>
	<LI>Next message (by thread): <A HREF="051829.html">[Twisted-Python] sending large files from web2 http server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51813">[ date ]</a>
              <a href="thread.html#51813">[ thread ]</a>
              <a href="subject.html#51813">[ subject ]</a>
              <a href="author.html#51813">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
