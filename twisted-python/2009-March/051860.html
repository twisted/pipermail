<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Noob Question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Noob%20Question&In-Reply-To=%3C200903151827.25932.peter%40sabaini.at%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="051859.html">
   <LINK REL="Next"  HREF="051861.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Noob Question</H1>
    <B>Peter Sabaini</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Noob%20Question&In-Reply-To=%3C200903151827.25932.peter%40sabaini.at%3E"
       TITLE="[Twisted-Python] Noob Question">peter at sabaini.at
       </A><BR>
    <I>Sun Mar 15 11:27:19 MDT 2009</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="051859.html">[Twisted-Python] Noob Question
</A></li>
        <LI>Next message (by thread): <A HREF="051861.html">[Twisted-Python] Noob Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51860">[ date ]</a>
              <a href="thread.html#51860">[ thread ]</a>
              <a href="subject.html#51860">[ subject ]</a>
              <a href="author.html#51860">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sunday 15 March 2009 14:55:25 Shelby Ramsey wrote:
&gt;<i> Peter,
</I>&gt;<i>
</I>&gt;<i> Thanks for the assistance.  I think you and David have me on the right
</I>&gt;<i> path.  Just to clarify the protocol looks like this:
</I>&gt;<i>
</I>&gt;<i> Content-Length: 984
</I>&gt;<i> Content-Type: text/event-xml
</I>&gt;<i>
</I>&gt;<i> &lt;event&gt;
</I>&gt;<i>   &lt;headers&gt;
</I>&gt;<i>    $bunchofinfo ...
</I>&gt;<i>   &lt;/headers&gt;
</I>&gt;<i> &lt;/event&gt;
</I>&gt;<i>
</I>&gt;<i> Where the body (and the content length) start and stop with the &lt;event&gt; ...
</I>&gt;<i> &lt;/event&gt;.
</I>&gt;<i>
</I>&gt;<i> Here is what I've done so far:
</I>&gt;<i>
</I>&gt;<i> from twisted.internet import reactor, protocol
</I>&gt;<i> from twisted.protocols import basic
</I>&gt;<i> from re import compile, findall
</I>&gt;<i>
</I>&gt;<i> bl_p = compile('Content-Length:\s(\d+)')
</I>&gt;<i>
</I>&gt;<i> class My_Client(basic.LineReceiver):
</I>&gt;<i>     def __init__(self):
</I>&gt;<i>         self.body_length = None
</I>&gt;<i>
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         self.transport.write(&quot;login \r\n\r\n&quot;)
</I>&gt;<i>         self.transport.write(&quot;sendevents\r\n\r\n&quot;)
</I>&gt;<i>
</I>&gt;<i>     def lineReceived(self, line):
</I>&gt;<i>         print line
</I>&gt;<i>         bl_m = bl_p.findall(line)
</I>&gt;<i>         if bl_m:
</I>&gt;<i>             print 'Match:'
</I>&gt;<i>             self.body_length = int(bl_m[0]) - len(line) # this doesn't
</I>&gt;<i> really work because it doesn't factor in the len of the next line
</I>
Hm, I thought you said the Content-Length was only the length of the body? Ie. 
without headers?

&gt;<i>             self.setRawMode()
</I>&gt;<i>
</I>&gt;<i>     def rawDataReceived(self, data):
</I>&gt;<i>        datalen = len(data)
</I>&gt;<i>        if self.body_length &gt; datalen:
</I>&gt;<i>            self.body_length -= datalen
</I>&gt;<i>            print data
</I>&gt;<i>        else:
</I>&gt;<i>            part = data[:self.body_length]
</I>&gt;<i>            extra = data[self.body_length:]
</I>&gt;<i>            print 'Left Over\n:'
</I>&gt;<i>            print extra
</I>&gt;<i>            self.setLineMode(extra=extra)
</I>&gt;<i>
</I>&gt;<i>     def connectionLost(self, reason):
</I>&gt;<i>         print &quot;%s&quot; % (reason)
</I>&gt;<i>
</I>&gt;<i> class My_Factory(protocol.ClientFactory):
</I>&gt;<i>     protocol = My_Client
</I>&gt;<i>
</I>&gt;<i>     def clientConnectionFailed(self, connector, reason):
</I>&gt;<i>         print &quot;Connection failed - goodbye!&quot;
</I>&gt;<i>         reactor.stop()
</I>&gt;<i>
</I>&gt;<i>     def clientConnectionLost(self, connector, reason):
</I>&gt;<i>         print &quot;Connection lost - goodbye!&quot;
</I>&gt;<i>         reactor.stop()
</I>&gt;<i>
</I>&gt;<i> def main():
</I>&gt;<i>     f = FS_Factory()
</I>
Should be My_Factory() above, right?

&gt;<i>     reactor.connectTCP(&quot;$IP&quot;, $PORT, f)
</I>
I assume $IP / $PORT get replaced with actual values?

&gt;<i>     reactor.run()
</I>&gt;<i>
</I>&gt;<i> # this only runs if the module was *not* imported
</I>&gt;<i> if __name__ == '__main__':
</I>&gt;<i>     main()
</I>&gt;<i>
</I>&gt;<i> To me ... this looks somewhat correct ... but it doesn't seem to actually
</I>&gt;<i> ever use the line received method (note the print statement ...).  For
</I>&gt;<i> instance upon logging in it should respond with a +OK Logged In ... but it
</I>&gt;<i> never prints that.
</I>
One thing that might be an issue here is the line delimiter. Twisted by 
default has &quot;\r\n&quot; as a line delimiter, so if you fed it only &quot;\n&quot; newlines, 
basic.LineReceiver would never detect an end of line. 

The delimiter is an attribute of the class, ie. 

class My_Client(basic.LineReceiver):
    delimiter = '\n'

switches to newline-delim. lines.


Two tools I find indispensable for this kind of work:

* the Python debugger &quot;pdb&quot; which lets you browse around interactively at 
interesting points in the running code ; see eg. here for a short intro: 
<A HREF="http://www.ferg.org/papers/debugging_in_python.html">http://www.ferg.org/papers/debugging_in_python.html</A>

* some kind of packet sniffer, eg. tcpdump or wireshark so you can actually 
see whats going on at the wire.

bye,
peter.



&gt;<i> And then when it receives an &quot;&lt;event&gt;...&quot; it actually dies with this error:
</I>&gt;<i>
</I>&gt;<i> [Failure instance: Traceback (failure with no frames): &lt;class
</I>&gt;<i> 'twisted.internet.error.ConnectionDone'&gt;: Connection was closed cleanly.
</I>&gt;<i> ]
</I>&gt;<i> Connection lost - goodbye!
</I>&gt;<i>
</I>&gt;<i> So I'm a bit lost as to what the impact of adding the rawDataReceived
</I>&gt;<i> method has done.
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i> SDR
</I>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 197 bytes
Desc: This is a digitally signed message part.
URL: &lt;/pipermail/twisted-python/attachments/20090315/76c2d9be/attachment.sig&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="051859.html">[Twisted-Python] Noob Question
</A></li>
	<LI>Next message (by thread): <A HREF="051861.html">[Twisted-Python] Noob Question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#51860">[ date ]</a>
              <a href="thread.html#51860">[ thread ]</a>
              <a href="subject.html#51860">[ subject ]</a>
              <a href="author.html#51860">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
