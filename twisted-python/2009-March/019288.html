<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Using sqlalchemy in twisted.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Using%20sqlalchemy%20in%20twisted.&In-Reply-To=F4366C21-62E0-479F-98DF-A13F77BFCF41%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019338.html">
   <LINK REL="Next"  HREF="019279.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Using sqlalchemy in twisted.</H1>
    <B>Peter Cai</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Using%20sqlalchemy%20in%20twisted.&In-Reply-To=F4366C21-62E0-479F-98DF-A13F77BFCF41%40gmail.com"
       TITLE="[Twisted-Python] Using sqlalchemy in twisted.">newptcai at gmail.com
       </A><BR>
    <I>Thu Mar  5 00:17:45 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019338.html">[Twisted-Python] Using sqlalchemy in twisted.
</A></li>
        <LI>Next message: <A HREF="019279.html">[Twisted-Python] how to pass on the connection failed or connection	lost error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19288">[ date ]</a>
              <a href="thread.html#19288">[ thread ]</a>
              <a href="subject.html#19288">[ subject ]</a>
              <a href="author.html#19288">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm not quite sure, but I think I'm pretty careful of sharing objects
between threads.
1st, I only cached as few as possible orm objects.  I tried to detach them,
but I found that if I detach them,  I can't access any of their fields any
more.

2nd, I create new orm objects based on client request, pass them to class
Database and then merge them to scoped sessions, change, commit and then
discard these objects.

3rd, I switch to sqlite frequently to check if there is any database
operation outside Database, because sqlite doesn't allow multi-thread
access.

Actually it seems to work until 2 or 3 days ago suddenly cases hang the
server.

Ah, as I've already written lots of code in ORM, I think maybe I should try
to change Database to use a dedicated thread to handle all database
operations.

That might be a bottle neck of my application, but I really can't give up
orm as these mapper classes are used everywhere in my application.

On Thu, Mar 5, 2009 at 3:04 AM, Valentino Volonghi &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dialtone at gmail.com</A>&gt;wrote:

&gt;<i> -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i> Hash: SHA1
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mar 4, 2009, at 3:28 AM, Peter Cai wrote:
</I>&gt;<i>
</I>&gt;<i>  The code doesn't work.   When I limit the thread numbers to 1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   reactor.suggestThreadPoolSize(1)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Everything goes fine.  Other wise the server would be blocked and must
</I>&gt;&gt;<i> be killed by &quot;kill 9 ...&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The result conflicts with my understanding of sqlalchemy.  Since I
</I>&gt;&gt;<i> don't share any object between threads, there should be no problem!
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I'm pretty sure you can't say this with full certainty and actually you are
</I>&gt;<i> just wrong based on the code you showed. deferToThread doesn't use
</I>&gt;<i> the same thread every time you call it, there's absolutely no guarantee
</I>&gt;<i> in that and sqlalchemy keeps state around in that thread related to that
</I>&gt;<i> object it returned. If you want to do any operations you need either to
</I>&gt;<i> detach the object from the session before returning it and do any
</I>&gt;<i> modification
</I>&gt;<i> on the same object in another thread after reattaching it (pretty
</I>&gt;<i> cumbersome).
</I>&gt;<i>
</I>&gt;<i> Or write your own threadpool that gives names to threads so that you can
</I>&gt;<i> have a guarantee that you always call the same thread when working with
</I>&gt;<i> a bunch of objects.
</I>&gt;<i>
</I>&gt;<i> Nonetheless though sqlalchemy is a huge project and I'm pretty sure it has
</I>&gt;<i> some deadlocks and race conditions around which means that even taking
</I>&gt;<i> care of these issues you'll have other problems when dealing with the orm.
</I>&gt;<i>
</I>&gt;<i> If you want to use sqlalchemy don't use its orm but just the query builder,
</I>&gt;<i> it's the only sane way to integrate with twisted. Which anyway IMHO is the
</I>&gt;<i> best way to use it anyway because it uses a lot less memory since it
</I>&gt;<i> doesn't
</I>&gt;<i> have to always cache objects because you control everything and can make
</I>&gt;<i> that call when you really need it.
</I>&gt;<i>
</I>&gt;<i>  Ah....  It always have risk to use something you haven't tried
</I>&gt;&gt;<i> before ....
</I>&gt;&gt;<i> I think I have no choice but always set thread pool size to 1 ...
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Not entirely true.
</I>&gt;<i>
</I>&gt;<i> - --
</I>&gt;<i> Valentino Volonghi aka Dialtone
</I>&gt;<i> Now running MacOS X 10.5
</I>&gt;<i> Home Page: <A HREF="http://www.twisted.it">http://www.twisted.it</A>
</I>&gt;<i> <A HREF="http://www.adroll.com">http://www.adroll.com</A>
</I>&gt;<i>
</I>&gt;<i> -----BEGIN PGP SIGNATURE-----
</I>&gt;<i> Version: GnuPG v1.4.9 (Darwin)
</I>&gt;<i>
</I>&gt;<i> iEYEARECAAYFAkmu0NoACgkQ9Llz28widGXBawCg32svBsLqsIRLzvzOThgR4sA0
</I>&gt;<i> 5UkAoIgNfyUDPl9c0nwSud0sem3aKjz5
</I>&gt;<i> =2XIX
</I>&gt;<i> -----END PGP SIGNATURE-----
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>


-- 
look to the things around you,the immediate world around you, if you are
alive,it will mean something to you &#8212;&#8212;Paul Strand
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20090305/9a952ddc/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20090305/9a952ddc/attachment.htm</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019338.html">[Twisted-Python] Using sqlalchemy in twisted.
</A></li>
	<LI>Next message: <A HREF="019279.html">[Twisted-Python] how to pass on the connection failed or connection	lost error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19288">[ date ]</a>
              <a href="thread.html#19288">[ thread ]</a>
              <a href="subject.html#19288">[ subject ]</a>
              <a href="author.html#19288">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
