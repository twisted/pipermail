<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] newbie problem with SMTPClient
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20newbie%20problem%20with%20SMTPClient&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019261.html">
   <LINK REL="Next"  HREF="019262.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] newbie problem with SMTPClient</H1>
    <B>Dave Britton</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20newbie%20problem%20with%20SMTPClient&In-Reply-To="
       TITLE="[Twisted-Python] newbie problem with SMTPClient">dave at davebritton.com
       </A><BR>
    <I>Sat Mar  7 11:08:49 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019261.html">[Twisted-Python] newbie problem with SMTPClient
</A></li>
        <LI>Next message: <A HREF="019262.html">[Twisted-Python] Bug in twisted.names.client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19307">[ date ]</a>
              <a href="thread.html#19307">[ thread ]</a>
              <a href="subject.html#19307">[ subject ]</a>
              <a href="author.html#19307">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks! sendmail is just what I needed, and its source should help me figure
out the bigger picture.
-Dave
----- Original Message -----
From: &quot;Jean-Paul Calderone&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt;
To: &quot;Twisted general discussion&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt;
Sent: Monday, March 02, 2009 4:22 PM
Subject: Re: [Twisted-Python] newbie problem with SMTPClient


&gt;<i> On Mon, 2 Mar 2009 15:57:17 -0500, Dave Britton &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dave at davebritton.com</A>&gt;
</I>wrote:
&gt;<i> &gt;I love the idea of twisted but I think I must have a twisted learning
</I>disability, as I have gotten nowhere in what ought to be a simple matter.
&gt;<i> &gt;
</I>&gt;<i> &gt;I need to send out emails to small groups from my apache server running a
</I>python cgi using mod_python, but my hosting service doesn't have a MTA.
Instead of learning how to install and configure exim I thought I would use
twisted to make a simple mail client. I started with the tutorial example
that appears at:
&gt;<i>
</I>&gt;<i> It may be that installing exim is actually a better idea.  In order to get
</I>&gt;<i> reliable message deliver, you'll need to handle transient failures.  That
</I>&gt;<i> means persisting state over time (as long as several days) and performing
</I>&gt;<i> redelivery attempts.  However, if you don't mind losing outgoing messages
</I>&gt;<i> when there is a transient failure...
</I>&gt;<i>
</I>&gt;<i> &gt; [snip]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;This nicely looks up the right MX record and sends out an email, just
</I>what I need. Now I want to expand it to allow me to give it a list of email
addresses to send the message to (not just call this same routine multple
times, which seems wasteful and slow and doesn't use twisted's power to
process the multiple emails in multiple threads), but I'm having terrible
trouble figuring out how to do that, which tells me I'm missing a paradigm
somewhere, there's something I'm not getting.
&gt;<i>
</I>&gt;<i> There is a reason that just calling the top-level function you've written
</I>&gt;<i> once for each email might be wasteful, but I don't think it's the reason
</I>&gt;<i> you're thinking.
</I>&gt;<i>
</I>&gt;<i> If you just naively call getMailExchange(host).addCallback(cbMailExchange)
</I>&gt;<i> once for each email, then you will get parallel processing.  Almost as
</I>soon
&gt;<i> as you call most Twisted APIs, they'll start an operation (to be precise,
</I>&gt;<i> many of them start it immediately - before they even return - and others
</I>&gt;<i> start it when you allow program execution flow to return to the reactor).
</I>&gt;<i> So if you call getMailExchange in a loop, each iteration of the loop will
</I>&gt;<i> start a new operation and they'll all run in parallel.  That seems like
</I>&gt;<i> just what you're after.
</I>&gt;<i>
</I>&gt;<i> The reason this isn't the most efficient solution is that your list of
</I>&gt;<i> email addresses might contain two addresses which have the same mail
</I>&gt;<i> exchange host.  In this case, you could connect to that mail exchange
</I>&gt;<i> once and address your message to both addresses and then deliver the
</I>&gt;<i> message body to the mail exchange just once.  This is why getMailTo
</I>&gt;<i> returns a list.
</I>&gt;<i>
</I>&gt;<i> So I think your other questions aren't directly relevant to this problem,
</I>&gt;<i> but I'll answer them anyway, since they're good questions.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Trouble 1 is figuring out the right way to pass additional parameters to
</I>callbacks. Is this right:
&gt;<i> &gt;
</I>&gt;<i> &gt;Dosomething(that-returns-a-deferred).addCallback(Then-do-the-next-thing,
</I>extra-parameter1, extraparameter2)
&gt;<i> &gt;
</I>&gt;<i> &gt;The function Then-do-the-next-thing() will receive the deferred returned
</I>results from Dosomething() as its first argument, and extra-parameter1 and
extraparameter2 as the next two. That is as if calling:
&gt;<i> &gt;Then-do-the-next-thing(Result-returned-by-Dosomething(),extra-parameter1,
</I>extraparameter2). Have I got this correct?
&gt;<i>
</I>&gt;<i> Yes, this is right.
</I>&gt;<i>
</I>&gt;<i> &gt;So, if this is right, then where do I want to put the additional argument
</I>that contains the next email address to send, if I iterate through the list
and hand each one to the email sending process like this:
&gt;<i> &gt;
</I>&gt;<i> &gt;elist=['<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">addr1 at domain.com</A>','<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">addr2 at nextdomain.com</A>'...]
</I>&gt;<i> &gt;for e in elist:
</I>&gt;<i> &gt;.... e2={'mxhost':'','toaddr':e}
</I>&gt;<i> &gt;.... getMailExchange(e2).addCallback(cbMailExchange)
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> I'm not sure why you switched to a dictionary here.  Ignoring that, the
</I>&gt;<i> biggest potential problem with this code snippet is that it creates a
</I>&gt;<i> Deferred (the one returned by getMailExchange) and then drops it on the
</I>&gt;<i> floor (albeit after adding a callback).  You'll almost certainly want to
</I>&gt;<i> build up a list of Deferreds in cases like this, and then use something
</I>&gt;<i> like twisted.internet.defer.gatherResults to find out when they've all
</I>&gt;<i> fired.  Otherwise, you don't really know when your list of operations has
</I>&gt;<i> completed.
</I>&gt;<i>
</I>&gt;<i> As to where to put extra arguments for tracking which email addresses to
</I>&gt;<i> send the message to next, I don't see why you'd want that in this case.
</I>&gt;<i> Your for loop iterates over all the addresses, so none of your callbacks
</I>&gt;<i> should need to know about any more addresses.  That is to say, by the end
</I>&gt;<i> of the for loop, there are no more addresses to which the message needs to
</I>&gt;<i> be sent - you've started sending to all of them already.
</I>&gt;<i>
</I>&gt;<i> &gt;In the tutorial, getMailExchange() is passed just the domain of the
</I>addressee, and the sending out of the email happens when the callback
returns the MX exchange. I changed that to split the email address, so now
it returns both the full address and the mx:
&gt;<i> &gt;
</I>&gt;<i> &gt;def getMailExchange(addr):
</I>&gt;<i> &gt;.... host=addr.split('@')[1]
</I>&gt;<i> &gt;.... def cbMX(mxRecord):
</I>&gt;<i> &gt;.... .... return [addr,str(mxRecord.name)]
</I>&gt;<i> &gt;.... return relaymanager.MXCalculator().getMX(host).addCallback(cbMX)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;At this point I can't figure out how to get the email address passed to
</I>wherever it needs to go. And I don't know really where it needs to go...
yikes.
&gt;<i>
</I>&gt;<i> Likely nothing in this code cares.  However, the address is going to be
</I>&gt;<i> passed to whatever callback is added to the Deferred this function
</I>&gt;<i> returns - because you've included it in the list returned by cbMX.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;In the tutorial the actual email address is hard coded into the class
</I>SMTPTutorialClient(smtp.ESMTPClient) as a class attribute, mailTo. I need to
change that to be variable.
&gt;<i> &gt;
</I>&gt;<i> &gt;How do I get this value (of mailTo) changed for each of the instances
</I>created by smtpClientFactory = SMTPClientFactory()? I think I must be
confused about the roles of Factories and Protocols.
&gt;<i>
</I>&gt;<i> This is probably simpler than you expected - just override __init__ to
</I>&gt;<i> accept any extra data you need, and then save that data as an instance
</I>&gt;<i> attribute.
</I>&gt;<i>
</I>&gt;<i> &gt;I can't seem to figure out a way that works to get the email address
</I>passed into the system as a variable. Rather than waste people's time by
describing my various failures, I thought I'd just ask for suggestions about
the right twisted way to do it.
&gt;<i>
</I>&gt;<i> Another API you might want to look at is twisted.mail.smtp.sendmail.  It's
</I>&gt;<i> probably rather unfortunate that SMTP client tutorial doesn't cover that
</I>&gt;<i> function.
</I>&gt;<i>
</I>&gt;<i> Hope this helps,
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019261.html">[Twisted-Python] newbie problem with SMTPClient
</A></li>
	<LI>Next message: <A HREF="019262.html">[Twisted-Python] Bug in twisted.names.client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19307">[ date ]</a>
              <a href="thread.html#19307">[ thread ]</a>
              <a href="subject.html#19307">[ subject ]</a>
              <a href="author.html#19307">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
