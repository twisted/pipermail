<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Re: Reentrant reactor iteration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Reentrant%20reactor%20iteration&In-Reply-To=20090227162723.12853.1884927660.divmod.quotient.14670%40henry.divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019308.html">
   <LINK REL="Next"  HREF="019310.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Re: Reentrant reactor iteration</H1>
    <B>Martin Geisler</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Re%3A%20Reentrant%20reactor%20iteration&In-Reply-To=20090227162723.12853.1884927660.divmod.quotient.14670%40henry.divmod.com"
       TITLE="[Twisted-Python] Re: Reentrant reactor iteration">mg at daimi.au.dk
       </A><BR>
    <I>Sat Mar  7 13:38:46 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="019308.html">[Twisted-Python] StandardIO flush'n
</A></li>
        <LI>Next message: <A HREF="019310.html">[Twisted-Python] Re: Reentrant reactor iteration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19309">[ date ]</a>
              <a href="thread.html#19309">[ thread ]</a>
              <a href="subject.html#19309">[ subject ]</a>
              <a href="author.html#19309">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at divmod.com</A>&gt; writes:

Hi,

Thanks for the answer. I'm also with the VIFF project and I would like
to explain a bit more about the background for the hack by Marcel.

&gt;<i> On Fri, 27 Feb 2009 15:26:43 +0100, Marcel Keller &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mkeller at cs.au.dk</A>&gt; wrote:
</I>&gt;&gt;<i>Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am working on the VIFF project (viff.dk) which uses Twisted. I
</I>&gt;&gt;<i> found out that our code is sometimes inefficient because we are
</I>&gt;&gt;<i> generating many deferreds (maybe about 10000) in a callback. While
</I>&gt;&gt;<i> doing that, no network communication is performed. Therefore, I
</I>&gt;&gt;<i> investigated the possibility of adding a function to the reactor
</I>&gt;&gt;<i> which is called every iteration and from which the iteration could
</I>&gt;&gt;<i> be called safely. Then, we could generate all deferreds in that
</I>&gt;&gt;<i> function and activate the reactor from to time. See the attached
</I>&gt;&gt;<i> patch for details.
</I>&gt;<i>
</I>&gt;<i> So you're doing a ton of work all at once now and you want to split up
</I>&gt;<i> that ton of work into smaller pieces and do it a little at a time?
</I>
Sort of. We have overloaded the arithmetic operators in our library, so
people will expect to be able to write

  # xs and ys are big lists of our objects
  dot_product
  for (x, y) in zip(xs, ys):
    dot_product += x * y

Here the multiplications involves network traffic and return Deferreds.
We would like the network traffic for the first multiplication to begin
immediately, *before* the remaining multiplications are done.

Doing all the multiplications up front makes the code block the reactor
and uses an awful lot of RAM. If we let each multiplication trigger the
sending of its data immediately, and if we process incoming messages
along the way, memory can be reclaimed for the earlier multiplications
and the above calculation should run in constant memory.

Sending and processing data in a more even flow makes our benchmark
results better and more consistent from one run to the next.

&gt;<i> If that's the case, then you don't need to modify the reactor, you
</I>&gt;<i> just need to split up the work your code is going. There are a lot of
</I>&gt;<i> techniques for doing this. coiterate and inlineCallbacks are two
</I>&gt;<i> solutions which are closest to &quot;cookie cutter&quot; (ie, you have the least
</I>&gt;<i> flexibility in deciding how to use them).
</I>
Right -- we might be able to use these techniques. I haven't looked at
coiterate yet. With inlineCallbacks I guess the code would look
something like this:

  # xs and ys are big lists of our objects
  dot_product
  for (x, y) in zip(xs, ys):
    dot_product += (yield x * y)

which is not so bad, expect that it destroys the nice illusion that x
and y behave like normal integers even though the multiplication
involves network traffic.

&gt;<i> You have a very long, steep, uphill battle to convince me that adding
</I>&gt;<i> support for re-entrant iteration is a good idea.
</I>
One problem I can think of is the memory usage associated with a very
deep recursion. Since there is no such thing as tail call optimization
in Python, each level in the recursion will hold onto any local
variables even though they might not be needed any more.

Are there other general problems with having a re-entrant reactor?

-- 
Martin Geisler

VIFF (Virtual Ideal Functionality Framework) brings easy and efficient
SMPC (Secure Multiparty Computation) to Python. See: <A HREF="http://viff.dk/.">http://viff.dk/.</A>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 196 bytes
Desc: not available
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20090307/b0f23125/attachment.pgp">http://twistedmatrix.com/pipermail/twisted-python/attachments/20090307/b0f23125/attachment.pgp</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="019308.html">[Twisted-Python] StandardIO flush'n
</A></li>
	<LI>Next message: <A HREF="019310.html">[Twisted-Python] Re: Reentrant reactor iteration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19309">[ date ]</a>
              <a href="thread.html#19309">[ thread ]</a>
              <a href="subject.html#19309">[ subject ]</a>
              <a href="author.html#19309">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
