<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Memory usage in large file transfers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Memory%20usage%20in%20large%20file%20transfers&In-Reply-To=%3C20031202152142.GB1559%40intarweb.us%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="039122.html">
   <LINK REL="Next"  HREF="039128.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Memory usage in large file transfers</H1>
    <B>Jp Calderone</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Memory%20usage%20in%20large%20file%20transfers&In-Reply-To=%3C20031202152142.GB1559%40intarweb.us%3E"
       TITLE="[Twisted-Python] Memory usage in large file transfers">exarkun at intarweb.us
       </A><BR>
    <I>Tue Dec  2 08:21:42 MST 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="039122.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
        <LI>Next message (by thread): <A HREF="039128.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39124">[ date ]</a>
              <a href="thread.html#39124">[ thread ]</a>
              <a href="subject.html#39124">[ subject ]</a>
              <a href="author.html#39124">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Dec 02, 2003 at 03:46:07PM +0200, Nikolaos Krontiris wrote:
&gt;<i> Hi again.
</I>&gt;<i> 
</I>&gt;<i> ----- Original Message ----- 
</I>&gt;<i> From: &quot;Andrew Bennetts&quot; &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrew-twisted at puzzling.org</A>&gt;
</I>&gt;<i> To: &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt;
</I>&gt;<i> Sent: Monday, December 01, 2003 2:11 PM
</I>&gt;<i> Subject: Re: [Twisted-Python] Memory usage in large file transfers
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; On Mon, Dec 01, 2003 at 11:25:13AM +0200, Nikolaos Krontiris wrote:
</I>&gt;<i> &gt; &gt;    Hi there.
</I>
&gt;<i> &gt; &gt;    I am writing a file transfer program using twisted as my framework.
</I>&gt;<i> &gt; &gt;    I have been having some problems as far as memory usage is
</I>&gt;<i> &gt; &gt;    concerned (i.e. both client and server just eat through available
</I>&gt;<i> &gt; &gt;    memory without ever releasing it back to the kernel while
</I>&gt;<i> &gt; &gt;    transfering data). I am aware that in theory, the client and server
</I>&gt;<i> &gt; &gt;    will consume at least as much memory as the file to be transferred,
</I>&gt;<i> &gt; &gt;    but this memory should also be made available to the O/S after the
</I>&gt;<i> &gt; &gt;    operation has completed. I also use a garbage collector, which
</I>&gt;<i> &gt; &gt;    makes things just marginally better and the only TWISTED operations
</I>&gt;<i> &gt; &gt;    I use are a few transport write and callLater commands.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; You don't say how large &quot;large&quot; is, but you probably should be using
</I>&gt;<i> &gt; producer/consumer APIs rather than just plain transport.write(data).  See
</I>&gt;<i> &gt; twisted.protocols.basic.FileSender for an example.  If I'm understanding
</I>&gt;<i> &gt; your problem correctly, you should see a significant improvement.  This
</I>&gt;<i> &gt; technique doesn't require holding the entire file in memory to transfer
</I>&gt;<i> &gt; it.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm not sure what you mean about using a garbage collector -- Python
</I>&gt;<i> &gt; automatically cleans up objects with zero reference counts, and
</I>&gt;<i> &gt; periodically finds and collects unreachable object cycles.
</I>&gt;<i> &gt;
</I>&gt;<i> nk: The size of files I am referring to can be anything from 20MB up to
</I>&gt;<i> 500MB, but right now I'm taking it easy with the client/ server model; I'm
</I>&gt;<i> using sending a single 43MB file, and as I'm debugging and improving
</I>&gt;<i> performance, I will increase this filesize...
</I>&gt;<i> nk: I had originally thought about using basic.FileSender but a) It has been
</I>&gt;<i> commented as unstable by the twisted development team and b)I need to send a
</I>&gt;<i> client ID each time I send a single buffer (security... what can you
</I>&gt;<i> say...).
</I>
  Comments of &quot;unstable&quot; in Twisted sources refer to the fact that we are
not promising that the API will not change.  The code in question is bug
free, as far as I know.

  Client ID?  I assume you're using TCP; what do you need to add an ID to
every packet for?

&gt;<i> To make sure that I'm not holding the entire file's contents in
</I>&gt;<i> memory, I read (at most) 64K of  the file each time, and send this data
</I>&gt;<i> away. After it has been sent, this data buffer is flushed. I guess I can try
</I>&gt;<i> to change this to file.open, file.seek, file.read and file.close each time I
</I>&gt;<i> read the file so that the only contents of the file in system memory are the
</I>&gt;<i> only ones necessary...
</I>
  That is not necessary.

&gt;<i> nk: When talking about the garbage collector, I'm just referring to python's
</I>&gt;<i> gc.enable() and gc.collect() commands, nothing more... Unfortunately I don't
</I>&gt;<i> believe that the built-in periodical find-and-collect unreachable object
</I>&gt;<i> cycles is very useful in the case of the client, since it shuts down after
</I>&gt;<i> the file's EOF...
</I>
  Unless you are preventing the garbage collector from working, I don't see
why this should be the case.  To see if your program is building up
unreasonable amounts of unfreeable objects, look at the gc.garbage list. 
Any objects the garbage collector has found can be freed but which it cannot
actually free will end up there.

&gt;<i> [snip]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt;    As professional network programmers, do you believe my diagnosis is
</I>&gt;<i> &gt; &gt;    correct? Have you encountered such problems in the past? Are there
</I>&gt;<i> &gt; &gt;    workarounds for this?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I really can't say.  You've given no specific data at all... How large are
</I>&gt;<i> &gt; the files?  How much memory does your server appear to lose per request?
</I>&gt;<i> &gt; How much memory does the server take overall (both initially and after
</I>&gt;<i> &gt; running for a while)?  How many concurrent requests are you dealing with?
</I>&gt;<i> &gt; What platform, version of Python, and version of Twisted?  Anything else
</I>&gt;<i> you
</I>&gt;<i> &gt; think is relevant?  :)
</I>&gt;<i> &gt;
</I>&gt;<i> nk: Right now, I'm testing the server/ client model with a 43 MB file. The
</I>&gt;<i> memory consumed on a WinMe system using Python 2.3.2 and Twisted 1.1.0 with
</I>&gt;<i> a 64K buffer is 58MB, while with a 4KB buffer is around the 80MB region. On
</I>&gt;<i> Linux using Python 2.3.2 and Twisted 1.1.0, the memory consumed with a 4K
</I>&gt;<i> buffer is always a bit more than 100MB. I can't use very large buffers on my
</I>&gt;<i> Linux system, because of the ID I have to send per buffer sent. It seems
</I>&gt;<i> that the linux default SOL_SOCKET, SO_RCVBUF sizes are relatively small, so
</I>&gt;<i> it confuses the client ID since the packets it receives will have different
</I>&gt;<i> sizes... Note that these results are for 1 server and 1 client. I have not
</I>&gt;<i> yet dared do 2 concurrent clients at once!
</I>
  You absolutely must not rely on the number of bytes received from a
particular read from a socket.  I cannot stress this enough.  You
*absolutely* *can* *not* rely on it.

&gt;<i> nk: The server consumes only 3MB of memory while idle. Unfortunately, I
</I>&gt;<i> cannot tell if the erratic memory consumption lies on the server or client
</I>&gt;<i> side (or both), since I only have 1 PC...
</I>
  The client and server are still separate processes.  You should be able to
view resource usage for each individually.

  Jp
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 189 bytes
Desc: Digital signature
URL: &lt;/pipermail/twisted-python/attachments/20031202/6d92cfc8/attachment.sig&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="039122.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
	<LI>Next message (by thread): <A HREF="039128.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#39124">[ date ]</a>
              <a href="thread.html#39124">[ thread ]</a>
              <a href="subject.html#39124">[ subject ]</a>
              <a href="author.html#39124">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
