<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Memory usage in large file transfers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Memory%20usage%20in%20large%20file%20transfers&In-Reply-To=Law11-OE44iIBFdtaFc0000c9ba%40hotmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006601.html">
   <LINK REL="Next"  HREF="006614.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Memory usage in large file transfers</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Memory%20usage%20in%20large%20file%20transfers&In-Reply-To=Law11-OE44iIBFdtaFc0000c9ba%40hotmail.com"
       TITLE="[Twisted-Python] Memory usage in large file transfers">andrew-twisted at puzzling.org
       </A><BR>
    <I>Mon Dec  1 07:11:51 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="006601.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
        <LI>Next message: <A HREF="006614.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6602">[ date ]</a>
              <a href="thread.html#6602">[ thread ]</a>
              <a href="subject.html#6602">[ subject ]</a>
              <a href="author.html#6602">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Dec 01, 2003 at 11:25:13AM +0200, Nikolaos Krontiris wrote:
&gt;<i>    Hi there.
</I>&gt;<i>    I am writing a file transfer program using twisted as my framework.
</I>&gt;<i>    I have been having some problems as far as memory usage is concerned
</I>&gt;<i>    (i.e. both client and server just eat through available memory without
</I>&gt;<i>    ever releasing it back to the kernel while transfering data). I am aware
</I>&gt;<i>    that in theory, the client and server will consume at least as much memory
</I>&gt;<i>    as the file to be transferred, but this memory should also be made
</I>&gt;<i>    available to the O/S after the operation has completed.
</I>&gt;<i>    I also use a garbage collector, which makes things just marginally better
</I>&gt;<i>    and the only TWISTED operations I use are a few transport write and
</I>&gt;<i>    callLater commands.
</I>
You don't say how large &quot;large&quot; is, but you probably should be using
producer/consumer APIs rather than just plain transport.write(data).  See
twisted.protocols.basic.FileSender for an example.  If I'm understanding
your problem correctly, you should see a significant improvement.  This
technique doesn't require holding the entire file in memory to transfer it.

I'm not sure what you mean about using a garbage collector -- Python
automatically cleans up objects with zero reference counts, and periodically
finds and collects unreachable object cycles.

&gt;<i>    The only culprits responsible for this I can imagine to be a difference
</I>&gt;<i>    between the hardcoded buffer sizes in TWISTED and the amount of data I
</I>&gt;<i>    send (I send 64Kb of data per request for faster delivery in LANs) and/or
</I>&gt;<i>    possibly that this memory lost is in many small chunks of data -- in this
</I>&gt;<i>    case no O/S can free this data, since there are always limits only above
</I>&gt;<i>    which the kernel will deem an amount of memory worth the trouble to be
</I>&gt;<i>    released (I think glibc has around a 2MB limit)...
</I>
Memory fragmentation can prevent the OS reclaiming memory, but generally
you'd expect memory growth to slow as it asymptotically reaches a high
enough limit to accomodate all memory allocations for your load, even with
fragmentation.

I believe Python 2.3's pymalloc allocates memory for different types in
different &quot;arenas&quot;, which are seperately mmapped, so fragmentation in e.g.
the string arena (strings being that type this is read from files, split up,
sent over the network, etc) hopefully won't impact other memory allocation.
So 2.3 vs. 2.2 (or earlier) you should see... different memory use
characteristics.  Hopefully better, but you never know :)

Also, transport.write and callLater in 64kB chunks is unlikely to be the
fastest or memory-efficient technique.  Producers/consumers should be best,
but I'd suspect that even a single transport.write of the entire content
would probably be better.  Actual benchmarks to support this claim would be
very welcome!

&gt;<i>    As professional network programmers, do you believe my diagnosis is
</I>&gt;<i>    correct? Have you encountered such problems in the past? Are there
</I>&gt;<i>    workarounds for this?
</I>
I really can't say.  You've given no specific data at all... How large are
the files?  How much memory does your server appear to lose per request?
How much memory does the server take overall (both initially and after
running for a while)?  How many concurrent requests are you dealing with?
What platform, version of Python, and version of Twisted?  Anything else you
think is relevant?  :)

If you could answer some of these sorts of questions, we could maybe tell
you if what you're seeing is expected behaviour, or unusual, and maybe
suggest specific remedies.

-Andrew.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006601.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
	<LI>Next message: <A HREF="006614.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6602">[ date ]</a>
              <a href="thread.html#6602">[ thread ]</a>
              <a href="subject.html#6602">[ subject ]</a>
              <a href="author.html#6602">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
