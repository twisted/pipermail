<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Memory usage in large file transfers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Memory%20usage%20in%20large%20file%20transfers&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006602.html">
   <LINK REL="Next"  HREF="006616.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Memory usage in large file transfers</H1>
    <B>Nikolaos Krontiris</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Memory%20usage%20in%20large%20file%20transfers&In-Reply-To="
       TITLE="[Twisted-Python] Memory usage in large file transfers">nkrontir at hotmail.com
       </A><BR>
    <I>Tue Dec  2 08:46:07 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="006602.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
        <LI>Next message: <A HREF="006616.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6614">[ date ]</a>
              <a href="thread.html#6614">[ thread ]</a>
              <a href="subject.html#6614">[ subject ]</a>
              <a href="author.html#6614">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again.

----- Original Message ----- 
From: &quot;Andrew Bennetts&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrew-twisted at puzzling.org</A>&gt;
To: &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">twisted-python at twistedmatrix.com</A>&gt;
Sent: Monday, December 01, 2003 2:11 PM
Subject: Re: [Twisted-Python] Memory usage in large file transfers


&gt;<i> On Mon, Dec 01, 2003 at 11:25:13AM +0200, Nikolaos Krontiris wrote:
</I>&gt;<i> &gt;    Hi there.
</I>&gt;<i> &gt;    I am writing a file transfer program using twisted as my framework.
</I>&gt;<i> &gt;    I have been having some problems as far as memory usage is concerned
</I>&gt;<i> &gt;    (i.e. both client and server just eat through available memory
</I>without
&gt;<i> &gt;    ever releasing it back to the kernel while transfering data). I am
</I>aware
&gt;<i> &gt;    that in theory, the client and server will consume at least as much
</I>memory
&gt;<i> &gt;    as the file to be transferred, but this memory should also be made
</I>&gt;<i> &gt;    available to the O/S after the operation has completed.
</I>&gt;<i> &gt;    I also use a garbage collector, which makes things just marginally
</I>better
&gt;<i> &gt;    and the only TWISTED operations I use are a few transport write and
</I>&gt;<i> &gt;    callLater commands.
</I>&gt;<i>
</I>&gt;<i> You don't say how large &quot;large&quot; is, but you probably should be using
</I>&gt;<i> producer/consumer APIs rather than just plain transport.write(data).  See
</I>&gt;<i> twisted.protocols.basic.FileSender for an example.  If I'm understanding
</I>&gt;<i> your problem correctly, you should see a significant improvement.  This
</I>&gt;<i> technique doesn't require holding the entire file in memory to transfer
</I>it.
&gt;<i>
</I>&gt;<i> I'm not sure what you mean about using a garbage collector -- Python
</I>&gt;<i> automatically cleans up objects with zero reference counts, and
</I>periodically
&gt;<i> finds and collects unreachable object cycles.
</I>&gt;<i>
</I>nk: The size of files I am referring to can be anything from 20MB up to
500MB, but right now I'm taking it easy with the client/ server model; I'm
using sending a single 43MB file, and as I'm debugging and improving
performance, I will increase this filesize...
nk: I had originally thought about using basic.FileSender but a) It has been
commented as unstable by the twisted development team and b)I need to send a
client ID each time I send a single buffer (security... what can you
say...). To make sure that I'm not holding the entire file's contents in
memory, I read (at most) 64K of  the file each time, and send this data
away. After it has been sent, this data buffer is flushed. I guess I can try
to change this to file.open, file.seek, file.read and file.close each time I
read the file so that the only contents of the file in system memory are the
only ones necessary...
nk: When talking about the garbage collector, I'm just referring to python's
gc.enable() and gc.collect() commands, nothing more... Unfortunately I don't
believe that the built-in periodical find-and-collect unreachable object
cycles is very useful in the case of the client, since it shuts down after
the file's EOF...
&gt;<i> &gt;    The only culprits responsible for this I can imagine to be a
</I>difference
&gt;<i> &gt;    between the hardcoded buffer sizes in TWISTED and the amount of data
</I>I
&gt;<i> &gt;    send (I send 64Kb of data per request for faster delivery in LANs)
</I>and/or
&gt;<i> &gt;    possibly that this memory lost is in many small chunks of data -- in
</I>this
&gt;<i> &gt;    case no O/S can free this data, since there are always limits only
</I>above
&gt;<i> &gt;    which the kernel will deem an amount of memory worth the trouble to
</I>be
&gt;<i> &gt;    released (I think glibc has around a 2MB limit)...
</I>&gt;<i>
</I>&gt;<i> Memory fragmentation can prevent the OS reclaiming memory, but generally
</I>&gt;<i> you'd expect memory growth to slow as it asymptotically reaches a high
</I>&gt;<i> enough limit to accomodate all memory allocations for your load, even with
</I>&gt;<i> fragmentation.
</I>&gt;<i>
</I>&gt;<i> I believe Python 2.3's pymalloc allocates memory for different types in
</I>&gt;<i> different &quot;arenas&quot;, which are seperately mmapped, so fragmentation in e.g.
</I>&gt;<i> the string arena (strings being that type this is read from files, split
</I>up,
&gt;<i> sent over the network, etc) hopefully won't impact other memory
</I>allocation.
&gt;<i> So 2.3 vs. 2.2 (or earlier) you should see... different memory use
</I>&gt;<i> characteristics.  Hopefully better, but you never know :)
</I>&gt;<i>
</I>&gt;<i> Also, transport.write and callLater in 64kB chunks is unlikely to be the
</I>&gt;<i> fastest or memory-efficient technique.  Producers/consumers should be
</I>best,
&gt;<i> but I'd suspect that even a single transport.write of the entire content
</I>&gt;<i> would probably be better.  Actual benchmarks to support this claim would
</I>be
&gt;<i> very welcome!
</I>&gt;<i>
</I>&gt;<i> &gt;    As professional network programmers, do you believe my diagnosis is
</I>&gt;<i> &gt;    correct? Have you encountered such problems in the past? Are there
</I>&gt;<i> &gt;    workarounds for this?
</I>&gt;<i>
</I>&gt;<i> I really can't say.  You've given no specific data at all... How large are
</I>&gt;<i> the files?  How much memory does your server appear to lose per request?
</I>&gt;<i> How much memory does the server take overall (both initially and after
</I>&gt;<i> running for a while)?  How many concurrent requests are you dealing with?
</I>&gt;<i> What platform, version of Python, and version of Twisted?  Anything else
</I>you
&gt;<i> think is relevant?  :)
</I>&gt;<i>
</I>nk: Right now, I'm testing the server/ client model with a 43 MB file. The
memory consumed on a WinMe system using Python 2.3.2 and Twisted 1.1.0 with
a 64K buffer is 58MB, while with a 4KB buffer is around the 80MB region. On
Linux using Python 2.3.2 and Twisted 1.1.0, the memory consumed with a 4K
buffer is always a bit more than 100MB. I can't use very large buffers on my
Linux system, because of the ID I have to send per buffer sent. It seems
that the linux default SOL_SOCKET, SO_RCVBUF sizes are relatively small, so
it confuses the client ID since the packets it receives will have different
sizes... Note that these results are for 1 server and 1 client. I have not
yet dared do 2 concurrent clients at once!
nk: The server consumes only 3MB of memory while idle. Unfortunately, I
cannot tell if the erratic memory consumption lies on the server or client
side (or both), since I only have 1 PC...
&gt;<i> If you could answer some of these sorts of questions, we could maybe tell
</I>&gt;<i> you if what you're seeing is expected behaviour, or unusual, and maybe
</I>&gt;<i> suggest specific remedies.
</I>&gt;<i>
</I>&gt;<i> -Andrew.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006602.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
	<LI>Next message: <A HREF="006616.html">[Twisted-Python] Memory usage in large file transfers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6614">[ date ]</a>
              <a href="thread.html#6614">[ thread ]</a>
              <a href="subject.html#6614">[ subject ]</a>
              <a href="author.html#6614">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
