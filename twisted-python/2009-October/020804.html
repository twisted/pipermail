<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Using a custom reactor in twisted trial for test	cases?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Using%20a%20custom%20reactor%20in%20twisted%20trial%20for%20test%0A%09cases%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020800.html">
   <LINK REL="Next"  HREF="020806.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Using a custom reactor in twisted trial for test	cases?</H1>
    <B>Crispin Wellington</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Using%20a%20custom%20reactor%20in%20twisted%20trial%20for%20test%0A%09cases%3F&In-Reply-To="
       TITLE="[Twisted-Python] Using a custom reactor in twisted trial for test	cases?">cwellington at ccg.murdoch.edu.au
       </A><BR>
    <I>Fri Oct 30 05:38:12 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020800.html">[Twisted-Python] Working on multiple Twisted branches
</A></li>
        <LI>Next message: <A HREF="020806.html">[Twisted-Python] Using a custom reactor in twisted trial for	test	cases?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20804">[ date ]</a>
              <a href="thread.html#20804">[ thread ]</a>
              <a href="subject.html#20804">[ subject ]</a>
              <a href="author.html#20804">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi there,

I am using twisted trial to run test cases for an application. The
application however uses stackless python and has a custom stackless
reactor. I implemented this reactor like this...

-------------------- stacklessreactor.py -----------------------
# Use epoll() as our base reactor
from twisted.internet.epollreactor import EPollReactor as StacklessBaseReactor

import stackless

# seconds between running the greenthreads. 0.0 for flat out 100% CPU
STACKLESS_MAX_PUMP_RATE = 0.1

class StacklessReactor(StacklessBaseReactor):
    &quot;&quot;&quot;This reactor does the stackless greenthread pumping in the main thread, interwoven with the reactor pump&quot;&quot;&quot;
    
    def doIteration(self, timeout):
        &quot;&quot;&quot;Calls the base reactors doIteration, and then fires off all the stackless threads&quot;&quot;&quot;
        if timeout &gt; STACKLESS_MAX_PUMP_RATE:
            timeout = STACKLESS_MAX_PUMP_RATE
        stackless.schedule()
        return StacklessBaseReactor.doIteration(self,timeout)

def install():
    &quot;&quot;&quot;
    Install the stackless() reactor.
    &quot;&quot;&quot;
    p = StacklessReactor()
    from twisted.internet.main import installReactor
    installReactor(p)
-------------------------------------------------------------------

And I install this as my reactor in my application with...

import stacklessreactor
stacklessreactor.install()

...placed right at the top of my .tac python file. And this all works.
Running the app with twistd, the custom reactor is installed and is used
as the reactor for the app.

Now however, I come to write tests and run them with trial. I *need* the
tests to be run under the stackless reactor or things simply wont work
(a lot of the code I need to test are stackless tasklets).

When I go &quot;/usr/local/stackless/bin/trial --help-reactors&quot; I get the
following list:

    kqueue	kqueue(2)-based reactor.
    win32	Win32 WaitForMultipleObjects-based reactor.
    epoll	epoll(4)-based reactor.
    iocp	Win32 IO Completion Ports-based reactor.
    gtk 	Gtk1 integration reactor.
    cf  	CoreFoundation integration reactor.
    gtk2	Gtk2 integration reactor.
    default	The best reactor for the current platform.
    debug-gui	Semi-functional debugging/introspection reactor.
    poll	poll(2)-based reactor.
    glib2	GLib2 event-loop integration reactor.
    select	select(2)-based reactor.
    wx  	wxPython integration reactor.
    qt  	QT integration reactor

One of these I can use by passing in --reactor=name. 

So the question is, is there a way of getting the trial framework to use
my custom reactor? Is there a way to get my reactor into that list
somehow? Is this not a supported feature of trial?

And... if this isn't a supported feature, what is the best way to get a
TestCase that will run under that reactor?

Look forward to any help people can offer me.

With kind regards

Crispin Wellington



</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020800.html">[Twisted-Python] Working on multiple Twisted branches
</A></li>
	<LI>Next message: <A HREF="020806.html">[Twisted-Python] Using a custom reactor in twisted trial for	test	cases?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20804">[ date ]</a>
              <a href="thread.html#20804">[ thread ]</a>
              <a href="subject.html#20804">[ subject ]</a>
              <a href="author.html#20804">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
