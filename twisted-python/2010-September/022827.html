<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to hook onto or append functionality to a	class (from another class)?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20hook%20onto%20or%20append%20functionality%20to%20a%0A%09class%20%28from%20another%20class%29%3F&In-Reply-To=AANLkTi%3DLKK1Ue_yov%3Dtey13rkkVEu3RTzn4WG6toYwyX%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022825.html">
   <LINK REL="Next"  HREF="022835.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to hook onto or append functionality to a	class (from another class)?</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20How%20to%20hook%20onto%20or%20append%20functionality%20to%20a%0A%09class%20%28from%20another%20class%29%3F&In-Reply-To=AANLkTi%3DLKK1Ue_yov%3Dtey13rkkVEu3RTzn4WG6toYwyX%40mail.gmail.com"
       TITLE="[Twisted-Python] How to hook onto or append functionality to a	class (from another class)?">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Sep  8 15:47:40 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022825.html">[Twisted-Python] How to hook onto or append functionality to a	class (from another class)?
</A></li>
        <LI>Next message: <A HREF="022835.html">[Twisted-Python] How to hook onto or append functionality to a class (from another class)?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22827">[ date ]</a>
              <a href="thread.html#22827">[ thread ]</a>
              <a href="subject.html#22827">[ subject ]</a>
              <a href="author.html#22827">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Einar,

On Sep 8, 2010, at 6:19 AM, Einar S. Ids&#248; wrote:

&gt;<i> I am trying to make one class/service hook onto another class/service
</I>&gt;<i> to add to its functionality without disturbing the original
</I>&gt;<i> class/service.
</I>
So... you are trying to write a computer program, is what you're saying? ;-)

&gt;<i> My situation is this: I currently have a class which at specific
</I>&gt;<i> intervals queries one server per instance (via t.u.getProcessOutput())
</I>&gt;<i> for some basic information. Each instance has a method which analyses
</I>&gt;<i> its returned data and stores the result it to  ts internal data
</I>&gt;<i> structure. My dilemma is that I wish to leave this class alone, but I
</I>&gt;<i> also wish to be able to add functionality from external classes based
</I>&gt;<i> on the result of said method. For instance: If the method analysing
</I>&gt;<i> the result from getProcessOutput() discovers a certain user on the
</I>&gt;<i> server being queried, I wish to store the data to a mysql database.
</I>&gt;<i> Under other circumstances I wish to send a notification to myself over
</I>&gt;<i> MSN or via mail. I can easily envision myself wanting to respond to
</I>&gt;<i> the results with other actions as well in the future. How can this be
</I>&gt;<i> achieved?
</I>
It sounds like this is a pretty trivial application of the Publish/Subscribe pattern (or perhaps the Observer) pattern.

&lt;<A HREF="http://en.wikipedia.org/wiki/Publish/subscribe">http://en.wikipedia.org/wiki/Publish/subscribe</A>&gt;
&lt;<A HREF="http://en.wikipedia.org/wiki/Observer_pattern">http://en.wikipedia.org/wiki/Observer_pattern</A>&gt;

In less fancy language, &quot;it sounds like you need a 'for' loop&quot;.

&gt;<i> I can of course modify the original class so that I pass an
</I>&gt;<i> adbapi.ConnectionPool as optional argument to __init__() and modify
</I>&gt;<i> the method to check for the existence of such an object before
</I>&gt;<i> querying the database. I would then also need to add another optional
</I>&gt;<i> argument which is whatever object needs to be passed to allow the
</I>&gt;<i> class to send a message to MSN, and still more optional arguments for
</I>&gt;<i> any such new service I'd like to add. However, as mentioned I'd rather
</I>&gt;<i> not modify the original class, and doing this seems like too much of a
</I>&gt;<i> hack. Or is it? Perhaps inheritance is the key, although that would
</I>&gt;<i> require me to modify existing methods which I know to be working just
</I>&gt;<i> to tack on some additional functionality at the end.
</I>
No, inheritance isn't the key.  It never is - composition is the key :).  You're right that adding lots of special-purpose arguments to __init__ that each do one thing is a bad idea.  Don't do that.  Add one general-purpose &quot;list of observers that want to be notified (when X happens)&quot; argument.  Then when your getProcessOutput() finishes, just do 'for something in self.observers: something.youJustGotServerStatus(newServerStatus)'.  It usually makes sense to define an interface with a couple of interesting methods when you do this, so that you can have more methods.  If you've only ever got one interesting type of event for this class and you're sure you won't ever have more, you might just use callable objects instead of methods, since that will let users pass in functions (i.e. 'for observer in observers: observer()').

&gt;<i> What are my options here? I took a look at t.p.hook, and it seems like
</I>&gt;<i> it is perfect for the job: After having instantiated my &quot;global&quot;
</I>&gt;<i> adbapi.ConnectionPool(), I can just add a pre- or post-hook to any
</I>&gt;<i> class's method from which I'd like to store data. That way I can make
</I>&gt;<i> a db-instance which hooks in to any part of my application and stores
</I>&gt;<i> any result imaginable from any method. However, it seems that t.p.hook
</I>&gt;<i> is very rarely used, so perhaps there is a better way of achieving
</I>&gt;<i> what I want?
</I>
Please, please do not use t.p.hook.  I hope that we delete it one day.

The only thing in all of Twisted which uses t.p.hook is twisted.python.threadable, which is also very lightly used.  This functionality could easily be implemented using a decorator instead of the awfulness that twisted.python.hook gets up to.  If you look at how twisted.python.hook is implemented, you'll notice that it generates strings of Python code at runtime, and compiles and runs them.

More generally, please don't try to do what t.p.hook tries to do, and add functionality to a class that you wrote without that class's cooperation.  If your application depends on magical external modifications to classes in order to work as expected, it will become flaky and difficult to maintain.  For one thing, imagine some new developer reading the code: they're looking at the body of the method, they're looking at the code of the method, and then they're looking at some code in some totally random other spot that is somehow getting invoked when they call it.  Imagine the frustration as they try to figure out why that is happening.

If you instead just have an explicit list of observers, which are passed in to the class, then if one of them blows up, it will be very easy to figure out where it's blowing up: the line will be observer.youJustGotServerStatus(), there will be a couple of youJustGotServerStatus method somewhere that you can track down bugs to.

In some situations, if you're dealing with somebody else's code, that you can't modify for some reason at the source level (for example: you want to work with a released version of the standard library, or an older version of Twisted) it might make sense to patch in some extra functionality from your code.  In that case, using something like twisted.python.hook that enforces a particular style (again: do not use twisted.python.hook itself, it is old, crufty code that is unnecessarily complex) might be slightly better than just raw monkey patching.  But this is very much something that happens across the boundaries of code that is distributed separately.  If you are the maintainer for your class, just change your class, it's much simpler!

Of course, there are perfectly good reasons to use the wonktacular insane dynamic features that Python offers you, but mostly those are useful when you're trying to abstract away some concern that the developer writing the code in question shouldn't have to worry about, like a proxy object.  It's not a good idea to implement core application functionality in terms of meta-programming hacks: the whole point of adding funky meta-programming hacks is to make the core application logic easier to follow, by removing other concerns from the code :).

&gt;<i> I hope this was somewhat comprehensible, and that there is an elegant
</I>&gt;<i> solution out there. :)
</I>
Well, if my answer answers your question, then yes :).

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20100908/88c9b1fe/attachment-0001.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20100908/88c9b1fe/attachment-0001.htm</A> 
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022825.html">[Twisted-Python] How to hook onto or append functionality to a	class (from another class)?
</A></li>
	<LI>Next message: <A HREF="022835.html">[Twisted-Python] How to hook onto or append functionality to a class (from another class)?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22827">[ date ]</a>
              <a href="thread.html#22827">[ thread ]</a>
              <a href="subject.html#22827">[ subject ]</a>
              <a href="author.html#22827">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
