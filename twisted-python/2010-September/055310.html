<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Memory Usage Problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Memory%20Usage%20Problem&In-Reply-To=%3Cloom.20100906T102808-312%40post.gmane.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="055413.html">
   <LINK REL="Next"  HREF="055311.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Memory Usage Problem</H1>
    <B>Ozgur Pekcagliyan</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Memory%20Usage%20Problem&In-Reply-To=%3Cloom.20100906T102808-312%40post.gmane.org%3E"
       TITLE="[Twisted-Python] Memory Usage Problem">pekcagliyan at labristeknoloji.com
       </A><BR>
    <I>Mon Sep  6 02:28:51 MDT 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="055413.html">[Twisted-Python] Weekly Bug Summary
</A></li>
        <LI>Next message (by thread): <A HREF="055311.html">[Twisted-Python] Memory Usage Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55310">[ date ]</a>
              <a href="thread.html#55310">[ thread ]</a>
              <a href="subject.html#55310">[ subject ]</a>
              <a href="author.html#55310">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi All,

I have a problem which is that memory usage of twisted is increasing but not 
decreasing over time.

After few days, it reaches 520MB. You may find the codes below;
How may I reduce the usage of memory?
Twisted version: 8.2.0
Python version: 2.4.3

[<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">root at labris</A> init.d]# cat /usr/bin/labris-flyng.tac
#!/usr/bin/python

import os

from twisted.application import internet, service
from twisted.internet import reactor
from twisted.enterprise import adbapi
from twisted.plugin import getPlugins
from twisted.python import log

import labris.flyng.iflyng as iflyng
import labris.flyng.config as config
import labris.flyng.plugins as pplugins
import labris.flyng.protocols as flyng_protocols

from labris.flyng.config import flyng_config

# Database type to package dictionary
DB_PACKAGE_DICT = {
    &quot;postgresql&quot; : &quot;psycopg2&quot;
}

def initDatabase(config):
    &quot;&quot;&quot;
    Create database connection pool
    &quot;&quot;&quot;

    dbtype = config.getDBType()
    dbpackage = DB_PACKAGE_DICT.get(dbtype, None)

    if not dbpackage:
        print &quot;Database type % is not supported yet!&quot; %(dbtype)
        sys.exit(1)


    if dbtype == &quot;mysql&quot;:
        dbpool = adbapi.ConnectionPool(
            dbpackage,
                        config.getDBHost(),
                        config.getDBUser(),
                        config.getDBPassword(),
                        config.getDBName()
                )
    else:
            dbpool = adbapi.ConnectionPool(
            dbpackage,
                    database=config.getDBName(),
                    user=config.getDBUser(),
            password=config.getDBPassword(),
                    host=config.getDBHost()
            )

    dbpool.connect()

    return dbpool


def setupPlugins(config, dbpool):
    &quot;&quot;&quot;
    Initialize and setup plugins
    &quot;&quot;&quot;

    for plugin in getPlugins(iflyng.IFlyngPlugin, pplugins):
        print &quot;* Plugin %s&quot; %(plugin.name)
        if not config.isEnabled(plugin.name):
            print &quot;   - Not enabled&quot;
            continue

        plugin.init(config, dbpool)

        for type, port in config.getListeningPorts(plugin.name):
            port = port.replace('&quot;', &quot;&quot;)
            if type == &quot;tcp&quot;:
                print &quot;   -&gt; TCP port: %s&quot; %(port)
                factory = flyng_protocols.FlyngServerFactory(plugin)
                internet.TCPServer(
                    int(port),
                    factory
                ).setServiceParent(application)

            elif type == &quot;udp&quot;:
                print &quot;   -&gt; UDP port: %s&quot; %(port)
                internet.UDPServer(
                    int(port),
                    flyng_protocols.FlyngUDPProtocol(plugin)
                ).setServiceParent(application)

            elif type == &quot;unix&quot;:
                print &quot;   -&gt; UNIX stream: %s&quot; %(port)
                if os.path.exists(port):
                    os.unlink(port)
                factory = flyng_protocols.FlyngServerFactory(plugin)
                internet.UNIXServer(
                    port,
                    factory
                ).setServiceParent(application)

            else:
                raise &quot;connection type %s is not supported&quot; %(port)

#log.startLogging(open(&quot;/var/log/labris-flyng.log&quot;, &quot;a&quot;))

config = config.Configuration()

uid, gid = config.getRunAs()

application = service.Application('labris-flyng', uid, gid)

dbpool = initDatabase(config)

setupPlugins(config, dbpool)


-------------------------------------------------------------------


[<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">root at labris</A> init.d]# cat /usr/bin/labris-pyng.tac
#!/usr/bin/python

&quot;&quot;&quot;
    A syslog-ng to database mapping service
&quot;&quot;&quot;

import os

from twisted.internet import protocol, reactor, defer
from twisted.application import internet, service
from twisted.python import log

from labris.logutils import factories
from labris.logutils.config import pyng_config

class LogFactory(protocol.ServerFactory):
    pass

class UnixLogFactory(protocol.ServerFactory):
    pass

def openUNIXStreams(configuration, application):
    for logtype, stream in configuration.getUnixStreams():
        try:
            if not pyng_config.getboolean(logtype.strip(), &quot;enabled&quot;):
                print &quot;Warning: UNIX stream: &quot;, logtype, &quot; is DISABLED&quot;
                continue

            print &quot;\nPlugin: %s [UNIX-Stream(%s)]&quot; %(logtype, stream)

            factory = UnixLogFactory()
            factory.protocol = 
factories.ProtocolFactory.getLogProtocol(logtype.strip(), &quot;stream&quot;)

            # delete old stream
            if os.path.exists(stream):
                os.unlink(stream)

            internet.UNIXServer(stream.strip(), 
factory).setServiceParent(application)
        except factories.NoSuchProtocolException, e:
            print &quot;Error: no such protocol:&quot;, e.getProtoname()

    for logtype, sock in configuration.getUnixDgrams():
        try:
            if not pyng_config.getboolean(logtype.strip(), &quot;enabled&quot;):
                print &quot;Warning: UNIX dgram: &quot;, logtype, &quot; is DISABLED&quot;
                continue

            print &quot;\nPlugin: %s [UNIX-Datagram(%s)]&quot; %(logtype, stream)

            protocol = factories.ProtocolFactory.getLogProtocol(logtype.strip(), 
&quot;datagram&quot;)

            # delete old stream
            if os.path.exists(sock):
                os.unlink(sock)

            internet.UNIXDatagramServer(sock.strip(), 
protocol()).setServiceParent(application)
        except factories.NoSuchProtocolException, e:
            print &quot;Error: no such protocol:&quot;, e.getProtoname()


def openSockets(configuration, application):
    for logtype, hostname, port in configuration.getTCP():
        try:
            if not pyng_config.getboolean(logtype.strip(), &quot;enabled&quot;):
                print &quot;Warning: TCP socket: &quot;, logtype, &quot; is DISABLED&quot;
                continue

            print &quot;\nPlugin: %s [TCP =&gt; port:%d]&quot; %(logtype, int(port))

            factory = LogFactory()
            factory.protocol = 
factories.ProtocolFactory.getLogProtocol(logtype.strip(), &quot;stream&quot;)

            internet.TCPServer(int(port), factory).setServiceParent(application)
        except factories.NoSuchProtocolException, e:
            print &quot;Error: no such protocol:&quot;, e.getProtoname()

    for logtype, hostname, port in configuration.getUDP():
        try:
            if not pyng_config.getboolean(logtype.strip(), &quot;enabled&quot;):
                print &quot;Warning: UDP socket: &quot;, logtype, &quot; is DISABLED&quot;
                continue

            print &quot;\nPlugin: %s [UDP =&gt; port:%d]&quot; %(logtype, int(port))

            protocol = factories.ProtocolFactory.getLogProtocol(logtype.strip(), 
&quot;datagram&quot;)

            internet.UDPServer(int(port), 
protocol()).setServiceParent(application)
        except factories.NoSuchProtocolException, e:
            print &quot;Error: no such protocol:&quot;, e.getProtoname()


#log.startLogging(open(&quot;/var/log/labris-pyng.log&quot;, &quot;a&quot;))

from labris.logutils.dao.pyngdb import PyNgDB

PyNgDB.initDatabase(pyng_config.bind())

application = service.Application('labris-pyng', pyng_config.uid(), 
pyng_config.gid())

openUNIXStreams(pyng_config, application)
openSockets(pyng_config, application)




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="055413.html">[Twisted-Python] Weekly Bug Summary
</A></li>
	<LI>Next message (by thread): <A HREF="055311.html">[Twisted-Python] Memory Usage Problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55310">[ date ]</a>
              <a href="thread.html#55310">[ thread ]</a>
              <a href="subject.html#55310">[ subject ]</a>
              <a href="author.html#55310">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
