<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] how to write a safe catch-all
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20how%20to%20write%20a%20safe%20catch-all&In-Reply-To=4CA49B1E.5040608%40simplistix.co.uk">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022966.html">
   <LINK REL="Next"  HREF="022964.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] how to write a safe catch-all</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20how%20to%20write%20a%20safe%20catch-all&In-Reply-To=4CA49B1E.5040608%40simplistix.co.uk"
       TITLE="[Twisted-Python] how to write a safe catch-all">exarkun at twistedmatrix.com
       </A><BR>
    <I>Thu Sep 30 10:33:24 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022966.html">[Twisted-Python] The Real Error (tm) [was Re: how to write a safe catch-all]
</A></li>
        <LI>Next message: <A HREF="022964.html">[Twisted-Python] how to write a safe catch-all
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22959">[ date ]</a>
              <a href="thread.html#22959">[ thread ]</a>
              <a href="subject.html#22959">[ subject ]</a>
              <a href="author.html#22959">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02:13 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris at simplistix.co.uk</A> wrote:
&gt;<i>On 30/09/2010 14:39, Jonathan Lange wrote:
</I>&gt;&gt;<i>On Thu, Sep 30, 2010 at 2:36 PM, Chris Withers&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">chris at simplistix.co.uk</A>&gt; 
</I>&gt;&gt;<i>wrote:
</I>&gt;&gt;<i>...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>Is there any way I can get both errbacks *and* exceptions handled 
</I>&gt;&gt;&gt;<i>nicely in
</I>&gt;&gt;&gt;<i>my `loop` call?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>You know about defer.maybeDeferred, right?
</I>&gt;<i>
</I>&gt;<i>Yep, the problem is with `loop` implemented like so:
</I>&gt;<i>
</I>&gt;<i>def loop():
</I>&gt;<i>     d = maybeDeferred(doStuff)
</I>&gt;<i>     d.addErrback(partial(log.err,_why='Unhandled scheduled exception'))
</I>
Names that begin with an underscore are private.  Also, partial is a 
pointless complexification here.

    def loop():
        d = maybeDeferred(doStuff)
        d.addErrback(log.err, 'Unhandled scheduled exception')
&gt;<i>...the logging is odd:
</I>&gt;<i>
</I>&gt;<i>2010-09-30 15:07:03,161 ERROR   : log         (22194|7f41910b26e0):
</I>&gt;<i>Unhandled Error
</I>&gt;<i>Traceback (most recent call last):
</I>&gt;<i>   File &quot;test_looping.py&quot;, line 47, in &lt;module&gt;
</I>&gt;<i>     reactor.run()
</I>&gt;<i>   File &quot;/twisted/internet/base.py&quot;, line 1166, in run
</I>&gt;<i>     self.mainLoop()
</I>&gt;<i>   File &quot;/twisted/internet/base.py&quot;, line 1175, in mainLoop
</I>&gt;<i>     self.runUntilCurrent()
</I>&gt;<i>--- &lt;exception caught here&gt; ---
</I>&gt;<i>   File &quot;/twisted/internet/base.py&quot;, line 779, in runUntilCurrent
</I>&gt;<i>     call.func(*call.args, **call.kw)
</I>&gt;<i>   File &quot;test_looping.py&quot;, line 30, in __call__
</I>&gt;<i>     del self.connector
</I>&gt;<i>exceptions.AttributeError: Break instance has no attribute 'connector'
</I>

This is not logged by your code.  Do you recognize that?
&gt;<i>
</I>&gt;<i>called  4
</I>&gt;<i>called  5
</I>&gt;<i>/twisted/internet/defer.py:262: DeprecationWarning: Don't pass strings
</I>&gt;<i>(like 'Break!') to failure.Failure (replacing with a DefaultException).
</I>&gt;<i>   fail = failure.Failure(fail)
</I>&gt;<i>2010-09-30 15:07:05,167 ERROR   : log         (22194|7f41910b26e0):
</I>&gt;<i>Unhandled scheduled exception
</I>&gt;<i>Traceback (most recent call last):
</I>&gt;<i>Failure: twisted.python.failure.DefaultException: Break!
</I>
This comes from some code not included in the code you posted.  It looks 
like you're using Failure wrong though.  Quoting from above:

    Don't pass strings (like 'Break!') to failure.Failure.
&gt;<i>
</I>&gt;<i>So, how come my log.err doesn't get used for the AttributeError on
</I>&gt;<i>connector?
</I>
I'm sure it doesn't help for me to simply repeat myself, since if it 
didn't make sense the first time probably won't make sense the third or 
fourth time.  I don't know what else to say though.

log.err is an errback on the Deferred you created in loop.

An errback is called (roughly) when a Deferred fires with a Failure.

Your Deferred *never* fires with a Failure corresponding to that 
AttributeError.  This is the most important thing.  If you don't 
understand this, say so and we can talk about it some more.  Everything 
else is just confusing particulars.

Unfortunately maybeDeferred cannot help here.  It solves a slightly 
related problem and does nothing about this one.  You may well want to 
use it, but it's not going to address your `AttributeError` issue in any 
way, because of what I said above, and will repeat here for emphasis:

The AttributeError never becomes an error result on any Deferred.  It is 
caught inside the reactor implementation, logged there by Twisted 
itself, and then thrown away forever.

Jean-Paul

</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022966.html">[Twisted-Python] The Real Error (tm) [was Re: how to write a safe catch-all]
</A></li>
	<LI>Next message: <A HREF="022964.html">[Twisted-Python] how to write a safe catch-all
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22959">[ date ]</a>
              <a href="thread.html#22959">[ thread ]</a>
              <a href="subject.html#22959">[ subject ]</a>
              <a href="author.html#22959">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
