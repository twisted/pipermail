<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Unable to start twistd service on Ubuntu 10.04 when using pseudo terminal
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Unable%20to%20start%20twistd%20service%20on%20Ubuntu%2010.04%0A%20when%20using%20pseudo%20terminal&In-Reply-To=AANLkTikv9nDYjMPiRYRQuNGDEv-DT1d2mioZRGxgp93c%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022940.html">
   <LINK REL="Next"  HREF="022930.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Unable to start twistd service on Ubuntu 10.04 when using pseudo terminal</H1>
    <B>&#381;iga Seilnacht</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Unable%20to%20start%20twistd%20service%20on%20Ubuntu%2010.04%0A%20when%20using%20pseudo%20terminal&In-Reply-To=AANLkTikv9nDYjMPiRYRQuNGDEv-DT1d2mioZRGxgp93c%40mail.gmail.com"
       TITLE="[Twisted-Python] Unable to start twistd service on Ubuntu 10.04 when using pseudo terminal">ziga.seilnacht at gmail.com
       </A><BR>
    <I>Thu Sep 30 11:52:16 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="022940.html">[Twisted-Python] Unable to start twistd service on Ubuntu 10.04	when using pseudo terminal
</A></li>
        <LI>Next message: <A HREF="022930.html">[Twisted-Python] getProcessOutput - Can it be made to return	'output' instead of differed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22965">[ date ]</a>
              <a href="thread.html#22965">[ thread ]</a>
              <a href="subject.html#22965">[ subject ]</a>
              <a href="author.html#22965">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Garret Heaton wrote:
&gt;<i> I've simplified this issue down and am able to reproduce it without
</I>&gt;<i> Twisted: <A HREF="http://gist.github.com/603154">http://gist.github.com/603154</A>
</I>&gt;<i> 
</I>&gt;<i> Still not sure what the cause is, so if anyone has any ideas I'd love to
</I>&gt;<i> hear them. Thanks!
</I>&gt;<i> 
</I>
The behavior that you are seeing seems to be related to the change in
the 2.6.32 kernel, where they changed the child-runs-first scheduler
parameter to false. Setting that parameter to 1 with:

$ sudo sysctl -w kernel.sched_child_runs_first=1

and rebooting the computer restores the behavior that you saw on the
old kernel for me. See <A HREF="http://lwn.net/Articles/352863/">http://lwn.net/Articles/352863/</A> for more details.

Parent (which is the controlling process when ran with -t) exiting before
the child starts causes the child to receive SIGHUP signal immediately as
it starts running, before it has time to disassociate itself from the
parent's process group. It seems to me that this might be an actual bug
in twistd, it should block the SIGHUP signal across the fork() calls.

Your test program has an additional assumption that the child will run
before the parent; the child in your program tries to write to stdout,
i.e. the controlling terminal, which gets closed once the parent exits.

The modified test program below works for me regardless of the setting
of the kernel.sched_child_runs_first parameter.

Hope this helps,
Ziga



import os
import signal

f = open(&quot;test_fork.out&quot;, &quot;w&quot;)

def daemonize():
     # See <A HREF="http://www.faqs.org/faqs/unix-faq/programmer/faq/">http://www.faqs.org/faqs/unix-faq/programmer/faq/</A> - Section 1.7
     print &gt;&gt; f, '--- %s: daemonizing' % os.getpid()

     signal.signal(signal.SIGHUP, signal.SIG_IGN)
     if os.fork(): # launch child and...
         print &gt;&gt; f, '--- %s: kill parent 1' % os.getpid()
         os._exit(0) # kill off parent
     print &gt;&gt; f, '--- %s: old sid: %r' % (os.getpid(), os.getsid(os.getpid()))
     os.setsid()
     print &gt;&gt; f, '--- %s: new sid: %r' % (os.getpid(), os.getsid(os.getpid()))
     if os.fork(): # launch child and...
         print &gt;&gt; f, '--- %s: kill parent 2' % os.getpid()
         os._exit(0) # kill off parent again.

     signal.signal(signal.SIGHUP, signal.SIG_DFL)
     print &gt;&gt; f, '--- %s: daemonizing done' % os.getpid()

if __name__ == &quot;__main__&quot;:
     print &gt;&gt; f, 'starting as %d' % os.getpid()
     daemonize()
     print &gt;&gt; f, 'stopping as %s' % os.getpid()




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="022940.html">[Twisted-Python] Unable to start twistd service on Ubuntu 10.04	when using pseudo terminal
</A></li>
	<LI>Next message: <A HREF="022930.html">[Twisted-Python] getProcessOutput - Can it be made to return	'output' instead of differed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22965">[ date ]</a>
              <a href="thread.html#22965">[ thread ]</a>
              <a href="subject.html#22965">[ subject ]</a>
              <a href="author.html#22965">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
