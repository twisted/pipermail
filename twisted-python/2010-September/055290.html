<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Ldaptor: [PATCH] Reroute errback to deferred	returned by search()
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Ldaptor%3A%20%5BPATCH%5D%20Reroute%20errback%20to%20deferred%0A%09returned%20by%20search%28%29&In-Reply-To=%3CAANLkTin-NA%3DWKpYvT6jzCk4yxf2LCa3iHLyaEXUyrrwf%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="055291.html">
   <LINK REL="Next"  HREF="055294.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Ldaptor: [PATCH] Reroute errback to deferred	returned by search()</H1>
    <B>Anton Gyllenberg</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Ldaptor%3A%20%5BPATCH%5D%20Reroute%20errback%20to%20deferred%0A%09returned%20by%20search%28%29&In-Reply-To=%3CAANLkTin-NA%3DWKpYvT6jzCk4yxf2LCa3iHLyaEXUyrrwf%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Ldaptor: [PATCH] Reroute errback to deferred	returned by search()">anton at iki.fi
       </A><BR>
    <I>Wed Sep  1 05:52:06 MDT 2010</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="055291.html">[Twisted-Python] Ldaptor status and updates
</A></li>
        <LI>Next message (by thread): <A HREF="055294.html">[Twisted-Python] Ldaptor: [PATCH] Reroute errback to deferred returned by search()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55290">[ date ]</a>
              <a href="thread.html#55290">[ thread ]</a>
              <a href="subject.html#55290">[ subject ]</a>
              <a href="author.html#55290">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The LDAPEntryWithClient.search() method used to send the LDAP request with
a call like
	self.client.send_multiResponse(... )
send_multiResponse() returns a deferred that was just discarded. If the
operation causes an error then the errback fired on the discarded deferred
will remain unhandled. The deferred returned by search() will then not
have any errback fired and the caller of search() will be waiting forever.

This change adds an errback to the deferred returned by send_multiResponse()
and has the error rerouted to the errback chain of the deferred returned by
search().
---

Discussion: This hits right into the internals of Ldaptor and I am not
sure I understand this well enough to make an accurate fix. The
problem I encountered is real and can be reproduced, and this change
does seem to work around it.

Any comments and suggestions welcome!


 ldaptor/protocols/ldap/ldapsyntax.py |    7 ++++++-
 1 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/ldaptor/protocols/ldap/ldapsyntax.py
b/ldaptor/protocols/ldap/ldapsyntax.py
index f54d2f8..471ffa6 100644
--- a/ldaptor/protocols/ldap/ldapsyntax.py
+++ b/ldaptor/protocols/ldap/ldapsyntax.py
@@ -683,7 +683,7 @@ class LDAPEntryWithClient(entry.EditableLDAPEntry):
                 typesOnly=typesOnly,
                 filter=filterObject,
                 attributes=attributes)
-            self.client.send_multiResponse(
+            dsend = self.client.send_multiResponse(
                 op, self._cbSearchMsg,
                 d, cb, complete=not attributes,
                 sizeLimitIsNonFatal=sizeLimitIsNonFatal)
@@ -692,6 +692,11 @@ class LDAPEntryWithClient(entry.EditableLDAPEntry):
         else:
             if callback is None:
                 d.addCallback(lambda dummy: results)
+            def rerouteerr(e):
+                d.errback(e)
+                # returning None will stop the error
+                # from being propagated and logged.
+            dsend.addErrback(rerouteerr)
         return d

     def lookup(self, dn):
-- 
1.7.1.5.g49342


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="055291.html">[Twisted-Python] Ldaptor status and updates
</A></li>
	<LI>Next message (by thread): <A HREF="055294.html">[Twisted-Python] Ldaptor: [PATCH] Reroute errback to deferred returned by search()
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#55290">[ date ]</a>
              <a href="thread.html#55290">[ thread ]</a>
              <a href="subject.html#55290">[ subject ]</a>
              <a href="author.html#55290">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
