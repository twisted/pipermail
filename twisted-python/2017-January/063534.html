<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] How to get caller’s IP address in Perspective Broker server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%0A%20%3D%3Futf-8%3Fq%3FHow_to_get_caller%3DE2%3D80%3D99s_IP_address%3F%3D%0A%20%3D%3Futf-8%3Fq%3F_in_Perspective_Broker_server%3F%3D&In-Reply-To=%3CB6696D7F-9368-444F-AE7E-3218039318BC%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="063532.html">
   <LINK REL="Next"  HREF="063537.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] How to get caller’s IP address in Perspective Broker server</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%0A%20%3D%3Futf-8%3Fq%3FHow_to_get_caller%3DE2%3D80%3D99s_IP_address%3F%3D%0A%20%3D%3Futf-8%3Fq%3F_in_Perspective_Broker_server%3F%3D&In-Reply-To=%3CB6696D7F-9368-444F-AE7E-3218039318BC%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] How to get caller’s IP address in Perspective Broker server">glyph at twistedmatrix.com
       </A><BR>
    <I>Mon Jan 16 23:50:36 MST 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="063532.html">[Twisted-Python] How to get caller’s IP address in Perspective Broker server
</A></li>
        <LI>Next message (by thread): <A HREF="063537.html">[Twisted-Python] How to get caller’s IP address in Perspective Broker server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63534">[ date ]</a>
              <a href="thread.html#63534">[ thread ]</a>
              <a href="subject.html#63534">[ subject ]</a>
              <a href="author.html#63534">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Jan 16, 2017, at 6:15 AM, Роман Мещеряков &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">romanmescheryakov at yandex.ru</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hi everyone! I’m new to Twisted and mailing lists, so please excuse me if I make some mistake.
</I>
Hi Roman! Doing great so far, no mistakes I can see.

&gt;<i> My question maybe trivial, but as far as I know it is neither explained on the twistedmatrix.com web site nor easily resolved using Google search. The question is: how can Perspective Broker server get an IP address of the client the server is being called by? For example, let’s consider first PB server example on the Using Perspective Broker &lt;<A HREF="http://twistedmatrix.com/documents/current/core/howto/pb-usage.html">http://twistedmatrix.com/documents/current/core/howto/pb-usage.html</A>&gt; page, pbsimple.py. Inside remote_echo method of the Echoer class, how one could obtain IP address of a client that is calling this method?
</I>
This is a great question and really points to a weakness in the PB documentation.

&gt;<i> One of solutions I found in Google requires client to pass some pb.Referenceable object as a parameter to a call, and then server is able to get client’s IP address by calling broker.transport.getPeer().host on that object. But passing pb.Referenceable just for purpose of getting caller’s IP address seems not very convenient. Are there more simple way?
</I>
Yeah, adding a Referenceable argument is not really the right way to go; you don't want to have to expose a whole object and thereby change your network protocol just to get access to an object that's already present in the existing implementation.

What you need to do here is take advantage of the remoteMessageReceived method, <A HREF="https://twistedmatrix.com/documents/16.6.0/api/twisted.spread.pb.Referenceable.html#remoteMessageReceived">https://twistedmatrix.com/documents/16.6.0/api/twisted.spread.pb.Referenceable.html#remoteMessageReceived</A> &lt;<A HREF="https://twistedmatrix.com/documents/16.6.0/api/twisted.spread.pb.Referenceable.html#remoteMessageReceived">https://twistedmatrix.com/documents/16.6.0/api/twisted.spread.pb.Referenceable.html#remoteMessageReceived</A>&gt;, which is what actually calls the remote_ method for you.

The documentation isn't entirely clear, as it says it's calling the remote_ method with &quot;the same&quot; arguments, but if you look at the implementation, it is fairly straightforward:

<A HREF="https://github.com/twisted/twisted/blob/3257fbb3504329f603cc9b6e17442d913170b5d1/src/twisted/spread/flavors.py#L104-L124">https://github.com/twisted/twisted/blob/3257fbb3504329f603cc9b6e17442d913170b5d1/src/twisted/spread/flavors.py#L104-L124</A> &lt;<A HREF="https://github.com/twisted/twisted/blob/3257fbb3504329f603cc9b6e17442d913170b5d1/src/twisted/spread/flavors.py#L104-L124">https://github.com/twisted/twisted/blob/3257fbb3504329f603cc9b6e17442d913170b5d1/src/twisted/spread/flavors.py#L104-L124</A>&gt;

it deserializes the arguments, calls the method, and serializes the result.

Notice that in order to do this serializing and deserializing, it's called with the broker, which is the object that has the IP you want.  So you could override this method to do its own serialization and deserialization.  But, luckily enough, there's something very close to what you want already: ViewPoint, which already does the insertion-of-an-argument for you.  So here's a little hack which will insert 'broker' as the first argument and call a 'view_' method rather than a 'remote_' one:

from twisted.spread.flavors import Referenceable, ViewPoint
class BrokerizedReferenceable(Referenceable, object):
    def remoteMessageReceived(self, broker, message, args, kw):
        return (ViewPoint(broker, self)
                .remoteMessageReceived(broker, message, args, kw))


This is untested but hopefully it will be close enough to put you on your way.  Make sense?

-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20170116/3e9828ee/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="063532.html">[Twisted-Python] How to get caller’s IP address in Perspective Broker server
</A></li>
	<LI>Next message (by thread): <A HREF="063537.html">[Twisted-Python] How to get caller’s IP address in Perspective Broker server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63534">[ date ]</a>
              <a href="thread.html#63534">[ thread ]</a>
              <a href="subject.html#63534">[ subject ]</a>
              <a href="author.html#63534">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
