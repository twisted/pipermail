<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] treq POST abborting with: err: ('Could not adapt', '{&quot;....&quot;, &quot;...&quot;} &lt;InterfaceClass twisted.web.iweb.IBodyProducer&gt;)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20treq%20POST%20abborting%20with%3A%20err%3A%20%28%27Could%20not%0A%20adapt%27%2C%20%27%7B%22....%22%2C%20%22...%22%7D%20%3CInterfaceClass%20twisted.web.iweb.IBodyProducer%3E%29&In-Reply-To=%3C16164E31-CA06-4583-B514-1B87904EAA30%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031037.html">
   <LINK REL="Next"  HREF="031040.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] treq POST abborting with: err: ('Could not adapt', '{&quot;....&quot;, &quot;...&quot;} &lt;InterfaceClass twisted.web.iweb.IBodyProducer&gt;)</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20treq%20POST%20abborting%20with%3A%20err%3A%20%28%27Could%20not%0A%20adapt%27%2C%20%27%7B%22....%22%2C%20%22...%22%7D%20%3CInterfaceClass%20twisted.web.iweb.IBodyProducer%3E%29&In-Reply-To=%3C16164E31-CA06-4583-B514-1B87904EAA30%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] treq POST abborting with: err: ('Could not adapt', '{&quot;....&quot;, &quot;...&quot;} &lt;InterfaceClass twisted.web.iweb.IBodyProducer&gt;)">glyph at twistedmatrix.com
       </A><BR>
    <I>Sat Jan  7 16:57:15 MST 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="031037.html">[Twisted-Python] treq POST abborting with: err: ('Could not adapt', '{&quot;....&quot;, &quot;...&quot;} &lt;InterfaceClass twisted.web.iweb.IBodyProducer&gt;)
</A></li>
        <LI>Next message: <A HREF="031040.html">[Twisted-Python] treq POST abborting with: err: ('Could not adapt', '{&quot;....&quot;, &quot;...&quot;} &lt;InterfaceClass twisted.web.iweb.IBodyProducer&gt;)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31036">[ date ]</a>
              <a href="thread.html#31036">[ thread ]</a>
              <a href="subject.html#31036">[ subject ]</a>
              <a href="author.html#31036">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Jan 7, 2017, at 4:00 AM, Cory Benfield &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">cory at lukasa.co.uk</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> On 7 Jan 2017, at 02:18, Tristan Seligmann &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">mithrandi at mithrandi.net</A>&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Sat, 7 Jan 2017 at 03:23 Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Maybe we should support unicode for the body as well.  We can set the charset in the mime-type and everything so that it will be properly intelligible by the server, which doesn't happen if the user manually encodes like this.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Oh, forgot to comment on this point; in the specific case of JSON, it isn't necessary to specify UTF-8 in Content-Type[1], but for HTML or XML it's a pretty good idea. However, I'm not sure if it's possible to modify Content-Type in a generic fashion to make this sort of thing work; for example, &quot;Content-Type: application/octet-stream; charset=UTF-8&quot; is nonsense. I'll defer to some HTTP experts here ;)
</I>&gt;<i> 
</I>&gt;<i> This is really not simple, for the reason that many MIME types do not define a charset extension. In the case of JSON, it&#8217;s not just not necessary to specify UTF-8 in Content-Type, but the standard explicitly does not define charset for the JSON content type[0]:
</I>
I see you your standards pedantry, and raise you!

MIME defines content-type to always have a charset:

<A HREF="https://tools.ietf.org/html/rfc1521#section-4">https://tools.ietf.org/html/rfc1521#section-4</A> &lt;<A HREF="https://tools.ietf.org/html/rfc1521#section-4">https://tools.ietf.org/html/rfc1521#section-4</A>&gt;

&gt;&gt;&gt;<i> Among the defined parameters is a &quot;charset&quot; parameter by which the character set used in the body may be declared.
</I>
and from the spec you're citing,

&gt;&gt;&gt;<i> Adding one really has no effect on compliant recipients
</I>

Given that we'd always choose utf-8 anyway it would be fine.

&gt;&gt;<i> Note:  No &quot;charset&quot; parameter is defined for this registration. Adding one really has no effect on compliant recipients.
</I>&gt;<i> 
</I>&gt;<i> Strictly a completely compliant implementation would not emit charset details for content types that have no charset registration. Such a thing is pretty tricky to do. Knowing that, it&#8217;s probably best to YOLO your way though, or forbid unicode in bodies.
</I>
A bigger part of the problem here is that treq has no way of knowing that the characters you're sending are JSON at all, let alone what encoding you want them in.  So if we actually want to do MIME stuff, we'd probably want to have treq be the layer to call treq.dumps on the dict anyway, so that it knows what it's dealing with.  Automatic treatment of unicode would likely set the type to text/plain;charset=utf8.

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20170107/f9802b3d/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20170107/f9802b3d/attachment.html</A>&gt;
</PRE>











<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031037.html">[Twisted-Python] treq POST abborting with: err: ('Could not adapt', '{&quot;....&quot;, &quot;...&quot;} &lt;InterfaceClass twisted.web.iweb.IBodyProducer&gt;)
</A></li>
	<LI>Next message: <A HREF="031040.html">[Twisted-Python] treq POST abborting with: err: ('Could not adapt', '{&quot;....&quot;, &quot;...&quot;} &lt;InterfaceClass twisted.web.iweb.IBodyProducer&gt;)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31036">[ date ]</a>
              <a href="thread.html#31036">[ thread ]</a>
              <a href="subject.html#31036">[ subject ]</a>
              <a href="author.html#31036">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
