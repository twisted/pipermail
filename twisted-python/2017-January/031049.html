<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] understanding twisted, better error handling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20understanding%20twisted%2C%20better%20error%20handling&In-Reply-To=%3C1484011221.23369.31.camel%40yahoo.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031043.html">
   <LINK REL="Next"  HREF="031050.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] understanding twisted, better error handling</H1>
    <B>steven meiers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20understanding%20twisted%2C%20better%20error%20handling&In-Reply-To=%3C1484011221.23369.31.camel%40yahoo.de%3E"
       TITLE="[Twisted-Python] understanding twisted, better error handling">commercials24 at yahoo.de
       </A><BR>
    <I>Mon Jan  9 18:20:21 MST 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="031043.html">[Twisted-Python] treq POST abborting with: err: ('Could not adapt', '{&quot;....&quot;, &quot;...&quot;} &lt;InterfaceClass twisted.web.iweb.IBodyProducer&gt;)
</A></li>
        <LI>Next message: <A HREF="031050.html">[Twisted-Python] understanding twisted, better error handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31049">[ date ]</a>
              <a href="thread.html#31049">[ thread ]</a>
              <a href="subject.html#31049">[ subject ]</a>
              <a href="author.html#31049">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi,



i use twisted to send a web request over a proxy, this works over
treq.get(url, agent=myagent) without problems.

but in the process (started out with agent.request) i could not figure
out from what line of twisted code this error:

[Failure instance: Traceback (failure with no frames): &lt;class
'twisted.web._newclient.RequestGenerationFailed'&gt;:
[&lt;twisted.python.failure.Failure builtins.TypeError: sequence item 0:
expected a bytes-like object, str found&gt;]

came from.

btw, is there a way to have a debugger attached to twisted code that
shows what code is currently executed and has a step forward option?


the error does come up when you give agent.request a &quot;GET&quot; instead of a
b&quot;GET&quot;.


heres the test code:
from twisted.python.log import err
from twisted.web.client import ProxyAgent
from twisted.internet import reactor, defer
from twisted.internet.endpoints import TCP4ClientEndpoint
import treq

def display(response):
&#160;&#160;&#160;&#160;print(&quot;Received response&quot;)
&#160;&#160;&#160;&#160;print(response.content)


def err(failure):
&#160;&#160;&#160;&#160;print(failure)

def main():
&#160;&#160;&#160;&#160;endpoint = TCP4ClientEndpoint(reactor, &quot;223.25.102.186&quot;, 8080)
&#160;&#160;&#160;&#160;agent = ProxyAgent(endpoint)
&#160;&#160;&#160;&#160;d = agent.request(&quot;GET&quot;, bytes(&quot;<A HREF="http://somedomain.de">http://somedomain.de</A>&quot;, 'utf-8'))
&#160;&#160;&#160;&#160;d.addCallbacks(display)
&#160;&#160;&#160;&#160;d.addErrback(err)

if __name__ == &quot;__main__&quot;:
&#160;&#160;&#160;&#160;main()
&#160;&#160;&#160;&#160;reactor.run()


this code will produce this error:
[Failure instance: Traceback (failure with no frames): &lt;class
'twisted.web._newclient.RequestGenerationFailed'&gt;:
[&lt;twisted.python.failure.Failure builtins.TypeError: sequence item 0:
expected a bytes-like object, str found&gt;]

and some .py files with line numbers. none of which really are the
problem.



as it turns out, the &quot;GET&quot; as a string gets problematic here:
<A HREF="https://github.com/twisted/twisted/blob/twisted-16.6.0/src/twisted/web/">https://github.com/twisted/twisted/blob/twisted-16.6.0/src/twisted/web/</A>
_newclient.py#L651

requestLines.append(b' '.join([self.method, self.uri,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;b'HTTP/1.1\r\n']))


wouldnt it be better to have something like this:


try:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;requestLines.append(b' '.join([self.method, self.uri,
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;b'HTTP/1.1\r\n']))
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;except TypeError as e:
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;raise TypeError(&quot;could not join: &quot; + str(self.method) + &quot; &quot;
+ str(self.uri) + ' ' + 'HTTP/1.1\r\n' )




which will produce:
&lt;class 'twisted.python.failure.Failure'&gt; [Failure instance: Traceback:
&lt;class 'TypeError'&gt;: could not join: GET b'<A HREF="http://somedomain.de">http://somedomain.de</A>'
HTTP/1.1

to give the user a chance to find out what he did wrong?
...when he uses agent instead of treq for whatever reason.


</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031043.html">[Twisted-Python] treq POST abborting with: err: ('Could not adapt', '{&quot;....&quot;, &quot;...&quot;} &lt;InterfaceClass twisted.web.iweb.IBodyProducer&gt;)
</A></li>
	<LI>Next message: <A HREF="031050.html">[Twisted-Python] understanding twisted, better error handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31049">[ date ]</a>
              <a href="thread.html#31049">[ thread ]</a>
              <a href="subject.html#31049">[ subject ]</a>
              <a href="author.html#31049">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
