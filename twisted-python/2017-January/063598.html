<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] web client FileBodyProducer - transfer encoding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20web%20client%20FileBodyProducer%20-%20transfer%20encoding&In-Reply-To=%3CDB302537-C004-4CAA-9D5F-135F8989DDD9%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="063597.html">
   <LINK REL="Next"  HREF="063599.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] web client FileBodyProducer - transfer encoding</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20web%20client%20FileBodyProducer%20-%20transfer%20encoding&In-Reply-To=%3CDB302537-C004-4CAA-9D5F-135F8989DDD9%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] web client FileBodyProducer - transfer encoding">glyph at twistedmatrix.com
       </A><BR>
    <I>Mon Jan 30 19:01:25 MST 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="063597.html">[Twisted-Python] web client FileBodyProducer - transfer encoding
</A></li>
        <LI>Next message (by thread): <A HREF="063599.html">[Twisted-Python] web client FileBodyProducer - transfer encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63598">[ date ]</a>
              <a href="thread.html#63598">[ thread ]</a>
              <a href="subject.html#63598">[ subject ]</a>
              <a href="author.html#63598">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Jan 30, 2017, at 19:44, Kevin Mcintyre &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">kebin70 at gmail.com</A>&gt; wrote:
</I>&gt;<i> On Mon, Jan 30, 2017 at 4:59 PM, Jean-Paul Calderone &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On Mon, Jan 30, 2017 at 7:44 PM, Glyph Lefkowitz &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A> &lt;mailto:<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;&gt; wrote:
</I>&gt;<i> Gotcha.  I guess what I meant was that you shouldn't care about this at the application level, but you're talking about an operational concern, not an application-level concern.
</I>&gt;<i> 
</I>&gt;<i> Perhaps this should be a tunable on Agent somehow.  Can you file a ticket?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Well... It is sort of tuneable, as you implied earlier.
</I>&gt;<i> 
</I>&gt;<i> If you pass an IBodyProducer with a non-None length, Agent will send a Content-Length header - not use chunked Transfer-Encoding.  FileBodyProducer doesn't know how to determine the length of a StringIO, so you get chunked with this example.
</I>
Not quite true: FileBodyProducer does know how to compute the length of a StringIO, via seek():

&gt;&gt;&gt;<i> from twisted.web.client import FileBodyProducer
</I>&gt;&gt;&gt;<i> from io import BytesIO
</I>&gt;&gt;&gt;<i> from cStringIO import StringIO
</I>&gt;&gt;&gt;<i> FileBodyProducer(BytesIO(b&quot;some bytes&quot;)).length
</I>10L
&gt;&gt;&gt;<i> FileBodyProducer(StringIO(b&quot;some bytes&quot;)).length
</I>10

&gt;<i> If you write the JSON to a regular file and FileBodyProducer(open(the file)) you'll get a Content-Length request.  You could also write a new (trivial) IBodyProducer that does know how to compute the length of a StringIO.
</I>&gt;<i> 
</I>&gt;<i> The documentation doesn't exactly spell this out - but the only reason `length` is part of the interface is to be able to generate the Content-Length header.
</I>&gt;<i> 
</I>&gt;<i> What would the ticket be?  Expanded documentation to make this behavior into an explicit guarantee of the interface?  A new toggle somewhere to force Agent.request into one mode or the other (regardless of the performance consequences)?
</I>
Rather than &quot;regardless&quot; of the consequences, perhaps just a maximum body size.  If we made it an explicit guarantee in Agent, perhaps the interface change would not be in '.request' (which, as a formal interface used both inside and outside of Twisted, is fairly fixed), but rather a new `NonChunkedBodyProducer` concrete class that would implement IBodyProducer in terms of another IBodyProducer which either does or doesn't have a `length`.  (Or a function that does same, always returning its argument if `length` is already set...)

&gt;<i> And that stuff you said about proxies before was true ... So even if you can control this in Agent, you're still not guaranteed the server will see what you send.
</I>
&gt;<i> Thanks - that's exactly what I was looking for.
</I>&gt;<i> 
</I>&gt;<i> But note when using FileBodyProducer(StringIO(json.dumps(~blah))) -- I still see a content-length in the request header as it's received by twisted.  Am I correct to assume the request is agnostic...meaning it's shaped the same for twisted as it is for apache.
</I>
It is shaped the same.  The reason you're seeing the error is due to the issue I pointed out above.
&gt;<i> Headers({'host': ['localhost:8080'], 'connection': ['close'], 'content-length': ['671'], 'user-agent': ['PassengerTest']})
</I>&gt;<i> 
</I>
-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20170130/83115068/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="063597.html">[Twisted-Python] web client FileBodyProducer - transfer encoding
</A></li>
	<LI>Next message (by thread): <A HREF="063599.html">[Twisted-Python] web client FileBodyProducer - transfer encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63598">[ date ]</a>
              <a href="thread.html#63598">[ thread ]</a>
              <a href="subject.html#63598">[ subject ]</a>
              <a href="author.html#63598">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
