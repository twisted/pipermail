<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Testing Strategies (was Re:  Streaming Requests)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Testing%20Strategies%20%28was%20Re%3A%20%20Streaming%20Requests%29&In-Reply-To=%3C464CBB36-3247-4201-9BFB-7ADC2AF3D655%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="031042.html">
   <LINK REL="Next"  HREF="031047.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Testing Strategies (was Re:  Streaming Requests)</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Testing%20Strategies%20%28was%20Re%3A%20%20Streaming%20Requests%29&In-Reply-To=%3C464CBB36-3247-4201-9BFB-7ADC2AF3D655%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Testing Strategies (was Re:  Streaming Requests)">glyph at twistedmatrix.com
       </A><BR>
    <I>Mon Jan  9 02:52:29 MST 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="031042.html">[Twisted-Python] Streaming Requests
</A></li>
        <LI>Next message: <A HREF="031047.html">[Twisted-Python] Testing Strategies (was Re: Streaming Requests)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31046">[ date ]</a>
              <a href="thread.html#31046">[ thread ]</a>
              <a href="subject.html#31046">[ subject ]</a>
              <a href="author.html#31046">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Jan 8, 2017, at 4:34 PM, Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:
&gt;<i> 
</I>&gt;<i> Here's one example I know of off the top of my head, &lt;<A HREF="https://github.com/ScatterHQ/flocker/blob/master/flocker/restapi/testtools.py#L316">https://github.com/ScatterHQ/flocker/blob/master/flocker/restapi/testtools.py#L316</A> &lt;<A HREF="https://github.com/ScatterHQ/flocker/blob/master/flocker/restapi/testtools.py#L316">https://github.com/ScatterHQ/flocker/blob/master/flocker/restapi/testtools.py#L316</A>&gt;&gt;.  This one isn't a from-scratch re-implementation of the implicit Request interface but a Request subclass, instead.  However, it still interacts with a lot of important pieces of Request which aren't part of IRequest.
</I>
Mark already addressed how he won't be breaking this use-case (which is hugely important, and core to the whole idea of a compatibility policy, so that is as it should be).

However, this kind of test-mocking is, I think, ultimately done at the wrong layer.  It's trying to override some very vaguely-specified internals in the middle of an implementation.

Really, twisted.web should provide its own testing tools, of course.  But if you're going to implement something that does this sort of overriding, I think the idiom to follow would be treq.testing: <A HREF="https://github.com/twisted/treq/blob/fcf5deb976c955ca6ef6484f414d25839932940e/src/treq/testing.py">https://github.com/twisted/treq/blob/fcf5deb976c955ca6ef6484f414d25839932940e/src/treq/testing.py</A> &lt;<A HREF="https://github.com/twisted/treq/blob/fcf5deb976c955ca6ef6484f414d25839932940e/src/treq/testing.py">https://github.com/twisted/treq/blob/fcf5deb976c955ca6ef6484f414d25839932940e/src/treq/testing.py</A>&gt;, rather than any of the various implementations of DummyRequest (including more than a few I'm sure I've written).

Internally, treq.testing uses MemoryReactor and the (not-technically-public-but-it-really-should-be) iosim module.  Therefore the layer it's plugging in at is at the very well-defined interface between IAgent and IStreamClientEndpoint, and between HTTPChannel and Transport.  This gives the determinism and (most of the) speed of an in-memory implementation, but a great deal of the realism of a full-blown integration test.  In particular, it binds to the appropriate objects within Twisted and will throw deprecation warnings if their interfaces change.  (Also of note; since what it's building a fake for is really 99% Agent, the bulk of this could probably move up another level into Twisted with very little effort.)

I think following this idiom of pushing I/O through a fake reactor and having a back-end that can be controlled via test-specific APIs is probably what we should all be striving for, and in Twisted we should be working to make the memory-reactor stuff more complete and convenient, rather than adding dummy implementations at each layer of the stack.

This is a set of ideas that I've been gradually arriving at over a long period of time, but it's probably high time for some public discussion by now, even if it's just everybody saying &quot;yeah, that sounds good&quot; :-).

On a related note, 'proto_helpers' is in a super awkward place.  'twisted.testing', anyone? :)

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20170109/9557646e/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20170109/9557646e/attachment-0001.html</A>&gt;
</PRE>

















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="031042.html">[Twisted-Python] Streaming Requests
</A></li>
	<LI>Next message: <A HREF="031047.html">[Twisted-Python] Testing Strategies (was Re: Streaming Requests)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31046">[ date ]</a>
              <a href="thread.html#31046">[ thread ]</a>
              <a href="subject.html#31046">[ subject ]</a>
              <a href="author.html#31046">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
