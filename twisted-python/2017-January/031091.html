<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Problems with inlineCallback, Deferred,	yield and Python 3 in buildbot
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Problems%20with%20inlineCallback%2C%20Deferred%2C%0A%09yield%20and%20Python%203%20in%20buildbot&In-Reply-To=%3CCAG%3DrPVeqn3XHGu17uz5KruTHYPgHNH%3DgKyOojHiHnCnVJs9O8g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="063551.html">
   <LINK REL="Next"  HREF="063553.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Problems with inlineCallback, Deferred,	yield and Python 3 in buildbot</H1>
    <B>Craig Rodrigues</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Problems%20with%20inlineCallback%2C%20Deferred%2C%0A%09yield%20and%20Python%203%20in%20buildbot&In-Reply-To=%3CCAG%3DrPVeqn3XHGu17uz5KruTHYPgHNH%3DgKyOojHiHnCnVJs9O8g%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] Problems with inlineCallback, Deferred,	yield and Python 3 in buildbot">rodrigc at crodrigues.org
       </A><BR>
    <I>Sat Jan 21 19:15:45 MST 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="063551.html">[Twisted-Python] conch problem with ecdsa-sha2-nistp256 host	key?
</A></li>
        <LI>Next message (by thread): <A HREF="063553.html">[Twisted-Python] Problems with inlineCallback, Deferred, yield and Python 3 in buildbot
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31091">[ date ]</a>
              <a href="thread.html#31091">[ thread ]</a>
              <a href="subject.html#31091">[ subject ]</a>
              <a href="author.html#31091">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have been submitting many patches to get buildbot working on Python 3:

<A HREF="http://bit.ly/2jCCMPW">http://bit.ly/2jCCMPW</A>

I have run into one problem involving inlineCallback, Deferred, and yield
which I am having difficulty solving.  Can someone help me?

If I do the following inside a Python 3 virtualenv to set things up:

git clone <A HREF="https://github.com/buildbot/buildbot">https://github.com/buildbot/buildbot</A> buildbot_test
cd buildbot_test
pip install -e pkg
pip install -e worker
pip install -e 'master[tls,tests]'

trial buildbot.test.unit.test_process_buildrequestdistributor
I get this error:

==================================================================
  File
&quot;/Users/crodrigues/buildbot_test/master/buildbot/process/buildrequestdistributor.py&quot;,
line 93, in &lt;lambda&gt;^M
    brdicts.sort(key=lambda brd: brd['submitted_at'])
builtins.TypeError: 'Deferred' object is not subscriptable

buildbot.test.unit.test_process_buildrequestdistributor.TestMaybeStartBuilds.test_slow_db^M
==================================================================


The code causing this problem is on line 93 of
master/buildbot/process/buildrequestdistributor.py:

 78     @defer.inlineCallbacks
 79     def _fetchUnclaimedBrdicts(self):
 80         # Sets up a cache of all the unclaimed brdicts. The cache is
 81         # saved at self.unclaimedBrdicts cache. If the cache already
 82         # exists, this function does nothing. If a refetch is desired,
set
 83         # the self.unclaimedBrdicts to None before calling.&quot;&quot;&quot;
 84         if self.unclaimedBrdicts is None:
 85             # TODO: use order of the DATA API
 86             brdicts = yield self.master.data.get(('builders',
 87                                                   (yield
self.bldr.getBuilderId()),
 88                                                   'buildrequests'),
 89
 [resultspec.Filter('claimed',
 90
'eq',
 91
[False])])
 92             # sort by submitted_at, so the first is the oldest
 93             brdicts.sort(key=lambda brd: brd['submitted_at'])
 94             self.unclaimedBrdicts = brdicts
 95         defer.returnValue(self.unclaimedBrdicts)

If I run the test on Python 2, I don't get the error, and on line 93,
brdicts is a dict.
However, if I run the test on Python 3, brdicts is a Deferred, thus the
error.

Can someone point me in the right direction for solving this problem?

I am not so familiar with the differences in generators and Deferreds
between Python 2 and 3.

Thanks.

--
Craig
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20170121/bb273520/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20170121/bb273520/attachment.html</A>&gt;
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="063551.html">[Twisted-Python] conch problem with ecdsa-sha2-nistp256 host	key?
</A></li>
	<LI>Next message (by thread): <A HREF="063553.html">[Twisted-Python] Problems with inlineCallback, Deferred, yield and Python 3 in buildbot
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#31091">[ date ]</a>
              <a href="thread.html#31091">[ thread ]</a>
              <a href="subject.html#31091">[ subject ]</a>
              <a href="author.html#31091">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
