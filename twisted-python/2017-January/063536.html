<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted code works,	after importing it does not anymore
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20code%20works%2C%0A%09after%20importing%20it%20does%20not%20anymore&In-Reply-To=%3C1484654644.5985.3.camel%40yahoo.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="063528.html">
   <LINK REL="Next"  HREF="063506.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted code works,	after importing it does not anymore</H1>
    <B>steven meiers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20code%20works%2C%0A%09after%20importing%20it%20does%20not%20anymore&In-Reply-To=%3C1484654644.5985.3.camel%40yahoo.de%3E"
       TITLE="[Twisted-Python] twisted code works,	after importing it does not anymore">commercials24 at yahoo.de
       </A><BR>
    <I>Tue Jan 17 05:04:04 MST 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="063528.html">[Twisted-Python] Testing Strategies (was Re: Streaming Requests)
</A></li>
        <LI>Next message (by thread): <A HREF="063506.html">[Twisted-Python] Streaming Requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63536">[ date ]</a>
              <a href="thread.html#63536">[ thread ]</a>
              <a href="subject.html#63536">[ subject ]</a>
              <a href="author.html#63536">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi,



this websocket code works but now i would like to be able to import it
to another class to have a way to send messages without waiting for the
answer.

the code is below here and also pasted here: <A HREF="https://bpaste.net/show/78">https://bpaste.net/show/78</A>
36ba3b8008 for some nice syntax highlighting.


just running websockets.py works...sending and receiving messages.
importing does not, says:

builtins.AttributeError: 'MyClientProtocol' object has no attribute
'deferred'


any ideas why it does give me this error?



but since the code works on its own i dont see why it can be imported.

first code paste is the import test which fails, after that is the
error mesage and at the  end is the code (mywebsocket.py) that is to be
imported.



from mywebsocket import runIt
import sys
from autobahn.twisted.websocket import WebSocketClientProtocol, \
            WebSocketClientFactory
from mywebsocket import MyClientProtocol
from twisted.python import log
from twisted.internet import reactor

if __name__ == '__main__':
    log.startLogging(sys.stdout)

    factory = WebSocketClientFactory(u&quot;<A HREF="ws://127.0.0.1:8080/javaee7-">ws://127.0.0.1:8080/javaee7-</A>
websocket-chat/chat/arduino&quot;)
    factory.protocol = MyClientProtocol
    reactor.connectTCP(&quot;127.0.0.1&quot;, 8080, factory)

    d, factory = runIt()
    def test_sendMessage(result):
        print(&quot;test_sesndMessage():&quot;, result)
        factory.p.sendMessage('python client', 'very nice message')

    d.addCallback(test_sendMessage)
    reactor.run()






python testimport.py 
2017-01-17 12:57:43+0100 [-] Log opened.
2017-01-17 12:57:43+0100 [-] Starting factory
&lt;autobahn.twisted.websocket.WebSocketClientFactory object at
0x7fea4c21d358&gt;
2017-01-17 12:57:43+0100 [-] Starting factory &lt;mywebsocket.MyFactory
object at 0x7fea48a34b38&gt;
2017-01-17 12:57:43+0100 [-] Server connected: tcp4:127.0.0.1:8080
2017-01-17 12:57:43+0100 [-] WebSocket connection open.
2017-01-17 12:57:43+0100 [-] test_sesndMessage(): yep that worked
2017-01-17 12:57:43+0100 [-] Server connected: tcp4:127.0.0.1:8080
2017-01-17 12:57:43+0100 [-] WebSocket connection open.
2017-01-17 12:57:43+0100 [MyClientProtocol,client] Unhandled Error
	Traceback (most recent call last):
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-packages/twisted/python/log.py&quot;, line
103, in callWithLogger
	    return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-packages/twisted/python/log.py&quot;, line
86, in callWithContext
	    return context.call({ILogContext: newCtx}, func, *args,
**kw)
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-packages/twisted/python/context.py&quot;,
line 118, in callWithContext
	    return self.currentContext().callWithContext(ctx, func,
*args, **kw)
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-packages/twisted/python/context.py&quot;,
line 81, in callWithContext
	    return func(*args,**kw)
	--- &lt;exception caught here&gt; ---
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-packages/twisted/internet/posixbase.py&quot;, 
line 597, in _doReadOrWrite
	    why = selectable.doRead()
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-packages/twisted/internet/tcp.py&quot;, line
208, in doRead
	    return self._dataReceived(data)
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-packages/twisted/internet/tcp.py&quot;, line
214, in _dataReceived
	    rval = self.protocol.dataReceived(data)
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-packages/autobahn/twisted/websocket.py&quot;, 
line 132, in dataReceived
	    self._dataReceived(data)
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-
packages/autobahn/websocket/protocol.py&quot;, line 1183, in _dataReceived
	    self.consumeData()
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-
packages/autobahn/websocket/protocol.py&quot;, line 1212, in consumeData
	    self.processHandshake()
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-
packages/autobahn/websocket/protocol.py&quot;, line 3784, in
processHandshake
	    self._onOpen()
	  File &quot;/home/julius/code/python/twisted/webchat-
client/venv/lib/python3.5/site-packages/autobahn/twisted/websocket.py&quot;, 
line 142, in _onOpen
	    self.onOpen()
	  File &quot;/home/julius/code/python/twisted/webchat-
client/mywebsocket.py&quot;, line 18, in onOpen
	    self.deferred.callback('yep that worked')
	builtins.AttributeError: 'MyClientProtocol' object has no
attribute 'deferred'
	
2017-01-17 12:57:43+0100 [-] WebSocket connection closed: connection
was closed uncleanly (peer dropped the TCP connection without previous
WebSocket closing handshake)
2017-01-17 12:57:43+0100 [-] Stopping factory
&lt;autobahn.twisted.websocket.WebSocketClientFactory object at
0x7fea4c21d358&gt;
2017-01-17 12:57:43+0100 [-] Text message received: {&quot;message&quot;:&quot;very
nice message&quot;,&quot;sender&quot;:&quot;python client&quot;,&quot;received&quot;:&quot;Tue Jan 17 12:57:43
CET 2017&quot;}
^C2017-01-17 12:57:44+0100 [-] Received SIGINT, shutting down.
2017-01-17 12:57:44+0100 [-] WebSocket connection closed: connection
was closed uncleanly (peer dropped the TCP connection without previous
WebSocket closing handshake)
2017-01-17 12:57:44+0100 [-] Stopping factory &lt;mywebsocket.MyFactory
object at 0x7fea48a34b38&gt;
2017-01-17 12:57:44+0100 [-] Main loop terminated.







mywebsocket.py
from autobahn.twisted.websocket import WebSocketClientProtocol, \
    WebSocketClientFactory
import sys

from twisted.python import log
from twisted.internet import reactor, defer

import json

class MyClientProtocol(WebSocketClientProtocol):

    def onConnect(self, response):
        tmp = &quot;Server connected: {0}&quot;.format(response.peer)
        print(tmp)

    def onOpen(self):
        print(&quot;WebSocket connection open.&quot;)
        self.deferred.callback('yep that worked')

        def hello():
            print(&quot;sending message&quot;)
            message = json.dumps({&quot;message&quot;:&quot;1&quot; ,&quot;sender&quot;:&quot;2&quot;,
&quot;received&quot;:&quot;3&quot;}).encode('utf-8')

            
            self.sendMessage(message)
            self.factory.reactor.callLater(10, hello)


    def sendMessage(self, sender, message):
        message = json.dumps({&quot;message&quot;: message, &quot;sender&quot;: sender,
&quot;received&quot;: &quot;notusedyet&quot;})
        super(MyClientProtocol, self).sendMessage(message.encode('utf-
8'))

    def onMessage(self, payload, isBinary):
        if isBinary:
            print(&quot;Binary message received: {0}
bytes&quot;.format(len(payload)))
        else:
            print(&quot;Text message received:
{0}&quot;.format(payload.decode('utf8')))

    def onClose(self, wasClean, code, reason):
        print(&quot;WebSocket connection closed: {0}&quot;.format(reason))




class MyFactory(WebSocketClientFactory):

    def __init__(self, deferred, *args, **kwargs):
        self.d = deferred
        super(MyFactory, self).__init__(*args, **kwargs)

    def buildProtocol(self, addr):
        p = super(MyFactory, self).buildProtocol(addr)
        self.p = p
        p.deferred = self.d
        return p



def runIt():
    log.startLogging(sys.stdout)


    d = defer.Deferred()

    factory = MyFactory(d, u&quot;<A HREF="ws://127.0.0.1:8080/javaee7-websocket-">ws://127.0.0.1:8080/javaee7-websocket-</A>
chat/chat/arduino&quot;)


    factory.protocol = MyClientProtocol
    
    def test_sendMessage(result):
        print(&quot;test_sesndMessage():&quot;, result)
        factory.p.sendMessage('python client', 'very nice message')

    reactor.connectTCP(&quot;127.0.0.1&quot;, 8080, factory)
    return (d, factory)


if __name__ == '__main__':
    runIt()
    reactor.run()


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="063528.html">[Twisted-Python] Testing Strategies (was Re: Streaming Requests)
</A></li>
	<LI>Next message (by thread): <A HREF="063506.html">[Twisted-Python] Streaming Requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#63536">[ date ]</a>
              <a href="thread.html#63536">[ thread ]</a>
              <a href="subject.html#63536">[ subject ]</a>
              <a href="author.html#63536">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
