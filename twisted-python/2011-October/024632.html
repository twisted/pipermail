<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted as windows service
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20twisted%20as%20windows%20service&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024630.html">
   <LINK REL="Next"  HREF="024634.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted as windows service</H1>
    <B>John Aherne</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20twisted%20as%20windows%20service&In-Reply-To="
       TITLE="[Twisted-Python] twisted as windows service">johnaherne at rocs.co.uk
       </A><BR>
    <I>Tue Oct 11 07:10:09 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="024630.html">[Twisted-Python] Proposed new homepage
</A></li>
        <LI>Next message: <A HREF="024634.html">[Twisted-Python] Boston Twisted Sprint: Last-Minute October Edition
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24632">[ date ]</a>
              <a href="thread.html#24632">[ thread ]</a>
              <a href="subject.html#24632">[ subject ]</a>
              <a href="author.html#24632">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have been looking for some info on running twisted as a Windows Service.

I have found various examples in mailing-lists and blogs that vary in what
seem to be important respects.

I have included them below as 3 examples.

The problem I have is working out which scheme or combination I should be
adopting.
I have tried out some of the options and they appear to work. But I need
something better than seems to work.

My gut reaction is that I should be putting all my imports into SvcDoRun,
since they will be used in the thread.

But if I import the reactor in SvcDoRun, should I be
using reactor.callfromthread(reactor.stop). I think not

I think the use of waitforobject is the right thing to do as well without
fully understanding it at the moment.

If anyone can throw some light on what to do I shall be very grateful.

It could be that I should post this question to python-windows mailing
list since it seems to me more pertinent to windows than twisted.

Thanks for any info.

John Aherne

Here is 1st example.

The reactor is imported globally not in SvcDoRun
It uses the waitforobject to detect stopping the service
The reactor.stop is calledfromthread


[Twisted-Python] How to run Twisted as a service in Windows?

Thomas Jacob jacob at internet24.de
Wed Aug 9 10:49:30 EDT 2006
Previous message: [Twisted-Python] How to run Twisted as a service in
Windows?
Next message: [Twisted-Python] How to run Twisted as a service in Windows?
Messages sorted by: [ date ] [ thread ] [ subject ] [ author ]
AFAIK, twistd doesn't provide direct support for Windows Services yet
(Is this planned?).

But you can easily wrap a reactor,run() yourself by doing something
like the following using the Win32-Python packages

import win32serviceutil
import win32service
import win32event

from twisted.internet import reactor

import sys


class IMSAgentBase(win32serviceutil.ServiceFramework):
    _svc_name_ = &quot;myService&quot;
    _svc_display_name_ = &quot;My little Service&quot;
    _svc_description_ = &quot;My little Service&quot; # Win2k or later
    _svc_deps_ = [&quot;RpcSs&quot;] # Start after the Network has come up...

    def __init__(self, args):
        win32serviceutil.ServiceFramework.__init__(self, args)
        self.hWaitStop = win32event.CreateEvent(None, 0, 0, None)

    def SvcStop(self):
        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
        reactor.callFromThread(reactor.stop)
        win32event.SetEvent(self.hWaitStop)

    def SvcDoRun(self):

        # initialize your services here
        reactor.run()
        win32event.WaitForSingleObject(self.hWaitStop,win32event.INFINITE)

def HandleCommandLine(cls):
    win32serviceutil.HandleCommandLine(cls)


Run the above as a script.


Here is the 2nd example.

The imports are global not in SvcDoRun

And the reactor .stop is not called from thread.

And the wait for stop event is in a timeout loop

It uses waitforobject events

It sets installsignalhandlers to 0

 You can then test it out with the sample Echo client from the core docs.

 &quot;&quot;&quot;qotdservice.py
 Sample Twisted Windows Service
 &quot;&quot;&quot;

 # Service Utilities
 import win32serviceutil
 import win32service
 import win32event

 # Twisted imports
 from twisted.internet.protocol import Protocol, Factory
 from twisted.internet import reactor

 class QOTD(Protocol):

     def connectionMade(self):
         self.transport.write(&quot;An apple a day keeps the doctor away\r\n&quot;)
         self.transport.loseConnection()


 class WindowsService(win32serviceutil.ServiceFramework):
     _svc_name_ = &quot;TwistedWin32Service&quot;
     _svc_display_name_ = &quot;Twisted Win32 Service&quot;

     def __init__(self, args):
         win32serviceutil.ServiceFramework.__init__(self, args)
         self.hWaitStop = win32event.CreateEvent(None, 0, 0, None)

     def SvcStop(self):
         self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
         win32event.SetEvent(self.hWaitStop)

     def SvcDoRun(self):
         import servicemanager

         self.CheckForQuit()

         factory = Factory()
         factory.protocol = QOTD

         reactor.listenTCP(8007, factory)
         reactor.run(installSignalHandlers=0)


     def CheckForQuit(self):
         retval = win32event.WaitForSingleObject(self.hWaitStop, 10)
         if not retval == win32event.WAIT_TIMEOUT:
             # Received Quit from Win32
             reactor.stop()

         reactor.callLater(1.0, self.CheckForQuit)

 if __name__=='__main__':
     win32serviceutil.HandleCommandLine(WindowsService)


Here is  the 3rd example.

The imports are done in SvcDoRun.
There is no callfrom thread
It does not use the waitforobject

import sys, os
import win32serviceutil, win32service

class MyService(win32serviceutil.ServiceFramework):
    &quot;&quot;&quot;NT Service.&quot;&quot;&quot;

    _svc_name_ = &quot;MyService&quot;
    _svc_display_name_ = &quot;MyService server&quot;

    def SvcDoRun(self):
        import server
        f = open(os.path.join(server.rootPath, &quot;cyberhigh.log&quot;), 'a')
        from twisted.python.log import startLogging
        from twisted.application.app import startApplication
        from twisted.internet import reactor
        startLogging(f)
        startApplication(server.application, 0)
        reactor.run()

    def SvcStop(self):
        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
        from twisted.internet import reactor
        reactor.stop()

if __name__ == '__main__':&lt;/pre&gt;
    win32serviceutil.HandleCommandLine(MyService)&lt;/pre&gt;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20111011/7eb72b38/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20111011/7eb72b38/attachment.htm</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="024630.html">[Twisted-Python] Proposed new homepage
</A></li>
	<LI>Next message: <A HREF="024634.html">[Twisted-Python] Boston Twisted Sprint: Last-Minute October Edition
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24632">[ date ]</a>
              <a href="thread.html#24632">[ thread ]</a>
              <a href="subject.html#24632">[ subject ]</a>
              <a href="author.html#24632">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
