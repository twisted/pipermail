<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] distutils and twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20distutils%20and%20twisted&In-Reply-To=%3C20021108111648.GE7335%40calvin.fayauffre.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="034752.html">
   <LINK REL="Next"  HREF="034740.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] distutils and twisted</H1>
    <B>Alexandre Fayolle</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20distutils%20and%20twisted&In-Reply-To=%3C20021108111648.GE7335%40calvin.fayauffre.org%3E"
       TITLE="[Twisted-Python] distutils and twisted">alexandre.fayolle at free.fr
       </A><BR>
    <I>Fri Nov  8 04:16:49 MST 2002</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="034752.html">[Twisted-Python] distutils and twisted
</A></li>
        <LI>Next message (by thread): <A HREF="034740.html">[Twisted-Python] distutils and twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34758">[ date ]</a>
              <a href="thread.html#34758">[ thread ]</a>
              <a href="subject.html#34758">[ subject ]</a>
              <a href="author.html#34758">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Nov 06, 2002 at 07:22:21PM +0100, Alexandre Fayolle wrote:
&gt;<i> IMNSHO, having a module
</I>&gt;<i> twisted.python.distutils with a custom setup aware of tml files would be
</I>&gt;<i> a nice thing to have for module developers (and I'm a bit surprised that
</I>&gt;<i> no such beast exists). I'll hack something, and submit it to the mailing
</I>&gt;<i> list if I'm happy enough with it.  
</I>
Well, here's an attempt. The documentation is in the module docstring.
Feel free to add it to the twisted distribution if you think it's ok.
If you need more features, please ask. If you find bugs, please tell me.

-- 
Alexandre
-------------- next part --------------
&quot;&quot;&quot;Distutils extensions for twisted framework.

This module enables the installation of plugins.tml files using standard
distutils syntax. It adds the following commands to the standard
setup.py commands:
* build_twisted_plugins: build (i.e. copy) plugins
* install_twisted_plugins: install plugins

Additionally, the following commands have been modified to deal with
plugins files:
 * sdist
 * build
 * install

To use these extenstion, you should import the setup fonction from this
module, and use it normally. To list the plugins.tml files, use the
twisted_plugins keyword argument to the setup function:

from twisted_distutils import setup # you can also import Extension if needed

if __name__ == '__main__':
    setup(name='my_twisted_app',
          version='1.0',
          author='me',
          packages=['my_package'],
          twisted_plugins = ['my_package/plugins.tml'])

Note that you can use this to install files that are not twisted plugins in any package directory of your application.
&quot;&quot;&quot;
#
# (c) 2002 Alexandre Fayolle &lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">alexandre.fayolle at free.fr</A>&gt;
# This module is heavily based on code copied from the python distutils
# framework, especially distutils.command.build_script,
# distutils.command.install_script. Many thanks to the authors of these
# modules.
# This module is provided as is, I'm not responsible if anything bad
# happens to you or your python library while using this module. You may
# freely copy it, distribute it and use it in your library or to distribute
# your applications. I'd appreciate if you could drop me an email if you plan
# to do so &lt;wink&gt;.
#
# Happy twisting!
#

from distutils.core import Extension,Distribution,Command
from distutils.command.install import install
from distutils.command.build import build
from distutils.command.sdist import sdist
from distutils.dep_util import newer
from distutils.util import convert_path
import os

class twisted_sdist(sdist):
    def add_defaults(self):
        sdist.add_defaults(self)
        if self.distribution.has_twisted_plugins():
            build_twisted_plugins = self.get_finalized_command('build_twisted_plugins')
            self.filelist.extend(build_twisted_plugins.get_source_files())

class twisted_install(install):
    def initialize_options (self):
        install.initialize_options(self)
        self.twisted_plugins = None
        
    def has_twisted_plugins(self):
        print '$'*50,self.distribution.has_twisted_plugins()
        return self.distribution.has_twisted_plugins()
    
    sub_commands = []
    sub_commands.extend(install.sub_commands)
    sub_commands.append(('install_twisted_plugins', has_twisted_plugins))
                   

class twisted_build(build):
    def initialize_options (self):
        build.initialize_options(self)
        self.twisted_plugins = None
        
    def has_twisted_plugins(self):
        print '#'*50,self.distribution.has_twisted_plugins()
        return self.distribution.has_twisted_plugins()
    
    sub_commands = []
    sub_commands.extend(build.sub_commands)
    sub_commands.append(('build_twisted_plugins', has_twisted_plugins))
    print '#'*50
    print sub_commands
    print '#'*50

class build_twisted_plugins (Command):

    description = &quot;\&quot;build\&quot; twisted plugins (copy)&quot;

    user_options = [
        ('build-dir=', 'd', &quot;directory to \&quot;build\&quot; (copy) to&quot;),
        ('force', 'f', &quot;forcibly build everything (ignore file timestamps&quot;),
        ]

    boolean_options = ['force']


    def initialize_options (self):
        self.build_dir = None
        self.twisted_plugins = None
        self.force = None
        self.outfiles = None

    def get_source_files(self):
        return self.twisted_plugins

    def finalize_options (self):
        self.set_undefined_options('build',
                                   ('build_lib', 'build_dir'),
                                   ('force', 'force'))
        self.twisted_plugins = self.distribution.twisted_plugins


    def run (self):
        if not self.twisted_plugins:
            return
        self.copy_twisted_plugins()


    def copy_twisted_plugins (self):
        &quot;&quot;&quot;Copy each plugin listed in 'self.twisted_plugins'.
        &quot;&quot;&quot;
        self.mkpath(self.build_dir)
        for plugin in self.twisted_plugins:
            adjust = 0
            print '*'*80
            print plugin
            plugin = convert_path(plugin)
            print plugin
            print self.build_dir,os.path.basename(plugin)
            outfile = os.path.join(self.build_dir, plugin)
            print outfile
            print '*'*80
            if not self.force and not newer(plugin, outfile):
                self.announce(&quot;not copying %s (up-to-date)&quot; % plugin)
                continue

            # Always open the file, but ignore failures in dry-run mode --
            # that way, we'll get accurate feedback if we can read the
            # plugin.
            try:
                f = open(plugin, &quot;r&quot;)
            except IOError:
                if not self.dry_run:
                    raise
                f = None
            else:
                f.close()
                self.copy_file(plugin, outfile)


class install_twisted_plugins(Command):

    description = &quot;install twisted plugins&quot;

    user_options = [
        ('install-dir=', 'd', &quot;directory to install scripts to&quot;),
        ('build-dir=','b', &quot;build directory (where to install from)&quot;),
        ('force', 'f', &quot;force installation (overwrite existing files)&quot;),
        ('skip-build', None, &quot;skip the build steps&quot;),
    ]

    boolean_options = ['force', 'skip-build']


    def initialize_options (self):
        self.install_dir = None
        self.force = 0
        self.build_dir = None
        self.skip_build = None

    def finalize_options (self):
        self.set_undefined_options('build', ('build_lib', 'build_dir'))
        self.set_undefined_options('install',
                                   ('install_lib', 'install_dir'),
                                   ('force', 'force'),
                                   ('skip_build', 'skip_build'),
                                  )

    def run (self):
        if not self.skip_build:
            self.run_command('build_twisted_plugins')
        self.outfiles = self.copy_tree(self.build_dir, self.install_dir)

    def get_inputs (self):
        return self.distribution.twisted_plugins or []

    def get_outputs(self):
        return self.outfiles or []
        
    

class TwistedDistribution(Distribution):
    def __init__(self,attrs=None):
        self.twisted_plugins = None
        Distribution.__init__(self,attrs)
        self.cmdclass = {'install':twisted_install,
                         'install_twisted_plugins':install_twisted_plugins,
                         'build':twisted_build,
                         'build_twisted_plugins':build_twisted_plugins,
                         'sdist':twisted_sdist,
                         }

    def has_twisted_plugins(self):
        return self.twisted_plugins and len(self.twisted_plugins) &gt; 0


def setup(**attrs):
    from distutils.core import setup
    attrs['distclass'] = TwistedDistribution
    setup(**attrs)
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 241 bytes
Desc: not available
URL: &lt;/pipermail/twisted-python/attachments/20021108/bc82ccca/attachment.sig&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="034752.html">[Twisted-Python] distutils and twisted
</A></li>
	<LI>Next message (by thread): <A HREF="034740.html">[Twisted-Python] distutils and twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#34758">[ date ]</a>
              <a href="thread.html#34758">[ thread ]</a>
              <a href="subject.html#34758">[ subject ]</a>
              <a href="author.html#34758">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
