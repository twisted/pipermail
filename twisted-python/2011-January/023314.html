<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] client connecting to 2	servers	(nonsimultaneously)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20client%20connecting%20to%202%0A%09servers%09%28nonsimultaneously%29&In-Reply-To=AANLkTi%3DZ1SQxBChZKOOyyLpaf8fhcp8RkWFJviYhPrMO%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023313.html">
   <LINK REL="Next"  HREF="023315.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] client connecting to 2	servers	(nonsimultaneously)</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20client%20connecting%20to%202%0A%09servers%09%28nonsimultaneously%29&In-Reply-To=AANLkTi%3DZ1SQxBChZKOOyyLpaf8fhcp8RkWFJviYhPrMO%40mail.gmail.com"
       TITLE="[Twisted-Python] client connecting to 2	servers	(nonsimultaneously)">exarkun at twistedmatrix.com
       </A><BR>
    <I>Wed Jan 12 16:40:17 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023313.html">[Twisted-Python] client connecting to 2 servers	(nonsimultaneously)
</A></li>
        <LI>Next message: <A HREF="023315.html">[Twisted-Python] client connecting to 2 servers	(nonsimultaneously)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23314">[ date ]</a>
              <a href="thread.html#23314">[ thread ]</a>
              <a href="subject.html#23314">[ subject ]</a>
              <a href="author.html#23314">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 06:45 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jrennie at gmail.com</A> wrote:
&gt;<i>On Wed, Jan 12, 2011 at 11:32 AM, Glyph Lefkowitz
</I>&gt;<i>&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt;wrote:
</I>&gt;&gt;<i>The reactor doesn't have a queue of tasks to be completed.  It has 
</I>&gt;&gt;<i>sets of
</I>&gt;&gt;<i>various event sources, which it executes in no particular order.
</I>&gt;<i>
</I>&gt;<i>&quot;queue of tasks&quot; was a guess on my part, but I looked through the
</I>&gt;<i>BaseReactor code and found something like that.  'course, I could 
</I>&gt;<i>easily be
</I>&gt;<i>reading the code wrong.  How would you describe threadCallQueue?  When 
</I>&gt;<i>I
</I>&gt;<i>said &quot;tasks&quot;, I meant something akin to &quot;calls&quot;.  That could be
</I>&gt;<i>confusing---did you interpret &quot;tasks&quot; differently?
</I>&gt;&gt;<i>Scheduling a timed event with callLater(0,...) might do what you want,
</I>&gt;&gt;<i>though.
</I>&gt;<i>
</I>&gt;<i>Yes.  Thanks!  I see that the callFromThread documentation even 
</I>&gt;<i>recommends
</I>&gt;<i>using callLater for this behavior. (doh!)
</I>&gt;<i>
</I>&gt;<i><A HREF="http://twistedmatrix.com/documents/10.2.0/api/twisted.internet.interfaces.IReactorThreads.html#callFromThread">http://twistedmatrix.com/documents/10.2.0/api/twisted.internet.interfaces.IReactorThreads.html#callFromThread</A>
</I>&gt;&gt;&gt;&gt;<i>from twisted.internet import reactor
</I>&gt;&gt;&gt;&gt;<i>def foo():
</I>&gt;<i>...     print &quot;foo!&quot;
</I>&gt;<i>...
</I>&gt;&gt;&gt;&gt;<i>def bar():
</I>&gt;<i>...     reactor.callLater(0, foo)
</I>&gt;<i>...     print &quot;bar!&quot;
</I>&gt;<i>...
</I>&gt;&gt;&gt;&gt;<i>reactor.callWhenRunning(bar)
</I>&gt;<i>('startup', ('after', &lt;function bar at 0x2c84320&gt;, (), {}))
</I>&gt;&gt;&gt;&gt;<i>reactor.run()
</I>&gt;<i>bar!
</I>&gt;<i>foo!
</I>&gt;<i>
</I>&gt;<i>Interesting that you can substitute callFromThread for callLater(0, 
</I>&gt;<i>...) in
</I>&gt;<i>the above code and get the same behavior...
</I>&gt;<i>
</I>&gt;<i>Sorry to prolong the tangent, but I'd like to better understand the
</I>&gt;<i>differences between callWhenRunning, callFromThread and callLater.  I 
</I>&gt;<i>think
</I>&gt;<i>reactor.wakeUp() is the one missing piece for me.  How exactly does it 
</I>&gt;<i>work?
</I>&gt;<i>Reading the BaseReactor code... callFromThread adds the call to a 
</I>&gt;<i>queue,
</I>&gt;<i>then calls wakeUp.  IIUC, wakeUp simply runs
</I>&gt;<i>
</I>&gt;<i>self.port.postEvent(0, KEY_WAKEUP, None)
</I>
Some reactors have a different implementation of wakeUp than the above, 
but they all have the same goal.

The reactor thread may be doing something which is going to block 
indefinitely (WaitForMultipleObjects, select(), epoll_wait(), etc).  The 
purpose of the wakeUp call is to cause that blocking call to end.  Once 
it ends, calls in the threadCallQueue can be processed.

The reactor is written such that if you are running code in the same 
thread it is running in (ie, you are &quot;in the reactor thread&quot;) then any 
event source you create (be it network or time or whatever), the reactor 
will be sure to service it in a timely manner.  For network event 
sources, this means it will include a descriptor in the select() (etc) 
call.  For timing event sources (ie callLater), it means the reactor 
will set a timeout on the select() (etc) call so that it returns before 
it is time for that delayed call to execute.

However, if you are not in the reactor thread, then really the only 
thing you're allowed to do to Twisted is use reactor.callFromThread. 
Since this might happen at any time with respect to what the reactor 
thread is doing, there's no way to be sure a (let's call it a) thread 
call event will get handled in a timely fashion.  So this is the problem 
that wakeUp solves.  After the thread call event is added to 
threadCallQueue, wakeUp makes some event source the reactor is 
monitoring signal readiness (on POSIX, it writes a byte to a pipe the 
reactor is select()ing (etc) on; on Windows, it posts an event like you 
pasted above).  This ensures that if the reactor is asleep waiting for 
an event it will wake up soon, and then it will notice there are thread 
call events to process.

Jean-Paul

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023313.html">[Twisted-Python] client connecting to 2 servers	(nonsimultaneously)
</A></li>
	<LI>Next message: <A HREF="023315.html">[Twisted-Python] client connecting to 2 servers	(nonsimultaneously)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23314">[ date ]</a>
              <a href="thread.html#23314">[ thread ]</a>
              <a href="subject.html#23314">[ subject ]</a>
              <a href="author.html#23314">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
