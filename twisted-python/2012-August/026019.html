<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Using Deferred.called to distinguish between synchronous and asynchronous result
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Using%20Deferred.called%20to%20distinguish%20between%0A%20synchronous%20and%20asynchronous%20result&In-Reply-To=CAFUtXGyNqUkxqAa4tBb8%3DD73-S_Z1ec5FP%2B29ceExoEyC0h-sg%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026018.html">
   <LINK REL="Next"  HREF="026020.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Using Deferred.called to distinguish between synchronous and asynchronous result</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Using%20Deferred.called%20to%20distinguish%20between%0A%20synchronous%20and%20asynchronous%20result&In-Reply-To=CAFUtXGyNqUkxqAa4tBb8%3DD73-S_Z1ec5FP%2B29ceExoEyC0h-sg%40mail.gmail.com"
       TITLE="[Twisted-Python] Using Deferred.called to distinguish between synchronous and asynchronous result">exarkun at twistedmatrix.com
       </A><BR>
    <I>Wed Aug 29 16:52:15 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="026018.html">[Twisted-Python] Using Deferred.called to distinguish between synchronous and asynchronous result
</A></li>
        <LI>Next message: <A HREF="026020.html">[Twisted-Python] Using Deferred.called to distinguish between synchronous and asynchronous result
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26019">[ date ]</a>
              <a href="thread.html#26019">[ thread ]</a>
              <a href="subject.html#26019">[ subject ]</a>
              <a href="author.html#26019">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 07:53 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">wasilak at gmail.com</A> wrote:
&gt;<i>Hello,
</I>&gt;<i>
</I>&gt;<i>I am implementing UDP-based protocol in Twisted (CoAP) which allows two
</I>&gt;<i>behaviors when answering requests:
</I>&gt;<i>
</I>&gt;<i>1. If response is immediately available - send acknowledgement and 
</I>&gt;<i>response
</I>&gt;<i>in a single datagram (piggyback response)
</I>&gt;<i>2. If response needs to be fetched or prepared - send datagram with
</I>&gt;<i>acknowledgement, and then send another datagram with a response 
</I>&gt;<i>(separate
</I>&gt;<i>response)
</I>&gt;<i>
</I>&gt;<i>(I think behavior #1 is called synchronous in most Twisted tutorials, 
</I>&gt;<i>and
</I>&gt;<i>behavior #2 is called asynchronous.)
</I>&gt;<i>
</I>&gt;<i>When programmer is implementing his application on top of CoAP 
</I>&gt;<i>protocol, he
</I>&gt;<i>or she needs to choose how his request handler is going to behave. I 
</I>&gt;<i>would
</I>&gt;<i>like to handle both behaviors in the same manner - by forcing every
</I>&gt;<i>user-written request handler to return Deferred. Then I would
</I>&gt;<i>check Deferred.called parameter.
</I>&gt;<i>1. If True - callback will execute immediately and send proper 
</I>&gt;<i>ACK+Response
</I>&gt;<i>(that means request handler used defer.succeed() or somethin similar)
</I>&gt;<i>2. If False I send empty ACK, and wait for callback to send Response
</I>&gt;<i>
</I>&gt;<i>code:
</I>&gt;<i>def respond(request):
</I>&gt;<i>        d = requestHandler(request)
</I>&gt;<i>        if d.called is False:
</I>&gt;<i>            sendEmptyAck()
</I>&gt;<i>        d.addCallback(sendResponse)
</I>&gt;<i>
</I>&gt;<i>I assume that sendResponse can send either ACK+RSP, or only RSP.
</I>&gt;<i>
</I>&gt;<i>I would like to ask if this is a proper approach?
</I>
This isn't the right way to go.  The `called` attribute is set to `True` 
as soon as `Deferred.callback` is called.  This might sound like it's 
what you want, but only if you disregard the chaining feature of 
Deferreds, where a callback on the Deferred might return a *new* unfired 
Deferred.  Now your original Deferred has `called` set to `True` but you 
don't actually have a result yet.

Instead, there are two obvious options:

  1. Allow the application to return a non-Deferred result.  Use 
`isinstance` to detect this case and do the synchronous send when you 
see a non-Deferred come back.  Send the empty ACK and ultimately the 
result in the other case.

  2. Change your empty ACK logic to be time-based instead.  Say, if the 
application doesn't produce a result within 10 milliseconds, send the 
empty ACK.  Implement this using `reactor.callLater` and 
`IDelayedCall.cancel`.  You'll set up a delayed call to send the empty 
ACK every time you call application code, but in the callback on the 
application's Deferred, you'll cancel that call (unless it has already 
happened).

Hope this helps,
Jean-Paul

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="026018.html">[Twisted-Python] Using Deferred.called to distinguish between synchronous and asynchronous result
</A></li>
	<LI>Next message: <A HREF="026020.html">[Twisted-Python] Using Deferred.called to distinguish between synchronous and asynchronous result
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26019">[ date ]</a>
              <a href="thread.html#26019">[ thread ]</a>
              <a href="subject.html#26019">[ subject ]</a>
              <a href="author.html#26019">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
