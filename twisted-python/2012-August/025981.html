<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Using StandardIO and pipes.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Using%20StandardIO%20and%20pipes.&In-Reply-To=20120810023907.GC11315%40fuchsia.puzzling.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025980.html">
   <LINK REL="Next"  HREF="025982.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Using StandardIO and pipes.</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Using%20StandardIO%20and%20pipes.&In-Reply-To=20120810023907.GC11315%40fuchsia.puzzling.org"
       TITLE="[Twisted-Python] Using StandardIO and pipes.">glyph at twistedmatrix.com
       </A><BR>
    <I>Fri Aug 10 01:18:13 EDT 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="025980.html">[Twisted-Python] Using StandardIO and pipes.
</A></li>
        <LI>Next message: <A HREF="025982.html">[Twisted-Python] Using StandardIO and pipes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25981">[ date ]</a>
              <a href="thread.html#25981">[ thread ]</a>
              <a href="subject.html#25981">[ subject ]</a>
              <a href="author.html#25981">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Aug 9, 2012, at 7:39 PM, Andrew Bennetts &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">andrew at bemusement.org</A>&gt; wrote:

&gt;<i> Maxim Lacrima wrote:
</I>&gt;<i> [&#8230;]
</I>&gt;&gt;<i> So my conclusions are:
</I>&gt;&gt;<i> 1. When I write to stdin of my script from keyboard then
</I>&gt;&gt;<i> `self.transport.write()` works as expected.
</I>&gt;&gt;<i> 2. When I use pipes or redirection to my script `self.transport.write()`
</I>&gt;&gt;<i> doesn't produce any output.
</I>&gt;&gt;<i> 3. If I replace self.transport.write() with print statements it works.
</I>&gt;<i> 
</I>&gt;<i> Buffering, perhaps?
</I>&gt;<i> 
</I>&gt;<i> As a quick test, try adjusting your callback to loseConnection on the transport
</I>&gt;<i> after to the write, that should flush the buffers.  If buffering turns out to
</I>&gt;<i> be your problem, and you really do expect your pipes to be at most
</I>&gt;<i> line-buffered, you'll need to arrange for the buffering on the stdin and stdout
</I>&gt;<i> file descriptors to be changed.  I don't think Twisted has that builtin, so you
</I>&gt;<i> may need to do that before creating the StandardIO object using the regular
</I>&gt;<i> Python APIs.
</I>
It's not this kind of buffering problem.  I was actually able to reproduce it by replacing &quot;Item.get()&quot; with a deferLater.  (In the future, please perform these types of replacements yourself before posting your examples; it's much easier to help out with complete, runnable programs.)

The issue is that twisted.internet.stdio considers your protocol to only know about one kind of connection loss: i.e. that your entire transport has gone away.  So, when the input is closed, the output file descriptor is immediately closed as well.

Unfortunately - and I think this is a bug in Twisted - the input connection being lost causes the output connection to be immediately and somewhat aggressively closed.  The difference between &quot;echo&quot; and typing interactively is that you send &quot;test_item_id\n&quot;, but echo sends &quot;test_item_id\n&quot; *EOF*.

Luckily you can work around this, by explicitly asking Twisted for notifications about half of the connection being closed.  You do this by implementing IHalfCloseableProtocol.

Although Twisted should be better about how it handles shutting down stdout, this nuance does reveal some logic that your code is missing: once your input is done, you don't have any concept of waiting for your output to be done before shutting everything down.  So, if you add both the IHalfCloseableProtocol implements declaration to receive the relevant notifications, and some logic to keep track of when all the output has been written, you can get exactly the behavior that I assume you want.

I've attached an example that does all of these things with a simple timer, since this is something that Twisted probably needs to document a bit better.



Cheers,

-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20120809/72a869f3/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20120809/72a869f3/attachment.htm</A> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: check.py
Type: text/x-python-script
Size: 1196 bytes
Desc: not available
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20120809/72a869f3/attachment.bin">http://twistedmatrix.com/pipermail/twisted-python/attachments/20120809/72a869f3/attachment.bin</A> 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20120809/72a869f3/attachment-0001.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20120809/72a869f3/attachment-0001.htm</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="025980.html">[Twisted-Python] Using StandardIO and pipes.
</A></li>
	<LI>Next message: <A HREF="025982.html">[Twisted-Python] Using StandardIO and pipes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25981">[ date ]</a>
              <a href="thread.html#25981">[ thread ]</a>
              <a href="subject.html#25981">[ subject ]</a>
              <a href="author.html#25981">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
