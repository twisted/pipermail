<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] inlineCallbacks and current exceptions: leaky	abstraction or bug?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20inlineCallbacks%20and%20current%20exceptions%3A%20leaky%0A%09abstraction%20or%20bug%3F&In-Reply-To=%3C64E51A7D-763D-4932-A540-8F054C7D5C75%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028556.html">
   <LINK REL="Next"  HREF="028558.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] inlineCallbacks and current exceptions: leaky	abstraction or bug?</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20inlineCallbacks%20and%20current%20exceptions%3A%20leaky%0A%09abstraction%20or%20bug%3F&In-Reply-To=%3C64E51A7D-763D-4932-A540-8F054C7D5C75%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] inlineCallbacks and current exceptions: leaky	abstraction or bug?">glyph at twistedmatrix.com
       </A><BR>
    <I>Mon Jul 28 16:56:04 MDT 2014</I>
    <P><UL>
        <LI>Previous message: <A HREF="028556.html">[Twisted-Python] inlineCallbacks and current exceptions: leaky	abstraction or bug?
</A></li>
        <LI>Next message: <A HREF="028558.html">[Twisted-Python] inlineCallbacks and current exceptions: leaky abstraction or bug?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28557">[ date ]</a>
              <a href="thread.html#28557">[ thread ]</a>
              <a href="subject.html#28557">[ subject ]</a>
              <a href="author.html#28557">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Jul 28, 2014, at 1:54 AM, Laurens Van Houtven &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">_ at lvh.io</A>&gt; wrote:

&gt;<i> Honored twistedeers,
</I>
Seriously, we need to come up with a good collective noun for ourselves one day.  We should have a referendum or something.

&gt;<i> Consider the following (blocking) decorator, which runs a function in a transaction:
</I>&gt;<i> 
</I>&gt;<i> def _with_transaction(f):
</I>&gt;<i>     def decorated(self, *args, **kwargs):
</I>&gt;<i> ...
</I>&gt;<i>        try:
</I>&gt;<i>             result = f(self, conn, *args, **kwargs)
</I>&gt;<i>         except:
</I>&gt;<i>             txn.rollback()
</I>&gt;<i>             raise
</I>&gt;<i> ...
</I>&gt;<i> Where I to translate this logic verbatim to @inlineCallbacks, I get:
</I>&gt;<i> 
</I>&gt;<i> def _with_transaction(f):
</I>&gt;<i>     @inlineCallbacks
</I>&gt;<i>     def decorated(self, *args, **kwargs):
</I>&gt;<i> ...
</I>&gt;<i>         try:
</I>&gt;<i>             result = yield f(self, conn, *args, **kwargs)
</I>&gt;<i>         except:
</I>&gt;<i>             yield txn.rollback()
</I>&gt;<i>             raise
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> However, there&#8217;s a bug here! In the except clause: there&#8217;s an (implicit) current exception, to be re-raised by the bare raise statement. Unfortunately, when doing yield txn.rollback(), that conveniently eats said exception.
</I>
This is actually true of _with_transaction as well.  Any code, anywhere, might call sys.exc_clear(), or do some interpreter shenanigans that accidentally make the equivalent happen.  So when you are calling &quot;rollback&quot; on your transaction and perhaps running application code in a post-rollback hook (because your database has that, right?  you totally need it for some things).

And of course rollback can *itself* fail which wipes out the exception anyway - is that what you want to happen in that condition?

&gt;<i> Of course, there&#8217;s a fairly simple workaround involving catching BaseException and capturing the exception instance explicitly.
</I>&gt;<i> 
</I>&gt;<i> I&#8217;m wondering if this is just a leaky abstraction, or if I should report it as a bug in @inlineCallbacks?
</I>
I don't think there's any such thing as &quot;just&quot; a leaky abstraction :-).  If an abstraction leaks in an unspecified way, it's a bug.  Report away.

Personally, I'd do something like this:

try:
    ...
except:
    captured = Failure()
    yield txn.rollback()
    yield captured

because I find that it's more readable - rather than relying on ephemeral, manipulable state which should (but doesn't necessarily) follow conventions related to indentation, I explicitly capture the implicit state, on the only line of code where it's guaranteed to be the right thing.

Also worth noting that yielding the Failure will fail the Deferred returned by your inlineCallbacks function, implicitly terminating the execution of that function.

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20140728/9ae7b091/attachment.html">http://twistedmatrix.com/pipermail/twisted-python/attachments/20140728/9ae7b091/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028556.html">[Twisted-Python] inlineCallbacks and current exceptions: leaky	abstraction or bug?
</A></li>
	<LI>Next message: <A HREF="028558.html">[Twisted-Python] inlineCallbacks and current exceptions: leaky abstraction or bug?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28557">[ date ]</a>
              <a href="thread.html#28557">[ thread ]</a>
              <a href="subject.html#28557">[ subject ]</a>
              <a href="author.html#28557">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
