<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] call XMLRPC
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20call%20XMLRPC&In-Reply-To=%3CCANAxZ%2BOBq89z7UPgxETSZLOi2K5X74LH-ZAiLERvZZRvWTH-DA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="057963.html">
   <LINK REL="Next"  HREF="057970.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] call XMLRPC</H1>
    <B>joel tremblet</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20call%20XMLRPC&In-Reply-To=%3CCANAxZ%2BOBq89z7UPgxETSZLOi2K5X74LH-ZAiLERvZZRvWTH-DA%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] call XMLRPC">bingopitts at gmail.com
       </A><BR>
    <I>Mon Apr 16 20:38:26 MDT 2012</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="057963.html">[Twisted-Python] [ANN] Announcing MV3D 0.75!
</A></li>
        <LI>Next message (by thread): <A HREF="057970.html">[Twisted-Python] call XMLRPC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57969">[ date ]</a>
              <a href="thread.html#57969">[ thread ]</a>
              <a href="subject.html#57969">[ subject ]</a>
              <a href="author.html#57969">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

I started to learn Twisted with the O'Reilly Book Twisted Network
Programming Essentials
I want to do a daemon to listen on port
- when a correct sentence is received, the daemon must to check by querying a
server XML_RPC
- if the answer from  XML_RPC is 1, the  HTTP answer will be OK else NOT
FOUND

I adapted the basic example HttpEchoProtocol.py

from twisted.protocols import basic
from twisted.web.xmlrpc import Proxy
from twisted.internet import protocol, reactor
import pdb

KEYS_ADDR=&quot;192.168.0.254&quot;
KEYS_PORT=2101

# URL of the XML-RPC server
 OF_XMLRPC_URL=&quot;<A HREF="http://127.0.0.1/xmlRpc.rpc.php">http://127.0.0.1/xmlRpc.rpc.php</A>&quot;
# HTTP Port from which the OF client contact the service
SERVICE_PORT=4080
# url sent  for test: localhost:4080/?sessid=dddddd&amp;key=1&amp;resource=2

class HttpProtocol(basic.LineReceiver):

    def __init__(self):
        self.lines      = []
        self.answer     = &quot;HTTP/1.0 200 No value&quot;
        self.gotRequest = False
        self.proxy      = Proxy(OF_XMLRPC_URL)

    def xmlRpcResponse(self, value):
        self.xmlRpc = value
        if self.xmlRpc == 1:
            self.answer = &quot;HTTP/1.0 200 OK&quot;
            print &quot;xmlRpc : &quot;,self.xmlRpc
        else:
            self.answer = &quot;HTTP/1.0 406 Invalid key&quot;
        self.xmlRpc = 0

    def xmlRpcError(self, error):
        self.answer = &quot;HTTP/1.0 405 NOT FOUND&quot;
        print &quot;Error&quot;

    def lineReceived(self, line):
        self.lines.append(line)
        if not line and not self.gotRequest:
            text = self.lines[0]
            startText = text.find(&quot;sessid&quot;)
            if startText&gt;0 :
                endText = text.find(&quot;HTTP&quot;)
                text=text[startText:endText]
                data = text.split(&quot;&amp;&quot;)
                sessionId = data[0][data[0].find(&quot;=&quot;)+1:]
                keyId = int(data[1][data[1].find(&quot;=&quot;)+1:])
                resourceId = int(data[2][data[2].find(&quot;=&quot;)+1:])
                self.proxy.callRemote('checkCommand', sessionId,
keyId).addCallbacks(self.xmlRpcResponse, self.xmlRpcError)
            self.sendResponse()
            self.gotRequest = True

    def sendResponse(self):
        responseBody = self.answer
        self.sendLine(self.answer)
        self.sendLine(&quot;Content-Type: text/plain&quot;)
        self.sendLine(&quot;Content-Length: %i&quot; % len(responseBody))
        self.sendLine(&quot;&quot;)
        self.transport.write(responseBody)
        self.transport.loseConnection()

factory = protocol.ServerFactory()
factory.protocol = HttpProtocol
reactor.listenTCP(SERVICE_PORT, factory)
reactor.run()

XML_RPC answer is correctly  received (&quot;xmlRpc :  1&quot;) but the HTTP answer
is always &quot;HTTP/1.0 200 No value&quot; (first initialization)

I tried a other example, based on requesthandler,py

from twisted.web.xmlrpc import Proxy
from twisted.web import http
from twisted.web.xmlrpc import Proxy
from twisted.internet import reactor
import pdb


# HTTP Port from which the OF client contact OpenKeys service
SERVICE_PORT=4080

# URL of the XML-RPC server
OF_XMLRPC_URL=&quot;<A HREF="http://127.0.0.1/openkeys.rpc.php">http://127.0.0.1/openkeys.rpc.php</A>&quot;

class MyRequestHandler(http.Request):

    xmlRpc = 0
    def xmlRpcResponse(self, value):
        self.xmlRpc = value
        print repr(value)
        if self.xmlRpc == 1:
           self.setResponseCode(http.OK)
           self.write(&quot;&lt;h1&gt;OK&lt;/h1&gt;&quot;)
        else:
            self.setResponseCode(http.NOT_ALLOWED)
            self.write(&quot;&lt;h1&gt;Invalid key&lt;/h1&gt;.&quot;)
        self.xmlRpc = 0
        self.finish()

    def xmlRpcError(self, error):
        print 'error', error
        self.setResponseCode(http.NOT_FOUND)
        self.write(&quot;&lt;h1&gt;Not Found&lt;/h1&gt;&quot;)
        self.xmlRpc = 0
        self.finish()

    def process(self):
        self.setHeader('Content-Type', 'text/html')
        data = self.args
        if 'sessid' in data:
            sessionId  = data['sessid'][0]
            keyId      = data[&quot;key&quot;][0]
            resourceId = data[&quot;resource&quot;][0]
            print &quot;session = &quot;, sessionId
            print &quot;key = &quot;, keyId
            print &quot;resource = &quot;, resourceId
            proxy.callRemote('checkCommand', sessionId,
keyId).addCallbacks(self.xmlRpcResponse, self.xmlRpcError)
        else:
            print &quot;data = &quot;, data
            self.setResponseCode(http.NOT_FOUND)
            self.write(&quot;&lt;h1&gt;Not Found&lt;/h1&gt;Sorry, no such page.&quot;)
            self.finish()

class MyHttp(http.HTTPChannel):
    requestFactory = MyRequestHandler

class MyHttpFactory(http.HTTPFactory):
    protocol = MyHttp

proxy  = Proxy(OF_XMLRPC_URL)
reactor.listenTCP(SERVICE_PORT, MyHttpFactory())
reactor.run()

But in this case an error occur

error [Failure instance: Traceback: &lt;class 'xmlrpclib.Fault'&gt;: &lt;Fault
-32602: 's
erver error. invalid method parameters'&gt;
C:\python27\lib\site-packages\twisted\internet\posixbase.py:263:_disconnectSelec
table
C:\python27\lib\site-packages\twisted\internet\tcp.py:433:connectionLost
C:\python27\lib\site-packages\twisted\internet\tcp.py:277:connectionLost
C:\python27\lib\site-packages\twisted\web\xmlrpc.py:373:connectionLost
--- &lt;exception caught here&gt; ---
C:\python27\lib\site-packages\twisted\web\xmlrpc.py:444:parseResponse
C:\python27\lib\xmlrpclib.py:1137:loads
C:\python27\lib\xmlrpclib.py:793:close
]

I try to declare the Proxy(OF_XMLRPC_URL) differently, without success

Where is my mistake ....
Thanks
Bingo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20120416/ccd9813a/attachment.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="057963.html">[Twisted-Python] [ANN] Announcing MV3D 0.75!
</A></li>
	<LI>Next message (by thread): <A HREF="057970.html">[Twisted-Python] call XMLRPC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#57969">[ date ]</a>
              <a href="thread.html#57969">[ thread ]</a>
              <a href="subject.html#57969">[ subject ]</a>
              <a href="author.html#57969">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
