<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] using ClientFactory from within a server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20using%20ClientFactory%20from%20within%20a%20server&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005828.html">
   <LINK REL="Next"  HREF="005830.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] using ClientFactory from within a server</H1>
    <B>Greg</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20using%20ClientFactory%20from%20within%20a%20server&In-Reply-To="
       TITLE="[Twisted-Python] using ClientFactory from within a server">greg at digitalinfo.net
       </A><BR>
    <I>Sun Sep 28 21:30:33 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="005828.html">[Twisted-Python] Re: [Twisted-commits] InMemoryUsernamePasswordDatabaseDontUse didn't raise the error properly when the password was wrong
</A></li>
        <LI>Next message: <A HREF="005830.html">[Twisted-Python] using ClientFactory from within a server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5829">[ date ]</a>
              <a href="thread.html#5829">[ thread ]</a>
              <a href="subject.html#5829">[ subject ]</a>
              <a href="author.html#5829">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I am having trouble using ClientFactory to communicate from within a server. 
Specifically, I can't figure out the proper way to exit from the client 
process. 

Included is some example code illustrating the problem I am having. It is the 
simple echo server example, but when someone sends some text to the server, I 
am trying to talk to an SMTP server to send an email. This is just an example 
(there are probably better ways to fire off an email), but you get the idea. 
The client code never &quot;exits&quot; and if I try to use reactor.stop() it causes a 
traceback. 

So how do I properly exit from this client code, or (being new to twisted) am 
I going about this in the entirely wrong way? Thanks.


#!/usr/bin/env python

from twisted.internet import reactor
from twisted.internet.protocol import Protocol, ClientFactory, ServerFactory
import sys

class Echo(Protocol):
	&quot;&quot;&quot;This is just about the simplest possible protocol&quot;&quot;&quot;
	
	def dataReceived(self, data):
		&quot;As soon as any data is received, write it back.&quot;
		self.transport.write(data)
		factory2 = MySMTPClientFactory()
		host = 'localhost'
		port = 25
		reactor.connectTCP(host, port, factory2)
		reactor.run()

		print &quot;Returned from sending email&quot;
		# ^ Never gets to this point
		
class MySMTP(Protocol):
	def dataReceived(self, data):
			sys.stdout.write('Server said: ' + data)
			if data[:3] == &quot;220&quot;:
				self.transport.write(&quot;helo foo.com\n&quot;)
				self.stage = 1
			if data[:3] == &quot;250&quot;:
				if self.stage == 1:
					self.transport.write(&quot;MAIL FROM:&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">greg at foo.com</A>&gt;\n&quot;)
					self.stage = 2
				elif self.stage == 2:
					self.transport.write(&quot;RCPT TO:&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">greg at foo.com</A>&gt;\n&quot;)
					self.stage = 3
				elif self.stage == 3:
					self.transport.write(&quot;DATA\n&quot;)
					self.stage = 4
				elif self.stage == 4:
					self.transport.write(&quot;QUIT\n&quot;)
					self.transport.loseConnection()
					#reactor.stop()
					# ^ This causes a traceback
					
			if data[:3] == &quot;354&quot;:
				# Ready to send actual email
				self.transport.write(&quot;This is a test email\n.\n&quot;)
				

class MySMTPClientFactory(ClientFactory):
	def startedConnection(self, connector):
		print 'Started to connect.'
	
	def buildProtocol(self, addr):
		print 'Connected.'
		return MySMTP()
	
	def clientConnectionLost(self, connector, reason):
		print 'Lost connection.  Reason:', reason
		#reactor.stop()
		# ^ Causes a traceback here too
		
	def clientConnectionFailed(self, connector, reason):
		print 'Connection failed. Reason:', reason

def main():
	&quot;&quot;&quot;This runs the protocol on port 8000&quot;&quot;&quot;
	factory = ServerFactory()
	factory.protocol = Echo
	reactor.listenTCP(8000,factory)
	reactor.run()

# this only runs if the module was *not* imported
if __name__ == '__main__':
	main()



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005828.html">[Twisted-Python] Re: [Twisted-commits] InMemoryUsernamePasswordDatabaseDontUse didn't raise the error properly when the password was wrong
</A></li>
	<LI>Next message: <A HREF="005830.html">[Twisted-Python] using ClientFactory from within a server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5829">[ date ]</a>
              <a href="thread.html#5829">[ thread ]</a>
              <a href="subject.html#5829">[ subject ]</a>
              <a href="author.html#5829">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
