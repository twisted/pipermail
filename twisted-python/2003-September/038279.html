<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] twisted socksv4 proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20socksv4%20proxy&In-Reply-To=%3C39B38394-EE4A-11D7-A788-000A95686CD8%40redivi.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="038278.html">
   <LINK REL="Next"  HREF="038281.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] twisted socksv4 proxy</H1>
    <B>Bob Ippolito</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20twisted%20socksv4%20proxy&In-Reply-To=%3C39B38394-EE4A-11D7-A788-000A95686CD8%40redivi.com%3E"
       TITLE="[Twisted-Python] twisted socksv4 proxy">bob at redivi.com
       </A><BR>
    <I>Tue Sep 23 22:47:39 MDT 2003</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="038278.html">[Twisted-Python] twisted socksv4 proxy
</A></li>
        <LI>Next message (by thread): <A HREF="038281.html">[Twisted-Python] twisted socksv4 proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38279">[ date ]</a>
              <a href="thread.html#38279">[ thread ]</a>
              <a href="subject.html#38279">[ subject ]</a>
              <a href="author.html#38279">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wednesday, Sep 24, 2003, at 00:08 America/New_York, Yun Mao wrote:

&gt;<i> I tried to use twisted python to write a proxy following the given
</I>&gt;<i> socksv4 example.
</I>&gt;<i>
</I>&gt;<i> The problem i discovered is that: when i try to forward two 
</I>&gt;<i> connections,
</I>&gt;<i> their capacities may not match.
</I>&gt;<i>
</I>&gt;<i> In a blocking implementation,
</I>&gt;<i>            data = source.read(); dest.write(data);
</I>&gt;<i>
</I>&gt;<i> In a non-blocking implementation, what socksv4 did is something like:
</I>&gt;<i>
</I>&gt;<i>    def dataReceived(data):
</I>&gt;<i> 	otherConn.transport.write(data)
</I>&gt;<i>
</I>&gt;<i> However, if source is a much faster link than dest, would there be a
</I>&gt;<i> problem? write always return even it should block so that read always
</I>&gt;<i> happens, and the buffer of source tcp connection will never get full, 
</I>&gt;<i> to
</I>&gt;<i> let tcp start flow control?
</I>
With that code, you are right.  Twisted will buffer everything for 
dest.. so you won't lose any packets, but you might start using a lot 
of memory and source may think that dest has a faster connection than 
dest actually does.

The twisted.internet.policies module can throttle transports, however I 
don't think that any of them can actually determine how fast dest is 
actually consuming the data.  That would require introspecting the 
underlying transport's buffer and I don't believe the transport 
interface has any way of doing that.

You could break the rules and assume that there is a dataBuffer 
attribute (from twisted.internet.abstract.FileDescriptor) which would 
most likely work, until you try and use it on a transport that is not a 
FileDescriptor (wrapped by another policy, is a loopback for testing, 
using a custom reactor, etc.).

In any case, yes, it's possible to solve this problem, but you will 
have to write your own throttling policy which must bend the interface 
rules in its implementation.

I would suggest writing the throttling policy code, and then posting 
your code with a description of your use case to 
<A HREF="http://twistedmatrix.com/bugs/">http://twistedmatrix.com/bugs/</A> so there can be a discussion about how 
to best change Twisted's interfaces around a bit so that this kind of 
throttling policy can be implemented in a future release of Twisted 
without digging into objects beyond their declared interfaces.

I could be mistaken, though.  I'm not an expert on twisted.internet, 
but I poked around it a bit when writing my own reactor.

-bob



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="038278.html">[Twisted-Python] twisted socksv4 proxy
</A></li>
	<LI>Next message (by thread): <A HREF="038281.html">[Twisted-Python] twisted socksv4 proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#38279">[ date ]</a>
              <a href="thread.html#38279">[ thread ]</a>
              <a href="subject.html#38279">[ subject ]</a>
              <a href="author.html#38279">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
