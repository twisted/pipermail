<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Python3: should paths be bytes or str?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Python3%3A%20should%20paths%20be%20bytes%20or%20str%3F&In-Reply-To=%3CD716686A-00CA-4AA2-A11E-3BA5A74ECD8C%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="061199.html">
   <LINK REL="Next"  HREF="061209.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Python3: should paths be bytes or str?</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Python3%3A%20should%20paths%20be%20bytes%20or%20str%3F&In-Reply-To=%3CD716686A-00CA-4AA2-A11E-3BA5A74ECD8C%40twistedmatrix.com%3E"
       TITLE="[Twisted-Python] Python3: should paths be bytes or str?">glyph at twistedmatrix.com
       </A><BR>
    <I>Tue Sep  9 00:01:50 MDT 2014</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="061199.html">[Twisted-Python] Python3: should paths be bytes or str?
</A></li>
        <LI>Next message (by thread): <A HREF="061209.html">[Twisted-Python] Python3: should paths be bytes or str?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61206">[ date ]</a>
              <a href="thread.html#61206">[ thread ]</a>
              <a href="subject.html#61206">[ subject ]</a>
              <a href="author.html#61206">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Sep 7, 2014, at 7:14 PM, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A> wrote:

&gt;<i> On 01:26 am, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">wolfgang.kde at rohdewald.de</A> wrote:
</I>&gt;&gt;<i> The porting guide says
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> No byte paths in sys.path.
</I>&gt;<i> 
</I>&gt;<i> What porting guide is that?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> doc for FilePath says
</I>&gt;&gt;<i>   On both Python 2 and Python 3, paths can only be bytes.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I stumbled upon this while trying to find out how much work it might be
</I>&gt;&gt;<i> to make bin/trial run with python3
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> admin/run-python3-tests already passes for all twisted.spread related
</I>&gt;&gt;<i> tests but I still need to clean up a lot.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> after adding an assert to FilePath.__init__, python3 bin/trial ... gives
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/scripts/trial.py&quot;, line 601, in run
</I>&gt;&gt;<i>   config.parseOptions()
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/python/usage.py&quot;, line 277, in parseOptions
</I>&gt;&gt;<i>   self.postOptions()
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/scripts/trial.py&quot;, line 472, in postOptions
</I>&gt;&gt;<i>   _BasicOptions.postOptions(self)
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/scripts/trial.py&quot;, line 382, in postOptions
</I>&gt;&gt;<i>   self['reporter'] = self._loadReporterByName(self['reporter'])
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/scripts/trial.py&quot;, line 369, in _loadReporterByName
</I>&gt;&gt;<i>   for p in plugin.getPlugins(itrial.IReporter):
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/plugin.py&quot;, line 209, in getPlugins
</I>&gt;&gt;<i>   allDropins = getCache(package)
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/plugin.py&quot;, line 134, in getCache
</I>&gt;&gt;<i>   mod = getModule(module.__name__)
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/python/modules.py&quot;, line 781, in getModule
</I>&gt;&gt;<i>   return theSystemPath[moduleName]
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/python/modules.py&quot;, line 702, in __getitem__
</I>&gt;&gt;<i>   self._findEntryPathString(moduleObject)),
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/python/modules.py&quot;, line 627, in _findEntryPathString
</I>&gt;&gt;<i>   if _isPackagePath(FilePath(topPackageObj.__file__)):
</I>&gt;&gt;<i> File &quot;/home/wr/ssdsrc/Twisted/twisted/python/filepath.py&quot;, line 664, in __init__
</I>&gt;&gt;<i>   assert isinstance(path, bytes), 'path must be bytes: %r' % (path,)
</I>&gt;&gt;<i> AssertionError: path must be bytes: '/home/wr/ssdsrc/Twisted/twisted/__init__.py'
</I>&gt;<i> 
</I>&gt;<i> If paths are being represented using unicode somewhere and you want to use them with FilePath then you have to encode them (or you have to add unicode path support to FilePath and let FilePath encode them).
</I>&gt;<i> 
</I>&gt;<i> Unfortunately it's not entirely obvious how to make FilePath support unicode paths since not all platforms Twisted supports represent filesystem paths using unicode.
</I>&gt;<i> 
</I>&gt;<i> The choice python-dev made to bridge this gap was the creation of the &quot;surrogateescape&quot; error handler for the UTC-8 codec.  This lets you pretend that any time you need to convert between bytes and unicode the correct codec is UTF-8 (with this special error handler).
</I>&gt;<i> 
</I>&gt;<i> It's not clear this was a good choice (since the result is unicode strings that may contain garbage which will confuse other software) but it's also not clear it's possible for Twisted to try to make any other choice (at some point Twisted has to interoperate with the path-related APIs in Python itself - `sys.path`, for example).
</I>&gt;<i> 
</I>&gt;<i> Not sure if that helps you at all.  Maybe it outlines the problem a little more clearly, at least.
</I>
The problem with making FilePath support unicode is that we want to provide an interface that applications can rely upon, specified in terms of specific types (bytes or text) so that when you get an IFilePath you know what you can do with it.

As it is currently implemented, FilePath exposes its internal representation fairly directly, most notably as the ‘.path’ attribute, but also in the return-type of methods like &quot;basename&quot; and &quot;segmentsFrom&quot;.

FilePath doesn't exactly &quot;support&quot; unicode, in that it's specifically documented not to, but it's sort of hard to tell, since you can instantiate one with a unicode string in both python 2 and python 3, and get (apparently) correct results out of it for some methods.  However, methods that need a string constant as part of their implementation, like siblingExtensionSearch and globChildren, will break unceremoniously when presented with unicode.

Another decision that python-dev made to bridge the gap was to randomly allow different string types be passed to platform APIs, like this:

&gt;&gt;&gt;<i> import os
</I>&gt;&gt;&gt;<i> os.listdir(u&quot;.&quot;)
</I>['a', 'b', 'c']
&gt;&gt;&gt;<i> os.listdir(b&quot;.&quot;)
</I>[b'a', b'b', b'c']
&gt;&gt;&gt;<i> os.path.basename(b&quot;.&quot;)
</I>b'.'
&gt;&gt;&gt;<i> os.path.basename(&quot;.&quot;)
</I>'.'

This implies a parallel structure might be possible for FilePath: if you pass its constructor bytes, you get a BytesFilePath; if you pass it text, you get a TextFilePath.  You can't mix the two, and once you've chosen a path you can't choose a different one.

IFilePath could then document that all of its existing methods have the return type of &quot;whatever got passed to __init__&quot; (which is what the current implementation does about 2/3 of the time anyway on py3, and about 9/10 of the time on py2; we would just be making it work intentionally, all the way).

But, it would then be possible to give BytesFilePath a &quot;asText()&quot; method and vice versa &quot;asBytes()&quot; - since it's the filesystem, metadata about encodings exists outside your program and you would not need to guess at encodings, you'd simply indicate what return value you'd like from methods like .basename() et. al.

The more I think about this, the more I like it - it's a bit of annoying and subtle implementation work, but I think it would supply the behavior that most people want, remain compatible with most of the existing unspecified behavior, and it would address clean text/bytes separation without having a giant deprecation cycle and inventing a new interface.  It's also the sort of implementation work which, after some discussion and consideration, we could be reasonably sure is *correct* rather than guessing at things.

Thoughts?

-glyph


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;/pipermail/twisted-python/attachments/20140908/318bcbd6/attachment-0002.html&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="061199.html">[Twisted-Python] Python3: should paths be bytes or str?
</A></li>
	<LI>Next message (by thread): <A HREF="061209.html">[Twisted-Python] Python3: should paths be bytes or str?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#61206">[ date ]</a>
              <a href="thread.html#61206">[ thread ]</a>
              <a href="subject.html#61206">[ subject ]</a>
              <a href="author.html#61206">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
