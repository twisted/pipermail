<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Question regarding the working of twisted python with celery
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Question%20regarding%20the%20working%20of%20twisted%0A%20python%20with%20celery&In-Reply-To=AANLkTi%3Dgf%3D8%2Bb%2B4M7xmgn-phewzHXe0%2Bc5i2n6r5hvzX%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023619.html">
   <LINK REL="Next"  HREF="023614.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Question regarding the working of twisted python with celery</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Question%20regarding%20the%20working%20of%20twisted%0A%20python%20with%20celery&In-Reply-To=AANLkTi%3Dgf%3D8%2Bb%2B4M7xmgn-phewzHXe0%2Bc5i2n6r5hvzX%40mail.gmail.com"
       TITLE="[Twisted-Python] Question regarding the working of twisted python with celery">andrew at bemusement.org
       </A><BR>
    <I>Thu Mar  3 16:36:37 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023619.html">[Twisted-Python] Question regarding the working of twisted python with celery
</A></li>
        <LI>Next message: <A HREF="023614.html">[Twisted-Python] PyCon 2011 Twisted Sprint
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23622">[ date ]</a>
              <a href="thread.html#23622">[ thread ]</a>
              <a href="subject.html#23622">[ subject ]</a>
              <a href="author.html#23622">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dinesh Kapoor wrote:
[...]
&gt;<i>    4. When celery is run with concurrency of 2, then I tried printing out the
</I>&gt;<i>    process ids of calling process in the reactor code, and I am getting 2
</I>&gt;<i>    different pids, so I am assuming there are two seperate copies of reactor
</I>&gt;<i>    in those separate tasks.
</I>
This sounds like the problem: you have instantiated one reactor, and
Celery (probably via the multiprocessing module) has used fork(), which
shares the reactor's internal state with the forked copy, which is not
safe.  In particular I suspect the 'waker' pipe that the reactor uses to
be notified is being shared between both processes, leading to
notifications of callFromThread etc to be noticed by the wrong copy.

The solution is to avoid starting the reactor until after the separate
processes have started.  I don't know how easy that is to arrange with
Celery.

-Andrew.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023619.html">[Twisted-Python] Question regarding the working of twisted python with celery
</A></li>
	<LI>Next message: <A HREF="023614.html">[Twisted-Python] PyCon 2011 Twisted Sprint
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23622">[ date ]</a>
              <a href="thread.html#23622">[ thread ]</a>
              <a href="subject.html#23622">[ subject ]</a>
              <a href="author.html#23622">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
