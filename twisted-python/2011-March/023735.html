<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Deferred documentation.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Deferred%20documentation.&In-Reply-To=B68B4F4A-A8D5-4D23-87FC-9D0477A4BA65%40twistedmatrix.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023731.html">
   <LINK REL="Next"  HREF="023745.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Deferred documentation.</H1>
    <B>Jasper St. Pierre</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Deferred%20documentation.&In-Reply-To=B68B4F4A-A8D5-4D23-87FC-9D0477A4BA65%40twistedmatrix.com"
       TITLE="[Twisted-Python] Deferred documentation.">jstpierre at mecheye.net
       </A><BR>
    <I>Fri Mar 25 07:28:26 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023731.html">[Twisted-Python] Deferred documentation.
</A></li>
        <LI>Next message: <A HREF="023745.html">[Twisted-Python] Deferred documentation.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23735">[ date ]</a>
              <a href="thread.html#23735">[ thread ]</a>
              <a href="subject.html#23735">[ subject ]</a>
              <a href="author.html#23735">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Big wall of text incoming. If you're going to read any part of this
email, search for *IMPORTANT* and read that part.

Right now I'm stuck at creating a simple example for &quot;deferred dependencies&quot;.

On Tue, Mar 22, 2011 at 10:03 PM, Glyph Lefkowitz
&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">glyph at twistedmatrix.com</A>&gt; wrote:
&gt;<i> On Mar 21, 2011, at 9:30 PM, Jasper St. Pierre wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On IRC, exarkun, glyph, spiv and idnar encouraged me to do a bit of
</I>&gt;&gt;<i> work on the Defer documentation.
</I>&gt;<i>
</I>&gt;<i> Yay! &#160;This documentation could definitely use some work.
</I>&gt;<i>
</I>&gt;&gt;<i> I kept get confused between the&#160;things like returning a Deferred from a
</I>&gt;&gt;<i> callback and chainDeferred,&#160;which I found out wasn't that useful:
</I>&gt;<i>
</I>&gt;<i> Yeah, chainDeferred is not a great method. &#160;Now that Deferreds are
</I>&gt;<i> non-recursive, I think it's purely worse than inserting an additional
</I>&gt;<i> Deferred as a result from a callback.
</I>&gt;<i>
</I>&gt;<i> My eventual goal is to reduce the number of documentation about defer
</I>&gt;<i> down to a near-impossible two documents. I'm hoping to merge some of
</I>&gt;<i> the good stuff of the other thousands of documents.
</I>&gt;<i>
</I>&gt;<i> That would be absolutely great.
</I>&gt;<i>
</I>&gt;&gt;<i> Thoughts so far?
</I>&gt;<i>
</I>&gt;<i> While I applaud your intent, these drafts look quite&#160;rough. &#160;The random
</I>&gt;<i> interjections and asides in
</I>&gt;<i> &lt;<A HREF="http://magcius.mecheye.net/twisted/DeferHowTo-Fixup.html">http://magcius.mecheye.net/twisted/DeferHowTo-Fixup.html</A>&gt; seem distracting
</I>&gt;<i> and confusing to me. &#160;Trying to put myself in the mind of a newcomer, I find
</I>&gt;<i> myself asking many questions which are irrelevant to what I'm trying to
</I>&gt;<i> learn:
</I>&gt;<i>
</I>&gt;<i> What's &quot;async&quot;? &#160;Why is it hard? &#160;(The original document mentions
</I>&gt;<i> asynchronous stuff, but in the context of full english sentences.)
</I>
Should I mention blocking with something like urllib, then showcase
another example library that uses regular callbacks?

&gt;<i> Where are we going shopping? &#160;What does shopping have to do with this?
</I>
Pop culture reference. Killed.

&gt;<i> What's gevent? &#160;Does this have something to do with Twisted?
</I>&gt;<i> What's node.js? &#160;This looks like Javascript, what does it have to do with
</I>&gt;<i> Twisted, which I thought was in Python?
</I>
Placeholders.

&gt;<i> (Now I've gotten distracted and I'm reading about gevent and node.js rather
</I>&gt;<i> than making my Twisted application work and completing the Deferred
</I>&gt;<i> tutorial. &#160;Epic fail. &#160;But, if I were to continue...)
</I>&gt;<i>
</I>&gt;<i> What's &quot;this pattern&quot;? &#160;Functions? &#160;Don't lots of programs use functions?
</I>
I guess this is a bit obvious when you have first-class-functions as a
language feature, but it's still a &quot;pattern.&quot;

&gt;<i> How do they use it?  Why is it relevant?
</I>
I guess I'm stupid or slow, but it took a while for me to realize that
Deferreds were basically a standardized callback mechanism. It's not
really written anywhere on the tin: Deferred was to me a bit of an
unobvious name for what it does, and before recently I've always
associated it tightly to scheduling and the reactor.

&gt;<i> Why is Twisted's right hand blue? &#160;(Forget about being a beginner: I
</I>&gt;<i> honestly don't even get this reference. &#160;Googling seems to suggest it has
</I>&gt;<i> something to do with symptoms of heart disease and doesn't seem funny or
</I>&gt;<i> relevant at all.)
</I>
Another pop culture reference. Baleeted.

&gt;<i> Why is the first explanation of what a Deferred is referred to as &quot;technical
</I>&gt;<i> mumbo-jumbo&quot;? Is this really complicated? &#160;If I am not super good at
</I>&gt;<i> programming already, should I not be reading this?
</I>
It was prefixed with &quot;The abstract&quot; before. I put it back to &quot;The
abstract&quot;. To me, it seems like it's written in a way that makes sense
only if you understand what a Deferred is, but it was useful, so I
didn't rip it out. I see it as a paragraph that will make more sense
as you're reading the article, and once you go back and understand it,
there's that happy &quot;snap&quot; feeling as you get the concept.

&gt;<i> What's an &quot;operation&quot;? &#160;Does that mean 'function' or 'method' or some other
</I>&gt;<i> special thing? &#160;It says &quot;most operations in Twisted return a Deferred&quot;; but
</I>&gt;<i> I've called lots of functions in Twisted which returned other objects before
</I>&gt;<i> reading this tutorial, or returned None. &#160;Were those actually Deferreds?
</I>
Yeah, I need to reword that. How about, &quot;because Deferreds are a core
part of Twisted, a lot of functions return them&quot;? No... that's not
good either.

&gt;<i> Why do I &quot;not know where this Deferred has been&quot;? &#160;Do Deferreds get dirty or
</I>&gt;<i> broken somehow when I add multiple callbacks? &#160;Should I avoid that?
</I>
Again, I fail at humor. Removed.

&gt;<i> The Python examples in the current Deferred Reference are mostly runnable.
</I>&gt;<i> &#160;The ones that aren't, should be. &#160;The documentation should stress that you
</I>&gt;<i> can run these examples simply, and encourage the reader to download and
</I>&gt;<i> experiment with them, and modify them to see what happens when they do
</I>&gt;<i> things in a different order.
</I>&gt;<i> Instead, the &quot;fixup&quot; changes the first example to rely on a fake library,
</I>&gt;<i> which will raise exceptions if I try to run it, but doesn't actually explain
</I>&gt;<i> that 'magiclib' isn't real. &#160;This isn't a huge problem in and of itself (it
</I>&gt;<i> is trying to demonstrate the &quot;wrong&quot; way to do things, after all) but it
</I>&gt;<i> sets up the expectation that the rest of the examples are fake, too, and I
</I>&gt;<i> shouldn't bother to run them.
</I>
Right now, it's a placeholder for that magic library that I haven't found yet.

&gt;<i> I think the original document has plenty of issues, but these changes look
</I>&gt;<i> like they've been written for people who already mostly understand
</I>&gt;<i> Deferreds, but are having trouble catching some of the nuances, and need
</I>&gt;<i> humor to diffuse their frustration and more examples to illustrate different
</I>&gt;<i> usage patterns, rather than a fundamentally clearer or better explanation
</I>&gt;<i> than what was offered before.
</I>
*IMPORTANT*

Are there specific changes you find that could make it harder to read
for newcomers?

The concept of Deferreds isn't hard at all, once you understand what
they are. The subtle nuances and bits of glue code that Twisted are
the things that can trip someone up, and what I'm still learning. A
small amount of very specific use cases for Deferreds happen in
real-world code and I'd like to show the support that Twisted has for
them built-in.

My goals for this document are:

  1) A list of guaranteed rules about Deferreds for reference at any time.
  2) An introduction to those rules in a format that doesn't require
knowledge of others.
  3) Showing techniques or tricks that you can play by &quot;exploiting&quot;
parts of those rules in the context of a contrived problem.
  4) Showing the built-in support for it.

This should help clear up my writing style a bit. I think in terms of
separating abstraction layers; I always try separate a fact or rule
from logic or a technique that can follow when you can exploit that
fact (feel free to ask the people about 'evolution' in
#python-offtopic). I also try to think of the code being very linear
when it evolves: a new rule is added, you have a problem, you can
exploit that rule with a specific technique, the technique is
standardized.

Example A:
  PROBLEM: You need to create a Deferred with a known result
  RULE: Callbacks will continue running after you've called &quot;callback&quot;
or &quot;errback&quot;
  TECHNIQUE: You can create a Deferred, call 'callback' on it and
return it, without any tricky business
  STANDARDIZED: twisted.internet.defer.success

Example B:
  PROBLEM: You need to get the results from multiple Deferreds without
blocking or too much linearity
  RULE: More than one Deferred can be created and 'run' at the same time
  TECHNIQUE: You can add a callback to a Deferred, take the result you
get and save it in a list or dictionary
  STANDARDIZED: DeferredList, gatherResults

The hardest part is creating simple, short, runnable code that
introduces: a problem that doesn't seem silly, a rule that guides
toward the solution, the technique that uses the rule to solve it. It
was much easier when I could contrive examples of a network-enabled
kitchen: recipes map pretty well to code, especially Twisted async:

  1) Melt butter in a saucepan. When the butter is finished melting,
put cocoa powder in.
  2) Meanwhile, beat egg whites and sugar, and cream of tartar.
  3) When both are done, put the chocolate mix in a Cuisinart, and
fold in the egg whites.

Here you have dependencies (butter needs to be melted before cocoa
powder), multi-tasking (you don't want to wait for the butter while
beating the eggs), and a way of knowing when things are done (so you
can fold them into the cuisinart).

( Also, this is a real recipe, ableit simplified and it makes really
easy, delicious chocolate mousse:
<A HREF="http://articles.latimes.com/2008/feb/13/food/la-fo-watch13recafeb13">http://articles.latimes.com/2008/feb/13/food/la-fo-watch13recafeb13</A> )

&gt;<i> That makes sense, since based on what you've
</I>&gt;<i> said on #twisted, that's basically the position you find yourself in :).
</I>&gt;<i> &#160;This document is supposed to be a tutorial though, explaining how to use
</I>&gt;<i> Deferreds to users who really have no idea what they are (despite its
</I>&gt;<i> unfortunate name, &quot;Deferred Reference&quot; - that should probably be changed).
</I>&gt;<i> One thing I think is very good about this attempted rework, though, is the
</I>&gt;<i> explanation of the motivation for having Deferreds at all, before explaining
</I>&gt;<i> how they work. &#160;In the current documentation, it's very unclear why we have
</I>&gt;<i> such an object in the first place, or what the alternatives to it are.
</I>
Once I *knew* what a Deferred was, the other pieces started snapping into place.

&gt;<i> However, the example presented makes it seem as though you really don't
</I>&gt;<i> need Deferreds, because the only problem with the single-callback approach
</I>&gt;<i> is handling errors. Another major motivation is the ability to return a
</I>&gt;<i> Deferred through a system with several layers, changing the return value at
</I>&gt;<i> each layer by post-processing it a bit. &#160;(One possible example: a REST API
</I>&gt;<i> that wants to deal with objects, and goes via a translation of [bytes from
</I>&gt;<i> HTTP]-&gt;[JSON dicts/lists from parsing those bytes]-&gt;[domain-specific objects
</I>&gt;<i> by converting JSON objects according to the particular API's spec].)
</I>
I never really thought about it before. I just realized right now,
writing this email, that things like DeferredList aren't cleanly
possible if the callback is tied to the request.

Additionally, is the showcase of this in the fixup with &quot;Multiple
Callbacks&quot; I did fine? The SQL to HTML example that was there before
seemed a bit contrived, and I wanted to showcase it in a runnable
snippet that required Twisted. We can't have them install a SQL
server, so I used xml.minidom instead of lxml, even though know it's
complete crap. When I'm done, I should replace the www.example.com
URLs with files hosted on the Twisted doc site. Is there a way to
point to generate a URL like that with Lore?

&gt;<i> However, I think the need would be better illustrated with examples that can
</I>&gt;<i> actually be run than with fake examples where we assume that the user knows
</I>&gt;<i> how something like gevent works. &#160;(Also: gevent doesn't actually work this
</I>&gt;<i> way, for fetching web pages at least, so your example is wrong. &#160;See
</I>&gt;<i> &lt;<A HREF="http://www.gevent.org/intro.html#monkey-patching">http://www.gevent.org/intro.html#monkey-patching</A>&gt;.)
</I>
I've replaced them with &quot;Library A&quot; and &quot;Library B&quot; placeholders. :)

&gt;<i> It's pretty easy to write a fake implementation of 'fetchWebPageAsync' which
</I>&gt;<i> squirrels away the callback somewhere that the example can call it later,
</I>&gt;<i> and explain that with some handwaving where we say &quot;and pretend that was
</I>&gt;<i> actually some networking code fetching it&quot;. &#160;For that matter, the reactor is
</I>&gt;<i> introduced too early in the existing docs; we should demonstrate calling the
</I>&gt;<i> callback synchronously, and then only later introduce a callLater.
</I>
I ripped out all the reactor code in the starting sections of the
fixup on purpose, and showcased it with what I think is a clear
example. When introducing the techniques afterwards, I'm going to
gently ramp up the reactor code to be a bit more real-world.

&gt;<i> Anyway I hope this wall of text did not discourage you - I just think you
</I>&gt;<i> need some clearer goals for improving specific aspects of the documentation,
</I>&gt;<i> and you should write those down first&#160;before trying to actually address them
</I>&gt;<i> with more docs.
</I>
This email did exactly that. Thanks so much!

P.S. I still have a *lot* to learn. Some tutoring on the subtleties of
LoopingCall and coiterator/cooperator would be nice. I'm not going to
even bother to try to explain how inlineCallbacks works to my brain
right now. I've said enough erroneous fact in IRC. I'm going to need a
lot more help in the future.

&gt;<i> Thanks for your time,
</I>
I appreciate your time a lot more. You have things to do. I don't.

&gt;<i> -glyph
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023731.html">[Twisted-Python] Deferred documentation.
</A></li>
	<LI>Next message: <A HREF="023745.html">[Twisted-Python] Deferred documentation.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23735">[ date ]</a>
              <a href="thread.html#23735">[ thread ]</a>
              <a href="subject.html#23735">[ subject ]</a>
              <a href="author.html#23735">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
