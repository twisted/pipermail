<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] LoopingCalls and unclean reactor
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20LoopingCalls%20and%20unclean%20reactor&In-Reply-To=%3CAANLkTike52n5iWvad3Tod6G6pj%3DtjefO6%2BHEEhSZEnMp%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="056169.html">
   <LINK REL="Next"  HREF="056172.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] LoopingCalls and unclean reactor</H1>
    <B>Drew Smathers</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20LoopingCalls%20and%20unclean%20reactor&In-Reply-To=%3CAANLkTike52n5iWvad3Tod6G6pj%3DtjefO6%2BHEEhSZEnMp%40mail.gmail.com%3E"
       TITLE="[Twisted-Python] LoopingCalls and unclean reactor">drew.smathers at gmail.com
       </A><BR>
    <I>Wed Mar 16 10:06:25 MDT 2011</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="056169.html">[Twisted-Python] LoopingCalls and unclean reactor
</A></li>
        <LI>Next message (by thread): <A HREF="056172.html">[Twisted-Python] LoopingCalls and unclean reactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#56170">[ date ]</a>
              <a href="thread.html#56170">[ thread ]</a>
              <a href="subject.html#56170">[ subject ]</a>
              <a href="author.html#56170">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Mar 15, 2011 at 9:55 PM, Brad Milne
&lt;<A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">brad.milne at devx.runthered.com</A>&gt; wrote:
&gt;<i> Hi
</I>&gt;<i> I have a series of MultiService objects, with child Services. Some of these
</I>&gt;<i> services are TCPServers, for example, and others are my own objects
</I>&gt;<i> (extending from Service).
</I>&gt;<i> In the instance that I have a Service which controls a LoopingCall, I am
</I>&gt;<i> getting intermittent 'unclean reactor' errors during tests. I feel I might
</I>&gt;<i> be missing some handling of deferreds, perhaps.
</I>&gt;<i> (using 8.2.0 - looking to migrate to 10.2.0 soon)
</I>&gt;<i> Here is an example of the approach being used:
</I>&gt;<i> class AdapterQueue(service.MultiService):
</I>&gt;<i>     def startService(self):
</I>&gt;<i>         service.Service.startService(self)
</I>&gt;<i>         self._looping_controller = LoopingCall(self._action)
</I>&gt;<i>         d = self._looping_controller.start(self.delay, False)
</I>&gt;<i>         d.addErrback(self._errorInScheduler)
</I>&gt;<i>     def stopService(self):
</I>&gt;<i>         service.Service.stopService(self)
</I>&gt;<i>         d = self._looping_controller.deferred
</I>&gt;<i>         self._looping_controller.stop()
</I>&gt;<i>         return d
</I>

I'm not sure if this is part of the issue or not, but it seems odd
that you may have accidentally inherited from MultiService instead of
Service.


&gt;<i> And an example error (happens about 1/3 of the time):
</I>&gt;<i> DirtyReactorAggregateError: Reactor was unclean.
</I>&gt;<i> DelayedCalls: (set twisted.internet.base.DelayedCall.debug = True to debug)
</I>&gt;<i> &lt;DelayedCall 30800112 [0.0189974308014s] called=0 cancelled=0
</I>&gt;<i> LoopingCall&lt;0.033333333333333333&gt;(AdapterQueue._action, *(), **{})()
</I>&gt;<i> traceback at creation:
</I>&gt;<i>   File &quot;C:\Python26\lib\threading.py&quot;, line 497, in __bootstrap
</I>&gt;<i>     self.__bootstrap_inner()
</I>&gt;<i>       File &quot;C:\Python26\lib\threading.py&quot;, line 525, in __bootstrap_inner
</I>&gt;<i>     self.run()
</I>&gt;<i>       File &quot;C:\Python26\lib\threading.py&quot;, line 477, in run
</I>&gt;<i>     self.__target(*self.__args, **self.__kwargs)
</I>&gt;<i>       File &quot;D:\dev\eggs\nose-0.11.3-py2.6.egg\nose\twistedtools.py&quot;, line
</I>&gt;<i> 57, in &lt;lambda&gt;
</I>&gt;<i>     installSignalHandlers=False))
</I>&gt;<i>       File
</I>&gt;<i> &quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\base.py&quot;, line
</I>&gt;<i> 1128, in run
</I>&gt;<i>     self.mainLoop()
</I>&gt;<i>       File
</I>&gt;<i> &quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\base.py&quot;, line
</I>&gt;<i> 1137, in mainLoop
</I>&gt;<i>     self.runUntilCurrent()
</I>&gt;<i>       File
</I>&gt;<i> &quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\base.py&quot;, line
</I>&gt;<i> 757, in runUntilCurrent
</I>&gt;<i>     call.func(*call.args, **call.kw)
</I>&gt;<i>       File
</I>&gt;<i> &quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\task.py&quot;, line
</I>&gt;<i> 115, in __call__
</I>&gt;<i>     d.addCallback(cb)
</I>&gt;<i>       File
</I>&gt;<i> &quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\defer.py&quot;, line
</I>&gt;<i> 195, in addCallback
</I>&gt;<i>     callbackKeywords=kw)
</I>&gt;<i>       File
</I>&gt;<i> &quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\defer.py&quot;, line
</I>&gt;<i> 186, in addCallbacks
</I>&gt;<i>     self._runCallbacks()
</I>&gt;<i>       File
</I>&gt;<i> &quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\defer.py&quot;, line
</I>&gt;<i> 328, in _runCallbacks
</I>&gt;<i>     self.result = callback(self.result, *args, **kw)
</I>&gt;<i>       File
</I>&gt;<i> &quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\task.py&quot;, line
</I>&gt;<i> 103, in cb
</I>&gt;<i>     self._reschedule()
</I>&gt;<i>       File
</I>&gt;<i> &quot;D:\dev\eggs\twisted-8.2.0-py2.6-win32.egg\twisted\internet\task.py&quot;, line
</I>&gt;<i> 139, in _reschedule
</I>&gt;<i>     self.call = self.clock.callLater(nextTime - currentTime, self)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>

Can you post code for the test?  This means generally (as you
suggested) that you haven't waited for all related deferreds to fire
before ending the test. Return the deferred returned by stopService(),
for example, and make final assertions in a callback; but I'm guessing
you already know this.


-Drew


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="056169.html">[Twisted-Python] LoopingCalls and unclean reactor
</A></li>
	<LI>Next message (by thread): <A HREF="056172.html">[Twisted-Python] LoopingCalls and unclean reactor
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#56170">[ date ]</a>
              <a href="thread.html#56170">[ thread ]</a>
              <a href="subject.html#56170">[ subject ]</a>
              <a href="author.html#56170">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
