<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Best strategies for pb Referenceables	running	long methods from callRemote
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Best%20strategies%20for%20pb%20Referenceables%0A%09running%09long%20methods%20from%20callRemote&In-Reply-To=%3C20110319014038.2231.1181588868.divmod.xquotient.269%40localhost.localdomain%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="056148.html">
   <LINK REL="Next"  HREF="056184.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Best strategies for pb Referenceables	running	long methods from callRemote</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-Python%5D%20Best%20strategies%20for%20pb%20Referenceables%0A%09running%09long%20methods%20from%20callRemote&In-Reply-To=%3C20110319014038.2231.1181588868.divmod.xquotient.269%40localhost.localdomain%3E"
       TITLE="[Twisted-Python] Best strategies for pb Referenceables	running	long methods from callRemote">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri Mar 18 19:40:38 MDT 2011</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="056148.html">[Twisted-Python] Best strategies for pb Referenceables running long	methods from callRemote
</A></li>
        <LI>Next message (by thread): <A HREF="056184.html">[Twisted-Python] Best strategies for pb Referenceables running long methods from callRemote
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#56183">[ date ]</a>
              <a href="thread.html#56183">[ thread ]</a>
              <a href="subject.html#56183">[ subject ]</a>
              <a href="author.html#56183">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10 Mar, 11:08 pm, <A HREF="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">charlessolar at gmail.com</A> wrote:
&gt;<i>I am using PB to run remote methods in a testing system at my company. 
</I>&gt;<i>The
</I>&gt;<i>code works very well but breaks down when I start running multiple 
</I>&gt;<i>tests at
</I>&gt;<i>once.  I have tracked this down to overflowing the thread pool on the 
</I>&gt;<i>remote
</I>&gt;<i>machines.  I am wondering if anyone might have better suggestions for
</I>&gt;<i>running long methods from a remote method.
</I>&gt;<i>
</I>&gt;<i>I coded up a sample of what I am seeing here: 
</I>&gt;<i><A HREF="http://pastebin.com/rBPp20Ms">http://pastebin.com/rBPp20Ms</A>
</I>&gt;<i>
</I>&gt;<i>Basically I have 1 server that calls remote_execute on many clients on 
</I>&gt;<i>a
</I>&gt;<i>remote server.  This remote_execute method starts a new method using
</I>&gt;<i>threads.deferToThread and returns the defer to make the server's 
</I>&gt;<i>callRemote
</I>&gt;<i>defer wait until the remote long method end.
</I>&gt;<i>What I do in those methods is run test code that waits, blocks, sleeps, 
</I>&gt;<i>and
</I>&gt;<i>all sorts of nasty things that make the thread take a while.  In the 
</I>&gt;<i>example
</I>&gt;<i>code I simply sleep for 20 seconds.
</I>&gt;<i>
</I>&gt;<i>The problem I see with this code specifically is that I run out of 
</I>&gt;<i>threads
</I>&gt;<i>on the pool and even though I wanted all execute methods to run at the 
</I>&gt;<i>same
</I>&gt;<i>time, I see 10 run, then 10 more, then 10 more.. etc.  The testing 
</I>&gt;<i>depends
</I>&gt;<i>on all these methods being run at the same time as they run mechanisms 
</I>&gt;<i>that
</I>&gt;<i>depend on each other and need everyone running.  When I overflow the 
</I>&gt;<i>thread
</I>&gt;<i>pool some methods do not run until other methods stop, which makes the 
</I>&gt;<i>whole
</I>&gt;<i>test fail.
</I>
This is how the thread pool works.  It has a maximum size, which limits 
the number of threads it will create to process work given to it. 
Beyond that number of concurrent tasks, things will begin to get queued 
up and wait for a free thread to execute them.

Each task you give to the thread pool exclusively uses one of its 
threads for the entire duration of the task, regardless of what the task 
consists of.
&gt;<i>I am not holding the GIL or blocking the reactor, which was the first 
</I>&gt;<i>thing
</I>&gt;<i>I checked.
</I>&gt;<i>
</I>&gt;<i>Setting reactor.suggestThreadPoolSize(50) does help, but I do not think 
</I>&gt;<i>its
</I>&gt;<i>the best solution, and does not work very well on our slow and older
</I>&gt;<i>machines.
</I>
Using more threads is the only solution to the problem of not using 
enough threads.  Alternatively, look for wards to process tasks without 
using threads.

Jean-Paul


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="056148.html">[Twisted-Python] Best strategies for pb Referenceables running long	methods from callRemote
</A></li>
	<LI>Next message (by thread): <A HREF="056184.html">[Twisted-Python] Best strategies for pb Referenceables running long methods from callRemote
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#56183">[ date ]</a>
              <a href="thread.html#56183">[ thread ]</a>
              <a href="subject.html#56183">[ subject ]</a>
              <a href="author.html#56183">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
