<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Agent and &quot;Cannot assign requested address&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Agent%20and%20%22Cannot%20assign%20requested%20address%22&In-Reply-To=m3lj0nqnbv.fsf%40tb10.ngrid.ru">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023655.html">
   <LINK REL="Next"  HREF="023626.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Agent and &quot;Cannot assign requested address&quot;</H1>
    <B>Jason J. W. Williams</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Agent%20and%20%22Cannot%20assign%20requested%20address%22&In-Reply-To=m3lj0nqnbv.fsf%40tb10.ngrid.ru"
       TITLE="[Twisted-Python] Agent and &quot;Cannot assign requested address&quot;">jasonjwwilliams at gmail.com
       </A><BR>
    <I>Thu Mar 10 13:04:48 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023655.html">[Twisted-Python] Agent and &quot;Cannot assign requested address&quot;
</A></li>
        <LI>Next message: <A HREF="023626.html">[Twisted-Python] ANN: Fusion v0.3,	a C++ integration layer for Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23656">[ date ]</a>
              <a href="thread.html#23656">[ thread ]</a>
              <a href="subject.html#23656">[ subject ]</a>
              <a href="author.html#23656">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I ended up getting around the problem by increasing my Riak cluster
size and putting a load balancer in front for the test.  But
connection pooling would be really helpful, both here and in the
CouchDB client. I've refactored both txRiak and Paisley in the past
couple of months to use Agent in the hopes ticket 3420 gets completed.
:<i>)
</I>
-J

On Thu, Mar 10, 2011 at 3:31 AM, akira &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">4kir4.1i at gmail.com</A>&gt; wrote:
&gt;<i> &quot;Jason J. W. Williams&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">jasonjwwilliams at gmail.com</A>&gt; writes:
</I>&gt;<i>
</I>&gt;&gt;<i> Actually, I think the TIME_WAIT is the problem. It's what I see in
</I>&gt;&gt;<i> netstat, and the Agent requests are fired sequentially via yield
</I>&gt;&gt;<i> inside a for loop (inlineCallbacks). So they shouldn't be running in
</I>&gt;&gt;<i> parallel.
</I>&gt;<i>
</I>&gt;<i> `yield` returns before TIME_WAIT expires otherwise it would require ~1
</I>&gt;<i> minute per request.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The use case here is loading a Riak server with keys to prepare for a
</I>&gt;&gt;<i> test. There's not a real way to get around sending one POST per key.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How would I set the timeout value in Twisted? Or do I have to modify
</I>&gt;&gt;<i> the timeout/keepalive systemwide in /proc?
</I>&gt;<i>
</I>&gt;<i> In addition to net.ipv4.tcp_fin_timeout you could increase the ephemeral
</I>&gt;<i> port range (net.ipv4.ip_local_port_range sysctl parameter).
</I>&gt;<i>
</I>&gt;<i> Each connection can be identified using 4-tuple (server IP, server port,
</I>&gt;<i> client IP, client port) Everything except client port is fixed in your
</I>&gt;<i> case so there could be at most
</I>&gt;<i> ~ net.ipv4.ip_local_port_range/net.ipv4.tcp_fin_timeout connections per
</I>&gt;<i> second (even less in practice due to other applications and other
</I>&gt;<i> settings taking preference such as fs.file-max). For example:
</I>&gt;<i>
</I>&gt;<i> &#160;net.ipv4.ip_local_port_range = 32768 &#160; &#160;61000
</I>&gt;<i> &#160;net.ipv4.tcp_fin_timeout = 30
</I>&gt;<i>
</I>&gt;<i> There could be ~900 connections per second that might be good enough.
</I>&gt;<i>
</I>&gt;<i> Reusing a local port via SO_REUSEADDR or better yet reusing a tcp
</I>&gt;<i> connection via HTTP keep-alive aren't available with twisted as I
</I>&gt;<i> understand it.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> akira
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023655.html">[Twisted-Python] Agent and &quot;Cannot assign requested address&quot;
</A></li>
	<LI>Next message: <A HREF="023626.html">[Twisted-Python] ANN: Fusion v0.3,	a C++ integration layer for Twisted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23656">[ date ]</a>
              <a href="thread.html#23656">[ thread ]</a>
              <a href="subject.html#23656">[ subject ]</a>
              <a href="author.html#23656">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
