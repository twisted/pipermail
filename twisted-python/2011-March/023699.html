<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Best strategies for pb Referenceables running long methods from callRemote
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Best%20strategies%20for%20pb%20Referenceables%20running%0A%20long%20methods%20from%20callRemote&In-Reply-To=20110319014038.2231.1181588868.divmod.xquotient.269%40localhost.localdomain">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023698.html">
   <LINK REL="Next"  HREF="023706.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Best strategies for pb Referenceables running long methods from callRemote</H1>
    <B>Charles Solar</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Best%20strategies%20for%20pb%20Referenceables%20running%0A%20long%20methods%20from%20callRemote&In-Reply-To=20110319014038.2231.1181588868.divmod.xquotient.269%40localhost.localdomain"
       TITLE="[Twisted-Python] Best strategies for pb Referenceables running long methods from callRemote">charlessolar at gmail.com
       </A><BR>
    <I>Fri Mar 18 22:06:11 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023698.html">[Twisted-Python] Best strategies for pb Referenceables	running	long methods from callRemote
</A></li>
        <LI>Next message: <A HREF="023706.html">[Twisted-Python] Best strategies for pb Referenceables	running	long methods from callRemote
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23699">[ date ]</a>
              <a href="thread.html#23699">[ thread ]</a>
              <a href="subject.html#23699">[ subject ]</a>
              <a href="author.html#23699">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the reply.  I am using twisted conch to connect to the remote
machines and start these tests, I am thinking that instead of using one
connection for all testing I will open a new connection (and thus a new
python) for each test.  Like I said increasing the thread pool size worked
well for fast machines but no so well on older ones.  I am hoping that this
behavior has more to do with the GIL and that 5 processes on a slow machine
will operate better than 5 python threads.
If not, then I will just have to write some sort of system to make sure I
dont open too many threads on certain remote machines.

Thanks again

On Fri, Mar 18, 2011 at 8:40 PM, &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:

&gt;<i> On 10 Mar, 11:08 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">charlessolar at gmail.com</A> wrote:
</I>&gt;<i> &gt;I am using PB to run remote methods in a testing system at my company.
</I>&gt;<i> &gt;The
</I>&gt;<i> &gt;code works very well but breaks down when I start running multiple
</I>&gt;<i> &gt;tests at
</I>&gt;<i> &gt;once.  I have tracked this down to overflowing the thread pool on the
</I>&gt;<i> &gt;remote
</I>&gt;<i> &gt;machines.  I am wondering if anyone might have better suggestions for
</I>&gt;<i> &gt;running long methods from a remote method.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I coded up a sample of what I am seeing here:
</I>&gt;<i> &gt;<A HREF="http://pastebin.com/rBPp20Ms">http://pastebin.com/rBPp20Ms</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Basically I have 1 server that calls remote_execute on many clients on
</I>&gt;<i> &gt;a
</I>&gt;<i> &gt;remote server.  This remote_execute method starts a new method using
</I>&gt;<i> &gt;threads.deferToThread and returns the defer to make the server's
</I>&gt;<i> &gt;callRemote
</I>&gt;<i> &gt;defer wait until the remote long method end.
</I>&gt;<i> &gt;What I do in those methods is run test code that waits, blocks, sleeps,
</I>&gt;<i> &gt;and
</I>&gt;<i> &gt;all sorts of nasty things that make the thread take a while.  In the
</I>&gt;<i> &gt;example
</I>&gt;<i> &gt;code I simply sleep for 20 seconds.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;The problem I see with this code specifically is that I run out of
</I>&gt;<i> &gt;threads
</I>&gt;<i> &gt;on the pool and even though I wanted all execute methods to run at the
</I>&gt;<i> &gt;same
</I>&gt;<i> &gt;time, I see 10 run, then 10 more, then 10 more.. etc.  The testing
</I>&gt;<i> &gt;depends
</I>&gt;<i> &gt;on all these methods being run at the same time as they run mechanisms
</I>&gt;<i> &gt;that
</I>&gt;<i> &gt;depend on each other and need everyone running.  When I overflow the
</I>&gt;<i> &gt;thread
</I>&gt;<i> &gt;pool some methods do not run until other methods stop, which makes the
</I>&gt;<i> &gt;whole
</I>&gt;<i> &gt;test fail.
</I>&gt;<i>
</I>&gt;<i> This is how the thread pool works.  It has a maximum size, which limits
</I>&gt;<i> the number of threads it will create to process work given to it.
</I>&gt;<i> Beyond that number of concurrent tasks, things will begin to get queued
</I>&gt;<i> up and wait for a free thread to execute them.
</I>&gt;<i>
</I>&gt;<i> Each task you give to the thread pool exclusively uses one of its
</I>&gt;<i> threads for the entire duration of the task, regardless of what the task
</I>&gt;<i> consists of.
</I>&gt;<i> &gt;I am not holding the GIL or blocking the reactor, which was the first
</I>&gt;<i> &gt;thing
</I>&gt;<i> &gt;I checked.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Setting reactor.suggestThreadPoolSize(50) does help, but I do not think
</I>&gt;<i> &gt;its
</I>&gt;<i> &gt;the best solution, and does not work very well on our slow and older
</I>&gt;<i> &gt;machines.
</I>&gt;<i>
</I>&gt;<i> Using more threads is the only solution to the problem of not using
</I>&gt;<i> enough threads.  Alternatively, look for wards to process tasks without
</I>&gt;<i> using threads.
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20110318/1518c09b/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20110318/1518c09b/attachment.htm</A> 
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023698.html">[Twisted-Python] Best strategies for pb Referenceables	running	long methods from callRemote
</A></li>
	<LI>Next message: <A HREF="023706.html">[Twisted-Python] Best strategies for pb Referenceables	running	long methods from callRemote
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23699">[ date ]</a>
              <a href="thread.html#23699">[ thread ]</a>
              <a href="subject.html#23699">[ subject ]</a>
              <a href="author.html#23699">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
