<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Question regarding the working of twisted python with celery
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Question%20regarding%20the%20working%20of%20twisted%0A%20python%20with%20celery&In-Reply-To=20110302133435.2231.810980901.divmod.xquotient.101%40localhost.localdomain">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023613.html">
   <LINK REL="Next"  HREF="023622.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Question regarding the working of twisted python with celery</H1>
    <B>Dinesh Kapoor</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Question%20regarding%20the%20working%20of%20twisted%0A%20python%20with%20celery&In-Reply-To=20110302133435.2231.810980901.divmod.xquotient.101%40localhost.localdomain"
       TITLE="[Twisted-Python] Question regarding the working of twisted python with celery">dineshkapoor27 at gmail.com
       </A><BR>
    <I>Thu Mar  3 07:42:57 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023613.html">[Twisted-Python] Question regarding the working of twisted	python	with celery
</A></li>
        <LI>Next message: <A HREF="023622.html">[Twisted-Python] Question regarding the working of twisted python with celery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23619">[ date ]</a>
              <a href="thread.html#23619">[ thread ]</a>
              <a href="subject.html#23619">[ subject ]</a>
              <a href="author.html#23619">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Reza and Jean-Paul for your response. Actually, I tried investigating
a bit more that whether the reactor is in different process than the calling
celery task, and it doesn't seem to be the case. The workflow that I am
assuming is as follows:

1. Celery creates a worker process and assigns a task to it, which is our
Python code.
2. That python code is calling into the twisted library where the reactor
exists, so that reactor is in the same process as our python code.
3. Our code opens up a TCP socket to another process which is NOT related to
celery or twisted (it connects to freeswitch process).
4. When celery is run with concurrency of 2, then I tried printing out the
process ids of calling process in the reactor code, and I am getting 2
different pids, so I am assuming there are two seperate copies of reactor in
those separate tasks.
5. One thing that I have think that's happening is that the reactor gets
stuck at polling, and then once it times out, the data is written on the
socket. Is that possible? If yes, how can I get around it?
6. Jean-Paul, how does Ampoule compares to Twisted?

Thanks,
Dinesh




On Wed, Mar 2, 2011 at 7:04 PM, &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">exarkun at twistedmatrix.com</A>&gt; wrote:

&gt;<i> On 09:42 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">dineshkapoor27 at gmail.com</A> wrote:
</I>&gt;<i> &gt;Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;  I have run into a weird performance issue while working with twisted
</I>&gt;<i> &gt;and
</I>&gt;<i> &gt;using celery to schedule tasks on it. Here is my setup:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;1. Celery schedules a task which makes a TCP connection to a server
</I>&gt;<i> &gt;running
</I>&gt;<i> &gt;FreeSwitch
</I>&gt;<i> &gt;2. Celery is running with concurrency = 2.
</I>&gt;<i> &gt;3. I have changed my code so that I call reactor.callfromthread for all
</I>&gt;<i> &gt;reactor based work.
</I>&gt;<i> &gt;4. A lot of times once I schedule the celery task, I get delays ranging
</I>&gt;<i> &gt;from
</I>&gt;<i> &gt;3 - 30 seconds when I am running with Celery concurrency =2.
</I>&gt;<i> &gt;5. If I reduce the celery concurrency to 1, then everything works
</I>&gt;<i> &gt;great!
</I>&gt;<i> &gt;6. Upon debugging it a little bit more, it seems that the
</I>&gt;<i> &gt;selectReactor's
</I>&gt;<i> &gt;doSelect is where the code is getting stuck on the select().
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I dont know how to get around the delay, and I dont know who is causing
</I>&gt;<i> &gt;that
</I>&gt;<i> &gt;delay exactly. If there is more info that is needed then please let me
</I>&gt;<i> &gt;know.
</I>&gt;<i> &gt;Everything works fine when the Celery worker process is 1, but delay
</I>&gt;<i> &gt;starts
</I>&gt;<i> &gt;happening invariably when celery's worker processes &gt;=2.
</I>&gt;<i>
</I>&gt;<i> I think Reza Lotun explained what's causing this problem.
</I>&gt;<i>
</I>&gt;<i> If you haven't looked at it yet, you might want to see if Ampoule can
</I>&gt;<i> help you out.
</I>&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-Python mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">Twisted-Python at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-python/attachments/20110303/fafbccb5/attachment.htm">http://twistedmatrix.com/pipermail/twisted-python/attachments/20110303/fafbccb5/attachment.htm</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023613.html">[Twisted-Python] Question regarding the working of twisted	python	with celery
</A></li>
	<LI>Next message: <A HREF="023622.html">[Twisted-Python] Question regarding the working of twisted python with celery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23619">[ date ]</a>
              <a href="thread.html#23619">[ thread ]</a>
              <a href="subject.html#23619">[ subject ]</a>
              <a href="author.html#23619">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
