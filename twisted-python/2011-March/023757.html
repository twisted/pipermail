<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Failure is O(state) vs Exception
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Failure%20is%20O%28state%29%20vs%20Exception&In-Reply-To=AANLkTindhXEEwnLG-nO7dFCxd30hjqQ%3DiDEo_p2RT0Ks%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023756.html">
   <LINK REL="Next"  HREF="023775.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Failure is O(state) vs Exception</H1>
    <B>John Arbash Meinel</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Failure%20is%20O%28state%29%20vs%20Exception&In-Reply-To=AANLkTindhXEEwnLG-nO7dFCxd30hjqQ%3DiDEo_p2RT0Ks%40mail.gmail.com"
       TITLE="[Twisted-Python] Failure is O(state) vs Exception">john at arbash-meinel.com
       </A><BR>
    <I>Mon Mar 28 11:11:40 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023756.html">[Twisted-Python] Failure is O(state) vs Exception
</A></li>
        <LI>Next message: <A HREF="023775.html">[Twisted-Python] Failure is O(state) vs Exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23757">[ date ]</a>
              <a href="thread.html#23757">[ thread ]</a>
              <a href="subject.html#23757">[ subject ]</a>
              <a href="author.html#23757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

On 03/28/2011 05:02 PM, Christopher Armstrong wrote:
&gt;<i> On Mon, Mar 28, 2011 at 9:44 AM, John Arbash Meinel
</I>&gt;<i> &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">john at arbash-meinel.com</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">john at arbash-meinel.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>     -----BEGIN PGP SIGNED MESSAGE-----
</I>&gt;<i>     Hash: SHA1
</I>&gt;<i> 
</I>&gt;<i>     I'm doing some performance testing of one of our Twisted applications.
</I>&gt;<i>     And what I came across was a surprising amount of time being spent in
</I>&gt;<i>     twisted.python.failure.Failure.__getstate__
</I>&gt;<i> 
</I>&gt;<i>     So under profiling, we spent 408ms in __getstate__. I then changed
</I>&gt;<i>     Failure.cleanFailure to just 'return', and I saw a real-world
</I>&gt;<i>     improvement of ~480ms down to about 240ms. I then restored cleanFailure,
</I>&gt;<i>     but changed Failure.__init__ to always set 'tb=None' before it does
</I>&gt;<i>     anything. And in that case the time went down to 180ms. (And when I dug
</I>&gt;<i>     into it, 150ms of that is time spent waiting for an XMLRPC response.)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Just for the record, changing cleanFailure to not do its operation is
</I>&gt;<i> likely to lead to big memory leaks. The second thing you did, setting
</I>&gt;<i> self.tb to None, makes more sense to speed things up.
</I>&gt;<i> 
</I>
Right. I agree that it is a better solution. I was wondering about
having a whitelist of Exception classes that aren't considered
interesting enough to keep a traceback.

&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i>     I'm wondering if there is a tasteful way to disable Traceback processing
</I>&gt;<i>     in a production machine. I realize you never know when you are going to
</I>&gt;<i>     need the state in order to figure out what went wrong. But it is costing
</I>&gt;<i>     2-5x runtime speed. (The other answer is to write all of our code to
</I>&gt;<i>     avoid Deferred.addErrback...)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I hate to mention it (since it's unlikely I'd be able to work on it),
</I>&gt;<i> but I wonder how much a C extension would improve this without going the
</I>&gt;<i> full step of throwing out the debug data.
</I>
A large portion of the time spent is in &quot;safe_repr&quot;, which presumably is
turning all 30k objects into 'str' representations. I would imagine that
a lot of this is redundant across state. Meaning that the objects up at
the top frame probably don't change very often.


I think part of the issue is that when you have an unhandled exception,
that's when you really want the traceback, but you only know that long
after the traceback is gone.

John
=:-&gt;
-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1.4.10 (GNU/Linux)
Comment: Using GnuPG with Mozilla - <A HREF="http://enigmail.mozdev.org/">http://enigmail.mozdev.org/</A>

iEYEARECAAYFAk2QpSwACgkQJdeBCYSNAANHhwCgj3J5a6/FgV1n/O2Zwm8U9pm7
eTgAoKWemYqgHnvMwnCrQA+uFZK/+Zeo
=x5Xm
-----END PGP SIGNATURE-----

</PRE>






















<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023756.html">[Twisted-Python] Failure is O(state) vs Exception
</A></li>
	<LI>Next message: <A HREF="023775.html">[Twisted-Python] Failure is O(state) vs Exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23757">[ date ]</a>
              <a href="thread.html#23757">[ thread ]</a>
              <a href="subject.html#23757">[ subject ]</a>
              <a href="author.html#23757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
