<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-Python] Failure is O(state) vs Exception
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Failure%20is%20O%28state%29%20vs%20Exception&In-Reply-To=20110330091411.GE2777%40aihal.home.puzzling.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023777.html">
   <LINK REL="Next"  HREF="023790.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-Python] Failure is O(state) vs Exception</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-python%40twistedmatrix.com?Subject=%5BTwisted-Python%5D%20Failure%20is%20O%28state%29%20vs%20Exception&In-Reply-To=20110330091411.GE2777%40aihal.home.puzzling.org"
       TITLE="[Twisted-Python] Failure is O(state) vs Exception">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Mar 31 00:23:43 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="023777.html">[Twisted-Python] Failure is O(state) vs Exception
</A></li>
        <LI>Next message: <A HREF="023790.html">[Twisted-Python] Failure is O(state) vs Exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23789">[ date ]</a>
              <a href="thread.html#23789">[ thread ]</a>
              <a href="subject.html#23789">[ subject ]</a>
              <a href="author.html#23789">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Mar 30, 2011, at 5:14 AM, Andrew Bennetts wrote:

&gt;<i> John Arbash Meinel wrote:
</I>&gt;<i> [&#8230;]
</I>&gt;&gt;<i> I think walking the frames and copying the dicts is also expensive. That
</I>&gt;&gt;<i> is what the bug you linked to me was about. (First, walking everything
</I>&gt;&gt;<i> and using __dict__.copy() was a bit expensive, and second that the
</I>&gt;&gt;<i> safe_repr() calls were turning 1GB strings into a new 1GB+ string.)
</I>&gt;<i> 
</I>&gt;<i> Well, if we take my proposal to not (by default at least) capture the
</I>&gt;<i> frames in the first place this isn't an issue is it?  The only other
</I>&gt;<i> copy done in Failure is the copy of self.__dict__ in __getstate__, which
</I>&gt;<i> is just a shallow copy of one dict, so fairly cheap.
</I>&gt;<i> 
</I>&gt;&gt;<i> The one other step that I think we need, is that 'maybeDeferred' also
</I>&gt;&gt;<i> always traps into a Failure object, and we'd want that to check
</I>&gt;&gt;<i> Deferred.debug first.
</I>&gt;<i> 
</I>&gt;<i> Good point!
</I>&gt;<i> 
</I>&gt;&gt;<i> I do wonder if Failure should just be checking Deferred.debug before
</I>&gt;&gt;<i> automatically including a traceback. I'm not really sure about logical
</I>&gt;&gt;<i> layering of twisted modules, though. Certainly 'twisted.python.failure'
</I>&gt;&gt;<i> seems a lower layer than 'twisted.internet.defer'.
</I>&gt;<i> 
</I>&gt;<i> Yes, checking Deferred.debug in twisted.python.failure would be bad
</I>&gt;<i> layering.  twisted.internet.defer only invokes Failure in a couple of
</I>&gt;<i> places, so it's not so onerous to make sure it invokes it to avoid
</I>&gt;<i> capturing tracebacks unless it means to.
</I>&gt;<i> 
</I>&gt;<i> That said, it might be a good idea to change Failure to *not* capture
</I>&gt;<i> tracebacks by default when invoked as Failure().  Perhaps add a
</I>&gt;<i> setDebugging toggle to twisted.python.failure too.  If an explicit
</I>&gt;<i> traceback is passed to the constructor it would still be captured, and
</I>&gt;<i> perhaps provide an alternative constructor for the current &#8220;capture
</I>&gt;<i> everything&#8221; behaviour (perhaps via a new optional flag for __init__,
</I>&gt;<i> perhaps via a new name DetailedFailure(), perhaps via a classmethod
</I>&gt;<i> except failure is not a new-style class and can't be one without
</I>&gt;<i> changing to subclass Exception&#8230;) for the rare cases when people want
</I>&gt;<i> that.  It's a pity you can't just use Failure(*sys.exc_info()) because
</I>&gt;<i> the parameters are in the wrong order.
</I>&gt;<i> 
</I>&gt;<i> Certainly the current behaviour of doing a costly capturing of traceback
</I>&gt;<i> and frame contents seems like the wrong default, given how rarely I've
</I>&gt;<i> seen anyone use Failure.printDetailedTraceback.
</I>
Agreed.  I've seen this behavior crop up shocking close to the top of profiles for Calendar Server as well, so I'm very glad to hear you've undertaken this work.  The current default is almost certainly wrong; the only code which has practically ever used it was the HTML traceback stuff, which most serious users disable for security reasons anyway.

Debugging is kind of a process-global thing, most of the time.  I think maybe we should have 'twisted.python.debug' which is the main thing that all these features use, and then a setDebugging for each system (Failure, Deferred, reactor; and ideally, eventually stuff like web, mail, conch too) to turn on these expensive-but-occasionally-worthwhile features.

But I'd be happy if this change did _nothing_ but make Failure simply default to not capturing globals and locals, and add a flag to explicitly request this behavior.  Like you say: the information is always captured but almost never used.

-glyph


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="023777.html">[Twisted-Python] Failure is O(state) vs Exception
</A></li>
	<LI>Next message: <A HREF="023790.html">[Twisted-Python] Failure is O(state) vs Exception
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23789">[ date ]</a>
              <a href="thread.html#23789">[ thread ]</a>
              <a href="subject.html#23789">[ subject ]</a>
              <a href="author.html#23789">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-python">More information about the Twisted-Python
mailing list</a><br>
</body></html>
