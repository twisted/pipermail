<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Reality] patch to make Imagination run
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:reality%40twistedmatrix.com?Subject=%5BReality%5D%20patch%20to%20make%20Imagination%20run&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="000196.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Reality] patch to make Imagination run</H1>
    <B>Ed Rahn</B> 
    <A HREF="mailto:reality%40twistedmatrix.com?Subject=%5BReality%5D%20patch%20to%20make%20Imagination%20run&In-Reply-To="
       TITLE="[Reality] patch to make Imagination run">ed at lamedomain.net
       </A><BR>
    <I>Sun Mar 27 17:01:47 MST 2005</I>
    <P><UL>
        
        <LI>Next message: <A HREF="000196.html">[Reality] patch to make Imagination run
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#195">[ date ]</a>
              <a href="thread.html#195">[ thread ]</a>
              <a href="subject.html#195">[ subject ]</a>
              <a href="author.html#195">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Attached is a patch updating the usage of zope.interfaces in Imagination. With these changes the demo in the sandbox now works.

Ed
-------------- next part --------------
Index: imagination/facets.py
===================================================================
--- imagination/facets.py	(revision 179)
+++ imagination/facets.py	(working copy)
@@ -24,7 +24,14 @@
     for interfaceClass in interfaceClasses:
         self.register([origInterface], interfaceClass, '', adapterFactory)
 
+def _hook(iface, ob, lookup=registry.lookup1):
+    factory = lookup(declarations.providedBy(ob), iface)
+    if factory is None:
+        return None
+    else:
+        return factory(ob)
 
+interface.adapter_hooks.append(_hook)
 _nope = object()
 
 class IReprable(Interface):
Index: imagination/wiring/web.py
===================================================================
--- imagination/wiring/web.py	(revision 179)
+++ imagination/wiring/web.py	(working copy)
@@ -12,7 +12,7 @@
 from nevow import rend
 from nevow.loaders import stan
 from nevow.tags import *
-from nevow.livepage import handler, glue, literal
+from nevow.liveevil import handler, glue, literal
 from nevow import entities
 
 getinput = literal.getinput
Index: imagination/simdata.py
===================================================================
--- imagination/simdata.py	(revision 179)
+++ imagination/simdata.py	(working copy)
@@ -98,11 +98,11 @@
             map[iface] = (map[iface][0], lazy(map[iface][1], kw))
         return ThingTemplate(templateMap=map, order=order)
 
-    def apply(self, method, *args, **kw):
+    def apply(self, methodClass, methodName, *args, **kw):
         map = self.templateMap.copy()
         order = self.order[:]
         order.append(
-            lazyApply(method.im_class, method.im_func.func_name, args, kw))
+            lazyApply(methodClass, methodName, args, kw))
         return ThingTemplate(templateMap=map, order=order)
 
     def copy(self):
Index: imagination/architecture.py
===================================================================
--- imagination/architecture.py	(revision 179)
+++ imagination/architecture.py	(working copy)
@@ -87,8 +87,9 @@
 
     def iterImplementors(self, interface):
         if self.closed:
-            selfish = interface(self, default=None)
-            if selfish is None:
+            try:
+                selfish = interface(self)
+            except TypeError: 
                 return iter([])
             return iter([selfish])
         else:
Index: sandbox/simplemap.py
===================================================================
--- sandbox/simplemap.py	(revision 179)
+++ sandbox/simplemap.py	(working copy)
@@ -25,17 +25,17 @@
     name=&quot;Gamma&quot;,
     description=(&quot;This room is visible through a transparent door.&quot;)).new()
 
-passage = basic.Portal.apply(architecture.IExit.between, room, room2).fill(
+passage = basic.Portal.apply(architecture.IExit, 'between', room, room2).fill(
     INoun, name=&quot;Fancy Passageway Between Alpha and Omega&quot;).new()
 
 door = basic.Door.fill(
     INoun, name=&quot;Door&quot;
-    ).apply(architecture.IExit.between, room2, room3).new()
+    ).apply(architecture.IExit, 'between', room3, room3).new()
 
 door2 = basic.Door.fill(INoun, name=&quot;glass door&quot;
                         ).fill(
     architecture.IExit, transparent=True).apply(
-    architecture.IExit.between, room, room4).new()
+    architecture.IExit, 'between', room, room4).new()
 
 
 book1 = basic.Book.fill(containment.ILocatable, location=room).fill(
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="000196.html">[Reality] patch to make Imagination run
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#195">[ date ]</a>
              <a href="thread.html#195">[ thread ]</a>
              <a href="subject.html#195">[ subject ]</a>
              <a href="author.html#195">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/reality">More information about the Reality
mailing list</a><br>
</body></html>
