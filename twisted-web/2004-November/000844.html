<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] reverse proxy with nevow
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20reverse%20proxy%20with%20nevow&In-Reply-To=5.2.1.1.0.20041111095544.02607c98%40mail.comune.grosseto.it">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000839.html">
   <LINK REL="Next"  HREF="000846.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] reverse proxy with nevow</H1>
    <B>Mike Mueller</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20reverse%20proxy%20with%20nevow&In-Reply-To=5.2.1.1.0.20041111095544.02607c98%40mail.comune.grosseto.it"
       TITLE="[Twisted-web] reverse proxy with nevow">pyp at gmx.net
       </A><BR>
    <I>Fri Nov 12 01:51:15 MST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000839.html">[Twisted-web] [version not trashed by enigmail] Custom 404,
	500 pages ...
</A></li>
        <LI>Next message: <A HREF="000846.html">[Twisted-web] WebDAV client library?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#844">[ date ]</a>
              <a href="thread.html#844">[ thread ]</a>
              <a href="subject.html#844">[ subject ]</a>
              <a href="author.html#844">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>At 09:57 11.11.2004 +0100, you wrote:
&gt;<i>Hi Mike,
</I>&gt;<i>
</I>&gt;<i>in just a bit I'll have to set up a reverse proxy with url rewriting.  Do 
</I>&gt;<i>you mind to share your setup?  (and can I post it on the devel list of 
</I>&gt;<i>OpenPortalGuard (openportalguard.sf.net))?
</I>&gt;<i>
</I>&gt;<i>many thanks
</I>&gt;<i>-b
</I>

Here is my version.
It serves static files from subdirectories in a given directory.
The names of the subdirectories correspond to the domain names.
In the example below, this is just domain1.com but it could be more domains.
The reverse proxy part redirects all requests to domains2.com to port 8080 
on the same machine.
So instead using domain2.com:8080 you can use domain2.com directly (that is 
on port 80).

The source for my server on port 80 looks like this:

#twistedStaticServer.py
from twisted.web import vhost, static, server, proxy
from twisted.application import internet, service
import os


# use this path to put several subdirectories
# the name of each subdirectory is used as a domain name
vhostDir = '..\hosts'

root = vhost.NameVirtualHost()
dir = 'domain1.com'
# making all files in ..\hosts\domain1.com\ available
# as static pages, just put your html files there
root.addHost(dir, static.File(os.path.join(vhostDir, dir)))

# now the reverse proxy part
vhostName = 'domain2.com'
# there is another server listening at 8080
reverseProxy = proxy.ReverseProxyResource('localhost', 8080, '')
# just add it to root and tell that it is a reverseProxy
root.addHost(vhostName, reverseProxy)
application = service.Application('web')
sc = service.IServiceCollection(application)
site = server.Site(root)
i = internet.TCPServer(80, site)
i.setServiceParent(sc)

For this to work you have to have a directory ../hosts/domain1.com and of 
course put the lines
127.0.0.1       domain1.com
127.0.0.1       domain2.com
in your /etc/hosts.

The source for the reverse proxy looks like this:

#nevowProxy.py
import random
from nevow import appserver, vhost
from twisted.application import internet, service
from nevow import rend, tags
from nevow import loaders

vResource = vhost.VHostMonsterResource()

class VHostGreeter(rend.Page):
     docFactory = loaders.stan(
     tags.html[
     tags.head[ tags.title[ &quot;Runnig as VHostMonsterResource&quot; ]],
     tags.body[
         tags.h1(style=&quot;font-size: large&quot;)[ &quot;This works.&quot; ]
     ]
])

root = VHostGreeter()
#just add child as nevow.vhost.VHostMonsterResource()
root.putChild(&quot;vhost&quot;, vResource)

application = service.Application('web-proxy')
sc = service.IServiceCollection(application)
site = appserver.NevowSite(root)
i = internet.TCPServer(8080, site)
i.setServiceParent(sc)

The server listens on port 8080 and can still be directly accessed via 
domain2.com:8080.
But it also works behind the static server. In this case it means the 
bowser just shows domain2.com.

That's what I wanted. You might need to adapt to your needs.


HTH,

Mike



</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000839.html">[Twisted-web] [version not trashed by enigmail] Custom 404,
	500 pages ...
</A></li>
	<LI>Next message: <A HREF="000846.html">[Twisted-web] WebDAV client library?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#844">[ date ]</a>
              <a href="thread.html#844">[ thread ]</a>
              <a href="subject.html#844">[ subject ]</a>
              <a href="author.html#844">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
