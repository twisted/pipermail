<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Xml-Rpc server troubles
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Xml-Rpc%20server%20troubles&In-Reply-To=1100601436l.12582l.5l%40Asterix">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000849.html">
   <LINK REL="Next"  HREF="000860.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Xml-Rpc server troubles</H1>
    <B>Eric Mangold</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Xml-Rpc%20server%20troubles&In-Reply-To=1100601436l.12582l.5l%40Asterix"
       TITLE="[Twisted-web] Xml-Rpc server troubles">teratorn at world-net.net
       </A><BR>
    <I>Tue Nov 16 14:35:50 MST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000849.html">[Twisted-web] Xml-Rpc server troubles
</A></li>
        <LI>Next message: <A HREF="000860.html">[Twisted-web] Xml-Rpc server troubles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#858">[ date ]</a>
              <a href="thread.html#858">[ thread ]</a>
              <a href="subject.html#858">[ subject ]</a>
              <a href="author.html#858">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Andrea Nicolini wrote:

&gt;<i> Hi All,
</I>&gt;<i>
</I>&gt;<i> I'm trying to debug a XML-RPC server I wrote because sometimes it gets  
</I>&gt;<i> stuck and I don't know why.
</I>&gt;<i> I'm not a twisted expertise so I hope someone in this list can help me.
</I>&gt;<i>
</I>&gt;<i> I use the server to give access to a MySql database via XML-RPC, the  
</I>&gt;<i> client are written in python and java.
</I>&gt;<i> The server runs fine for some days and then suddenly it hangs.
</I>&gt;<i> When the server hangs I can connect to the server port but when I call a  
</I>&gt;<i> remote method the server doesn't respond.
</I>&gt;<i> The server is not throwing any exception.
</I>&gt;<i> I'm running the server on a RH9 using Python 2.2 and Twisted 1.3.
</I>&gt;<i>
</I>&gt;<i> Here's a snippet of code:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> def xmlrpc_createjob(self,hash):
</I>&gt;<i>                 tscmfuncs.call_debug(debug,foreground)
</I>&gt;<i>                 d = self.dbpool.runInteraction(self.createjob,hash)
</I>&gt;<i>                 return d.addCallback(self.returnData)
</I>
Where is your Errback? If this doesn't work then you'll never know until
the Deferred gets GC'ed, if it ever does, and even then only sometimes.

Deferred's have __del__ defined to hopefully, maybe, warn the user if there
were errors that never got handled. This is of course not guarenteed to  
happen.

Always, always, add Errbacks.

&gt;<i>
</I>&gt;<i> def createjob(self,cur,hash):
</I>&gt;<i>                 &quot;&quot;&quot;Method to create a new job -&gt; returns the new job's  
</I>&gt;<i> id&quot;&quot;&quot;
</I>&gt;<i>                 try:
</I>&gt;<i>                         qparam = ()
</I>&gt;<i>                         cur.execute('SELECT * FROM jobtable')
</I>&gt;<i>                         for field in cur.description:
</I>&gt;<i>                                 f = field[0]
</I>&gt;<i>                                 if hash.has_key(f):
</I>&gt;<i>                                         if type(hash[f]) == type(u''):
</I>&gt;<i>                                                 qparam += (hash 
</I>&gt;<i> [f].encode('iso-8859-1'),)
</I>&gt;<i>                                         else:
</I>&gt;<i>                                                 qparam += (hash[f],)
</I>&gt;<i>                                 else:
</I>&gt;<i>                                         qparam += (None,)
</I>&gt;<i>                         cur.execute(&quot;INSERT INTO jobtable VALUES (%s,% 
</I>&gt;<i> s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,% 
</I>&gt;<i> s)&quot;,qparam)
</I>&gt;<i>                         cur.execute(&quot;SELECT LAST_INSERT_ID() FROM  
</I>&gt;<i> jobtable&quot;)
</I>&gt;<i>                         curid = cur.fetchone()[0]
</I>&gt;<i>                         cur.close()
</I>&gt;<i>
</I>&gt;<i>                 except Exception,err:
</I>&gt;<i>                         return 0
</I>&gt;<i>                 else:
</I>&gt;<i>                         return curid
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I don't have any idea of what can cause this behaviour and how to debug  
</I>&gt;<i> the server.
</I>&gt;<i> Any idea?
</I>
I don't know much about Twisted's RDBMS stuff.  I'm assuming createjob  
gets run in a thread.
Maybe these threads are getting stuck? *shrug*.  Apparently the Deferred's  
aren't firing, but you
could have a timeout function to see if they really are getting fired but  
lost before the
result gets send back by xml-rpc.

Perhaps something like this (untested):

def xmlrpc_createjob(self,hash):
     tscmfuncs.call_debug(debug,foreground)
     d = self.dbpool.runInteraction(self.createjob,hash)
     reactor.callLater(5, checkIfDeferredFired, d)
     return d.addCallback(self.returnData)

def checkIfDeferredFired(d):
     if not d.called:
         log.msg('Deferred not fired after 5 seconds')

     #omit this if it will fill your logs too much
     else:
         log.msg('Deferred fired OK')

Good luck,
-Eric


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000849.html">[Twisted-web] Xml-Rpc server troubles
</A></li>
	<LI>Next message: <A HREF="000860.html">[Twisted-web] Xml-Rpc server troubles
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#858">[ date ]</a>
              <a href="thread.html#858">[ thread ]</a>
              <a href="subject.html#858">[ subject ]</a>
              <a href="author.html#858">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
