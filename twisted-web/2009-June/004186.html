<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Telnet chat server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Telnet%20chat%20server&In-Reply-To=368574aa0906041606y2d4eb0dfo682e2eb5451df916%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004185.html">
   <LINK REL="Next"  HREF="004187.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Telnet chat server</H1>
    <B>Drew Smathers</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Telnet%20chat%20server&In-Reply-To=368574aa0906041606y2d4eb0dfo682e2eb5451df916%40mail.gmail.com"
       TITLE="[Twisted-web] Telnet chat server">drew.smathers at gmail.com
       </A><BR>
    <I>Thu Jun  4 19:06:16 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004185.html">[Twisted-web] Telnet chat server
</A></li>
        <LI>Next message: <A HREF="004187.html">[Twisted-web] Hi everybody
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4186">[ date ]</a>
              <a href="thread.html#4186">[ thread ]</a>
              <a href="subject.html#4186">[ subject ]</a>
              <a href="author.html#4186">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>2009/6/4 Drew Smathers &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">drew.smathers at gmail.com</A>&gt;:
&gt;<i> 2009/6/3 Jason St.Clair &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">woahyeahyeah at yahoo.com</A>&gt;:
</I>&gt;&gt;<i> I've got a simple little chat server set up that people can telnet into.&#160; The code is as follows:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ----------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> from twisted.internet import reactor
</I>&gt;&gt;<i> from twisted.internet.protocol import ServerFactory
</I>&gt;&gt;<i> from twisted.protocols.basic import LineOnlyReceiver
</I>&gt;&gt;<i> import threading
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class ChatProtocol(LineOnlyReceiver):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; name = &quot;&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; def getName(self):
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; if self.name!=&quot;&quot;:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return self.name
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; return self.transport.getPeer().host
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; def connectionMade(self):
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; print &quot;New connection from &quot;+self.getName()
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; self.sendLine(&quot;Welcome to the chat.\r\n/quit to quit.&quot;)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; self.factory.sendMessageToAllClients(self.getName()+&quot; joined the chat.&quot;)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; self.factory.clientProtocols.append(self)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; def connectionLost(self, reason):
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; print &quot;Lost connection from &quot;+self.getName()
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; self.factory.clientProtocols.remove(self)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; self.factory.sendMessageToAllClients(self.getName()+&quot; disconnected.&quot;)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; def lineReceived(self, line):
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; if line==&quot;/quit&quot;:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.transport.loseConnection()
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; else:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; self.factory.sendMessageToAllClients(self.getName()+&quot;: &quot;+line)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; def sendLine(self, line):
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; self.transport.write(line+&quot;\r\n&quot;)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class ChatProtocolFactory(ServerFactory):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; protocol = ChatProtocol
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; def __init__(self):
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; self.clientProtocols = []
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; def sendMessageToAllClients(self, mesg):
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; for client in self.clientProtocols:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; client.sendLine(mesg)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> def Test():
</I>&gt;&gt;<i> &#160;&#160;&#160; global test
</I>&gt;&gt;<i> &#160;&#160;&#160; factory.sendMessageToAllClients('Hey.')
</I>&gt;&gt;<i> &#160;&#160;&#160; test = threading.Timer(1.0, Test)
</I>&gt;&gt;<i> &#160;&#160;&#160; test.start()
</I>&gt;&gt;<i> test = threading.Timer(1.0, Test)
</I>&gt;&gt;<i> test.start()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> print &quot;Starting Server&quot;
</I>&gt;&gt;<i> factory = ChatProtocolFactory()
</I>&gt;&gt;<i> reactor.listenTCP(3009, factory)
</I>&gt;&gt;<i> reactor.run()
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ----------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem is that last def, &quot;def Test()&quot;.&#160; It should send the line &quot;Hey.&quot; to all connected users every second.&#160; It does that - however, the message only sends through if the client is typing or has entered a line.&#160; So, if a client is idle for 30 seconds, then starts typing, he will receive &quot;Hey.&quot; 30 times in a row - one for each second he was idle.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there any way to get this to send the message and have it show up for a client even when they're idle?
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-web mailing list
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You should use twisted.internet.task.LoopingCall instead of threading.Timer and it's also worth mentioning that twisted APIs are *not* thread-safe; in use cases where you have to use threads (there are really few), you should use reactor.callFromThread().
</I>&gt;<i>
</I>&gt;<i> So the equivalent for the above using LoopingCall would be something like:
</I>&gt;<i>
</I>&gt;<i> def test():
</I>&gt;<i> factory.sendMessageToAllClients('Hey.')
</I>&gt;<i> task = LoopingCall(test)
</I>&gt;<i> reactor.callWhenRunning(task.start, 1.0, 0)
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i>
</I>&gt;<i> -Drew
</I>&gt;<i>
</I>
Also, forgot to mention: This is a general question better asked at
twisted-python mailing list (not twisted-web).

-Drew

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004185.html">[Twisted-web] Telnet chat server
</A></li>
	<LI>Next message: <A HREF="004187.html">[Twisted-web] Hi everybody
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4186">[ date ]</a>
              <a href="thread.html#4186">[ thread ]</a>
              <a href="subject.html#4186">[ subject ]</a>
              <a href="author.html#4186">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
