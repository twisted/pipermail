<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Re: [Web-SIG] A more Twisted approach to
	async apps in WSGI
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20%5BWeb-SIG%5D%20A%20more%20Twisted%20approach%20to%0A%09async%20apps%20in%20WSGI&In-Reply-To=B6269DF6-181D-11D9-AAA6-000A95A50FB2%40fuhm.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000722.html">
   <LINK REL="Next"  HREF="000745.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Re: [Web-SIG] A more Twisted approach to
	async apps in WSGI</H1>
    <B>Phillip J. Eby</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20%5BWeb-SIG%5D%20A%20more%20Twisted%20approach%20to%0A%09async%20apps%20in%20WSGI&In-Reply-To=B6269DF6-181D-11D9-AAA6-000A95A50FB2%40fuhm.net"
       TITLE="[Twisted-web] Re: [Web-SIG] A more Twisted approach to
	async apps in WSGI">pje at telecommunity.com
       </A><BR>
    <I>Wed Oct  6 23:28:42 MDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000722.html">[Twisted-web] [PATCH] twisted.web2 support for gzip stream in/out,
	this time for real
</A></li>
        <LI>Next message: <A HREF="000745.html">[Twisted-web] Re: [Web-SIG] A more Twisted approach to async apps
	in WSGI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#724">[ date ]</a>
              <a href="thread.html#724">[ thread ]</a>
              <a href="subject.html#724">[ subject ]</a>
              <a href="author.html#724">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>At 12:59 AM 10/7/04 -0400, James Y Knight wrote:
&gt;<i>On Oct 5, 2004, at 2:37 AM, Phillip J. Eby wrote:
</I>&gt;&gt;<i>Although you probably want something more like a pipe error if the input 
</I>&gt;&gt;<i>times out or the connection is broken.
</I>&gt;<i>
</I>&gt;<i>You normally only get pipe errors on writes, read just sees EOF.
</I>&gt;<i>
</I>&gt;<i>But that does bring up a good point: How does the server notify the 
</I>&gt;<i>application that the client has gone away, and any further work is useless?
</I>&gt;<i>- For non-async apps that use the iterator model: I think the server is 
</I>&gt;<i>allowed to just call iterable.close() and never iterate again.
</I>
Yes.


&gt;<i>- For async applications, with the proposed API, that may not be an 
</I>&gt;<i>option, because the iterable returned is the special wrapper, not a 
</I>&gt;<i>user-created class. Although, actually, I guess the app can return its own 
</I>&gt;<i>iterable whose __iter__ calls through and returns the wrapper's __iter__.
</I>
Not if the server wants to be able to handle that iterable specially.  But 
anyway, it seems that the wrapper's constructor should take a close method, 
or have a way to set one.


&gt;<i>- What about for non-async applications that use the write callable? 
</I>&gt;<i>Should write be allowed to raise an exception? Or should it just become a 
</I>&gt;<i>no-op when the client is disconnected?
</I>
It's allowed to raise an exception, though this was never explicitly put in 
the spec; I'll have to fix that.  The actual process for that scenario 
looks something like this:

    * app calls write()
    * write() raises error
    * app catches error (maybe) and calls start_response() with exc_info
    * start_response() reraises the error, because it has already sent 
headers to the client and can't restart the response
    * application error handler bombs out and returns to server/gateway
    * server/gateway logs the exception (maybe) and gets on with life in 
the big 'net


&gt;<i>Hmm, yes. I totally missed the option of just yielding ''. Of course it's 
</I>&gt;<i>a very bad idea to repeatedly yield '' to a server if you don't know the 
</I>&gt;<i>server can properly handle it (by e.g. delaying longer and longer), but, 
</I>&gt;<i>in this case, since the server itself is providing the special iterable, 
</I>&gt;<i>that should be fine.
</I>
Yes.  Also, when we finally settle on an async API, I do want to cover the 
issue of backing off iteration when empty strings are yielded.  I'm 
actually inclined to suggest that an async application should take 
responsibility for doing the delaying if it's called repeatedly, and the 
async API isn't available.


&gt;<i>It seems like it should be possible to make a generic class that 
</I>&gt;<i>implements this async API for use with sync servers that do not support it 
</I>&gt;<i>natively. That would allow async apps to run on a sync server without 
</I>&gt;<i>modification, which is potentially useful. To do that, though, I think the 
</I>&gt;<i>it'd have to spawn an extra thread per request that is waiting to read 
</I>&gt;<i>data, for the read() call to block on. Unless, of course, the app never 
</I>&gt;<i>needs to yield outgoing data while waiting for incoming data.
</I>
Well, with Twisted you could deferToThread the read() operations, though 
it's hard for me to think straight about that scenario because I keep 
finding it hard to imagine an async web app that isn't just written to the 
Twisted API to start with... ;)


&gt;<i>The one remaining issue I have is the required thread-safeness of various 
</I>&gt;<i>APIs.
</I>&gt;<i>
</I>&gt;<i>The spec doesn't mention much of anything about threadsafeness: is it ok 
</I>&gt;<i>to call wsgi methods from a different thread than the one the server 
</I>&gt;<i>originally called the request on? Especially interesting for implementing 
</I>&gt;<i>the above sync-&gt;async adapter: environ['wsgi.input'].read(x) would be 
</I>&gt;<i>called from a second thread.
</I>
Excellent question; I should add the answer to the spec, as soon as I 
decide precisely what it is. :)

One point: the spec should absolutely forbid servers from using thread 
identity to identify the application/caller.  The &quot;what can you call while 
what else is executing&quot; part of the question is a bit trickier.


&gt;<i>What thread (if there's a choice) does the on_get callback get called on. Etc.
</I>
My inclination is to make threading issues symmetrical.  That is, the 
application doesn't get any thread-identity guarantees either.


&gt;<i>  I haven't really thought about these thready questions much either, so 
</I>&gt;<i> maybe the answers are obvious, but in my experience, that's usually not 
</I>&gt;<i> the case when it comes to threads.
</I>
Yep.  :)  However, the more I think about it, the more it seems to me that 
WSGI should emulate single-threadedness with respect to any 
function/method/iterator invocations associated with a given application 
invocation.  However, it is *not* guaranteed that all such invocations will 
occur from the same thread.

Basically, it means &quot;no multitasking with the other guy's objects&quot;, and 
puts the locking burdens on whoever's trying to mix multitasking into the 
works.


&gt;<i>That's why async apps are nice. ;)
</I>
Not to mention fork().  :)


By the way, after all this discussion...  do you think it would be better to:

1) Push towards a full async API, nailing down all these loose ends

2) Use the simple-but-klugdy &quot;pause iteration&quot; API idea

3) Don't make an &quot;official&quot; async API, and just leave it open to server 
authors to create their own extensions, and maybe cherry pick the best 
ideas for WSGI 2.0, or

4) Do something else altogether?


</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000722.html">[Twisted-web] [PATCH] twisted.web2 support for gzip stream in/out,
	this time for real
</A></li>
	<LI>Next message: <A HREF="000745.html">[Twisted-web] Re: [Web-SIG] A more Twisted approach to async apps
	in WSGI
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#724">[ date ]</a>
              <a href="thread.html#724">[ thread ]</a>
              <a href="subject.html#724">[ subject ]</a>
              <a href="author.html#724">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
