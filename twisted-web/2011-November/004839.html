<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] twisted.web.template output encoding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20twisted.web.template%20output%20encoding&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004838.html">
   <LINK REL="Next"  HREF="004840.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] twisted.web.template output encoding</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20twisted.web.template%20output%20encoding&In-Reply-To="
       TITLE="[Twisted-web] twisted.web.template output encoding">exarkun at twistedmatrix.com
       </A><BR>
    <I>Sat Nov 26 11:52:10 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004838.html">[Twisted-web] CorePost 0.0.8 is out
</A></li>
        <LI>Next message: <A HREF="004840.html">[Twisted-web] twisted.web.template output encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4839">[ date ]</a>
              <a href="thread.html#4839">[ thread ]</a>
              <a href="subject.html#4839">[ subject ]</a>
              <a href="author.html#4839">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all,

I recently did some work on &lt;<A HREF="http://twistedmatrix.com/trac/ticket/4896">http://twistedmatrix.com/trac/ticket/4896</A>&gt; 
(&quot;twisted.web.util.formatFailure vulnerable to XSS in rare cases&quot;). 
Rather than apply the patch adding extra html.escape calls, I tried 
porting the function to twisted.web.template (presently it builds the 
html string manually).

Apart from various issues relating to the lack of patterns in 
twisted.web.template, the main difficulty is in handling non-ascii 
contents in the traceback.  Apart from any unicode that may show up in 
the source code being rendered (or, perhaps, eventually, the values of 
variables to be rendered - though for now I do not plan to implement 
this) the no-break space characters which are necessary to get traceback 
lines indented properly mean that there is always some non-ascii to 
include in the output.

twisted.web.template encodes its output using UTF-8, and this is not 
customizable.  Thus, using twisted.web.template, formatFailure's result 
will be a str containing UTF-8 encoded text.  Previously the result was 
a str containing only ASCII encoded text, with no-break space 
represented as `&amp;nbsp;&#180;.  Consequently, callers of `formatFailure&#180; will 
probably mishandle the result - the caller in `twisted.web.server&#180; does, 
at least, including the bytes in a page with a content type of 
&quot;text/html&quot;.

The solutions that come to mind are all about removing this incompatible 
change and making it so `formatFailure&#180; can continue to return a str 
with ASCII-encoded text.

One solution is to add support for named entities or numeric character 
references to twisted.web.template.  Very likely this is a good idea 
regardless (Nevow supported these).

Another solution is to use a different encoding in 
`twisted.web.template&#180; - ASCII, with xmlcharrefreplace as the error 
handler.  This is tempting since it avoids an obtrusive non-ASCII 
support API (the way Nevow supports these is via `nevow.entities&#180;, which 
must be used rather than normal Python unicode objects).

Perhaps another question is whether the encoding used by 
`twisted.web.template&#180; should be a parameter.  A related question raised 
might be whether `twisted.web.template&#180; should encoded to bytes at all, 
or delegate the responsibility for that to code closer to a socket.

As a work-around in `formatFailure&#180; I can decode the output of the 
flattener using UTF-8 and then re-encode it to avoid non-ASCII, but it 
seems like this should be solved in `twisted.web.template&#180; rather than 
over and over again in application code.

Jean-Paul

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004838.html">[Twisted-web] CorePost 0.0.8 is out
</A></li>
	<LI>Next message: <A HREF="004840.html">[Twisted-web] twisted.web.template output encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4839">[ date ]</a>
              <a href="thread.html#4839">[ thread ]</a>
              <a href="subject.html#4839">[ subject ]</a>
              <a href="author.html#4839">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
