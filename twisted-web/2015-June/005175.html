<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] How does Twisted Web Multiprocess work ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20How%20does%20Twisted%20Web%20Multiprocess%20work%20%3F&In-Reply-To=%3CCACZ%2BWpymMG_%3DvDjaTNUQu7%3Dz688KU9OZN3OB31AkWU6zkYd-fg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005174.html">
   <LINK REL="Next"  HREF="005178.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] How does Twisted Web Multiprocess work ?</H1>
    <B>Sagar Dixit</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20How%20does%20Twisted%20Web%20Multiprocess%20work%20%3F&In-Reply-To=%3CCACZ%2BWpymMG_%3DvDjaTNUQu7%3Dz688KU9OZN3OB31AkWU6zkYd-fg%40mail.gmail.com%3E"
       TITLE="[Twisted-web] How does Twisted Web Multiprocess work ?">sagar.dixit at gmail.com
       </A><BR>
    <I>Wed Jun 10 16:39:37 MDT 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="005174.html">[Twisted-web] How does Twisted Web Multiprocess work ?
</A></li>
        <LI>Next message: <A HREF="005178.html">[Twisted-web] How does Twisted Web Multiprocess work ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5175">[ date ]</a>
              <a href="thread.html#5175">[ thread ]</a>
              <a href="subject.html#5175">[ subject ]</a>
              <a href="author.html#5175">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Gavin

Good to know how things are done at your end. thanks!
However, why is Twisted not internally using SO_REUSEPORT ? Is there any
plan to integrate it inside twisted so that application need not worry
about it ?

The problem with code mentioned here:
<A HREF="http://stackoverflow.com/questions/10077745/twistedweb-on-multicore-multiprocessor">http://stackoverflow.com/questions/10077745/twistedweb-on-multicore-multiprocessor</A>
is that the requests are not equally distributed across all processes. This
imbalance leads to underutilization of CPU cores. This issue is also
discussed on <A HREF="https://lwn.net/Articles/542629/">https://lwn.net/Articles/542629/</A>
and that this is not an issue with SO_REUSEPORT

Does it mean that Twisted is using single listening socket and all
processes accept() on that socket ?

thanks






On Wed, Jun 10, 2015 at 2:23 AM, Gavin Panella &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">gavin at gromper.net</A>&gt; wrote:

&gt;<i> On 10 June 2015 at 03:01, Sagar Dixit &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">sagar.dixit at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt; Hi,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am exploring Twisted Web for my RESTful application. My application
</I>&gt;<i> &gt; is stateless and involves storing and retrieving objects based on
</I>&gt;<i> &gt; Object-ID. This application will run on beefy (multicore, lots of
</I>&gt;<i> &gt; memory) machine. However, not all APIs that the application issues to
</I>&gt;<i> &gt; underlying storage are async and hence I cannot fully utilize
</I>&gt;<i> &gt; Deferreds
</I>&gt;<i> &gt; Which means, there will some blocking calls and hence my primary
</I>&gt;<i> &gt; interest is to use Twisted Web in multiprocessing mode
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I came across
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="http://stackoverflow.com/questions/10077745/twistedweb-on-multicore-multiprocessor">http://stackoverflow.com/questions/10077745/twistedweb-on-multicore-multiprocessor</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; However, I am not sure if it is the &quot;correct&quot; way of doing things.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hence I had some questions around it:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1. Is there an interface (similar to defertoThread) which allows me to
</I>&gt;<i> &gt; execute a blocking call in a separate process ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2. Does reactor synchronize access of all processes to the shared
</I>&gt;<i> &gt; listen socket ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 3. Is there a sample code I can refer to where the application is
</I>&gt;<i> &gt; spawning subprocesses to handle HTTP requests ?
</I>&gt;<i>
</I>&gt;<i> We've used SO_REUSEPORT (which is briefly mentioned on the SO page you
</I>&gt;<i> linked to) in order to run multiple processes. On a recentish Linux the
</I>&gt;<i> following approach has worked well for us:
</I>&gt;<i>
</I>&gt;<i>     # Make a socket with SO_REUSEPORT set so that we can run multiple web
</I>&gt;<i>     # applications. This is easier to do from outside of Twisted as there's
</I>&gt;<i>     # not yet official support for setting socket options.
</I>&gt;<i>     s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
</I>&gt;<i>     s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
</I>&gt;<i>     # The following might not work on older kernels, or SO_REUSEPORT
</I>&gt;<i>     # might not be available if Python was compiled with older headers.
</I>&gt;<i>     # In the former case you're out of luck, but you can define the
</I>&gt;<i>     # header yourself if it's missing from Python's socket module.
</I>&gt;<i>     s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEPORT, 1)
</I>&gt;<i>
</I>&gt;<i>     # Listen on all interfaces on port 1234.
</I>&gt;<i>     s.bind(('0.0.0.0', 1234))
</I>&gt;<i>
</I>&gt;<i>     # Use a backlog of 50, which seems to be fairly common.
</I>&gt;<i>     s.listen(50)
</I>&gt;<i>
</I>&gt;<i>     # Adopt this socket into something more Twisty.
</I>&gt;<i>     endpoint = AdoptedStreamServerEndpoint(reactor, s.fileno(), s.family)
</I>&gt;<i>
</I>&gt;<i>     # Prevent garbage collection. This is something we discovered we
</I>&gt;<i>     # needed, and is perhaps something that AdoptedStreamServerEndpoint
</I>&gt;<i>     # ought to do itself.
</I>&gt;<i>     endpoint.socket = s
</I>&gt;<i>
</I>&gt;<i>     # Create a service with the endpoint.
</I>&gt;<i>     service = OurService(site_endpoint)
</I>&gt;<i>
</I>&gt;<i> (Derived from src/maasserver/eventloop.py in MAAS.)
</I>&gt;<i>
</I>&gt;<i> We then use Upstart (Ubuntu 14.10 and before) or systemd (Ubuntu 15.04)
</I>&gt;<i> to run multiple processes. For us this mean 4, but you can have as many
</I>&gt;<i> or as few as you need, for example 1 process per CPU core. I like this
</I>&gt;<i> approach because we can use the system's facilities for process
</I>&gt;<i> supervision instead of cobbling together our own.
</I>&gt;<i>
</I>&gt;<i> One caveat is that the processes are running concurrently. If you're
</I>&gt;<i> modifiying shared resources you'll want to consider explicit locking
</I>&gt;<i> where before you might have been safe with Twisted' single-threadedness.
</I>&gt;<i>
</I>&gt;<i> Gavin.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i>
</I>


-- 
ssdixit
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20150610/315e6836/attachment.html">http://twistedmatrix.com/pipermail/twisted-web/attachments/20150610/315e6836/attachment.html</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005174.html">[Twisted-web] How does Twisted Web Multiprocess work ?
</A></li>
	<LI>Next message: <A HREF="005178.html">[Twisted-web] How does Twisted Web Multiprocess work ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5175">[ date ]</a>
              <a href="thread.html#5175">[ thread ]</a>
              <a href="subject.html#5175">[ subject ]</a>
              <a href="author.html#5175">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
