<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] How to handle interrupted responses in nevow?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20How%20to%20handle%20interrupted%20responses%20in%20nevow%3F&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="004543.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] How to handle interrupted responses in nevow?</H1>
    <B>Peter Westlake</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20How%20to%20handle%20interrupted%20responses%20in%20nevow%3F&In-Reply-To="
       TITLE="[Twisted-web] How to handle interrupted responses in nevow?">peter.westlake at pobox.com
       </A><BR>
    <I>Fri Oct  1 10:31:07 EDT 2010</I>
    <P><UL>
        
        <LI>Next message: <A HREF="004543.html">[Twisted-web] How to handle interrupted responses in nevow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4540">[ date ]</a>
              <a href="thread.html#4540">[ thread ]</a>
              <a href="subject.html#4540">[ subject ]</a>
              <a href="author.html#4540">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>J.P's excellent article <A HREF="http://jcalderone.livejournal.com/50890.html">http://jcalderone.livejournal.com/50890.html</A>
explains how to avoid calling Request.finish() on a request after its
connection was lost, because that now raises an exception. The code in
the article is able to avoid calling finish() because it handles the
rendering itself. The call to finish() is right there in _delayedRender.
But I'm using Nevow (because it's awesome) and all that stuff is done
behind the scenes, where I can't get to it.

My application has a form, which uses the Post/Redirect/Get pattern
(<A HREF="http://en.wikipedia.org/wiki/Post/Redirect/Get">http://en.wikipedia.org/wiki/Post/Redirect/Get</A>) to avoid
double-posting. Because processing is not instant, the browser receives
the HTTP header telling it to redirect before the processing has
finished. When the processing finishes, the Deferred embedded in the web
page fires with a value, Stan finishes flattening the page, and Nevow
calls Request.finish(). By then the browser has closed the connection
and sent in the GET request. So I get an error every single time.

What is the correct method to tell Nevow to abandon the request, please?

This is a completely self-contained example, to be run with twistd:


from nevow import tags, inevow, loaders, appserver
from nevow.rend import Page
from nevow.url import URL
from twisted.internet.task import deferLater
from twisted.internet import reactor
from twisted.application import service
from twisted.application.internet import TCPServer
from twisted.web import http

class Redirector(Page):

    count = 0
    message = 0

    def _increment(self):
        self.count += 1
        return self.count

    def slow_operation(self):
        return deferLater(reactor, 3, self._increment)

    def beforeRender(self, ctx):
        req = inevow.IRequest(ctx)
        if req.method == 'POST':
            oldurl = URL.fromContext(ctx)
            newurl = oldurl.remove('cmd')
            req.setResponseCode(http.SEE_OTHER)
            req.setHeader(&quot;Location&quot;, newurl)
            self.message = self.slow_operation()

    def render_message(self, ctx, data):
        return self.message

    docFactory = loaders.stan(
        tags.html[
            tags.head[tags.title['Slow page']],
            tags.body[
                tags.h1['Problem with interrupted connections'],
                tags.form(method='post', action='')[
                    tags.button(type='submit', name='cmd',
                    value='click')[
                        'Click'
                        ]
                    ],
                tags.p(render=tags.directive('message'))
                ]
            ]
        )

application = service.Application('Demo')

site = appserver.NevowSite(Redirector())
webservice = TCPServer(8123, site)
webservice.setName('WUI')
webservice.setServiceParent(application)


Thanks in advance,

Peter.


</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="004543.html">[Twisted-web] How to handle interrupted responses in nevow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4540">[ date ]</a>
              <a href="thread.html#4540">[ thread ]</a>
              <a href="subject.html#4540">[ subject ]</a>
              <a href="author.html#4540">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
