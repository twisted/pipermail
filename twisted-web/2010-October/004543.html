<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] How to handle interrupted responses in nevow?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20How%20to%20handle%20interrupted%20responses%20in%20nevow%3F&In-Reply-To=1285943467.13732.1397865225%40webmail.messagingengine.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004540.html">
   <LINK REL="Next"  HREF="004545.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] How to handle interrupted responses in nevow?</H1>
    <B>exarkun at twistedmatrix.com</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20How%20to%20handle%20interrupted%20responses%20in%20nevow%3F&In-Reply-To=1285943467.13732.1397865225%40webmail.messagingengine.com"
       TITLE="[Twisted-web] How to handle interrupted responses in nevow?">exarkun at twistedmatrix.com
       </A><BR>
    <I>Fri Oct  8 09:19:33 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="004540.html">[Twisted-web] How to handle interrupted responses in nevow?
</A></li>
        <LI>Next message: <A HREF="004545.html">[Twisted-web] How to handle interrupted responses in nevow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4543">[ date ]</a>
              <a href="thread.html#4543">[ thread ]</a>
              <a href="subject.html#4543">[ subject ]</a>
              <a href="author.html#4543">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1 Oct, 02:31 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">peter.westlake at pobox.com</A> wrote:
&gt;<i>J.P's excellent article <A HREF="http://jcalderone.livejournal.com/50890.html">http://jcalderone.livejournal.com/50890.html</A>
</I>&gt;<i>explains how to avoid calling Request.finish() on a request after its
</I>&gt;<i>connection was lost, because that now raises an exception. The code in
</I>&gt;<i>the article is able to avoid calling finish() because it handles the
</I>&gt;<i>rendering itself. The call to finish() is right there in 
</I>&gt;<i>_delayedRender.
</I>&gt;<i>But I'm using Nevow (because it's awesome) and all that stuff is done
</I>&gt;<i>behind the scenes, where I can't get to it.
</I>
Mmm.  Indeed.  Nevow doesn't make it easy to handle this case.

Nevow itself should be taking some action in this case, I think.  One 
possibility would be to cancel the Deferred associated with the child 
lookup/rendering operation.  This would depend on having a new enough 
version of Twisted (such that Deferred cancellation is available) 
though.  Otherwise all Nevow could really do is ignore the result of the 
Deferred when it comes.

Actually, ignoring the result might be a sensible thing to implement 
first anyway.  It should be simpler and have no application consequences 
except to get rid of the now-disallowed finish() call.

Are you interested in helping implement this?

Jean-Paul
&gt;<i>My application has a form, which uses the Post/Redirect/Get pattern
</I>&gt;<i>(<A HREF="http://en.wikipedia.org/wiki/Post/Redirect/Get">http://en.wikipedia.org/wiki/Post/Redirect/Get</A>) to avoid
</I>&gt;<i>double-posting. Because processing is not instant, the browser receives
</I>&gt;<i>the HTTP header telling it to redirect before the processing has
</I>&gt;<i>finished. When the processing finishes, the Deferred embedded in the 
</I>&gt;<i>web
</I>&gt;<i>page fires with a value, Stan finishes flattening the page, and Nevow
</I>&gt;<i>calls Request.finish(). By then the browser has closed the connection
</I>&gt;<i>and sent in the GET request. So I get an error every single time.
</I>&gt;<i>
</I>&gt;<i>What is the correct method to tell Nevow to abandon the request, 
</I>&gt;<i>please?
</I>&gt;<i>
</I>&gt;<i>This is a completely self-contained example, to be run with twistd:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>from nevow import tags, inevow, loaders, appserver
</I>&gt;<i>from nevow.rend import Page
</I>&gt;<i>from nevow.url import URL
</I>&gt;<i>from twisted.internet.task import deferLater
</I>&gt;<i>from twisted.internet import reactor
</I>&gt;<i>from twisted.application import service
</I>&gt;<i>from twisted.application.internet import TCPServer
</I>&gt;<i>from twisted.web import http
</I>&gt;<i>
</I>&gt;<i>class Redirector(Page):
</I>&gt;<i>
</I>&gt;<i>    count = 0
</I>&gt;<i>    message = 0
</I>&gt;<i>
</I>&gt;<i>    def _increment(self):
</I>&gt;<i>        self.count += 1
</I>&gt;<i>        return self.count
</I>&gt;<i>
</I>&gt;<i>    def slow_operation(self):
</I>&gt;<i>        return deferLater(reactor, 3, self._increment)
</I>&gt;<i>
</I>&gt;<i>    def beforeRender(self, ctx):
</I>&gt;<i>        req = inevow.IRequest(ctx)
</I>&gt;<i>        if req.method == 'POST':
</I>&gt;<i>            oldurl = URL.fromContext(ctx)
</I>&gt;<i>            newurl = oldurl.remove('cmd')
</I>&gt;<i>            req.setResponseCode(http.SEE_OTHER)
</I>&gt;<i>            req.setHeader(&quot;Location&quot;, newurl)
</I>&gt;<i>            self.message = self.slow_operation()
</I>&gt;<i>
</I>&gt;<i>    def render_message(self, ctx, data):
</I>&gt;<i>        return self.message
</I>&gt;<i>
</I>&gt;<i>    docFactory = loaders.stan(
</I>&gt;<i>        tags.html[
</I>&gt;<i>            tags.head[tags.title['Slow page']],
</I>&gt;<i>            tags.body[
</I>&gt;<i>                tags.h1['Problem with interrupted connections'],
</I>&gt;<i>                tags.form(method='post', action='')[
</I>&gt;<i>                    tags.button(type='submit', name='cmd',
</I>&gt;<i>                    value='click')[
</I>&gt;<i>                        'Click'
</I>&gt;<i>                        ]
</I>&gt;<i>                    ],
</I>&gt;<i>                tags.p(render=tags.directive('message'))
</I>&gt;<i>                ]
</I>&gt;<i>            ]
</I>&gt;<i>        )
</I>&gt;<i>
</I>&gt;<i>application = service.Application('Demo')
</I>&gt;<i>
</I>&gt;<i>site = appserver.NevowSite(Redirector())
</I>&gt;<i>webservice = TCPServer(8123, site)
</I>&gt;<i>webservice.setName('WUI')
</I>&gt;<i>webservice.setServiceParent(application)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>Thanks in advance,
</I>&gt;<i>
</I>&gt;<i>Peter.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Twisted-web mailing list
</I>&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004540.html">[Twisted-web] How to handle interrupted responses in nevow?
</A></li>
	<LI>Next message: <A HREF="004545.html">[Twisted-web] How to handle interrupted responses in nevow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4543">[ date ]</a>
              <a href="thread.html#4543">[ thread ]</a>
              <a href="subject.html#4543">[ subject ]</a>
              <a href="author.html#4543">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
