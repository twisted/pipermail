<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Matt's &quot;forms&quot; - error when using field
	Integer(immutable=True)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Matt%27s%20%22forms%22%20-%20error%20when%20using%20field%0A%09Integer%28immutable%3DTrue%29&In-Reply-To=20051207171259.GD254%40divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002205.html">
   <LINK REL="Next"  HREF="002207.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Matt's &quot;forms&quot; - error when using field
	Integer(immutable=True)</H1>
    <B>Paul Reznicek</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Matt%27s%20%22forms%22%20-%20error%20when%20using%20field%0A%09Integer%28immutable%3DTrue%29&In-Reply-To=20051207171259.GD254%40divmod.com"
       TITLE="[Twisted-web] Matt's &quot;forms&quot; - error when using field
	Integer(immutable=True)">maillists at ivsn.com
       </A><BR>
    <I>Mon Dec 12 11:23:39 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002205.html">[Twisted-web] Matt's &quot;forms&quot; - validation error when field name
	is not ASCII
</A></li>
        <LI>Next message: <A HREF="002207.html">[Twisted-web] Better patch [Re: Matt's &quot;forms&quot; - error when using
	field Integer(immutable=True)]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2206">[ date ]</a>
              <a href="thread.html#2206">[ thread ]</a>
              <a href="subject.html#2206">[ subject ]</a>
              <a href="author.html#2206">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matt,

Attached patch corrects an error when using field  Integer(immutable=True)
and form re-render because some validation failed (i.e. other required
field is empty, etc.)

Additionally, I've added some line breaks for the renderer to
make the produced HTML more readable (I needed it while debugging).

Thanks for the great package!
Paul

-------------- next part --------------
Index: widget.py 
=================================================================== 
--- widget.py	(Revision 147) 
+++ widget.py	(Arbeitskopie) 
@@ -39,7 +39,11 @@ 
  
     def render(self, ctx, key, args, errors): 
         if errors: 
-            value = args.get(key, [''])[0] 
+            # this correct an error when using field  Integer(immutable=True) 
+            # and form re-render because some validation failed 
+            value = args.get(key, ['']) 
+            if type(value) in (list, tuple): 
+                value = args.get(key, [''])[0] 
         else: 
             value = iforms.IStringConvertible(self.original).fromType(args.get(key)) 
         if not self.showValueOnFailure: 
@@ -171,6 +175,7 @@ 
         return [ 
             T.input(type='password', name=key, id=keytocssid(ctx.key), value=values[0], class_='readonly', readonly='readonly'), 
             T.br, 
+            T.xml('\n'), 
             T.label(for_='%s__confirm'%keytocssid(ctx.key))[' Confirm '], 
             T.input(type='password', name=key, id='%s__confirm'%keytocssid(ctx.key), value=values[1], class_='readonly', readonly='readonly') 
         ] 
@@ -236,7 +241,7 @@ 
  
         def renderOptions(ctx, data): 
             if self.noneOption is not None: 
-                yield T.option(value=iforms.IKey(self.noneOption).key())[iforms.ILabel(self.noneOption).label()] 
+                yield T.xml('\n'), T.option(value=iforms.IKey(self.noneOption).key())[iforms.ILabel(self.noneOption).label()] 
             if data is None: 
                 return 
             for item in data: 
@@ -246,7 +251,7 @@ 
                 option = T.option(value=optValue)[optLabel] 
                 if optValue == value: 
                     option = option(selected='selected') 
-                yield option 
+                yield T.xml('\n'), option 
  
         tag=T.select(name=key, id=keytocssid(ctx.key), data=self.options)[renderOptions] 
         if disabled: 
@@ -283,7 +288,7 @@ 
             tag = T.input(name=key, type='radio', id=cssid, value=itemKey) 
             if selected: 
                 tag = tag(checked='checked') 
-            return tag, ' ', T.label(for_=cssid)[itemLabel], T.br 
+            return tag, ' ', T.label(for_=cssid)[itemLabel], T.br, T.xml('\n') 
  
         def renderOptions(ctx, data): 
             # A counter to assign unique ids to each input 
@@ -324,16 +329,16 @@ 
     The default entry format is the US (month, day, year) but can be switched to 
     the more common (day, month, year) by setting the dayFirst attribute to 
     True. 
-     
+ 
     By default the widget is designed to only accept unambiguous years, i.e. 
     the user must enter 4 character dates. 
-     
+ 
     Many people find it convenient or even necessary to allow a 2 character 
     year. This can be allowed by setting the twoCharCutoffYear attribute to an 
     integer value between 0 and 99. Anything greater than or equal to the cutoff 
     year will be considered part of the 20th century (1900 + year); anything 
     less the cutoff year is a 21st century (2000 + year) date. 
-     
+ 
     A typical twoCharCutoffYear value is 70 (i.e. 1970). However, that value is 
     somewhat arbitrary. It's the year that time began according to the PC, but 
     it doesn't mean much to your non-techie user. 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002205.html">[Twisted-web] Matt's &quot;forms&quot; - validation error when field name
	is not ASCII
</A></li>
	<LI>Next message: <A HREF="002207.html">[Twisted-web] Better patch [Re: Matt's &quot;forms&quot; - error when using
	field Integer(immutable=True)]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2206">[ date ]</a>
              <a href="thread.html#2206">[ thread ]</a>
              <a href="subject.html#2206">[ subject ]</a>
              <a href="author.html#2206">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
