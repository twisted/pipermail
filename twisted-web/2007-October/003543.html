<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] adpapi cp_reconnect problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20adpapi%20cp_reconnect%20problem&In-Reply-To=6ABBF9F9-77C9-4154-8E8E-2CF5724ACFCE%40bubblehouse.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003542.html">
   <LINK REL="Next"  HREF="003545.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] adpapi cp_reconnect problem</H1>
    <B>Werner Thie</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20adpapi%20cp_reconnect%20problem&In-Reply-To=6ABBF9F9-77C9-4154-8E8E-2CF5724ACFCE%40bubblehouse.org"
       TITLE="[Twisted-web] adpapi cp_reconnect problem">wthie at thiengineering.ch
       </A><BR>
    <I>Wed Oct 10 14:17:55 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="003542.html">[Twisted-web] adpapi cp_reconnect problem
</A></li>
        <LI>Next message: <A HREF="003545.html">[Twisted-web] Twisted.web/Twisted.web2 and multiple threads
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3543">[ date ]</a>
              <a href="thread.html#3543">[ thread ]</a>
              <a href="subject.html#3543">[ subject ]</a>
              <a href="author.html#3543">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thxs Phil

Starting with V5 MySQL docs state, that there is no way to switch off 
the disconnects at all security reasons). One funy recipe I found was a 
guy stating that his provider reboots the servers every 24 hours, so he 
was setting disconnect timeouts to some value slightly bigger than 24 :-(

I hesitated to have a periodic SELECT 1; but if this is the way to go, 
why not?

I do not really have a problem when the exception bubbles up after a 
rerun of the query, moreover in this case I am interested in the 
exception, which could be handled at some outer level.

After some staring at my own code and being hit by the exception again 
it looks like the try/except should be around the actual code running 
the query, not in the setup of the interaction.

Werner

Phil Christensen wrote:
&gt;<i> On Oct 10, 2007, at 1:02 PM, Werner Thie wrote:
</I>&gt;&gt;<i> Hi all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> From what I was able to google and what I could deduce from the 
</I>&gt;&gt;<i> source/docs this is what I think the right way to get reconnects after 
</I>&gt;&gt;<i> all:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> def runQuery(self, query, *args):
</I>&gt;&gt;<i>   try:
</I>&gt;&gt;<i>     d = self.pool.runInteraction(self.mapQuery, query, args)
</I>&gt;&gt;<i>   except adbapi.ConnectionLost:
</I>&gt;&gt;<i>     #simply resend query, assuming cp_reconnect=True
</I>&gt;&gt;<i>     d = self.pool.runInteraction(self.mapQuery, query, args)
</I>&gt;&gt;<i>   return d
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Am I on the right track?
</I>&gt;<i> 
</I>&gt;<i> Is this intended to be kept in a trivial subclass of ConnectionPool? I 
</I>&gt;<i> think I'd want to avoid that...
</I>&gt;<i> 
</I>&gt;<i> The only issue that could arise here is that subsequent connections 
</I>&gt;<i> might also be down. In a similar app I'm working on, my pool might have 
</I>&gt;<i> 5-10 broken connections if it's been sitting unused for awhile. Although 
</I>&gt;<i> ConnectionPool will remove the broken connection instances when they 
</I>&gt;<i> raise ConnectionLost, your followup query could also raise the same 
</I>&gt;<i> exception.
</I>&gt;<i> 
</I>&gt;<i> I would hesitate to put the code in some kind of loop, since it's 
</I>&gt;<i> difficult to tell at this point (i.e., in runQuery) **why** the 
</I>&gt;<i> connection is lost, and how critical that fact is to the rest of the 
</I>&gt;<i> application
</I>&gt;<i> 
</I>&gt;<i> I think the approach I'm going to take is to create a separate delayed 
</I>&gt;<i> event loop that periodically runs &quot;SELECT 1;&quot; or similar every hour or 
</I>&gt;<i> so. This will keep the connections live, and in the event that one of 
</I>&gt;<i> them goes down for some other reason, it will make sure they are removed 
</I>&gt;<i> from the pool.
</I>&gt;<i> 
</I>&gt;<i> Of course, the best solution would be to figure out how to turn off 
</I>&gt;<i> those disconnects in MySQL, but I haven't had much luck finding that 
</I>&gt;<i> info in the endless quagmire of mysql.com documentation.
</I>&gt;<i> 
</I>&gt;<i> -phil
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003542.html">[Twisted-web] adpapi cp_reconnect problem
</A></li>
	<LI>Next message: <A HREF="003545.html">[Twisted-web] Twisted.web/Twisted.web2 and multiple threads
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3543">[ date ]</a>
              <a href="thread.html#3543">[ thread ]</a>
              <a href="subject.html#3543">[ subject ]</a>
              <a href="author.html#3543">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
