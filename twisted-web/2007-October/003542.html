<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] adpapi cp_reconnect problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20adpapi%20cp_reconnect%20problem&In-Reply-To=470D05AA.4010108%40thiengineering.ch">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003541.html">
   <LINK REL="Next"  HREF="003543.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] adpapi cp_reconnect problem</H1>
    <B>Phil Christensen</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20adpapi%20cp_reconnect%20problem&In-Reply-To=470D05AA.4010108%40thiengineering.ch"
       TITLE="[Twisted-web] adpapi cp_reconnect problem">phil at bubblehouse.org
       </A><BR>
    <I>Wed Oct 10 13:53:52 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="003541.html">[Twisted-web] adpapi cp_reconnect problem
</A></li>
        <LI>Next message: <A HREF="003543.html">[Twisted-web] adpapi cp_reconnect problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3542">[ date ]</a>
              <a href="thread.html#3542">[ thread ]</a>
              <a href="subject.html#3542">[ subject ]</a>
              <a href="author.html#3542">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Oct 10, 2007, at 1:02 PM, Werner Thie wrote:
&gt;<i> Hi all
</I>&gt;<i>
</I>&gt;<i> From what I was able to google and what I could deduce from the  
</I>&gt;<i> source/docs this is what I think the right way to get reconnects  
</I>&gt;<i> after all:
</I>&gt;<i>
</I>&gt;<i> def runQuery(self, query, *args):
</I>&gt;<i>   try:
</I>&gt;<i>     d = self.pool.runInteraction(self.mapQuery, query, args)
</I>&gt;<i>   except adbapi.ConnectionLost:
</I>&gt;<i>     #simply resend query, assuming cp_reconnect=True
</I>&gt;<i>     d = self.pool.runInteraction(self.mapQuery, query, args)
</I>&gt;<i>   return d
</I>&gt;<i>
</I>&gt;<i> Am I on the right track?
</I>
Is this intended to be kept in a trivial subclass of ConnectionPool?  
I think I'd want to avoid that...

The only issue that could arise here is that subsequent connections  
might also be down. In a similar app I'm working on, my pool might  
have 5-10 broken connections if it's been sitting unused for awhile.  
Although ConnectionPool will remove the broken connection instances  
when they raise ConnectionLost, your followup query could also raise  
the same exception.

I would hesitate to put the code in some kind of loop, since it's  
difficult to tell at this point (i.e., in runQuery) **why** the  
connection is lost, and how critical that fact is to the rest of the  
application

I think the approach I'm going to take is to create a separate  
delayed event loop that periodically runs &quot;SELECT 1;&quot; or similar  
every hour or so. This will keep the connections live, and in the  
event that one of them goes down for some other reason, it will make  
sure they are removed from the pool.

Of course, the best solution would be to figure out how to turn off  
those disconnects in MySQL, but I haven't had much luck finding that  
info in the endless quagmire of mysql.com documentation.

-phil

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003541.html">[Twisted-web] adpapi cp_reconnect problem
</A></li>
	<LI>Next message: <A HREF="003543.html">[Twisted-web] adpapi cp_reconnect problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3542">[ date ]</a>
              <a href="thread.html#3542">[ thread ]</a>
              <a href="subject.html#3542">[ subject ]</a>
              <a href="author.html#3542">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
