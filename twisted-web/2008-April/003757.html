<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] what are the advantage of using a single-threaded
	server? and when should we use deferreds?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20what%20are%20the%20advantage%20of%20using%20a%20single-threaded%0A%09server%3F%20and%20when%20should%20we%20use%20deferreds%3F&In-Reply-To=da776a8c0804252344g17c3bd9dm65b859c263585a50%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003755.html">
   <LINK REL="Next"  HREF="003758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] what are the advantage of using a single-threaded
	server? and when should we use deferreds?</H1>
    <B>glyph at divmod.com</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20what%20are%20the%20advantage%20of%20using%20a%20single-threaded%0A%09server%3F%20and%20when%20should%20we%20use%20deferreds%3F&In-Reply-To=da776a8c0804252344g17c3bd9dm65b859c263585a50%40mail.gmail.com"
       TITLE="[Twisted-web] what are the advantage of using a single-threaded
	server? and when should we use deferreds?">glyph at divmod.com
       </A><BR>
    <I>Sat Apr 26 21:37:30 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="003755.html">[Twisted-web] what are the advantage of using a single-threaded
	server? and when should we use deferreds?
</A></li>
        <LI>Next message: <A HREF="003758.html">[Twisted-web] Athena onbeforeunload ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3757">[ date ]</a>
              <a href="thread.html#3757">[ thread ]</a>
              <a href="subject.html#3757">[ subject ]</a>
              <a href="author.html#3757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26 Apr, 06:44 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">inhahe at gmail.com</A> wrote:
&gt;<i>hi, excuse my noobness, I have a few basic questions about twisted, or
</I>&gt;<i>probably about web servers in general.
</I>&gt;<i>
</I>&gt;<i>what is the advantage of using a single-threaded server?
</I>&gt;<i>
</I>&gt;<i>i figured it makes it more scalable because there's too much overhead 
</I>&gt;<i>to
</I>&gt;<i>have a thread for each user when you have many simultaneous users.  but 
</I>&gt;<i>a
</I>&gt;<i>friend i'm talking to now says that using i/o blocking threads is 
</I>&gt;<i>perfectly
</I>&gt;<i>scalable for a large number of simultaneous users.
</I>
One way in which a single-threaded server scales better can be 
understood in terms of how the operating system copes with increased 
load.

Let's say your site is being hit very, very hard, and you have to ssh in 
to change some stuff around to update it to deal with more load.  With a 
single-threaded server, the operating system is scheduling two tasks: 
your SSH session and your web server.  Therefore your SSH session gets 
plenty of time to talk to you.  With a multi-threaded or multi-process 
server, it is scheduling zillions of tasks, and you have to think about 
limiting the number of processes that can run (which puts a hard limit 
on the number of concurrent users, that can easily be too many or too 
few for your hardware, especially if those processes are doing network 
I/O of their own).

So, on a poorly-configured multithreaded server, you have to wait for 
the load to die down before your system starts slowing to a crawl.  With 
a single-process server like Twisted, lighttpd, and nginx, you can 
easily get in and poke it with a separate maintenance tool like SSH.

There are also potentially performance differences between event-driven 
and multithreaded servers, but there's a huge amount of optimization 
work that has gone into both approaches, so I wouldn't want to say one 
is definitely faster.  Twisted is definitely a lot slower than several 
competing servers which use a multi-process approach.  However, it can 
be made to scale in a variety of interesting ways.  (I would say that 
your friend is wrong in saying that i/o blocking threads is &quot;perfectly 
scalable&quot;, though, especially in the naive case.)
&gt;<i>if that's true i can only see a disadvantage in using a single-threaded
</I>&gt;<i>server -- having to use deferreds and stuff to make things asynchronous
</I>
This is not a disadvantage.  Deferreds are great; if you have a race- 
condition firing two Deferreds you can easily write a test to fire them 
in a different order and easily replicate the problem in a debugger to 
figure out what is going on.  If you have the same problem with threads, 
you are basically screwed; it's very hard to reproduce in an environment 
where you can see what's going on and even harder to write a repeatable 
test for.
&gt;<i>i also don't understand how you're supposed to use deferreds
</I>&gt;<i>the twisted doc says deferreds won't *make* your code asynchronous.  so
</I>&gt;<i>let's say you have to do an sql query that takes 10 seconds, deferreds 
</I>&gt;<i>would
</I>&gt;<i>be useless for making that not block unless you have a way of making 
</I>&gt;<i>that
</I>&gt;<i>sql query non-blocking already?  how is that done?  do you run a 
</I>&gt;<i>separate
</I>&gt;<i>thread of your own for each sql query?  one thread for all sql queries?
</I>
I could try to explain this, but you should really just read the 
Deferred howto and experiment at the Python prompt for a few hours with 
Deferred-returning APIs like twisted.web.client and 
twisted.enterprise.adbapi.  The short answer is &quot;twisted uses threads 
under the covers to do stuff with SQL, but to your code it just looks 
like a deferred because it's simpler&quot;.
&gt;<i>also I wonder in an typical twisted app, just how slow should an 
</I>&gt;<i>operation
</I>&gt;<i>be before you use a deferred?  what if a user enters a username and 
</I>&gt;<i>password
</I>&gt;<i>and i have to look that up in the database. do i use a deferred?  just 
</I>&gt;<i>how
</I>&gt;<i>bad should the query be before using a deferred?
</I>
It's not a question of speed, it's a question of blocking.  If you are 
doing CPU-intensive stuff, you might want to put it into a separate 
process so you don't need to break it up into lots of little chunks. 
(Look into spawnProcess.)  However, in general the things that use 
Deferreds are the things that generate some output and then wait for 
some input in response.
&gt;<i>(reading the twisted docs is like reading a brick wall for me, it would 
</I>&gt;<i>be
</I>&gt;<i>nice if someone could just explain things to me in simple terms.)
</I>
Good luck.

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003755.html">[Twisted-web] what are the advantage of using a single-threaded
	server? and when should we use deferreds?
</A></li>
	<LI>Next message: <A HREF="003758.html">[Twisted-web] Athena onbeforeunload ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3757">[ date ]</a>
              <a href="thread.html#3757">[ thread ]</a>
              <a href="subject.html#3757">[ subject ]</a>
              <a href="author.html#3757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
