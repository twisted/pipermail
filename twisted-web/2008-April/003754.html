<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] what are the advantage of using a
	single-threaded server? and when should we use deferreds?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20what%20are%20the%20advantage%20of%20using%20a%0A%09single-threaded%20server%3F%20and%20when%20should%20we%20use%20deferreds%3F&In-Reply-To=da776a8c0804252344g17c3bd9dm65b859c263585a50%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003753.html">
   <LINK REL="Next"  HREF="003755.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] what are the advantage of using a
	single-threaded server? and when should we use deferreds?</H1>
    <B>Andrew Bennetts</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20what%20are%20the%20advantage%20of%20using%20a%0A%09single-threaded%20server%3F%20and%20when%20should%20we%20use%20deferreds%3F&In-Reply-To=da776a8c0804252344g17c3bd9dm65b859c263585a50%40mail.gmail.com"
       TITLE="[Twisted-web] what are the advantage of using a
	single-threaded server? and when should we use deferreds?">andrew-twisted at puzzling.org
       </A><BR>
    <I>Sat Apr 26 05:42:46 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="003753.html">[Twisted-web] what are the advantage of using a single-threaded
	server? and when should we use deferreds?
</A></li>
        <LI>Next message: <A HREF="003755.html">[Twisted-web] what are the advantage of using a single-threaded
	server? and when should we use deferreds?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3754">[ date ]</a>
              <a href="thread.html#3754">[ thread ]</a>
              <a href="subject.html#3754">[ subject ]</a>
              <a href="author.html#3754">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>inhahe wrote:
&gt;<i> hi, excuse my noobness, I have a few basic questions about twisted, or probably
</I>&gt;<i> about web servers in general.
</I>
There's nothing web-specific in these questions that I see... they apply to any
network service serving requests.

&gt;<i> what is the advantage of using a single-threaded server?
</I>&gt;<i> 
</I>&gt;<i> i figured it makes it more scalable because there's too much overhead to have a
</I>&gt;<i> thread for each user when you have many simultaneous users.  but a friend i'm
</I>&gt;<i> talking to now says that using i/o blocking threads is perfectly scalable for a
</I>&gt;<i> large number of simultaneous users. 
</I>
That's basically right.  Threads can be a scalability issue, particularly if you
have many connections that are mostly idle&#8202;&#8212;&#8202;you end up with a lot of wasted
memory (for stack space).

Another problem with threads is non-determinism.  You can't easy construct a
test suite that will find every possible race condition, because a thread can be
pre-empted at any time.  In effect you have a state machine with a massive
number of states, many more than necessary.  With a single thread, you can
simply and reliably test what happens when events happen a particular order. 

Personally, I find this latter advantage more compelling.  The performance
differences are in many respects minor (and not clearly one way), especially
compared to the overhead of using Python over C/C++.  I find it *much* easier to
write and test non-threaded code (and for that matter, I find it much easier to
write and test Python).  No point worrying about performance unless I can be
confident in the correctness :)

&gt;<i> if that's true i can only see a disadvantage in using a single-threaded server
</I>&gt;<i> -- having to use deferreds and stuff to make things asynchronous
</I>
That is a disadvantage.  Creating lots of objects and calling lots of functions
can be a performance issue in Python.  Deferreds are *much* nicer than the
obvious alternative (passing callback functions to functions that produce
asynchronous results), though.

Fundamentally, concurrent programming is more complex than non-concurrent.  The
question is which tradeoffs suit your problem best.

&gt;<i> i also don't understand how you're supposed to use deferreds
</I>&gt;<i> the twisted doc says deferreds won't *make* your code asynchronous.  so let's
</I>&gt;<i> say you have to do an sql query that takes 10 seconds, deferreds would be
</I>&gt;<i> useless for making that not block unless you have a way of making that sql
</I>&gt;<i> query non-blocking already?  how is that done?  do you run a separate thread of
</I>&gt;<i> your own for each sql query?  one thread for all sql queries?
</I>
You've got it.  If you have a blocking API, there's nothing you can do to make
it non-blocking apart from running it in a thread (if it's kind enough to
release the GIL) or running it in a subprocess (if you don't mind the overhead
of spawning another process and the complexity of marshalling messages to it
rather than simply sharing an address space).

Note that a common compromise between &#8220;a separate thread of your own for each
sql query&#8221; and &#8220;one thread for all sql queries&#8221; is a thread pool with a limited
number of threads.  This is what twisted.enterprise.adbapi basically does to run
SQL using the standard Python DB-API.

&gt;<i> also I wonder in an typical twisted app, just how slow should an operation be
</I>&gt;<i> before you use a deferred?  what if a user enters a username and password and i
</I>&gt;<i> have to look that up in the database. do i use a deferred?  just how bad should
</I>&gt;<i> the query be before using a deferred?
</I>
The precise answer is: it depends.

The short answer is: if it does I/O or is obviously slower than instant, then
it's blocking and should be avoided (in your main thread).

To be precise: it depends on your requirements: basically, what performance do
you need?  If a lookup in the database is only, say, 30ms, and you don't lots of
concurrent requests, and they only need to do that one lookup, and you only need
an average latency for replying to requests of 100ms, then you'd be pretty
comfortable with just blocking for that lookup.

Typically, anything that doesn't return immediately, for some value of
&#8220;immediately&#8221;, is good to treat as blocking, and thus something to avoid in your
main thread.  Small writes to disk are often fast enough to count as
&#8220;immediate&#8221;.  Small reads that are probably cached in RAM by your OS might be
too.  Querying a database usually isn't.  It depends on your exact situation,
though.  It sounds like you already have a good idea of the sorts of things to
watch out for, though.

Basically, there's no magic substitute for measuring actual performance, and
asking yourself &#8220;is it good enough?&#8221;

&gt;<i> (reading the twisted docs is like reading a brick wall for me, it would be nice
</I>&gt;<i> if someone could just explain things to me in simple terms.)
</I>
It sounds to me like you've actually understood things quite well. :)

-Andrew.


</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003753.html">[Twisted-web] what are the advantage of using a single-threaded
	server? and when should we use deferreds?
</A></li>
	<LI>Next message: <A HREF="003755.html">[Twisted-web] what are the advantage of using a single-threaded
	server? and when should we use deferreds?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3754">[ date ]</a>
              <a href="thread.html#3754">[ thread ]</a>
              <a href="subject.html#3754">[ subject ]</a>
              <a href="author.html#3754">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
