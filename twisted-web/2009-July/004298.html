<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Guard, LastPage Memory Leak?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Guard%2C%20LastPage%20Memory%20Leak%3F&In-Reply-To=4A70DC82.4080608%40yahoo.it">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004297.html">
   <LINK REL="Next"  HREF="004299.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Guard, LastPage Memory Leak?</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Guard%2C%20LastPage%20Memory%20Leak%3F&In-Reply-To=4A70DC82.4080608%40yahoo.it"
       TITLE="[Twisted-web] Guard, LastPage Memory Leak?">exarkun at divmod.com
       </A><BR>
    <I>Wed Jul 29 20:47:29 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004297.html">[Twisted-web] Guard, LastPage Memory Leak?
</A></li>
        <LI>Next message: <A HREF="004299.html">[Twisted-web] Guard, LastPage Memory Leak?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4298">[ date ]</a>
              <a href="thread.html#4298">[ thread ]</a>
              <a href="subject.html#4298">[ subject ]</a>
              <a href="author.html#4298">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 30 Jul 2009 01:34:26 +0200, Federico Tomassini &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">federicotom at yahoo.it</A>&gt; wrote:
&gt;<i>Jean-Paul Calderone wrote:
</I>&gt;<i>
</I>&gt;&gt;&gt;<i>Ok, this minimal server application proofs that a memory
</I>&gt;&gt;&gt;<i>leak exists somewhere. This is already a good result.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I messed around with this for a while.  Unfortunately, I am not able
</I>&gt;&gt;<i> to reproduce a memory leak using it.  I found some things which I find
</I>&gt;&gt;<i> suspicious in Nevow, but none of them explains a leak.
</I>&gt;<i>
</I>&gt;<i>Are you saying that you are not sure about memory leaks
</I>&gt;<i>existence?
</I>
No, only that I am not able to reproduce it (I believe you when you say that
you have a server which leaks memory).

&gt;<i>The previous example allocates memory such way:
</I>&gt;<i>
</I>&gt;<i>  def afterRender(self, *a):
</I>&gt;<i>    self.foo= ['a' * (10**6) for i in xrange(100)]
</I>&gt;<i>
</I>&gt;<i>When logout, memory remains allocated unless you
</I>&gt;<i>create a destroyer method that deletes the foo
</I>&gt;<i>attr before the exit, explicitley.
</I>&gt;<i>
</I>&gt;<i>Memory leaks appears also when rend.Page.data_bar()
</I>&gt;<i>is used. Both cases seem to be related to WovenContext
</I>&gt;<i>and docFactory (a lot of WovenCtx and IMacroFactory
</I>&gt;<i>instances seems to stick in docFactory._cache).
</I>
Yes, this I am able to observe.  However, this leak limits itself to a single
instance.  After the first request, no further memory is leaked (when I try
the example you provided).

&gt;<i>In fact, this part of nevow is simply a Memory
</I>&gt;<i>Blackhole. Inside docFactory._cache one can find
</I>&gt;<i>various sticky objects.
</I>
Yes, but they're generally things which are needed over and over again for
every request.  That is the purpose of the cache. :)

&gt;<i>So, why &quot;you are not able to reproduce it&quot;?
</I>
When I run the example, it starts off by using about 10MB of memory.  When I
make one request of it, it jumps to 50MB of memory.  When I make a second (or
third, or any additional number) request of it, memory usage remains at
50MB.  So, that's what I mean.

&gt;<i>This is a *really heavy* problem. So, imho, nevow
</I>&gt;<i>should work on it with energies.
</I>
I can understand how it would seem to be a very serious problem from your
perspective.  It probably makes your Nevow-based application unusable, or at
least require significant additional administrative resources.

However... none of *my* Nevow-based applications exhibit this behavior. Even
ignoring the fact that this makes it very difficult for me to try to fix the
problem (or even understand what the problem is - I still don't, by the way),
this means it's not going to work its way very far up my list of priorities -
sorry.  There are other ways to move things up my list of priorities, most
prominently, you could fund the debugging and development required to fix the
issue.  As my employer has recently become defunct, the logistics of this are
slightly complicated, but I'm sure we can work something out if you are
interested.

All that said, I'm still happy to give you my time in working on this,
provided an example I can use to reproduce the misbehavior myself.  Without
this, it's just too hard.

&gt;<i>Maybe the better way is to redesign WovenCtx machinery,
</I>&gt;<i>as Jean-Paul suggested. But it's absolutely important
</I>&gt;<i>to make an intervention.
</I>&gt;<i>
</I>&gt;<i>I can help. If we need to redesign WovenCtx and someone
</I>&gt;<i>is able to guide my work (requiring to me precise APIs
</I>&gt;<i>or Classes), you can rely on my contribution.
</I>
Some effort has been directed towards this goal already.  Element supersedes
Fragment.  It comes with a flattener which doesn't use the context (except
for backwards compatibility).  The next step is to provide a similar class to
supersede Page.  This hasn't been extremely high priority, since it's always
possible to structure all of your rendering logic as a number of Elements
with only the thinnest layer of support from Page.

Jean-Paul

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004297.html">[Twisted-web] Guard, LastPage Memory Leak?
</A></li>
	<LI>Next message: <A HREF="004299.html">[Twisted-web] Guard, LastPage Memory Leak?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4298">[ date ]</a>
              <a href="thread.html#4298">[ thread ]</a>
              <a href="subject.html#4298">[ subject ]</a>
              <a href="author.html#4298">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
