<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] [Twisted-Python] Speed of rendering?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20%5BTwisted-Python%5D%20Speed%20of%20rendering%3F&In-Reply-To=B4FD5ED3-74A3-4EF7-85AA-7E43D20026BF%40twistedmatrix.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004990.html">
   <LINK REL="Next"  HREF="004992.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] [Twisted-Python] Speed of rendering?</H1>
    <B>Peter Westlake</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20%5BTwisted-Python%5D%20Speed%20of%20rendering%3F&In-Reply-To=B4FD5ED3-74A3-4EF7-85AA-7E43D20026BF%40twistedmatrix.com"
       TITLE="[Twisted-web] [Twisted-Python] Speed of rendering?">peter.westlake at pobox.com
       </A><BR>
    <I>Wed Feb 27 06:55:19 EST 2013</I>
    <P><UL>
        <LI>Previous message: <A HREF="004990.html">[Twisted-web] [Twisted-Python] Speed of rendering?
</A></li>
        <LI>Next message: <A HREF="004992.html">[Twisted-web] [Twisted-Python] Speed of rendering?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4991">[ date ]</a>
              <a href="thread.html#4991">[ thread ]</a>
              <a href="subject.html#4991">[ subject ]</a>
              <a href="author.html#4991">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Feb 27, 2013, at 0:39, Glyph wrote:
&gt;<i> 
</I>&gt;<i> On Feb 26, 2013, at 10:05 AM, Peter Westlake &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">peter.westlake at pobox.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; On Sun, Jan 6, 2013, at 20:22, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">exarkun at twistedmatrix.com</A> wrote:
</I>&gt;<i> &gt;&gt; On 12:48 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">peter.westlake at pobox.com</A> wrote:
</I>&gt;<i> &gt;&gt;&gt; On Fri, Jan 4, 2013, at 19:58, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">exarkun at twistedmatrix.com</A> wrote:
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt;&gt; Codespeed cannot handle more than one result per benchmark.
</I>&gt;<i> &gt;&gt;&gt;&gt; The `timeit` module is probably not suitable to use to collect the data
</I>&gt;<i> &gt; .....
</I>&gt;<i> &gt;&gt;&gt; What method would you prefer?
</I>&gt;<i> &gt;&gt; 
</I>&gt;<i> &gt;&gt; Something simple and accurate. :)  You may need to do some investigation 
</I>&gt;<i> &gt;&gt; to determine the best approach.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; 1. This is simple:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;    def do_benchmark(content):
</I>&gt;<i> &gt;         t1 = time.time()
</I>&gt;<i> &gt;         d = flatten(request, content, lambda _: None)
</I>&gt;<i> &gt;         t2 = time.time()
</I>&gt;<i> &gt;         assert d.called
</I>&gt;<i> &gt;         return t2 - t1
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Do you think it's acceptably accurate? After a few million iterations,
</I>&gt;<i> &gt; the relative error should be pretty small.
</I>&gt;<i> 
</I>&gt;<i> Well it rather depends on the contents of 'content', doesn't it? :)
</I>
Yes, sorry, the loop is meant to be around the flatten call!
Corrected version below.

&gt;<i> I think we have gotten lost in the weeds here. We talked
</I>&gt;<i> about using benchlib.py initially, and then you noticed a
</I>&gt;<i> bug, and it was mentioned that benchlib.py was mostly
</I>&gt;<i> written for testing asynchronous things and didn't have
</I>&gt;<i> good support for testing the simple case here, which is
</I>&gt;<i> synchronous rendering of a simple document. However, one
</I>&gt;<i> of twisted.web.template's major features - arguably its
</I>&gt;<i> reason for existing in a world that is practically overrun
</I>&gt;<i> by HTML templating systems - is that it supports
</I>&gt;<i> Deferreds. So we'll want that anyway.
</I>
That's true, and I'll include some Deferreds in the content
to be flattened. But if the Deferreds actually do any
lengthy processing, it makes a nonsense of the benchmark. It
only makes sense to use ones that have already fired, i.e.
defer.succeed(...). The other benchmarks are testing
asynchronous operations, as names like &quot;ssl_throughput&quot;
suggest. Flattening doesn't do any of that, and I'm only
trying to measure the speed of flattening.

&gt;<i> The right thing to do here would be to update benchlib
</I>&gt;<i> itself with a few simple tools for doing timing of
</I>&gt;<i> synchronous tasks, and possibly also to just fix the
</I>&gt;<i> unbounded-recursion bug that you noticed, not to start
</I>&gt;<i> building a new, parallel set of testing tools which use
</I>&gt;<i> different infrastructure. That probably means implementing
</I>&gt;<i> a small subset of timeit.
</I>
I'm not convinced that the unbounded recursion is actually a
bug. A callback on a fired Deferred will be executed
immediately, and that's correct behaviour. There's no chance
to return control to the reactor, and even if there was,
anything that happened in that time would only skew the
results. The real problem is that recursion-by-Deferred
doesn't have the optimisation for tail recursion found in
most functional languages, because that would be very
difficult and it's not how Deferreds are usually used.

&gt;<i> &gt; 2. For the choice of test data, I had a quick search for
</I>&gt;<i> &gt; benchmarks from other web frameworks. All I found was
</I>&gt;<i> &gt; &quot;hello world&quot; benchmarks, that test the overhead of the
</I>&gt;<i> &gt; framework itself by rendering an empty page. I'll
</I>&gt;<i> &gt; include that, of course.
</I>&gt;<i> 
</I>&gt;<i> &quot;hello world&quot; benchmarks have problems because start-up
</I>&gt;<i> overhead tends to dominate. A realistic web page with some
</I>&gt;<i> slots and renderers sprinkled throughout would be a lot
</I>&gt;<i> better. Although even better would be a couple of cases -
</I>&gt;<i> let's say small, large-sync, and large-async - so we can
</I>&gt;<i> see if optimizations for one case hurt another.
</I>
Yes, I'm just making my excuses for not copying benchmarks
from an existing framework.

&gt;<i> As Jean-Paul already mentioned in this thread, you can't
</I>&gt;<i> have more than one result per benchmark, so you'll need to
</I>&gt;<i> choose a fixed number of configurations and create one
</I>&gt;<i> benchmark for each.
</I>&gt;<i> 
</I>&gt;<i> &gt; 3. Regarding option parsing, is there any reason to
</I>&gt;<i> &gt;    prefer twisted.python.usage.Options over [...]
</I>&gt;<i> 
</I>&gt;<i> The reason to prefer usage.Options is consistency. ...
</I>
OK

&gt;<i>  The thing to implement would be a different driver() function that makes
</I>&gt;<i> a few simple synchronous calls without running the
</I>&gt;<i> reactor.
</I>
If you don't mind the overhead of an extra function call,
that could be as simple as:

def sync_benchmark(iterations, name, func, *args):
    t1 = time.time()
    for _ in range(iterations):
        func(*args)
    t2 = time.time()
    benchlib.benchmark_report(iterations, t2 - t1, name)

I'm not sure if options['iterations'] would be the right
thing to use here, because it gives the number of times to
repeat the whole benchmark, not the number of times round
the inner loop. The async code uses options['duration'],
but there would be more overhead to run synchronous code
for a given duration.

Peter.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004990.html">[Twisted-web] [Twisted-Python] Speed of rendering?
</A></li>
	<LI>Next message: <A HREF="004992.html">[Twisted-web] [Twisted-Python] Speed of rendering?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4991">[ date ]</a>
              <a href="thread.html#4991">[ thread ]</a>
              <a href="subject.html#4991">[ subject ]</a>
              <a href="author.html#4991">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
