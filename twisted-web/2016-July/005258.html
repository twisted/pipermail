<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] getSession, componentized but not async?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20getSession%2C%20componentized%20but%20not%20async%3F&In-Reply-To=%3CCAHPVzqan%3D%2BDFi0FdQwPCpNLKQQt9bXmp3%2BPz_T8MuWD%3Dyiuo3Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005256.html">
   <LINK REL="Next"  HREF="005259.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] getSession, componentized but not async?</H1>
    <B>Carl Waldbieser</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20getSession%2C%20componentized%20but%20not%20async%3F&In-Reply-To=%3CCAHPVzqan%3D%2BDFi0FdQwPCpNLKQQt9bXmp3%2BPz_T8MuWD%3Dyiuo3Q%40mail.gmail.com%3E"
       TITLE="[Twisted-web] getSession, componentized but not async?">cwaldbieser at gmail.com
       </A><BR>
    <I>Thu Jul  7 06:14:23 MDT 2016</I>
    <P><UL>
        <LI>Previous message: <A HREF="005256.html">[Twisted-web] getSession, componentized but not async?
</A></li>
        <LI>Next message: <A HREF="005259.html">[Twisted-web] getSession, componentized but not async?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5258">[ date ]</a>
              <a href="thread.html#5258">[ thread ]</a>
              <a href="subject.html#5258">[ subject ]</a>
              <a href="author.html#5258">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Creating the session follows the normal Twisted modus operandi-- create a
factory that returns the actual thing you want and attach the session to
your site.  I wrote an authenticating web proxy[1] that does just that.  If
you skim down to the `sessionFactory()` function, you can see it is not
overly complicated.

The docs on storing objects in a session[2] are a bit complex.  They are
basically taking the approach where the idea is when you can
`request.getSession()`, you can pass in an interface and get back an object
that corresponds to that interface.  This can actually be useful in larger
systems where you are making use of heavily componentized code, but in some
cases it does seem like overkill.

Since the main thing that the stock `Session` buys you is expiration, you
can use the `Session.notifyOnExpire()` method to update other data
structures.  My authenticating proxy took that approach for keeping track
of authenticated users (see the &quot;txcasproxy.py&quot; file around the `_expired`
function).

As for persisting session data-- I guess the idea is that storing or
retrieving the session object doesn't need to be async because it is just
an object in memory corresponding to a cookie in the request.  However,
writing to or reading from the session could definitely require async
methods that talk to a back end store.  This could potentially be one area
where implementing a component with an interface like
`IRedisSessionStorage` might be useful (get session synchonously from
request passing in IRedisStorage,  then call `storeThingInSession()` which
returns a deferred).

Thanks,
Carl


[1]
<A HREF="https://github.com/cwaldbieser/txcasproxy/blob/master/txcasproxy/service.py">https://github.com/cwaldbieser/txcasproxy/blob/master/txcasproxy/service.py</A>

[2]
<A HREF="https://twistedmatrix.com/documents/current/web/howto/web-in-60/session-store.html">https://twistedmatrix.com/documents/current/web/howto/web-in-60/session-store.html</A>


On Tue, Jul 5, 2016 at 12:03 PM, Donal McMullan &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">donal.mcmullan at gmail.com</A>&gt;
wrote:

&gt;<i> I'm curious about request.getSession
</I>&gt;<i>
</I>&gt;<i> Per the docs:
</I>&gt;<i> <A HREF="https://twistedmatrix.com/documents/current/web/howto/using-twistedweb.html">https://twistedmatrix.com/documents/current/web/howto/using-twistedweb.html</A>
</I>&gt;<i>
</I>&gt;<i> It seems like it's tricky to use correctly. My code needs to:
</I>&gt;<i>  - define an Interface
</I>&gt;<i>  - define a class that implements my Interface
</I>&gt;<i>  - call registerAdapter, passing in my class, server.Session and my
</I>&gt;<i> Interface
</I>&gt;<i>  - get a Session instance
</I>&gt;<i>  - brace myself
</I>&gt;<i>  - create an instance of my Interface class, passing in the Session
</I>&gt;<i> instance
</I>&gt;<i>  - update that Interface instance.... it will persisted, but only in-memory
</I>&gt;<i>
</I>&gt;<i> By default, that data doesn't go to database/memcached/whatever, so it's
</I>&gt;<i> only accessible in-process
</I>&gt;<i>
</I>&gt;<i> On first blush, that seems like a lot of legwork. I'm not clear on what
</I>&gt;<i> utility's provided by all this versus say maintaining a dict as a
</I>&gt;<i> class-attribute on Site or something. It's also (for me) counter-intuitive
</I>&gt;<i> to be creating an instance of an _Interface_ and poking data into it.
</I>&gt;<i>
</I>&gt;<i> Also I was a bit surprised that getSession doesn't return a deferred,
</I>&gt;<i> since it seems like it'd be common to want to persist session data in an
</I>&gt;<i> external store so that multiple twisted-web processes can access it in a
</I>&gt;<i> clustered/load-balanced setup. How do other folks go about that?
</I>&gt;<i>
</I>&gt;<i> I hacked something together a while ago to run session data into Redis,
</I>&gt;<i> but what I ended up with required so much surgery on twisted web's classes
</I>&gt;<i> that I figured I must be doing it wrong. I think Site, SessionFactory and
</I>&gt;<i> Request were all customised.
</I>&gt;<i>
</I>&gt;<i> I was thinking about this again in the context of Cory's &quot;Implement
</I>&gt;<i> server-side HTTP/2 server push&quot; ticket:
</I>&gt;<i> <A HREF="https://twistedmatrix.com/trac/ticket/8485">https://twistedmatrix.com/trac/ticket/8485</A>
</I>&gt;<i>
</I>&gt;<i> In this context, I'd like to have access to my session data in multiple
</I>&gt;<i> Resource objects without _necessarily_ having to round-trip to an external
</I>&gt;<i> store each time to get/put the same data. In the case of http 1.1 requests,
</I>&gt;<i> I guess there's no way around that round-trip, so it might be optimal if my
</I>&gt;<i> Resource objects could be oblivious to the underlying protocol version and
</I>&gt;<i> Session get/put mechanism.
</I>&gt;<i>
</I>&gt;<i> So it'd be great if the default Session mechanism could take care of me
</I>&gt;<i> there, and I could just have my cake and eat it.
</I>&gt;<i>
</I>&gt;<i> Another wrinkle that surprised me when I was hacking on this was that
</I>&gt;<i> there didn't seem to be a way to uniquely identify a request instance, so
</I>&gt;<i> within the session code it was impossible to tell if two calls to
</I>&gt;<i> getSession were coming from different points in the callback chain
</I>&gt;<i> responding to a single Request, or if the second belonged to a different
</I>&gt;<i> Request entirely.
</I>&gt;<i>
</I>&gt;<i> So my confusion is probably apparent at this stage :)
</I>&gt;<i>
</I>&gt;<i> I'm guessing others have been here before me. What approaches have you
</I>&gt;<i> taken to storing your sessions? Are there good open source projects that I
</I>&gt;<i> should look to for best practice?
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i> DJM
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20160707/7930b957/attachment.html">http://twistedmatrix.com/pipermail/twisted-web/attachments/20160707/7930b957/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005256.html">[Twisted-web] getSession, componentized but not async?
</A></li>
	<LI>Next message: <A HREF="005259.html">[Twisted-web] getSession, componentized but not async?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5258">[ date ]</a>
              <a href="thread.html#5258">[ thread ]</a>
              <a href="subject.html#5258">[ subject ]</a>
              <a href="author.html#5258">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
