From gus.duarte at gmail.com  Fri Aug  5 13:26:52 2011
From: gus.duarte at gmail.com (Gustavo Duarte)
Date: Fri, 05 Aug 2011 14:26:52 -0300
Subject: [Twisted-web] Nevow sources
Message-ID: <4E3C27DC.8020408@gmail.com>

Hi all,

Someone could tell me where I can find nevow sources ?

Thanks in advance.

Gustavo.


From exarkun at twistedmatrix.com  Fri Aug  5 15:42:25 2011
From: exarkun at twistedmatrix.com (exarkun at twistedmatrix.com)
Date: Fri, 05 Aug 2011 19:42:25 -0000
Subject: [Twisted-web] Nevow sources
In-Reply-To: <4E3C27DC.8020408@gmail.com>
References: <4E3C27DC.8020408@gmail.com>
Message-ID: <20110805194225.2280.1832218593.divmod.xquotient.235@localhost.localdomain>

On 05:26 pm, gus.duarte at gmail.com wrote:
>Hi all,
>
>Someone could tell me where I can find nevow sources ?

See http://launchpad.net/divmod.org or just `bzr branch lp:divmod.org`.

Jean-Paul


From gus.duarte at gmail.com  Fri Aug  5 23:30:43 2011
From: gus.duarte at gmail.com (Gustavo Duarte)
Date: Sat, 6 Aug 2011 00:30:43 -0300
Subject: [Twisted-web] Nevow sources
In-Reply-To: <20110805194225.2280.1832218593.divmod.xquotient.235@localhost.localdomain>
References: <4E3C27DC.8020408@gmail.com>
	<20110805194225.2280.1832218593.divmod.xquotient.235@localhost.localdomain>
Message-ID: <CACV5_BVXJmrOLPGdzn_RK1oZ+aQftLx2tOWJ27LXhezBRi9JmA@mail.gmail.com>

Thanks, very much.

El ago 5, 2011 4:43 p.m., <exarkun at twistedmatrix.com> escribi?:

On 05:26 pm, gus.duarte at gmail.com wrote:
>Hi all,
>
>Someone could tell me where I can find nevow so...
See http://launchpad.net/divmod.org or just `bzr branch lp:divmod.org`.

Jean-Paul

_______________________________________________
Twisted-web mailing list
Twisted-web at twistedmatrix.com
http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110806/e33b2688/attachment.htm 

From gonvaled at gonvaled.com  Mon Aug  8 14:00:51 2011
From: gonvaled at gonvaled.com (Daniel Gonzalez)
Date: Mon, 8 Aug 2011 20:00:51 +0200
Subject: [Twisted-web] Implementing a continuous polling client in twisted
Message-ID: <CAAOi-OE7b1X7fS_FbDtd36GqV91SaRSKK5e7ZgzpsHGO=6pLPQ@mail.gmail.com>

Hello,

I am trying to implement a continuous polling client for couchdb change
notifications, which uses HTTP protocol (REST):

http://guide.couchdb.org/draft/notifications.html

I have started by using the agent described here:
http://twistedmatrix.com/documents/current/web/howto/client.html

This is working fine, but the problem is that the connection is not
permanent: it is being closed after a timeout (I think 1 minute).
For continuous polling, I need to keep the connection open (forever), or if
that is not possible, to reconnect as soon as the connection is closed.

I have taken a look at the code, and the problem seems to be that the Agent
(twisted/web/client.py) class is using ClientCreator
(twisted/internet/protocol.py)
ClientCreator is not doing reconnection. I would like to implement a similar
class to ClientCreator, but one which uses ReconnectingClientFactory
(twisted/internet/protocol.py)

I have not found any guidance in using ReconnectingClientFactory. According
to the documentation:

"Note that clients should call my resetDelay method after they
have connected successfully."

The difficulty I have is that the factory is not returning any deferred
which I could use to catch when connections are established, and then call
the resetDelay method.

Do you have any pointers to examples of use of ReconnectingClientFactory?

BR,
Daniel Gonzalez
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110808/7fd52c23/attachment.htm 

From bdfy at mail.ru  Wed Aug 10 12:02:51 2011
From: bdfy at mail.ru (=?UTF-8?B?SXZhbg==?=)
Date: Wed, 10 Aug 2011 20:02:51 +0400
Subject: [Twisted-web] =?utf-8?q?How_to_disable_messages_in_client=2EgetPa?=
	=?utf-8?q?ge_=3F?=
In-Reply-To: <CAAOi-OE7b1X7fS_FbDtd36GqV91SaRSKK5e7ZgzpsHGO6pLPQ@mail.gmail.com>
References: <CAAOi-OE7b1X7fS_FbDtd36GqV91SaRSKK5e7ZgzpsHGO6pLPQ@mail.gmail.com>
Message-ID: <E1QrBF5-0001Lh-00.bdfy-mail-ru@f213.mail.ru>

How to disable messages in client.getPage:

2011-08-10 19:57:38+0400 [HTTPPageDownloader,client] Starting factory <HTTPDownloader

....

??
   document.write(' 
 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110810/74a607b7/attachment.htm 

From schenette at gmail.com  Fri Aug 19 00:42:03 2011
From: schenette at gmail.com (Stephan)
Date: Thu, 18 Aug 2011 21:42:03 -0700
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
Message-ID: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>

I'm attempting to spawn xvfb with firefox using twisted's spawnProcess.

I'm having two issues:

1) when I call a normal process (not xvfb) it seems to
work, but when I call xvfb the process goes defunct

2) perhaps because it goes defunct but the timeout I set in place in
the processprotocol does
not trigger.

==============
here is the code for spawning a process
==============
108         command = ["/usr/bin/xvfb-run", "--auto-servernum",
"/usr/bin/firefox", "-P", profile_id]
109         subprocess = reactor.spawnProcess(TimedProcessProtocol(20),
110                                             command[0], command)
111         logging.debug(type(subprocess))
112         logging.debug("spawned a process: pid: %d", subprocess.pid)
113
114         # this file will be created when firefox starts
115         while (not os.path.exists(self.profile_dir + "/importantfile")):
116             logging.debug("in while loop waiting for
firesharkReady file to exist")
117             pass
118
119         logging.debug("file exist")

==============
here is the process class
==============

 27 class TimedProcessProtocol(protocol.ProcessProtocol):
 28
 29     def __init__(self, timeout):
 30         self.timeout = timeout
 31
 32     def connectionMade(self):
 33         logging.debug("connection made timeout = %d", self.timeout)
 34         @defer.inlineCallbacks
 35         def killIfAlive():
 36             logging.debug("timeout reached - killing process")
 37             try:
 38                 yield self.transport.signalProcess('KILL')
 39             except error.ProcessExitedAlready:
 40                 logging.debug("process already exited")
 41                 pass
 42
 43         d = reactor.callLater(self.timeout, killIfAlive)
 44
 45     def outReceived(self, data):
 46         logging.debug("output: %s", data)
 47
 48     def errReceived(self, data):
 49         logging.debug("errReceived %s", data)


From glyph at twistedmatrix.com  Fri Aug 19 00:51:17 2011
From: glyph at twistedmatrix.com (Glyph Lefkowitz)
Date: Fri, 19 Aug 2011 00:51:17 -0400
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
Message-ID: <5D130B54-11F3-4B4A-9D54-97569752FCA8@twistedmatrix.com>


On Aug 19, 2011, at 12:42 AM, Stephan wrote:

> I'm attempting to spawn xvfb with firefox using twisted's spawnProcess.
> 
> I'm having two issues:
> 
> 1) when I call a normal process (not xvfb) it seems to work, but when I call xvfb the process goes defunct

Defunct processes have exited, but not been reaped.  In older versions of Twisted, this might happen if some other library were competing to register the SIGCHLD signal.  What version of Twisted are you using?

> 2) perhaps because it goes defunct but the timeout I set in place in the processprotocol does
> not trigger.

It should never go defunct, whether or not your timeout triggers.

> ==============
> here is the code for spawning a process
> ==============
> 108         command = ["/usr/bin/xvfb-run", "--auto-servernum",
> "/usr/bin/firefox", "-P", profile_id]
> 109         subprocess = reactor.spawnProcess(TimedProcessProtocol(20),
> 110                                             command[0], command)
> 111         logging.debug(type(subprocess))
> 112         logging.debug("spawned a process: pid: %d", subprocess.pid)
> 113
> 114         # this file will be created when firefox starts
> 115         while (not os.path.exists(self.profile_dir + "/importantfile")):
> 116             logging.debug("in while loop waiting for
> firesharkReady file to exist")
> 117             pass

You should really not busy-loop like this waiting for the subprocess.  Have a repeating callLater (or LoopingCall) that does this check cooperatively with the reactor, so if something goes wrong (for example: firefox fails to launch), you'll be able to react to it effectively rather than just hanging your Twisted process forever.  If firefox isn't actually starting correctly, or that file doesn't actually get created for some reason, this could cause the defunct process.

> 118
> 119         logging.debug("file exist")
> 
> ==============
> here is the process class
> ==============
> 
> 27 class TimedProcessProtocol(protocol.ProcessProtocol):
> 28
> 29     def __init__(self, timeout):
> 30         self.timeout = timeout
> 31
> 32     def connectionMade(self):
> 33         logging.debug("connection made timeout = %d", self.timeout)
> 34         @defer.inlineCallbacks
> 35         def killIfAlive():
> 36             logging.debug("timeout reached - killing process")
> 37             try:
> 38                 yield self.transport.signalProcess('KILL')
> 39             except error.ProcessExitedAlready:
> 40                 logging.debug("process already exited")
> 41                 pass
> 42
> 43         d = reactor.callLater(self.timeout, killIfAlive)
> 44
> 45     def outReceived(self, data):
> 46         logging.debug("output: %s", data)
> 47
> 48     def errReceived(self, data):
> 49         logging.debug("errReceived %s", data)
> 
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web



From schenette at gmail.com  Fri Aug 19 01:14:09 2011
From: schenette at gmail.com (Stephan)
Date: Thu, 18 Aug 2011 22:14:09 -0700
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <5D130B54-11F3-4B4A-9D54-97569752FCA8@twistedmatrix.com>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
	<5D130B54-11F3-4B4A-9D54-97569752FCA8@twistedmatrix.com>
Message-ID: <CADozHMWK+igDEKePaMs+fEmxknvj3DgNcxK2yRSTR9mx22KSAg@mail.gmail.com>

Thanks for the prompt reply response inline. I'm still having issues
even though I've changed some code based on your advice.

On Thu, Aug 18, 2011 at 9:51 PM, Glyph Lefkowitz
<glyph at twistedmatrix.com> wrote:
>
> On Aug 19, 2011, at 12:42 AM, Stephan wrote:
>
>> I'm attempting to spawn xvfb with firefox using twisted's spawnProcess.
>>
>> I'm having two issues:
>>
>> 1) when I call a normal process (not xvfb) it seems to work, but when I call xvfb the process goes defunct
>
> Defunct processes have exited, but not been reaped. ?In older versions of Twisted, this might happen if some other library were competing to register the SIGCHLD signal. ?What version of Twisted are you using?

I'm using the latest version (I installed it today). 11.0.0 on an ubuntu machine

>
>> 2) perhaps because it goes defunct but the timeout I set in place in the processprotocol does
>> not trigger.
>
> It should never go defunct, whether or not your timeout triggers.

I agree, I can't figure out why it's going defunct.

>
>> ==============
>> here is the code for spawning a process
>> ==============
>> 108 ? ? ? ? command = ["/usr/bin/xvfb-run", "--auto-servernum",
>> "/usr/bin/firefox", "-P", profile_id]
>> 109 ? ? ? ? subprocess = reactor.spawnProcess(TimedProcessProtocol(20),
>> 110 ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? command[0], command)
>> 111 ? ? ? ? logging.debug(type(subprocess))
>> 112 ? ? ? ? logging.debug("spawned a process: pid: %d", subprocess.pid)
>> 113
>> 114 ? ? ? ? # this file will be created when firefox starts
>> 115 ? ? ? ? while (not os.path.exists(self.profile_dir + "/importantfile")):
>> 116 ? ? ? ? ? ? logging.debug("in while loop waiting for
>> firesharkReady file to exist")
>> 117 ? ? ? ? ? ? pass
>
> You should really not busy-loop like this waiting for the subprocess. ?Have a repeating callLater (or LoopingCall) that does this check cooperatively with the reactor, so if something goes wrong (for example: firefox fails to launch), you'll be able to react to it effectively rather than just hanging your Twisted process forever. ?If firefox isn't actually starting correctly, or that file doesn't actually get created for some reason, this could cause the defunct process.


I agree with your point, I've changed it a bit (see the code at the
bottom) I'm not sure if this is correct or not.

>
>> 118
>> 119 ? ? ? ? logging.debug("file exist")
>>
>> ==============
>> here is the process class
>> ==============
>>
>> 27 class TimedProcessProtocol(protocol.ProcessProtocol):
>> 28
>> 29 ? ? def __init__(self, timeout):
>> 30 ? ? ? ? self.timeout = timeout
>> 31
>> 32 ? ? def connectionMade(self):
>> 33 ? ? ? ? logging.debug("connection made timeout = %d", self.timeout)
>> 34 ? ? ? ? @defer.inlineCallbacks
>> 35 ? ? ? ? def killIfAlive():
>> 36 ? ? ? ? ? ? logging.debug("timeout reached - killing process")
>> 37 ? ? ? ? ? ? try:
>> 38 ? ? ? ? ? ? ? ? yield self.transport.signalProcess('KILL')
>> 39 ? ? ? ? ? ? except error.ProcessExitedAlready:
>> 40 ? ? ? ? ? ? ? ? logging.debug("process already exited")
>> 41 ? ? ? ? ? ? ? ? pass
>> 42
>> 43 ? ? ? ? d = reactor.callLater(self.timeout, killIfAlive)
>> 44
>> 45 ? ? def outReceived(self, data):
>> 46 ? ? ? ? logging.debug("output: %s", data)
>> 47
>> 48 ? ? def errReceived(self, data):
>> 49 ? ? ? ? logging.debug("errReceived %s", data)
>>
>> _______________________________________________
>> Twisted-web mailing list
>> Twisted-web at twistedmatrix.com
>> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>
>
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>

============
new code (still does not work)
=============
108         profile_id = self.profile['name']
109         command = ["/usr/bin/xvfb-run", "--auto-servernum",
"/usr/bin/firefox", "-P", profile_id]
110         subprocess = reactor.spawnProcess(TimedProcessProtocol(20),
111                                             command[0], command)
112         logging.debug(type(subprocess))
113         logging.debug("spawned a process: pid: %d", subprocess.pid)
114
115         lc = LoopingCall(self.check_if_file)
116         self.check = lc
117         lc.start(0.5)
118
119     def check_if_file(self):
120         if os.path.exists(self.fireshark_profile_dir + "/firesharkReady"):
121             logging.debug("firesharkReady file to exist")
122             self.check.stop()

============
new code (log)
=============

478C0-CA07-11E0-B595-E88E810DE385
2011-08-18 22:06:58,038 DEBUG:FirefoxProcess run called
2011-08-18 22:06:58,038 DEBUG:intialize firefox files
2011-08-18 22:06:58,040 DEBUG:connection made timeout = 20
2011-08-18 22:06:58,041 DEBUG:<class 'twisted.internet.process.Process'>
2011-08-18 22:06:58,041 DEBUG:spawned a process: pid: 30562
2011-08-18 22:07:01,374 DEBUG:inConnectionLost
2011-08-18 22:07:01,374 DEBUG:errConnectionLost
2011-08-18 22:07:01,375 DEBUG:process exited, status 1


=======================

this time the xvfb process did not go defunct but it did exit, which
shouldn't really happen, firefox should just stay open really.


From glyph at twistedmatrix.com  Fri Aug 19 04:22:33 2011
From: glyph at twistedmatrix.com (Glyph Lefkowitz)
Date: Fri, 19 Aug 2011 04:22:33 -0400
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <CADozHMWK+igDEKePaMs+fEmxknvj3DgNcxK2yRSTR9mx22KSAg@mail.gmail.com>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
	<5D130B54-11F3-4B4A-9D54-97569752FCA8@twistedmatrix.com>
	<CADozHMWK+igDEKePaMs+fEmxknvj3DgNcxK2yRSTR9mx22KSAg@mail.gmail.com>
Message-ID: <EC63E826-27E8-49DE-A81D-455F787035E5@twistedmatrix.com>

On Aug 19, 2011, at 1:14 AM, Stephan wrote:

> Thanks for the prompt reply response inline. I'm still having issues
> even though I've changed some code based on your advice.


Perhaps you could reduce this to a complete, runnable example so that someone could reproduce the behavior you're seeing.  At this point further advice would be guessing on my part.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110819/c9795348/attachment.htm 

From schenette at gmail.com  Sat Aug 20 13:52:48 2011
From: schenette at gmail.com (Stephan)
Date: Sat, 20 Aug 2011 10:52:48 -0700
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <EC63E826-27E8-49DE-A81D-455F787035E5@twistedmatrix.com>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
	<5D130B54-11F3-4B4A-9D54-97569752FCA8@twistedmatrix.com>
	<CADozHMWK+igDEKePaMs+fEmxknvj3DgNcxK2yRSTR9mx22KSAg@mail.gmail.com>
	<EC63E826-27E8-49DE-A81D-455F787035E5@twistedmatrix.com>
Message-ID: <CADozHMVfHF1wDPuzJ8rFsZ7BOjGwyDNR3xbmH+5KeyM_Lbsbuw@mail.gmail.com>

Hi Glyph,

I've created a specially crafted runnable example
you can find it here: http://pastebin.com/dyhTFPjM

as you'll see in the debug log that is created:

2011-08-20 10:36:10,484 DEBUG:errReceived xvfb-run: error: Xvfb failed to start
2011-08-20 10:36:10,486 DEBUG:inConnectionLost
2011-08-20 10:36:10,486 DEBUG:errConnectionLost
2011-08-20 10:36:10,487 DEBUG:process exited, status 1

Any help is appreciated.
to install xvfb on linux if not already installed
sudo apt-get install xvfb

On Fri, Aug 19, 2011 at 1:22 AM, Glyph Lefkowitz
<glyph at twistedmatrix.com> wrote:
> On Aug 19, 2011, at 1:14 AM, Stephan wrote:
>
> Thanks for the prompt reply response inline. I'm still having issues
> even though I've changed some code based on your advice.
>
> Perhaps you could reduce this to a complete, runnable example so that
> someone could reproduce the behavior you're seeing. ?At this point further
> advice would be guessing on my part.
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>
>


From schenette at gmail.com  Sat Aug 20 15:29:05 2011
From: schenette at gmail.com (Stephan)
Date: Sat, 20 Aug 2011 12:29:05 -0700
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <CADozHMVfHF1wDPuzJ8rFsZ7BOjGwyDNR3xbmH+5KeyM_Lbsbuw@mail.gmail.com>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
	<5D130B54-11F3-4B4A-9D54-97569752FCA8@twistedmatrix.com>
	<CADozHMWK+igDEKePaMs+fEmxknvj3DgNcxK2yRSTR9mx22KSAg@mail.gmail.com>
	<EC63E826-27E8-49DE-A81D-455F787035E5@twistedmatrix.com>
	<CADozHMVfHF1wDPuzJ8rFsZ7BOjGwyDNR3xbmH+5KeyM_Lbsbuw@mail.gmail.com>
Message-ID: <CADozHMV+P2SEeAzJBFPx+uvUT619gGD+ACwviYw5ip6bN=xmjA@mail.gmail.com>

I've attempted to switch out spawnProcess for subprocess.Popen

e.g.

               command = "xvfb-run --auto-servernum firefox"
                args = shlex.split(command)
                #p = subprocess.Popen(args)
                #logging.debug("spawned a process: pid: %d", p.pid)
                subprocess =
reactor.spawnProcess(TimedProcessProtocol(20), args[0], args)

                logging.debug(type(subprocess))
                logging.debug("spawned a process: pid: %d", subprocess.pid)

when using subprocess.Popen, xvfb does start up correctly, but then I
have a python issue which is that xfb will start firefox-bin and make
it the parent and exit, thus, making it hard to kill the new process
of which I don't know the pid of.

in any case, I'd like to use spawnProcess, so any help as to why this
isn't working would be helpful.

Stephan

On Sat, Aug 20, 2011 at 10:52 AM, Stephan <schenette at gmail.com> wrote:
> Hi Glyph,
>
> I've created a specially crafted runnable example
> you can find it here: http://pastebin.com/dyhTFPjM
>
> as you'll see in the debug log that is created:
>
> 2011-08-20 10:36:10,484 DEBUG:errReceived xvfb-run: error: Xvfb failed to start
> 2011-08-20 10:36:10,486 DEBUG:inConnectionLost
> 2011-08-20 10:36:10,486 DEBUG:errConnectionLost
> 2011-08-20 10:36:10,487 DEBUG:process exited, status 1
>
> Any help is appreciated.
> to install xvfb on linux if not already installed
> sudo apt-get install xvfb
>
> On Fri, Aug 19, 2011 at 1:22 AM, Glyph Lefkowitz
> <glyph at twistedmatrix.com> wrote:
>> On Aug 19, 2011, at 1:14 AM, Stephan wrote:
>>
>> Thanks for the prompt reply response inline. I'm still having issues
>> even though I've changed some code based on your advice.
>>
>> Perhaps you could reduce this to a complete, runnable example so that
>> someone could reproduce the behavior you're seeing. ?At this point further
>> advice would be guessing on my part.
>> _______________________________________________
>> Twisted-web mailing list
>> Twisted-web at twistedmatrix.com
>> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>>
>>
>


From exarkun at twistedmatrix.com  Sat Aug 20 17:01:10 2011
From: exarkun at twistedmatrix.com (exarkun at twistedmatrix.com)
Date: Sat, 20 Aug 2011 21:01:10 -0000
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
Message-ID: <20110820210110.14538.1681657284.divmod.xquotient.5@localhost.localdomain>

On 19 Aug, 04:42 am, schenette at gmail.com wrote:
>I'm attempting to spawn xvfb with firefox using twisted's spawnProcess.
>
>I'm having two issues:
>
>1) when I call a normal process (not xvfb) it seems to
>work, but when I call xvfb the process goes defunct
>
>2) perhaps because it goes defunct but the timeout I set in place in
>the processprotocol does
>not trigger.
>
>==============
>here is the code for spawning a process
>==============
>108         command = ["/usr/bin/xvfb-run", "--auto-servernum",
>"/usr/bin/firefox", "-P", profile_id]
>109         subprocess = reactor.spawnProcess(TimedProcessProtocol(20),
>110                                             command[0], command)


Does it make any difference if you pass on the parent's environment to 
the xvfb-run process?  Try something like spawnProcess(..., 
env=os.environ)

Jean-Paul


From mailinglists at xgm.de  Sun Aug 21 06:10:04 2011
From: mailinglists at xgm.de (Florian Lindner)
Date: Sun, 21 Aug 2011 12:10:04 +0200
Subject: [Twisted-web] How to use templating with the web server
Message-ID: <1338380.9MTyI3m0Zd@horus>

Hello,

I want to build a simple webinterface for my application and decided to use 
twisted.web with its templating for that. This will be my first contact with 
twisted.

I had found a working example at [1].

Is there a way to render a template that involves less boiler plate code? In 
that example I had to create a template.Element class and a web.Ressource 
class for each page I want to render. The Ressource basically looks always the 
same for each page, just that it renders another Element class.

Is there a way to shortcut that a bit? My standard situation will be that I 
have a template file and an Element class containing the logic. These are 
"mounted" somewehre in the hierarchy (like with putChild).

Sorry, I'm sure I'm lacking quite a bit of insight into twisted.

Thanks!

Florian


[1]
http://groups.google.com/group/pythonmy/browse_thread/thread/bab31751d0e0f78f?pli=1



From schenette at gmail.com  Mon Aug 22 05:16:21 2011
From: schenette at gmail.com (Stephan)
Date: Mon, 22 Aug 2011 02:16:21 -0700
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <20110820210110.14538.1681657284.divmod.xquotient.5@localhost.localdomain>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
	<20110820210110.14538.1681657284.divmod.xquotient.5@localhost.localdomain>
Message-ID: <CADozHMVChXxmvO+_k9Hcuzh-LzhZhvfB5bcBEJ4XBLN4x_Ccxg@mail.gmail.com>

Jean-Paul,

adding

env=os.environ to spanProcess fixed the issue, thank you.

There is still one problem I brought up that I'm attempting to figure
out with twisted that is related to the initial question...

current status is that now with the addition of setting the env params
xvfb starts up correctly and starts up firefox.

the ProcessProtocol object that I created, has a calllater function
that kills the process after 20seconds.

the issue is that xvfb has one process id and any process it's asked
to create will cause another process to be spawned, thus another
process id, where the parent process is that of xvfb.

when I issue the kill command, xvfb does indeed die, but firefox-bin
stays around and it's parent is set to 1.

here is the ProcessProtocol code, should I be killing the parent
process differently so that the children die as well?

 33 class TimedProcessProtocol(protocol.ProcessProtocol):
 34
 35     def __init__(self, timeout):
 36         self.timeout = timeout
 37
 38     def connectionMade(self):
 39         logging.debug("connection made timeout = %d", self.timeout)
 40         @defer.inlineCallbacks
 41         def killIfAlive():
 42             logging.debug("timeout reached - killing process")
 43             try:
 44                 yield self.transport.signalProcess('TERM')
 45             except error.ProcessExitedAlready:
 46                 logging.debug("process already exited")
 47                 pass
 48
 49         d = reactor.callLater(self.timeout, killIfAlive)
 50
 51     def outReceived(self, data):
 52         logging.debug("output: %s", data)


Stephan

ps both TERM and KILL act the same way

On Sat, Aug 20, 2011 at 2:01 PM,  <exarkun at twistedmatrix.com> wrote:
> On 19 Aug, 04:42 am, schenette at gmail.com wrote:
>>I'm attempting to spawn xvfb with firefox using twisted's spawnProcess.
>>
>>I'm having two issues:
>>
>>1) when I call a normal process (not xvfb) it seems to
>>work, but when I call xvfb the process goes defunct
>>
>>2) perhaps because it goes defunct but the timeout I set in place in
>>the processprotocol does
>>not trigger.
>>
>>==============
>>here is the code for spawning a process
>>==============
>>108 ? ? ? ? command = ["/usr/bin/xvfb-run", "--auto-servernum",
>>"/usr/bin/firefox", "-P", profile_id]
>>109 ? ? ? ? subprocess = reactor.spawnProcess(TimedProcessProtocol(20),
>>110 ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? command[0], command)
>
>
> Does it make any difference if you pass on the parent's environment to
> the xvfb-run process? ?Try something like spawnProcess(...,
> env=os.environ)
>
> Jean-Paul
>
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>


From schenette at gmail.com  Mon Aug 22 12:32:55 2011
From: schenette at gmail.com (Stephan)
Date: Mon, 22 Aug 2011 09:32:55 -0700
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <CADozHMVChXxmvO+_k9Hcuzh-LzhZhvfB5bcBEJ4XBLN4x_Ccxg@mail.gmail.com>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
	<20110820210110.14538.1681657284.divmod.xquotient.5@localhost.localdomain>
	<CADozHMVChXxmvO+_k9Hcuzh-LzhZhvfB5bcBEJ4XBLN4x_Ccxg@mail.gmail.com>
Message-ID: <CADozHMX+Xt7N0qwjsv6iMVAeWVpEwT9gis_8YxtktdNefcQNZQ@mail.gmail.com>

I think I might have figured out that you have to add usePTY=1 to
associate the process group, so that the children will be killed when
the parent process is killed.
e.g.
subprocess = reactor.spawnProcess(self.pp, args[0], args, env = os.e
 nviron, usePTY=1)

but I tried to separate out the killing in another process and now the
new method isnt' called.
are ProcessProtocol classes allowed to have other methods added to it
for calling?

 45     def killProcessIfAlive(self):
 46         logging.debug("killProcessIfAlive called")
 47         try:
 48             yield self.transport.signalProcess('KILL')
 49         except error.ProcessExitedAlready:
 50             logging.debug("process already exited")
 51             pass
 52
 53     def connectionMade(self):
 54         logging.debug("connection made timeout = %d", self.timeout)
 55         @defer.inlineCallbacks
 56         def onTimer():
 57             logging.debug("timeout triggered")
 58             self.killProcessIfAlive()
 59         d = reactor.callLater(self.timeout, onTimer)

On Mon, Aug 22, 2011 at 2:16 AM, Stephan <schenette at gmail.com> wrote:
> Jean-Paul,
>
> adding
>
> env=os.environ to spanProcess fixed the issue, thank you.
>
> There is still one problem I brought up that I'm attempting to figure
> out with twisted that is related to the initial question...
>
> current status is that now with the addition of setting the env params
> xvfb starts up correctly and starts up firefox.
>
> the ProcessProtocol object that I created, has a calllater function
> that kills the process after 20seconds.
>
> the issue is that xvfb has one process id and any process it's asked
> to create will cause another process to be spawned, thus another
> process id, where the parent process is that of xvfb.
>
> when I issue the kill command, xvfb does indeed die, but firefox-bin
> stays around and it's parent is set to 1.
>
> here is the ProcessProtocol code, should I be killing the parent
> process differently so that the children die as well?
>
> ?33 class TimedProcessProtocol(protocol.ProcessProtocol):
> ?34
> ?35 ? ? def __init__(self, timeout):
> ?36 ? ? ? ? self.timeout = timeout
> ?37
> ?38 ? ? def connectionMade(self):
> ?39 ? ? ? ? logging.debug("connection made timeout = %d", self.timeout)
> ?40 ? ? ? ? @defer.inlineCallbacks
> ?41 ? ? ? ? def killIfAlive():
> ?42 ? ? ? ? ? ? logging.debug("timeout reached - killing process")
> ?43 ? ? ? ? ? ? try:
> ?44 ? ? ? ? ? ? ? ? yield self.transport.signalProcess('TERM')
> ?45 ? ? ? ? ? ? except error.ProcessExitedAlready:
> ?46 ? ? ? ? ? ? ? ? logging.debug("process already exited")
> ?47 ? ? ? ? ? ? ? ? pass
> ?48
> ?49 ? ? ? ? d = reactor.callLater(self.timeout, killIfAlive)
> ?50
> ?51 ? ? def outReceived(self, data):
> ?52 ? ? ? ? logging.debug("output: %s", data)
>
>
> Stephan
>
> ps both TERM and KILL act the same way
>
> On Sat, Aug 20, 2011 at 2:01 PM, ?<exarkun at twistedmatrix.com> wrote:
>> On 19 Aug, 04:42 am, schenette at gmail.com wrote:
>>>I'm attempting to spawn xvfb with firefox using twisted's spawnProcess.
>>>
>>>I'm having two issues:
>>>
>>>1) when I call a normal process (not xvfb) it seems to
>>>work, but when I call xvfb the process goes defunct
>>>
>>>2) perhaps because it goes defunct but the timeout I set in place in
>>>the processprotocol does
>>>not trigger.
>>>
>>>==============
>>>here is the code for spawning a process
>>>==============
>>>108 ? ? ? ? command = ["/usr/bin/xvfb-run", "--auto-servernum",
>>>"/usr/bin/firefox", "-P", profile_id]
>>>109 ? ? ? ? subprocess = reactor.spawnProcess(TimedProcessProtocol(20),
>>>110 ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? command[0], command)
>>
>>
>> Does it make any difference if you pass on the parent's environment to
>> the xvfb-run process? ?Try something like spawnProcess(...,
>> env=os.environ)
>>
>> Jean-Paul
>>
>> _______________________________________________
>> Twisted-web mailing list
>> Twisted-web at twistedmatrix.com
>> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>>
>


From glyph at twistedmatrix.com  Mon Aug 22 15:21:15 2011
From: glyph at twistedmatrix.com (Glyph Lefkowitz)
Date: Mon, 22 Aug 2011 15:21:15 -0400
Subject: [Twisted-web] How to use templating with the web server
In-Reply-To: <1338380.9MTyI3m0Zd@horus>
References: <1338380.9MTyI3m0Zd@horus>
Message-ID: <639370CE-AD60-4983-A34D-96B9B814418E@twistedmatrix.com>


On Aug 21, 2011, at 6:10 AM, Florian Lindner wrote:

> Hello,
> 
> I want to build a simple webinterface for my application and decided to use 
> twisted.web with its templating for that. This will be my first contact with 
> twisted.

In that case, welcome to Twisted!

> I had found a working example at [1].

That looks like an OK example.  I see that <http://twistedmatrix.com/users/glyph/sphinx-preview-11.0pre1/projects/web/howto/twisted-templates.html> explains this in the abstract, but it's a documentation bug that it doesn't help you tie it all together.  Please feel free to file that bug :).

> Is there a way to render a template that involves less boiler plate code? In 
> that example I had to create a template.Element class and a web.Ressource 
> class for each page I want to render. The Ressource basically looks always the 
> same for each page, just that it renders another Element class.

You can just make one Resource class that wraps an Element.  There's no need to have a different class for every one.

You might want to submit a patch to add such a class to Twisted, although I think requirements will differ between projects as far as what the features of such a class should be, so it might be best to wait on that until a few more projects can present examples of how they used it.

> Is there a way to shortcut that a bit? My standard situation will be that I 
> have a template file and an Element class containing the logic. These are 
> "mounted" somewehre in the hierarchy (like with putChild).

You can either use putChild or write resources with appropriate getChild methods; which is better depends on your application.  It might make sense to make a single Resource subclass that deals with rendering an element, and then subclass that in order to provide methods to retrieve children.

> Sorry, I'm sure I'm lacking quite a bit of insight into twisted.

It sounds like you've got the basics, actually - just remember that it's all Python code, and you can use whatever programming techniques make your life easier.  You don't need to find a magic solution to everything somewhere inside Twisted itself, just for it to work with Twisted :).

-glyph

From exarkun at twistedmatrix.com  Mon Aug 22 15:53:34 2011
From: exarkun at twistedmatrix.com (exarkun at twistedmatrix.com)
Date: Mon, 22 Aug 2011 19:53:34 -0000
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <CADozHMX+Xt7N0qwjsv6iMVAeWVpEwT9gis_8YxtktdNefcQNZQ@mail.gmail.com>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
	<20110820210110.14538.1681657284.divmod.xquotient.5@localhost.localdomain>
	<CADozHMVChXxmvO+_k9Hcuzh-LzhZhvfB5bcBEJ4XBLN4x_Ccxg@mail.gmail.com>
	<CADozHMX+Xt7N0qwjsv6iMVAeWVpEwT9gis_8YxtktdNefcQNZQ@mail.gmail.com>
Message-ID: <20110822195334.14538.592069362.divmod.xquotient.13@localhost.localdomain>

On 04:32 pm, schenette at gmail.com wrote:
>I think I might have figured out that you have to add usePTY=1 to
>associate the process group, so that the children will be killed when
>the parent process is killed.
>e.g.
>subprocess = reactor.spawnProcess(self.pp, args[0], args, env = os.e
>nviron, usePTY=1)

This is a not bad approach.  Another possibility might be to leave 
usePTY out but change how you kill the process.  There is the notion of 
"process groups", which contain one or more processes, and all of the 
processes in a group can be sent a signal by passing a negative number 
to os.kill.  For your case, the process group would probably be the same 
as the pid of the xvfb-run process, so you could do something like:

    os.kill(-process.transport.pid, SIGTERM)

Whether this is better or worse than using a PTY depends on the 
particulars of how xvfb-run manages its child process, whether it is 
okay to actually have a pty allocated, and probably some other POSIX 
arcana.
>but I tried to separate out the killing in another process and now the
>new method isnt' called.
>are ProcessProtocol classes allowed to have other methods added to it
>for calling?
>
>45     def killProcessIfAlive(self):
>46         logging.debug("killProcessIfAlive called")
>47         try:
>48             yield self.transport.signalProcess('KILL')
>49         except error.ProcessExitedAlready:
>50             logging.debug("process already exited")
>51             pass

It looks like you wanted killProcessIfAlive to be decorated with 
inlineCallbacks, but I don't see that here.  So that would prevent the 
signal from ever actually being sent.  signalProcess doesn't return a 
Deferred though, so you can skip inlineCallbacks and the yield and that 
should also fix the problem.
>52
>53     def connectionMade(self):
>54         logging.debug("connection made timeout = %d", self.timeout)
>55         @defer.inlineCallbacks
>56         def onTimer():
>57             logging.debug("timeout triggered")
>58             self.killProcessIfAlive()
>59         d = reactor.callLater(self.timeout, onTimer)

Ah, there's the inlineCallbacks.  It won't work there, though, it needs 
to go onto the generator function (the function that has yield in it).

Jean-Paul


From schenette at gmail.com  Mon Aug 22 16:45:52 2011
From: schenette at gmail.com (Stephan)
Date: Mon, 22 Aug 2011 13:45:52 -0700
Subject: [Twisted-web] spawning a xvfb and firefox with a timeout
In-Reply-To: <20110822195334.14538.592069362.divmod.xquotient.13@localhost.localdomain>
References: <CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG=6zxfV_k5pr1W71A@mail.gmail.com>
	<20110820210110.14538.1681657284.divmod.xquotient.5@localhost.localdomain>
	<CADozHMVChXxmvO+_k9Hcuzh-LzhZhvfB5bcBEJ4XBLN4x_Ccxg@mail.gmail.com>
	<CADozHMX+Xt7N0qwjsv6iMVAeWVpEwT9gis_8YxtktdNefcQNZQ@mail.gmail.com>
	<20110822195334.14538.592069362.divmod.xquotient.13@localhost.localdomain>
Message-ID: <CADozHMUCdw4V7pCvqRu70GyGa9CW2VEWZUc=+YaiNMYeCHOHBA@mail.gmail.com>

Hi Jean-Paul,

decorated with inlineCallbacks? why would I need that?

I'm trying to figure that out... but would it look like this?

        def killProcessIfAlive(self):
                logging.debug("killProcessIfAlive called")
                @defer.inlineCallbacks
                try:
                        yield self.transport.signalProcess('KILL')
                except error.ProcessExitedAlready:
                        logging.debug("process already exited")
                        pass

        def connectionMade(self):
                logging.debug("connection made timeout = %d", self.timeout)
                #@defer.inlineCallbacks
                def onTimer():
                        logging.debug("timeout triggered")
                        self.killProcessIfAlive()
                d = reactor.callLater(self.timeout, onTimer)


----
also I tried before you had sent out the email

os.kill(self.pid, SIGTERM)
and
os.kill(self.pid, SIGTERM)

but not

os.kill(-process.transport.pid, SIGTERM) (with the dash, does that
make a difference?)
On Mon, Aug 22, 2011 at 12:53 PM,  <exarkun at twistedmatrix.com> wrote:
> On 04:32 pm, schenette at gmail.com wrote:
>>I think I might have figured out that you have to add usePTY=1 to
>>associate the process group, so that the children will be killed when
>>the parent process is killed.
>>e.g.
>>subprocess = reactor.spawnProcess(self.pp, args[0], args, env = os.e
>>nviron, usePTY=1)
>
> This is a not bad approach. ?Another possibility might be to leave
> usePTY out but change how you kill the process. ?There is the notion of
> "process groups", which contain one or more processes, and all of the
> processes in a group can be sent a signal by passing a negative number
> to os.kill. ?For your case, the process group would probably be the same
> as the pid of the xvfb-run process, so you could do something like:
>
> ? ?os.kill(-process.transport.pid, SIGTERM)
>
> Whether this is better or worse than using a PTY depends on the
> particulars of how xvfb-run manages its child process, whether it is
> okay to actually have a pty allocated, and probably some other POSIX
> arcana.
>>but I tried to separate out the killing in another process and now the
>>new method isnt' called.
>>are ProcessProtocol classes allowed to have other methods added to it
>>for calling?
>>
>>45 ? ? def killProcessIfAlive(self):
>>46 ? ? ? ? logging.debug("killProcessIfAlive called")
>>47 ? ? ? ? try:
>>48 ? ? ? ? ? ? yield self.transport.signalProcess('KILL')
>>49 ? ? ? ? except error.ProcessExitedAlready:
>>50 ? ? ? ? ? ? logging.debug("process already exited")
>>51 ? ? ? ? ? ? pass
>
> It looks like you wanted killProcessIfAlive to be decorated with
> inlineCallbacks, but I don't see that here. ?So that would prevent the
> signal from ever actually being sent. ?signalProcess doesn't return a
> Deferred though, so you can skip inlineCallbacks and the yield and that
> should also fix the problem.
>>52
>>53 ? ? def connectionMade(self):
>>54 ? ? ? ? logging.debug("connection made timeout = %d", self.timeout)
>>55 ? ? ? ? @defer.inlineCallbacks
>>56 ? ? ? ? def onTimer():
>>57 ? ? ? ? ? ? logging.debug("timeout triggered")
>>58 ? ? ? ? ? ? self.killProcessIfAlive()
>>59 ? ? ? ? d = reactor.callLater(self.timeout, onTimer)
>
> Ah, there's the inlineCallbacks. ?It won't work there, though, it needs
> to go onto the generator function (the function that has yield in it).
>
> Jean-Paul
>
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>


From mailinglists at xgm.de  Tue Aug 23 08:34:09 2011
From: mailinglists at xgm.de (Florian Lindner)
Date: Tue, 23 Aug 2011 14:34:09 +0200
Subject: [Twisted-web] Rendering of list/table data with a template
Message-ID: <6475308.5poGRfLPQQ@horus>

Hello,

I'm still trying to figure out what is the correct way to render data in a 
template that comes from a list, e.g. to produce a table.

I have figured out a way, but I got no idea if that's the way to go:

    <table>
      <tr t:render="table_row"><td><t:slot name="table_content" /></td></tr>
    </table>

with that renderer:

    @renderer
    def table_row(self, request, tag):
        rows = ["A", "B", "C"]
        
        output_list = []
        for row in rows:
            t = tag.clone()
            t.fillSlots(table_content=row)
            output_list.append(t)
        return output_list

Is that how it should be done in twisted templating?

Thanks,

Florian


From glyph at twistedmatrix.com  Tue Aug 23 14:26:19 2011
From: glyph at twistedmatrix.com (Glyph Lefkowitz)
Date: Tue, 23 Aug 2011 14:26:19 -0400
Subject: [Twisted-web] Rendering of list/table data with a template
In-Reply-To: <6475308.5poGRfLPQQ@horus>
References: <6475308.5poGRfLPQQ@horus>
Message-ID: <E16062FB-882C-44BD-B9A5-774CE0CB38A2@twistedmatrix.com>


On Aug 23, 2011, at 8:34 AM, Florian Lindner wrote:

> Hello,
> 
> I'm still trying to figure out what is the correct way to render data in a 
> template that comes from a list, e.g. to produce a table.
> 
> I have figured out a way, but I got no idea if that's the way to go:
> 
>    <table>
>      <tr t:render="table_row"><td><t:slot name="table_content" /></td></tr>
>    </table>
> 
> with that renderer:
> 
>    @renderer
>    def table_row(self, request, tag):
>        rows = ["A", "B", "C"]
> 
>        output_list = []
>        for row in rows:
>            t = tag.clone()
>            t.fillSlots(table_content=row)
>            output_list.append(t)
>        return output_list
> 
> Is that how it should be done in twisted templating?

This is pretty close to the way I've been doing it, which is:

@renderer
def table_row(self, request, tag):
    rows = ['A', 'B', 'C']
    for row in rows:
        yield tag.clone().fillSlots(table_content=row)

The logic is basically the same, it is just a little bit shorter.  Sometimes I will also include a 'hasRows' and 'noRows' renderers in the outer template, like:

<table t:render="hasRows">
<tr t:render="table_row"><td><t:slot name="table_content" /></td></tr>
</table>

<div t:render="noRows">
No rows.
</div>

The renderers for these just look like this:

@renderer
def hasRows(self, request, tag):
    rows = ...
    if not rows:
        return ''
    return tag

Fans of nevow's 'pattern' feature will be quick to point out that this is one of the use-cases for patterns, and indeed, so far I have had to write some logic to cache 'rows' on 'self', and a few redundant renderers which would have been unnecessary if we had patterns.  But I actually find templates like this easier to read, and it saves me from having to use <t:transparent>s that hold the table and the div in the same renderer, which makes my browser ever so slightly happier to view the template un-rendered.  I think I'll probably add some utilities for doing these things automatically, once I have a little more experience with this new, simplified templating style :).

Hope this was a helpful insight into some real-world t.w.t usage :).

-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110823/31340489/attachment.htm 

From jacek99 at gmail.com  Thu Aug 25 14:55:01 2011
From: jacek99 at gmail.com (Jacek Furmankiewicz)
Date: Thu, 25 Aug 2011 14:55:01 -0400
Subject: [Twisted-web] CorePost - a tiny Flask-style REST microframework for
	twisted.web
Message-ID: <CAGDztiEagYkRD4rkaZFpDErgHtmi8oXP8-V8qTTocHLhs71fkQ@mail.gmail.com>

Hi,

I'd like to announce the very first alpha release of CorePost,
a tiny REST microframework on top of the core twisted.web APIs.

http://pypi.python.org/pypi/CorePost/0.0.1

it's design is heavily inspired by Flask, for easy creation of REST
services.

Looking forward to any comments and suggestions.
It's my first attempt at any serious Twisted programming, so be gentle with
your comments :-)

Cheers,
Jacek

P.S. I plan to look at integrating twisted.internet.processes
http://pypi.python.org/pypi/twisted.internet.processes

in the near future to enable scaling to all cores on a multi core machine.
using its deferToProcess()
functionality. Any suggestions from seasoned Twisted developers on whether
that is the correct approach
would be appreciated.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110825/0a0d737a/attachment.htm 

From glyph at twistedmatrix.com  Thu Aug 25 15:40:16 2011
From: glyph at twistedmatrix.com (Glyph Lefkowitz)
Date: Thu, 25 Aug 2011 15:40:16 -0400
Subject: [Twisted-web] CorePost - a tiny Flask-style REST microframework
	for twisted.web
In-Reply-To: <CAGDztiEagYkRD4rkaZFpDErgHtmi8oXP8-V8qTTocHLhs71fkQ@mail.gmail.com>
References: <CAGDztiEagYkRD4rkaZFpDErgHtmi8oXP8-V8qTTocHLhs71fkQ@mail.gmail.com>
Message-ID: <B6B284F0-91C7-4F3E-A593-910FD18EC8CF@twistedmatrix.com>


On Aug 25, 2011, at 2:55 PM, Jacek Furmankiewicz wrote:

> Hi,
> 
> I'd like to announce the very first alpha release of CorePost,
> a tiny REST microframework on top of the core twisted.web APIs.
> 
> http://pypi.python.org/pypi/CorePost/0.0.1
> 
> it's design is heavily inspired by Flask, for easy creation of REST services.
> 
> Looking forward to any comments and suggestions.
> It's my first attempt at any serious Twisted programming, so be gentle with your comments :-)

Cool!  I don't have any comments just yet, but I wanted to quickly say thanks for doing this :-).

The only similar project I've heard of is <https://github.com/lvh/txyoga> - any idea about comparing / contrasting?

Also, as I've been suggesting to a few other people recently, you may find it useful to register your project on Launchpad and add it to the 'tx' group so that it appears in the list we frequently refer new Twisted users to, <https://launchpad.net/tx>.

> Cheers,
> Jacek
> 
> P.S. I plan to look at integrating twisted.internet.processes
> http://pypi.python.org/pypi/twisted.internet.processes
> 
> in the near future to enable scaling to all cores on a multi core machine. using its deferToProcess()
> functionality. Any suggestions from seasoned Twisted developers on whether that is the correct approach
> would be appreciated.

I would suggest using something based on spawnProcess instead.  There are a number of issues with multiprocessing itself, and this package says right there on the PyPI page that it has no tests.  Not to mention that it calls multiprocessing in a thread.  If you're using synchronous / blocking I/O in Python, you have no choice but to do some of the awful stuff multiprocessing does, but Twisted's spawnProcess is much cleaner and integrates efficiently with asynchronous I/O, especially on Linux and MacOS.

<https://launchpad.net/ampoule> is one option you may want to consider.

(Not to mention the fact that it is confusingly named; it is not part of twisted.internet and in fact does not even use the process support in twisted.internet.)

-glyph


-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110825/8ca34c16/attachment.htm 

From jacek99 at gmail.com  Thu Aug 25 16:29:21 2011
From: jacek99 at gmail.com (Jacek Furmankiewicz)
Date: Thu, 25 Aug 2011 16:29:21 -0400
Subject: [Twisted-web] CorePost - a tiny Flask-style REST microframework
 for twisted.web
In-Reply-To: <B6B284F0-91C7-4F3E-A593-910FD18EC8CF@twistedmatrix.com>
References: <CAGDztiEagYkRD4rkaZFpDErgHtmi8oXP8-V8qTTocHLhs71fkQ@mail.gmail.com>
	<B6B284F0-91C7-4F3E-A593-910FD18EC8CF@twistedmatrix.com>
Message-ID: <CAGDztiHuMv6TwUGphGKrOcsvaviKUFYax-MTvsAAerGm9Zq1mw@mail.gmail.com>

- tzyoga - will look at it. I just really liked the minimal super easy API
of Flask (which in turn is probably inspired by Sinatra) and that's what I
wanted to bring to Twisted.
- spawnProcess - got it. Will look into that

thank you for your feedback

Jacek

On Thu, Aug 25, 2011 at 3:40 PM, Glyph Lefkowitz <glyph at twistedmatrix.com>wrote:

>
> On Aug 25, 2011, at 2:55 PM, Jacek Furmankiewicz wrote:
>
> Hi,
>
> I'd like to announce the very first alpha release of CorePost,
> a tiny REST microframework on top of the core twisted.web APIs.
>
> http://pypi.python.org/pypi/CorePost/0.0.1
>
> it's design is heavily inspired by Flask, for easy creation of REST
> services.
>
> Looking forward to any comments and suggestions.
> It's my first attempt at any serious Twisted programming, so be gentle with
> your comments :-)
>
>
> Cool!  I don't have any comments just yet, but I wanted to quickly say
> thanks for doing this :-).
>
> The only similar project I've heard of is <https://github.com/lvh/txyoga>
> - any idea about comparing / contrasting?
>
> Also, as I've been suggesting to a few other people recently, you may find
> it useful to register your project on Launchpad and add it to the 'tx' group
> so that it appears in the list we frequently refer new Twisted users to, <
> https://launchpad.net/tx>.
>
> Cheers,
> Jacek
>
> P.S. I plan to look at integrating twisted.internet.processes
> http://pypi.python.org/pypi/twisted.internet.processes
>
>
> in the near future to enable scaling to all cores on a multi core machine.
> using its deferToProcess()
> functionality. Any suggestions from seasoned Twisted developers on whether
> that is the correct approach
> would be appreciated.
>
>
> I would suggest using something based on spawnProcess instead.  There are a
> number of issues with multiprocessing itself, and this package says right
> there on the PyPI page that it has no tests.  Not to mention that it calls
> multiprocessing in a thread.  If you're using synchronous / blocking I/O in
> Python, you have no choice but to do some of the awful stuff multiprocessing
> does, but Twisted's spawnProcess is much cleaner and integrates efficiently
> with asynchronous I/O, especially on Linux and MacOS.
>
> <https://launchpad.net/ampoule> is one option you may want to consider.
>
> (Not to mention the fact that it is confusingly named; it is not part of
> twisted.internet and in fact does not even use the process support in
> twisted.internet.)
>
> -glyph
>
>
>
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110825/50dc956a/attachment.htm 

From schenette at gmail.com  Mon Aug 29 02:50:18 2011
From: schenette at gmail.com (Stephan)
Date: Sun, 28 Aug 2011 23:50:18 -0700
Subject: [Twisted-web] default file creation when using reactor.spawnProcess
Message-ID: <CADozHMUMRGbdUN1hZuO5kJzDhXrJ95fB6F3i=NCvnUReMj_xNg@mail.gmail.com>

I'm attempting to move over PERL code to python code using the twisted
framework.
so far a few hiccups but this mailing list has helped me quite figure it out.

I have a few few more hurdles, one being that since moving from Perl's

my $cmd = "xvfb-run --auto-servernum firefox -P $profile_id";
$pid = open2($infh, $outfh, $cmd);

to twisted's reactor.spawnProcess:

 subprocess = reactor.spawnProcess(self.pp, args[0], args, env =
os.environ, usePTY=1, childFDs=None)

when the xvfb/firefox processes create files they do so with root
read/write, owner no permissions and group
no permissions,

using the the perl implementation the twisted daemon is run as a
particular user and the file creation via firefox is rw rw rw which is
what  my goal is.

What code would help those on the list willing to help? the daemon
script code in init.d?

Thanks in advance, so far this list has been golden!
Stephan


From steven.samuel.cole at gmail.com  Mon Aug 29 05:09:41 2011
From: steven.samuel.cole at gmail.com (Steven Samuel Cole)
Date: Mon, 29 Aug 2011 19:09:41 +1000
Subject: [Twisted-web] http authentication for xmlrpc: basic works,
	digest unauthorized
Message-ID: <CANZxLCU8rX6spphjcWmowfc6x2ZPBtF5WnSV5ueXZDddcBzufw@mail.gmail.com>

hello,

i would like to create an xmlrpc interface to my data server. i've
been trying to get my head around twisted for that purpose for about a
week now and i think i've made ok progress:

anonymous xmlrpc (i.e. without user authentication) works over tcp and
ssl and in order to understand http authentication in twisted, i've
set up web server (also over tcp and ssl) which does log in users by
means of basic and digest http authentication.

concerning xmlrpc and users, _basic_ http authentication does work,
but when i try to use _digest_ authentication, i keep getting 401
unauthorized.

the test client i am using is pretty much the same as the sample code
from http://twistedmatrix.com/documents/current/web/examples/xmlrpcclient.py
i am working on mac osx with the twisted 8.2 as installed by default.

i do assume that changing basic to digest in the server does not
require any changes in the client. is that assumption correct ?

is it a known problem that basic auth works but digest does not ? does
anyone have authenticated xmlrpc access running ? what would be the
most straight forward way to find the reason why auth fails ?

thank you very much,

ssc


From schenette at gmail.com  Mon Aug 29 11:20:26 2011
From: schenette at gmail.com (Stephan)
Date: Mon, 29 Aug 2011 08:20:26 -0700
Subject: [Twisted-web] default file creation when using
	reactor.spawnProcess
In-Reply-To: <CADozHMUMRGbdUN1hZuO5kJzDhXrJ95fB6F3i=NCvnUReMj_xNg@mail.gmail.com>
References: <CADozHMUMRGbdUN1hZuO5kJzDhXrJ95fB6F3i=NCvnUReMj_xNg@mail.gmail.com>
Message-ID: <CADozHMXz-aBknEuKLRhgFG_UuuEXdu_f8Lpj2N29=mfZRoSnHA@mail.gmail.com>

I still have the issue, but I've found out that it has something to do
with the fact that the twisted daemon isn't starting as the user I've
asked it to start as.

I know this because I dumped os.environ

145         for k,v in os.environ.items():
146             logging.debug("%s : %s", k, v)
147
148         subprocess = reactor.spawnProcess(self.pp, args[0], args,
env = os.environ, usePTY=1)


and this is what I see:

2011-08-29 08:07:58,263 DEBUG:USERNAME : root
2011-08-29 08:07:58,263 DEBUG:LANG : en_US.UTF-8
2011-08-29 08:07:58,263 DEBUG:SUDO_GID : 1000
2011-08-29 08:07:58,263 DEBUG:SHELL : /bin/bash
2011-08-29 08:07:58,263 DEBUG:SUDO_COMMAND : /etc/init.d/fireshark start
2011-08-29 08:07:58,263 DEBUG:PYTHONPATH :
2011-08-29 08:07:58,263 DEBUG:SUDO_UID : 1000
2011-08-29 08:07:58,263 DEBUG:TERM : xterm
2011-08-29 08:07:58,263 DEBUG:PATH :
/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
2011-08-29 08:07:58,263 DEBUG:PWD : /usr/sbin
2011-08-29 08:07:58,263 DEBUG:LOGNAME : root
2011-08-29 08:07:58,264 DEBUG:USER : root
2011-08-29 08:07:58,264 DEBUG:HOME : /home/fireshark
2011-08-29 08:07:58,264 DEBUG:MAIL : /var/mail/stephan
2011-08-29 08:07:58,264 DEBUG:SUDO_USER : stephan

The daemon should be running as user fireshark, as that's what I have
it start as in the /etc/init.d/fireshark script (shown below) does
twisted follow a different convention for me to start the daemon as a
different user?

code from /etc/init.d/fireshark:

 14 PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
 15 DAEMON=/usr/bin/twistd
 16 RUNAS=fireshark
 17 SERVICE_NAME=fireshark
 18 SERVICE_PATH=/usr/sbin/fireshark.py
 19 PIDFILE=/home/fireshark/fireshark.pid
 20 LOGFILE=/home/fireshark/fireshark.log
 21 DAEMON_OPTS="--pidfile=${PIDFILE} --logfile=${LOGFILE} --python
${SERVICE_PA    TH}"
 22
 23 # Set python path so twistd can find the plugin
 24 # See: http://twistedmatrix.com/projects/core/documentation/howto/plugin.htm
   l
 25 export PYTHONPATH=$SERVICE_DIR
 26
 27 if [ ! -x $DAEMON ]; then
 28   echo "ERROR: Can't execute $DAEMON."
 29   exit 1
 30 fi
 31
 32 if [ ! -x $SERVICE_PATH ]; then
 33   echo "ERROR: Can't execute: $SERVICE_PATH"
 34   exit 1
 35 fi
 36
 37 start_service() {
 38   echo -n " * Starting $SERVICE_NAME... "
 39   start-stop-daemon -Sq --chuid ${RUNAS} --group ${RUNAS} -p
$PIDFILE -x $DA    EMON -- $DAEMON_OPTS
 40   e=$?
 41   if [ $e -eq 1 ]; then
 42     echo "already running"
 43     return





On Sun, Aug 28, 2011 at 11:50 PM, Stephan <schenette at gmail.com> wrote:
> I'm attempting to move over PERL code to python code using the twisted
> framework.
> so far a few hiccups but this mailing list has helped me quite figure it out.
>
> I have a few few more hurdles, one being that since moving from Perl's
>
> my $cmd = "xvfb-run --auto-servernum firefox -P $profile_id";
> $pid = open2($infh, $outfh, $cmd);
>
> to twisted's reactor.spawnProcess:
>
> ?subprocess = reactor.spawnProcess(self.pp, args[0], args, env =
> os.environ, usePTY=1, childFDs=None)
>
> when the xvfb/firefox processes create files they do so with root
> read/write, owner no permissions and group
> no permissions,
>
> using the the perl implementation the twisted daemon is run as a
> particular user and the file creation via firefox is rw rw rw which is
> what ?my goal is.
>
> What code would help those on the list willing to help? the daemon
> script code in init.d?
>
> Thanks in advance, so far this list has been golden!
> Stephan
>


From glyph at twistedmatrix.com  Mon Aug 29 12:45:12 2011
From: glyph at twistedmatrix.com (Glyph Lefkowitz)
Date: Mon, 29 Aug 2011 09:45:12 -0700
Subject: [Twisted-web] default file creation when using
	reactor.spawnProcess
In-Reply-To: <CADozHMXz-aBknEuKLRhgFG_UuuEXdu_f8Lpj2N29=mfZRoSnHA@mail.gmail.com>
References: <CADozHMUMRGbdUN1hZuO5kJzDhXrJ95fB6F3i=NCvnUReMj_xNg@mail.gmail.com>
	<CADozHMXz-aBknEuKLRhgFG_UuuEXdu_f8Lpj2N29=mfZRoSnHA@mail.gmail.com>
Message-ID: <7E181D75-735E-40E8-BF47-159BA38366F6@twistedmatrix.com>


On Aug 29, 2011, at 8:20 AM, Stephan wrote:

> I still have the issue, but I've found out that it has something to do
> with the fact that the twisted daemon isn't starting as the user I've
> asked it to start as.

The --chuid flag to start-stop-daemon is not seen by twistd; twistd is started by start-stop-daemon allegedly already running as that user.  If this is a bug, it's a bug in your platform's startup-management tools, not Twisted itself.

Note that os.environ['USER'] is informational only and does not represent the actual current user.  Look at os.getuid() for the real number.

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110829/7aa521c7/attachment.htm 

From schenette at gmail.com  Mon Aug 29 12:50:24 2011
From: schenette at gmail.com (Stephan)
Date: Mon, 29 Aug 2011 09:50:24 -0700
Subject: [Twisted-web] default file creation when using
	reactor.spawnProcess
In-Reply-To: <7E181D75-735E-40E8-BF47-159BA38366F6@twistedmatrix.com>
References: <CADozHMUMRGbdUN1hZuO5kJzDhXrJ95fB6F3i=NCvnUReMj_xNg@mail.gmail.com>
	<CADozHMXz-aBknEuKLRhgFG_UuuEXdu_f8Lpj2N29=mfZRoSnHA@mail.gmail.com>
	<7E181D75-735E-40E8-BF47-159BA38366F6@twistedmatrix.com>
Message-ID: <CADozHMVshZboAZB2YmBgksuSbEJU64cUrdMnjb0dSm=NFC_rNg@mail.gmail.com>

HI Glypyh,

I'm using Ubuntu currently,

what I'm trying to accomplish is changing the default file creation
for the daemon, which from what I'm reading was changed some time ago.

http://twistedmatrix.com/trac/ticket/966

what I'd like is for the twistd daemon to create files with a certain
default file creation permission, so I'm looking at changing the
umask,
but so far I can't get the format correctly, as I'm trying to use what
I'd normally use for chmod

when starting twistd what is the correct format for umask? is what I
have correct?
desired result is rw for owner, group and world.

 21 DAEMON_OPTS="--umask=0666 --pidfile=${PIDFILE}
--logfile=${LOGFILE} --python     ${SERVICE_PATH}"
 22
 23 # Set python path so twistd can find the plugin
 24 # See: http://twistedmatrix.com/projects/core/documentation/howto/plugin.htm
   l
 25 export PYTHONPATH=$SERVICE_DIR
 26
 27 if [ ! -x $DAEMON ]; then
 28   echo "ERROR: Can't execute $DAEMON."
 29   exit 1
 30 fi
 31
 32 if [ ! -x $SERVICE_PATH ]; then
 33   echo "ERROR: Can't execute: $SERVICE_PATH"
 34   exit 1
 35 fi
 36
 37 start_service() {
 38   echo -n " * Starting $SERVICE_NAME... "
 39   start-stop-daemon -Sq --chuid ${RUNAS} --group ${RUNAS} -p
$PIDFILE -x $DA    EMON -- $DAEMON_OPTS


On Mon, Aug 29, 2011 at 9:45 AM, Glyph Lefkowitz
<glyph at twistedmatrix.com> wrote:
>
> On Aug 29, 2011, at 8:20 AM, Stephan wrote:
>
> I still have the issue, but I've found out that it has something to do
> with the fact that the twisted daemon isn't starting as the user I've
> asked it to start as.
>
> The --chuid flag to start-stop-daemon is not seen by twistd; twistd is
> started by start-stop-daemon allegedly already running as that user. ?If
> this is a bug, it's a bug in your platform's startup-management tools, not
> Twisted itself.
> Note that os.environ['USER'] is informational only and does not represent
> the actual current user. ?Look at os.getuid() for the real number.
>
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>
>


From glyph at twistedmatrix.com  Mon Aug 29 13:03:29 2011
From: glyph at twistedmatrix.com (Glyph Lefkowitz)
Date: Mon, 29 Aug 2011 10:03:29 -0700
Subject: [Twisted-web] default file creation when using
	reactor.spawnProcess
In-Reply-To: <CADozHMVshZboAZB2YmBgksuSbEJU64cUrdMnjb0dSm=NFC_rNg@mail.gmail.com>
References: <CADozHMUMRGbdUN1hZuO5kJzDhXrJ95fB6F3i=NCvnUReMj_xNg@mail.gmail.com>
	<CADozHMXz-aBknEuKLRhgFG_UuuEXdu_f8Lpj2N29=mfZRoSnHA@mail.gmail.com>
	<7E181D75-735E-40E8-BF47-159BA38366F6@twistedmatrix.com>
	<CADozHMVshZboAZB2YmBgksuSbEJU64cUrdMnjb0dSm=NFC_rNg@mail.gmail.com>
Message-ID: <03C4D1CE-5010-46E1-9450-4CC53DC0C061@twistedmatrix.com>


On Aug 29, 2011, at 9:50 AM, Stephan wrote:

> what I'd like is for the twistd daemon to create files with a certain
> default file creation permission, so I'm looking at changing the
> umask,
> but so far I can't get the format correctly, as I'm trying to use what
> I'd normally use for chmod
> 
> when starting twistd what is the correct format for umask? is what I
> have correct?
> desired result is rw for owner, group and world.

Not just in twistd, the terms "umask" and "chmod" are basically inverses.  chmod sets the permissions of a file to a particular set of bits, but umask _masks out_ those bits on newly created files.

The mask you want is "execute for everybody" (0b001001001) but you're currently specifying "everything but execute for everybody" (0b110110110).  The Python interpreter can help you coerce this to octal, for use as a --umask command line option:

>>> oct(0b001001001)
'0111'

Hope this helps,

-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20110829/ab2caec2/attachment.htm 

From schenette at gmail.com  Mon Aug 29 13:15:21 2011
From: schenette at gmail.com (Stephan)
Date: Mon, 29 Aug 2011 10:15:21 -0700
Subject: [Twisted-web] default file creation when using
	reactor.spawnProcess
In-Reply-To: <03C4D1CE-5010-46E1-9450-4CC53DC0C061@twistedmatrix.com>
References: <CADozHMUMRGbdUN1hZuO5kJzDhXrJ95fB6F3i=NCvnUReMj_xNg@mail.gmail.com>
	<CADozHMXz-aBknEuKLRhgFG_UuuEXdu_f8Lpj2N29=mfZRoSnHA@mail.gmail.com>
	<7E181D75-735E-40E8-BF47-159BA38366F6@twistedmatrix.com>
	<CADozHMVshZboAZB2YmBgksuSbEJU64cUrdMnjb0dSm=NFC_rNg@mail.gmail.com>
	<03C4D1CE-5010-46E1-9450-4CC53DC0C061@twistedmatrix.com>
Message-ID: <CADozHMWgz+ZXxT3URDpsx+M=se3ob8ZomJ+MpK8X9ZKgGzqjOg@mail.gmail.com>

Thanks Glyph,

I've been coding all night, I should have known umask from chmod
but in order to accomplish the correct chmod I believe this is what I need:

unmask=000 	
results in chmod = 666 (rw-rw-rw-)

right? I realize this is now off topic, but just wanted to make sure
it was correct.
explicitly setting the umask I believe will fix the issue, testing now...

Stephan

On Mon, Aug 29, 2011 at 10:03 AM, Glyph Lefkowitz
<glyph at twistedmatrix.com> wrote:
>
> On Aug 29, 2011, at 9:50 AM, Stephan wrote:
>
> what I'd like is for the twistd daemon to create files with a certain
> default file creation permission, so I'm looking at changing the
> umask,
> but so far I can't get the format correctly, as I'm trying to use what
> I'd normally use for chmod
>
> when starting twistd what is the correct format for umask? is what I
> have correct?
> desired result is rw for owner, group and world.
>
> Not just in twistd, the terms "umask" and "chmod" are basically inverses.
> ?chmod sets the permissions of a file to a particular set of bits, but umask
> _masks out_ those bits on newly created files.
> The mask you want is "execute for everybody" (0b001001001) but you're
> currently specifying "everything but execute for everybody" (0b110110110).
> ?The Python interpreter can help you coerce this to octal, for use as a
> --umask command line option:
>>>> oct(0b001001001)
> '0111'
> Hope this helps,
> -glyph
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>
>


From schenette at gmail.com  Wed Aug 31 21:52:55 2011
From: schenette at gmail.com (Stephan)
Date: Wed, 31 Aug 2011 18:52:55 -0700
Subject: [Twisted-web] stopping LoopCall and check if running
Message-ID: <CADozHMU59U9BTot3ijD0Ks1N2PM02T-UYb8NuLSyQpH7kzpAKw@mail.gmail.com>

I have a question on LoopCall.

I have a process that uses a sequence of LoopCalls, once one finishes
I call the next to check for the next critical event to continue:

e.g.

    def checkForAvailableProfile(self):
        profile = fs_profiles_manager.get_next_available_profile()
        if profile is None:
            return
        else:
            self.checkForAvailableProfileLoop.stop()

        self.profile = profile

        logging.debug("using profile: %s", self.profile['name'])

        self.ff = FirefoxProcess(self.profile, self.params)
        self.ff.run()

        self.checkForEventsFileLoop = LoopingCall(self.checkIfEventsFileExists)
        self.checkForEventsFileLoop.start(0.5)
        self.state = self.STATE_WAIT_FOR_EVENTS

====================================================

The problem is that I'm getting errors, errors when I try to call stop
when stop perhaps has already been called.
I want advice on how to manage LoopCalls. So far I'm using state variables.
e.g.
self.state = self.STATE_WAIT_FOR_EVENTS

if something goes haywire or if the process is done I have a function
that cleans up all the LoopCalls so it's not checking constantly:

    def cleanExit(self):
        if self.state == self.STATE_WAIT_FOR_PROFILE:
            self.checkForAvailableProfileLoop.stop()
        elif self.state == self.STATE_WAIT_FOR_EVENTS:
            self.checkForEventsFileLoop.stop()
        elif self.state == self.STATE_WAIT_FOR_PROC_KILLED:
            self.checkIfFirefoxWasKilledLoop.stop()

        self.ff.cleanExit()


the above code is what I believe is causing my exceptions, but how
else do I check for the LoopCalls?



=====================================================

2011-08-31 12:30:11-0700 [FiresharkProtocol,1278,127.0.0.1] Unhandled Error
    Traceback (most recent call last):
      File "/usr/lib/python2.6/dist-packages/twisted/application/app.py",
line 348, in runReactorWithLogging
        reactor.run()
      File "/usr/lib/python2.6/dist-packages/twisted/internet/base.py",
line 1170, in run
        self.mainLoop()
      File "/usr/lib/python2.6/dist-packages/twisted/internet/base.py",
line 1182, in mainLoop
        self.doIteration(t)
      File "/usr/lib/python2.6/dist-packages/twisted/internet/selectreactor.py",
line 140, in doSelect
        _logrun(selectable, _drdw, selectable, method, dict)
    --- <exception caught here> ---
      File "/usr/lib/python2.6/dist-packages/twisted/python/log.py",
line 84, in callWithLogger
        return callWithContext({"system": lp}, func, *args, **kw)
      File "/usr/lib/python2.6/dist-packages/twisted/python/log.py",
line 69, in callWithContext
        return context.call({ILogContext: newCtx}, func, *args, **kw)
      File "/usr/lib/python2.6/dist-packages/twisted/python/context.py",
line 59, in callWithContext
        return self.currentContext().callWithContext(ctx, func, *args, **kw)
      File "/usr/lib/python2.6/dist-packages/twisted/python/context.py",
line 37, in callWithContext
        return func(*args,**kw)
      File "/usr/lib/python2.6/dist-packages/twisted/internet/selectreactor.py",
line 156, in _doReadOrWrite
        self._disconnectSelectable(selectable, why, method=="doRead")
      File "/usr/lib/python2.6/dist-packages/twisted/internet/posixbase.py",
line 194, in _disconnectSelectable
        selectable.connectionLost(f)
      File "/usr/lib/python2.6/dist-packages/twisted/internet/tcp.py",
line 519, in connectionLost
        protocol.connectionLost(reason)
      File "/usr/sbin/fireshark.py", line 101, in connectionLost
        self.cleanExit()
      File "/usr/sbin/fireshark.py", line 43, in cleanExit
        self.checkIfFirefoxWasKilledLoop.stop()
      File "/usr/lib/python2.6/dist-packages/twisted/internet/task.py",
line 171, in stop
        assert self.running, ("Tried to stop a LoopingCall that was "
    exceptions.AssertionError: Tried to stop a LoopingCall that was not running.

2011-08-31 12:30:22-0700 [-] Unhandled error in Deferred:
2011-08-31 12:30:22-0700 [-] Unhandled Error
    Traceback (most recent call last):
      File "/usr/lib/python2.6/dist-packages/twisted/internet/base.py",
line 1170, in run
        self.mainLoop()
      File "/usr/lib/python2.6/dist-packages/twisted/internet/base.py",
line 1179, in mainLoop
        self.runUntilCurrent()
      File "/usr/lib/python2.6/dist-packages/twisted/internet/base.py",
line 778, in runUntilCurrent
        call.func(*call.args, **call.kw)
      File "/usr/lib/python2.6/dist-packages/twisted/internet/defer.py",
line 944, in unwindGenerator
        return _inlineCallbacks(None, f(*args, **kwargs), Deferred())
    --- <exception caught here> ---
      File "/usr/lib/python2.6/dist-packages/twisted/internet/defer.py",
line 823, in _inlineCallbacks
3, in _inlineCallbacks
        result = g.send(result)
    exceptions.AttributeError: 'NoneType' object has no attribute 'send'

2011-08-31 12:30:28-0700 [-] Unhandled error in Deferred:
2011-08-31 12:30:28-0700 [-] Unhandled Error
    Traceback (most recent call last):
      File "/usr/lib/python2.6/dist-packages/twisted/internet/base.py",
line 1170, in run
        self.mainLoop()
      File "/usr/lib/python2.6/dist-packages/twisted/internet/base.py",
line 1179, in mainLoop
        self.runUntilCurrent()
      File "/usr/lib/python2.6/dist-packages/twisted/internet/base.py",
line 778, in runUntilCurrent
        call.func(*call.args, **call.kw)
      File "/usr/lib/python2.6/dist-packages/twisted/internet/defer.py",
line 944, in unwindGenerator
        return _inlineCallbacks(None, f(*args, **kwargs), Deferred())
    --- <exception caught here> ---
      File "/usr/lib/python2.6/dist-packages/twisted/internet/defer.py",
line 823, in _inlineCallbacks
        result = g.send(result)
    exceptions.AttributeError: 'NoneType' object has no attribute 'send'


From terry at jon.es  Wed Aug 31 22:32:20 2011
From: terry at jon.es (Terry Jones)
Date: Thu, 1 Sep 2011 03:32:20 +0100
Subject: [Twisted-web] stopping LoopCall and check if running
In-Reply-To: Your message at 18:52:55 on Wednesday, 31 August 2011
References: <CADozHMU59U9BTot3ijD0Ks1N2PM02T-UYb8NuLSyQpH7kzpAKw@mail.gmail.com>
Message-ID: <20062.61108.709229.527852@jon.es>

Hi Stephan

I wont try to answer your question, but this error:

>        result = g.send(result)
>   exceptions.AttributeError: 'NoneType' object has no attribute 'send'

is what you see when you decorate a function with @inlineCallbacks but
don't have any yields in the function (i.e., it doesn't return a generator
object). You should definitely find & fix that problem.

Terry


