<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] memory leak with metaclass
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20memory%20leak%20with%20metaclass&In-Reply-To=aa51a4617213ddf0d567524ebb42b79b%4081.208.60.192">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001577.html">
   <LINK REL="Next"  HREF="001585.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] memory leak with metaclass</H1>
    <B>tazzo</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20memory%20leak%20with%20metaclass&In-Reply-To=aa51a4617213ddf0d567524ebb42b79b%4081.208.60.192"
       TITLE="[Twisted-web] memory leak with metaclass">tazzo at email.it
       </A><BR>
    <I>Mon Jun 27 01:56:35 MDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001577.html">[Twisted-web] memory leak with metaclass
</A></li>
        <LI>Next message: <A HREF="001585.html">[Twisted-web] memory leak with metaclass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1579">[ date ]</a>
              <a href="thread.html#1579">[ thread ]</a>
              <a href="subject.html#1579">[ subject ]</a>
              <a href="author.html#1579">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Also without metaclass there is a memory leak, returning
instances of rend.Page from locateChild they are never released.
Here a simple example, the function 'do' build on file log
a simple statistic every 5 sec about only instances classes  that are
growing up during page serving.
Try to start the server and ask some page continuosly, you'll see
the number of rendPage grow up with some other classes.

#-------------------------
import nevow
 
instances={}
count=0
def do():
  global count
  import gc
  gc.collect()
  objects=gc.get_objects()
  new={}
  for object in objects:
    try:
      new[str(object.__class__)]=new.setdefault(str(object.__class__),0)+1
    except:
      pass
  show=set()
  for key,value in new.items():
    if key in instances:
      if instances[key][-1]!=value:
        show.add(key)
    else:
      instances[key]=[0]*count
      show.add(key)
    instances[key].append(new[key])
  log=open('log','w')
  for klass,lista in sorted(instances.items()):
    if klass in show:
      print &gt;&gt;log,klass
      print &gt;&gt;log,'\t',lista
  log.close()
  count+=1

import twisted
from twisted.internet.task import LoopingCall
from nevow import appserver


LoopingCall(do).start(5)
 
 
class Controller(nevow.rend.Page):
  def locateChild(self,context,segments):
    page=nevow.rend.Page()
    page.docFactory=nevow.loaders.stan(nevow.tags.h1['I leak memory'])
    return page,[]
 
 
application=twisted.application.service.Application('leaker')
webservice = 
twisted.application.internet.TCPServer(12345,appserver.NevowSite(Controller()))
webservice.setServiceParent(application)
#-------------------------

-- 
La presente comunicazione potrebbe contenere informazioni riservate e/o
protette
da segreto professionale ed e' indirizzata esclusivamente ai destinatari della
medesima qui indicati. Se avete ricevuto per errore la presente comunicazione,
siete invitati a segnalarcelo, rispondendo a questo stesso indirizzo di
e-mail,
e a cancellare il presente messaggio dal Vostro sistema. E' strettamente
proibito
e potrebbe essere fonte di violazione di legge qualsiasi uso, comunicazione,
copia
o diffusione dei contenuti di questa comunicazione da parte di chi la abbia
ricevuta per errore o in violazione degli scopi della presente.
Il messaggio e' stato analizzato alla ricerca di virus o contenuti pericolosi
ed
e' risultato NON infetto.



</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001577.html">[Twisted-web] memory leak with metaclass
</A></li>
	<LI>Next message: <A HREF="001585.html">[Twisted-web] memory leak with metaclass
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1579">[ date ]</a>
              <a href="thread.html#1579">[ thread ]</a>
              <a href="subject.html#1579">[ subject ]</a>
              <a href="author.html#1579">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
