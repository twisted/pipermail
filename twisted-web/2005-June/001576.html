<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Re: Twisted-web Digest, Vol 15, Issue 20
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20Twisted-web%20Digest%2C%20Vol%2015%2C%20Issue%2020&In-Reply-To=E1DlVzi-0002cU-02%40pyramid.twistedmatrix.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001574.html">
   <LINK REL="Next"  HREF="001588.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Re: Twisted-web Digest, Vol 15, Issue 20</H1>
    <B>Richard Meraz</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20Twisted-web%20Digest%2C%20Vol%2015%2C%20Issue%2020&In-Reply-To=E1DlVzi-0002cU-02%40pyramid.twistedmatrix.com"
       TITLE="[Twisted-web] Re: Twisted-web Digest, Vol 15, Issue 20">rfmeraz at gmail.com
       </A><BR>
    <I>Thu Jun 23 12:35:15 MDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001574.html">[Twisted-web] Uploading files
</A></li>
        <LI>Next message: <A HREF="001588.html">[Twisted-web] Re: Twisted-web Digest, Vol 15, Issue 20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1576">[ date ]</a>
              <a href="thread.html#1576">[ thread ]</a>
              <a href="subject.html#1576">[ subject ]</a>
              <a href="author.html#1576">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Dave: very clear and easy to follow answer and example code.  I
definitely appreciate your time.

Final question.  Is there a convenient way to put an upper-bound on
how long twisted.web.client.getPage is allowed to complete its work. I
know twisted.web.client.getPage takes a timeout parameter, but this
seems more like a socket timeout which won't kill for example a
getPage waiting on a low-bandwidth server (is my understanding
correct?)

 For example, if I'm using the asyncore.py framework to mange IO i can
use the channel.timestamp attribute to examine how long things have
been going in order to kill long-running IO in a polling loop.  Of
course with asyncore I can manage my own polling loop which I can't
see an easy way to do using reactor() (someone care to comment on that
since I'm probably missing something).

-Thanks again

-Richard Meraz


On 6/23/05, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">twisted-web-request at twistedmatrix.com</A>
&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">twisted-web-request at twistedmatrix.com</A>&gt; wrote:
&gt;<i> Send Twisted-web mailing list submissions to
</I>&gt;<i>         <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">twisted-web at twistedmatrix.com</A>
</I>&gt;<i> 
</I>&gt;<i> To subscribe or unsubscribe via the World Wide Web, visit
</I>&gt;<i>         <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i> or, via email, send a message with subject or body 'help' to
</I>&gt;<i>         <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">twisted-web-request at twistedmatrix.com</A>
</I>&gt;<i> 
</I>&gt;<i> You can reach the person managing the list at
</I>&gt;<i>         <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">twisted-web-owner at twistedmatrix.com</A>
</I>&gt;<i> 
</I>&gt;<i> When replying, please edit your Subject line so it is more specific
</I>&gt;<i> than &quot;Re: Contents of Twisted-web digest...&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Today's Topics:
</I>&gt;<i> 
</I>&gt;<i>    1. Re: Defers, the reactor,  and idiomatic/proper usage      -- new
</I>&gt;<i>       user needs some advice? (Dave Gray)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> Message: 1
</I>&gt;<i> Date: Thu, 23 Jun 2005 12:18:06 -0400
</I>&gt;<i> From: Dave Gray &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">dgray at omniti.com</A>&gt;
</I>&gt;<i> Subject: Re: [Twisted-web] Defers, the reactor, and idiomatic/proper
</I>&gt;<i>         usage   -- new user needs some advice?
</I>&gt;<i> To: Richard Meraz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">rfmeraz at gmail.com</A>&gt;, &quot;Discussion of twisted.web,
</I>&gt;<i>         Nevow,  and Woven&quot; &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">twisted-web at twistedmatrix.com</A>&gt;
</I>&gt;<i> Message-ID: &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">42BAE0BE.1040209 at omniti.com</A>&gt;
</I>&gt;<i> Content-Type: text/plain; charset=&quot;windows-1252&quot;
</I>&gt;<i> 
</I>&gt;<i> I'm not familiar with feedlib, etc, but I'll answer what I can.
</I>&gt;<i> 
</I>&gt;<i> Richard Meraz wrote:
</I>&gt;<i> &gt; MAXTIME = 60 # Kill crawl after this time
</I>&gt;<i> &gt; TIMEOUT = 20 # Kill page retrieval after this time inactive
</I>&gt;<i> &gt; MAXDEPTH = 3 # Recurse this depth when crawling page.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # Question: There seem to be many idioms to aggregate information from
</I>&gt;<i> &gt; different defered call-back chains in twisted..  Since everything runs
</I>&gt;<i> &gt; in a single thread I just stuck my stuff in a global class and everybody
</I>&gt;<i> &gt; modifies the vars there as I pass it around to the call-backs that
</I>&gt;<i> &gt; should see it.  Seems okay for a small script like this?
</I>&gt;<i> 
</I>&gt;<i> That seems fine, yeah. I think I would pass around the StateVars
</I>&gt;<i> instance as a context if I were coding this. Probably the same effect.
</I>&gt;<i> 
</I>&gt;<i> &gt; class StateVars:
</I>&gt;<i> &gt;     '''Keep Global state for starting/stopping feedfinding and a record
</I>&gt;<i> &gt; of links we have checked and their status'''
</I>&gt;<i> &gt;     connections = 1
</I>&gt;<i> &gt;     links_checked = {} # Structure: {url: (is RSS/ATOM/RDF, page-content)}
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # Question: start_feed_crawl is where I set up my defers.  getPage
</I>&gt;<i> &gt; returns a defer and I attach my call-back process_link.
</I>&gt;<i> &gt; # addCallbacks adds a callback/errback in parallel so only one or the
</I>&gt;<i> &gt; other is called?  so I need to add
</I>&gt;<i> &gt; # the final errback to catch errors from callback process_link ?
</I>&gt;<i> 
</I>&gt;<i> Correct. Well, sort of. See below.
</I>&gt;<i> 
</I>&gt;<i> &gt; def start_feed_crawl(uri,depth):
</I>&gt;<i> &gt;     '''Harvest feeds from a uri'''
</I>&gt;<i> &gt; # Question: how to time-out this deferred chain if getPage is taking too
</I>&gt;<i> &gt; long to finish its work.
</I>&gt;<i> &gt; # what exactly does the argument timeout to getPage do,  does it timeout
</I>&gt;<i> &gt; the socket after a no-response
</I>&gt;<i> &gt; # or does it put an upper-bound on how long getPage has to finish its work?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     getPage(uri, timeout=TIMEOUT).addCallbacks(callback=process_link,
</I>&gt;<i> &gt;                                                       callbackArgs=(uri,
</I>&gt;<i> &gt; depth, StateVars),
</I>&gt;<i> &gt;                                                       errback =
</I>&gt;<i> &gt; process_error,
</I>&gt;<i> &gt;                                                       errbackArgs=(uri,StateVars)
</I>&gt;<i> &gt;                                                       ).addErrback(process_error,
</I>&gt;<i> &gt; uri, StateVars)
</I>&gt;<i> 
</I>&gt;<i> It seems clearer to me to write this as follows, but that's personal
</I>&gt;<i> preference:
</I>&gt;<i> 
</I>&gt;<i>      d = getPage(...)
</I>&gt;<i>      d.addCallbacks(...)
</I>&gt;<i>      d.addErrback(...)
</I>&gt;<i> 
</I>&gt;<i> But since you're setting up the call to the same errback twice, you
</I>&gt;<i> could simplify this to:
</I>&gt;<i> 
</I>&gt;<i>      d = getPage(...)
</I>&gt;<i>      d.addCallback(process_link, uri, depth, StateVars)
</I>&gt;<i>      d.addErrback(process_error, uri, StateVars)
</I>&gt;<i> 
</I>&gt;<i> &lt;<A HREF="http://twistedmatrix.com/projects/core/documentation/howto/defer.html#auto4">http://twistedmatrix.com/projects/core/documentation/howto/defer.html#auto4</A>&gt;
</I>&gt;<i> has a nice visual explanation of what happens when.
</I>&gt;<i> 
</I>&gt;<i> &gt; # Question: since I'm starting up these defers in a callback they are
</I>&gt;<i> &gt; # being created after I've called reactor.run() since we call start_feed_crawl
</I>&gt;<i> &gt; # as we find new links that meet our criteria.  Am I doing anything bad here?
</I>&gt;<i> &gt; # All the examples I've seen (eg. p. 548-552 Python Cookbook, great eg by V. Volonghi
</I>&gt;<i> &gt; # and P. Cogolo) have their data up-front and therefore set-up all the defers before calling
</I>&gt;<i> &gt; # reactor.run().  Here I'm discovering my data as I go along and setting up deferrs while
</I>&gt;<i> &gt; # the reactor is spinning.  Here is my fundamental lack of understanding.  While this script
</I>&gt;<i> &gt; # seems to run okay, is it okay to do this?
</I>&gt;<i> 
</I>&gt;<i> Yes, that's fine. I think the one you've seen the most is the odd case -
</I>&gt;<i> being able to set up all the Deferreds beforehand.
</I>&gt;<i> 
</I>&gt;<i> &gt;     # Question: Is this how I kill the reactor -- ie. using some sort of
</I>&gt;<i> &gt; state condition.  Is there a better way,
</I>&gt;<i> &gt;     # should I try better to understand deferred-list.  For example.  A
</I>&gt;<i> &gt; top-level deferred-list that contains
</I>&gt;<i> &gt;     # other deferred-lists which get created to hold all the defers
</I>&gt;<i> &gt; (created by start_feed_crawl) for the
</I>&gt;<i> &gt;     # links on a given page.  Could this deferred-list be told to stop
</I>&gt;<i> &gt; the reactor when the other lists have
</I>&gt;<i> &gt;     # fired their callback (after the component defers have finished) ?
</I>&gt;<i> &gt; (Sorry for the convoluted question here
</I>&gt;<i> &gt;     # I'm new at this)
</I>&gt;<i> 
</I>&gt;<i> What you want to do is stop the reactor when everything is done
</I>&gt;<i> processing. So after you call start_feed_crawl the first time, returning
</I>&gt;<i> the Deferred that getPage gives you, you can add a callback to that
</I>&gt;<i> which stops the reactor. The trick here is that if you stuff that
</I>&gt;<i> deferred into a DeferredList before you add the callback that stops the
</I>&gt;<i> reactor then if your first operation itself returns a deferred, the
</I>&gt;<i> DeferredList won't call its callbacks until the other Deferred operation
</I>&gt;<i> completes. So you'll be stacking up a whole bunch of Deferreds inside
</I>&gt;<i> the first one, and the callback on the DeferredList that does the
</I>&gt;<i> reactor.stop won't fire until you don't return a Deferred.
</I>&gt;<i> 
</I>&gt;<i> There might be an easier way to do this, but this the way I know
</I>&gt;<i> (example attached). Someone please let me know if there's an easier way.
</I>&gt;<i> To see the example, run it with 'twistd -noy fetchpage.tac' then do
</I>&gt;<i> 'telnet localhost 9000' and send:
</I>&gt;<i> 
</I>&gt;<i> GET /?target=<A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
</I>&gt;<i> Host: localhost
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; Final question: occasionally I get errors that come from the http.py
</I>&gt;<i> &gt; code in twisted.  This get printed to the console, but don't necessarily
</I>&gt;<i> &gt; stop my program.  Should my errbacks be catching these?  How do I keep
</I>&gt;<i> &gt; errors from getting logged to the console (beside redirecting stderr). I
</I>&gt;<i> &gt; can post an example if necessary of the errors I'm getting.
</I>&gt;<i> 
</I>&gt;<i> When you create the DeferredList, pass in consumeErrors=1 - this will
</I>&gt;<i> make debugging that much more annoying though...
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> Dave
</I>&gt;<i> -------------- next part --------------
</I>&gt;<i> from twisted.web import server
</I>&gt;<i> from twisted.web.resource import Resource
</I>&gt;<i> from twisted.web.client import getPage
</I>&gt;<i> 
</I>&gt;<i> from twisted.internet import defer, reactor
</I>&gt;<i> from twisted.python import log
</I>&gt;<i> from cgi import escape
</I>&gt;<i> class Foo(Resource):
</I>&gt;<i>     counter = 0
</I>&gt;<i>     isLeaf=True
</I>&gt;<i>     def render_GET (self, request):
</I>&gt;<i>         self.rq = request
</I>&gt;<i>         target = escape(request.args['target'][0])
</I>&gt;<i>         d = getPage(target).addCallback(self.print_page)
</I>&gt;<i>         d.addErrback(log.err)
</I>&gt;<i>         dl = defer.DeferredList([d])
</I>&gt;<i>         dl.addCallback(stopNow)
</I>&gt;<i>         dl.addErrback(log.err)
</I>&gt;<i>         return server.NOT_DONE_YET
</I>&gt;<i> 
</I>&gt;<i>     def print_page (self, html):
</I>&gt;<i>         if Foo.counter &lt; 5:
</I>&gt;<i>             Foo.counter += 1
</I>&gt;<i>             print 'request '+str(Foo.counter)
</I>&gt;<i>             d = defer.Deferred()
</I>&gt;<i>             d.addCallback(self.print_page)
</I>&gt;<i>             d.addErrback(log.err)
</I>&gt;<i>             reactor.callLater(1, d.callback, html)
</I>&gt;<i>             return d
</I>&gt;<i>         else:
</I>&gt;<i>             print 'now we can write stuff back'
</I>&gt;<i>             self.rq.write(str(len(html))+' '+str(Foo.counter))
</I>&gt;<i>             self.rq.finish()
</I>&gt;<i>             self.rq.transport.loseConnection()
</I>&gt;<i>             # no deferred being returned, stopNow fires
</I>&gt;<i> 
</I>&gt;<i> def stopNow(cbval):
</I>&gt;<i>     # can't add reactor.stop as a callback directly
</I>&gt;<i>     # because it doesn't know what to do with the extra
</I>&gt;<i>     # argument being returned from the callback
</I>&gt;<i>     print cbval
</I>&gt;<i>     reactor.stop()
</I>&gt;<i> 
</I>&gt;<i> resource = Foo()
</I>&gt;<i> site = server.Site(resource)
</I>&gt;<i> 
</I>&gt;<i> from twisted.application import service, internet
</I>&gt;<i> application = service.Application(&quot;Foo&quot;)
</I>&gt;<i> internet.TCPServer(9000, site).setServiceParent(application)
</I>&gt;<i> 
</I>&gt;<i> # vim: ai sts=4 sw=4 expandtab syntax=python :
</I>&gt;<i> 
</I>&gt;<i> ------------------------------
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> End of Twisted-web Digest, Vol 15, Issue 20
</I>&gt;<i> *******************************************
</I>&gt;<i> 
</I>

-- 
Never think there is anything impossible for the soul. It is the
greatest heresy to think so. If there is sin, this is the only sin &#8211;
to say that you are weak, or others are weak.

Swami Vivekananda
</PRE>








<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001574.html">[Twisted-web] Uploading files
</A></li>
	<LI>Next message: <A HREF="001588.html">[Twisted-web] Re: Twisted-web Digest, Vol 15, Issue 20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1576">[ date ]</a>
              <a href="thread.html#1576">[ thread ]</a>
              <a href="subject.html#1576">[ subject ]</a>
              <a href="author.html#1576">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
