From sebastien.pastor at gmx.com  Mon May 10 10:44:39 2010
From: sebastien.pastor at gmx.com (Sebastien PASTOR)
Date: Mon, 10 May 2010 16:44:39 +0200
Subject: [Twisted-web] Newbie question : client connection lost
Message-ID: <20100510144439.GB30467@seblaptop>

Hi !
I am very new at Twisted. What i am trying to achieve is a simple web
service using basic HTTTP GET and POST requests. My big requirement is
being able to detect when the connection is closed client side. Bottom
line being : i want to know that each GET or POST result has been
successfully or not sent to the client. I could not managed to do that using WSGI. 
Is there way to try: catch sockets exception using Twisted or should i
go the async way and use notifyFinish() and friends ?

Thanks in advance !


Seb


From graemeglass at gmail.com  Mon May 10 10:00:03 2010
From: graemeglass at gmail.com (Graeme Glass)
Date: Mon, 10 May 2010 16:00:03 +0200
Subject: [Twisted-web] Newbie question : client connection lost
In-Reply-To: <20100510144439.GB30467@seblaptop>
References: <20100510144439.GB30467@seblaptop>
Message-ID: <AANLkTinjVo8vipIjitNhnkcKPcdkkEtXw-tmS0-vOSep@mail.gmail.com>

On Mon, May 10, 2010 at 4:44 PM, Sebastien PASTOR
<sebastien.pastor at gmx.com> wrote:
> Hi !
> I am very new at Twisted. What i am trying to achieve is a simple web
> service using basic HTTTP GET and POST requests. My big requirement is
> being able to detect when the connection is closed client side. Bottom
> line being : i want to know that each GET or POST result has been
> successfully or not sent to the client. I could not managed to do that using WSGI.
> Is there way to try: catch sockets exception using Twisted or should i
> go the async way and use notifyFinish() and friends ?
>
> Thanks in advance !
>
>
> Seb

HTTP is stateless, you have no way of knowing if the client closed the
connection

Take a look at this, for some ideas
http://en.wikipedia.org/wiki/Comet_%28programming%29

hth

Graeme


From sebastien.pastor at gmx.com  Mon May 10 11:04:57 2010
From: sebastien.pastor at gmx.com (Sebastien PASTOR)
Date: Mon, 10 May 2010 17:04:57 +0200
Subject: [Twisted-web] Newbie question : client connection lost
In-Reply-To: <AANLkTinjVo8vipIjitNhnkcKPcdkkEtXw-tmS0-vOSep@mail.gmail.com>
References: <20100510144439.GB30467@seblaptop>
	<AANLkTinjVo8vipIjitNhnkcKPcdkkEtXw-tmS0-vOSep@mail.gmail.com>
Message-ID: <20100510150457.GC30467@seblaptop>

Thanks graeme, 

Yup, i know  HTTP is stateless.. My question is more how to get the exception
from a Resource object when trying to write to a closed socket.

cheers

Seb

On Mon, May 10, 2010 at 04:00:03PM +0200, Graeme Glass wrote:
> On Mon, May 10, 2010 at 4:44 PM, Sebastien PASTOR
> <sebastien.pastor at gmx.com> wrote:
> > Hi !
> > I am very new at Twisted. What i am trying to achieve is a simple web
> > service using basic HTTTP GET and POST requests. My big requirement is
> > being able to detect when the connection is closed client side. Bottom
> > line being : i want to know that each GET or POST result has been
> > successfully or not sent to the client. I could not managed to do that using WSGI.
> > Is there way to try: catch sockets exception using Twisted or should i
> > go the async way and use notifyFinish() and friends ?
> >
> > Thanks in advance !
> >
> >
> > Seb
> 
> HTTP is stateless, you have no way of knowing if the client closed the
> connection
> 
> Take a look at this, for some ideas
> http://en.wikipedia.org/wiki/Comet_%28programming%29
> 
> hth
> 
> Graeme
> 
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web


From p.mayers at imperial.ac.uk  Mon May 10 10:25:33 2010
From: p.mayers at imperial.ac.uk (Phil Mayers)
Date: Mon, 10 May 2010 15:25:33 +0100
Subject: [Twisted-web] Newbie question : client connection lost
In-Reply-To: <20100510150457.GC30467@seblaptop>
References: <20100510144439.GB30467@seblaptop>	<AANLkTinjVo8vipIjitNhnkcKPcdkkEtXw-tmS0-vOSep@mail.gmail.com>
	<20100510150457.GC30467@seblaptop>
Message-ID: <4BE8175D.6040805@imperial.ac.uk>

On 10/05/10 16:04, Sebastien PASTOR wrote:
> Thanks graeme,
>
> Yup, i know  HTTP is stateless.. My question is more how to get the exception
> from a Resource object when trying to write to a closed socket.

There's a request.notifyFinish method somewhere in there, which returns 
a deferred that callback's on success and errback's on failure.


From markscottwright at gmail.com  Mon May 10 12:35:22 2010
From: markscottwright at gmail.com (markscottwright at gmail.com)
Date: Mon, 10 May 2010 16:35:22 +0000
Subject: [Twisted-web] How can I direct a user to a "you are being logged
	off" page?
Message-ID: <0016e65b5cccc7d35604863ffe50@google.com>

I'm using twisted web (not nevow) in an application right now. I'm handling  
expiration by having a LogonState Session variable, which has an  
is_logged_in member that defaults to False. All requests are checked for  
this and redirected to my logon page if is_logged_in is not true.

This is all working fine, but unfortunately, it means that timeouts are  
abrupt - you are just re-directed to a logon page with no warning the next  
time you try to access a resource after session timeout.

Session expiration callbacks don't seem that useful here. I'll be notified,  
but then the session is gone and I no longer have any way of knowing if the  
next request is from someone who once had a valid session, but no longer  
does.

How do others deal with this issue?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20100510/c6131520/attachment.htm 

From maarten at treewalker.org  Mon May 10 13:04:15 2010
From: maarten at treewalker.org (Maarten ter Huurne)
Date: Mon, 10 May 2010 19:04:15 +0200
Subject: [Twisted-web] How can I direct a user to a "you are being
	logged off" page?
In-Reply-To: <0016e65b5cccc7d35604863ffe50@google.com>
References: <0016e65b5cccc7d35604863ffe50@google.com>
Message-ID: <201005101904.15911.maarten@treewalker.org>

On Monday 10 May 2010, markscottwright at gmail.com wrote:

> I'm using twisted web (not nevow) in an application right now. I'm
> handling expiration by having a LogonState Session variable, which has
> an is_logged_in member that defaults to False. All requests are checked
> for this and redirected to my logon page if is_logged_in is not true.
> 
> This is all working fine, but unfortunately, it means that timeouts are
> abrupt - you are just re-directed to a logon page with no warning the
> next time you try to access a resource after session timeout.
> 
> Session expiration callbacks don't seem that useful here. I'll be
> notified, but then the session is gone and I no longer have any way of
> knowing if the next request is from someone who once had a valid
> session, but no longer does.

Since the session is remembered by storing a session ID in a session cookie, 
maybe you could check for the presence of that cookie in the request? If it 
is present, you could add an argument like "reason=expired" to the login 
redirect.

Bye,
		Maarten


From sebastien.pastor at gmx.com  Tue May 11 08:23:47 2010
From: sebastien.pastor at gmx.com (Sebastien PASTOR)
Date: Tue, 11 May 2010 14:23:47 +0200
Subject: [Twisted-web] Newbie question : client connection lost
In-Reply-To: <4BE8175D.6040805@imperial.ac.uk>
References: <20100510144439.GB30467@seblaptop>
	<AANLkTinjVo8vipIjitNhnkcKPcdkkEtXw-tmS0-vOSep@mail.gmail.com>
	<20100510150457.GC30467@seblaptop>
	<4BE8175D.6040805@imperial.ac.uk>
Message-ID: <20100511122346.GA7699@seblaptop>

Thanks Phil, 

I managed to be notified when the connection is cleanly closed by the
client (ie: browser is stop or close window).
But i could not handle non-clean connection closure (ie: when wifi  goes
down client side for instance). request.finish() does not event raise
any error. ...
I am a bit stuck here. .. any ideas ?

Thanks

Seb

On Mon, May 10, 2010 at 03:25:33PM +0100, Phil Mayers wrote:
> On 10/05/10 16:04, Sebastien PASTOR wrote:
> > Thanks graeme,
> >
> > Yup, i know  HTTP is stateless.. My question is more how to get the exception
> > from a Resource object when trying to write to a closed socket.
> 
> There's a request.notifyFinish method somewhere in there, which returns 
> a deferred that callback's on success and errback's on failure.
> 
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web


From p.mayers at imperial.ac.uk  Tue May 11 07:54:40 2010
From: p.mayers at imperial.ac.uk (Phil Mayers)
Date: Tue, 11 May 2010 12:54:40 +0100
Subject: [Twisted-web] Newbie question : client connection lost
In-Reply-To: <20100511122346.GA7699@seblaptop>
References: <20100510144439.GB30467@seblaptop>	<AANLkTinjVo8vipIjitNhnkcKPcdkkEtXw-tmS0-vOSep@mail.gmail.com>	<20100510150457.GC30467@seblaptop>	<4BE8175D.6040805@imperial.ac.uk>
	<20100511122346.GA7699@seblaptop>
Message-ID: <4BE94580.2080201@imperial.ac.uk>

On 11/05/10 13:23, Sebastien PASTOR wrote:
> Thanks Phil,
>
> I managed to be notified when the connection is cleanly closed by the
> client (ie: browser is stop or close window).
> But i could not handle non-clean connection closure (ie: when wifi  goes
> down client side for instance). request.finish() does not event raise
> any error. ...
> I am a bit stuck here. .. any ideas ?

I'm not sure I follow.

Have a look at this to make sure you're using it properly:

http://jcalderone.livejournal.com/50890.html


From sebastien.pastor at gmx.com  Tue May 11 09:46:36 2010
From: sebastien.pastor at gmx.com (Sebastien PASTOR)
Date: Tue, 11 May 2010 15:46:36 +0200
Subject: [Twisted-web] Newbie question : client connection lost
In-Reply-To: <4BE94580.2080201@imperial.ac.uk>
References: <20100510144439.GB30467@seblaptop>
	<AANLkTinjVo8vipIjitNhnkcKPcdkkEtXw-tmS0-vOSep@mail.gmail.com>
	<20100510150457.GC30467@seblaptop>
	<4BE8175D.6040805@imperial.ac.uk> <20100511122346.GA7699@seblaptop>
	<4BE94580.2080201@imperial.ac.uk>
Message-ID: <20100511134635.GB7699@seblaptop>

It looks to me that this is what i am doin ... I really might be
doing something wrong here but can t see what.
The only difference with the livejournal's code is that i am trying to
run a blocking code so i am doing a threads.deferToThread instead of doing a 
callLater. 
To test the connection lost, client side i am disabling the wifi while
the server is blocking (sleeping). At the end of the blocking code:
request.write() and finish() are done as if the connection was available
and my ErrCallBack is not called.

I hope i am clear... in attachment the code i am using 


Thanks for your time

Seb






On Tue, May 11, 2010 at 12:54:40PM +0100, Phil Mayers wrote:
> On 11/05/10 13:23, Sebastien PASTOR wrote:
> > Thanks Phil,
> >
> > I managed to be notified when the connection is cleanly closed by the
> > client (ie: browser is stop or close window).
> > But i could not handle non-clean connection closure (ie: when wifi  goes
> > down client side for instance). request.finish() does not event raise
> > any error. ...
> > I am a bit stuck here. .. any ideas ?
> 
> I'm not sure I follow.
> 
> Have a look at this to make sure you're using it properly:
> 
> http://jcalderone.livejournal.com/50890.html
> 
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
-------------- next part --------------
A non-text attachment was scrubbed...
Name: delay.py
Type: text/x-python
Size: 1083 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20100511/36415b90/attachment.py 

From p.mayers at imperial.ac.uk  Tue May 11 09:06:27 2010
From: p.mayers at imperial.ac.uk (Phil Mayers)
Date: Tue, 11 May 2010 14:06:27 +0100
Subject: [Twisted-web] Newbie question : client connection lost
In-Reply-To: <20100511134635.GB7699@seblaptop>
References: <20100510144439.GB30467@seblaptop>	<AANLkTinjVo8vipIjitNhnkcKPcdkkEtXw-tmS0-vOSep@mail.gmail.com>	<20100510150457.GC30467@seblaptop>	<4BE8175D.6040805@imperial.ac.uk>
	<20100511122346.GA7699@seblaptop>	<4BE94580.2080201@imperial.ac.uk>
	<20100511134635.GB7699@seblaptop>
Message-ID: <4BE95653.1000205@imperial.ac.uk>

On 11/05/10 14:46, Sebastien PASTOR wrote:
> It looks to me that this is what i am doin ... I really might be
> doing something wrong here but can t see what.
> The only difference with the livejournal's code is that i am trying to
> run a blocking code so i am doing a threads.deferToThread instead of doing a
> callLater.
> To test the connection lost, client side i am disabling the wifi while
> the server is blocking (sleeping). At the end of the blocking code:
> request.write() and finish() are done as if the connection was available
> and my ErrCallBack is not called.

If you're disabling the wi-fi, then you'll have to wait until the TCP 
connection timeout occurs. This might be a long, long time, or possibly 
never, if keepalives aren't enabled.

You could try enabling aggressive values for TCP keepalives on the 
underlying TCP connection, but I'm not sure that's advisable.


From oscar.campos at open-phoenix.com  Tue May 11 15:03:08 2010
From: oscar.campos at open-phoenix.com (Oscar Campos)
Date: Tue, 11 May 2010 21:03:08 +0200
Subject: [Twisted-web] Sessions and stored objects
Message-ID: <AANLkTikUWlEAoiyVpv3iAkNHAfS_LuhbKsdaRPA1ZJwi@mail.gmail.com>

Greetings.

I'm storing User objects in my sessions, those User objects can perform some
actions at application if they have permissions in the ACL.
When I need to do logout with any of them I just use the expire method from
the Session object and this works nice using the notufyOnExpire callback,
but I'm just curious.

Is there any way that I can call Session methods from store session objects?

user.logout() should look nicer.

Ty.

-- 
Oscar Campos Ruiz-Adame -oscar.campos at open-phoenix.com
Consultor - Consultant
Open Phoenix IT Consultor?a Tecnol?gica - IT Consulting
_________________________________________________
Tel. +34 644569088
http://www.open-phoenix.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20100511/49000a42/attachment.htm 

From exarkun at twistedmatrix.com  Thu May 13 09:55:26 2010
From: exarkun at twistedmatrix.com (exarkun at twistedmatrix.com)
Date: Thu, 13 May 2010 13:55:26 -0000
Subject: [Twisted-web] Sessions and stored objects
In-Reply-To: <AANLkTikUWlEAoiyVpv3iAkNHAfS_LuhbKsdaRPA1ZJwi@mail.gmail.com>
References: <AANLkTikUWlEAoiyVpv3iAkNHAfS_LuhbKsdaRPA1ZJwi@mail.gmail.com>
Message-ID: <20100513135526.1694.690456252.divmod.xquotient.3@localhost.localdomain>

On 11 May, 07:03 pm, oscar.campos at open-phoenix.com wrote:
>Greetings.
>
>I'm storing User objects in my sessions, those User objects can perform 
>some
>actions at application if they have permissions in the ACL.
>When I need to do logout with any of them I just use the expire method 
>from
>the Session object and this works nice using the notufyOnExpire 
>callback,
>but I'm just curious.
>
>Is there any way that I can call Session methods from store session 
>objects?

The session is a regular Python object (as is everything).  You can call 
methods on it in the usual way.
>
>user.logout() should look nicer.
>
>Ty.
>
>--
>Oscar Campos Ruiz-Adame -oscar.campos at open-phoenix.com
>Consultor - Consultant
>Open Phoenix IT Consultor?a Tecnol?gica - IT Consulting
>_________________________________________________
>Tel. +34 644569088
>http://www.open-phoenix.com


From wthie at thiengineering.ch  Sat May 15 21:00:10 2010
From: wthie at thiengineering.ch (Werner Thie)
Date: Sun, 16 May 2010 03:00:10 +0200
Subject: [Twisted-web] gzipped content
Message-ID: <4BEF439A.2020508@thiengineering.ch>

Hi

There must be an easy answer for this, it just eludes me. After some 
digging in the source code it looked like this will be handled 
automatically for static resources in twisted.web

Hitting http://www.gidnetwork.com/tools/gzip-test.php shows that this is 
not the case, response headers for my LivePage site are set to

status          HTTP/1.0 200 OK
date            Sun, 16 May 2010 00:50:29 GMT
cache-control   no-store, no-cache,
must-revalidate
content-type    text/html;
charset=UTF-8
pragma 	        no-cache
server 	        TwistedWeb/10.0.0

Is there an easy way to switch to gzipped content, helping a lot with 
delivering more and more JScript code to the user (obfuscated and all I 
could squeeze out another factor of three)

Thank you, Werner


From maarten at treewalker.org  Sat May 15 21:17:48 2010
From: maarten at treewalker.org (Maarten ter Huurne)
Date: Sun, 16 May 2010 03:17:48 +0200
Subject: [Twisted-web] gzipped content
In-Reply-To: <4BEF439A.2020508@thiengineering.ch>
References: <4BEF439A.2020508@thiengineering.ch>
Message-ID: <201005160317.48717.maarten@treewalker.org>

On Sunday 16 May 2010, Werner Thie wrote:

> There must be an easy answer for this, it just eludes me. After some
> digging in the source code it looked like this will be handled
> automatically for static resources in twisted.web

Do the client headers tell that it is willing to accept gzip encoding?

Bye,
		Maarten


From maillists at ivsn.com  Sun May 16 06:01:31 2010
From: maillists at ivsn.com (Paul Reznicek)
Date: Sun, 16 May 2010 12:01:31 +0200
Subject: [Twisted-web] gzipped content for speed-up nevow
In-Reply-To: <4BEF439A.2020508@thiengineering.ch>
References: <4BEF439A.2020508@thiengineering.ch>
Message-ID: <4BEFC27B.2030706@ivsn.com>

Werner Thie wrote:
> There must be an easy answer for this, it just eludes me. After some 
> digging in the source code it looked like this will be handled 
> automatically for static resources in twisted.web
> 
> Hitting http://www.gidnetwork.com/tools/gzip-test.php shows that this is 
> ...
> 
> Is there an easy way to switch to gzipped content, helping a lot with 
> delivering more and more JScript code to the user (obfuscated and all I 
> could squeeze out another factor of three)
> 
> Thank you, Werner

Hello Werner, hello all,
this is also very interesting for me, but I did not found a way.
Here is probably a part of the solution:
   http://www.mail-archive.com/twisted-web at twistedmatrix.com/msg01694.html
but I did not get it to work with Athena resp. nevow.rend.Page. Any idea?

Thank you, Paul




From johan.rydberg at edgeware.tv  Mon May 17 02:47:41 2010
From: johan.rydberg at edgeware.tv (Johan Rydberg)
Date: Mon, 17 May 2010 08:47:41 +0200
Subject: [Twisted-web] gzipped content for speed-up nevow
In-Reply-To: <4BEFC27B.2030706@ivsn.com>
References: <4BEF439A.2020508@thiengineering.ch> <4BEFC27B.2030706@ivsn.com>
Message-ID: <4BF0E68D.3020705@edgeware.tv>

I'm using this to serve up my static content:

   http://github.com/jrydberg/edgy/blob/master/src/edgy/web/static.py

It's for twisted.web and not nevow.

Cheers,
Johan

On 5/16/10 12:01 PM, Paul Reznicek wrote:
> Werner Thie wrote:
>    
>> There must be an easy answer for this, it just eludes me. After some
>> digging in the source code it looked like this will be handled
>> automatically for static resources in twisted.web
>>
>> Hitting http://www.gidnetwork.com/tools/gzip-test.php shows that this is
>> ...
>>
>> Is there an easy way to switch to gzipped content, helping a lot with
>> delivering more and more JScript code to the user (obfuscated and all I
>> could squeeze out another factor of three)
>>
>> Thank you, Werner
>>      
> Hello Werner, hello all,
> this is also very interesting for me, but I did not found a way.
> Here is probably a part of the solution:
>     http://www.mail-archive.com/twisted-web at twistedmatrix.com/msg01694.html
> but I did not get it to work with Athena resp. nevow.rend.Page. Any idea?
>
> Thank you, Paul
>
>
>
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>
>
>    



From alecs.box at gmail.com  Thu May 20 16:21:13 2010
From: alecs.box at gmail.com (Sosnovskiy Alexander)
Date: Thu, 20 May 2010 23:21:13 +0300
Subject: [Twisted-web] SOAPPublisher: How to work with <soap:Header> ?
Message-ID: <AANLkTikxJUHxJ9DZsljZ7hZerHKv857RrZFNJo7BQjZg@mail.gmail.com>

Hi all!
I need to create a service which will set headers into response, but
if to be honest have no idea of how to achieve this goal :(
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20100520/4b8d24c2/attachment.htm 

From djimenez at unipost.es  Wed May 26 18:46:06 2010
From: djimenez at unipost.es (DAVID JIMENEZ CARRASCO)
Date: Thu, 27 May 2010 00:46:06 +0200
Subject: [Twisted-web] sendLine and connectionLost question
Message-ID: <1AC73264A19DAD4C8478A9ED565C42E70B3FA6361E@YPAMail.unipost.es>

Hi all,

I'm trying to write a typical chat server application with twisted. At this moment, all is working fine except for some strange behaviour with sendLine and connectionLost funcs. Let me explain the problem:

- I have a server on the internet.
- I connect two PCs (2 clients) from the same LAN through a router to that server
- All is working fine until I disconnect the LAN of one of those PC (The client is disconnected but the server doesn't know about it). Just to test a typical wireless disconnection without closing sockets, etc...
- After disconnecting I try to send some messages through the remaining clients to all clients through this function:

    def sendMessageToAllClients(self, mesg,reqClient):
        for client in self.clientProtocols:
            dataLength = str(len(mesg))
            if (len(dataLength) < 8):
                dif = 8 - len(dataLength)
                dataLength = "0"*dif + dataLength
            print "Enviando a:",str(client)
            client.sendLine(dataLength+mesg)
            client.clearLineBuffer()

As you can see, I send a message to all clients, including the one disconnected because the server doesn't
 know at this moment that the client is "out". I'm able to send 6 or 7 messages to the remaining client but
 after that, the connection get lost. I would expect to have a connectionLost with the client offline but actually
I got a connectionLost in both clients and I don't know why. The server disconnect both clients with "non clean fashion".

Any help or advice would be highly appreciated.

Regards,

David


------------------------------------------------------------------------------------------------------------------------------------------------
Este mensaje es confidencial y ata?e exclusivamente a las personas a las que va dirigido.
Cualquier opini?n en el contenida, es exclusivo de su autor y no representa necesariamente
la opinion de UNIPOST, S.A.
Si Ud. no es el destinatario del  mensaje, considerese advertido que lo ha recibido por error
y que cualquier difusi?n o copia estan terminantemente prohibidos. Si ha recibido por error, 
por favor comuniquelo a UNIPOST, S.A. al n?mero +34 93 223 25 52 o correo electr?nico 
a <support at unipost.es>.

This e-mail is confidential and intended solely for the use of the individual to whom it is addressed.
Any opinions presented are solely those of the author and do not necessarily represent those of 
UNIPOST, S.A.
If you are not the intended recipient, be advised that you have received this e-mail in error and that 
dissemination, forwarding or copying of this e-mail is strictly prohibited. If you have received this 
e-mail in error please notify it to UNIPOST, S.A. by telephone on number +34 93 223 25 52 or by
e-mail to <support at unipost.es>.
------------------------------------------------------------------------------------------------------------------------------------------------
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20100527/5d747dc4/attachment.htm 

From exarkun at twistedmatrix.com  Wed May 26 21:38:49 2010
From: exarkun at twistedmatrix.com (exarkun at twistedmatrix.com)
Date: Thu, 27 May 2010 01:38:49 -0000
Subject: [Twisted-web] sendLine and connectionLost question
In-Reply-To: <1AC73264A19DAD4C8478A9ED565C42E70B3FA6361E@YPAMail.unipost.es>
References: <1AC73264A19DAD4C8478A9ED565C42E70B3FA6361E@YPAMail.unipost.es>
Message-ID: <20100527013849.1974.428959893.divmod.xquotient.9@localhost.localdomain>

On 26 May, 10:46 pm, djimenez at unipost.es wrote:
>Hi all,
>
>I'm trying to write a typical chat server application with twisted. At 
>this moment, all is working fine except for some strange behaviour with 
>sendLine and connectionLost funcs. Let me explain the problem:
>
>- I have a server on the internet.
>- I connect two PCs (2 clients) from the same LAN through a router to 
>that server
>- All is working fine until I disconnect the LAN of one of those PC 
>(The client is disconnected but the server doesn't know about it). Just 
>to test a typical wireless disconnection without closing sockets, 
>etc...
>- After disconnecting I try to send some messages through the remaining 
>clients to all clients through this function:
>
>    def sendMessageToAllClients(self, mesg,reqClient):
>        for client in self.clientProtocols:
>            dataLength = str(len(mesg))
>            if (len(dataLength) < 8):
>                dif = 8 - len(dataLength)
>                dataLength = "0"*dif + dataLength
>            print "Enviando a:",str(client)
>            client.sendLine(dataLength+mesg)
>            client.clearLineBuffer()

You shouldn't be calling `client.clearLineBuffer()` here.
>
>As you can see, I send a message to all clients, including the one 
>disconnected because the server doesn't
>know at this moment that the client is "out". I'm able to send 6 or 7 
>messages to the remaining client but
>after that, the connection get lost. I would expect to have a 
>connectionLost with the client offline but actually
>I got a connectionLost in both clients and I don't know why. The server 
>disconnect both clients with "non clean fashion".
>
>Any help or advice would be highly appreciated.

This is how TCP works.  If the remote host stops responding to packets, 
then there's a period of time where the connection still appears to be 
up anyway.  After a TCP-level timer expires, the connection is 
considered lost.

Jean-Paul


From djimenez at unipost.es  Thu May 27 02:42:02 2010
From: djimenez at unipost.es (DAVID JIMENEZ CARRASCO)
Date: Thu, 27 May 2010 08:42:02 +0200
Subject: [Twisted-web] sendLine and connectionLost question
In-Reply-To: <20100527013849.1974.428959893.divmod.xquotient.9@localhost.localdomain>
References: <1AC73264A19DAD4C8478A9ED565C42E70B3FA6361E@YPAMail.unipost.es>,
	<20100527013849.1974.428959893.divmod.xquotient.9@localhost.localdomain>
Message-ID: <1AC73264A19DAD4C8478A9ED565C42E70B3FA63621@YPAMail.unipost.es>


Hi Jean Paul,

A lot of thanks for your quick answer. It's really appreciated. Regarding your answer, I understand that when the remote hosts stop responding, after a timer, the connection is considered lost. But the main problem is that the remaining client (the one that have not been disconnected) should continue working without problems and the fact is that the server closes connection to that client too in a "non clean fashion".

Regards and a lot of thanks for your help,

David

De: twisted-web-bounces at twistedmatrix.com [twisted-web-bounces at twistedmatrix.com] En nombre de exarkun at twistedmatrix.com [exarkun at twistedmatrix.com]
Enviado el: jueves, 27 de mayo de 2010 3:38
Para: Twisted Web World
Asunto: Re: [Twisted-web] sendLine and connectionLost question

On 26 May, 10:46 pm, djimenez at unipost.es wrote:
>Hi all,
>
>I'm trying to write a typical chat server application with twisted. At
>this moment, all is working fine except for some strange behaviour with
>sendLine and connectionLost funcs. Let me explain the problem:
>
>- I have a server on the internet.
>- I connect two PCs (2 clients) from the same LAN through a router to
>that server
>- All is working fine until I disconnect the LAN of one of those PC
>(The client is disconnected but the server doesn't know about it). Just
>to test a typical wireless disconnection without closing sockets,
>etc...
>- After disconnecting I try to send some messages through the remaining
>clients to all clients through this function:
>
>    def sendMessageToAllClients(self, mesg,reqClient):
>        for client in self.clientProtocols:
>            dataLength = str(len(mesg))
>            if (len(dataLength) < 8):
>                dif = 8 - len(dataLength)
>                dataLength = "0"*dif + dataLength
>            print "Enviando a:",str(client)
>            client.sendLine(dataLength+mesg)
>            client.clearLineBuffer()

You shouldn't be calling `client.clearLineBuffer()` here.
>
>As you can see, I send a message to all clients, including the one
>disconnected because the server doesn't
>know at this moment that the client is "out". I'm able to send 6 or 7
>messages to the remaining client but
>after that, the connection get lost. I would expect to have a
>connectionLost with the client offline but actually
>I got a connectionLost in both clients and I don't know why. The server
>disconnect both clients with "non clean fashion".
>
>Any help or advice would be highly appreciated.

This is how TCP works.  If the remote host stops responding to packets,
then there's a period of time where the connection still appears to be
up anyway.  After a TCP-level timer expires, the connection is
considered lost.

Jean-Paul

_______________________________________________
Twisted-web mailing list
Twisted-web at twistedmatrix.com
http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
------------------------------------------------------------------------------------------------------------------------------------------------
Este mensaje es confidencial y ata?e exclusivamente a las personas a las que va dirigido.
Cualquier opini?n en el contenida, es exclusivo de su autor y no representa necesariamente
la opinion de UNIPOST, S.A.
Si Ud. no es el destinatario del  mensaje, considerese advertido que lo ha recibido por error
y que cualquier difusi?n o copia estan terminantemente prohibidos. Si ha recibido por error, 
por favor comuniquelo a UNIPOST, S.A. al n?mero +34 93 223 25 52 o correo electr?nico 
a <support at unipost.es>.

This e-mail is confidential and intended solely for the use of the individual to whom it is addressed.
Any opinions presented are solely those of the author and do not necessarily represent those of 
UNIPOST, S.A.
If you are not the intended recipient, be advised that you have received this e-mail in error and that 
dissemination, forwarding or copying of this e-mail is strictly prohibited. If you have received this 
e-mail in error please notify it to UNIPOST, S.A. by telephone on number +34 93 223 25 52 or by
e-mail to <support at unipost.es>.
------------------------------------------------------------------------------------------------------------------------------------------------


From exarkun at twistedmatrix.com  Thu May 27 09:44:56 2010
From: exarkun at twistedmatrix.com (exarkun at twistedmatrix.com)
Date: Thu, 27 May 2010 13:44:56 -0000
Subject: [Twisted-web] sendLine and connectionLost question
In-Reply-To: <1AC73264A19DAD4C8478A9ED565C42E70B3FA63621@YPAMail.unipost.es>
References: <1AC73264A19DAD4C8478A9ED565C42E70B3FA6361E@YPAMail.unipost.es>,
	<20100527013849.1974.428959893.divmod.xquotient.9@localhost.localdomain>
	<1AC73264A19DAD4C8478A9ED565C42E70B3FA63621@YPAMail.unipost.es>
Message-ID: <20100527134456.2801.1144368787.divmod.xquotient.2@localhost.localdomain>

On 06:42 am, djimenez at unipost.es wrote:
>
>Hi Jean Paul,
>
>A lot of thanks for your quick answer. It's really appreciated. 
>Regarding your answer, I understand that when the remote hosts stop 
>responding, after a timer, the connection is considered lost. But the 
>main problem is that the remaining client (the one that have not been 
>disconnected) should continue working without problems and the fact is 
>that the server closes connection to that client too in a "non clean 
>fashion".
>
>Regards and a lot of thanks for your help,

Can you share a minimal example - http://sscce.org/ - that demonstrates 
this behavior?

Jean-Paul


From stefan at grosz.at  Fri May 28 08:35:15 2010
From: stefan at grosz.at (Ing. Stefan Grosz, BSc)
Date: Fri, 28 May 2010 14:35:15 +0200
Subject: [Twisted-web] Deferred in proxy.ProxyClient.handleHeader
Message-ID: <AANLkTimfNHuvUzIhfbzS_aWcErnqO-4rAg-tE7lyyOq0@mail.gmail.com>

hi!

i'm currently writing a reverse proxy with twisted and i've a problem with a
deferred
function in my handleHeader method.

the code looks simplified like this:

class MyProxyClient(proxy.ProxyClient):
@defer.inlineCallbacks
def handleHeader(self, key, value):
if key.lower() == 'location':
clientCreator = protocol.ClientCreator(reactor, Redis, db=3)
redis = yield clientCreator.connectTCP("localhost", 6379)
value = yield redis.get('myproxy:hashcode:%s' % value)
proxy.ProxyClient.handleHeader(self,key,value)


as the handleHeader caller doesn't wait for a deferred to finish, the
location header is
added after handleResponseEnd is already called and therefore never makes it
to the client.

is there a way to convert the non-blocking redis call to a blocking redis
call?
i know that there's a blocking client library for redis but i'd rather use
only txredis if possible.


regards,
  stefan


-- 
Stefan Grosz <stefan at grosz.at>
Stadtausstellungs-, Gemeindeausstellungs-, Stadtinformations- und
Gemeindeinformationsplanungs GmbH
A-1100 Wien, Buchengasse 42
Mobil: +43 650 2643435
Fax: +43 7243 57435

http://www.stadtausstellung.at
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20100528/6afc718f/attachment.htm 

From stefan at grosz.at  Fri May 28 08:47:41 2010
From: stefan at grosz.at (Ing. Stefan Grosz, BSc)
Date: Fri, 28 May 2010 14:47:41 +0200
Subject: [Twisted-web] Deferred in proxy.ProxyClient.handleHeader
	(reformatted)
Message-ID: <BDDBC983-8770-4CD2-9D74-591D423573FE@grosz.at>

hi!

(sorry, the formatting in my last mail got screwed up. hope this time it works)

i'm currently writing a reverse proxy with twisted and i've a problem with a deferred function in my handleHeader method.

the code looks simplified like this (http://pastie.org/981735):

class MyProxyClient(proxy.ProxyClient):
    @defer.inlineCallbacks
    def handleHeader(self, key, value):
        if key.lower() == 'location':
            clientCreator = protocol.ClientCreator(reactor, Redis, db=3)
            redis = yield clientCreator.connectTCP("localhost", 6379)
            value = yield redis.get('myproxy:hashcode:%s' % value)
        proxy.ProxyClient.handleHeader(self,key,value)


as the handleHeader caller doesn't wait for a deferred to finish, the location header is added after handleResponseEnd is already called and therefore never makes it to the client.

is there a way to convert the non-blocking redis call to a blocking redis call?
i know that there's a blocking client library for redis but i'd rather use only txredis if possible.


regards,
  stefan

-- 
Stefan Grosz <stefan at grosz.at>
Stadtaustellungs-, Gemeindeausstellungs-, Stadtinformations- und Gemeindeinformationsplanungs GmbH
A-1100 Wien, Buchengasse 42
Mobil: +43 650 2643435
Fax: +43 7243 57435

http://www.stadtausstellung.at


From exarkun at twistedmatrix.com  Fri May 28 15:09:11 2010
From: exarkun at twistedmatrix.com (exarkun at twistedmatrix.com)
Date: Fri, 28 May 2010 19:09:11 -0000
Subject: [Twisted-web] Deferred in
	proxy.ProxyClient.handleHeader	(reformatted)
In-Reply-To: <BDDBC983-8770-4CD2-9D74-591D423573FE@grosz.at>
References: <BDDBC983-8770-4CD2-9D74-591D423573FE@grosz.at>
Message-ID: <20100528190911.2734.1088925821.divmod.xquotient.36@localhost.localdomain>

On 12:47 pm, stefan at grosz.at wrote:
>hi!
>
>(sorry, the formatting in my last mail got screwed up. hope this time 
>it works)
>
>i'm currently writing a reverse proxy with twisted and i've a problem 
>with a deferred function in my handleHeader method.
>
>the code looks simplified like this (http://pastie.org/981735):
>
>class MyProxyClient(proxy.ProxyClient):
>    @defer.inlineCallbacks
>    def handleHeader(self, key, value):
>        if key.lower() == 'location':
>            clientCreator = protocol.ClientCreator(reactor, Redis, db=3)
>            redis = yield clientCreator.connectTCP("localhost", 6379)
>            value = yield redis.get('myproxy:hashcode:%s' % value)
>        proxy.ProxyClient.handleHeader(self,key,value)
>
>
>as the handleHeader caller doesn't wait for a deferred to finish, the 
>location header is added after handleResponseEnd is already called and 
>therefore never makes it to the client.
>
>is there a way to convert the non-blocking redis call to a blocking 
>redis call?
>i know that there's a blocking client library for redis but i'd rather 
>use only txredis if possible.

The proxy isn't written to deal with what you want to do.  Converting 
the non-blocking call into a blocking one won't fix the problem, it'll 
just change it.

If you want to change the headers that pass through the proxy, you 
probably need to hook in at a different place, where an asynchronous 
operation won't mess things up.

More generally, `twisted.web.proxy` isn't really well suited for a 
rewriting proxy.  It's barely capable of functioning as a boring pass- 
through proxy.  If you'd like to make your application simpler, you 
might want to look at ways to make `twisted.web.proxy` more well suited 
to this task.

Jean-Paul


