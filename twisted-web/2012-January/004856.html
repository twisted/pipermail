<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] twisted.web.template output encoding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20twisted.web.template%20output%20encoding&In-Reply-To=20120103155429.2755.144788169.divmod.xquotient.87%40localhost6.localdomain6">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004854.html">
   <LINK REL="Next"  HREF="004858.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] twisted.web.template output encoding</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20twisted.web.template%20output%20encoding&In-Reply-To=20120103155429.2755.144788169.divmod.xquotient.87%40localhost6.localdomain6"
       TITLE="[Twisted-web] twisted.web.template output encoding">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Jan  4 20:52:24 EST 2012</I>
    <P><UL>
        <LI>Previous message: <A HREF="004854.html">[Twisted-web] twisted.web.template output encoding
</A></li>
        <LI>Next message: <A HREF="004858.html">[Twisted-web] cooperate and keeping data integrity in response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4856">[ date ]</a>
              <a href="thread.html#4856">[ thread ]</a>
              <a href="subject.html#4856">[ subject ]</a>
              <a href="author.html#4856">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Jan 3, 2012, at 10:54 AM, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">exarkun at twistedmatrix.com</A> wrote:

&gt;<i> On 5 Dec 2011, 08:19 pm, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">glyph at twistedmatrix.com</A> wrote:
</I>&gt;&gt;<i> Sorry it took me so long to get to this.  Hopefully it's still relevant 
</I>&gt;&gt;<i> ;).
</I>&gt;<i> 
</I>&gt;<i> Heh.  Heh heh heh.  Heh.
</I>
So it goes ;-).

&gt;&gt;<i> On Nov 26, 2011, at 11:52 AM, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">exarkun at twistedmatrix.com</A> wrote:
</I>&gt;&gt;&gt;<i> Apart from various issues relating to the lack of patterns in 
</I>&gt;&gt;&gt;<i> twisted.web.template,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I had some trepidation about marking 
</I>&gt;&gt;<i> &lt;<A HREF="http://twistedmatrix.com/trac/ticket/5040">http://twistedmatrix.com/trac/ticket/5040</A>&gt; as &quot;closed&quot; :).  What kind 
</I>&gt;&gt;<i> of issues came up with patterns?  Anything you feel needs fixing?
</I>&gt;<i> 
</I>&gt;<i> The approach facilitated by #5040 seems to result in much more 
</I>&gt;<i> boilerplate than the approach facilitated by Nevow's patterns.  The code 
</I>&gt;<i> for #4896 has many, many Elements.  An implementation using Nevow 
</I>&gt;<i> probably would have had far fewer, perhaps only one.
</I>&gt;<i> 
</I>&gt;<i> Which of these is better, I don't know.  I certainly got bored very 
</I>&gt;<i> early on in the #4896 work, though.
</I>
Well, if the approach on #5040 is way more verbose, what does it have in its favor?  Simplicity?  I must imagine that we can get both somehow.

&gt;&gt;&gt;<i> the main difficulty is in handling non-ascii contents in the 
</I>&gt;&gt;&gt;<i> traceback.  Apart from any unicode that may show up in the source code 
</I>&gt;&gt;&gt;<i> being rendered (or, perhaps, eventually, the values of variables to be 
</I>&gt;&gt;&gt;<i> rendered - though for now I do not plan to implement this) the no- 
</I>&gt;&gt;&gt;<i> break space characters which are necessary to get traceback lines 
</I>&gt;&gt;&gt;<i> indented properly mean that there is always some non-ascii to include 
</I>&gt;&gt;&gt;<i> in the output.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Looking at the actual output now, these &amp;nbsp; characters strike me as 
</I>&gt;&gt;<i> an accident of how browsers collapse different types of whitespace. 
</I>&gt;&gt;<i> They could be replaced with a &lt;span style=&quot;width: 4em;&quot; /&gt; to avoid 
</I>&gt;&gt;<i> this problem for now, which is probably more expressive.
</I>&gt;<i> 
</I>&gt;<i> If I understood Jonathan's reply properly, it sounds like the &amp;nbsp; 
</I>&gt;<i> hack is the best we've got.
</I>
I don't _want_ to read Jonathan's reply thoroughly enough to understand it, so I'll have to take your word for it.

&gt;&gt;&gt;<i> twisted.web.template encodes its output using UTF-8, and this is not 
</I>&gt;&gt;&gt;<i> customizable.  Thus, using twisted.web.template, formatFailure's 
</I>&gt;&gt;&gt;<i> result will be a str containing UTF-8 encoded text.  Previously the 
</I>&gt;&gt;&gt;<i> result was a str containing only ASCII encoded text, with no-break 
</I>&gt;&gt;&gt;<i> space represented as `&amp;nbsp;&#180;.  Consequently, callers of 
</I>&gt;&gt;&gt;<i> `formatFailure&#180; will probably mishandle the result - the caller in 
</I>&gt;&gt;&gt;<i> `twisted.web.server&#180; does, at least, including the bytes in a page 
</I>&gt;&gt;&gt;<i> with a content type of &quot;text/html&quot;.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The solutions that come to mind are all about removing this 
</I>&gt;&gt;&gt;<i> incompatible change and making it so `formatFailure&#180; can continue to 
</I>&gt;&gt;&gt;<i> return a str with ASCII-encoded text.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> One solution is to add support for named entities or numeric character 
</I>&gt;&gt;&gt;<i> references to twisted.web.template.  Very likely this is a good idea 
</I>&gt;&gt;&gt;<i> regardless (Nevow supported these).
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I think that this is probably a necessary feature regardless, 
</I>&gt;&gt;<i> eventually.  Did you end up filing a ticket for it?
</I>&gt;<i> 
</I>&gt;<i> Yep, this has been filed and is up for review (for weeks now ;): #5408.
</I>
Great, okay.

&gt;&gt;&gt;<i> Another solution is to use a different encoding in 
</I>&gt;&gt;&gt;<i> `twisted.web.template&#180; - ASCII, with xmlcharrefreplace as the error 
</I>&gt;&gt;&gt;<i> handler.  This is tempting since it avoids an obtrusive non-ASCII 
</I>&gt;&gt;&gt;<i> support API (the way Nevow supports these is via `nevow.entities&#180;, 
</I>&gt;&gt;&gt;<i> which must be used rather than normal Python unicode objects).
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I like this idea, because it's so hard to get wrong even if you have 
</I>&gt;&gt;<i> other problems (missing charset, buggy proxies, overly aggressive 
</I>&gt;&gt;<i> encoding detection, etc).  We can still say it's UTF-8 but it will work 
</I>&gt;&gt;<i> anywhere ASCII will work :).
</I>&gt;&gt;&gt;<i> Perhaps another question is whether the encoding used by 
</I>&gt;&gt;&gt;<i> `twisted.web.template&#180; should be a parameter.  A related question 
</I>&gt;&gt;&gt;<i> raised might be whether `twisted.web.template&#180; should encoded to bytes 
</I>&gt;&gt;&gt;<i> at all, or delegate the responsibility for that to code closer to a 
</I>&gt;&gt;&gt;<i> socket.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Personal experience looking at profiles of applications which serialize 
</I>&gt;&gt;<i> a lot of XML suggests to me that encoding and decoding text in Python 
</I>&gt;&gt;<i> is a huge chunk of CPU work and memory footprint; keeping the encoding 
</I>&gt;&gt;<i> in t.w.t provides an opportunity for a potentially important 
</I>&gt;&gt;<i> optimization which might not be possible if it were done closer to the 
</I>&gt;&gt;<i> socket.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> For example, if we're generating a long table that generates 10MB of 
</I>&gt;&gt;<i> HTML, if this is encoded incrementally (even foregoing any smarter 
</I>&gt;&gt;<i> optimizations, like caching the encoded form of strings) then there's a 
</I>&gt;&gt;<i> small working set of encoded data which can be collected as the 
</I>&gt;&gt;<i> template renders, and by the time the final string is emitted by 
</I>&gt;&gt;<i> cStringIO.getvalue() or what have you, you're using 20-ish megabytes of 
</I>&gt;&gt;<i> heap to store your UTF-8 bytes (10 in the StringIO and 10 in the str). 
</I>&gt;&gt;<i> If you build this as a unicode string instead, you'll end up using 
</I>&gt;&gt;<i> 50MB; 40MB for your unicode string, 10MB for the decoded bytes.  Part 
</I>&gt;&gt;<i> of this is just an implementation issue, but even if Python gets a 
</I>&gt;&gt;<i> smarter unicode representation, you still need more space, because you 
</I>&gt;&gt;<i> need to store the encoded and decoded representations concurrently.
</I>&gt;<i> 
</I>&gt;<i> This all seems to suppose the non-existence of the 
</I>&gt;<i> twisted.web.template.flatten
</I>&gt;<i> style interface.  Doesn't that give you what's needed to do your 
</I>&gt;<i> incremental encoding outside of the flattener?
</I>
Hmmmmmm.  Okay, generating a couple of short encoded strings does leave one with a much shorter working set.  There should definitely be a lot more convenience functions in this area to just do the right thing in the various contexts one might want to flatten something (for which there are already a few tickets, such as &lt;<A HREF="http://tm.tl/5395">http://tm.tl/5395</A>&gt;).  As I recall you've spoken against the flatten() style interface because it makes error-handling somewhat more challenging, but if #5395 were fixed it could take care of those complexities internally.

&gt;&gt;<i> It might be a while until I get around to implementing something smart 
</I>&gt;&gt;<i> in this area, but I'd prefer we have an interface that makes such 
</I>&gt;&gt;<i> optimizations possible without breaking compatibility.
</I>&gt;&gt;&gt;<i> As a work-around in `formatFailure&#180; I can decode the output of the 
</I>&gt;&gt;&gt;<i> flattener using UTF-8 and then re-encode it to avoid non-ASCII, but it 
</I>&gt;&gt;&gt;<i> seems like this should be solved in `twisted.web.template&#180; rather than 
</I>&gt;&gt;&gt;<i> over and over again in application code.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> If this does end up happening in formatFailure or anywhere else, please 
</I>&gt;&gt;<i> (whoever does it) make sure to file a ticket to fix it; this should 
</I>&gt;&gt;<i> never be more than a temporary workaround.
</I>&gt;<i> 
</I>&gt;<i> Okay.  #4896 is still up for review, and the branch implementing it does 
</I>&gt;<i> use the decode/encode hack.  I'll file a ticket for fixing that if I 
</I>&gt;<i> ever get to merge the branch (someone review it please).
</I>
Why not just file the ticket now?  As you said before: &quot;Heh.  Heh heh heh.  Heh.&quot;  It might be a while before sufficient review bandwidth becomes available.  (If history is any indicator, things will stall out between now and February, and March will be crazily active.)

-glyph


</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004854.html">[Twisted-web] twisted.web.template output encoding
</A></li>
	<LI>Next message: <A HREF="004858.html">[Twisted-web] cooperate and keeping data integrity in response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4856">[ date ]</a>
              <a href="thread.html#4856">[ thread ]</a>
              <a href="subject.html#4856">[ subject ]</a>
              <a href="author.html#4856">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
