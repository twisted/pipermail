<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Lingering HTTP Channel in web2 when testing with trial
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Lingering%20HTTP%20Channel%20in%20web2%20when%20testing%20with%20trial&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002552.html">
   <LINK REL="Next"  HREF="002554.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Lingering HTTP Channel in web2 when testing with trial</H1>
    <B>Henrik Thostrup Jensen</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Lingering%20HTTP%20Channel%20in%20web2%20when%20testing%20with%20trial&In-Reply-To="
       TITLE="[Twisted-web] Lingering HTTP Channel in web2 when testing with trial">thostrup at gmail.com
       </A><BR>
    <I>Mon Mar 13 04:16:00 CST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002552.html">[Twisted-web] Error using getPage
</A></li>
        <LI>Next message: <A HREF="002554.html">[Twisted-web] Re: Lingering HTTP Channel in web2 when testing with
	trial
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2553">[ date ]</a>
              <a href="thread.html#2553">[ thread ]</a>
              <a href="subject.html#2553">[ subject ]</a>
              <a href="author.html#2553">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

I have an application which uses web2. In good twisted style I'm writing
tests for it, and using trial.

When performing some rather simple page retrievals a get a lingering http
channel. Setting
twisted.internet.base.DelayedCall.debug = True
I get this trace:


  File &quot;/usr/lib/python2.4/site-packages/twisted/trial/util.py&quot;, line 131,
in _dispatch
    getattr(self, &quot;do_%s&quot; % attr)()
  File &quot;/usr/lib/python2.4/site-packages/twisted/trial/util.py&quot;, line 173,
in do_cleanPending
    raise PendingTimedCallsError(s)
twisted.trial.util.PendingTimedCallsError: pendingTimedCalls still pending
(consider setting twisted.internet.base.DelayedCall.debug = True):
&lt;DelayedCall 1083946540 [19.9427890778s] called=0 cancelled=0
HTTPChannel._lingerClose()

traceback at creation:

  File &quot;/usr/bin/trial&quot;, line 24, in ?
    run()
      File &quot;/usr/lib/python2.4/site-packages/twisted/scripts/trial.py&quot;, line
676, in run
    suite = reallyRun(config)
      File &quot;/usr/lib/python2.4/site-packages/twisted/scripts/trial.py&quot;, line
657, in reallyRun
    suite.run(config['random'])
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&quot;, line
250, in run
    tr.runTests(randomize=(seed is not None))
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&quot;, line
496, in runTests
    runner.runTests(randomize)
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&quot;, line
601, in runTests
    self._apply(_runTestMethod)
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&quot;, line
543, in _apply
    f(tm)
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&quot;, line
597, in _runTestMethod
    testMethod.run(tci)
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&quot;, line
849, in run
    orig(tci)
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&quot;, line
332, in __call__
    lambda :util.wait(defer.maybeDeferred(self.original, *a, **kw),
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&quot;, line
409, in _runWithWarningFilters
    return f(*a, **kw)
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&quot;, line
333, in &lt;lambda&gt;
    timeout, useWaitError=True))
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/util.py&quot;, line
325, in wait
    r = _Wait.wait(d, timeout)
      File &quot;/usr/lib/python2.4/site-packages/twisted/trial/util.py&quot;, line
269, in wait
    reactor.iterate(0.01)
      File &quot;/usr/lib/python2.4/site-packages/twisted/internet/base.py&quot;, line
360, in iterate
    self.doIteration(delay)
      File
&quot;/usr/lib/python2.4/site-packages/twisted/internet/selectreactor.py&quot;, line
133, in doSelect
    _logrun(selectable, _drdw, selectable, method, dict)
      File &quot;/usr/lib/python2.4/site-packages/twisted/python/log.py&quot;, line
56, in callWithLogger
    return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
      File &quot;/usr/lib/python2.4/site-packages/twisted/python/log.py&quot;, line
41, in callWithContext
    return context.call({ILogContext: newCtx}, func, *args, **kw)
      File &quot;/usr/lib/python2.4/site-packages/twisted/python/context.py&quot;,
line 52, in callWithContext
    return self.currentContext().callWithContext(ctx, func, *args, **kw)
      File &quot;/usr/lib/python2.4/site-packages/twisted/python/context.py&quot;,
line 31, in callWithContext
    return func(*args,**kw)
      File
&quot;/usr/lib/python2.4/site-packages/twisted/internet/selectreactor.py&quot;, line
139, in _doReadOrWrite
    why = getattr(selectable, method)()
      File &quot;/usr/lib/python2.4/site-packages/twisted/internet/abstract.py&quot;,
line 134, in doWrite
    result = self._closeWriteConnection()
      File &quot;/usr/lib/python2.4/site-packages/twisted/internet/tcp.py&quot;, line
376, in _closeWriteConnection
    p.writeConnectionLost()
      File &quot;/usr/lib/python2.4/site-packages/twisted/web2/channel/http.py&quot;,
line 788, in writeConnectionLost
    self._lingerTimer = reactor.callLater(20, self._lingerClose)
&gt;<i>
</I>
This if course makes sense, especially if the server lost its connection. I
am doing cleanup in tearDown (calling stopListening() on the port), but
trial still complains. Canceling the call, and calling it manually in
tearDown, doesn't appear to help either. How do I make it shut it up in a
proper way?


PS. I'm rather pleased with the web2 framework, especially the stream
framework (once I got my head wrapped around it), but it is hard to get an
overview of the internals. A brief description of the design, philosophy,
what was wrong with web(1), etc. would be very nice (I do realize that web2
is a moving target).

--
   - Henrik
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20060313/16680bea/attachment.htm">http://twistedmatrix.com/pipermail/twisted-web/attachments/20060313/16680bea/attachment.htm</A>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002552.html">[Twisted-web] Error using getPage
</A></li>
	<LI>Next message: <A HREF="002554.html">[Twisted-web] Re: Lingering HTTP Channel in web2 when testing with
	trial
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2553">[ date ]</a>
              <a href="thread.html#2553">[ thread ]</a>
              <a href="subject.html#2553">[ subject ]</a>
              <a href="author.html#2553">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
