<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Deferred fun
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Deferred%20fun&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002335.html">
   <LINK REL="Next"  HREF="002315.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Deferred fun</H1>
    <B>James R. Saker Jr.</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Deferred%20fun&In-Reply-To="
       TITLE="[Twisted-web] Deferred fun">cso at netcenturion.biz
       </A><BR>
    <I>Mon Jan 16 18:56:14 MST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002335.html">[Twisted-web] Good ROM tool ?
</A></li>
        <LI>Next message: <A HREF="002315.html">[Twisted-web] Deferred fun
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2314">[ date ]</a>
              <a href="thread.html#2314">[ thread ]</a>
              <a href="subject.html#2314">[ subject ]</a>
              <a href="author.html#2314">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Per new years resolution 'I will learn how to use deferreds in twisted', I've 
got a little puzzle in an xmlrpc remote nmap tool that I put together to try 
to learn deferreds (as well as automate scans on my firewall from outside my 
net), figuring the speed of nmap returning the results of a scan can be 
excessively long and should make for a good deferred experiment. Except I 
keep hitting an AssertionError and think it may have to do with what happens 
to my deferred when it completes:

#!/usr/bin/python
&quot;&quot;&quot;
pyrscand.py
Python remote scanner: Nmap XML-RPC module for processing scan requests from a 
remote host
&quot;&quot;&quot;
import os
from twisted.internet import defer
from twisted.web import xmlrpc, server

NMAP_PATH = '/usr/bin/nmap' # location of nmap binary on host

class ScanServer(xmlrpc.XMLRPC):
    &quot;&quot;&quot;
    XMLRPC server for remote scan processing
    &quot;&quot;&quot;

    def handleScan(self, type, ip, detectOS, timing):
	&quot;&quot;&quot;
	Simplistic scans only for now!
	&quot;&quot;&quot;
        result = ''
        print &quot;running scanner...&quot;
        scandata = os.popen('%s -%s -A -T%s %s -oX -' % \
            (NMAP_PATH, type, timing, ip), 'r')
        for line in scandata:
            result += line  # return xml in a string - not a list object
        print &quot;got result: \n%s&quot; % result
        return result

    def handleFailure(self, f):
        print &quot;errback&quot;
        print &quot;we got an exception: %s&quot; % (f.getTraceback(),)
        f.trap(RuntimeError)
        return 'Error'
        
    def xmlrpc_scan(self, type, ip, detectOS, timing):
        &quot;&quot;&quot;
        Inputs: type (sS, sT, sP), ip, detectOS flag, timing performance (0-5)
        Outputs: XML formatted report value compliant with nmap schema
        &quot;&quot;&quot;
        print &quot;scanner&quot;
        d = defer.Deferred()
        d.addCallback(self.handleScan(type, ip, detectOS, timing))
        d.addErrback(self.handleFailure)
    
if __name__ == '__main__':
    from twisted.internet import reactor
    r = ScanServer()
    reactor.listenTCP(7080, server.Site(r))
    reactor.run()


Running it actually shows the nmap xml output is returned to handleScan but 
from there we hit an AssertionError:

Traceback (most recent call last):
  File &quot;/usr/lib/python2.4/site-packages/twisted/web/http.py&quot;, line 557, in 
requestReceived
    self.process()
  File &quot;/usr/lib/python2.4/site-packages/twisted/web/server.py&quot;, line 153, in 
process
    self.render(resrc)
  File &quot;/usr/lib/python2.4/site-packages/twisted/web/server.py&quot;, line 160, in 
render
    body = resrc.render(self)
  File &quot;/usr/lib/python2.4/site-packages/twisted/web/xmlrpc.py&quot;, line 118, in 
render
    defer.maybeDeferred(function, *args).addErrback(
--- &lt;exception caught here&gt; ---
  File &quot;/usr/lib/python2.4/site-packages/twisted/internet/defer.py&quot;, line 107, 
in maybeDeferred
    result = f(*args, **kw)
  File &quot;pyrscand.py&quot;, line 39, in xmlrpc_scan
    d.addCallback(self.handleScan(type, ip, detectOS, timing))
  File &quot;/usr/lib/python2.4/site-packages/twisted/internet/defer.py&quot;, line 191, 
in addCallback
    callbackKeywords=kw)
  File &quot;/usr/lib/python2.4/site-packages/twisted/internet/defer.py&quot;, line 175, 
in addCallbacks
    assert callable(callback)
exceptions.AssertionError:

My xmlrpc client is pretty short and taken directly from online howto:

from twisted.web.xmlrpc import Proxy
from twisted.internet import reactor

def printValue(value):
    print repr(value)
    reactor.stop()

def printError(error):
    print 'error', error
    reactor.stop()

proxy = Proxy('<A HREF="http://localhost:7080/XMLRPC'">http://localhost:7080/XMLRPC'</A>)
proxy.callRemote('scan', 'sP', '69.63.110.1',\ 		
				1, 5).addCallbacks(printValue,printError)
reactor.run()


Any thoughts would be greatly appreciated -


Jamie

</PRE>



























































<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002335.html">[Twisted-web] Good ROM tool ?
</A></li>
	<LI>Next message: <A HREF="002315.html">[Twisted-web] Deferred fun
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2314">[ date ]</a>
              <a href="thread.html#2314">[ thread ]</a>
              <a href="subject.html#2314">[ subject ]</a>
              <a href="author.html#2314">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
