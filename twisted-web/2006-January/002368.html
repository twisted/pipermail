<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Cheetah+twisted.web2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Cheetah%2Btwisted.web2&In-Reply-To=20060119125226.GI19010%40opteron.random">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002365.html">
   <LINK REL="Next"  HREF="002373.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Cheetah+twisted.web2</H1>
    <B>David Reid</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Cheetah%2Btwisted.web2&In-Reply-To=20060119125226.GI19010%40opteron.random"
       TITLE="[Twisted-web] Cheetah+twisted.web2">dreid at dreid.org
       </A><BR>
    <I>Thu Jan 19 10:24:01 MST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002365.html">[Twisted-web] Cheetah+twisted.web2
</A></li>
        <LI>Next message: <A HREF="002373.html">[Twisted-web] Cheetah+twisted.web2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2368">[ date ]</a>
              <a href="thread.html#2368">[ thread ]</a>
              <a href="subject.html#2368">[ subject ]</a>
              <a href="author.html#2368">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Andrea Arcangeli wrote:
&gt;<i> This fixes one logging bug:
</I>
Thanks


&gt;<i> 1) the web2.vhost seems buggy not fixing up the req.uri, I had to fixup
</I>&gt;<i> req.uri to get logging right in my vhost hack that understand the
</I>&gt;<i> twisted.web reverse proxy with clientPass=True (my old twisted.web patch)
</I>
Judging from the way Request actually deals with .uri it should be _uri, 
I'll discuss this with foom and fix it later.

&gt;<i> 2) assuming that I had web2 on the reverse proxy, would it already pass
</I>&gt;<i> down the remote_ip information, or only apache2 does that? (the only one
</I>&gt;<i> capable of receiving the remote_ip is AutoVHostURIRewrite, but the
</I>&gt;<i> deployment only talks about apache2, Also note for me it's fundamentally
</I>&gt;<i> important for security reasons to have the port too, one needs the port
</I>&gt;<i> to safely indentify a box behind a nat (assuming the nat admin is
</I>&gt;<i> capable of logging all connection tracking but if he doesn't he will
</I>&gt;<i> take the blame). Is the apache2/twisted.web2 reverseproxy protocol
</I>&gt;<i> passing down the peer port too in the x-forwarded-host?
</I>
As far as I know twisted.web.proxy.ReverseProxyResource doesn't send 
X-Forwarded-For.  I don't think Apache2 sends the port.  I'm not sure 
what to do about this other than subclass and fix, it seems like a 
pretty special case to me, perhaps security would be better provided 
through another means, because as you said, it only works if the 
connection tracking is logged.  Which most SOHO devices don't do.

&gt;<i> 3) if answer to 2 is no, can I forward port to web2 my simple hack to
</I>&gt;<i> twisted.web that I need in order to plug klive on top twisted.web2?
</I>
Twisted.web2 is backwards compatible, in that it knows what a 
twisted.web resource expects, and is capable of translating them from 
what Twisted.web2 uses (see twisted.web2.compat)  You should be able to 
just drop that exact ReverseProxyResource into a twisted.web2 tree and 
have it work.  (While you're at it you might as well patch it to send 
the client via X-Forwarded-For (and send the other headers 
AutoURIRewrite expects while you're at it))

&gt;<i> Here for reference my old patch that is running on cpushare.com today
</I>&gt;<i> and that my web2 vhost hack is understanding and that passes down to
</I>&gt;<i> klive both ip and port (setClient was actually used by the nevow.vhost,
</I>&gt;<i> now obsoleted by web2 req.remoteAddr)
</I>
I'm not sure if tacking a :port onto the X-Forwarded-For header will 
break other http servers.

&gt;<i> One more question, you said the channel is private, why don't we add __
</I>&gt;<i> in front of it. Python is capable of autodocumenting without possibility
</I>&gt;<i> for mistakes all private parts of a class.
</I>
Send me a patch (on or offlist) that changes chanRequest to _chanRequest[1]

--David

[1] See twisted coding standards: 
<A HREF="http://twistedmatrix.com/projects/core/documentation/howto/policy/coding-standard.html">http://twistedmatrix.com/projects/core/documentation/howto/policy/coding-standard.html</A>



</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002365.html">[Twisted-web] Cheetah+twisted.web2
</A></li>
	<LI>Next message: <A HREF="002373.html">[Twisted-web] Cheetah+twisted.web2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2368">[ date ]</a>
              <a href="thread.html#2368">[ thread ]</a>
              <a href="subject.html#2368">[ subject ]</a>
              <a href="author.html#2368">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
