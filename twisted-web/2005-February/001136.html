<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] html cache with timeout
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20html%20cache%20with%20timeout&In-Reply-To=20050201190957.GA8446%40opteron.random">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001135.html">
   <LINK REL="Next"  HREF="001137.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] html cache with timeout</H1>
    <B>Valentino Volonghi aka Dialtone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20html%20cache%20with%20timeout&In-Reply-To=20050201190957.GA8446%40opteron.random"
       TITLE="[Twisted-web] html cache with timeout">dialtone at divmod.com
       </A><BR>
    <I>Tue Feb  1 13:02:27 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001135.html">[Twisted-web] html cache with timeout
</A></li>
        <LI>Next message: <A HREF="001137.html">[Twisted-web] html cache with timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1136">[ date ]</a>
              <a href="thread.html#1136">[ thread ]</a>
              <a href="subject.html#1136">[ subject ]</a>
              <a href="author.html#1136">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 1 Feb 2005 20:09:57 +0100, Andrea Arcangeli &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">andrea at cpushare.com</A>&gt; wrote:
&gt;<i> &gt; Anyway the patch is below:
</I>&gt;<i> 
</I>&gt;<i> Looks a great start.
</I>&gt;<i> 
</I>&gt;<i> I'll give it a spin overnight to see what happens.
</I>&gt;<i> 
</I>&gt;<i> &gt; +_CACHE = {}
</I>&gt;<i> 
</I>&gt;<i> Shouldn't this be stored in the respective classes?
</I>
There are MANY ideas on where to put this _CACHE.
jamwt volunteered for writing a memcache like <A HREF="http://www.danga.com/memcached/">http://www.danga.com/memcached/</A>
Which will probably be one of the backends. 

There are also other problems to solve about this cache, but it is working with this patch (that is now committed in the caching branch) and people can test it or provide  different behaviours.

&gt;<i> &gt; +def CachedSerializer(original, context):
</I>&gt;<i> &gt; +    cached = _CACHE.get(original.name, None)
</I>&gt;<i> &gt; +    life = now()-original.lifetime
</I>&gt;<i> 
</I>&gt;<i> Can we execute only one single gettimeofday? gettimeofday is one of the
</I>&gt;<i> biggest kernel costs of twisted in general (modulo poll). I will deploy
</I>&gt;<i> initially on x86 (on x86-64 with vsyscalls gettimeofday is zerocost).
</I>&gt;<i> 
</I>&gt;<i> Could you also keep it similar to my patch where a timeout &lt;= 0 means
</I>&gt;<i> &quot;cache forever&quot;?
</I>
Yep, this is just a first attempt. Further work will be done on the caching branch.

&gt;<i> &gt; +    if cached and cached[0] &gt; life:
</I>&gt;<i> &gt; +##         print &quot;=&quot;*20
</I>&gt;<i> &gt; +##         print cached[0]
</I>&gt;<i> &gt; +##         print life
</I>&gt;<i> &gt; +##         print &quot;=&quot;*20        
</I>&gt;<i> &gt; +        yield cached[1]
</I>&gt;<i> &gt; +        return
</I>&gt;<i> 
</I>&gt;<i> Why yield if you return immediatly? Why not return cached[1]?
</I>
Try it yourself :)

In python you cannot have a return statement with arguments when inside a generator.
CachedSerializer is in fact a generator (because of the yield keyword inside the func body) and can't have a return statement with arguments.

&gt;<i> &gt; +    _CACHE[original.name] = (now(), result)
</I>&gt;<i> 
</I>&gt;<i> what is contained in original.name? How to identify exactly which object
</I>&gt;<i> is being cached? (just to understand how should I use this exactly)
</I>
original name is the first argument of the tag instance.

t.cached(name=&quot;foobar&quot;)

this will create an empty cached tag with name foobar, you can also do:

t.cached(name=(IFoo, IBar)) 

as was suggested if you need. No check is done on the type of name but it must be hashable.

&gt;<i> Do I understand correctly this more finegriend cache doesn't obsolete
</I>&gt;<i> the other cache?
</I>
I think it does and will surely do if someone will write the flatsax stuff to use it with xhtml templates.

with stan you can do:

    docFatory = loaders.stan(t.cached(name=&quot;MainPage&quot;, lifetime=10)[t.html[....]])

Which will do the same thing as the first ancient patch. I also get similar performances with the new patch: 26 req/sec and it shouldn't be any slower.
 
&gt;<i> The other cache is probably the fastest we can get, and it pretty much
</I>&gt;<i> solves my problem for the high traffic part.
</I>
I still think 250 req/sec are too much. Are you sure that is not the redirect page in guard?
 
&gt;<i> PS. Still I would like to see compy removed, since not everything will
</I>&gt;<i> be cached. There are parts where I will not cache anything.
</I>
I've talked to dp and he said that compy will be there only to not depend on twisted but it will definately directly use zope.interface if present.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001135.html">[Twisted-web] html cache with timeout
</A></li>
	<LI>Next message: <A HREF="001137.html">[Twisted-web] html cache with timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1136">[ date ]</a>
              <a href="thread.html#1136">[ thread ]</a>
              <a href="subject.html#1136">[ subject ]</a>
              <a href="author.html#1136">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
