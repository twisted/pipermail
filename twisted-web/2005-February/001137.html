<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] html cache with timeout
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20html%20cache%20with%20timeout&In-Reply-To=20050201200227.21318.1114589713.divmod.quotient.93%40ohm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001136.html">
   <LINK REL="Next"  HREF="001138.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] html cache with timeout</H1>
    <B>Andrea Arcangeli</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20html%20cache%20with%20timeout&In-Reply-To=20050201200227.21318.1114589713.divmod.quotient.93%40ohm"
       TITLE="[Twisted-web] html cache with timeout">andrea at cpushare.com
       </A><BR>
    <I>Tue Feb  1 19:48:40 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001136.html">[Twisted-web] html cache with timeout
</A></li>
        <LI>Next message: <A HREF="001138.html">[Twisted-web] Re: html cache with timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1137">[ date ]</a>
              <a href="thread.html#1137">[ thread ]</a>
              <a href="subject.html#1137">[ subject ]</a>
              <a href="author.html#1137">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Feb 01, 2005 at 08:02:27PM +0000, Valentino Volonghi wrote:
&gt;<i> On Tue, 1 Feb 2005 20:09:57 +0100, Andrea Arcangeli &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">andrea at cpushare.com</A>&gt; wrote:
</I>&gt;<i> &gt; &gt; Anyway the patch is below:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Looks a great start.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'll give it a spin overnight to see what happens.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt; +_CACHE = {}
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Shouldn't this be stored in the respective classes?
</I>&gt;<i> 
</I>&gt;<i> There are MANY ideas on where to put this _CACHE.
</I>&gt;<i> jamwt volunteered for writing a memcache like <A HREF="http://www.danga.com/memcached/">http://www.danga.com/memcached/</A>
</I>&gt;<i> Which will probably be one of the backends. 
</I>
Is that a separate task? One of the benefits of having cache inside the
python VM that runs the webserver is no context switches and no inter
process communication. So I'm not very excited about caching outside
nevow ;)

&gt;<i> In python you cannot have a return statement with arguments when
</I>&gt;<i> inside a generator.  CachedSerializer is in fact a generator (because
</I>&gt;<i> of the yield keyword inside the func body) and can't have a return
</I>&gt;<i> statement with arguments.
</I>
Didn't know about that...

&gt;<i> &gt; &gt; +    _CACHE[original.name] = (now(), result)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; what is contained in original.name? How to identify exactly which object
</I>&gt;<i> &gt; is being cached? (just to understand how should I use this exactly)
</I>&gt;<i> 
</I>&gt;<i> original name is the first argument of the tag instance.
</I>&gt;<i> 
</I>&gt;<i> t.cached(name=&quot;foobar&quot;)
</I>&gt;<i> 
</I>&gt;<i> this will create an empty cached tag with name foobar, you can also do:
</I>&gt;<i> 
</I>&gt;<i> t.cached(name=(IFoo, IBar)) 
</I>&gt;<i> 
</I>&gt;<i> as was suggested if you need. No check is done on the type of name but it must be hashable.
</I>
Ok, so it's up to me to avoid collisions, it's not like the more
lowlevel cache where the url was picked automatically.

&gt;<i> &gt; Do I understand correctly this more finegriend cache doesn't obsolete
</I>&gt;<i> &gt; the other cache?
</I>&gt;<i> 
</I>&gt;<i> I think it does and will surely do if someone will write the flatsax stuff to use it with xhtml templates.
</I>&gt;<i> 
</I>&gt;<i> with stan you can do:
</I>&gt;<i> 
</I>&gt;<i>     docFatory = loaders.stan(t.cached(name=&quot;MainPage&quot;, lifetime=10)[t.html[....]])
</I>&gt;<i> 
</I>&gt;<i> Which will do the same thing as the first ancient patch. I also get
</I>&gt;<i> similar performances with the new patch: 26 req/sec and it shouldn't
</I>&gt;<i> be any slower.
</I>
All my pages are using xml (except for the forms that come from
formless), so I'd need the cache for xml templates too.

But I really liked the caching using URL, I don't want having to write
name=&quot;something&quot; by hand.

&gt;<i> &gt; The other cache is probably the fastest we can get, and it pretty much
</I>&gt;<i> &gt; solves my problem for the high traffic part.
</I>&gt;<i> 
</I>&gt;<i> I still think 250 req/sec are too much. Are you sure that is not the redirect page in guard?
</I>
There's no guard (I know the issue with the guard redirect), I get 200
req/sec just fine (over loopback, it goes down to 180req/sec with
ethernet in the middle).

I cannot easily evalute if your same approach for xml is going to work
at the same speed of the httprendering, but for sure I don't want having
to write name=&quot;xxx&quot; by hand. So for now I stick with the cache in the
httprendering that guarantees me no cpu bottleneck until 200req/sec.

The httprender cache is so easy to use and so efficient and gets
automatically right the whole http site, that it doesn't worth for me to
even think at messing things up and convert stuff to the new method,
even if only because I'd need to choose the index of the hash by hand
(and even assuming it has the same performance). So I'd still suggest to
apply that patch to the trunk. Not everyone will want to use the more
finegrined caches, for dynamic but mostly static data, the httprender
cache is just ideal.

For the SSL site where I cannot use the httprender cache at all, I'll
need the xml loader caching or the fragments, since I only used xml fragments.

But I suspect this stan cache could already solve all the forms
rendering if I do something like tags.cached(..)[webform.renderForms()],
I'm going to try it in a few minutes ;). If I can optimize the forms
with this cache it'll be great.

&gt;<i> I've talked to dp and he said that compy will be there only to not
</I>&gt;<i> depend on twisted but it will definately directly use zope.interface
</I>&gt;<i> if present.
</I>
Ok great news! Thanks ;)

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001136.html">[Twisted-web] html cache with timeout
</A></li>
	<LI>Next message: <A HREF="001138.html">[Twisted-web] Re: html cache with timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1137">[ date ]</a>
              <a href="thread.html#1137">[ thread ]</a>
              <a href="subject.html#1137">[ subject ]</a>
              <a href="author.html#1137">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
