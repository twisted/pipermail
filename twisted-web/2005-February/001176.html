<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Encoding bug in Safari's XMLHttpRequest
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Encoding%20bug%20in%20Safari%27s%20XMLHttpRequest&In-Reply-To=baef06200c8b2a03dc8ad0789d8c91d4%40ulaluma.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001168.html">
   <LINK REL="Next"  HREF="001170.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Encoding bug in Safari's XMLHttpRequest</H1>
    <B>David Remahl</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Encoding%20bug%20in%20Safari%27s%20XMLHttpRequest&In-Reply-To=baef06200c8b2a03dc8ad0789d8c91d4%40ulaluma.com"
       TITLE="[Twisted-web] Encoding bug in Safari's XMLHttpRequest">chmod007 at gmail.com
       </A><BR>
    <I>Sat Feb 12 23:24:39 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001168.html">[Twisted-web] Encoding bug in Safari's XMLHttpRequest
</A></li>
        <LI>Next message: <A HREF="001170.html">[Twisted-web] generating Canvas.swf without needing Flash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1176">[ date ]</a>
              <a href="thread.html#1176">[ thread ]</a>
              <a href="subject.html#1176">[ subject ]</a>
              <a href="author.html#1176">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 11 Feb 2005 13:53:50 -0800, Donovan Preston &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">dp at ulaluma.com</A>&gt; wrote:
&gt;<i> 
</I>&gt;<i> +1 on this; liveevil.js should abstract all of these problems away from
</I>&gt;<i> the developer. If nobody else generates a patch, I will do one in the
</I>&gt;<i> manner which James suggests some weekend soon.
</I>&gt;<i> 
</I>&gt;<i> dp
</I>
I've created a patch now. The problem turned out to be rather more
difficult than originally anticipated. I chose to go with the &quot;magic&quot;
method suggested by James.

The first time nevow_liveOutput is requested, a second argument is
passed. magicEcho is the URI encoded version of &quot;\u9b54\u8853&quot;
(Japanese for &quot;magic&quot;, clever huh? ;-). nevow_liveOutput prefixes its
reply with magicEcho. No extra roundtrips, and very little overhead
since the magic is passed only on the first liveOutput query.

The problems started when I realized that AppleWebKit does not simply
interpret each byte in the stream as \xXX. The encoding it defaults to
is not iso-8859-1, it is windows latin-1 (including cp1252). This
means that for example \x91 becomes \u2018 (left single quotation
mark).

I ended up creating a lookup table for going back to something
resembling the original stream (which could then be passed to
from_utf8). Unfortunately five bytes map to the same character, namely
\ufffd (undefined) (\x81, \x8d, \x8f, \x90 and \x9d). This makes it
impossible to perfectly reconstruct the original stream if it
contained one of those bytes. This affects roughly 10% of unicode
characters smaller than 0x10000.

In any case, allowing Safari to process 90% of all characters is
better than getting erroneous output for 99.9% of them...

The only other workaround I can think of is for the client to request
a re-send of the latest message in some 7-bit encoded form (base64 or
something like that). The advantage is that the interpretation would
always be accurate and that we don't have to include the cp1252
conversion table. Disadvantages include that it requires the server to
remember the latest message, that it requires an extra xmlhttprequest
round trip, that it is relatively space inefficient and that
liveevil.js would have to include a base64 decoding function on top of
from_utf8(). Magic would still be required to determine whether a
re-transmission is necessary (i.e. if the JS implementation is buggy).

Does this seem like a reasonable compromise? If so, I'll clean up the
patch, create some unit tests and submit it for consideration.

/ Sincerely, David Remahl

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001168.html">[Twisted-web] Encoding bug in Safari's XMLHttpRequest
</A></li>
	<LI>Next message: <A HREF="001170.html">[Twisted-web] generating Canvas.swf without needing Flash
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1176">[ date ]</a>
              <a href="thread.html#1176">[ thread ]</a>
              <a href="subject.html#1176">[ subject ]</a>
              <a href="author.html#1176">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
