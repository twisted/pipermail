<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] How can I change the HTTP request to avoid gzip
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20How%20can%20I%20change%20the%20HTTP%20request%20to%20avoid%20gzip&In-Reply-To=20081216122056.20272.1291122364.divmod.quotient.21756%40ohm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004035.html">
   <LINK REL="Next"  HREF="004037.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] How can I change the HTTP request to avoid gzip</H1>
    <B>Radu Dragusin</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20How%20can%20I%20change%20the%20HTTP%20request%20to%20avoid%20gzip&In-Reply-To=20081216122056.20272.1291122364.divmod.quotient.21756%40ohm"
       TITLE="[Twisted-web] How can I change the HTTP request to avoid gzip">radudragusin at gmail.com
       </A><BR>
    <I>Tue Dec 16 08:57:18 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="004035.html">[Twisted-web] How can I change the HTTP request to avoid gzip
</A></li>
        <LI>Next message: <A HREF="004037.html">[Twisted-web] How can I change the HTTP request to avoid gzip
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4036">[ date ]</a>
              <a href="thread.html#4036">[ thread ]</a>
              <a href="subject.html#4036">[ subject ]</a>
              <a href="author.html#4036">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, Dec 16, 2008 at 2:20 PM, Jean-Paul Calderone &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">exarkun at divmod.com</A>&gt;wr=
ote:

&gt;<i> On Tue, 16 Dec 2008 05:31:45 +0200, Radu Dragusin &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">radudragusin at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I have a HTTP Proxy made with twisted.web and want to change the request
</I>&gt;&gt;<i> that the browser sends to the Proxy such that I erase the value of the
</I>&gt;&gt;<i> 'accept-encoding' key from 'gzip,deflate' to ' '.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I use the example from the Tisted Book:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> By adding the overriden process method in WordCountProxyRequest I can get
</I>&gt;&gt;<i> the request header but have found no way to set a key, value pair.
</I>&gt;&gt;<i> I want make the server think that the browser does not support gzip
</I>&gt;&gt;<i> because
</I>&gt;&gt;<i> twisted seems to not support gzip as the response from www.google.com and
</I>&gt;&gt;<i> many (but not all) sites appears still encoded. www.dpreview.com seems
</I>&gt;&gt;<i> not
</I>&gt;&gt;<i> to gzip the response, and so the resonse is processed correctly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What can I do to either correctly decode gzip responses or modify the
</I>&gt;&gt;<i> 'accept-encoding' value to nothing so the server does not compress the
</I>&gt;&gt;<i> response?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you!
</I>&gt;&gt;<i> *Example 4-8. wordcountproxy.py*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> import sgmllib, re
</I>&gt;&gt;<i> from twisted.web import proxy, http
</I>&gt;&gt;<i> import sys
</I>&gt;&gt;<i> from twisted.python import log
</I>&gt;&gt;<i> log.startLogging(sys.stdout)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> WEB_PORT =3D 8000
</I>&gt;&gt;<i> PROXY_PORT =3D 8001
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class WordParser(sgmllib.SGMLParser):
</I>&gt;&gt;<i>   def __init__(self):
</I>&gt;&gt;<i>       sgmllib.SGMLParser.__init__(self)
</I>&gt;&gt;<i>       self.chardata =3D []
</I>&gt;&gt;<i>       self.inBody =3D False
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def start_body(self, attrs):
</I>&gt;&gt;<i>       self.inBody =3D True
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def end_body(self):
</I>&gt;&gt;<i>       self.inBody =3D False
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def handle_data(self, data):
</I>&gt;&gt;<i>       if self.inBody:
</I>&gt;&gt;<i>           self.chardata.append(data)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def getWords(self):
</I>&gt;&gt;<i>       # extract words
</I>&gt;&gt;<i>       wordFinder =3D re.compile(r'\w*')
</I>&gt;&gt;<i>       words =3D wordFinder.findall(&quot;&quot;.join(self.chardata))
</I>&gt;&gt;<i>       words =3D filter(lambda word: word.strip( ), words)
</I>&gt;&gt;<i>       print &quot;WORDS ARE&quot;, words
</I>&gt;&gt;<i>       return words
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class WordCounter(object):
</I>&gt;&gt;<i>   ignoredWords =3D &quot;the a of in from to this that and or but is was be
</I>&gt;&gt;<i> can could i you they we at&quot;.split( )
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def __init__(self):
</I>&gt;&gt;<i>       self.words =3D {}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def addWords(self, words):
</I>&gt;&gt;<i>       for word in words:
</I>&gt;&gt;<i>           word =3D word.lower( )
</I>&gt;&gt;<i>           if not word in self.ignoredWords:
</I>&gt;&gt;<i>               currentCount =3D self.words.get(word, 0)
</I>&gt;&gt;<i>               self.words[word] =3D currentCount + 1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class WordCountProxyClient(proxy.ProxyClient):
</I>&gt;&gt;<i>   def handleHeader(self, key, value):
</I>&gt;&gt;<i>       proxy.ProxyClient.handleHeader(self, key, value)
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> How about skipping it here?
</I>&gt;<i>
</I>
If I use here the following:

print &quot;[&quot;, key, &quot;:&quot;, value,&quot;]&quot;

I get:
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Cache-Control :
no-cache, no-store, max-age=3D0, must-revalidate ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Pragma : no-cache ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Expires : Fri, 01
Jan 1990 00:00:00 GMT ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Date : Tue, 16 Dec
2008 13:37:21 GMT ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Content-Type :
text/javascript; charset=3DUTF-8 ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Set-Cookie :
GMAIL_STAT_3492=3DEXPIRED; Expires=3DMon, 15-Dec-2008 13:37:21 GMT; Path=3D=
/a/
dragusin.ro ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Set-Cookie :
GMAIL_IMP=3DEXPIRED; Expires=3DMon, 15-Dec-2008 13:37:21 GMT; Path=3D/a/
dragusin.ro ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Content-Encoding :
gzip ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [
X-Content-Type-Options : nosniff ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Content-Length :
14340 ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Server : GFE/1.3 ]
2008-12-16 15:37:21+0200 [WordCountProxyClient,client] [ Connection : Close
]
2008-12-16 15:37:22+0200 [WordCountProxyClient,client] [ Cache-Control :
private, max-age=3D0 ]
2008-12-16 15:37:22+0200 [WordCountProxyClient,client] [ Date : Tue, 16 Dec
2008 13:37:21 GMT ]
2008-12-16 15:37:22+0200 [WordCountProxyClient,client] [ Expires : -1 ]
2008-12-16 15:37:22+0200 [WordCountProxyClient,client] [ Content-Type :
text/html; charset=3DUTF-8 ]
2008-12-16 15:37:22+0200 [WordCountProxyClient,client] [ Content-Encoding :
gzip ]
2008-12-16 15:37:22+0200 [WordCountProxyClient,client] [ Server : gws ]
2008-12-16 15:37:22+0200 [WordCountProxyClient,client] [ Content-Length :
2597 ]
2008-12-16 15:37:22+0200 [WordCountProxyClient,client] [ Connection : Close
]

So that is the response header.
I need to override the request header, the one that the browser sends to the
proxy server.
See below:


&gt;<i>
</I>&gt;<i>
</I>&gt;<i>        if key.lower( ) =3D=3D &quot;content-type&quot;:
</I>&gt;&gt;<i>           if value.split(';')[0] =3D=3D 'text/html':
</I>&gt;&gt;<i>               self.parser =3D WordParser( )
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def handleResponsePart(self, data):
</I>&gt;&gt;<i>       proxy.ProxyClient.handleResponsePart(self, data)
</I>&gt;&gt;<i>       if hasattr(self, 'parser'): self.parser.feed(data)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def handleResponseEnd(self):
</I>&gt;&gt;<i>       proxy.ProxyClient.handleResponseEnd(self)
</I>&gt;&gt;<i>       if hasattr(self, 'parser'):
</I>&gt;&gt;<i>           self.parser.close( )
</I>&gt;&gt;<i>           self.father.wordCounter.addWords(self.parser.getWords( ))
</I>&gt;&gt;<i>           del(self.parser)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class WordCountProxyClientFactory(proxy.ProxyClientFactory):
</I>&gt;&gt;<i>   def buildProtocol(self, addr):
</I>&gt;&gt;<i>       client =3D proxy.ProxyClientFactory.buildProtocol(self, addr)
</I>&gt;&gt;<i>       # upgrade proxy.proxyClient object to WordCountProxyClient
</I>&gt;&gt;<i>       client.__class__ =3D WordCountProxyClient
</I>&gt;&gt;<i>       return client
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class WordCountProxyRequest(proxy.ProxyRequest):
</I>&gt;&gt;<i>   protocols =3D {'http': WordCountProxyClientFactory}
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def __init__(self, wordCounter, *args):
</I>&gt;&gt;<i>       self.wordCounter =3D wordCounter
</I>&gt;&gt;<i>       proxy.ProxyRequest.__init__(self, *args)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *    def process(self):
</I>&gt;&gt;<i>       proxy.ProxyRequest.process(self)
</I>&gt;&gt;<i>       print &quot;received_headers&quot;, proxy.ProxyRequest.getAllHeaders(self)*
</I>&gt;<i>
</I>&gt;<i>
</I>the print above prints:

received_headers: {'accept-language': 'en-us,en;q=3D0.5', 'accept-encoding':
'gzip,deflate', 'keep-alive': '300', 'accept':
'text/html,application/xhtml+xml,application/xml;q=3D0.9,*/*;q=3D0.8',
'user-agent': 'Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.4)
Gecko/2008111318 Ubuntu/8.10 (intrepid) Firefox/3.0.4', 'accept-charset':
'ISO-8859-1,utf-8;q=3D0.7,*;q=3D0.7', 'host': 'www.google.com', 'cookie':
'PREF=3DID=3Dcfb3eb179de0c1e6:LD=3Den:NR=3D100:CR=3D2:TM=3D1228315308:LM=3D=
1229032156:GM=3D1:S=3DImAuEufbnV6S7BAz;
NID=3D17=3DlOVMiFLculcrfN-zUO7xxFTTUFzqQqaHOFHcG_BDmYFX8QKYbMoo7GrDoYH-8ASP=
BlVijG_Hstp7HSDQ_8WQexHPjwz6g_7ZVpBhwmh3vkKuO3jpf9dnzrnWthcW1mGh;
S=3Dphotos_html=3D6ScUGfd699g4Xuuh0FeizA; TZ=3D-120', 'cache-control':
'max-age=3D0', 'proxy-connection': 'keep-alive'}

these are the values I want to modify, the 'accept-encoding', to be
specific. How can I do it?

Thank you!



&gt;<i> class WordCountProxy(proxy.Proxy):
</I>&gt;&gt;<i>   def __init__(self, wordCounter):
</I>&gt;&gt;<i>       self.wordCounter =3D wordCounter
</I>&gt;&gt;<i>       proxy.Proxy.__init__(self)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def requestFactory(self, *args):
</I>&gt;&gt;<i>       return WordCountProxyRequest(self.wordCounter, *args)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class WordCountProxyFactory(http.HTTPFactory):
</I>&gt;&gt;<i>   def __init__(self, wordCounter):
</I>&gt;&gt;<i>       self.wordCounter =3D wordCounter
</I>&gt;&gt;<i>       http.HTTPFactory.__init__(self)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def buildProtocol(self, addr):
</I>&gt;&gt;<i>       protocol =3D WordCountProxy(self.wordCounter)
</I>&gt;&gt;<i>       return protocol
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # classes for web reporting interface
</I>&gt;&gt;<i> class WebReportRequest(http.Request):
</I>&gt;&gt;<i>   def __init__(self, wordCounter, *args):
</I>&gt;&gt;<i>       self.wordCounter =3D wordCounter
</I>&gt;&gt;<i>       http.Request.__init__(self, *args)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def process(self):
</I>&gt;&gt;<i>       self.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;)
</I>&gt;&gt;<i>       words =3D self.wordCounter.words.items( )
</I>&gt;&gt;<i>       words.sort(lambda (w1, c1), (w2, c2): cmp(c2, c1))
</I>&gt;&gt;<i>       for word, count in words:
</I>&gt;&gt;<i>           self.write(&quot;&lt;li&gt;%s %s&lt;/li&gt;&quot; % (word, count))
</I>&gt;&gt;<i>       self.finish( )
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class WebReportChannel(http.HTTPChannel):
</I>&gt;&gt;<i>   def __init__(self, wordCounter):
</I>&gt;&gt;<i>       self.wordCounter =3D wordCounter
</I>&gt;&gt;<i>       http.HTTPChannel.__init__(self)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def requestFactory(self, *args):
</I>&gt;&gt;<i>       return WebReportRequest(self.wordCounter, *args)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> class WebReportFactory(http.HTTPFactory):
</I>&gt;&gt;<i>   def __init__(self, wordCounter):
</I>&gt;&gt;<i>       self.wordCounter =3D wordCounter
</I>&gt;&gt;<i>       http.HTTPFactory.__init__(self)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   def buildProtocol(self, addr):
</I>&gt;&gt;<i>       return WebReportChannel(self.wordCounter)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> if __name__ =3D=3D &quot;__main__&quot;:
</I>&gt;&gt;<i>   from twisted.internet import reactor
</I>&gt;&gt;<i>   counter =3D WordCounter( )
</I>&gt;&gt;<i>   prox =3D WordCountProxyFactory(counter)
</I>&gt;&gt;<i>   reactor.listenTCP(PROXY_PORT, prox)
</I>&gt;&gt;<i>   reactor.listenTCP(WEB_PORT, WebReportFactory(counter))
</I>&gt;&gt;<i>   reactor.run( )
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Jean-Paul
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i>
</I>


-- =

Radu
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20081216/da=">http://twistedmatrix.com/pipermail/twisted-web/attachments/20081216/da=</A>
b51661/attachment-0001.htm
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004035.html">[Twisted-web] How can I change the HTTP request to avoid gzip
</A></li>
	<LI>Next message: <A HREF="004037.html">[Twisted-web] How can I change the HTTP request to avoid gzip
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4036">[ date ]</a>
              <a href="thread.html#4036">[ thread ]</a>
              <a href="subject.html#4036">[ subject ]</a>
              <a href="author.html#4036">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
