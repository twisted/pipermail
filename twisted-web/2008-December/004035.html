<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] How can I change the HTTP request to avoid gzip
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20How%20can%20I%20change%20the%20HTTP%20request%20to%20avoid%20gzip&In-Reply-To=b657efa80812151931y4d0dacdv3aee3fec51eaf007%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004034.html">
   <LINK REL="Next"  HREF="004036.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] How can I change the HTTP request to avoid gzip</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20How%20can%20I%20change%20the%20HTTP%20request%20to%20avoid%20gzip&In-Reply-To=b657efa80812151931y4d0dacdv3aee3fec51eaf007%40mail.gmail.com"
       TITLE="[Twisted-web] How can I change the HTTP request to avoid gzip">exarkun at divmod.com
       </A><BR>
    <I>Tue Dec 16 07:20:56 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="004034.html">[Twisted-web] How can I change the HTTP request to avoid gzip
</A></li>
        <LI>Next message: <A HREF="004036.html">[Twisted-web] How can I change the HTTP request to avoid gzip
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4035">[ date ]</a>
              <a href="thread.html#4035">[ thread ]</a>
              <a href="subject.html#4035">[ subject ]</a>
              <a href="author.html#4035">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 16 Dec 2008 05:31:45 +0200, Radu Dragusin &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">radudragusin at gmail.com</A>&gt; wrote:
&gt;<i>I have a HTTP Proxy made with twisted.web and want to change the request
</I>&gt;<i>that the browser sends to the Proxy such that I erase the value of the
</I>&gt;<i>'accept-encoding' key from 'gzip,deflate' to ' '.
</I>&gt;<i>
</I>&gt;<i>I use the example from the Tisted Book:
</I>&gt;<i>
</I>&gt;<i>By adding the overriden process method in WordCountProxyRequest I can get
</I>&gt;<i>the request header but have found no way to set a key, value pair.
</I>&gt;<i>I want make the server think that the browser does not support gzip because
</I>&gt;<i>twisted seems to not support gzip as the response from www.google.com and
</I>&gt;<i>many (but not all) sites appears still encoded. www.dpreview.com seems not
</I>&gt;<i>to gzip the response, and so the resonse is processed correctly.
</I>&gt;<i>
</I>&gt;<i>What can I do to either correctly decode gzip responses or modify the
</I>&gt;<i>'accept-encoding' value to nothing so the server does not compress the
</I>&gt;<i>response?
</I>&gt;<i>
</I>&gt;<i>Thank you!
</I>&gt;<i>*Example 4-8. wordcountproxy.py*
</I>&gt;<i>
</I>&gt;<i>import sgmllib, re
</I>&gt;<i>from twisted.web import proxy, http
</I>&gt;<i>import sys
</I>&gt;<i>from twisted.python import log
</I>&gt;<i>log.startLogging(sys.stdout)
</I>&gt;<i>
</I>&gt;<i>WEB_PORT = 8000
</I>&gt;<i>PROXY_PORT = 8001
</I>&gt;<i>
</I>&gt;<i>class WordParser(sgmllib.SGMLParser):
</I>&gt;<i>    def __init__(self):
</I>&gt;<i>        sgmllib.SGMLParser.__init__(self)
</I>&gt;<i>        self.chardata = []
</I>&gt;<i>        self.inBody = False
</I>&gt;<i>
</I>&gt;<i>    def start_body(self, attrs):
</I>&gt;<i>        self.inBody = True
</I>&gt;<i>
</I>&gt;<i>    def end_body(self):
</I>&gt;<i>        self.inBody = False
</I>&gt;<i>
</I>&gt;<i>    def handle_data(self, data):
</I>&gt;<i>        if self.inBody:
</I>&gt;<i>            self.chardata.append(data)
</I>&gt;<i>
</I>&gt;<i>    def getWords(self):
</I>&gt;<i>        # extract words
</I>&gt;<i>        wordFinder = re.compile(r'\w*')
</I>&gt;<i>        words = wordFinder.findall(&quot;&quot;.join(self.chardata))
</I>&gt;<i>        words = filter(lambda word: word.strip( ), words)
</I>&gt;<i>        print &quot;WORDS ARE&quot;, words
</I>&gt;<i>        return words
</I>&gt;<i>
</I>&gt;<i>class WordCounter(object):
</I>&gt;<i>    ignoredWords = &quot;the a of in from to this that and or but is was be
</I>&gt;<i>can could i you they we at&quot;.split( )
</I>&gt;<i>
</I>&gt;<i>    def __init__(self):
</I>&gt;<i>        self.words = {}
</I>&gt;<i>
</I>&gt;<i>    def addWords(self, words):
</I>&gt;<i>        for word in words:
</I>&gt;<i>            word = word.lower( )
</I>&gt;<i>            if not word in self.ignoredWords:
</I>&gt;<i>                currentCount = self.words.get(word, 0)
</I>&gt;<i>                self.words[word] = currentCount + 1
</I>&gt;<i>
</I>&gt;<i>class WordCountProxyClient(proxy.ProxyClient):
</I>&gt;<i>    def handleHeader(self, key, value):
</I>&gt;<i>        proxy.ProxyClient.handleHeader(self, key, value)
</I>
How about skipping it here?

&gt;<i>        if key.lower( ) == &quot;content-type&quot;:
</I>&gt;<i>            if value.split(';')[0] == 'text/html':
</I>&gt;<i>                self.parser = WordParser( )
</I>&gt;<i>
</I>&gt;<i>    def handleResponsePart(self, data):
</I>&gt;<i>        proxy.ProxyClient.handleResponsePart(self, data)
</I>&gt;<i>        if hasattr(self, 'parser'): self.parser.feed(data)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>    def handleResponseEnd(self):
</I>&gt;<i>        proxy.ProxyClient.handleResponseEnd(self)
</I>&gt;<i>        if hasattr(self, 'parser'):
</I>&gt;<i>            self.parser.close( )
</I>&gt;<i>            self.father.wordCounter.addWords(self.parser.getWords( ))
</I>&gt;<i>            del(self.parser)
</I>&gt;<i>
</I>&gt;<i>class WordCountProxyClientFactory(proxy.ProxyClientFactory):
</I>&gt;<i>    def buildProtocol(self, addr):
</I>&gt;<i>        client = proxy.ProxyClientFactory.buildProtocol(self, addr)
</I>&gt;<i>        # upgrade proxy.proxyClient object to WordCountProxyClient
</I>&gt;<i>        client.__class__ = WordCountProxyClient
</I>&gt;<i>        return client
</I>&gt;<i>
</I>&gt;<i>class WordCountProxyRequest(proxy.ProxyRequest):
</I>&gt;<i>    protocols = {'http': WordCountProxyClientFactory}
</I>&gt;<i>
</I>&gt;<i>    def __init__(self, wordCounter, *args):
</I>&gt;<i>        self.wordCounter = wordCounter
</I>&gt;<i>        proxy.ProxyRequest.__init__(self, *args)
</I>&gt;<i>
</I>&gt;<i>*    def process(self):
</I>&gt;<i>        proxy.ProxyRequest.process(self)
</I>&gt;<i>        print &quot;received_headers&quot;, proxy.ProxyRequest.getAllHeaders(self)*
</I>&gt;<i>
</I>&gt;<i>class WordCountProxy(proxy.Proxy):
</I>&gt;<i>    def __init__(self, wordCounter):
</I>&gt;<i>        self.wordCounter = wordCounter
</I>&gt;<i>        proxy.Proxy.__init__(self)
</I>&gt;<i>
</I>&gt;<i>    def requestFactory(self, *args):
</I>&gt;<i>        return WordCountProxyRequest(self.wordCounter, *args)
</I>&gt;<i>
</I>&gt;<i>class WordCountProxyFactory(http.HTTPFactory):
</I>&gt;<i>    def __init__(self, wordCounter):
</I>&gt;<i>        self.wordCounter = wordCounter
</I>&gt;<i>        http.HTTPFactory.__init__(self)
</I>&gt;<i>
</I>&gt;<i>    def buildProtocol(self, addr):
</I>&gt;<i>        protocol = WordCountProxy(self.wordCounter)
</I>&gt;<i>        return protocol
</I>&gt;<i>
</I>&gt;<i># classes for web reporting interface
</I>&gt;<i>class WebReportRequest(http.Request):
</I>&gt;<i>    def __init__(self, wordCounter, *args):
</I>&gt;<i>        self.wordCounter = wordCounter
</I>&gt;<i>        http.Request.__init__(self, *args)
</I>&gt;<i>
</I>&gt;<i>    def process(self):
</I>&gt;<i>        self.setHeader(&quot;Content-Type&quot;, &quot;text/html&quot;)
</I>&gt;<i>        words = self.wordCounter.words.items( )
</I>&gt;<i>        words.sort(lambda (w1, c1), (w2, c2): cmp(c2, c1))
</I>&gt;<i>        for word, count in words:
</I>&gt;<i>            self.write(&quot;&lt;li&gt;%s %s&lt;/li&gt;&quot; % (word, count))
</I>&gt;<i>        self.finish( )
</I>&gt;<i>
</I>&gt;<i>class WebReportChannel(http.HTTPChannel):
</I>&gt;<i>    def __init__(self, wordCounter):
</I>&gt;<i>        self.wordCounter = wordCounter
</I>&gt;<i>        http.HTTPChannel.__init__(self)
</I>&gt;<i>
</I>&gt;<i>    def requestFactory(self, *args):
</I>&gt;<i>        return WebReportRequest(self.wordCounter, *args)
</I>&gt;<i>
</I>&gt;<i>class WebReportFactory(http.HTTPFactory):
</I>&gt;<i>    def __init__(self, wordCounter):
</I>&gt;<i>        self.wordCounter = wordCounter
</I>&gt;<i>        http.HTTPFactory.__init__(self)
</I>&gt;<i>
</I>&gt;<i>    def buildProtocol(self, addr):
</I>&gt;<i>        return WebReportChannel(self.wordCounter)
</I>&gt;<i>
</I>&gt;<i>if __name__ == &quot;__main__&quot;:
</I>&gt;<i>    from twisted.internet import reactor
</I>&gt;<i>    counter = WordCounter( )
</I>&gt;<i>    prox = WordCountProxyFactory(counter)
</I>&gt;<i>    reactor.listenTCP(PROXY_PORT, prox)
</I>&gt;<i>    reactor.listenTCP(WEB_PORT, WebReportFactory(counter))
</I>&gt;<i>    reactor.run( )
</I>&gt;<i>
</I>&gt;<i>
</I>
Jean-Paul

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004034.html">[Twisted-web] How can I change the HTTP request to avoid gzip
</A></li>
	<LI>Next message: <A HREF="004036.html">[Twisted-web] How can I change the HTTP request to avoid gzip
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4035">[ date ]</a>
              <a href="thread.html#4035">[ thread ]</a>
              <a href="subject.html#4035">[ subject ]</a>
              <a href="author.html#4035">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
