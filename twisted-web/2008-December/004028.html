<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] twisted.web.wsgi usage example
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20twisted.web.wsgi%20usage%20example&In-Reply-To=FF76AB8F-6E0D-40AF-AD00-8975450415F3%40bubblehouse.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004027.html">
   <LINK REL="Next"  HREF="004029.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] twisted.web.wsgi usage example</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20twisted.web.wsgi%20usage%20example&In-Reply-To=FF76AB8F-6E0D-40AF-AD00-8975450415F3%40bubblehouse.org"
       TITLE="[Twisted-web] twisted.web.wsgi usage example">exarkun at divmod.com
       </A><BR>
    <I>Tue Dec  9 16:19:10 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="004027.html">[Twisted-web] twisted.web.wsgi usage example
</A></li>
        <LI>Next message: <A HREF="004029.html">[Twisted-web] finger tutorial: problems rewriting finger08.py to
 use inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4028">[ date ]</a>
              <a href="thread.html#4028">[ thread ]</a>
              <a href="subject.html#4028">[ subject ]</a>
              <a href="author.html#4028">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 9 Dec 2008 14:40:13 -0500, Phil Christensen &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">phil at bubblehouse.org</A>&gt; wrote:
&gt;<i>Just because I've found myself doing this several times, you might  give an 
</I>&gt;<i>example of how to run an existing WSGI application in twisted.
</I>&gt;<i>
</I>&gt;<i>I would suggest Trac, since you can just import 
</I>&gt;<i>trac.web.main.dispatch_request and pass it as your WSGI application  object, 
</I>&gt;<i>plus it's something that I know I often end up using in tandem  with web 
</I>&gt;<i>projects.
</I>
This is pretty easy:

    twistd web --wsgi trac.web.main.dispatch_request

&gt;<i>
</I>&gt;<i>-phil
</I>&gt;<i>
</I>&gt;<i>On Dec 9, 2008, at 12:38 AM, Waldemar Osuch wrote:
</I>&gt;&gt;<i>Hi,
</I>&gt;&gt;<i>I'm trying to come up with an example on how to use the spanking new
</I>&gt;&gt;<i>twisted.web.wsgi
</I>&gt;&gt;<i>module.  Here it is.  Any comments?
</I>
Just one, I think

&gt;&gt;<i>
</I>&gt;&gt;<i>8 &lt; 
</I>&gt;&gt;<i>--------------------------------------------------------------------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>from twisted.internet import reactor
</I>&gt;&gt;<i>from twisted.application import service, internet
</I>&gt;&gt;<i>from twisted.web import server, static, wsgi
</I>&gt;&gt;<i>from twisted.python import threadpool
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>def wsgi_app(environ, start_response):
</I>&gt;&gt;<i>    status = '200 OK'
</I>&gt;&gt;<i>    response_headers = [('Content-type', 'text/plain')]
</I>&gt;&gt;<i>    start_response(status, response_headers)
</I>&gt;&gt;<i>    return ['Hello from twisted.web.wsgi']
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>class WSGIService(service.Service):
</I>&gt;&gt;<i>    def __init__(self, minPoolSize=5, maxPoolSize=20):
</I>&gt;&gt;<i>        self.pool = threadpool.ThreadPool(minPoolSize, maxPoolSize)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def startService(self):
</I>&gt;&gt;<i>        self.pool.start()
</I>&gt;&gt;<i>        service.Service.startService(self)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    def stopService(self):
</I>&gt;&gt;<i>        self.pool.stop()
</I>&gt;&gt;<i>        service.Service.stopService(self)
</I>&gt;&gt;<i>
</I>
self.pool.stop() will block until all the threads in the pool finish whatever
job they're on.  This is probably okay for now, but if Twisted's WSGI server
ever changes to deliver request body bytes to WSGI applications incrementally
then this could cause a deadlock.  In order to fix this, there needs to be a
way to shut down the threadpool without blocking the reactor.  This would
make a good enhancement request for ThreadPool.  Another approach would be to
stop the HTTP port so that new requests cannot be made and then wait for all
existing requests to finish before trying to stop the pool.

&gt;&gt;<i>
</I>&gt;&gt;<i>application = service.Application('wsgi')
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>root = static.File(&quot;www/documents&quot;)
</I>&gt;&gt;<i>site = server.Site(root)
</I>&gt;&gt;<i>internet.TCPServer(8080, site).setServiceParent(application)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>serv = WSGIService()
</I>&gt;&gt;<i>root.putChild('wsgi', wsgi.WSGIResource(reactor, serv.pool, wsgi_app))
</I>&gt;&gt;<i>serv.setServiceParent(application)
</I>&gt;&gt;<i>
</I>
Jean-Paul

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004027.html">[Twisted-web] twisted.web.wsgi usage example
</A></li>
	<LI>Next message: <A HREF="004029.html">[Twisted-web] finger tutorial: problems rewriting finger08.py to
 use inlineCallbacks
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4028">[ date ]</a>
              <a href="thread.html#4028">[ thread ]</a>
              <a href="subject.html#4028">[ subject ]</a>
              <a href="author.html#4028">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
