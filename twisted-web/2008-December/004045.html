<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Finding memory leaks in Nevow/Twisted
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Finding%20memory%20leaks%20in%20Nevow/Twisted&In-Reply-To=494803DA.2060300%40thiengineering.ch">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004044.html">
   <LINK REL="Next"  HREF="004046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Finding memory leaks in Nevow/Twisted</H1>
    <B>Abdul-Wahid Paterson</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Finding%20memory%20leaks%20in%20Nevow/Twisted&In-Reply-To=494803DA.2060300%40thiengineering.ch"
       TITLE="[Twisted-web] Finding memory leaks in Nevow/Twisted">abdulwahid at gmail.com
       </A><BR>
    <I>Wed Dec 17 00:41:11 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="004044.html">[Twisted-web] Finding memory leaks in Nevow/Twisted
</A></li>
        <LI>Next message: <A HREF="004046.html">[Twisted-web] Athena IE lockup on page refresh
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4045">[ date ]</a>
              <a href="thread.html#4045">[ thread ]</a>
              <a href="subject.html#4045">[ subject ]</a>
              <a href="author.html#4045">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Werner,

Thanks for your post. Is very useful.

I am using Guard so that might be one place to start looking although I
personally didn't develop that part of the code. (Which kinda make me even
more suspicious).

The Manhole stuff looks interesting too. I will give that a go if I can't
find anything by disabling the Guard code.

Thanks again.

AW

On Tue, Dec 16, 2008 at 10:39 PM, Werner Thie &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">wthie at thiengineering.ch</A>&gt;wrot=
e:

&gt;<i> Hi
</I>&gt;<i>
</I>&gt;<i> I was bitten by the same problem and went so far to track down all the
</I>&gt;<i> fishy cycles which easily can be created. Most of the cycles I detected w=
</I>ere
&gt;<i> multi-object cycles which were created by me just storing references to
</I>&gt;<i> objects to have them handy. Certain types of cycles cannot be broken by t=
</I>he
&gt;<i> gc, you get a runaway situation either in Python24 or Python25. My code n=
</I>ow
&gt;<i> runs without problems for months serving more than 10k users a day provid=
</I>ing
&gt;<i> a card gaming environment.
</I>&gt;<i>
</I>&gt;<i> Things to check:
</I>&gt;<i> - the object hierarchy on the server and the client should be in sync, if
</I>&gt;<i> not detach might not work correctly
</I>&gt;<i>
</I>&gt;<i> - do you use stateful LivePages?
</I>&gt;<i> if so, check the toremember list in the request if its growing ad libidum
</I>&gt;<i>
</I>&gt;<i> - do you use guard/sessions?
</I>&gt;<i> if so, be careful with the session/mind object and what you store in mind
</I>&gt;<i>
</I>&gt;<i> But without seeing your code it's close to impossible to give you more th=
</I>an
&gt;<i> hints.
</I>&gt;<i>
</I>&gt;<i> I include some code which I wrote to peek into my running server with a
</I>&gt;<i> manhole connection. dumpobjects is loosely based on several Python snippe=
</I>ts
&gt;<i> and might not win a contest in programming but it helps to track the numb=
</I>er
&gt;<i> of objects of certain types in the running system when used on the
</I>&gt;<i> commandline from inside your server.
</I>&gt;<i>
</I>&gt;<i> HTH, Werner
</I>&gt;<i>
</I>&gt;<i> To create a manhole in the same process you started with your .tac file u=
</I>se
&gt;<i> the following code:
</I>&gt;<i>
</I>&gt;<i> ---------------------------------------------------------------
</I>&gt;<i> def ManholeFactory(namespace, **passwords):
</I>&gt;<i>  realm =3D manhole_ssh.TerminalRealm()
</I>&gt;<i>
</I>&gt;<i>  def getManhole(_):
</I>&gt;<i>    return manhole.Manhole(namespace)
</I>&gt;<i>
</I>&gt;<i>  realm.chainedProtocolFactory.protocolFactory =3D getManhole
</I>&gt;<i>  p =3D portal.Portal(realm)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> p.registerChecker(checkers.InMemoryUsernamePasswordDatabaseDontUse(**pass=
</I>words))
&gt;<i>  f =3D manhole_ssh.ConchFactory(p)
</I>&gt;<i>  return f
</I>&gt;<i>
</I>&gt;<i> console =3D ManholeFactory(globals(), admin=3D'admin')
</I>&gt;<i> internet.TCPServer(2222, console,
</I>&gt;<i> interface=3D'localhost').setServiceParent(application)
</I>&gt;<i> ---------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i> exc =3D [
</I>&gt;<i>  &quot;function&quot;,
</I>&gt;<i>  &quot;type&quot;,
</I>&gt;<i>  &quot;list&quot;,
</I>&gt;<i>  &quot;dict&quot;,
</I>&gt;<i>  &quot;tuple&quot;,
</I>&gt;<i>  &quot;wrapper_descriptor&quot;,
</I>&gt;<i>  &quot;module&quot;,
</I>&gt;<i>  &quot;method_descriptor&quot;,
</I>&gt;<i>  &quot;member_descriptor&quot;,
</I>&gt;<i>  &quot;instancemethod&quot;,
</I>&gt;<i>  &quot;builtin_function_or_method&quot;,
</I>&gt;<i>  &quot;frame&quot;,
</I>&gt;<i>  &quot;classmethod&quot;,
</I>&gt;<i>  &quot;classmethod_descriptor&quot;,
</I>&gt;<i>  &quot;_Environ&quot;,
</I>&gt;<i>  &quot;MemoryError&quot;,
</I>&gt;<i>  &quot;_Printer&quot;,
</I>&gt;<i>  &quot;_Helper&quot;,
</I>&gt;<i>  &quot;getset_descriptor&quot;,
</I>&gt;<i>  &quot;weakreaf&quot;
</I>&gt;<i> ]
</I>&gt;<i>
</I>&gt;<i> inc =3D [
</I>&gt;<i>  'YourObject_One',
</I>&gt;<i>  'YourObject_Two'
</I>&gt;<i> ]
</I>&gt;<i>
</I>&gt;<i> prev =3D {}
</I>&gt;<i>
</I>&gt;<i> def dumpObjects(delta=3DTrue, limit=3D0, include=3Dinc, exclude=3D[]):
</I>&gt;<i>  global prev
</I>&gt;<i>  if include !=3D [] and exclude !=3D []:
</I>&gt;<i>    print 'cannot use include and exclude at the same time'
</I>&gt;<i>    return
</I>&gt;<i>  print 'working with:'
</I>&gt;<i>  print '   delta: ', delta
</I>&gt;<i>  print '   limit: ', limit
</I>&gt;<i>  print ' include: ', include
</I>&gt;<i>  print ' exclude: ', exclude
</I>&gt;<i>  objects =3D {}
</I>&gt;<i>  gc.collect()
</I>&gt;<i>  oo =3D gc.get_objects()
</I>&gt;<i>  for o in oo:
</I>&gt;<i>    if getattr(o, &quot;__class__&quot;, None):
</I>&gt;<i>      name =3D o.__class__.__name__
</I>&gt;<i>      if ((exclude =3D=3D [] and include =3D=3D [])       or \
</I>&gt;<i>          (exclude !=3D [] and name not in exclude) or \
</I>&gt;<i>          (include !=3D [] and name in include)):
</I>&gt;<i>        objects[name] =3D objects.get(name, 0) + 1
</I>&gt;<i> ##    if more:
</I>&gt;<i> ##      print o
</I>&gt;<i>  pk =3D prev.keys()
</I>&gt;<i>  pk.sort()
</I>&gt;<i>  names =3D objects.keys()
</I>&gt;<i>  names.sort()
</I>&gt;<i>  for name in names:
</I>&gt;<i>    if limit =3D=3D 0 or objects[name] &gt; limit:
</I>&gt;<i>      if not prev.has_key(name):
</I>&gt;<i>        prev[name] =3D objects[name]
</I>&gt;<i>      dt =3D objects[name] - prev[name]
</I>&gt;<i>      if delta or dt !=3D 0:
</I>&gt;<i>        print '%0.6d -- %0.6d -- ' % (dt, objects[name]),  name
</I>&gt;<i>      prev[name] =3D objects[name]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Abdul-Wahid Paterson wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am using Python 2.5.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I will try to use guppy as suggested in another post to so if it will
</I>&gt;&gt;<i> help. Otherwise yes, I will try to reduce it to the smallest possible co=
</I>de
&gt;&gt;<i> to demonstrate the leak. At the moment the code is a bit complex so is h=
</I>ard
&gt;&gt;<i> to track down.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for the help.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> AW
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Tue, Dec 16, 2008 at 6:23 PM, Phil Christensen &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">phil at bubblehouse.org</A>&lt;=
</I>mailto:
&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">phil at bubblehouse.org</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    On Dec 16, 2008, at 10:07 AM, Abdul-Wahid Paterson wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>        I have managed to write my nevow/twisted site. I am using a lot
</I>&gt;&gt;<i>        of Athena elements on my site and they are all working well from
</I>&gt;&gt;<i>        a functional point of view. However, the Athena elements are
</I>&gt;&gt;<i>        eating up RAM and as I leave things running the Twisted process
</I>&gt;&gt;<i>        slowly consumes more and more RAM until the process dies.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    The first thing would be to check that you're running at least
</I>&gt;&gt;<i>    Python 2.5. Previous versions have garbage collection problems on
</I>&gt;&gt;<i>    long-running apps like a Twisted web app.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    Athena-based apps should not inherently leak memory, but adding
</I>&gt;&gt;<i>    leaks of your own creation isn't too hard ;-)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    If you are running 2.5 or later, you should try to reduce your app
</I>&gt;&gt;<i>    to the smallest possible test version that demonstrates the leak,
</I>&gt;&gt;<i>    and someone here can probably be of more help.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    -phil
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    _______________________________________________
</I>&gt;&gt;<i>    Twisted-web mailing list
</I>&gt;&gt;<i>    <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A> &lt;mailto:<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>&gt;
</I>&gt;&gt;<i>    <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ------------------------------------------------------------------------
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-web mailing list
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20081217/cd=">http://twistedmatrix.com/pipermail/twisted-web/attachments/20081217/cd=</A>
d42b56/attachment.htm
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004044.html">[Twisted-web] Finding memory leaks in Nevow/Twisted
</A></li>
	<LI>Next message: <A HREF="004046.html">[Twisted-web] Athena IE lockup on page refresh
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4045">[ date ]</a>
              <a href="thread.html#4045">[ thread ]</a>
              <a href="subject.html#4045">[ subject ]</a>
              <a href="author.html#4045">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
