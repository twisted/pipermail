<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] finger tutorial: problems rewriting finger08.py
	to use inlineCallbacks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20finger%20tutorial%3A%20problems%20rewriting%20finger08.py%0A%09to%20use%20inlineCallbacks&In-Reply-To=54789.219.101.239.101.1228962514.squirrel%40mail.vultaire.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004029.html">
   <LINK REL="Next"  HREF="004031.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] finger tutorial: problems rewriting finger08.py
	to use inlineCallbacks</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20finger%20tutorial%3A%20problems%20rewriting%20finger08.py%0A%09to%20use%20inlineCallbacks&In-Reply-To=54789.219.101.239.101.1228962514.squirrel%40mail.vultaire.net"
       TITLE="[Twisted-web] finger tutorial: problems rewriting finger08.py
	to use inlineCallbacks">exarkun at divmod.com
       </A><BR>
    <I>Wed Dec 10 22:37:01 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="004029.html">[Twisted-web] finger tutorial: problems rewriting finger08.py to
 use inlineCallbacks
</A></li>
        <LI>Next message: <A HREF="004031.html">[Twisted-web] possible bug in t.web.wsgi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4030">[ date ]</a>
              <a href="thread.html#4030">[ thread ]</a>
              <a href="subject.html#4030">[ subject ]</a>
              <a href="author.html#4030">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 11 Dec 2008 11:28:34 +0900 (JST), Paul Goins &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">general at vultaire.net</A>&gt; wrote:
&gt;<i>I'm having problems with using inlineCallbacks in the finger tutorial.
</I>&gt;<i>I've used them successfully in some other test programs, but in this case
</I>&gt;<i>I really don't know what I'm doing wrong.
</I>&gt;<i>
</I>&gt;<i>Here's the FingerProtocol code from the finger tutorial:
</I>&gt;<i>
</I>&gt;<i>class FingerProtocol(basic.LineReceiver):
</I>&gt;<i>    def lineReceived(self, user):
</I>&gt;<i>        self.factory.getUser(user) \
</I>&gt;<i>            .addErrback(lambda _: &quot;Internal error in server&quot;) \
</I>&gt;<i>            .addCallback(lambda m:
</I>&gt;<i>                             (self.transport.write(m + &quot;\r\n&quot;),
</I>&gt;<i>                              self.transport.loseConnection()))
</I>&gt;<i>
</I>&gt;<i>And here's my modified version:
</I>&gt;<i>
</I>&gt;<i>class FingerProtocol(basic.LineReceiver):
</I>&gt;<i>    @defer.inlineCallbacks
</I>&gt;<i>    def lineReceived(self, user):
</I>&gt;<i>        try:
</I>&gt;<i>            data = yield self.factory.getUser(user)
</I>&gt;<i>        except Exception:
</I>&gt;<i>            data = &quot;Internal error in server&quot;
</I>&gt;<i>        self.transport.write(data + &quot;\r\n&quot;)
</I>&gt;<i>        self.transport.loseConnection()
</I>&gt;<i>
</I>&gt;<i>For some reason, in my version, the connection is getting terminated
</I>&gt;<i>before any writes can take place.  Even if I comment out the
</I>&gt;<i>loseConnection line, still nothing goes across to the client and the
</I>&gt;<i>connection still gets terminated.
</I>&gt;<i>
</I>&gt;<i>Could anyone tell me where I'm going wrong on this?  Thanks in advance.
</I>
By decorating your lineReceived with inlineCallbacks, you made it return
a Deferred.  If lineReceived returns non-None, the protocol disconnects
itself.

One solution would be to put your inlineCallbacks-decorated generator
code into another function, call it from lineReceived, and discard the
return value.

This preserves a minor problem with your current implementation though,
which is that if a client sends you two lines and the Deferred returned
by the second call to getUser fires first, you'll write out the second
user's info and then close the connection.  This isn't a major flaw for
a finger server to have, since a client is only allowed to send you one
line, but it's something to keep in mind if you use inlineCallbacks in
a more complicated application.

Jean-Paul

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004029.html">[Twisted-web] finger tutorial: problems rewriting finger08.py to
 use inlineCallbacks
</A></li>
	<LI>Next message: <A HREF="004031.html">[Twisted-web] possible bug in t.web.wsgi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4030">[ date ]</a>
              <a href="thread.html#4030">[ thread ]</a>
              <a href="subject.html#4030">[ subject ]</a>
              <a href="author.html#4030">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
