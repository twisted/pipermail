From nico at tekNico.net  Thu Dec  1 02:12:03 2005
From: nico at tekNico.net (Nicola Larosa)
Date: Thu Dec  1 02:14:52 2005
Subject: [Twisted-web] Re: lightweight forms thing for use with athena ???
In-Reply-To: <438E9C80.4060700@ivsn.com>
References: <438E9C80.4060700@ivsn.com>
Message-ID: <dmmep4$bhh$1@sea.gmane.org>

> Is there any kind of work on this target?
> - yes: I'd like to join to share and push the efforts!
> - not: Is somebody looking for the same, so it make sense to publish
>        partial results of my work?

It surely makes sense, count me in. :-)

-- 
Nicola Larosa - nico@tekNico.net

On a personal note, Xara is the main reason why I still haven't switched
to a Linux desktop for myself. I can't live without my Xara... now it
looks like I'll finally be able to switch! Tonight, I will literally go
out and toast to Xara. This is the best news I've had in months.
  -- GooseKirk on Slashdot, October 2005


From tv at twistedmatrix.com  Thu Dec  1 02:27:17 2005
From: tv at twistedmatrix.com (Tommi Virtanen)
Date: Thu Dec  1 02:27:24 2005
Subject: [Twisted-web] Error output for bad deferred method signatures?
In-Reply-To: <20051130170411.12910.qmail@web31515.mail.mud.yahoo.com>
References: <20051130170411.12910.qmail@web31515.mail.mud.yahoo.com>
Message-ID: <438EC1F5.7080608@twistedmatrix.com>

Lenny G Arbage wrote:
> 'test(respOrErr, msg)'.  What isn't clear [to me] is
> why this doesn't produce an error upon firing the
> deferred, but instead produces an error when the
> reactor shuts down [via ctrl-c], which could be hours
> later.

It does. But as the error happens inside your Deferred
chain, it will sit there waiting for an errback to be
added, which would handle it. At shutdown you see debug
output telling you forgot to handle errors in your
Deferred chain.

Add d.addErrback(log.err) after all the other deferred
handling and errors in the deferred chain will cause log
output and will not get complained about.

From alengarbage at yahoo.com  Thu Dec  1 09:28:09 2005
From: alengarbage at yahoo.com (Lenny G Arbage)
Date: Thu Dec  1 09:28:11 2005
Subject: [Twisted-web] Error output for bad deferred method signatures?
In-Reply-To: <438EC1F5.7080608@twistedmatrix.com>
Message-ID: <20051201162809.27633.qmail@web31508.mail.mud.yahoo.com>

Perfect.  This works as described, and your
explanation makes perfect sense.

I'm wondering though, if there is a way to do this
globally without specifying another errBack for every
deferred I call (which, right now numbers about 60 in
my little app)?  This would be useful for debugging
only, of course -- but that's where I'd like to save
the several hours trying to figure out why my
callbacks weren't firing for the next time I forget to
check that all err/callbacks have the correct
signatures.

  Thanks again,
  Lenny


--- Tommi Virtanen <tv@twistedmatrix.com> wrote:

> Lenny G Arbage wrote:
> > 'test(respOrErr, msg)'.  What isn't clear [to me]
> is
> > why this doesn't produce an error upon firing the
> > deferred, but instead produces an error when the
> > reactor shuts down [via ctrl-c], which could be
> hours
> > later.
> 
> It does. But as the error happens inside your
> Deferred
> chain, it will sit there waiting for an errback to
> be
> added, which would handle it. At shutdown you see
> debug
> output telling you forgot to handle errors in your
> Deferred chain.
> 
> Add d.addErrback(log.err) after all the other
> deferred
> handling and errors in the deferred chain will cause
> log
> output and will not get complained about.
> 
> _______________________________________________
> Twisted-web mailing list
> Twisted-web@twistedmatrix.com
>
http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
> 



		
__________________________________ 
Yahoo! Music Unlimited 
Access over 1 million songs. Try it free. 
http://music.yahoo.com/unlimited/

From doug at isotoma.com  Thu Dec  1 10:02:10 2005
From: doug at isotoma.com (Doug Winter)
Date: Thu Dec  1 10:02:15 2005
Subject: [Twisted-web] lightweight forms thing for use with athena ???
In-Reply-To: <438E9C80.4060700@ivsn.com>
References: <438E9C80.4060700@ivsn.com>
Message-ID: <438F2C92.1080906@isotoma.com>

Paul Reznicek wrote:
> - yes: I'd like to join to share and push the efforts!
> - not: Is somebody looking for the same, so it make sense to publish
>        partial results of my work?

I'm definitely up for helping.  I have some scarily complicated live
forms stuff I'm going to be needing for athena.  Lets get cracking :)

doug.


-- 
doug@isotoma.com   / Isotoma, Open Source Software Consulting
Tel: 020 7620 1446 / Mobile: 07879 423002 / Fax: 020 79006980
Skype: dougwinter  / http://www.isotoma.com
Lincoln House, 75 Westminster Bridge Road, London, SE1 7HS

From hartshorne at gmail.com  Thu Dec  1 10:13:16 2005
From: hartshorne at gmail.com (Beau Hartshorne)
Date: Thu Dec  1 10:13:20 2005
Subject: [Twisted-web] LivePage and Safari
Message-ID: <F020BCD4-849B-452A-9E10-6E96F98E69F4@gmail.com>

When I loaded up the Chatola demo, I noticed that Safari (2.0.2) was  
still "loading" the page. I sat there waiting for a few seconds  
before I realized that it would never stop because of the way the  
LivePage works. (Yes, I'm brand-new.) The first time, I clicked on  
Stop and of course nothing worked.

To work around the problem, I included the LivePage code in the  
<head>, and added an onload handler to <body> to call connect(0).  
This didn't fix it, so I changed it to setTimeout('connect()', 1).  
That worked, Safari no longer tells the user that it's waiting for  
the page to load.

This seems like a Safari bug, but would it make sense to patch the  
Nevow code with this work-around? Where do you get started to submit  
a change like this?

Thanks!
Beau

From dialtone at divmod.com  Thu Dec  1 10:19:17 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Thu Dec  1 10:19:20 2005
Subject: [Twisted-web] lightweight forms thing for use with athena ???
In-Reply-To: <438E9C80.4060700@ivsn.com>
References: <438E9C80.4060700@ivsn.com>
Message-ID: <20051201171917.GA9691@divmod.com>

On Thu, Dec 01, 2005 at 07:47:28AM +0100, Paul Reznicek wrote:
> I'm looking for a solution to replace formless.annotate.XX with a live 
> version
> of forms, whereby among other things:
> - required fields labels are *bold* as long as they are empty or with wrong
>   content and after leaving the input field, the label change accordingly
> - value checked input's labels are *red* as long as the entered value did 
> not
>   match the allowed range of values (+ there could be a live usage hint,
>   displayed only during the input has wrong/missing value)
> - the fire (submit) button is disabled as long as the form is not complete
>   [+ maybe change the value from _('Please fill all necessary fields')
>      to _('Process') depending on form status]
> - there can be more buttons with special functions, i.ex.: date manipulation
>   (now | +/- day/month/year) for date entry fields and lot of others
> - and of course all of this usable together with i18n part of Nevow, so that
>   the messages and labels are in the user's selected language ...

I suggest hacking forms package from mg that already provides most if not all
the features you listed above.

this is the svn address: svn://pollenation.net/forms/trunk
and this is the url of the trac instance:
http://forms-project.pollenation.net/cgi-bin/trac.cgi/newticket
to add a new ticket for 'live' feature.

Currently forms looks for __nevow_form__ in the url.

I suggest something like this as API for the live form.

f = forms.Form(callback, athena=True)
...


This will make the form use a different action like: __nevow_athena_form__ to
activate a response using athena itself. The rest of the form library should
(and I'd say must) be reused.

Another, I think still missing, bit is the complete and full customization of
the form look. This is already partly available by modifying form.FormRenderer
object in particular the loader attribute but currently each widget has an
hardcoded look while there should be a parameter to activate a self provided
representation of the widget in some way (the main problem is the presence of
<br /> elements that are not styleable.

> Is there any kind of work on this target?
> - yes: I'd like to join to share and push the efforts!
> - not: Is somebody looking for the same, so it make sense to publish
>        partial results of my work?

Hope the above satisfies this question.

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051201/861291f5/attachment.pgp
From dialtone at divmod.com  Thu Dec  1 10:24:19 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Thu Dec  1 10:24:12 2005
Subject: [Twisted-web] LivePage and Safari
In-Reply-To: <F020BCD4-849B-452A-9E10-6E96F98E69F4@gmail.com>
References: <F020BCD4-849B-452A-9E10-6E96F98E69F4@gmail.com>
Message-ID: <20051201172419.GB9691@divmod.com>

On Thu, Dec 01, 2005 at 12:13:16PM -0500, Beau Hartshorne wrote:

I'm not a javascript or Safari expert but...

> When I loaded up the Chatola demo, I noticed that Safari (2.0.2) was  
> still "loading" the page. I sat there waiting for a few seconds  
> before I realized that it would never stop because of the way the  
> LivePage works. (Yes, I'm brand-new.) The first time, I clicked on  
> Stop and of course nothing worked.

The problem is that the livepage opens a connection from the browser to the
server after the rendering is complete. This makes the browser believe the
page has still to finish rendering and keeps the loading up.

I'm unsure if this has to be considered a bug or a different implementation
but it is indeed annoying.

> To work around the problem, I included the LivePage code in the  
> <head>, and added an onload handler to <body> to call connect(0).  
> This didn't fix it, so I changed it to setTimeout('connect()', 1).  
> That worked, Safari no longer tells the user that it's waiting for  
> the page to load.

LivePage is about to be deprecated in favour of Athena but this fix still
makes sense for Athena too (since the same problem is available there).
I think patching both makes sense and if using the timeout actually fixes the
problem without breaking functionality then be it. :).

> This seems like a Safari bug, but would it make sense to patch the  
> Nevow code with this work-around? Where do you get started to submit  
> a change like this?

In the nevow bug tracker.

http://divmod.org/trac/newticket

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051201/1a252c56/attachment.pgp
From hartshorne at gmail.com  Thu Dec  1 10:57:20 2005
From: hartshorne at gmail.com (Beau Hartshorne)
Date: Thu Dec  1 10:57:23 2005
Subject: [Twisted-web] LivePage and Safari
In-Reply-To: <20051201172419.GB9691@divmod.com>
References: <F020BCD4-849B-452A-9E10-6E96F98E69F4@gmail.com>
	<20051201172419.GB9691@divmod.com>
Message-ID: <391A0CE5-A00D-41CF-A314-60A35E3A39CF@gmail.com>

> I'm unsure if this has to be considered a bug or a different  
> implementation
> but it is indeed annoying.

I checked on #webkit, and they said it may be a Safari bug. They  
invited me to submit it to WebKit's bugzilla.

> LivePage is about to be deprecated in favour of Athena but this fix  
> still
> makes sense for Athena too (since the same problem is available  
> there).
> I think patching both makes sense and if using the timeout actually  
> fixes the
> problem without breaking functionality then be it. :).

It doesn't seem to cause any problems with Safari, Firefox or IE.  
Does the perpetual loading problem exist in any other browsers?

> In the nevow bug tracker.
>
> http://divmod.org/trac/newticket

Does someone have an active installation of Chatola that we could use  
to demonstrate the reduction (for trac and bugzilla)?

Thanks,
Beau

From dialtone at divmod.com  Thu Dec  1 11:28:57 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Thu Dec  1 11:28:57 2005
Subject: [Twisted-web] LivePage and Safari
In-Reply-To: <391A0CE5-A00D-41CF-A314-60A35E3A39CF@gmail.com>
References: <F020BCD4-849B-452A-9E10-6E96F98E69F4@gmail.com>
	<20051201172419.GB9691@divmod.com>
	<391A0CE5-A00D-41CF-A314-60A35E3A39CF@gmail.com>
Message-ID: <20051201182857.GC9691@divmod.com>

On Thu, Dec 01, 2005 at 12:57:20PM -0500, Beau Hartshorne wrote:
> I checked on #webkit, and they said it may be a Safari bug. They  
> invited me to submit it to WebKit's bugzilla.

Then I think it's ok to work around it until it is not needed anymore.

> It doesn't seem to cause any problems with Safari, Firefox or IE.  
> Does the perpetual loading problem exist in any other browsers?

Not that I know of.

> Does someone have an active installation of Chatola that we could use  
> to demonstrate the reduction (for trac and bugzilla)?

http://divmod.org:8081/chatola/

All nevow examples are running under http://divmod.org:8081/

Thanks for the help :)

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051201/bbcf3e2e/attachment.pgp
From matt.feifarek at gmail.com  Thu Dec  1 14:16:43 2005
From: matt.feifarek at gmail.com (Matt Feifarek)
Date: Thu Dec  1 14:16:45 2005
Subject: [Twisted-web] Strange crash with custom resource code
Message-ID: <6fb6dbfe0512011316g338bb738q54a204af21f45328@mail.gmail.com>

I recently moved an existing twisted http app from Twisted 1.x to 2.1,
and am having a strange traceback that I can't track down.

My code renders jpeg images on-the-fly via a spawnProcess() on the
reactor. It used to work fine, and it still seems to work (though very
very slowly).

I'm getting tons of tracebacks at the console that launched the reactor:

Unhandled error in Deferred:
Traceback (most recent call last):
  File "/usr/lib/python2.4/site-packages/twisted/internet/defer.py",
line 294, in _startRunCallbacks
    self._runCallbacks()
  File "/usr/lib/python2.4/site-packages/twisted/internet/defer.py",
line 307, in _runCallbacks
    self.result = callback(self.result, *args, **kw)
  File "/usr/lib/python2.4/site-packages/twisted/internet/defer.py",
line 229, in callback
    self._startRunCallbacks(result)
  File "/usr/lib/python2.4/site-packages/twisted/internet/defer.py",
line 294, in _startRunCallbacks
    self._runCallbacks()
--- <exception caught here> ---
  File "/usr/lib/python2.4/site-packages/twisted/internet/defer.py",
line 307, in _runCallbacks
    self.result = callback(self.result, *args, **kw)
  File "/usr/local/lib/python2.4/site-packages/Wrangler/render/image/__init__.py
", line 132, in postConvert_Success
    Inline_Generic.render_present( self, args[0] )
  File "/usr/local/lib/python2.4/site-packages/Wrangler/render/generic.py",
line  131, in render_present
    static.FileTransfer(f, size, request)
  File "/usr/lib/python2.4/site-packages/twisted/web/static.py", line
413, in __init__
    request.registerProducer(self, 0)
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
583, in registerProducer
    self.transport.registerProducer(producer, streaming)
  File "/usr/lib/python2.4/site-packages/twisted/internet/abstract.py",
line 273, in registerProducer
    producer.resumeProducing()
  File "/usr/lib/python2.4/site-packages/twisted/python/hook.py", line
153, in newfunc
    return getattr(klass, ORIG(klass, name))(*args, **kw)
  File "/usr/lib/python2.4/site-packages/twisted/web/static.py", line
426, in resumeProducing
    self.request.finish()
  File "/usr/lib/python2.4/site-packages/twisted/web/server.py", line
265, in finish
    http.Request.finish(self)
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
630, in finish
    self._cleanup()
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
437, in _cleanup
    self.channel.requestDone(self)
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
1058, in requestDone
    self.requests[0].noLongerQueued()
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
468, in noLongerQueued
    self.transport.registerProducer(self.producer, self.streamingProducer)
  File "/usr/lib/python2.4/site-packages/twisted/internet/abstract.py",
line 273, in registerProducer
    producer.resumeProducing()
  File "/usr/lib/python2.4/site-packages/twisted/python/hook.py", line
153, in newfunc
    return getattr(klass, ORIG(klass, name))(*args, **kw)
  File "/usr/lib/python2.4/site-packages/twisted/web/static.py", line
426, in resumeProducing
    self.request.finish()
  File "/usr/lib/python2.4/site-packages/twisted/web/server.py", line
265, in finish
    http.Request.finish(self)
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
630, in finish
    self._cleanup()
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
437, in _cleanup
    self.channel.requestDone(self)
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
1058, in requestDone
    self.requests[0].noLongerQueued()
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
468, in noLongerQueued
    self.transport.registerProducer(self.producer, self.streamingProducer)
  File "/usr/lib/python2.4/site-packages/twisted/internet/abstract.py",
line 273, in registerProducer
    producer.resumeProducing()
  File "/usr/lib/python2.4/site-packages/twisted/python/hook.py", line
153, in newfunc
    return getattr(klass, ORIG(klass, name))(*args, **kw)
  File "/usr/lib/python2.4/site-packages/twisted/web/static.py", line
426, in resumeProducing
    self.request.finish()
  File "/usr/lib/python2.4/site-packages/twisted/web/server.py", line
265, in finish
    http.Request.finish(self)
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
630, in finish
    self._cleanup()
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
437, in _cleanup
    self.channel.requestDone(self)
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
1058, in requestDone
    self.requests[0].noLongerQueued()
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
472, in noLongerQueued
    self._cleanup()
  File "/usr/lib/python2.4/site-packages/twisted/web/http.py", line
437, in _cleanup
    self.channel.requestDone(self)
exceptions.AttributeError: Request instance has no attribute 'channel'

Very little of that traceback refers to any of my own code, so I don't
know how to begin digging in for what I've done wrong. My suspicion is
that it's a matter of minor api changes in the Resource class, but I
can't find any migration documentation on twistedmatrix.com.

If anyone could give me a track to start my digging, I'd appreciate it.

Thanks!

From abe at fettig.net  Thu Dec  1 21:53:01 2005
From: abe at fettig.net (Abe Fettig)
Date: Thu Dec  1 21:50:22 2005
Subject: [Twisted-web] LivePage and Safari
In-Reply-To: <F020BCD4-849B-452A-9E10-6E96F98E69F4@gmail.com>
References: <F020BCD4-849B-452A-9E10-6E96F98E69F4@gmail.com>
Message-ID: <438FD32D.80508@fettig.net>

Beau Hartshorne wrote:
> When I loaded up the Chatola demo, I noticed that Safari (2.0.2) was 
> still "loading" the page. I sat there waiting for a few seconds  before
> I realized that it would never stop because of the way the  LivePage
> works. (Yes, I'm brand-new.) The first time, I clicked on  Stop and of
> course nothing worked.
> 
> To work around the problem, I included the LivePage code in the  <head>,
> and added an onload handler to <body> to call connect(0).  This didn't
> fix it, so I changed it to setTimeout('connect()', 1).  That worked,
> Safari no longer tells the user that it's waiting for  the page to load.

Thanks a lot for figuring this out. This has been an annoyance on
JotSpot Live, and I'm happy to have a solution. I'd suggest:

setTimeout(function(){connect()}, 1)

as a slightly nicer way to phrase that. I'm testing this locally and it
looks good - I'll be deploying it on JotSpot Live soon unless I run into
any problems.

Abe

From suetlung2003 at yahoo.com.hk  Thu Dec  1 21:54:48 2005
From: suetlung2003 at yahoo.com.hk (Suet Lung Cheung)
Date: Thu Dec  1 21:54:51 2005
Subject: [Twisted-web] How to wait for a deferred object?
Message-ID: <20051202045448.51823.qmail@web51915.mail.yahoo.com>

  Hi everyone,
  
 I am writing a TCP server program using twisted. I cannot use pb since the client side is not in python. I decided to use twisted.application and run it as internet.TCPServer(...). My problem is that I want to make it save something to a database whenever a connection closed. I do this in returning a deferred under Protocol.connectionLost(). I would like to make this work when the server is shut down. However when the server is down, it doesn't wait for the deferred to finish the callback and quit. I would like to make it save to db as normal but the server will wait for all deferred has called back.  Is there anyway I can do this? Any suggestions? Thanks a lot
  
  Snow Dragon

_______________________________________
 x息 - Yahoo! Messenger
 就算你]有上W，你的朋友仍可以留下息o你，你上Wr就能立即看到，任何f都幼呤А
  http://messenger.yahoo.com.hk 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20051202/66bdea1a/attachment.htm
From exarkun at divmod.com  Fri Dec  2 00:28:22 2005
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Fri Dec  2 00:28:27 2005
Subject: [Twisted-web] How to wait for a deferred object?
In-Reply-To: <20051202045448.51823.qmail@web51915.mail.yahoo.com>
Message-ID: <20051202072822.1217.276316636.divmod.quotient.2657@ohm>

On Fri, 2 Dec 2005 12:54:48 +0800 (CST), Suet Lung Cheung <suetlung2003@yahoo.com.hk> wrote:
>  Hi everyone,
>
> I am writing a TCP server program using twisted. I cannot use pb since the client side is not in python. I decided to use twisted.application and run it as internet.TCPServer(...). My problem is that I want to make it save something to a database whenever a connection closed. I do this in returning a deferred under Protocol.connectionLost(). I would like to make this work when the server is shut down. However when the server is down, it doesn't wait for the deferred to finish the callback and quit. I would like to make it save to db as normal but the server will wait for all deferred has called back.  Is there anyway I can do this? Any suggestions? Thanks a lot

Services receive shutdown notification via their stopService() method.  The method is called all the way down the service hierarchy when a twistd process is preparing to terminate.  If a stopService() method returns a Deferred, the Deferred will be allowed to fire before shutdown completes.  So you probably want a custom Service implementation which knows about the Deferreds from your connectionLost() and can return them from stopService() if necessary.

Jean-Paul

From tv at twistedmatrix.com  Fri Dec  2 01:11:18 2005
From: tv at twistedmatrix.com (Tommi Virtanen)
Date: Fri Dec  2 01:11:36 2005
Subject: [Twisted-web] Error output for bad deferred method signatures?
In-Reply-To: <20051201162809.27633.qmail@web31508.mail.mud.yahoo.com>
References: <20051201162809.27633.qmail@web31508.mail.mud.yahoo.com>
Message-ID: <439001A6.8050501@twistedmatrix.com>

Lenny G Arbage wrote:
> I'm wondering though, if there is a way to do this
> globally without specifying another errBack for every
> deferred I call (which, right now numbers about 60 in
> my little app)?  This would be useful for debugging
> only, of course -- but that's where I'd like to save
> the several hours trying to figure out why my
> callbacks weren't firing for the next time I forget to
> check that all err/callbacks have the correct
> signatures.

There already is a global debug output if nothing handled
the error (last errback run should return e.g. None).
The traceback is dumped to the log. But it is only run
when the Deferred is garbace collected, so if something
that has infinite lifetime holds a reference to it, it
won't be triggered until shutdown. There's no way to do
this globally earlier, because you don't know whether
a new errback will be added later..

From suetlung2003 at yahoo.com.hk  Sun Dec  4 20:52:11 2005
From: suetlung2003 at yahoo.com.hk (Suet Lung Cheung)
Date: Sun Dec  4 20:52:13 2005
Subject: =?big5?q?=A6^=C2=D0=A1G=20Re:=20[Twisted-web]=20How=20to=20wait=20for=20a?=
	=?big5?q?=20deferred=20object=3F?=
In-Reply-To: <20051202072822.1217.276316636.divmod.quotient.2657@ohm>
Message-ID: <20051205035211.21112.qmail@web51915.mail.yahoo.com>

Hi Paul,
     Thanks for your help. However it seems doesn't work. When I press Ctrl-C, it even doesn't call the stopService() function. I print a "Hello World" inside the function but it doesn't say hello to the world. And I've tried returning a Deferred from this function. However it quit before the callback is called. Can u give advice on this? Do u know where can I find some example about this? Thanks a lot.
 
 Snow Dragon

Jean-Paul Calderone <exarkun@divmod.com> 弧G On Fri, 2 Dec 2005 12:54:48 +0800 (CST), Suet Lung Cheung  wrote:
>  Hi everyone,
>
> I am writing a TCP server program using twisted. I cannot use pb since the client side is not in python. I decided to use twisted.application and run it as internet.TCPServer(...). My problem is that I want to make it save something to a database whenever a connection closed. I do this in returning a deferred under Protocol.connectionLost(). I would like to make this work when the server is shut down. However when the server is down, it doesn't wait for the deferred to finish the callback and quit. I would like to make it save to db as normal but the server will wait for all deferred has called back. Is there anyway I can do this? Any suggestions? Thanks a lot

Services receive shutdown notification via their stopService() method. The method is called all the way down the service hierarchy when a twistd process is preparing to terminate. If a stopService() method returns a Deferred, the Deferred will be allowed to fire before shutdown completes. So you probably want a custom Service implementation which knows about the Deferreds from your connectionLost() and can return them from stopService() if necessary.

Jean-Paul

_______________________________________________
Twisted-web mailing list
Twisted-web@twistedmatrix.com
http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web



_______________________________________
 x息 - Yahoo! Messenger
 就算你]有上W，你的朋友仍可以留下息o你，你上Wr就能立即看到，任何f都幼呤А
  http://messenger.yahoo.com.hk 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20051205/28baa7bf/attachment.htm
From exarkun at divmod.com  Sun Dec  4 22:24:38 2005
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Sun Dec  4 22:24:40 2005
Subject: =?utf-8?b?UmU6IOWbnuimhu+8miBSZTogW1R3aXN0ZWQtd2ViXSBIb3cgdG8g?=
	=?utf-8?q?wait_for_a_deferred_object=3F?=
In-Reply-To: <20051205035211.21112.qmail@web51915.mail.yahoo.com>
Message-ID: <20051205052438.1217.492449739.divmod.quotient.3259@ohm>

On Mon, 5 Dec 2005 11:52:11 +0800 (CST), Suet Lung Cheung <suetlung2003@yahoo.com.hk> wrote:
>Hi Paul,
>     Thanks for your help. However it seems doesn't work. When I press Ctrl-C, it even doesn't call the stopService() function. I print a "Hello World" inside the function but it doesn't say hello to the world. And I've tried returning a Deferred from this function. However it quit before the callback is called. Can u give advice on this? Do u know where can I find some example about this? Thanks a lot.
>
> Snow Dragon
>

exarkun@boson:~$ cat > stop-service.py
from twisted.application import service
application = service.Application("stop-service demo")

class Demo(service.Service):
  def stopService(self):
    print "Stopping!"
Demo().setServiceParent(application)
exarkun@boson:~$ twistd -noy stop-service.py 
2005/12/05 00:23 EST [-] Log opened.
2005/12/05 00:23 EST [-] twistd SVN-Trunk (/usr/bin/python 2.4.2) starting up
2005/12/05 00:23 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor
2005/12/05 00:23 EST [-] Loading stop-service.py...
2005/12/05 00:23 EST [-] Loaded.
2005/12/05 00:23 EST [-] Received SIGINT, shutting down.
2005/12/05 00:23 EST [-] Stopping!       < - - - - - - - - - stopService
2005/12/05 00:23 EST [-] Main loop terminated.
2005/12/05 00:23 EST [-] Server Shut Down.
exarkun@boson:~$ 

Jean-Paul

From suetlung2003 at yahoo.com.hk  Sun Dec  4 23:52:27 2005
From: suetlung2003 at yahoo.com.hk (Suet Lung Cheung)
Date: Sun Dec  4 23:52:30 2005
Subject: =?big5?q?=A6^=C2=D0=A1G=20Re:=20=A6^=C2=D0=A1G=20Re:=20[Twisted-web]=20Ho?=
	=?big5?q?w=20to=20wait=20for=20a=20deferred=20object=3F?=
In-Reply-To: <20051205052438.1217.492449739.divmod.quotient.3259@ohm>
Message-ID: <20051205065227.36225.qmail@web51912.mail.yahoo.com>

Hi Paul,
     Thanks for your reply again. Your example works for me. I found the difference. I use a serviceCollection to include my service. Does it mean anything? my code is in this way...
 application = service.Application('chatroom')
 
 f = ChatService()
 serviceCollection = service.IServiceCollection(application)
 internet.TCPServer (1234, ChatFactoryFromService(f)).setServiceParent(serviceCollection)
 
and I have implemented stopService() in ChatService. Is it different if I use serviceCollection? Thanks again.
 
 Snow Dragon
 
Jean-Paul Calderone <exarkun@divmod.com> 弧G On Mon, 5 Dec 2005 11:52:11 +0800 (CST), Suet Lung Cheung  wrote:
>Hi Paul,
> Thanks for your help. However it seems doesn't work. When I press Ctrl-C, it even doesn't call the stopService() function. I print a "Hello World" inside the function but it doesn't say hello to the world. And I've tried returning a Deferred from this function. However it quit before the callback is called. Can u give advice on this? Do u know where can I find some example about this? Thanks a lot.
>
> Snow Dragon
>

exarkun@boson:~$ cat > stop-service.py
from twisted.application import service
application = service.Application("stop-service demo")

class Demo(service.Service):
  def stopService(self):
    print "Stopping!"
Demo().setServiceParent(application)
exarkun@boson:~$ twistd -noy stop-service.py 
2005/12/05 00:23 EST [-] Log opened.
2005/12/05 00:23 EST [-] twistd SVN-Trunk (/usr/bin/python 2.4.2) starting up
2005/12/05 00:23 EST [-] reactor class: twisted.internet.selectreactor.SelectReactor
2005/12/05 00:23 EST [-] Loading stop-service.py...
2005/12/05 00:23 EST [-] Loaded.
2005/12/05 00:23 EST [-] Received SIGINT, shutting down.
2005/12/05 00:23 EST [-] Stopping!       < - - - - - - - - - stopService
2005/12/05 00:23 EST [-] Main loop terminated.
2005/12/05 00:23 EST [-] Server Shut Down.
exarkun@boson:~$ 

Jean-Paul

_______________________________________________
Twisted-web mailing list
Twisted-web@twistedmatrix.com
http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web



_______________________________________
 x息 - Yahoo! Messenger
 就算你]有上W，你的朋友仍可以留下息o你，你上Wr就能立即看到，任何f都幼呤А
  http://messenger.yahoo.com.hk 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20051205/ab94eaec/attachment.htm
From maillists at ivsn.com  Mon Dec  5 01:24:51 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Mon Dec  5 01:25:36 2005
Subject: [Twisted-web] Re: Athena Forms Thing [was: lightweight forms thing
 for use with athena ???]
In-Reply-To: <43900CA3.907@isotoma.com>
References: <43900CA3.907@isotoma.com>
Message-ID: <4393F953.3020303@ivsn.com>

Doug Winter wrote:
> ...
> Dialtone is right to suggest using mg's form library ...
> 

Nice, and Doug convinced me to try Matt's "forms", especially because
each input block (i.e. including it's label and required message)
has it's own id and very sophisticated class combination, so it is
predestined to go alive with athena ...

When you get the current version from:
    svn://pollenation.net/forms/trunk
and can not start the
    twistd -noy examples.tac
try attached patch of forms/examples/main.py, it helped me ...

Paul

(P.S.: Sorry, Doug, I sent to wrong address before ...)

-------------- next part --------------
Index: examples/main.py 
=================================================================== 
--- examples/main.py	(Revision 140) 
+++ examples/main.py	(Arbeitskopie) 
@@ -1,4 +1,7 @@ 
-import pkg_resources 
+try: 
+    from pkg_resources import resource_filename 
+except ImportError: 
+    from nevow.util import resource_filename 
 from twisted.python import reflect 
 from nevow import appserver, loaders, rend, static, tags as T, url 
 import forms 
@@ -98,6 +101,6 @@ 
  
  
 # Add child_ attributes 
-examples_css = pkg_resources.resource_filename('forms.examples', 'examples.css') 
+examples_css = resource_filename('forms.examples', 'examples.css') 
 setattr(RootPage, 'child_examples.css', static.File(examples_css)) 
 setattr(RootPage, 'child_forms.css', forms.defaultCSS) 

From agoryunov at list.ru  Mon Dec  5 11:16:05 2005
From: agoryunov at list.ru (A. Goryunov)
Date: Mon Dec  5 11:16:10 2005
Subject: [Twisted-web] Using deferreds to render a page
Message-ID: <439483E5.1060204@list.ru>

I might be just dumb, but I can't figure out the correct way to do what 
the following passage from Twisted.web's Howto suggests:

"/Request a |Deferred|, return |server.NOT_DONE_YET|, and call 
|request.write("stuff")| and |request.finish()| later, in a callback on 
the |Deferred|/."

How do I get at the request object from a callback function? All the 
documentation on Deferreds that I managed to find uses print's to 
display results, but that doesn't help any, since I intend to present 
output to a remote user rather than myself. For now I've settled with 
using the following method:

class PrintResult(object):

    def __init__(self, request):

        self.request = request

        

    def __call__(self, *args):

        l = args[0]

        if l:

            self.request.write("<html>ID is %s</html>" % str(l[0][0]))

        else:

            self.request.write( "<html>No ID found</html>")

        self.request.finish()

        return server.NOT_DONE_YET


So that the request is stored inside the callback itself, but this 
somehow feels  wrong. Is there some standard way of doing this that I am 
missing?


From grant at osafoundation.org  Mon Dec  5 11:27:40 2005
From: grant at osafoundation.org (Grant Baillie)
Date: Mon Dec  5 11:28:58 2005
Subject: [Twisted-web] Using deferreds to render a page
In-Reply-To: <439483E5.1060204@list.ru>
References: <439483E5.1060204@list.ru>
Message-ID: <126C06B7-DFA3-4653-BFD4-227976400A59@osafoundation.org>

On Dec 5, 2005, at 10:16 , A. Goryunov wrote:

> I might be just dumb, but I can't figure out the correct way to do  
> what the following passage from Twisted.web's Howto suggests:
>
> "/Request a |Deferred|, return |server.NOT_DONE_YET|, and call | 
> request.write("stuff")| and |request.finish()| later, in a callback  
> on the |Deferred|/."
>
> How do I get at the request object from a callback function? All  
> the documentation on Deferreds that I managed to find uses print's  
> to display results, but that doesn't help any, since I intend to  
> present output to a remote user rather than myself. For now I've  
> settled with using the following method:
>
> class PrintResult(object):
>
>    def __init__(self, request):
>
>        self.request = request
>
>
>    def __call__(self, *args):
>
>        l = args[0]
>
>        if l:
>
>            self.request.write("<html>ID is %s</html>" % str(l[0][0]))
>
>        else:
>
>            self.request.write( "<html>No ID found</html>")
>
>        self.request.finish()
>
>        return server.NOT_DONE_YET
>
>
> So that the request is stored inside the callback itself, but this  
> somehow feels  wrong. Is there some standard way of doing this that  
> I am missing?

One way is to define the callback within the scope of request (and  
self, your Resource), and let Python do the rest for you. E.g.


def render_GET(self, request):

     def finishUp(result):
        # .... do something interesting with result ...

         request.finish()


     d = self.makeADeferred(request)
     d.addCallback(finishUp) # You also need an errback here!
     return server.NOT_DONE_YET

--Grant

Grant Baillie
Open Source Applications Foundation
http://www.osafoundation.org




From radeex at gmail.com  Mon Dec  5 13:48:02 2005
From: radeex at gmail.com (Christopher Armstrong)
Date: Mon Dec  5 13:48:05 2005
Subject: =?BIG5?B?UmU6IKZewtChRyBSZTogpl7C0KFHIFJlOiBbVHdpc3RlZC13ZWJdIA==?=
	=?BIG5?B?SG93IHRvIHdhaXQgZm9yIGEgZGVmZXJyZWQgb2JqZWN0Pw==?=
In-Reply-To: <20051205065227.36225.qmail@web51912.mail.yahoo.com>
References: <20051205052438.1217.492449739.divmod.quotient.3259@ohm>
	<20051205065227.36225.qmail@web51912.mail.yahoo.com>
Message-ID: <60ed19d40512051248q43e6c4fm72bdce0127008a0b@mail.gmail.com>

]On 12/5/05, Suet Lung Cheung <suetlung2003@yahoo.com.hk> wrote:
> Hi Paul,
>      Thanks for your reply again. Your example works for me. I found the
> difference. I use a serviceCollection to include my service. Does it mean
> anything? my code is in this way...
>  application = service.Application('chatroom')
>
>  f = ChatService()
>  serviceCollection = service.IServiceCollection(application)
>  internet.TCPServer (1234,
> ChatFactoryFromService(f)).setServiceParent(serviceCollection)
>
> and I have implemented stopService() in ChatService. Is it different if I
> use serviceCollection? Thanks again.

It looks like the problem here is that you're not setting your
ChatService's service parent to the application (by the way, you don't
need to adapt to IServiceCollection - setServiceParent tries to adapt
to IServiceCollection itself).

application = service.Application('chatroom')
f = ChatService()
f.setServiceParent(application)
...

should sort you out.



--
  Twisted   |  Christopher Armstrong: International Man of Twistery
   Radix    |    -- http://radix.twistedmatrix.com
            |  Release Manager, Twisted Project
  \\\V///   |    -- http://twistedmatrix.com
   |o O|    |
w----v----w-+

From andrew-twisted at puzzling.org  Mon Dec  5 16:26:41 2005
From: andrew-twisted at puzzling.org (Andrew Bennetts)
Date: Mon Dec  5 16:26:45 2005
Subject: [Twisted-web] Using deferreds to render a page
In-Reply-To: <439483E5.1060204@list.ru>
References: <439483E5.1060204@list.ru>
Message-ID: <20051205232641.GA16615@home.puzzling.org>

On Tue, Dec 06, 2005 at 04:16:05AM +1000, A. Goryunov wrote:
> I might be just dumb, but I can't figure out the correct way to do what 
> the following passage from Twisted.web's Howto suggests:
> 
> "/Request a |Deferred|, return |server.NOT_DONE_YET|, and call 
> |request.write("stuff")| and |request.finish()| later, in a callback on 
> the |Deferred|/."
> 
> How do I get at the request object from a callback function? All the 

You can pass extra arguments to callback functions.  So you can do e.g.:

    d.addCallback(callbackFunc, request)

And then define callbackFunc as:

    def callbackFunc(result, request):
        ...

Alternatively, as Grant suggests, you can use python's nested scopes to capture
the variable(s) you want.

-Andrew.


From maillists at ivsn.com  Mon Dec  5 19:39:00 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Mon Dec  5 19:39:35 2005
Subject: [Twisted-web] Re: Athena Forms Thing
In-Reply-To: <43900CA3.907@isotoma.com>
References: <43900CA3.907@isotoma.com>
Message-ID: <4394F9C4.3080307@ivsn.com>

Doug Winter wrote:
> ...
> Dialtone is right to suggest using mg's form library I think, and I'm up 
> for doing some hacking on this this weekend. ...

After testing Matt's "forms" I agree 100% that (except the AJAX features),
forms are capable for very sophisticated designs!

Your proposal on:
   http://forms-project.pollenation.net/cgi-bin/trac.cgi/wiki/ajax
is qualified too - this functionality could be a real base for high
interactive user interfaces.

After getting your ajax-forms branch with:
   svn checkout svn://pollenation.net/forms/branches/ajax-forms ajax-forms
I found your's first example - but not working too much. I was playing a bit
with it and attached is a patch how to get on the server-side some more live
into it.

Looking forward the next steps !!!

Paul
-------------- next part --------------
Index: aforms/event.py 
=================================================================== 
--- aforms/event.py	(Revision 147) 
+++ aforms/event.py	(Arbeitskopie) 
@@ -21,7 +21,7 @@ 
     def __init__(self, event, method, *args): 
         self.event = event 
         self.method = method 
-        self.args = args 
+        self.args = str(args)[2:-3] or '""' 
  
     def render(self, ctx): 
-        return "server.callRemote('%s')" % self.method 
+        return "server.callRemote('%s', %s)" % (self.method, self.args) 
Index: aforms/examples/simple.py 
=================================================================== 
--- aforms/examples/simple.py	(Revision 147) 
+++ aforms/examples/simple.py	(Arbeitskopie) 
@@ -1,3 +1,4 @@ 
+#! /usr/bin/env python 
  
 import pkg_resources 
 pkg_resources.require("forms") 
@@ -4,6 +5,8 @@ 
  
 from twisted.application import service 
 from twisted.application import internet 
+from twisted.python import util 
+from twisted.internet import reactor 
  
 from nevow import rend 
 from nevow import athena 
@@ -20,20 +23,43 @@ 
     ('baz', 'Baz'), 
 ] 
  
+from zope.interface import Interface 
+ 
+class ISimple(Interface): 
+    def keypressed(): 
+        pass 
+    def blur(): 
+        pass 
+    def async_submitted(): 
+        pass 
+ 
+class Simple(object): 
+    def keypressed(self, data): 
+        print 'keypressed', data 
+    def blur(self, data): 
+        print 'blur', data 
+    def async_submitted(self, data): 
+        print 'async_submitted', data 
+        reactor.stop() 
+ 
 class Page(forms.ResourceMixin, athena.LivePage): 
-    docFactory = loaders.xmlfile("aforms/examples/simple.html") 
+    docFactory = loaders.xmlfile( 
+            util.sibpath(__file__, 'simple.html'), ignoreComment=True) 
  
     def form_example(self, ctx): 
         form = aforms.Form() 
+        formIdPrefix = 'example' 
         wf = forms.widgetFactory( 
             aforms.TextArea, 
             events=( 
-                aforms.CallRemote('onkeyup', 'keypressed'), 
-                aforms.CallRemote('onblur', 'blur', 23), 
+                aforms.CallRemote('onkeyup', 'keypressed', 'this.value'), 
+                aforms.CallRemote('onblur', 'blur', 'this.value'), 
             ) 
         ) 
-        form.addField('aString', forms.String(), wf) 
-        form.addAsyncAction(aforms.CallRemote('onclick', 'async_submitted')) 
+        fieldName = 'aString' 
+        form.addField(fieldName, forms.String(), wf) 
+        form.addAsyncAction(aforms.CallRemote('onclick', 'async_submitted', 
+                'getValue("%s-%s")' % (formIdPrefix, fieldName) )) 
         return form 
  
     def submitted(self, ctx, form, data): 
@@ -44,11 +70,19 @@ 
         return url.URL.fromString('/app') 
  
     def child_app(self, ctx): 
-        page = Page((), None) 
+        page = Page(ISimple, Simple()) 
         return page 
  
 root = Root() 
 application = service.Application("test") 
-i = internet.TCPServer(9898, appserver.NevowSite(root,  logPath="/dev/null")) 
+i = internet.TCPServer(9898, appserver.NevowSite(root, ))# logPath="/dev/null")) 
 i.setServiceParent(application) 
  
+# with this, you can start this file directly, no need for twistd ... 
+if __name__ == '__main__': 
+    """Command Line Starter 
+    """ 
+    i.startService() 
+    print 'SERVICE STARTED' 
+    reactor.run() 
+    print 'reactor STOPPED' 
Index: aforms/examples/simple.html 
=================================================================== 
--- aforms/examples/simple.html	(Revision 147) 
+++ aforms/examples/simple.html	(Arbeitskopie) 
@@ -5,6 +5,14 @@ 
 <html xmlns:n="http://nevow.com/ns/nevow/0.1"> 
   <head> 
     <n:invisible n:render="liveglue" /> 
+    <script type='text/javascript' language='javascript'> 
+    // <![CDATA[ 
+    function getValue(fieldID) { 
+        return document.getElementById(fieldID).value; 
+    } 
+    // ]]> 
+    </script> 
+ 
   </head> 
   <body> 
     <form n:render="form example" /> 
From suetlung2003 at yahoo.com.hk  Mon Dec  5 20:07:21 2005
From: suetlung2003 at yahoo.com.hk (Suet Lung Cheung)
Date: Mon Dec  5 20:07:23 2005
Subject: =?big5?q?=A6^=C2=D0=A1G=20Re:=20=A6^=C2=D0=A1G=20Re:=20=A6^=C2=D0=A1G=20R?=
	=?big5?q?e:=20[Twisted-web]=20How=20to=20wait=20for=20a=20deferred=20obje?=
	=?big5?q?ct=3F?=
In-Reply-To: <60ed19d40512051248q43e6c4fm72bdce0127008a0b@mail.gmail.com>
Message-ID: <20051206030721.58319.qmail@web51915.mail.yahoo.com>

Thanks everybody, finally I've made it call the stopService(). However even I return a deferred in the stopService, it still quit before the callback is called. Can anyone give me an example of returning a deferred in stopService()? Thanks anyone.

Christopher Armstrong <radeex@gmail.com> 弧G ]On 12/5/05, Suet Lung Cheung  wrote:
> Hi Paul,
>      Thanks for your reply again. Your example works for me. I found the
> difference. I use a serviceCollection to include my service. Does it mean
> anything? my code is in this way...
>  application = service.Application('chatroom')
>
>  f = ChatService()
>  serviceCollection = service.IServiceCollection(application)
>  internet.TCPServer (1234,
> ChatFactoryFromService(f)).setServiceParent(serviceCollection)
>
> and I have implemented stopService() in ChatService. Is it different if I
> use serviceCollection? Thanks again.

It looks like the problem here is that you're not setting your
ChatService's service parent to the application (by the way, you don't
need to adapt to IServiceCollection - setServiceParent tries to adapt
to IServiceCollection itself).

application = service.Application('chatroom')
f = ChatService()
f.setServiceParent(application)
...

should sort you out.



--
  Twisted   |  Christopher Armstrong: International Man of Twistery
   Radix    |    -- http://radix.twistedmatrix.com
            |  Release Manager, Twisted Project
  \\\V///   |    -- http://twistedmatrix.com
   |o O|    |
w----v----w-+

_______________________________________________
Twisted-web mailing list
Twisted-web@twistedmatrix.com
http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web



_______________________________________
 x息 - Yahoo! Messenger
 就算你]有上W，你的朋友仍可以留下息o你，你上Wr就能立即看到，任何f都幼呤А
  http://messenger.yahoo.com.hk 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20051206/d1d10d53/attachment.htm
From maillists at ivsn.com  Wed Dec  7 08:59:58 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Wed Dec  7 09:00:39 2005
Subject: [Twisted-web] Nevow - how to render sequence into 3 column table
In-Reply-To: <20051201171917.GA9691@divmod.com>
References: <438E9C80.4060700@ivsn.com> <20051201171917.GA9691@divmod.com>
Message-ID: <439706FE.2050307@ivsn.com>

Hi all gurus,

have a list of dicts like:
   data = [
     {'name' : 'Alfred'}, {'age' : 15},
     {'name' : 'Mary'}, {'age' : 17},
     {'name' : 'Bob'}, {'age' : 25},
     ...
     {'name' : 'Molly'}, {'age' : 22},
     {'name' : 'Manfred'}, {'age' : 33},
   ]

!!! len(data)/3 is not a whole number !!!

The result should looks like:
   <table>
     <tr>
       <td>Alfred is 15</td>
       <td>Mary is 17</td>
       <td>Bob is 25</td>
     </tr>
     ...
     <tr>
       <td>Molly is 22</td>
       <td>Manfred is 33</td>
     </tr>
   </table>

Is in Nevow a way how to render this automatically using
"pattern" for each cell ?

Thanks for help,
Paul

From alberto.trujillo at ucd.ie  Wed Dec  7 09:05:07 2005
From: alberto.trujillo at ucd.ie (Alberto Trujillo)
Date: Wed Dec  7 09:05:12 2005
Subject: [Twisted-web] How to kill the session
Message-ID: <43970833.3020002@ucd.ie>

Hello everybody:

There is any way to kill all the session in Nevow? I mean, I'm loading a 
lot of variables in the session, and some times I need to get the 
session clear again, and it's very tedious set each variable to None. So 
if I coud kill all the session just with one sentences, or get a new one 
clean than replace the existing one, would be very helpfull for me.

Thank you very much.

From dialtone at divmod.com  Wed Dec  7 09:09:24 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Wed Dec  7 09:09:42 2005
Subject: [Twisted-web] Nevow - how to render sequence into 3 column table
In-Reply-To: <439706FE.2050307@ivsn.com>
References: <438E9C80.4060700@ivsn.com> <20051201171917.GA9691@divmod.com>
	<439706FE.2050307@ivsn.com>
Message-ID: <20051207160924.GC254@divmod.com>

On Wed, Dec 07, 2005 at 04:59:58PM +0100, Paul Reznicek wrote:
> Hi all gurus,
> 
> have a list of dicts like:
>   data = [
>     {'name' : 'Alfred'}, {'age' : 15},
>     {'name' : 'Mary'}, {'age' : 17},
>     {'name' : 'Bob'}, {'age' : 25},
>     ...
>     {'name' : 'Molly'}, {'age' : 22},
>     {'name' : 'Manfred'}, {'age' : 33},
>   ]
> 
> !!! len(data)/3 is not a whole number !!!
> 
> The result should looks like:
>   <table>
>     <tr>
>       <td>Alfred is 15</td>
>       <td>Mary is 17</td>
>       <td>Bob is 25</td>
>     </tr>
>     ...
>     <tr>
>       <td>Molly is 22</td>
>       <td>Manfred is 33</td>
>     </tr>
>   </table>
> 
> Is in Nevow a way how to render this automatically using
> "pattern" for each cell ?

Sure:

<table>
    <thead>
        <th>
            <td>Name</td>
            <td>Age</td>
       </th>
   </thead>
   <tbody n:data="data" n:render="sequence">
      <tr n:pattern="item" n:render="mapping">
          <td> <n:slot name="name" /> </td>
          <td> <n:slot name="age" />  </td>
      </tr>
   </tbody>
</table>

If you really want a pattern then write a new mapping that gathers some known
patterns from the enclosed html and fills the corresponding slots.

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051207/9a47ae3a/attachment.pgp
From maillists at ivsn.com  Wed Dec  7 09:12:23 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Wed Dec  7 09:12:57 2005
Subject: [Twisted-web] How to kill the session
In-Reply-To: <43970833.3020002@ucd.ie>
References: <43970833.3020002@ucd.ie>
Message-ID: <439709E7.1070508@ivsn.com>

Alberto Trujillo wrote:
> There is any way to kill all the session in Nevow? I mean, I'm loading a 
> lot of variables in the session, and some times I need to get the 
> session clear again, and it's very tedious set each variable to None. So 
> if I coud kill all the session just with one sentences, or get a new one 
> clean than replace the existing one, would be very helpfull for me.

Quite easy:
   session = inevow.ISession(ctx)
   session.expire()
   return url.here.up()   # or anything else to switch to the login page

Good luck,
Paul

From maillists at ivsn.com  Wed Dec  7 09:23:15 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Wed Dec  7 09:23:49 2005
Subject: [Twisted-web] Nevow - how to render sequence into 3 column table
In-Reply-To: <20051207160924.GC254@divmod.com>
References: <438E9C80.4060700@ivsn.com>
	<20051201171917.GA9691@divmod.com>	<439706FE.2050307@ivsn.com>
	<20051207160924.GC254@divmod.com>
Message-ID: <43970C73.7010202@ivsn.com>

Valentino Volonghi aka Dialtone wrote:
>> have a list of dicts like:
>>   data = [
>>     {'name' : 'Alfred'}, {'age' : 15},
>>     {'name' : 'Mary'}, {'age' : 17},
>>     {'name' : 'Bob'}, {'age' : 25},
>>     ...
>>     {'name' : 'Molly'}, {'age' : 22},
>>     {'name' : 'Manfred'}, {'age' : 33},
>>   ]
>>
>> !!! len(data)/3 is not a whole number !!!
>>
>> The result should looks like:
>>   <table>
>>     <tr>
>>       <td>Alfred is 15</td>
>>       <td>Mary is 17</td>
>>       <td>Bob is 25</td>
>>     </tr>
>>     ...
>>     <tr>
>>       <td>Molly is 22</td>
>>       <td>Manfred is 33</td>
>>     </tr>
>>   </table>
>>
>> Is in Nevow a way how to render this automatically using
>> "pattern" for each cell ?
> 
> Sure:
> 
> <table>
>     <thead>
>         <th>
>             <td>Name</td>
>             <td>Age</td>
>        </th>
>    </thead>
>    <tbody n:data="data" n:render="sequence">
>       <tr n:pattern="item" n:render="mapping">
>           <td> <n:slot name="name" /> </td>
>           <td> <n:slot name="age" />  </td>
>       </tr>
>    </tbody>
> </table>
> 
> If you really want a pattern then write a new mapping that gathers some known
> patterns from the enclosed html and fills the corresponding slots.

Hi Valentino,
thank you for quick response, but this is not the target! Your recipe will results in:
   | name | age |
   | name | age |
   ...
table, but I'm looking for a table result like:
   | name IS age | name IS age | name IS age |
   ...
   | name IS age | name IS age | <empty> |

The trick should be to get more (i.e. 3) data-sets into 1 row !

Is there a way?
Paul

From eurleif at gmail.com  Wed Dec  7 09:24:19 2005
From: eurleif at gmail.com (Leif K-Brooks)
Date: Wed Dec  7 09:24:24 2005
Subject: [Twisted-web] Nevow - how to render sequence into 3 column table
In-Reply-To: <439706FE.2050307@ivsn.com>
References: <438E9C80.4060700@ivsn.com> <20051201171917.GA9691@divmod.com>
	<439706FE.2050307@ivsn.com>
Message-ID: <85d9a9090512070824he517dcagbc25fc161f670aa4@mail.gmail.com>

On 12/7/05, Paul Reznicek <maillists@ivsn.com> wrote:
> The result should looks like:
>    <table>
>      <tr>
>        <td>Alfred is 15</td>
>        <td>Mary is 17</td>
>        <td>Bob is 25</td>
>      </tr>
>      ...
>      <tr>
>        <td>Molly is 22</td>
>        <td>Manfred is 33</td>
>      </tr>
>    </table>

If all you really want to do is have the names and ages displayed next
to each other, why not use ordinary nevow:render="sequence" along with
CSS? A demonstration of the stylesheet you'll need is at
<http://tw.ecritters.biz/html_examples/tile/>.

From alberto.trujillo at ucd.ie  Wed Dec  7 09:45:11 2005
From: alberto.trujillo at ucd.ie (Alberto Trujillo)
Date: Wed Dec  7 09:45:23 2005
Subject: [Twisted-web] How to kill the session
In-Reply-To: <439709E7.1070508@ivsn.com>
References: <43970833.3020002@ucd.ie> <439709E7.1070508@ivsn.com>
Message-ID: <43971197.7010607@ucd.ie>

That is what I was looking for. Thank you very much. I'm goin to try it.

Bye

Paul Reznicek wrote:

> Alberto Trujillo wrote:
>
>> There is any way to kill all the session in Nevow? I mean, I'm 
>> loading a lot of variables in the session, and some times I need to 
>> get the session clear again, and it's very tedious set each variable 
>> to None. So if I coud kill all the session just with one sentences, 
>> or get a new one clean than replace the existing one, would be very 
>> helpfull for me.
>
>
> Quite easy:
>   session = inevow.ISession(ctx)
>   session.expire()
>   return url.here.up()   # or anything else to switch to the login page
>
> Good luck,
> Paul
>
> _______________________________________________
> Twisted-web mailing list
> Twisted-web@twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web



From dialtone at divmod.com  Wed Dec  7 10:12:59 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Wed Dec  7 10:13:18 2005
Subject: [Twisted-web] Nevow - how to render sequence into 3 column table
In-Reply-To: <43970C73.7010202@ivsn.com>
References: <438E9C80.4060700@ivsn.com> <20051201171917.GA9691@divmod.com>
	<439706FE.2050307@ivsn.com> <20051207160924.GC254@divmod.com>
	<43970C73.7010202@ivsn.com>
Message-ID: <20051207171259.GD254@divmod.com>

On Wed, Dec 07, 2005 at 05:23:15PM +0100, Paul Reznicek wrote:
> Hi Valentino,
> thank you for quick response, but this is not the target! Your recipe will 
> results in:
>   | name | age |
>   | name | age |
>   ...
> table, but I'm looking for a table result like:
>   | name IS age | name IS age | name IS age |
>   ...
>   | name IS age | name IS age | <empty> |
> 
> The trick should be to get more (i.e. 3) data-sets into 1 row !
> 
> Is there a way?

Only with a custom renderer AFAIK.

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051207/b965873d/attachment.pgp
From maillists at ivsn.com  Wed Dec  7 10:17:46 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Wed Dec  7 10:18:25 2005
Subject: [Twisted-web] Nevow - how to render sequence into 3 column table
In-Reply-To: <85d9a9090512070824he517dcagbc25fc161f670aa4@mail.gmail.com>
References: <438E9C80.4060700@ivsn.com>
	<20051201171917.GA9691@divmod.com>	<439706FE.2050307@ivsn.com>
	<85d9a9090512070824he517dcagbc25fc161f670aa4@mail.gmail.com>
Message-ID: <4397193A.2070103@ivsn.com>

Leif K-Brooks wrote:
>> The result should looks like:
>>    <table>
>>      <tr>
>>        <td>Alfred is 15</td>
>>        <td>Mary is 17</td>
>>        <td>Bob is 25</td>
>>      </tr>
>>      ...
>>      <tr>
>>        <td>Molly is 22</td>
>>        <td>Manfred is 33</td>
>>      </tr>
>>    </table>
> 
> If all you really want to do is have the names and ages displayed next
> to each other, why not use ordinary nevow:render="sequence" along with
> CSS? A demonstration of the stylesheet you'll need is at
> <http://tw.ecritters.biz/html_examples/tile/>.

Thanks for this hint, it solve 50% of my needs ...
There is one reason, why I'd like prefer the <table> solution:
the variable column width!
In real, I'd like to use this for database field editing and the variable
field width get very important.

But your way is better than no way !!!
Paul

From eurleif at gmail.com  Wed Dec  7 10:30:27 2005
From: eurleif at gmail.com (Leif K-Brooks)
Date: Wed Dec  7 10:30:30 2005
Subject: [Twisted-web] Nevow - how to render sequence into 3 column table
In-Reply-To: <4397193A.2070103@ivsn.com>
References: <438E9C80.4060700@ivsn.com> <20051201171917.GA9691@divmod.com>
	<439706FE.2050307@ivsn.com>
	<85d9a9090512070824he517dcagbc25fc161f670aa4@mail.gmail.com>
	<4397193A.2070103@ivsn.com>
Message-ID: <85d9a9090512070930qaeb3bd6k3554496a9f65724e@mail.gmail.com>

On 12/7/05, Paul Reznicek <maillists@ivsn.com> wrote:
> There is one reason, why I'd like prefer the <table> solution:
> the variable column width!

If you don't need text in different rows to line up, you can remove
the width:8em line from the stylesheet (and maybe add a margin as
well).

From sam at SpinwardStars.com  Wed Dec  7 10:58:07 2005
From: sam at SpinwardStars.com (Samuel Reynolds)
Date: Wed Dec  7 11:05:59 2005
Subject: [Twisted-web] Nevow - how to render sequence into 3 column table
In-Reply-To: <4397193A.2070103@ivsn.com>
References: <438E9C80.4060700@ivsn.com> <20051201171917.GA9691@divmod.com>
	<439706FE.2050307@ivsn.com>
	<85d9a9090512070824he517dcagbc25fc161f670aa4@mail.gmail.com>
	<4397193A.2070103@ivsn.com>
Message-ID: <6.1.2.0.0.20051207105351.024b3da0@mail.myedl.com>

You'd need a custom renderer that does the
multicolumn layout.

I've attached a function that takes a list of items
and returns a list of lists. I created it for the
purpose you describe. It's not the prettiest or
most elegant code I've written, but I wrote it
when I was learning Python; since it works, and
I don't need it often, I haven't bothered trying
to improve it.

I added a couple of simple examples to the docstring.

Hope this helps.

- Sam

At 2005-12-07 06:17 PM +0100, you wrote:
>Leif K-Brooks wrote:
>>>The result should looks like:
>>>    <table>
>>>      <tr>
>>>        <td>Alfred is 15</td>
>>>        <td>Mary is 17</td>
>>>        <td>Bob is 25</td>
>>>      </tr>
>>>      ...
>>>      <tr>
>>>        <td>Molly is 22</td>
>>>        <td>Manfred is 33</td>
>>>      </tr>
>>>    </table>
>>If all you really want to do is have the names and ages displayed next
>>to each other, why not use ordinary nevow:render="sequence" along with
>>CSS? A demonstration of the stylesheet you'll need is at
>><http://tw.ecritters.biz/html_examples/tile/>.
>
>Thanks for this hint, it solve 50% of my needs ...
>There is one reason, why I'd like prefer the <table> solution:
>the variable column width!
>In real, I'd like to use this for database field editing and the variable
>field width get very important.
>
>But your way is better than no way !!!
>Paul
>
>_______________________________________________
>Twisted-web mailing list
>Twisted-web@twistedmatrix.com
>http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web

__________________________________________________________
Spinward Stars, LLC                        Samuel Reynolds
Software Consulting and Development           303-805-1446
http://SpinwardStars.com/            sam@SpinwardStars.com 
-------------- next part --------------
#	PlaceInColumns.py
#
#	Code by Samuel Reynolds.
#	This code is hereby released to the public domain.
#

def PlaceInColumns( itemList, numColumns=2, flReadAcross=False, flReturnAsRows=False ):
	"""
	Group the items in itemList for multiple-column presentation.
	
	Examples:
	1.	To present data as a 4-column HTML table:
			rowData = PlaceInColumns( myData, 4, True, True )
			#                                    ^^^^  ^^^^
			print '<table>'
			for row in rowData:
				TDs = [ '<td>%s</td>' % elt for elt in row ]
				print '<tr>%s<tr>' % ''.join( TDs )
			print '</table>'
	
	2.	To present data as a 4-column HTML table
		using only one row (items separated vertically by linebreaks):
			colData = PlaceInColumns( myData, 4, True, False )
			#                                    ^^^^  ^^^^^
			print '<table>'
			print '<tr>'
			for col in colData:
				print '<td>'
				print '<br />'.join( col )
				print '</td>'
			print '</tr>'
			print '</table>'
		
	"""
	outList = []
	if numColumns < 2:
		outList.append( itemList )
	else:
		numItems = len( itemList )
		
		if flReadAcross:	# Read across the columns
			idx = 0
			numCopies = 0
			subList = []
			while numCopies < numItems:
				subList.append( itemList[idx] )
				numCopies += 1
				idx = idx + numColumns
				if idx >= numItems:
					outList.append( subList )
					subList= []
					idx = idx % numColumns + 1
			if len( subList ) > 0:
				outList.append( subList )
		else:	# Read down the columns
			def CalcItemsPerColumn( cols, count ):
				perCol = count / cols
				if cols * perCol < count:
					perCol += 1
				return perCol
			idx = 1
			numCopies = 0
			numColumnsRemaining = numColumns
			subList = []
			itemsPerColumn = CalcItemsPerColumn( numColumnsRemaining, numItems )
			while numCopies < numItems:
				subList.append( itemList[ numCopies ] )
				numCopies += 1
				idx = idx + 1
				if idx > itemsPerColumn:
					outList.append( subList )
					subList = []
					idx = 1
					numColumnsRemaining -= 1
					if numColumnsRemaining > 1:
						itemsPerColumn = CalcItemsPerColumn( numColumnsRemaining, numItems - numCopies )
					else:
						itemsPerColumn = numItems - numCopies
	
	if not flReturnAsRows:
		return outList
	
	#Rows requested
	numCols = len( outList )
	numRows = len( outList[0] )
	rowsList = []
	subList = []
	numCopies = 0
	rowIdx = 1
	colIdx = 1
	for rowIdx in range( 0, numRows ):
		subList = []
		for colIdx in range( 0, numCols ):
			try:
				subList.append( outList[colIdx][rowIdx] )
			except:
				None
		rowsList.append( subList )
	
	return rowsList


if __name__ == "__main__":
	
	def TEST( trial, expect, flIgnoreNewlines=False ):
		"""
		Run trial script, compare to expected result,
		and print pass or fail message.
		"""
		result = eval( trial )
		if flIgnoreNewlines:
			expect = string.replace( expect, "\n", "\r" )
			while expect[-1] == '\r':
				expect = expect[:-1]
			result = string.replace( result, "\n", "\r" )
			while result[-1] == '\r':
				result = result[:-1]
		if result == expect:
			print "[PASS]      ", trial
		else:
			print "[FAIL] **** ", trial
			print "=" * 75
			print "Expect:"
			print "." * 75
			print expect
			print "-" * 75
			print "\nResult:"
			print "." * 75
			print result
			print "=" * 75
	
	# PlaceInColumns
	itemList = ['a','b','c','d','e','f','g']
	
	expectList = [ itemList ]
	TEST( "PlaceInColumns( itemList, 1 )", expectList )
	
	expectList = [['a'],['b'],['c'],['d'],['e'],['f'],['g']]
	TEST( "PlaceInColumns( itemList, 1, flReturnAsRows=True )", expectList )
	
	expectList = [['a','b','c','d'],['e','f','g']]
	TEST( "PlaceInColumns( itemList, 2 )", expectList )
	
	expectList = [['a','c','e','g'], ['b','d','f']]
	TEST( "PlaceInColumns( itemList, 2, flReadAcross=True )", expectList )
	
	expectList = [['a','b','c'],['d','e'],['f','g']]
	TEST( "PlaceInColumns( itemList, 3 )", expectList )
	
	expectList = [['a','d','f'],['b','e','g'],['c']]
	TEST( "PlaceInColumns( itemList, 3, flReturnAsRows=True )", expectList )
	
	expectList = [['a','d','g'],['b','e'],['c','f']]
	TEST( "PlaceInColumns( itemList, 3, flReadAcross=True )", expectList )
	
	expectList = [['a','b','c'],['d','e','f'],['g']]
	TEST( "PlaceInColumns( itemList, 3, flReadAcross=True, flReturnAsRows=True )", expectList )
From maillists at ivsn.com  Sat Dec 10 05:10:25 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Sat Dec 10 05:11:01 2005
Subject: [Twisted-web] Matt's "forms" - validation error when field name is
	not ASCII
In-Reply-To: <20051207171259.GD254@divmod.com>
References: <438E9C80.4060700@ivsn.com>
	<20051201171917.GA9691@divmod.com>	<439706FE.2050307@ivsn.com>
	<20051207160924.GC254@divmod.com>	<43970C73.7010202@ivsn.com>
	<20051207171259.GD254@divmod.com>
Message-ID: <439AC5B1.40801@ivsn.com>

Hi "forms" maintainers!

Current state (note the "?" character (German 'ae' in name):

    form.addField('w?hrung', forms.String(required=True))

You can fill some data in the form, but you permanently get the
"required" message for this field.

Attached patch open the possibility of using Unicode characters
in field names and corrects above error.

Thanks for the great package!
Paul
-------------- next part --------------
Index: form.py 
=================================================================== 
--- form.py	(Revision 147) 
+++ form.py	(Arbeitskopie) 
@@ -81,6 +81,7 @@ 
     def addField(self, name, type, widgetFactory=None, label=None, description=None, cssClass=None): 
         if self.items is None: 
             self.items = [] 
+        name = unicode(name) 
         type.name = name 
         if label is None: 
             label = util.titleFromName(name) 
From mithrandi-twisted-web at mithrandi.za.net  Sat Dec 10 08:11:32 2005
From: mithrandi-twisted-web at mithrandi.za.net (Tristan Seligmann)
Date: Sat Dec 10 08:11:42 2005
Subject: [Twisted-web] Matt's "forms" - validation error when field name
	is not ASCII
In-Reply-To: <439AC5B1.40801@ivsn.com>
References: <438E9C80.4060700@ivsn.com> <20051201171917.GA9691@divmod.com>
	<439706FE.2050307@ivsn.com> <20051207160924.GC254@divmod.com>
	<43970C73.7010202@ivsn.com> <20051207171259.GD254@divmod.com>
	<439AC5B1.40801@ivsn.com>
Message-ID: <20051210151131.GD23956@mithrandi.za.net>

* Paul Reznicek <maillists@ivsn.com> [2005-12-10 13:10:25 +0100]:

> Current state (note the "?" character (German 'ae' in name):
> 
>    form.addField('w?hrung', forms.String(required=True))
> 
> You can fill some data in the form, but you permanently get the
> "required" message for this field.
> 
> Attached patch open the possibility of using Unicode characters
> in field names and corrects above error.

The attached patch doesn't seem right at all, to me; if it does actually
do the right thing, then it seems to me you should just be passing a
unicode string in the first place. In other words:

    form.addField(u'w?hrung', forms.String(required=True))

I haven't really looked into the code at all, though, so I suspect there
may be other thorny unicode issues.
-- 
mithrandi, i Ainil en-Balandor, a faer Ambar
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: Digital signature
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051210/592034ca/attachment.pgp
From exarkun at divmod.com  Sat Dec 10 08:36:01 2005
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Sat Dec 10 08:36:05 2005
Subject: [Twisted-web] Matt's "forms" - validation error when field name
	is not ASCII
In-Reply-To: <20051210151131.GD23956@mithrandi.za.net>
Message-ID: <20051210153601.1217.929551159.divmod.quotient.4720@ohm>

On Sat, 10 Dec 2005 17:11:32 +0200, Tristan Seligmann <mithrandi-twisted-web@mithrandi.za.net> wrote:
>* Paul Reznicek <maillists@ivsn.com> [2005-12-10 13:10:25 +0100]:
>
>> Current state (note the "?" character (German 'ae' in name):
>>
>>    form.addField('w?hrung', forms.String(required=True))
>>
>> You can fill some data in the form, but you permanently get the
>> "required" message for this field.
>>
>> Attached patch open the possibility of using Unicode characters
>> in field names and corrects above error.
>
>The attached patch doesn't seem right at all, to me; if it does actually
>do the right thing, then it seems to me you should just be passing a
>unicode string in the first place. In other words:
>
>    form.addField(u'w?hrung', forms.String(required=True))

And an appropriate encoding declaration at the top of the source file:

# coding: utf-8

Or if you like emacs,

# -*- coding: utf-8 -*-

Jean-Paul

From maillists at ivsn.com  Sat Dec 10 10:43:28 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Sat Dec 10 10:44:34 2005
Subject: [Twisted-web] Matt's "forms" - validation error when field name
	is not ASCII
In-Reply-To: <20051210151131.GD23956@mithrandi.za.net>
References: <438E9C80.4060700@ivsn.com>
	<20051201171917.GA9691@divmod.com>	<439706FE.2050307@ivsn.com>
	<20051207160924.GC254@divmod.com>	<43970C73.7010202@ivsn.com>
	<20051207171259.GD254@divmod.com>	<439AC5B1.40801@ivsn.com>
	<20051210151131.GD23956@mithrandi.za.net>
Message-ID: <439B13C0.9040004@ivsn.com>

Tristan Seligmann wrote:
> * Paul Reznicek <maillists@ivsn.com> [2005-12-10 13:10:25 +0100]:
>> ...
>>    form.addField('w?hrung', forms.String(required=True))
>> ...
> 
> The attached patch doesn't seem right at all, to me; if it does actually
> do the right thing, then it seems to me you should just be passing a
> unicode string in the first place. In other words:
> 
>     form.addField(u'w?hrung', forms.String(required=True))
> ...

Yes, this is a way too, but than you must take care in each
".addField(" line, my patch save those sorrows ...

Paul

From dialtone at divmod.com  Sat Dec 10 11:48:02 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Sat Dec 10 11:48:19 2005
Subject: [Twisted-web] Matt's "forms" - validation error when field name
	is not ASCII
In-Reply-To: <439B13C0.9040004@ivsn.com>
References: <438E9C80.4060700@ivsn.com> <20051201171917.GA9691@divmod.com>
	<439706FE.2050307@ivsn.com> <20051207160924.GC254@divmod.com>
	<43970C73.7010202@ivsn.com> <20051207171259.GD254@divmod.com>
	<439AC5B1.40801@ivsn.com> <20051210151131.GD23956@mithrandi.za.net>
	<439B13C0.9040004@ivsn.com>
Message-ID: <20051210184802.GB26145@divmod.com>

On Sat, Dec 10, 2005 at 06:43:28PM +0100, Paul Reznicek wrote:
> Yes, this is a way too, but than you must take care in each
> ".addField(" line, my patch save those sorrows ...

Actually that is the only way, not one way. All the other ways, if they work,
they do by chance and are very fragile.

For example your 'solution' is simply broken by using a different encoding
that cannot be decoded with the default one used by unicode().

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051210/8884aa8c/attachment.pgp
From exarkun at divmod.com  Sat Dec 10 12:23:36 2005
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Sat Dec 10 12:23:40 2005
Subject: [Twisted-web] Matt's "forms" - validation error when field name
	is not ASCII
In-Reply-To: <20051210184802.GB26145@divmod.com>
Message-ID: <20051210192336.1217.819090532.divmod.quotient.4770@ohm>

On Sat, 10 Dec 2005 19:48:02 +0100, Valentino Volonghi aka Dialtone <dialtone@divmod.com> wrote:
>On Sat, Dec 10, 2005 at 06:43:28PM +0100, Paul Reznicek wrote:
>> Yes, this is a way too, but than you must take care in each
>> ".addField(" line, my patch save those sorrows ...
>
>Actually that is the only way, not one way. All the other ways, if they work,
>they do by chance and are very fragile.
>
>For example your 'solution' is simply broken by using a different encoding
>that cannot be decoded with the default one used by unicode().

Here are some concrete examples:

exarkun@boson:~$ python
Python 2.4.2 (#2, Sep 30 2005, 21:19:01)
[GCC 4.0.2 20050808 (prerelease) (Ubuntu 4.0.1-4ubuntu8)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> unicode('?')
Traceback (most recent call last):
  File "<stdin>", line 1, in ?
UnicodeDecodeError: 'ascii' codec can't decode byte 0xc3 in position 0: 
ordinal not in range(128)
>>>

Oops, I typed an accented e, which ended up in the code as UTF-8, since 
that's how my terminal is configured.  But Python has no way of knowing 
this, so it has to use the system specified default encoding to decode 
the bytes my terminal sent to it.  Since that's ASCII (the only sane 
system encoding, unfortunately), not UTF-8, the decode explodes.

Well fine.  How about I change the system encoding to UTF-8, then things 
will work, right?

>>> [magic censored - the system encoding is utf-8 now, trust me]
>>> unicode('?')
u'\xe9'

Hey cool, that worked.  Let's try another character.

>>> unicode('?')
Traceback (most recent call last):
  File "<stdin>", line 1, in ?
UnicodeDecodeError: 'ascii' codec can't decode byte 0xae in position 0: 
ordinal not in range(128)
>>>

Ahh crud.  This time I typed in some Big-5 encoded bytes to represent a 
Han character.  The system encoding is still UTF-8 though, so again it 
is broken.

Now, you might think it is unreasonable to be typing things in UTF-8 to 
start with and then randomly switch over to Big-5 (actually, doing 
anything with Big-5 is crazy, but I digress).  But just imagine you are 
trying to use two different libraries in your program: one developed in 
Sweden and one developed in China.  Nevow has to work with both of 
these *at the same time*.  So it cannot assume an encoding anywhere, 
even the system default encoding (you might be trying to run the program 
in the United States!), so the encodings have to be provided at the 
location of the actual bytes themselves: the way you do this in Python 
is by using unicode strings (u'...'), not byte strings ('...') and 
declaring the encoding of the source file the literals appear in.

Hope this helps clear things up,

Jean-Paul

From maillists at ivsn.com  Mon Dec 12 11:23:39 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Mon Dec 12 11:24:19 2005
Subject: [Twisted-web] Matt's "forms" - error when using field
	Integer(immutable=True)
In-Reply-To: <20051207171259.GD254@divmod.com>
References: <438E9C80.4060700@ivsn.com>
	<20051201171917.GA9691@divmod.com>	<439706FE.2050307@ivsn.com>
	<20051207160924.GC254@divmod.com>	<43970C73.7010202@ivsn.com>
	<20051207171259.GD254@divmod.com>
Message-ID: <439DC02B.9020606@ivsn.com>

Hi Matt,

Attached patch corrects an error when using field  Integer(immutable=True)
and form re-render because some validation failed (i.e. other required
field is empty, etc.)

Additionally, I've added some line breaks for the renderer to
make the produced HTML more readable (I needed it while debugging).

Thanks for the great package!
Paul

-------------- next part --------------
Index: widget.py 
=================================================================== 
--- widget.py	(Revision 147) 
+++ widget.py	(Arbeitskopie) 
@@ -39,7 +39,11 @@ 
  
     def render(self, ctx, key, args, errors): 
         if errors: 
-            value = args.get(key, [''])[0] 
+            # this correct an error when using field  Integer(immutable=True) 
+            # and form re-render because some validation failed 
+            value = args.get(key, ['']) 
+            if type(value) in (list, tuple): 
+                value = args.get(key, [''])[0] 
         else: 
             value = iforms.IStringConvertible(self.original).fromType(args.get(key)) 
         if not self.showValueOnFailure: 
@@ -171,6 +175,7 @@ 
         return [ 
             T.input(type='password', name=key, id=keytocssid(ctx.key), value=values[0], class_='readonly', readonly='readonly'), 
             T.br, 
+            T.xml('\n'), 
             T.label(for_='%s__confirm'%keytocssid(ctx.key))[' Confirm '], 
             T.input(type='password', name=key, id='%s__confirm'%keytocssid(ctx.key), value=values[1], class_='readonly', readonly='readonly') 
         ] 
@@ -236,7 +241,7 @@ 
  
         def renderOptions(ctx, data): 
             if self.noneOption is not None: 
-                yield T.option(value=iforms.IKey(self.noneOption).key())[iforms.ILabel(self.noneOption).label()] 
+                yield T.xml('\n'), T.option(value=iforms.IKey(self.noneOption).key())[iforms.ILabel(self.noneOption).label()] 
             if data is None: 
                 return 
             for item in data: 
@@ -246,7 +251,7 @@ 
                 option = T.option(value=optValue)[optLabel] 
                 if optValue == value: 
                     option = option(selected='selected') 
-                yield option 
+                yield T.xml('\n'), option 
  
         tag=T.select(name=key, id=keytocssid(ctx.key), data=self.options)[renderOptions] 
         if disabled: 
@@ -283,7 +288,7 @@ 
             tag = T.input(name=key, type='radio', id=cssid, value=itemKey) 
             if selected: 
                 tag = tag(checked='checked') 
-            return tag, ' ', T.label(for_=cssid)[itemLabel], T.br 
+            return tag, ' ', T.label(for_=cssid)[itemLabel], T.br, T.xml('\n') 
  
         def renderOptions(ctx, data): 
             # A counter to assign unique ids to each input 
@@ -324,16 +329,16 @@ 
     The default entry format is the US (month, day, year) but can be switched to 
     the more common (day, month, year) by setting the dayFirst attribute to 
     True. 
-     
+ 
     By default the widget is designed to only accept unambiguous years, i.e. 
     the user must enter 4 character dates. 
-     
+ 
     Many people find it convenient or even necessary to allow a 2 character 
     year. This can be allowed by setting the twoCharCutoffYear attribute to an 
     integer value between 0 and 99. Anything greater than or equal to the cutoff 
     year will be considered part of the 20th century (1900 + year); anything 
     less the cutoff year is a 21st century (2000 + year) date. 
-     
+ 
     A typical twoCharCutoffYear value is 70 (i.e. 1970). However, that value is 
     somewhat arbitrary. It's the year that time began according to the PC, but 
     it doesn't mean much to your non-techie user. 
From maillists at ivsn.com  Mon Dec 12 13:35:32 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Mon Dec 12 13:36:12 2005
Subject: [Twisted-web] Better patch [Re: Matt's "forms" - error when using
	field Integer(immutable=True)]
In-Reply-To: <439DC02B.9020606@ivsn.com>
References: <438E9C80.4060700@ivsn.com>
	<20051201171917.GA9691@divmod.com>	<439706FE.2050307@ivsn.com>
	<20051207160924.GC254@divmod.com>	<43970C73.7010202@ivsn.com>
	<20051207171259.GD254@divmod.com> <439DC02B.9020606@ivsn.com>
Message-ID: <439DDF14.5050208@ivsn.com>

Attached same solution, but more clean and applied on all places,
where this error can principally occur.

PaRez

Paul Reznicek wrote:
> Hi Matt,
> 
> Attached patch corrects an error when using field  Integer(immutable=True)
> and form re-render because some validation failed (i.e. other required
> field is empty, etc.)
> 
> Additionally, I've added some line breaks for the renderer to
> make the produced HTML more readable (I needed it while debugging).
> 
> Thanks for the great package!
> Paul
-------------- next part --------------
Index: widget.py 
=================================================================== 
--- widget.py	(Revision 147) 
+++ widget.py	(Arbeitskopie) 
@@ -16,6 +16,13 @@ 
 # Marker object for args that are not supplied 
 _UNSET = object() 
  
+def _getValue4key(args, key): 
+    # this correct an error when using field  Integer(immutable=True) 
+    # and form re-render because some validation failed 
+    value = args.get(key, ['']) 
+    if type(value) in (list, tuple): 
+        return value[0] 
+    return value 
  
 class TextInput(object): 
     """ 
@@ -39,7 +46,7 @@ 
  
     def render(self, ctx, key, args, errors): 
         if errors: 
-            value = args.get(key, [''])[0] 
+            value = _getValue4key(args, key) 
         else: 
             value = iforms.IStringConvertible(self.original).fromType(args.get(key)) 
         if not self.showValueOnFailure: 
@@ -51,7 +58,7 @@ 
         return self._renderTag(ctx, key, value, True) 
  
     def processInput(self, ctx, key, args): 
-        value = args.get(key, [''])[0].decode(util.getPOSTCharset(ctx)) 
+        value = _getValue4key(args, key).decode(util.getPOSTCharset(ctx)) 
         value = iforms.IStringConvertible(self.original).toType(value) 
         return self.original.validate(value) 
  
@@ -77,7 +84,7 @@ 
  
     def render(self, ctx, key, args, errors): 
         if errors: 
-            value = args.get(key, [''])[0] 
+            value = _getValue4key(args, key) 
         else: 
             value = iforms.IBooleanConvertible(self.original).fromType(args.get(key)) 
         return self._renderTag(ctx, key, value, False) 
@@ -130,7 +137,7 @@ 
  
     def render(self, ctx, key, args, errors): 
         if errors: 
-            value = args.get(key, [''])[0] 
+            value = _getValue4key(args, key) 
         else: 
             value = iforms.IStringConvertible(self.original).fromType(args.get(key)) 
         return self._renderTag(ctx, key, value, False) 
@@ -140,7 +147,7 @@ 
         return self._renderTag(ctx, key, value, True) 
  
     def processInput(self, ctx, key, args): 
-        value = args.get(key, [''])[0].decode(util.getPOSTCharset(ctx)) 
+        value = _getValue4key(args, key).decode(util.getPOSTCharset(ctx)) 
         value = iforms.IStringConvertible(self.original).fromType(value) 
         return self.original.validate(value) 
  
@@ -171,6 +178,7 @@ 
         return [ 
             T.input(type='password', name=key, id=keytocssid(ctx.key), value=values[0], class_='readonly', readonly='readonly'), 
             T.br, 
+            T.xml('\n'), 
             T.label(for_='%s__confirm'%keytocssid(ctx.key))[' Confirm '], 
             T.input(type='password', name=key, id='%s__confirm'%keytocssid(ctx.key), value=values[1], class_='readonly', readonly='readonly') 
         ] 
@@ -212,7 +220,7 @@ 
             self.noneOption = noneOption 
  
     def processInput(self, ctx, key, args): 
-        value = args.get(key, [''])[0] 
+        value = _getValue4key(args, key) 
         value = iforms.IStringConvertible(self.original).toType(value) 
         if self.noneOption is not None and value == self.noneOption[0]: 
             value = None 
@@ -236,7 +244,7 @@ 
  
         def renderOptions(ctx, data): 
             if self.noneOption is not None: 
-                yield T.option(value=iforms.IKey(self.noneOption).key())[iforms.ILabel(self.noneOption).label()] 
+                yield T.xml('\n'), T.option(value=iforms.IKey(self.noneOption).key())[iforms.ILabel(self.noneOption).label()] 
             if data is None: 
                 return 
             for item in data: 
@@ -246,7 +254,7 @@ 
                 option = T.option(value=optValue)[optLabel] 
                 if optValue == value: 
                     option = option(selected='selected') 
-                yield option 
+                yield T.xml('\n'), option 
  
         tag=T.select(name=key, id=keytocssid(ctx.key), data=self.options)[renderOptions] 
         if disabled: 
@@ -256,7 +264,7 @@ 
     def render(self, ctx, key, args, errors): 
         converter = iforms.IStringConvertible(self.original) 
         if errors: 
-            value = args.get(key, [''])[0] 
+            value = _getValue4key(args, key) 
         else: 
             value = converter.fromType(args.get(key)) 
         return self._renderTag(ctx, key, value, converter, False) 
@@ -283,7 +291,7 @@ 
             tag = T.input(name=key, type='radio', id=cssid, value=itemKey) 
             if selected: 
                 tag = tag(checked='checked') 
-            return tag, ' ', T.label(for_=cssid)[itemLabel], T.br 
+            return tag, ' ', T.label(for_=cssid)[itemLabel], T.br, T.xml('\n') 
  
         def renderOptions(ctx, data): 
             # A counter to assign unique ids to each input 
@@ -305,7 +313,7 @@ 
     def render(self, ctx, key, args, errors): 
         converter = iforms.IStringConvertible(self.original) 
         if errors: 
-            value = args.get(key, [''])[0] 
+            value = _getValue4key(args, key) 
         else: 
             value = converter.fromType(args.get(key)) 
         return self._renderTag(ctx, key, value, converter, False) 
@@ -324,16 +332,16 @@ 
     The default entry format is the US (month, day, year) but can be switched to 
     the more common (day, month, year) by setting the dayFirst attribute to 
     True. 
-     
+ 
     By default the widget is designed to only accept unambiguous years, i.e. 
     the user must enter 4 character dates. 
-     
+ 
     Many people find it convenient or even necessary to allow a 2 character 
     year. This can be allowed by setting the twoCharCutoffYear attribute to an 
     integer value between 0 and 99. Anything greater than or equal to the cutoff 
     year will be considered part of the 20th century (1900 + year); anything 
     less the cutoff year is a 21st century (2000 + year) date. 
-     
+ 
     A typical twoCharCutoffYear value is 70 (i.e. 1970). However, that value is 
     somewhat arbitrary. It's the year that time began according to the PC, but 
     it doesn't mean much to your non-techie user. 
@@ -584,7 +592,7 @@ 
  
     def render(self, ctx, key, args, errors): 
         if errors: 
-            value = args.get(key, [''])[0] 
+            value = _getValue4key(args, key) 
         else: 
             value = iforms.IFileConvertible(self.original).fromType(args.get(key)) 
         return self._renderTag(ctx, key, False) 
@@ -883,7 +891,7 @@ 
         return self.render(ctx, key, args, errors) 
  
     def processInput(self, ctx, key, args): 
-        value = args.get(key, [''])[0].decode(util.getPOSTCharset(ctx)) 
+        value = _getValue4key(args, key).decode(util.getPOSTCharset(ctx)) 
         value = iforms.IStringConvertible(self.original).toType(value) 
         return self.original.validate(value) 
  
From ruach at chpc.utah.edu  Tue Dec 13 13:07:47 2005
From: ruach at chpc.utah.edu (Matthew Thorley)
Date: Tue Dec 13 13:07:52 2005
Subject: [Twisted-web] twisted-web file upload processing on the server
Message-ID: <7ccdbe1a0512131207n1af2da6bv2d1c21a0d7c4592@mail.gmail.com>

Please forgive me if this is obvious, but I couldn't find the answer
any where! I searched google, the new twisted book, the twisted-web
docs, and the mailing list archive. I saw other posts with similar
questions but not the answer, so here goes.

I'm using twisted version 2.1.0 and I did the sumo download to make it
easy on myself

I've got a setup like this on the server:

class UploadPage(resource.Resource):
   def render_POST(self, request):
       filename = request.args['cml'][0]
       # filecontent = ???
       return "You uploaded file: %s" %filename


And I'm using a form like this to send the file:

<form enctype="mulitpart/form-data" action="/upload"
    method="post">
    <p>CML: <input name="cml" type="file"/></p>
    <p><input type="submit" name="submit" value="Upload"/></p>
</form>

When I upload the file everything works and the correct file name
shows in the output. But what I can't do is read/get the contents of
the file.

Can some one please explain how to do server side file upoad
processing??? I'm totaly lost here. I'm sure that it must be something
painfully obvious, since uploads are such a common thing. But I can't
figure it out.

Thanks much
Matthew Thorley

From ldanielburr at mac.com  Tue Dec 13 13:47:10 2005
From: ldanielburr at mac.com (L. Daniel Burr)
Date: Tue Dec 13 13:47:14 2005
Subject: [Twisted-web] twisted-web file upload processing on the server
In-Reply-To: <7ccdbe1a0512131207n1af2da6bv2d1c21a0d7c4592@mail.gmail.com>
References: <7ccdbe1a0512131207n1af2da6bv2d1c21a0d7c4592@mail.gmail.com>
Message-ID: <op.s1qpcweb3oj628@zetsuei>

On Tue, 13 Dec 2005 14:07:47 -0600, Matthew Thorley <ruach@chpc.utah.edu>  
wrote:

[SNIP]

> Can some one please explain how to do server side file upoad
> processing??? I'm totaly lost here. I'm sure that it must be something
> painfully obvious, since uploads are such a common thing. But I can't
> figure it out.
>

IIRC, request.content should contain what you are looking for.  Note that  
twisted.web doesn't handle file uploads optimally; twisted.web2 does a  
better job in that particular area.

Hope this helps,

L. Daniel Burr

From ruach at chpc.utah.edu  Tue Dec 13 14:09:18 2005
From: ruach at chpc.utah.edu (Matthew Thorley)
Date: Tue Dec 13 14:09:25 2005
Subject: [Twisted-web] twisted-web file upload processing on the server
Message-ID: <7ccdbe1a0512131309q51533afclbfdceb2d35696d7d@mail.gmail.com>

> IIRC, request.content should contain what you are looking for.  Note that
> twisted.web doesn't handle file uploads optimally; twisted.web2 does a
> better job in that particular area.

I gave that a shot earlier and didn't get much.

print request.content
<cStringIO.StringO object at 0xb7742ac0>

print request.content.readline()
[]

print request.content.readlines()
[]

I have tried this with different files, and also double checked that
the file I was uploading wasn't empty.

--
Matthew Thorley

From andrea at cpushare.com  Tue Dec 13 15:43:02 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Tue Dec 13 15:43:09 2005
Subject: [Twisted-web] Nevow PageCache
Message-ID: <20051213224302.GB23878@opteron.random>

I wanted to push into the tracker but I'm a bit confused on how to do
that with trac, so I resend with the mailing list.

This patch implements html caching at the page level with a optional max
cache size per page and with optional timeout.

Even when the timeout is very small, this makes sure that all blocked
waiting clients gets the same copy of the html allowing the server to
scale.

This only works for dynamic data that is the same for all users, so it's
good for the homepage etc...

I use it online for months and I had no problems at all.

Index: Nevow/nevow/util.py
===================================================================
--- Nevow/nevow/util.py	(revision 3434)
+++ Nevow/nevow/util.py	(working copy)
@@ -133,6 +133,7 @@
     from twisted.python.failure import Failure
     from twisted.trial.unittest import deferredError
     from twisted.python import log
+    from twisted.internet import reactor
 
     try:
         # work with twisted before retrial
Index: Nevow/nevow/rend.py
===================================================================
--- Nevow/nevow/rend.py	(revision 3434)
+++ Nevow/nevow/rend.py	(working copy)
@@ -491,6 +491,56 @@
         self.children[name] = child
 
 
+class PageCache(object):
+    def __init__(self):
+        self.__db = {}
+    def cacheIDX(self, ctx):
+        return str(url.URL.fromContext(ctx))
+    def __storeCache(self, cacheIDX, c):
+        self.__db[cacheIDX] = c
+    def __deleteCache(self, cacheIDX):
+        del self.__db[cacheIDX]
+    def __deleteCacheData(self, cacheIDX, page):
+        size = self.__db[cacheIDX][1]
+        assert len(self.__db[cacheIDX][0]) == size
+        page.subCacheSize(size)
+        self.__deleteCache(cacheIDX)
+    def __lookupCache(self, cacheIDX):
+        return self.__db.get(cacheIDX)
+    def getCache(self, ctx):
+        cacheIDX = self.cacheIDX(ctx)
+        c = self.__lookupCache(cacheIDX)
+
+        if c is None:
+            self.__storeCache(cacheIDX, [util.Deferred()])
+            return
+
+        if isinstance(c[0], util.Deferred):
+            d = util.Deferred()
+            c.append(d)
+            return d
+
+        return c[0]
+    def cacheRendered(self, ctx, data, page):
+        cacheIDX = self.cacheIDX(ctx)
+        defer_list = self.__lookupCache(cacheIDX)
+        assert(isinstance(defer_list[0], util.Deferred))
+        size = len(data)
+        if page.canCache(size):
+            # overwrite the deferred with the data
+            timer = None
+            if page.lifetime > 0:
+                timer = util.reactor.callLater(page.lifetime,
+                                               self.__deleteCacheData, cacheIDX, page)
+            page.addCacheSize(size)
+            self.__storeCache(cacheIDX, (data, size, timer, ))
+        else:
+            self.__deleteCache(cacheIDX)
+        for d in defer_list:
+            d.callback(data)
+
+_CACHE = PageCache()
+
 class Page(Fragment, ConfigurableFactory, ChildLookupMixin):
     """A page is the main Nevow resource and renders a document loaded
     via the document factory (docFactory).
@@ -504,8 +554,27 @@
     afterRender = None
     addSlash = None
 
+    cache = False
+    lifetime = 0
+    max_cache_size = None
+    __cache_size = 0
+
     flattenFactory = lambda self, *args: flat.flattenFactory(*args)
 
+    def hasCache(self, ctx):
+        if not self.cache:
+            return
+        return _CACHE.getCache(ctx)
+    def addCacheSize(self, size):
+        assert self.canCache(size)
+        self.__cache_size += size
+    def subCacheSize(self, size):
+        self.__cache_size -= size
+        assert self.__cache_size >= 0
+    def canCache(self, size):
+        return self.max_cache_size is None or \
+               self.__cache_size + size <= self.max_cache_size
+
     def renderHTTP(self, ctx):
         if self.beforeRender is not None:
             return util.maybeDeferred(self.beforeRender,ctx).addCallback(
@@ -530,11 +599,20 @@
             if self.afterRender is not None:
                 return util.maybeDeferred(self.afterRender,ctx)
 
-        if self.buffered:
+        c = self.hasCache(ctx)
+        if c is not None:
+            assert self.afterRender is None
+            finishRequest()
+            return c
+
+        if self.buffered or self.cache:
             io = StringIO()
             writer = io.write
             def finisher(result):
-                request.write(io.getvalue())
+                c = io.getvalue()
+                if self.cache:
+                    _CACHE.cacheRendered(ctx, c, self)
+                request.write(c)
                 return util.maybeDeferred(finishRequest).addCallback(lambda r: result)
         else:
             writer = request.write

From andrea at cpushare.com  Tue Dec 13 15:44:10 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Tue Dec 13 15:44:14 2005
Subject: [Twisted-web] remove ugliness when creating Nevow sessions
Message-ID: <20051213224410.GC23878@opteron.random>

This isn't only ugly, it also screwup wget. I left it commented just in
case.

Index: Nevow/nevow/guard.py
===================================================================
--- Nevow/nevow/guard.py	(revision 3434)
+++ Nevow/nevow/guard.py	(working copy)
@@ -299,7 +299,8 @@
         if path.startswith(SESSION_KEY):
             key = path[len(SESSION_KEY):]
             if key not in self.sessions:
-                return urlToChild(ctx, *segments[1:], **{'__start_session__':1}), ()
+                #return urlToChild(ctx, *segments[1:], **{'__start_session__':1}), ()
+                return urlToChild(ctx, *segments[1:]), ()
             self.sessions[key].setLifetime(self.sessionLifetime)
             if cookie == key:
                 # /sessionized-url/${SESSION_KEY}aef9c34aecc3d9148/foo
@@ -307,6 +308,7 @@
                 #                  we are this getChild
                 # with a matching cookie
                 self.sessions[key].sessionJustStarted = True
+                #return urlToChild(ctx, *segments[1:], **{'__session_just_started__':1}), ()
                 return urlToChild(ctx, *segments[1:]), ()
             else:
                 # We attempted to negotiate the session but failed (the user

From andrea at cpushare.com  Tue Dec 13 15:48:11 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Tue Dec 13 15:48:16 2005
Subject: [Twisted-web] forwarding client information from twisted proxy to
	nevow monster
Message-ID: <20051213224811.GD23878@opteron.random>

Without this patch, a nevow server behind twisted proxy can't receive
the correct client information.

It's backwards compatible, passClient = True must be explicitly passed
when creating both the proxy and monster classes for this to work (and
as usual the monster resource must be under the firewall, only the
"trusted" proxy must be allowed to connect to it, for the client info to
be trustable).

Here the Nevow part.

Index: Nevow/nevow/vhost.py
===================================================================
--- Nevow/nevow/vhost.py	(revision 3434)
+++ Nevow/nevow/vhost.py	(working copy)
@@ -134,13 +134,15 @@
     *after* it returns the (resource,segments) tuple.
     """
     implements(inevow.IResource)
+
+    def __init__(self, vhost_segments):
+        self.prepath_segments = vhost_segments+1 # +1 is for /vhost
+
     def locateChild(self, ctx, segments):
         request = inevow.IRequest(ctx)
-        request.prepath = request.prepath[3:]
+        request.prepath = request.prepath[self.prepath_segments:]
         return request.site.resource, segments
 
-_prepathCleaner = _VHostMonsterResourcePrepathCleaner()
-
 class VHostMonsterResource:
     """VHostMonster resource that helps to deploy a Nevow site behind a proxy.
     
@@ -174,17 +176,30 @@
     This also means your private server should serve the real content at
     /foo/bar, and not at the root of the tree.
 
+    If passClient is set to True it expects the client to be passed by the
+    proxy (see ReverseProxyResource passClient parameter for details). When
+    passClient is True this page should not be reacheable directly from the
+    internet if logging the IP address and port securely is needed.
+
     Warning: anyone who can access a VHostMonsterResource can fake the
     host name they are contacting. This can lead to cookie stealing or
     cross site scripting attacks. Never expose /vhost to the Internet.
     """
     implements(inevow.IResource)
 
+    vhost_segments = 2
+
+    def __init__(self, passClient = False):
+        self.passClient = passClient
+        if passClient:
+            self.vhost_segments = 3
+        self._prepathCleaner = _VHostMonsterResourcePrepathCleaner(self.vhost_segments)
+
     def locateChild(self, ctx, segments):
 
         request = inevow.IRequest(ctx)
 
-        if len(segments) < 2:
+        if len(segments) < self.vhost_segments:
             return rend.NotFound
         else:
             if segments[0] == 'http':
@@ -197,13 +212,18 @@
                 port = int(port)
             else:
                 host, port = segments[1], 80
-           
             request.setHost(host, port)
 
-            prefixLen = len('/'+'/'.join(request.prepath)+'/'+'/'.join(segments[:2]))
-            request.path = '/'+'/'.join(segments[2:])
+            if self.passClient:
+                if ':' not in segments[2]:
+                    return rend.NotFound
+                host, port = segments[2].split(':')
+                request.setClient(host, port)
+
+            prefixLen = len('/'+'/'.join(request.prepath)+'/'+'/'.join(segments[:self.vhost_segments]))
+            request.path = '/'+'/'.join(segments[self.vhost_segments:])
             request.uri = request.uri[prefixLen:]
 
-            return _prepathCleaner, segments[2:]
+            return self._prepathCleaner, segments[self.vhost_segments:]
         
 compy.backwardsCompatImplements(VHostMonsterResource)


Here the twisted part:

Index: Twisted/twisted/web/http.py
===================================================================
--- Twisted/twisted/web/http.py	(revision 15293)
+++ Twisted/twisted/web/http.py	(working copy)
@@ -876,6 +876,10 @@
         self.received_headers["host"] = host
         self.host = address.IPv4Address("TCP", host, port)
 
+    def setClient(self, host, port):
+        """Same as setHost but for the client address"""
+        self.client = address.IPv4Address("TCP", host, port)
+
     def getClientIP(self):
         if isinstance(self.client, address.IPv4Address):
             return self.client.host
Index: Twisted/twisted/web/proxy.py
===================================================================
--- Twisted/twisted/web/proxy.py	(revision 15293)
+++ Twisted/twisted/web/proxy.py	(working copy)
@@ -162,23 +162,33 @@
     to a different server.
     """
 
-    def __init__(self, host, port, path):
+    def __init__(self, host, port, path, passClient = False):
         resource.Resource.__init__(self)
         self.host = host
         self.port = port
         self.path = path
+        self.passClient = passClient
 
+    def getPath(self, request):
+        path = self.path
+        if self.passClient:
+            path += '/%s:%d' % (request.client.host, request.client.port)
+        return path
+
     def getChild(self, path, request):
-        return ReverseProxyResource(self.host, self.port, self.path+'/'+path)
+        return ReverseProxyResource(self.host, self.port, self.getPath(request)+'/'+path, False)
 
     def render(self, request):
         request.received_headers['host'] = self.host
         request.content.seek(0, 0)
+
+        path = self.getPath(request)
+
         qs = urlparse.urlparse(request.uri)[4]
         if qs:
-            rest = self.path + '?' + qs
+            rest = path + '?' + qs
         else:
-            rest = self.path
+            rest = path
         clientFactory = ProxyClientFactory(request.method, rest, 
                                      request.clientproto, 
                                      request.getAllHeaders(),

From dialtone at divmod.com  Tue Dec 13 16:48:00 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Tue Dec 13 16:48:23 2005
Subject: [Twisted-web] Nevow PageCache
In-Reply-To: <20051213224302.GB23878@opteron.random>
References: <20051213224302.GB23878@opteron.random>
Message-ID: <20051213234800.GA24295@divmod.com>

On Tue, Dec 13, 2005 at 11:43:02PM +0100, Andrea Arcangeli wrote:
> I wanted to push into the tracker but I'm a bit confused on how to do
> that with trac, so I resend with the mailing list.
> 
> This patch implements html caching at the page level with a optional max
> cache size per page and with optional timeout.
> 
> Even when the timeout is very small, this makes sure that all blocked
> waiting clients gets the same copy of the html allowing the server to
> scale.
> 
> This only works for dynamic data that is the same for all users, so it's
> good for the homepage etc...
> 
> I use it online for months and I had no problems at all.

This patch is indeed robust and works as expected. But page caching in this
way should not be done at Nevow level because it's slower than it could be.

Unfortunately Nevow overrides part of twisted.web request API and thus makes
this distinction a bit blurry.
The right strategy would be to write something similar for twisted.web2 using
filters maybe. This would make the implementation significantly easier to
maintain and probably shorter.

Nevow would be the place of fragment caches (for which there is an already
implemented API as you may recall).

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051214/da8fdcc5/attachment.pgp
From dialtone at divmod.com  Tue Dec 13 16:48:25 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Tue Dec 13 16:48:42 2005
Subject: [Twisted-web] remove ugliness when creating Nevow sessions
In-Reply-To: <20051213224410.GC23878@opteron.random>
References: <20051213224410.GC23878@opteron.random>
Message-ID: <20051213234825.GB24295@divmod.com>

On Tue, Dec 13, 2005 at 11:44:10PM +0100, Andrea Arcangeli wrote:
> This isn't only ugly, it also screwup wget. I left it commented just in
> case.

Already fixed in nevow trunk

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051214/648548e5/attachment-0001.pgp
From andrea at cpushare.com  Tue Dec 13 18:42:07 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Tue Dec 13 18:42:11 2005
Subject: [Twisted-web] remove ugliness when creating Nevow sessions
In-Reply-To: <20051213234825.GB24295@divmod.com>
References: <20051213224410.GC23878@opteron.random>
	<20051213234825.GB24295@divmod.com>
Message-ID: <20051214014207.GG23878@opteron.random>

Ciao Valentino,

On Wed, Dec 14, 2005 at 12:48:25AM +0100, Valentino Volonghi wrote:
> On Tue, Dec 13, 2005 at 11:44:10PM +0100, Andrea Arcangeli wrote:
> > This isn't only ugly, it also screwup wget. I left it commented just in
> > case.
> 
> Already fixed in nevow trunk

You mean it was fixed in a different way? I don't see my patch being
applied. Perhaps only wget is fixed in the different way?

Note that I dislike the url in the web browser showing the garbage after
logging in, even if that doesn't break wget anymore ;)

From andrea at cpushare.com  Tue Dec 13 18:47:12 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Tue Dec 13 18:47:16 2005
Subject: [Twisted-web] Nevow PageCache
In-Reply-To: <20051213234800.GA24295@divmod.com>
References: <20051213224302.GB23878@opteron.random>
	<20051213234800.GA24295@divmod.com>
Message-ID: <20051214014712.GH23878@opteron.random>

On Wed, Dec 14, 2005 at 12:48:00AM +0100, Valentino Volonghi wrote:
> The right strategy would be to write something similar for twisted.web2 using
> filters maybe. This would make the implementation significantly easier to
> maintain and probably shorter.

So, we should defer it to the time nevow will switch over web2? 

> Nevow would be the place of fragment caches (for which there is an already
> implemented API as you may recall).

Yep, at some point I started using it but then it complicated things too
much and I removed them. The benefit wasn't big enough. Those caches
require explicit coding, while the PageCache is instead totally
transparent and it only requires a two liner patch to be enabled and the
patched code runs backwards compatible if run on a pristine nevow tree.
So to me the PageCache is more important and it does 99% of the work.

From dialtone at divmod.com  Tue Dec 13 19:03:19 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Tue Dec 13 19:04:38 2005
Subject: [Twisted-web] remove ugliness when creating Nevow sessions
In-Reply-To: <20051214014207.GG23878@opteron.random>
References: <20051213224410.GC23878@opteron.random>
	<20051213234825.GB24295@divmod.com>
	<20051214014207.GG23878@opteron.random>
Message-ID: <20051214020319.GC24295@divmod.com>

On Wed, Dec 14, 2005 at 02:42:07AM +0100, Andrea Arcangeli wrote:
> Ciao Valentino,

Ciao :)

> > Already fixed in nevow trunk
> 
> You mean it was fixed in a different way? I don't see my patch being
> applied. Perhaps only wget is fixed in the different way?
> 
> Note that I dislike the url in the web browser showing the garbage after
> logging in, even if that doesn't break wget anymore ;)

No, I mean that the garbage has already been removed some weeks ago (3 maybe)
in svn trunk. :)

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051214/9a66a624/attachment.pgp
From lupin2000 at gmail.com  Tue Dec 13 23:20:12 2005
From: lupin2000 at gmail.com (=?EUC-KR?B?wMy/tbOy?=)
Date: Tue Dec 13 23:20:14 2005
Subject: [Twisted-web] socket.error: (24, 'Too many open files')
Message-ID: <f1442b9b0512132220se516f6j@mail.gmail.com>

Hi.
I'm twisted beginner. and My english is not good. ^^;;

I have some troubles using Twisted.

I make a web server with Twisted.

I'd like to test my webserver performance.

So Using "httperf", I test my webserver.

But *result in*,
     File "/usr/local/lib/python2.3/site-packages/twisted/python/log.py",
line 52, in callWithContext

     File
"/usr/local/lib/python2.3/site-packages/twisted/python/context.py", line 64,
in callWithContext

     File
"/usr/local/lib/python2.3/site-packages/twisted/python/context.py", line 43,
in callWithContext

     File
"/usr/local/lib/python2.3/site-packages/twisted/internet/default.py", line
535, in _doReadOrWrite

     --- <exception caught here> ---
     File "/usr/local/lib/python2.3/site-packages/twisted/internet/tcp.py",
line 625, in doRead

     File "/usr/local/lib/python2.3/socket.py", line 167, in accept

     socket.error: (24, 'Too many open files')



I think the reason is *file open limit per one process(maybe 1024).*

how can I solve this problem?

I'd like to

If Process *can not open file*, that request make wait-status*(not allow
socket accept).*

and when Process can open file, handle the request.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20051214/41119599/attachment.htm
From therve at free.fr  Wed Dec 14 01:18:55 2005
From: therve at free.fr (Thomas HERVE)
Date: Wed Dec 14 01:20:28 2005
Subject: [Twisted-web] twisted-web file upload processing on the server
In-Reply-To: <7ccdbe1a0512131207n1af2da6bv2d1c21a0d7c4592@mail.gmail.com>
References: <7ccdbe1a0512131207n1af2da6bv2d1c21a0d7c4592@mail.gmail.com>
Message-ID: <20051214091855.52hwrlv5cswwssgc@itchy.wasabout.net>

Quoting Matthew Thorley <ruach@chpc.utah.edu>:

> Please forgive me if this is obvious, but I couldn't find the answer
> any where! I searched google, the new twisted book, the twisted-web
> docs, and the mailing list archive. I saw other posts with similar
> questions but not the answer, so here goes.

[snip]

>
> And I'm using a form like this to send the file:
>
> <form enctype="mulitpart/form-data" action="/upload"
                 ^^^^^^^^^

I don't know if it's exact extract from you page but "multipart" should work
better.

-- 
Thomas



From flashbuster at gmail.com  Wed Dec 14 03:32:18 2005
From: flashbuster at gmail.com (Sebastian Schulze)
Date: Wed Dec 14 03:32:23 2005
Subject: [Twisted-web] socket.error: (24, 'Too many open files')
In-Reply-To: <f1442b9b0512132220se516f6j@mail.gmail.com>
References: <f1442b9b0512132220se516f6j@mail.gmail.com>
Message-ID: <c2959a420512140232l113e2486x@mail.gmail.com>

I think the reason is *file open limit per one process(maybe 1024).*
>
> how can I solve this problem?
>
> I'd like to
>
> If Process *can not open file*, that request make wait-status*(not allow
> socket accept).*
>
> and when Process can open file, handle the request.
>

Linux is limiting the maximum of open files,  a quick google gave this link
which probably helps you: http://www.netadmintools.com/art295.html

In fact i think this has been mentioned on the list before (isn't there a
search feature for the mailinglist?) and if i recall correctly one can use
another reactor under linux which is optimized and doesn't have those
restrictions.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20051214/d6483173/attachment.htm
From andrea at cpushare.com  Wed Dec 14 06:20:48 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Wed Dec 14 06:20:55 2005
Subject: [Twisted-web] socket.error: (24, 'Too many open files')
In-Reply-To: <c2959a420512140232l113e2486x@mail.gmail.com>
References: <f1442b9b0512132220se516f6j@mail.gmail.com>
	<c2959a420512140232l113e2486x@mail.gmail.com>
Message-ID: <20051214132048.GE5270@opteron.random>

On Wed, Dec 14, 2005 at 11:32:18AM +0100, Sebastian Schulze wrote:
> 
>    I think the reason is file open limit per one process(maybe 1024).
> 
>    how can I solve this problem?

set ulimit -n 50000 in the bash before starting twisted. Then you'll
need epoll before you run out of fds.

From andrea at cpushare.com  Wed Dec 14 06:21:54 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Wed Dec 14 06:21:58 2005
Subject: [Twisted-web] remove ugliness when creating Nevow sessions
In-Reply-To: <20051214020319.GC24295@divmod.com>
References: <20051213224410.GC23878@opteron.random>
	<20051213234825.GB24295@divmod.com>
	<20051214014207.GG23878@opteron.random>
	<20051214020319.GC24295@divmod.com>
Message-ID: <20051214132154.GF5270@opteron.random>

On Wed, Dec 14, 2005 at 03:03:19AM +0100, Valentino Volonghi wrote:
> No, I mean that the garbage has already been removed some weeks ago (3 maybe)
> in svn trunk. :)

The garbage is still there... patch is not applied, perhaps you're not
looking into trunk?

From dialtone at divmod.com  Wed Dec 14 07:44:22 2005
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Wed Dec 14 07:44:40 2005
Subject: [Twisted-web] remove ugliness when creating Nevow sessions
In-Reply-To: <20051214132154.GF5270@opteron.random>
References: <20051213224410.GC23878@opteron.random>
	<20051213234825.GB24295@divmod.com>
	<20051214014207.GG23878@opteron.random>
	<20051214020319.GC24295@divmod.com>
	<20051214132154.GF5270@opteron.random>
Message-ID: <20051214144422.GD24295@divmod.com>

On Wed, Dec 14, 2005 at 02:21:54PM +0100, Andrea Arcangeli wrote:
> The garbage is still there... patch is not applied, perhaps you're not
> looking into trunk?

  1204         dp 
  1104         dp     def locateChild(self, ctx, segments):
  1104         dp         request = inevow.IRequest(ctx)
  1908      glyph         # ctx.remember(self, ILoginManager)
   565         dp         path = segments[0]
  1498         dp         if self.useCookies:
  1498         dp             cookie = request.getCookie(self.cookieKey)
  1498         dp         else:
  1498         dp             cookie = ''
  2469         mg         request.setupSession = lambda : self.createSession(ctx, segments)
  1908      glyph 
   565         dp         if path.startswith(SESSION_KEY):
   565         dp             key = path[len(SESSION_KEY):]
   565         dp             if key not in self.sessions:
  2469         mg                 return urlToChild(ctx, *segments[1:], **{'__start_session__':1}), ()
   565         dp             self.sessions[key].setLifetime(self.sessionLifetime)
   565         dp             if cookie == key:
   565         dp                 # /sessionized-url/${SESSION_KEY}aef9c34aecc3d9148/foo
   565         dp                 #                  ^
   565         dp                 #                  we are this getChild
   565         dp                 # with a matching cookie
   565         dp                 self.sessions[key].sessionJustStarted = True
  3148      glyph                 return urlToChild(ctx, *segments[1:]), ()


This is enough to remove the weird url.
What kind of clients are you using to still see the garbage on the
URL? I don't see it anymore with safari, firefox, ie, konqueror and some
others.

To enter the path with the garbage you would need to use an hand crafted
sessionized url with a not existing session. Otherwise it won't be touched.
Sincerely I don't think anybody will see this behaviour in action.

If you have some usecases we can change it though.

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: http://vvolonghi.blogspot.com
http://weever.berlios.de
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 186 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051214/e470130b/attachment.pgp
From andrea at cpushare.com  Thu Dec 15 16:45:48 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Thu Dec 15 16:45:56 2005
Subject: [Twisted-web] remove ugliness when creating Nevow sessions
In-Reply-To: <20051214144422.GD24295@divmod.com>
References: <20051213224410.GC23878@opteron.random>
	<20051213234825.GB24295@divmod.com>
	<20051214014207.GG23878@opteron.random>
	<20051214020319.GC24295@divmod.com>
	<20051214132154.GF5270@opteron.random>
	<20051214144422.GD24295@divmod.com>
Message-ID: <20051215234548.GL5270@opteron.random>

On Wed, Dec 14, 2005 at 03:44:22PM +0100, Valentino Volonghi wrote:
> On Wed, Dec 14, 2005 at 02:21:54PM +0100, Andrea Arcangeli wrote:
> > The garbage is still there... patch is not applied, perhaps you're not
> > looking into trunk?
> 
>   1204         dp 
>   1104         dp     def locateChild(self, ctx, segments):
>   1104         dp         request = inevow.IRequest(ctx)
>   1908      glyph         # ctx.remember(self, ILoginManager)
>    565         dp         path = segments[0]
>   1498         dp         if self.useCookies:
>   1498         dp             cookie = request.getCookie(self.cookieKey)
>   1498         dp         else:
>   1498         dp             cookie = ''
>   2469         mg         request.setupSession = lambda : self.createSession(ctx, segments)
>   1908      glyph 
>    565         dp         if path.startswith(SESSION_KEY):
>    565         dp             key = path[len(SESSION_KEY):]
>    565         dp             if key not in self.sessions:
>   2469         mg                 return urlToChild(ctx, *segments[1:], **{'__start_session__':1}), ()
>    565         dp             self.sessions[key].setLifetime(self.sessionLifetime)
>    565         dp             if cookie == key:
>    565         dp                 # /sessionized-url/${SESSION_KEY}aef9c34aecc3d9148/foo
>    565         dp                 #                  ^
>    565         dp                 #                  we are this getChild
>    565         dp                 # with a matching cookie
>    565         dp                 self.sessions[key].sessionJustStarted = True
>   3148      glyph                 return urlToChild(ctx, *segments[1:]), ()
> 
> 
> This is enough to remove the weird url.
> What kind of clients are you using to still see the garbage on the
> URL? I don't see it anymore with safari, firefox, ie, konqueror and some
> others.
> 
> To enter the path with the garbage you would need to use an hand crafted
> sessionized url with a not existing session. Otherwise it won't be touched.
> Sincerely I don't think anybody will see this behaviour in action.
> 
> If you have some usecases we can change it though.

wget seems to work fine now, but why to leave other __start_session__ if
it's not needed? Or is it needed? Sorry to ask, but I never got the
point of all these __start_session__ in the code ;)

thanks!

From m-lists at the-moon.net  Thu Dec 15 17:02:50 2005
From: m-lists at the-moon.net (Richard Wall)
Date: Thu Dec 15 17:02:51 2005
Subject: [Twisted-web] Nevow VHostMonsterResource and lighttpd
Message-ID: <43A2042A.8020609@the-moon.net>

I got Nevow examples.tac and a simple Mantissa app working behind a
lighttpd reverse proxy, by adding a VHostMonsterResource to the root
resource in each case.

However, the lighttpd proxy request headers seem to contain enough
information about the public request (scheme, hostname, port), that I
wonder if VHostMonsterResource is always necessary.

For example given lighttpd listening on localhost.localdomain:10080 and
netcat listening at localhost.localdomain:8080, the headers look like
this...

richard@lazar:~$ nc -v -l -p 8080
listening on [any] 8080 ...
connect to [127.0.0.1] from localhost.localdomain [127.0.0.1] 34734
GET / HTTP/1.0
Host: localhost.localdomain:10080
User-Agent: Mozilla/5.0 (X11; U; Linux i686; en-GB; rv:1.7.12)
Gecko/20051010 Firefox/1.0.7 (Ubuntu package 1.0.7)
Accept:
text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
Accept-Language: en-gb,en;q=0.5
Accept-Encoding: gzip,deflate
Accept-Charset: UTF-8,*
Keep-Alive: 300
X-Forwarded-For: 127.0.0.1
X-Host: localhost.localdomain:10080
X-Forwarded-Proto: http

Infact, in my case anyway, the only problem running behind a proxy is
that twisted.web refers to it's listening port instead of reading it
from the http headers. Looking at  twisted.web.server the following
change fixes the port problem for me...

Index: /home/richard/lib/Twisted/trunk/twisted/web/server.py
===================================================================
--- /home/richard/lib/Twisted/trunk/twisted/web/server.py	(revision 15339)
+++ /home/richard/lib/Twisted/trunk/twisted/web/server.py	(working copy)
@@ -342,11 +342,17 @@
         return self.session

     def _prePathURL(self, prepath):
-        port = self.getHost().port
         if self.isSecure():
             default = 443
         else:
             default = 80
+
+        hostheader = self.getHeader('host')
+        if hostheader:
+            port = int(dict(zip(('hostname', 'port'),
hostheader.split(":"))).get('port', default))
+        else:
+            port = self.getHost().port
+
         if port == default:
             hostport = ''
         else:

...which just checks if there is a host header and gets the port number
from there if it's available. I can't think that this would break
anything and I hope someone will consider applying it.

The second problem, I suppose, is with https. I haven't been able test
it yet because I haven't got ssl working with lighttpd, but i should
think the solution would be to check for the "X-Forwarded-Proto" header
and if it exists, replace the request.isSecure method as in
VHostMonsterResource. Once I am able to try this, I'll submit a patch.

I'm not sure though whether this header is standard in reverse proxies
or whether it's specific to lighttpd. Will try and check with Apache.

The only remaining need for VHostMonsterResource then, is when you want
to serve a Nevow app at a none root url. I wondered if it might be
possible to add another header (eg X-Root-Path) using mod_headers and
use that somewhere in the nevow.url class. Again, if I get chance to
test this, I'll submit a patch.
-- 
Richard Wall

PS. According to Jan Knesche, Lighttpd mod_proxy will shortly have the
ability to forward requests to a Unix socket which I think will provide
quite a neat way of doing name based virtual hosting of multiple
twisted.web sites.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: port-from-http-header.patch
Type: text/x-patch
Size: 824 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051216/1e70bd3e/port-from-http-header.bin
From andrea at cpushare.com  Fri Dec 16 06:19:08 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Fri Dec 16 06:19:16 2005
Subject: [Twisted-web] pgasync INTERVAL
Message-ID: <20051216131908.GT5270@opteron.random>

I added the interval type conversion to allow KLive to work on top of
pgasync without requiring changes to the KLive code.

However in trying to run cpushare on top of pgasync, I'm getting this
error that I didn't finish debugging yet.

2005/12/16 14:18 CET [PgProtocol,client] [Failure instance: Traceback
(failure with no frames): pgasync.errors.DatabaseError: 34000: cursor
"none" does not exist
2005/12/16 14:18 CET [PgProtocol,client] ]

I didn't extract any meaningful stack trace yet.

Index: pgasync/pgasync/fe.py
===================================================================
--- pgasync/pgasync/fe.py	(revision 86)
+++ pgasync/pgasync/fe.py	(working copy)
@@ -349,7 +349,7 @@
 
 		DEFERRED
 
-		Execute a query with he given parameters properly formatted.
+		Execute a query with the given parameters properly formatted.
 
 		The parameter style is 'pyparam,' which uses a syntax like the 
 		following:
Index: pgasync/pgasync/pgtypes.py
===================================================================
--- pgasync/pgasync/pgtypes.py	(revision 86)
+++ pgasync/pgasync/pgtypes.py	(working copy)
@@ -120,7 +120,7 @@
 	@staticmethod
 	def fromDatabase(ins):
 		if ins.count("-"):
-			ins = ins.split("-")[0] #discarding timestamp for right tnow
+			ins = ins.split("-")[0] #discarding timestamp for right now
 				
 		try:
 			h,m,sparts = ins.split(":")
@@ -157,6 +157,44 @@
 		return datetime.datetime(dt.year,dt.month,dt.day,
 		tm.hour,tm.minute,tm.second,tm.microsecond)
 
+class INTERVAL(datetime.timedelta): 
+	def __init__(self, *args):
+		datetime.timedelta.__init__(self, *args)
+
+	@staticmethod
+	def toDatabase(s):
+		return "'%d days %d seconds %d microseconds'" % (s.days, s.seconds, s.microsecond)
+
+	def __str__(self):
+		return INTERVAL.toDatabase(self)
+
+	@staticmethod
+	def fromDatabase(ins):
+		try:
+			ins = re.split(' days? ', ins)
+			if len(ins) == 1:
+				ins = ins[0]
+				d = 0
+			elif len(ins) == 2:
+				d = int(ins[0])
+				ins = ins[1]
+
+			h,m,sparts = ins.split(":")
+			h,m = map(int,(h,m))
+			if sparts.count("."):
+				ssegs = sparts.split(".")
+				s,ms = map(int,ssegs)
+				if ms:
+					l = len(ssegs[1])
+					ms *= 10 ** (6 - l)
+			else:
+				s = int(sparts)
+				ms = 0
+		except:
+			raise
+			raise DataError, ("Cannot convert string '%s' to datetime.timedelta" % ins)
+		return datetime.timedelta(days=d,hours=h,minutes=m,seconds=s,microseconds=ms)
+
 class BOOL:
 	def __init__(self, b):
 		self.__b = b
Index: pgasync/pgasync/__init__.py
===================================================================
--- pgasync/pgasync/__init__.py	(revision 86)
+++ pgasync/pgasync/__init__.py	(working copy)
@@ -47,6 +47,7 @@
 registerAdapter(DATE, [datetime.date], [PgOids.DATE])
 registerAdapter(TIME, [datetime.time], [PgOids.TIME,PgOids.ABSTIME,PgOids.RELTIME])
 registerAdapter(DATETIME, [datetime.datetime], [PgOids.TIMESTAMP])
+registerAdapter(INTERVAL, [datetime.timedelta], [PgOids.INTERVAL,PgOids.TINTERVAL])
 
 registerAdapter(BOOL, [bool], [PgOids.BOOL])
 

From andrea at cpushare.com  Fri Dec 16 07:47:34 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Fri Dec 16 07:47:39 2005
Subject: [Twisted-web] pgasync INTERVAL
In-Reply-To: <20051216131908.GT5270@opteron.random>
References: <20051216131908.GT5270@opteron.random>
Message-ID: <20051216144734.GW5270@opteron.random>

On Fri, Dec 16, 2005 at 02:19:08PM +0100, Andrea Arcangeli wrote:
> 2005/12/16 14:18 CET [PgProtocol,client] [Failure instance: Traceback
> (failure with no frames): pgasync.errors.DatabaseError: 34000: cursor
> "none" does not exist
> 2005/12/16 14:18 CET [PgProtocol,client] ]
> 
> I didn't extract any meaningful stack trace yet.

here an incremental fix for the above problem:


Index: pgasync/pgasync/format.py
===================================================================
--- pgasync/pgasync/format.py	(revision 86)
+++ pgasync/pgasync/format.py	(working copy)
@@ -7,10 +7,6 @@
 from errors import *
 from registry import *
 
-from decimal import Decimal
-# Types that are already suitable for str() representation
-donetypes  = [STRING,UNICODE,BINARY,NUMBER,ROWID,DATETIME,BOOL,MONEY,int,float,Decimal]
-
 def typeCastParam(p):
 	"""Cast p to the appropriate type if possible.
 	"""
@@ -36,7 +32,7 @@
 	binary sequences, etc
 	"""
 
-	s = s.strip()
+	s = s.strip().replace('\n', ' ')
 	if s[-1] == ";":
 		s = s[:-1]
 

Please apply both patches to trunk thanks!

From andrea at cpushare.com  Fri Dec 16 09:19:46 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Fri Dec 16 09:19:54 2005
Subject: [Twisted-web] pgasync INTERVAL
In-Reply-To: <20051216131908.GT5270@opteron.random>
References: <20051216131908.GT5270@opteron.random>
Message-ID: <20051216161946.GX5270@opteron.random>

On Fri, Dec 16, 2005 at 02:19:08PM +0100, Andrea Arcangeli wrote:
> +class INTERVAL(datetime.timedelta): 
> +	def __init__(self, *args):
> +		datetime.timedelta.__init__(self, *args)
> +
> +	@staticmethod
> +	def toDatabase(s):
> +		return "'%d days %d seconds %d microseconds'" % (s.days, s.seconds, s.microsecond)
										      ^^^^^^^^^^^s

After more testing I noticed there was a typo sorry, please add the 's'
by hand after applying the patch thanks.

From jim at zope.com  Fri Dec 16 10:27:15 2005
From: jim at zope.com (Jim Fulton)
Date: Fri Dec 16 10:27:23 2005
Subject: [Twisted-web] Re: [Twisted-Python] WSGI Thread-management strategy
In-Reply-To: <B50EC6B5-6B3D-4254-9FC5-AD0CE32CC568@fuhm.net>
References: <43A1DE8D.8030604@zope.com>
	<B50EC6B5-6B3D-4254-9FC5-AD0CE32CC568@fuhm.net>
Message-ID: <43A2F8F3.4020701@zope.com>

James Y Knight wrote:
> (BTW, the correct mailing list for twisted webbish stuff is twisted- 
> web@twistedmatrix.com)
> On Dec 15, 2005, at 4:22 PM, Jim Fulton wrote:
> 
>> The strategy used by twisted WSGI, as I understand it, doesn't meet
>> our needs. Currently, a thread is created for each request.  The total
>> number of threads is throttled, I gather using a general Twisted
>> thread limit.  WSGI applications are called as soon as input headers
>> have been received completely. An application may be called before all
>> body input is received.  We need application calls to be delayed until
>> all request input has been received,
>>
>> [...]
>>
>> I propose that the default thread-management strategy should be to  delay
>> calling an application until all request input has been received. If
>> this isn't the default, then there should at least be an option to get
>> this behavior.  (Of course, the buffering strategy needs to be clever
>> enough to switch to a file when the input gets over some size.)
> 
> 
> Sounds sensible,

Does this mean you will make this the default in the future?


 > and is doable external to the WSGI wrapper. Here's a
> little bit I whipped up. (works on the 2.1.x branch and head). Could  be 
> smarter, by starting out the buffer in memory and switching to a  file 
> if necessary. Also shows off a couple of minor bugs I need to  fix. :)
> 
> def simple_wsgi_app(environ, start_response):
>     print "Starting wsgi app"
>     start_response("200 OK", [('Content-type','text/html;  
> charset=ISO-8859-1')])
>     data = environ['wsgi.input'].read()
>     return ['<pre>', data, '</pre>']
> 
> 
> class Prebuffer(resource.WrapperResource):
>     def hook(self, ctx):
>         req = iweb.IRequest(ctx)
>         temp = tempfile.TemporaryFile()
>         def done(_):
>             temp.seek(0)
>             # Replace the request's stream object with the tempfile
>             req.stream = stream.FileStream(temp)
>             # Hm, this shouldn't be required:
>             req.stream.doStartReading = None
>         return stream.readStream(req.stream, temp.write).addCallback (done)
> 
>     # Oops, fix missing () in lambda in WrapperResource
>     def locateChild(self, ctx, segments):
>         x = self.hook(ctx)
>         if x is not None:
>             return x.addCallback(lambda data: (self.res, segments))
>         return self.res, segments
> 
> if __name__ == '__builtin__':
>     from twisted.application import service, strports
>     from twisted.web2 import server, channel
> 
>     res = Prebuffer(wsgi.WSGIResource(simple_wsgi_app))
> 
>     site = server.Site(res)
>     application = service.Application("demo")
> 
>     s = strports.service('tcp:8080', channel.HTTPFactory(site))
>     s.setServiceParent(application)

This is greek to me. I'd forward this to the people who did the
Twisted Zope integration.

Thanks!

Jim

-- 
Jim Fulton           mailto:jim@zope.com       Python Powered!
CTO                  (540) 361-1714            http://www.python.org
Zope Corporation     http://www.zope.com       http://www.zope.org

From drakesmith at adelphia.net  Sat Dec 17 05:10:39 2005
From: drakesmith at adelphia.net (Drake Smith)
Date: Sat Dec 17 05:11:13 2005
Subject: [Twisted-web] Using Twisted Web for browser-based control
Message-ID: <5.1.0.14.0.20051217065305.02661620@mail.adelphia.net>

An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20051217/f8ecb72f/attachment.htm
From drakesmith at adelphia.net  Sat Dec 17 06:08:40 2005
From: drakesmith at adelphia.net (Drake Smith)
Date: Sat Dec 17 06:09:36 2005
Subject: [Twisted-web] Using Twisted Web for browser-based control
Message-ID: <5.1.0.14.0.20051217080825.026b2da8@mail.adelphia.net>

(non-HTML version.....sorry about that)

I use Twisted Web on an embedded Linux device to provide browser-based 
configuration & control. The browser displays a bar graph of a parameter 
that is quickly changing on the embedded device (peak audio level). In 
order to provide a reasonable feedback to the user, the browser connects to 
the Twisted Web CGI server once a second via XMLHTTPRequest to obtain an 
updated bar graph level, then Twisted Web dutifully closes the connection. 
Is there a way to achieve the same thing without opening & closing a 
connection each time?

My code:

# ----- Set up the web/CGI server to handle browser-based control -----
from twisted.web import server, static, twcgi
root = static.File("/myResourceDir")
root.putChild("cgi-bin", twcgi.CGIDirectory("/myResourceDir/cgi-bin"))
reactor.listenTCP(8000, server.Site(root))

Thank you.


From mithrandi-twisted-web at mithrandi.za.net  Sat Dec 17 07:03:55 2005
From: mithrandi-twisted-web at mithrandi.za.net (Tristan Seligmann)
Date: Sat Dec 17 07:04:02 2005
Subject: [Twisted-web] Using Twisted Web for browser-based control
In-Reply-To: <5.1.0.14.0.20051217080825.026b2da8@mail.adelphia.net>
References: <5.1.0.14.0.20051217080825.026b2da8@mail.adelphia.net>
Message-ID: <20051217140354.GA30235@mithrandi.za.net>

* Drake Smith <drakesmith@adelphia.net> [2005-12-17 08:08:40 -0500]:

> I use Twisted Web on an embedded Linux device to provide browser-based 
> configuration & control. The browser displays a bar graph of a parameter 
> that is quickly changing on the embedded device (peak audio level). In 
> order to provide a reasonable feedback to the user, the browser connects to 
> the Twisted Web CGI server once a second via XMLHTTPRequest to obtain an 
> updated bar graph level, then Twisted Web dutifully closes the connection. 
> Is there a way to achieve the same thing without opening & closing a 
> connection each time?

Yes. The easiest way would be to use something like nevow.athena, which
takes care of the XHR connection for you, allowing you to concentrate on
the higher-level communication between browser and server.
-- 
mithrandi, i Ainil en-Balandor, a faer Ambar
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: Digital signature
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051217/fb15d7aa/attachment.pgp
From andrea at cpushare.com  Sat Dec 17 07:31:13 2005
From: andrea at cpushare.com (Andrea Arcangeli)
Date: Sat Dec 17 07:31:21 2005
Subject: [Twisted-web] interface.queryDescriptionFor instead of getattr
Message-ID: <20051217143113.GY5270@opteron.random>

I noticed a deprecation warning, and I tried to fix it but it breaks
stuff so I backed it out, I post it just in case somebody can make a
right fix for the deprecation warning. This intermediate step between
compy and zope interfaces is very confusing.

Also note I totally dislike interfaces, all of them, no matter if
they're form zope, twisted, nevow.copy or whatever else interface.
They're an huge waste of cpu too, I wish all code was written without
them. Unless I'm absolutely forced by things like nevow, I never use
the interfaces insanity in my code. Perhaps I will change my mind after
I stop seeing all my cpu sucked by them, but at the moment I would never
dream to touch them in my code.

I strongly reccomend people to never use interfaces, they're a bad idea,
language lawyers may appreciate them so they can put to work all
features of python, but if you want your code simple, fast and readable
you should always avoid them.

2005/12/17 15:22 CET [HTTPChannel,0,127.0.0.1]
/home/andrea/bin/x86_64/python/lib/python2.4/site-packages/formless/webform.py:460:
twisted.python.components.ComponentsDeprecationWarning: Don't get
attributes (in this case, '__spec__') off Interface, use
.queryDescriptionFor() etc. instead

Index: configurable.py
===================================================================
--- configurable.py	(revision 3683)
+++ configurable.py	(working copy)
@@ -30,7 +30,7 @@
         for interface in ifs:
             ## TypedInterfaces have a __spec__ attribute which is a list of all Typed properties and
             ## autocallable methods
-            for binding in getattr(interface, '__spec__', []):
+            for binding in interface.queryDescriptionFor('__spec__', []):
                 bindingDict[binding.name] = binding
                 if binding.name not in bindingNames:
                     bindingNames.append(binding.name)
@@ -162,7 +162,7 @@
         bindingNames = []
         self.bindingDict = bindingDict = {}
         interface = self.groupInterface
-        for binding in getattr(interface, '__spec__', []):
+        for binding in interface.queryDescriptionFor('__spec__', []):
             bindingDict[binding.name] = binding
             if binding.name not in bindingNames:
                 bindingNames.append(binding.name)

From agoryunov at list.ru  Sat Dec 17 14:22:50 2005
From: agoryunov at list.ru (A. Goryunov)
Date: Sat Dec 17 14:22:51 2005
Subject: [Twisted-web] Standard sequence renderer "loosing" tags?
Message-ID: <43A481AA.3050600@list.ru>

I've noticed that Page.renderString() "swallows" some of the stan nodes. 
I've also tried the example below in an actual Twisted service and got 
the same result. Doing it with an XML template also yields erroneous 
output. Namely, it looses "table", "tr", a couple of "td" tags were MIA 
too I believe, as well as two "input"s.

The code I was using for testing is attached. It's supposed to be a 
library of widgets that are constructed using Fragments and render_sequence.

-------------- next part --------------
from nevow import tags as T
from nevow import flat, rend, loaders




class TestPage(rend.Page):
    docFactory = loaders.stan(
        T.html[
            T.body[
                T.invisible(render=T.directive("widget"))[
                    T.invisible(pattern="widget_name")['PortalContent'],
                    T.invisible(pattern="widget_slot")['main_content'],
                    T.invisible(pattern="widget_slot")[
                        T.invisible(render=T.directive("widget"))[
                            T.invisible(pattern="widget_name")['PortalBarVert'],
                            T.invisible(pattern="widget_slot")[
                                T.invisible(render=T.directive("widget"))[
                                    T.invisible(pattern="widget_name")['LoginForm'],
                                    T.invisible(pattern="widget_slot")['Sign in'],
                                    T.invisible(pattern="widget_slot")['User: '],
                                    T.invisible(pattern="widget_slot")['Password: '],
                                    T.invisible(pattern="widget_slot")[T.input(type="submit", name="null", value="Submit")]
                                ]
                            ]
                        ]
                    ]
                ]
            ]])

    def render_widget(self,ctx,data):
        wName = ctx.tag.onePattern("widget_name").children[0].strip('\n\t ')
        attrs = ctx.tag.allPatterns("widget_slot")
        args = []
        for attr in attrs:
            args.append(T.xml(attr.children))
        try:
            wdgt = globals()[wName](args)
            return ctx.tag[wdgt]
        except IndexError:
            return ctx.tag[T.p(style="font-color : red")["Unknown widget name: %s" % wName]]
        
        
class LoginForm(rend.Fragment):
    docFactory = loaders.stan(
        T.div(class_="login-form", render=T.directive("sequence"))[
            T.p(class_="small-form-title", pattern="item", render=T.directive('arg')),
            T.form(action="_submit", method="post")[
                T.table(id="login-form-table")[
                    T.tr[
                        T.td(align="right")[
                            T.label(for_="user", pattern="item", render=T.directive('arg'))
                            ],
                        T.td(align="left")[
                            T.input(type="text", name="user",
                                    class_="login-input")
                            ]
                        ],
                    T.tr[
                        T.td(align="right")[
                            T.label(for_="pass", pattern="item", render=T.directive('arg'))
                            ],
                        T.td(align="left")[
                            T.input(type="password", name="pass",
                                    class_="login-input")
                            ]
                        ],
                    T.tr[T.td(colspan="2")],
                    T.tr[
                        T.td(colspan="2", align="center", pattern="item", render=T.directive('arg'))
                        ]
                    ]
                ]
            ])

    def render_arg(self,ctx,data):
        return ctx.tag[data]

class PortalContent(rend.Fragment):
    docFactory = loaders.stan(
        T.table(id="portal-content", render=T.directive("sequence"))[
            T.tr[
                T.td(class_="portal-content-main", pattern='item', render=T.directive('arg')),
                T.td(class_="portal-content-sidebar", id="portal-sidebar-right",
                     pattern="item", render=T.directive("arg"))
                ]
            ])

    def render_arg(self,ctx,data):
        return ctx.tag[data]
    
class PortalBarVert(rend.Fragment):
    docFactory = loaders.stan(
        T.table(class_="portal-bar-vertical", render=T.directive('sequence'))[
            T.tr(pattern='item', render=T.directive('arg'))
            ])

    def render_arg(self,ctx,data):
        return ctx.tag[T.td(class_='vert-sidebar-slot')[data]]



page = TestPage()
df = page.renderString()
def printPage(result):
    print result

def printErr(err):
    print err
df.addCallback(printPage)
df.addErrback(printErr)
From agoryunov at list.ru  Sat Dec 17 14:31:56 2005
From: agoryunov at list.ru (A. Goryunov)
Date: Sat Dec 17 14:31:56 2005
Subject: [Twisted-web] Standard sequence renderer "loosing" tags?
In-Reply-To: <43A481AA.3050600@list.ru>
References: <43A481AA.3050600@list.ru>
Message-ID: <43A483CC.1050107@list.ru>

Nevermind that - I figured out that the sequence renderer only returns 
those tags that have either "pattern" or "render" specials, so it  seems 
to randomly loose stuff.

A. Goryunov wrote:
> I've noticed that Page.renderString() "swallows" some of the stan 
> nodes. I've also tried the example below in an actual Twisted service 
> and got the same result. Doing it with an XML template also yields 
> erroneous output. Namely, it looses "table", "tr", a couple of "td" 
> tags were MIA too I believe, as well as two "input"s.
>
> The code I was using for testing is attached. It's supposed to be a 
> library of widgets that are constructed using Fragments and 
> render_sequence.
>
> ------------------------------------------------------------------------
>
> from nevow import tags as T
> from nevow import flat, rend, loaders
>
>
>
>
> class TestPage(rend.Page):
>     docFactory = loaders.stan(
>         T.html[
>             T.body[
>                 T.invisible(render=T.directive("widget"))[
>                     T.invisible(pattern="widget_name")['PortalContent'],
>                     T.invisible(pattern="widget_slot")['main_content'],
>                     T.invisible(pattern="widget_slot")[
>                         T.invisible(render=T.directive("widget"))[
>                             T.invisible(pattern="widget_name")['PortalBarVert'],
>                             T.invisible(pattern="widget_slot")[
>                                 T.invisible(render=T.directive("widget"))[
>                                     T.invisible(pattern="widget_name")['LoginForm'],
>                                     T.invisible(pattern="widget_slot")['Sign in'],
>                                     T.invisible(pattern="widget_slot")['User: '],
>                                     T.invisible(pattern="widget_slot")['Password: '],
>                                     T.invisible(pattern="widget_slot")[T.input(type="submit", name="null", value="Submit")]
>                                 ]
>                             ]
>                         ]
>                     ]
>                 ]
>             ]])
>
>     def render_widget(self,ctx,data):
>         wName = ctx.tag.onePattern("widget_name").children[0].strip('\n\t ')
>         attrs = ctx.tag.allPatterns("widget_slot")
>         args = []
>         for attr in attrs:
>             args.append(T.xml(attr.children))
>         try:
>             wdgt = globals()[wName](args)
>             return ctx.tag[wdgt]
>         except IndexError:
>             return ctx.tag[T.p(style="font-color : red")["Unknown widget name: %s" % wName]]
>         
>         
> class LoginForm(rend.Fragment):
>     docFactory = loaders.stan(
>         T.div(class_="login-form", render=T.directive("sequence"))[
>             T.p(class_="small-form-title", pattern="item", render=T.directive('arg')),
>             T.form(action="_submit", method="post")[
>                 T.table(id="login-form-table")[
>                     T.tr[
>                         T.td(align="right")[
>                             T.label(for_="user", pattern="item", render=T.directive('arg'))
>                             ],
>                         T.td(align="left")[
>                             T.input(type="text", name="user",
>                                     class_="login-input")
>                             ]
>                         ],
>                     T.tr[
>                         T.td(align="right")[
>                             T.label(for_="pass", pattern="item", render=T.directive('arg'))
>                             ],
>                         T.td(align="left")[
>                             T.input(type="password", name="pass",
>                                     class_="login-input")
>                             ]
>                         ],
>                     T.tr[T.td(colspan="2")],
>                     T.tr[
>                         T.td(colspan="2", align="center", pattern="item", render=T.directive('arg'))
>                         ]
>                     ]
>                 ]
>             ])
>
>     def render_arg(self,ctx,data):
>         return ctx.tag[data]
>
> class PortalContent(rend.Fragment):
>     docFactory = loaders.stan(
>         T.table(id="portal-content", render=T.directive("sequence"))[
>             T.tr[
>                 T.td(class_="portal-content-main", pattern='item', render=T.directive('arg')),
>                 T.td(class_="portal-content-sidebar", id="portal-sidebar-right",
>                      pattern="item", render=T.directive("arg"))
>                 ]
>             ])
>
>     def render_arg(self,ctx,data):
>         return ctx.tag[data]
>     
> class PortalBarVert(rend.Fragment):
>     docFactory = loaders.stan(
>         T.table(class_="portal-bar-vertical", render=T.directive('sequence'))[
>             T.tr(pattern='item', render=T.directive('arg'))
>             ])
>
>     def render_arg(self,ctx,data):
>         return ctx.tag[T.td(class_='vert-sidebar-slot')[data]]
>
>
>
> page = TestPage()
> df = page.renderString()
> def printPage(result):
>     print result
>
> def printErr(err):
>     print err
> df.addCallback(printPage)
> df.addErrback(printErr)
>   
> ------------------------------------------------------------------------
>
> _______________________________________________
> Twisted-web mailing list
> Twisted-web@twistedmatrix.com
> http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
>   

From drakesmith at adelphia.net  Sat Dec 17 22:23:18 2005
From: drakesmith at adelphia.net (Drake Smith)
Date: Sat Dec 17 22:23:12 2005
Subject: [Twisted-web] Using Twisted Web for browser-based control
In-Reply-To: <20051217140354.GA30235@mithrandi.za.net>
References: <5.1.0.14.0.20051217080825.026b2da8@mail.adelphia.net>
	<5.1.0.14.0.20051217080825.026b2da8@mail.adelphia.net>
Message-ID: <5.1.0.14.0.20051217235439.0269d3c0@mail.adelphia.net>

At 04:03 PM 12/17/2005 +0200, you wrote:
>* Drake Smith <drakesmith@adelphia.net> [2005-12-17 08:08:40 -0500]:
>
> > I use Twisted Web on an embedded Linux device to provide browser-based
> > configuration & control. The browser displays a bar graph of a parameter
> > that is quickly changing on the embedded device (peak audio level). In
> > order to provide a reasonable feedback to the user, the browser 
> connects to
> > the Twisted Web CGI server once a second via XMLHTTPRequest to obtain an
> > updated bar graph level, then Twisted Web dutifully closes the connection.
> > Is there a way to achieve the same thing without opening & closing a
> > connection each time?
>
>Yes. The easiest way would be to use something like nevow.athena, which
>takes care of the XHR connection for you, allowing you to concentrate on
>the higher-level communication between browser and server.
>--
>mithrandi, i Ainil en-Balandor, a faer Ambar

Tristan, thank you for pointing out nevow.athena -- I did not know of it. I 
did know
of livepage but I was hoping for something less involved. On the other 
hand, the
ability to freely communicate back and forth between browser and server without
the need for a plug-in is so important that I'm willing to take the plunge 
into nevow.

Kindly let me know if there is any documentation on athena other than the
athena.py and .js modules that reside in the nevow 0.6.0 release, otherwise 
I will
find my way through the source and Twisted-web archives.


From exarkun at divmod.com  Sat Dec 17 22:37:02 2005
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Sat Dec 17 22:37:05 2005
Subject: [Twisted-web] Using Twisted Web for browser-based control
In-Reply-To: <5.1.0.14.0.20051217235439.0269d3c0@mail.adelphia.net>
Message-ID: <20051218053702.1217.756320239.divmod.quotient.6797@ohm>

On Sun, 18 Dec 2005 00:23:18 -0500, Drake Smith <drakesmith@adelphia.net> wrote:
>At 04:03 PM 12/17/2005 +0200, you wrote:
>>* Drake Smith <drakesmith@adelphia.net> [2005-12-17 08:08:40 -0500]:
>>
>> > I use Twisted Web on an embedded Linux device to provide browser-based
>> > configuration & control. The browser displays a bar graph of a parameter
>> > that is quickly changing on the embedded device (peak audio level). In
>> > order to provide a reasonable feedback to the user, the browser connects 
>>to
>> > the Twisted Web CGI server once a second via XMLHTTPRequest to obtain an
>> > updated bar graph level, then Twisted Web dutifully closes the 
>>connection.
>> > Is there a way to achieve the same thing without opening & closing a
>> > connection each time?
>>
>>Yes. The easiest way would be to use something like nevow.athena, which
>>takes care of the XHR connection for you, allowing you to concentrate on
>>the higher-level communication between browser and server.
>>--
>>mithrandi, i Ainil en-Balandor, a faer Ambar
>
>Tristan, thank you for pointing out nevow.athena -- I did not know of it. I 
>did know
>of livepage but I was hoping for something less involved. On the other hand, 
>the
>ability to freely communicate back and forth between browser and server 
>without
>the need for a plug-in is so important that I'm willing to take the plunge 
>into nevow.
>
>Kindly let me know if there is any documentation on athena other than the
>athena.py and .js modules that reside in the nevow 0.6.0 release, otherwise 
>I will
>find my way through the source and Twisted-web archives.

There is a handful of examples in current trunk@HEAD, in examples/athenademo/.  Note that the API in 0.6 is not quite the same as the API in current trunk.  If you're going to use Athena, I recommend tracking development, rather than sticking to the latest release (at least until the next release, after which things should settle down quite a bit).

Also note that Athena opens and closes a lot of sockets.  I am not sure why this might matter, but you seemed to indicate it was a problem in your initial post, so I wanted to point it out before you got too deep into anything.

Jean-Paul

From tv at twistedmatrix.com  Sun Dec 18 02:22:05 2005
From: tv at twistedmatrix.com (Tommi Virtanen)
Date: Sun Dec 18 02:22:12 2005
Subject: [Twisted-web] Using Twisted Web for browser-based control
In-Reply-To: <5.1.0.14.0.20051217065305.02661620@mail.adelphia.net>
References: <5.1.0.14.0.20051217065305.02661620@mail.adelphia.net>
Message-ID: <43A52A3D.8050302@twistedmatrix.com>

Drake Smith wrote:
> I use Twisted Web on an embedded Linux device to provide browser-based
> configuration & control. The browser displays a bar graph of a parameter
> that is quickly changing on the embedded device (peak audio level). In
> order to provide a reasonable feedback to the user, the browser connects
> to the Twisted Web CGI server once a second via XMLHTTPRequest to obtain
> an updated bar graph level, then Twisted Web dutifully closes the
> connection. Is there a way to achieve the same thing without opening &
> closing a connection each time?

AJAXy things in nevow.athena may be attracting to you, as pointed out
elsewhere. If you for some reason don't want to use them, the old school
way is to have the bar graph as a GIF with more than one frame, and
stream the frames whenever you want to update the picture; that keeps
a single connection open to the server, pushing more data exactly when
you want to. Of course, it is limited to updating 1-4 GIF images.

From drakesmith at adelphia.net  Sun Dec 18 06:44:03 2005
From: drakesmith at adelphia.net (Drake Smith)
Date: Sun Dec 18 06:44:02 2005
Subject: [Twisted-web] Using Twisted Web for browser-based control
In-Reply-To: <43A52A3D.8050302@twistedmatrix.com>
References: <5.1.0.14.0.20051217065305.02661620@mail.adelphia.net>
	<5.1.0.14.0.20051217065305.02661620@mail.adelphia.net>
Message-ID: <5.1.0.14.0.20051218081845.02694cb8@mail.adelphia.net>

At 11:22 AM 12/18/2005 +0200, you wrote:
>Drake Smith wrote:
> > I use Twisted Web on an embedded Linux device to provide browser-based
> > configuration & control. The browser displays a bar graph of a parameter
> > that is quickly changing on the embedded device (peak audio level). In
> > order to provide a reasonable feedback to the user, the browser connects
> > to the Twisted Web CGI server once a second via XMLHTTPRequest to obtain
> > an updated bar graph level, then Twisted Web dutifully closes the
> > connection. Is there a way to achieve the same thing without opening &
> > closing a connection each time?
>
>AJAXy things in nevow.athena may be attracting to you, as pointed out
>elsewhere. If you for some reason don't want to use them, the old school
>way is to have the bar graph as a GIF with more than one frame, and
>stream the frames whenever you want to update the picture; that keeps
>a single connection open to the server, pushing more data exactly when
>you want to. Of course, it is limited to updating 1-4 GIF images.

Thanks for chiming-in Tommi because keeping the connection open is really 
where I was leaning. I never had any luck doing this with Python's 
CGIHTTPServer module but I expect this will be no problem with Twisted Web 
or at least Twisted Web2. I am eager to revisit the "open connection" 
approach in light of JP's implication that AJAX-like functionality does not 
necessarily reduce the traffic between client & server -- my original goal. 
Be that as it may, athena.livepage is such an improvement over HTTP's 
request/response model that I will pursue that as well.


From m-lists at the-moon.net  Sun Dec 18 12:26:49 2005
From: m-lists at the-moon.net (Richard Wall)
Date: Sun Dec 18 12:26:52 2005
Subject: [Twisted-web] Nevow VHostMonsterResource and lighttpd
In-Reply-To: <43A2042A.8020609@the-moon.net>
References: <43A2042A.8020609@the-moon.net>
Message-ID: <43A5B7F9.80409@the-moon.net>

On 16/12/05 00:02 Richard Wall wrote:
> Infact, in my case anyway, the only problem running behind a proxy is
> that twisted.web refers to it's listening port instead of reading it
> from the http headers. Looking at  twisted.web.server the following
> change fixes the port problem for me...

Maybe that last patch was a bit daft. I've attached a better version.
Hope someone will consider applying it.
-- 
Richard Wall
-------------- next part --------------
A non-text attachment was scrubbed...
Name: port-from-http-hostheader-v2.patch
Type: text/x-patch
Size: 1020 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051218/c3e10fc0/port-from-http-hostheader-v2.bin
From maillists at ivsn.com  Sun Dec 18 13:17:42 2005
From: maillists at ivsn.com (Paul Reznicek)
Date: Sun Dec 18 13:18:23 2005
Subject: [Twisted-web] s: *
	select-with-other quick patch for  renderImmutable
In-Reply-To: <049.7391379ad24a911014d7d997addaadff@pollenation.net>
References: <049.7391379ad24a911014d7d997addaadff@pollenation.net>
Message-ID: <43A5C3E6.8000808@ivsn.com>

Hi Matt,

Attached a quick (an dirty) solution for  renderImmutable
in  class SelectOtherChoice.
For me, it's better solution than raising an error ...

The SelectOtherChoice - widget is nice and very helpful,
Thanks !
Paul
-------------- next part --------------
Index: widget.py 
=================================================================== 
--- widget.py	(Revision 164) 
+++ widget.py	(Arbeitskopie) 
@@ -367,7 +367,9 @@ 
         return tag 
  
     def renderImmutable(self, ctx, key, args, errors): 
-        raise NotImplemented 
+##        raise NotImplemented 
+        return SelectChoice(self.original, zip(self.options, self.options) 
+                ).renderImmutable( ctx, key, args, errors) 
  
     def processInput(self, ctx, key, args): 
         value = self._valueFromRequestArgs(key, args) 
From paul-lists at perforge.com  Mon Dec 19 13:27:55 2005
From: paul-lists at perforge.com (Paul G)
Date: Mon Dec 19 13:27:55 2005
Subject: [Twisted-web] xpost: multiple job openings
Message-ID: <00e801c604da$b1c3f930$6402a8c0@dcore>

folks,

i'm crossposting this to twisted-python-l and twisted-web-l for the benefit 
of those who don't read both. apologies to those who will consequently have 
to read this twice.

---
We've got multiple job openings for great engineers familiar with python and 
twisted, senior and junior positions available. We're building a small team 
of folks who like working hard, solving interesting problems, writing clean 
code and having fun doing it. If you got into coding because that's where 
the money was in the '90s, please skip this one and see my next job posting 
where I'm recruiting bodyguards for work in the Persian Gulf.

The dev team is run by an engineer ('run' in the sense that I shield you 
from the crazy business folk), so it is a strict meritocracy. You will be 
working on rebuilding/refactoring an existing PHP (ugh) web application into 
python services built on top of twisted as well as implementing new 
features. This is a high volume system, with millions of transactions a 
day - if you dig concurrency, you won't be bored. Must be able to handle the 
excitement ;)

Requirements:
* We're looking for great engineers - while your ability to discuss 
Wittgenstein over our 5th beer is welcome,
  a piece of paper^W^W^Wdiploma is not required.
* You should be old enough not to get us in trouble with Amnesty 
International for child exploitation.
* Experience working on hobby, open source and commercial projects counts 
with me.
* Python/Twisted and SQL a must.
* Reading/grokking bad PHP code a big plus. Writing PHP code useful, since 
we'll be hacking in the twisted/python bits over time.
* Javascript/DHTML/AJAX(ugh, buzzowrd) familiarity needed in at least one 
hire, so a plus.
* Experience with C and ASM good in that it is a good predictor of your 
understanding of memory allocation and performance issues.
* Don't mention Java, unless it has caused a medical (eg mental health) 
problem we should know about. <grin>
* Understanding of performance and scalability principles and issues.

Work environment:
* Onsite in NYC/NY Metro area strongly preferred.
* Don't let the above deter you - we can make telecommuting work under the 
right conditions.
* Competitive compensation - I know what good people are worth and have 
managed to beat that into the management with a clue-by-four.
* Flex time - relaxed cluture - getting your job done is all that matters.
---

Shoot me a resume, CV, writeup of what you've done, absolutely anything. Put 
[twisted-resume] in the subject. Include your phone number, time zone and a 
good time to call. I'll respond to everyone.

cheers,
-p 


From wsanchez at wsanchez.net  Tue Dec 20 10:38:21 2005
From: wsanchez at wsanchez.net (=?ISO-8859-1?Q?Wilfredo_S=E1nchez_Vega?=)
Date: Tue Dec 20 10:39:56 2005
Subject: [Twisted-web] (no subject)
Message-ID: <02414200-0262-4C97-9B4D-0340A41CE9F2@wsanchez.net>

   I think I'm ready to do a merge of the DAV branch.

   exarkun, I think I've addressed all on the list you sent me.

   Anyone else want to review the code first?  Other objections?

   I'll give you some targets to criticize:

   - The DAV property store code depends on Bob Ippolito's xattr  
library, which works on Mac OS, some Linuxes, and possible FreeBSD.   
Non-Mac uses require a filesystem that supports it.

   Alternate property stores are not going to be had to plug in, and  
we have several ways to proceed there, but I think these are  
generally out of scope for work on this branch, which I'm trying to  
keep from growing into a large and scary thing.

   - I use datetime in XML processing, which is apparently a Python  
2.3+ feature.  It would be unfortunate to have to avoid datetime,  
though, since it would mean adding the relevant code to twisted  
somewhere.

   The datetime issue we can either wave off by saying you need 2.3  
to use dav, or we go ahead and copy in a bunch of code.  I'd prefer  
to do that after merging if we think it's necessary to do so.  I vote  
for requiring 2.3, but maybe that's my inner laziness talking.

   - Some python files have capital letters.  exarkun says that may  
bug some people, specifically Windows types.  Is it actually a problem?

   I can fix the capital letters if it's an issue.

	-wsv

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 2746 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20051220/23b41fb1/smime.bin
From foom at fuhm.net  Tue Dec 20 11:10:53 2005
From: foom at fuhm.net (James Y Knight)
Date: Tue Dec 20 11:11:11 2005
Subject: =?ISO-8859-1?Q?Re:_[Twisted-web]_WebDAV=A0branch_merge?=
In-Reply-To: <02414200-0262-4C97-9B4D-0340A41CE9F2@wsanchez.net>
References: <02414200-0262-4C97-9B4D-0340A41CE9F2@wsanchez.net>
Message-ID: <FBE3F2BA-5C12-4CE5-94E6-8DDC702F0F5E@fuhm.net>


On Dec 20, 2005, at 12:38 PM, Wilfredo S?nchez Vega wrote:

>   - I use datetime in XML processing, which is apparently a Python  
> 2.3+ feature.  It would be unfortunate to have to avoid datetime,  
> though, since it would mean adding the relevant code to twisted  
> somewhere.
>
>   The datetime issue we can either wave off by saying you need 2.3  
> to use dav, or we go ahead and copy in a bunch of code.  I'd prefer  
> to do that after merging if we think it's necessary to do so.  I  
> vote for requiring 2.3, but maybe that's my inner laziness talking.

If 2.2 support is required, I would suggest taking the datetime.py  
module from pypy (from Python, was translated to C, and then the C  
implementation was modified slightly. Then PyPy imported it from  
Python and modified to match the C impl).

Or 2.2 could just be dropped.

James
From dreid at dreid.org  Tue Dec 20 11:25:36 2005
From: dreid at dreid.org (David Reid)
Date: Tue Dec 20 11:25:35 2005
Subject: =?ISO-8859-1?Q?Re:_[Twisted-web]_WebDAV=A0branch_merge?=
In-Reply-To: <FBE3F2BA-5C12-4CE5-94E6-8DDC702F0F5E@fuhm.net>
References: <02414200-0262-4C97-9B4D-0340A41CE9F2@wsanchez.net>
	<FBE3F2BA-5C12-4CE5-94E6-8DDC702F0F5E@fuhm.net>
Message-ID: <2349F290-9725-4E9D-B7DF-9F9DFE675FAB@dreid.org>


On Dec 20, 2005, at 10:10 AM, James Y Knight wrote:

>
> On Dec 20, 2005, at 12:38 PM, Wilfredo S?nchez Vega wrote:
>
>>   - I use datetime in XML processing, which is apparently a Python  
>> 2.3+ feature.  It would be unfortunate to have to avoid datetime,  
>> though, since it would mean adding the relevant code to twisted  
>> somewhere.
>>
>>   The datetime issue we can either wave off by saying you need 2.3  
>> to use dav, or we go ahead and copy in a bunch of code.  I'd  
>> prefer to do that after merging if we think it's necessary to do  
>> so.  I vote for requiring 2.3, but maybe that's my inner laziness  
>> talking.
>
> If 2.2 support is required, I would suggest taking the datetime.py  
> module from pypy (from Python, was translated to C, and then the C  
> implementation was modified slightly. Then PyPy imported it from  
> Python and modified to match the C impl).
>
> Or 2.2 could just be dropped.
>
> James

I'm not sure that there is a policy for minimum version support  
across subprojects, but I support bumping the minimum python  
requirement for Twisted.web2 to python2.3.  I'm a little bit more  
bothered by the xattr requirement.  I'd support making this pluggable  
atleast before release (even if we only have a single xattr based  
implementation)  But I'm leaning towards that this shouldn't block  
the merge, as there is significant interest in Dav and it's generally  
better to branch from trunk (i.e. to improve vfs usage *ahem* stephen.)

-David


From mike at mkp.ca  Tue Dec 20 13:07:49 2005
From: mike at mkp.ca (Mike Pelletier)
Date: Tue Dec 20 13:08:04 2005
Subject: [Twisted-web] Off topic: streaming animated GIFs
In-Reply-To: <43A52A3D.8050302@twistedmatrix.com>
References: <5.1.0.14.0.20051217065305.02661620@mail.adelphia.net>
	<43A52A3D.8050302@twistedmatrix.com>
Message-ID: <200512201507.49736.mike@mkp.ca>

On Sun December 18 2005 04:22, Tommi Virtanen wrote:
> the old school
> way is to have the bar graph as a GIF with more than one frame, and
> stream the frames whenever you want to update the picture; that keeps
> a single connection open to the server, pushing more data exactly when
> you want to. Of course, it is limited to updating 1-4 GIF images.

This is a really great idea!  Are there any gotchas that should be mentioned?  
Does the GIF header not specify the number of frames?  And even if the GIF 
isn't looped, would browsers be smart enough to discard data from previous 
frames?  It seems like it might cause what would effectively be a memory leak 
on the browser.

Just wondering whether this is suitable to be applied whenever you wished you 
could just write to a frame buffer on a client, or if it should be used 
sparringly for brief special effects.

Mike.

From ldanielburr at mac.com  Tue Dec 20 13:10:20 2005
From: ldanielburr at mac.com (L. Daniel Burr)
Date: Tue Dec 20 13:10:27 2005
Subject: =?utf-8?Q?=5BTwisted-web=5D_WebDAV?=
	=?utf-8?Q?=C2=A0branch_merge?=
In-Reply-To: <2349F290-9725-4E9D-B7DF-9F9DFE675FAB@dreid.org>
References: <02414200-0262-4C97-9B4D-0340A41CE9F2@wsanchez.net>
	<FBE3F2BA-5C12-4CE5-94E6-8DDC702F0F5E@fuhm.net>
	<2349F290-9725-4E9D-B7DF-9F9DFE675FAB@dreid.org>
Message-ID: <op.s13mbird3oj628@zetsuei>

On Tue, 20 Dec 2005 12:25:36 -0600, David Reid <dreid@dreid.org> wrote:

>
> I'm not sure that there is a policy for minimum version support across  
> subprojects, but I support bumping the minimum python requirement for  
> Twisted.web2 to python2.3.  I'm a little bit more bothered by the xattr  
> requirement.  I'd support making this pluggable atleast before release  
> (even if we only have a single xattr based implementation)  But I'm  
> leaning towards that this shouldn't block the merge, as there is  
> significant interest in Dav and it's generally better to branch from  
> trunk (i.e. to improve vfs usage *ahem* stephen.)
>
> -David
>

Has anyone taken a peek at the WebDAV implementation that was done for  
Google's Summer of Code?  I think it was called PyFileServer, or something  
like that.  Just wondering if that author came up with a solution that  
didn't require xattr.

Daniel

From wsanchez at wsanchez.net  Tue Dec 20 14:21:41 2005
From: wsanchez at wsanchez.net (=?ISO-8859-1?Q?Wilfredo_S=E1nchez_Vega?=)
Date: Tue Dec 20 14:21:48 2005
Subject: =?ISO-8859-1?Q?Re:_[Twisted-web]_WebDAV=A0branch_merge?=
In-Reply-To: <2349F290-9725-4E9D-B7DF-9F9DFE675FAB@dreid.org>
References: <02414200-0262-4C97-9B4D-0340A41CE9F2@wsanchez.net>
	<FBE3F2BA-5C12-4CE5-94E6-8DDC702F0F5E@fuhm.net>
	<2349F290-9725-4E9D-B7DF-9F9DFE675FAB@dreid.org>
Message-ID: <18F86855-1034-42A1-A546-1DF014CF05BF@wsanchez.net>

   Yep.  The xattr code is all in xattrprops.py, which defines a  
class xattrPropertyStore.  In dav/static.py, we have, in the class  
DAVFile:

     dead_properties = property(xattrPropertyStore)

   xattrPropertyStore could easily be replaced with any other  
callable that returns a dict-like object which will store the dead  
properties.

   That shouldn't be too far from what we need for pluggability.

	-wsv


On Dec 20, 2005, at 10:25 AM, David Reid wrote:

> I'm not sure that there is a policy for minimum version support  
> across subprojects, but I support bumping the minimum python  
> requirement for Twisted.web2 to python2.3.  I'm a little bit more  
> bothered by the xattr requirement.  I'd support making this  
> pluggable atleast before release (even if we only have a single  
> xattr based implementation)  But I'm leaning towards that this  
> shouldn't block the merge, as there is significant interest in Dav  
> and it's generally better to branch from trunk (i.e. to improve vfs  
> usage *ahem* stephen.)


From dreid at dreid.org  Tue Dec 20 14:25:29 2005
From: dreid at dreid.org (David Reid)
Date: Tue Dec 20 14:25:27 2005
Subject: =?ISO-8859-1?Q?Re:_[Twisted-web]_WebDAV=A0branch_merge?=
In-Reply-To: <op.s13mbird3oj628@zetsuei>
References: <02414200-0262-4C97-9B4D-0340A41CE9F2@wsanchez.net>
	<FBE3F2BA-5C12-4CE5-94E6-8DDC702F0F5E@fuhm.net>
	<2349F290-9725-4E9D-B7DF-9F9DFE675FAB@dreid.org>
	<op.s13mbird3oj628@zetsuei>
Message-ID: <80074CC2-32BD-4839-9C66-D63A0C6825F3@dreid.org>



On Dec 20, 2005, at 12:10 PM, L. Daniel Burr wrote:

> On Tue, 20 Dec 2005 12:25:36 -0600, David Reid <dreid@dreid.org>  
> wrote:
>
>>
>> I'm not sure that there is a policy for minimum version support  
>> across subprojects, but I support bumping the minimum python  
>> requirement for Twisted.web2 to python2.3.  I'm a little bit more  
>> bothered by the xattr requirement.  I'd support making this  
>> pluggable atleast before release (even if we only have a single  
>> xattr based implementation)  But I'm leaning towards that this  
>> shouldn't block the merge, as there is significant interest in Dav  
>> and it's generally better to branch from trunk (i.e. to improve  
>> vfs usage *ahem* stephen.)
>>
>> -David
>>
>
> Has anyone taken a peek at the WebDAV implementation that was done  
> for Google's Summer of Code?  I think it was called PyFileServer,  
> or something like that.  Just wondering if that author came up with  
> a solution that didn't require xattr.
>
> Daniel
>

I was not aware of any such implementation, was this using Twisted?   
Really xattr is an implementation detail, and should be easily  
abstracted into a more pluggable solution.

-David

From glyph at divmod.com  Tue Dec 20 15:31:50 2005
From: glyph at divmod.com (glyph@divmod.com)
Date: Tue Dec 20 15:31:51 2005
Subject: [Twisted-web] WebDAV branch merge
In-Reply-To: <FBE3F2BA-5C12-4CE5-94E6-8DDC702F0F5E@fuhm.net>
Message-ID: <20051220223150.1217.644033133.divmod.quotient.7401@ohm>



On Tue, 20 Dec 2005 13:10:53 -0500, James Y Knight <foom@fuhm.net> wrote:
>
>On Dec 20, 2005, at 12:38 PM, Wilfredo S?nchez Vega wrote:
>>   - I use datetime in XML processing, which is apparently a Python  2.3+ 
>>feature.  It would be unfortunate to have to avoid datetime,  though, since 
>>it would mean adding the relevant code to twisted  somewhere.
>>
>>   The datetime issue we can either wave off by saying you need 2.3  to use 
>>dav, or we go ahead and copy in a bunch of code.  I'd prefer  to do that 
>>after merging if we think it's necessary to do so.  I  vote for requiring 
>>2.3, but maybe that's my inner laziness talking.
>

(A)
>If 2.2 support is required, I would suggest taking the datetime.py  module 
>from pypy (from Python, was translated to C, and then the C  implementation 
>was modified slightly. Then PyPy imported it from  Python and modified to 
>match the C impl).
(B)
>Or 2.2 could just be dropped.

Let's just start with option A since it involves less discussion :).  It sounds easy, anyway - if it's not, (B) seems like an eventual inevitability anyway, so let's do that if the discussion that will ensue on t-py will be less effort than porting datetime.

From andrew-twisted at puzzling.org  Tue Dec 20 21:28:11 2005
From: andrew-twisted at puzzling.org (Andrew Bennetts)
Date: Tue Dec 20 21:17:38 2005
Subject: [Twisted-web] Off topic: streaming animated GIFs
In-Reply-To: <200512201507.49736.mike@mkp.ca>
References: <5.1.0.14.0.20051217065305.02661620@mail.adelphia.net>
	<43A52A3D.8050302@twistedmatrix.com>
	<200512201507.49736.mike@mkp.ca>
Message-ID: <20051221042810.GJ8331@home.puzzling.org>

On Tue, Dec 20, 2005 at 03:07:49PM -0500, Mike Pelletier wrote:
> On Sun December 18 2005 04:22, Tommi Virtanen wrote:
> > the old school
> > way is to have the bar graph as a GIF with more than one frame, and
> > stream the frames whenever you want to update the picture; that keeps
> > a single connection open to the server, pushing more data exactly when
> > you want to. Of course, it is limited to updating 1-4 GIF images.
> 
> This is a really great idea!  Are there any gotchas that should be mentioned?  
> Does the GIF header not specify the number of frames?  And even if the GIF 
> isn't looped, would browsers be smart enough to discard data from previous 
> frames?  It seems like it might cause what would effectively be a memory leak 
> on the browser.

Yep, I believe it does slowly eat memory.  In theory browsers could discard old
frames, but I don't think any are smart enough to.

Of course, I've no idea if more modern AJAX stuff is any better in practice ;)

-Andrew.


From tv at twistedmatrix.com  Wed Dec 21 02:02:18 2005
From: tv at twistedmatrix.com (Tommi Virtanen)
Date: Wed Dec 21 02:02:20 2005
Subject: [Twisted-web] Off topic: streaming animated GIFs
In-Reply-To: <200512201507.49736.mike@mkp.ca>
References: <5.1.0.14.0.20051217065305.02661620@mail.adelphia.net>	<43A52A3D.8050302@twistedmatrix.com>
	<200512201507.49736.mike@mkp.ca>
Message-ID: <43A91A1A.7060001@twistedmatrix.com>

Mike Pelletier wrote:
> This is a really great idea!  Are there any gotchas that should be mentioned?  
> Does the GIF header not specify the number of frames?  And even if the GIF 
> isn't looped, would browsers be smart enough to discard data from previous 
> frames?  It seems like it might cause what would effectively be a memory leak 
> on the browser.

The standard trick is to make the containing html page (or iframe)
refresh itself every once in a while, to free the memory etc.

I've written a (prototype of a) video surveillance system long, long ago
in the era of Perl CGIs, with this basic architecture. It worked well
enough to never cause any negative feedback.

> Just wondering whether this is suitable to be applied whenever you wished you 
> could just write to a frame buffer on a client, or if it should be used 
> sparringly for brief special effects.

For generic use, nevow.canvas, SVG+CSS+AJAX or XUL (nufox?) or something
like that sounds a lot better.

From tv at twistedmatrix.com  Wed Dec 21 02:07:44 2005
From: tv at twistedmatrix.com (Tommi Virtanen)
Date: Wed Dec 21 02:07:45 2005
Subject: [Twisted-web] Off topic: streaming animated GIFs
In-Reply-To: <200512201507.49736.mike@mkp.ca>
References: <5.1.0.14.0.20051217065305.02661620@mail.adelphia.net>	<43A52A3D.8050302@twistedmatrix.com>
	<200512201507.49736.mike@mkp.ca>
Message-ID: <43A91B60.3070108@twistedmatrix.com>

Mike Pelletier wrote:
> This is a really great idea!  Are there any gotchas that should be mentioned?  
> Does the GIF header not specify the number of frames?  And even if the GIF 

Dug up old code with more concrete things. Now that I look at it in more
detail, there were problems with multiframe GIFs, so I ended up doing
this:

HTTP/1.1 200 OK
Connection: close
Content-type: multipart/x-mixed-replace; boundary=--myboundary
Pragma: no-cache
Cache-Control: no-cache

--myboundary
Content-Type: image/jpeg

<put a jpeg here>
--myboundary
<delay for e.g. 5 seconds here>Content-Type: image/jpeg

<put a jpeg here>
--myboundary
etc etc..

just make sure you close that stream at some point, at least at that
time Netscape on windows did not obey refreshes dictated by HTTP headers
if the page contained an <img> that was still being pushed.

From rob at securecognition.com  Tue Dec 27 23:04:01 2005
From: rob at securecognition.com (Rob McMillen)
Date: Wed Dec 28 00:04:04 2005
Subject: [Twisted-web] XMLRPC and sessions
Message-ID: <bf6b07a70512272204i262851afn7aa2263c5b9adb15@mail.gmail.com>

I am trying to build an XMLRPC server that utilizes sessions to keep
track of authenticated users.  However, I have not been able to find
too much on session management and the only way I have figured out how
to get at the site from within the XMLRPC server is by overriding the
render method.  Is this the proper way?  Are there other ways to do
it?  I am currently thinking about adding a mechanism to store the uid
and time in a db.

Any help would be great!

Rob

class Handler(xmlrpc.XMLRPC):
   def __init__(self, cmd_schema, cmd_xml):
      log.msg("Using %s and %s to configure api" % (cmd_schema, cmd_xml))
      self.api = API(cmd_schema, cmd_xml)

      log.msg("Preparing authentication mechanism")
      self.creds = Creds()

      log.msg("Preparing role mechanism")
      self.roles = Roles()

   def render(self, request):
      s = request.site.makeSession()
      print s.uid
      return xmlrpc.XMLRPC.render(self, request)

   def xmlrpc_login(self, user, password):
      return self.creds.authenticate(user, password).addErrback(
         self.handleError)

if __name__ == "__main__":
   import sys
   from twisted.internet import reactor
   from twisted.python import log

   log.startLogging(sys.stdout)

   site = server.Site(Handler('conf/api.xsd', 'conf/api.xml'))
   reactor.listenSSL(8000, site, ServerContextFactory('etc/host.pem',
'etc/host.pem'))
   reactor.run()

From jim at zope.com  Fri Dec 30 09:30:42 2005
From: jim at zope.com (Jim Fulton)
Date: Fri Dec 30 10:30:50 2005
Subject: [Twisted-web] Re: [Twisted-Python] WSGI Thread-management strategy
In-Reply-To: <B50EC6B5-6B3D-4254-9FC5-AD0CE32CC568@fuhm.net>
References: <43A1DE8D.8030604@zope.com>
	<B50EC6B5-6B3D-4254-9FC5-AD0CE32CC568@fuhm.net>
Message-ID: <43B560B2.4040309@zope.com>

James Y Knight wrote:
> (BTW, the correct mailing list for twisted webbish stuff is twisted- 
> web@twistedmatrix.com)
> On Dec 15, 2005, at 4:22 PM, Jim Fulton wrote:
> 
>> The strategy used by twisted WSGI, as I understand it, doesn't meet
>> our needs. Currently, a thread is created for each request.  The total
>> number of threads is throttled, I gather using a general Twisted
>> thread limit.  WSGI applications are called as soon as input headers
>> have been received completely. An application may be called before all
>> body input is received.  We need application calls to be delayed until
>> all request input has been received,
>>
>> [...]
>>
>> I propose that the default thread-management strategy should be to  delay
>> calling an application until all request input has been received. If
>> this isn't the default, then there should at least be an option to get
>> this behavior.  (Of course, the buffering strategy needs to be clever
>> enough to switch to a file when the input gets over some size.)
> 
> 
> Sounds sensible, and is doable external to the WSGI wrapper. Here's a  
> little bit I whipped up. (works on the 2.1.x branch and head). Could  be 
> smarter, by starting out the buffer in memory and switching to a  file 
> if necessary. Also shows off a couple of minor bugs I need to  fix. :)
> 
> def simple_wsgi_app(environ, start_response):
>     print "Starting wsgi app"
>     start_response("200 OK", [('Content-type','text/html;  
> charset=ISO-8859-1')])
>     data = environ['wsgi.input'].read()
>     return ['<pre>', data, '</pre>']
> 
> 
> class Prebuffer(resource.WrapperResource):
>     def hook(self, ctx):
>         req = iweb.IRequest(ctx)
>         temp = tempfile.TemporaryFile()
>         def done(_):
>             temp.seek(0)
>             # Replace the request's stream object with the tempfile
>             req.stream = stream.FileStream(temp)
>             # Hm, this shouldn't be required:
>             req.stream.doStartReading = None
>         return stream.readStream(req.stream, temp.write).addCallback (done)
> 
>     # Oops, fix missing () in lambda in WrapperResource
>     def locateChild(self, ctx, segments):
>         x = self.hook(ctx)
>         if x is not None:
>             return x.addCallback(lambda data: (self.res, segments))
>         return self.res, segments
> 
> if __name__ == '__builtin__':
>     from twisted.application import service, strports
>     from twisted.web2 import server, channel
> 
>     res = Prebuffer(wsgi.WSGIResource(simple_wsgi_app))
> 
>     site = server.Site(res)
>     application = service.Application("demo")
> 
>     s = strports.service('tcp:8080', channel.HTTPFactory(site))
>     s.setServiceParent(application)
> 

This doesn't work for me if the input gets over a 8K,
It turns out the MMap wrapper is broken.  When the resulting stream
is read, the first line of output seems to be a mmap repr:

  <mmap.mmap object at 0xb68ef6c0>

and subsequent calls to readline return '\n'.

Disabling MMap support makes this work.

Debugging this was a bit frightening.  To read a line
from a temporary file, we end up calling the reactor.  Is all
this indirection and machinery really necessary to read a
temporary file? That question is mostly rhetorical. :)

Jim

-- 
Jim Fulton           mailto:jim@zope.com       Python Powered!
CTO                  (540) 361-1714            http://www.python.org
Zope Corporation     http://www.zope.com       http://www.zope.org

