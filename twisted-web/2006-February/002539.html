<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Some help with Nevow and databse I/O
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Some%20help%20with%20Nevow%20and%20databse%20I/O&In-Reply-To=200602241011.31364.egaumer%40pagecache.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002538.html">
   <LINK REL="Next"  HREF="002540.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Some help with Nevow and databse I/O</H1>
    <B>Valentino Volonghi aka Dialtone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Some%20help%20with%20Nevow%20and%20databse%20I/O&In-Reply-To=200602241011.31364.egaumer%40pagecache.org"
       TITLE="[Twisted-web] Some help with Nevow and databse I/O">dialtone at divmod.com
       </A><BR>
    <I>Fri Feb 24 13:29:23 MST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002538.html">[Twisted-web] Some help with Nevow and databse I/O
</A></li>
        <LI>Next message: <A HREF="002540.html">[Twisted-web] Some help with Nevow and databse I/O
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2539">[ date ]</a>
              <a href="thread.html#2539">[ thread ]</a>
              <a href="subject.html#2539">[ subject ]</a>
              <a href="author.html#2539">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 24 Feb 2006 10:11:21 -0800, Eric Gaumer &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">egaumer at pagecache.org</A>&gt; wrote:
&gt;<i>Hello everyone,
</I>
Hi

&gt;<i>I have two questions that are somewhat interrelated. In my test cases I have
</I>&gt;<i>authentication (using nevow session guard) setup using a SHA stored via the
</I>&gt;<i>shelve module.
</I>
This is technically wrong.

Let me explain why:
Yes, you are using nevow session guard to have authentication but no, it is not guard that is setup to use a SHA stored via the shelve module. The thing that is setup in that way is twisted.cred.

In fact guard is only glue that is used to get credentials from a request and pass them to twisted.cred.

Why do I tell you this? Because it means that you don't have to change your application in order to change the source of authentication data.

And yet people say that cred/guard is crappy... Oh man. :)

&gt;<i>The true customer info is stored in a MySQL database. I can pull that data
</I>&gt;<i>doing the following:
</I>&gt;<i>
</I>&gt;<i>    def data_query(self, context, data):
</I>&gt;<i>        return self.dbpool.runQuery('SELECT name, email, id, TransferType,
</I>&gt;<i>		basic_charge, over_charge, permitted_transfer FROM Customers')
</I>&gt;<i>
</I>&gt;<i>I've read Abe's book on twisted and on page 54 he states &quot;Nevow is designed
</I>&gt;<i>from the ground up for Twisted, which means you can use Deferreds everywhere&quot;
</I>
&gt;<i>My question is do I have to use the adbapi module or can I use deferreds to
</I>&gt;<i>handle database queries?
</I>
adbapi module returns deferreds for each of the 3 methods:

DBPool.runQuery
DBPool.runOperation
DBPool.runInteraction

&gt;<i>I've read the docs on deferreds but I'd be lying if I said I can fully wrap my
</I>&gt;<i>brain around all aspects of the concept or how it's implemented.
</I>
class Deferred(list):
    def addCallback(self, fun, *args, **kwargs):
        self.append((fun, args, kwargs))

    def callback(self, initial_value):
        for fun, args, kwargs in self:
            initial_value = fun(initial_value, *args, **kwargs)
        return initial_value

Easy isn't it?

&gt;<i>I don't understand why I would need separate threads in the first place. I
</I>&gt;<i>know that the query would block but isn't that transaction being done via
</I>&gt;<i>sockets anyway? Why can't I use the same mechanism (deferred) I would use, to
</I>&gt;<i>say, defer work waiting on a response from a mail server? Can't I submit a
</I>&gt;<i>query, have the reactor go do something else, and have a callback run when
</I>&gt;<i>the data becomes available? Why do I need to spawn threads to avoid blocking?
</I>
deferreds don't make blocking code non-blocking, they are just a different mechanism to register callbacks. Instead of doing:

button.handle_event('clicked', list_of_callbacks)

you do

button.clicked().addCallback(callback1).addCallback(callback2)

You need to spawn a thread because there is hardly any database adapter that is written to be async, and those that are written to be async are either buggy or not complete or not really usable, plus having deferreds after every query in python (which doesn't support deferreds natively) makes coding a lot harder (you can deal with some deferreds here and there, but not with 10 deferreds each function).

If you want to do N operations at the same time just use runInteraction instead of runQuery (but this doesn't seem to be the case).

&gt;<i>I can live with using the adbapi but wonder if it's possible to simply defer
</I>&gt;<i>that work and use a callback mechanism (I'm using the original twisted.web
</I>&gt;<i>not twisted.web2).
</I>
As I said above, authentication has almost nothing to do with guard and a lot to do with twisted.cred. Cred chapter in Abe's book is one of the best ones in the book thus I suggest you to read it.

&gt;<i>I was pretty much heading down this road but I don't really understand how
</I>&gt;<i>else to do it. I've browsed many examples and have never really come across
</I>&gt;<i>one that involves session.guard, newvow, and db access all in the same
</I>&gt;<i>application. Anyone have any experience they could share?
</I>
I can give you an example of how to deal with authentication using a real database:
<A HREF="http://svn.berlios.de/viewcvs/weever/trunk/src/users/auth.py?view=markup">http://svn.berlios.de/viewcvs/weever/trunk/src/users/auth.py?view=markup</A>
This code uses the 'old' twisted interfaces and is a bit rusty, nevertheless it shows the basic concepts and how to authenticate against a database.

I'm working on a pet project these days which is still very early in development ( <A HREF="http://vise.teknico.net/">http://vise.teknico.net/</A> ) but I'll have some code cleaned up and ready to be showed in not so long and of course it does authentication against a database using SQLAlchemy as an abstraction layer (it is integrated with twisted in an interesting way).

-- 
Valentino Volonghi aka Dialtone
Now Running MacOSX 10.4
Blog: <A HREF="http://vvolonghi.blogspot.com">http://vvolonghi.blogspot.com</A>
New Pet: <A HREF="http://www.stiq.it">http://www.stiq.it</A>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002538.html">[Twisted-web] Some help with Nevow and databse I/O
</A></li>
	<LI>Next message: <A HREF="002540.html">[Twisted-web] Some help with Nevow and databse I/O
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2539">[ date ]</a>
              <a href="thread.html#2539">[ thread ]</a>
              <a href="subject.html#2539">[ subject ]</a>
              <a href="author.html#2539">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
