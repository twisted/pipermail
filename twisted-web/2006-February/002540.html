<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Some help with Nevow and databse I/O
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Some%20help%20with%20Nevow%20and%20databse%20I/O&In-Reply-To=20060224202923.6122.64740389.divmod.quotient.6877%40ohm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002539.html">
   <LINK REL="Next"  HREF="002541.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Some help with Nevow and databse I/O</H1>
    <B>Eric Gaumer</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Some%20help%20with%20Nevow%20and%20databse%20I/O&In-Reply-To=20060224202923.6122.64740389.divmod.quotient.6877%40ohm"
       TITLE="[Twisted-web] Some help with Nevow and databse I/O">egaumer at pagecache.org
       </A><BR>
    <I>Fri Feb 24 14:49:01 MST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002539.html">[Twisted-web] Some help with Nevow and databse I/O
</A></li>
        <LI>Next message: <A HREF="002541.html">[Twisted-web] Some help with Nevow and databse I/O
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2540">[ date ]</a>
              <a href="thread.html#2540">[ thread ]</a>
              <a href="subject.html#2540">[ subject ]</a>
              <a href="author.html#2540">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Friday 24 February 2006 12:29 pm, Valentino Volonghi aka Dialtone wrote:

&gt;<i> &gt;I have two questions that are somewhat interrelated. In my test cases I
</I>&gt;<i> &gt; have authentication (using nevow session guard) setup using a SHA stored
</I>&gt;<i> &gt; via the shelve module.
</I>&gt;<i>
</I>&gt;<i> This is technically wrong.
</I>
Sorry. I should have clarified a bit. I am authenticating with twisted.cred 
using a class/method like this:

class AuthMech(object):
    implements(checkers.ICredentialsChecker)
    credentialInterfaces = (credentials.IUsernamePassword,)

    def _checkPasswd(self, cipher, password):
        cipher = base64.decodestring(str(cipher))
        salt, hash = cipher[:4], cipher[4:]
        hash2 = sha.new(salt + password).digest()
        return hash2 == hash

p.registerChecker(pages.AuthMech())
r = guard.SessionWrapper(p)

&gt;<i> Let me explain why:
</I>&gt;<i> Yes, you are using nevow session guard to have authentication but no, it is
</I>&gt;<i> not guard that is setup to use a SHA stored via the shelve module. The
</I>&gt;<i> thing that is setup in that way is twisted.cred.
</I>&gt;<i>
</I>&gt;<i> In fact guard is only glue that is used to get credentials from a request
</I>&gt;<i> and pass them to twisted.cred.
</I>&gt;<i>
</I>&gt;<i> Why do I tell you this? Because it means that you don't have to change your
</I>&gt;<i> application in order to change the source of authentication data.
</I>&gt;<i>
</I>&gt;<i> And yet people say that cred/guard is crappy... Oh man. :)
</I>
Not crappy at all, in fact it's been very easy to get running and seems to 
work perfectly. I haven't really encountered any problems and my questions 
are more about doing things the &quot;right&quot; way rather than just getting it 
working.

&gt;<i>
</I>&gt;<i> &gt;The true customer info is stored in a MySQL database. I can pull that data
</I>&gt;<i> &gt;doing the following:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    def data_query(self, context, data):
</I>&gt;<i> &gt;        return self.dbpool.runQuery('SELECT name, email, id, TransferType,
</I>&gt;<i> &gt;		basic_charge, over_charge, permitted_transfer FROM Customers')
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;I've read Abe's book on twisted and on page 54 he states &quot;Nevow is
</I>&gt;<i> &gt; designed from the ground up for Twisted, which means you can use
</I>&gt;<i> &gt; Deferreds everywhere&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;My question is do I have to use the adbapi module or can I use deferreds
</I>&gt;<i> &gt; to handle database queries?
</I>&gt;<i>
</I>&gt;<i> adbapi module returns deferreds for each of the 3 methods:
</I>&gt;<i>
</I>&gt;<i> DBPool.runQuery
</I>&gt;<i> DBPool.runOperation
</I>&gt;<i> DBPool.runInteraction
</I>
So I have to use the adbapi (threads) regardless? Okay I can handle that but 
my question now is what's the most efficient way to go about it?

Referring to Glyph's blog post, he claims most twisted developers are misusing 
the adbapi interface.

My concern is this, my code thus far looks pretty good. I've reviewed many 
examples of bits and pieces and generally have a decent feel for what I'm 
doing. Now that my application &quot;framework&quot; is basically setup (XHTML, 
templates, authentication, server, etc...) I'm to the point where I need to 
interface with an existing SQL database to retrieve data to fill in some 
templates.

This sort of method works fine:

    def data_query(self, context, data):
        return self.dbpool.runQuery('SELECT name, email, id, TransferType,
		basic_charge, over_charge, permitted_transfer FROM Customers')

But I'm wondering if this the best way to use the adbapi interface.

I guess I have questions concerning when should I connect. As it stands I 
connect in the class constructor like this:

class ListCustomers(rend.Page):
    def __init__(self, user):
        self.dbpool = adbapi.ConnectionPool(...

My gut says this is wrong because now each page class contains a connection 
object. That really seems to be more of a general Python design issue and I 
could probably come up with a better solution.

But what about queries themselves? Is it bad design to run a query from each 
data_* method for all data methods in all page objects? I have three methods 
to work with:

DBPool.runQuery
DBPool.runOperation
DBPool.runInteraction

You mentioned runInteraction above. Would it be more wise to provide a general 
data_* method that did several queries and stored (cached) that data in the 
Page object itself for later retieval?

Each page has to do some database I/O but it would be helpful to not have to 
do it everytime a page is refreshed or as the user goes back and forth 
through pages since the data is unlikely to change that quickly.

I'm looking for some insight as to how handle this type of scenario from a 
Twisted/Nevow perspective. It's obvious that database I/O is going to slow 
things down a bit but there must be a &quot;best case&quot; situation that avoids 
unnecessary queries.

&gt;<i> &gt;I've read the docs on deferreds but I'd be lying if I said I can fully
</I>&gt;<i> &gt; wrap my brain around all aspects of the concept or how it's implemented.
</I>&gt;<i>
</I>&gt;<i> class Deferred(list):
</I>&gt;<i>     def addCallback(self, fun, *args, **kwargs):
</I>&gt;<i>         self.append((fun, args, kwargs))
</I>&gt;<i>
</I>&gt;<i>     def callback(self, initial_value):
</I>&gt;<i>         for fun, args, kwargs in self:
</I>&gt;<i>             initial_value = fun(initial_value, *args, **kwargs)
</I>&gt;<i>         return initial_value
</I>&gt;<i>
</I>&gt;<i> Easy isn't it?
</I>
Yes, it's the &quot;deferreds don't make blocking code non-blocking&quot; part that can 
get a bit confusing. I've never really had to think about blocking vs. 
non-blocking calls and truthfully I like it. It forces you to be a little 
more conscious about what you're doing. I'm really stoked about not using 
threads because they are such a nightmare to debug.

&gt;<i> deferreds don't make blocking code non-blocking, they are just a different
</I>&gt;<i> mechanism to register callbacks. Instead of doing:
</I>&gt;<i>
</I>&gt;<i> button.handle_event('clicked', list_of_callbacks)
</I>&gt;<i>
</I>&gt;<i> you do
</I>&gt;<i>
</I>&gt;<i> button.clicked().addCallback(callback1).addCallback(callback2)
</I>
This chaining is very cool. So what actually makes the code non-blocking? The 
use of select() sys calls? I guess that's where my hangup is. How can we take 
a connection to a mail server and defer that result but yet we can't do the 
same for a database connection? At the OS level, aren't they both sockets 
that can be watched via select()?

My head hurts :-)

&gt;<i>
</I>&gt;<i> You need to spawn a thread because there is hardly any database adapter
</I>&gt;<i> that is written to be async, and those that are written to be async are
</I>&gt;<i> either buggy or not complete or not really usable, plus having deferreds
</I>&gt;<i> after every query in python (which doesn't support deferreds natively)
</I>&gt;<i> makes coding a lot harder (you can deal with some deferreds here and there,
</I>&gt;<i> but not with 10 deferreds each function).
</I>
When you say adapter your are referring to (in this case) MySQLdb or it's 
underlying _mysql module or yet even lower down to the C api?

If I wanted to implement a limited set of queries, could I write some 
non-blocking way of doing that and wrap those functions in Deferred objects. 
A silly question I guess because it's obviously possible. I guess I should 
ask if it's feasible. Maybe just attempting this as an exercise would give me 
greater understanding of how Twisted provides non-blocking calls.

&gt;<i> If you want to do N operations at the same time just use runInteraction
</I>&gt;<i> instead of runQuery (but this doesn't seem to be the case).
</I>
No it isn't the case but it is wise for me to do runQuery() calls in each 
data_ method of each page or should I be looking for some way to unify 
queries and cache that data?

Thanks,

-- 
Eric Gaumer
Debian GNU/Linux PPC
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">egaumer at pagecache.org</A>
<A HREF="http://egaumer.pagecache.org">http://egaumer.pagecache.org</A>
PGP/GPG Key 0xF15D41E9
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20060224/d63812a6/attachment.pgp">http://twistedmatrix.com/pipermail/twisted-web/attachments/20060224/d63812a6/attachment.pgp</A>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002539.html">[Twisted-web] Some help with Nevow and databse I/O
</A></li>
	<LI>Next message: <A HREF="002541.html">[Twisted-web] Some help with Nevow and databse I/O
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2540">[ date ]</a>
              <a href="thread.html#2540">[ thread ]</a>
              <a href="subject.html#2540">[ subject ]</a>
              <a href="author.html#2540">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
