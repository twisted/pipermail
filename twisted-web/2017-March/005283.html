<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] internal vs. external hostname in	Request.getHost9)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3CCAOG7vkx5hDm_Mb9v12rMKnva%3DwYbB328Zxux_CesdSSnZQXq6w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005282.html">
   <LINK REL="Next"  HREF="005284.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] internal vs. external hostname in	Request.getHost9)</H1>
    <B>Ilya Skriblovsky</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3CCAOG7vkx5hDm_Mb9v12rMKnva%3DwYbB328Zxux_CesdSSnZQXq6w%40mail.gmail.com%3E"
       TITLE="[Twisted-web] internal vs. external hostname in	Request.getHost9)">ilyaskriblovsky at gmail.com
       </A><BR>
    <I>Wed Mar 15 02:20:59 MDT 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="005282.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
        <LI>Next message: <A HREF="005284.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5283">[ date ]</a>
              <a href="thread.html#5283">[ thread ]</a>
              <a href="subject.html#5283">[ subject ]</a>
              <a href="author.html#5283">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok, so in the sort term you are suggesting to change Request.URLPath
(uppercased method? Hmm) to use Host header instead of getRequestHostname
and to change Klein to use it instead of Request.getHost(), right?
Sounds wise and reasonable :)

But I'd like to add one more thing. In order to build correct external URL
we need to know is it http or https. Currently URLPath is using
Request.isSecure(), but it is not sufficient since Request.isSecure() just
checks if backend connection is SSL while encryption is often terminated at
a reverse proxy. Can we add &quot;useXForwardedProto=False&quot; argument to
Request.URLPath() and check X-Forwarded-Proto header if it is true? And may
be add &quot;useXForwardedHost=False&quot; too to simplify setting up a reverse proxy
(with a bold red warning in docstring that it can be set to True only if
reverse proxy is correctly configured to drop corresponding
client-specified headers). What do you think?

-- ilya

&#1089;&#1088;, 15 &#1084;&#1072;&#1088;. 2017 &#1075;. &#1074; 9:10, Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">glyph at twistedmatrix.com</A>&gt;:

&gt;<i> On Mar 14, 2017, at 3:00 PM, Ilya Skriblovsky &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">ilyaskriblovsky at gmail.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;<i> Tickets you have mentioned and forwarded-for-5807 branch are mostly about
</I>&gt;<i> parsing X-Forwarded-For in order to obtain correct client IP. While it is
</I>&gt;<i> valuable task, it is not what strikes me right now.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Sorry, I was pretty tired when I wrote that message, and I realize that I
</I>&gt;<i> was getting server identification and client identification mixed up.
</I>&gt;<i>
</I>&gt;<i> I'm now more concerned with an absence of API for getting user-visible
</I>&gt;<i> server's name, not client's ip.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Yes.  My mistake.  (Although totally fix those other bugs too. They're
</I>&gt;<i> also bad. :))
</I>&gt;<i>
</I>&gt;<i> Look, I'm currently porting my app from Django to Klein and noticed
</I>&gt;<i> strange behavior of Klein. For example:
</I>&gt;<i> @app.route('/alias', alias=True)
</I>&gt;<i> @app.route('/path')
</I>&gt;<i> def path(request): return b'42'
</I>&gt;<i>
</I>&gt;<i> When /alias is requested werkzeug generates a redirect to /path. But Klein
</I>&gt;<i> is passing Request.getHost() to Werkzeug, so redirect gets internal
</I>&gt;<i> hostname and exposes backend's internal hostname and port to the user.
</I>&gt;<i> Seems like Klein is passing incorrect hostname to Werkzeug. But how can we
</I>&gt;<i> fix that?
</I>&gt;<i>
</I>&gt;<i> There are two methods in Request:
</I>&gt;<i> &#8226; Request.getHost() &#8212; &quot;Get my originally requesting transport's host&quot; as
</I>&gt;<i> doc says. Ok, seems like this method intentionally returns server's
</I>&gt;<i> internal address.
</I>&gt;<i> &#8226; Request.getRequestHostname() &#8212;doc says:
</I>&gt;<i> &gt;&gt; &quot;Get the hostname that the user passed in to the request. This will
</I>&gt;<i> either use the Host: header (if it is available) or the host we are
</I>&gt;<i> listening on if the header is unavailable.&quot;
</I>&gt;<i>
</I>&gt;<i> Cool, but why does this method only returns a hostname without a port? It
</I>&gt;<i> intentionally strips out the port number from Host header. What is the
</I>&gt;<i> point of such implementation?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Request is one of the oldest parts of Twisted, so the likely reason is &quot;it
</I>&gt;<i> looked like a good idea at the time&quot;.  Request predates the requirement for
</I>&gt;<i> test coverage, documentation coverage, and, in many cases, the author (me)
</I>&gt;<i> having any idea what they were doing :).  If you find something that looks
</I>&gt;<i> bad, it's probably just bad, there is unlikely any deeper reason.
</I>&gt;<i>
</I>&gt;<i> Long term, we need to overhaul the API to have fewer methods and be
</I>&gt;<i> generally less confusing. See for example the infamous
</I>&gt;<i> <A HREF="https://twistedmatrix.com/trac/ticket/288">https://twistedmatrix.com/trac/ticket/288</A> ticket.  However, before we do
</I>&gt;<i> that, we should make all the stuff that is there already behave correctly
</I>&gt;<i> and be documented even in its weird shape; then we can transition to a new
</I>&gt;<i> good thing confident in the knowledge that no old applications will break
</I>&gt;<i> and that users can move over to the new APIs without massive disruption.
</I>&gt;<i>
</I>&gt;<i> This method is used only a couple of times inside Twisted itself, and in
</I>&gt;<i> both places Twisted gets what getRequestHostname() returned and mixes it
</I>&gt;<i> with request.getHost().port which is *definitely* incorrect, because the
</I>&gt;<i> former is user-visible while latter is internal. So if my backend server is
</I>&gt;<i> using different port than a fronend, it is impossible to use
</I>&gt;<i> getRequestHostname() to build user-visible URL. I think current
</I>&gt;<i> getRequestHostname() implementation is broken.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So I have two proposals:
</I>&gt;<i>
</I>&gt;<i> Proposal #1 (fixing current behavior):
</I>&gt;<i> &#8226; Variant #1: Change Request.getRequestHostname() to return
</I>&gt;<i> b&quot;hostname:port&quot;. I think this is the correct thing to do, but this is a
</I>&gt;<i> backward-incompatible change.
</I>&gt;<i> - or -
</I>&gt;<i> &#8226; Variant #2: Change Klein to use Request.getHeader(b'Host') with fallback
</I>&gt;<i> to Request.getHost()
</I>&gt;<i>
</I>&gt;<i> Proposal #2 (adding new feature if Variant #1 is choosed):
</I>&gt;<i> &#8226; Add useXForwardedHost=False argument to Request.getRequestHostname() and
</I>&gt;<i> useXForwardedProto=False to Request.isSecure(). If True is passed, these
</I>&gt;<i> methods will obey corresponding request headers that are de-facto standard
</I>&gt;<i> for reverse proxies. Also add corresponding options to Klein app. This can
</I>&gt;<i> simplify reverse proxy configuration a bit.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have a third proposal.
</I>&gt;<i>
</I>&gt;<i> Ideally if we want to know about the URL for the request, we could ask the
</I>&gt;<i> request to just give us the URL.  And in fact the URL does have a method,
</I>&gt;<i> URLPath(), which is both (A) *unambiguously* broken (the case could be
</I>&gt;<i> made that getRequestHostname() is supposed to really just be a host, not
</I>&gt;<i> for URL generation, and maybe there is even a case where that makes sense;
</I>&gt;<i> origin comparisons perhaps) and (B) returning a data structure which could
</I>&gt;<i> be fixed to be correct without concern for client compatibility.
</I>&gt;<i>
</I>&gt;<i> In the long term, we should get rid of all these methods and have a single
</I>&gt;<i> 'request.url()' method which cleanly and correctly returns a
</I>&gt;<i> <A HREF="https://twistedmatrix.com/documents/17.1.0/api/twisted.python.url.URL.html">https://twistedmatrix.com/documents/17.1.0/api/twisted.python.url.URL.html</A>
</I>&gt;<i> object, which is better than a string or a URLPath (basically, it's what
</I>&gt;<i> URLPath should have been if we had designed it carefully).  In the
</I>&gt;<i> meanwhile, without adding a bunch of new API surface and abandoning
</I>&gt;<i> existing methods, Request.URLPath() is the easiest place to put this fix.
</I>&gt;<i>
</I>&gt;<i> getRequestHostname is, as you correctly called out, probably useless, but
</I>&gt;<i> we should just adjust its docstring to direct users to the URLPath method
</I>&gt;<i> instead.
</I>&gt;<i>
</I>&gt;<i> Klein should then be changed to use Request.URLPath() to build any URLs.
</I>&gt;<i>
</I>&gt;<i> What do you think of this proposal?  Does my reasoning make sense?
</I>&gt;<i>
</I>&gt;<i> -glyph
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20170315/b5c9441c/attachment.html">http://twistedmatrix.com/pipermail/twisted-web/attachments/20170315/b5c9441c/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005282.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
	<LI>Next message: <A HREF="005284.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5283">[ date ]</a>
              <a href="thread.html#5283">[ thread ]</a>
              <a href="subject.html#5283">[ subject ]</a>
              <a href="author.html#5283">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
