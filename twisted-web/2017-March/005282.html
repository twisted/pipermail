<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] internal vs. external hostname in	Request.getHost9)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3CF8EC9794-2522-4839-A5CA-AA430DFA01E0%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005281.html">
   <LINK REL="Next"  HREF="005283.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] internal vs. external hostname in	Request.getHost9)</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3CF8EC9794-2522-4839-A5CA-AA430DFA01E0%40twistedmatrix.com%3E"
       TITLE="[Twisted-web] internal vs. external hostname in	Request.getHost9)">glyph at twistedmatrix.com
       </A><BR>
    <I>Wed Mar 15 00:08:35 MDT 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="005281.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
        <LI>Next message: <A HREF="005283.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5282">[ date ]</a>
              <a href="thread.html#5282">[ thread ]</a>
              <a href="subject.html#5282">[ subject ]</a>
              <a href="author.html#5282">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Mar 14, 2017, at 3:00 PM, Ilya Skriblovsky &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">ilyaskriblovsky at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Tickets you have mentioned and forwarded-for-5807 branch are mostly about parsing X-Forwarded-For in order to obtain correct client IP. While it is valuable task, it is not what strikes me right now.
</I>
Sorry, I was pretty tired when I wrote that message, and I realize that I was getting server identification and client identification mixed up.

&gt;<i> I'm now more concerned with an absence of API for getting user-visible server's name, not client's ip.
</I>
Yes.  My mistake.  (Although totally fix those other bugs too. They're also bad. :))

&gt;<i> Look, I'm currently porting my app from Django to Klein and noticed strange behavior of Klein. For example:
</I>&gt;<i> @app.route('/alias', alias=True)
</I>&gt;<i> @app.route('/path')
</I>&gt;<i> def path(request): return b'42'
</I>&gt;<i> 
</I>&gt;<i> When /alias is requested werkzeug generates a redirect to /path. But Klein is passing Request.getHost() to Werkzeug, so redirect gets internal hostname and exposes backend's internal hostname and port to the user. Seems like Klein is passing incorrect hostname to Werkzeug. But how can we fix that?
</I>&gt;<i> 
</I>&gt;<i> There are two methods in Request:
</I>&gt;<i> &#8226; Request.getHost() &#8212; &quot;Get my originally requesting transport's host&quot; as doc says. Ok, seems like this method intentionally returns server's internal address.
</I>&gt;<i> &#8226; Request.getRequestHostname() &#8212;doc says:
</I>&gt;<i> &gt;&gt; &quot;Get the hostname that the user passed in to the request. This will either use the Host: header (if it is available) or the host we are listening on if the header is unavailable.&quot;
</I>&gt;<i> Cool, but why does this method only returns a hostname without a port? It intentionally strips out the port number from Host header. What is the point of such implementation?
</I>
Request is one of the oldest parts of Twisted, so the likely reason is &quot;it looked like a good idea at the time&quot;.  Request predates the requirement for test coverage, documentation coverage, and, in many cases, the author (me) having any idea what they were doing :).  If you find something that looks bad, it's probably just bad, there is unlikely any deeper reason.

Long term, we need to overhaul the API to have fewer methods and be generally less confusing. See for example the infamous <A HREF="https://twistedmatrix.com/trac/ticket/288">https://twistedmatrix.com/trac/ticket/288</A> ticket.  However, before we do that, we should make all the stuff that is there already behave correctly and be documented even in its weird shape; then we can transition to a new good thing confident in the knowledge that no old applications will break and that users can move over to the new APIs without massive disruption.

&gt;<i> This method is used only a couple of times inside Twisted itself, and in both places Twisted gets what getRequestHostname() returned and mixes it with request.getHost().port which is *definitely* incorrect, because the former is user-visible while latter is internal. So if my backend server is using different port than a fronend, it is impossible to use getRequestHostname() to build user-visible URL. I think current getRequestHostname() implementation is broken.
</I>&gt;<i> 
</I>&gt;<i> So I have two proposals:
</I>&gt;<i> 
</I>&gt;<i> Proposal #1 (fixing current behavior):
</I>&gt;<i> &#8226; Variant #1: Change Request.getRequestHostname() to return b&quot;hostname:port&quot;. I think this is the correct thing to do, but this is a backward-incompatible change.
</I>&gt;<i> - or -
</I>&gt;<i> &#8226; Variant #2: Change Klein to use Request.getHeader(b'Host') with fallback to Request.getHost()
</I>&gt;<i> 
</I>&gt;<i> Proposal #2 (adding new feature if Variant #1 is choosed):
</I>&gt;<i> &#8226; Add useXForwardedHost=False argument to Request.getRequestHostname() and useXForwardedProto=False to Request.isSecure(). If True is passed, these methods will obey corresponding request headers that are de-facto standard for reverse proxies. Also add corresponding options to Klein app. This can simplify reverse proxy configuration a bit.
</I>
I have a third proposal.

Ideally if we want to know about the URL for the request, we could ask the request to just give us the URL.  And in fact the URL does have a method, URLPath(), which is both (A) unambiguously broken (the case could be made that getRequestHostname() is supposed to really just be a host, not for URL generation, and maybe there is even a case where that makes sense; origin comparisons perhaps) and (B) returning a data structure which could be fixed to be correct without concern for client compatibility.

In the long term, we should get rid of all these methods and have a single 'request.url()' method which cleanly and correctly returns a <A HREF="https://twistedmatrix.com/documents/17.1.0/api/twisted.python.url.URL.html">https://twistedmatrix.com/documents/17.1.0/api/twisted.python.url.URL.html</A> object, which is better than a string or a URLPath (basically, it's what URLPath should have been if we had designed it carefully).  In the meanwhile, without adding a bunch of new API surface and abandoning existing methods, Request.URLPath() is the easiest place to put this fix.

getRequestHostname is, as you correctly called out, probably useless, but we should just adjust its docstring to direct users to the URLPath method instead.

Klein should then be changed to use Request.URLPath() to build any URLs.

What do you think of this proposal?  Does my reasoning make sense?

-glyph

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20170314/9de347e7/attachment-0001.html">http://twistedmatrix.com/pipermail/twisted-web/attachments/20170314/9de347e7/attachment-0001.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005281.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
	<LI>Next message: <A HREF="005283.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5282">[ date ]</a>
              <a href="thread.html#5282">[ thread ]</a>
              <a href="subject.html#5282">[ subject ]</a>
              <a href="author.html#5282">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
