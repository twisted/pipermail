<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] internal vs. external hostname in	Request.getHost9)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3CCAK4RBD96CqP0vU7tzLf_kme2uO4MfPxfgbkzzUN82DAYdqMiVA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005285.html">
   <LINK REL="Next"  HREF="005287.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] internal vs. external hostname in	Request.getHost9)</H1>
    <B>Tom Most</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3CCAK4RBD96CqP0vU7tzLf_kme2uO4MfPxfgbkzzUN82DAYdqMiVA%40mail.gmail.com%3E"
       TITLE="[Twisted-web] internal vs. external hostname in	Request.getHost9)">tommost at gmail.com
       </A><BR>
    <I>Mon Mar 20 12:30:27 MDT 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="005285.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
        <LI>Next message: <A HREF="005287.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5286">[ date ]</a>
              <a href="thread.html#5286">[ thread ]</a>
              <a href="subject.html#5286">[ subject ]</a>
              <a href="author.html#5286">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Mar 17, 2017 at 2:52 AM, Ilya Skriblovsky &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">ilyaskriblovsky at gmail.com</A>
&gt;<i> wrote:
</I>
&gt;<i> &gt; The code calling request.URLPath(), in a given Resource, or
</I>&gt;<i> application, is highly unlikely to know whether it wants to honor
</I>&gt;<i> (x-)forwarded-for.
</I>&gt;<i> You are right, I haven't thought about it.
</I>&gt;<i> But I'm in doubt whether trusting X-Forwarded-* by default can damage
</I>&gt;<i> security if Twisted app is running with naked HTTP(S) port exposed without
</I>&gt;<i> reverse proxy that handles these headers.
</I>&gt;<i> There are three headers:
</I>&gt;<i> 1. X-Forwarded-For specifying original client IP and IPs of proxies
</I>&gt;<i> 2. X-Forwarded-Host specifying original Host header from the client
</I>&gt;<i> 3. X-Forwarded-Proto specifying original client's scheme
</I>&gt;<i> (there is also new-style &quot;Forwarded:&quot; header but it is not widely used
</I>&gt;<i> yet, AFAIK)
</I>&gt;<i>
</I>&gt;<i> X-Forwarded-For definetly can't be trusted if comes from untrusted client
</I>&gt;<i> client. Fortunately we don't need it at all for generating URLs :) It will
</I>&gt;<i> be in question when refactoring getClientIP() somewhen later.
</I>&gt;<i>
</I>&gt;<i> But can we trust X-Forwarded-Host &amp; X-Forwarded-Proto? From the first
</I>&gt;<i> glance it isn't a problem since we are using them to display URLs for the
</I>&gt;<i> same client, so nasty client will get his nasty URLs, that's it. But if app
</I>&gt;<i> is doing something like storing URL in DB or (more likely) sending an email
</I>&gt;<i> with a link to another client, this would be an issue.
</I>&gt;<i>
</I>
It's not safe to enable support for X-Forwarded-For and friends by default,
since you can't know how application code will use that information and in
many configurations it may be spoofed by clients.

A proper deployment which sets these headers looks like this:

1. Configure your frontend reverse-proxy (nginx or whatever) to discard
incoming X-Forwarded-* headers and *set* X-Forwarded-* as appropriate. Note
that X-Forwarded-For is actually a *list* of hops[1], so if you do this
naively your server may append to the list! [2]
2. Configure your backend services to respect exactly the headers passed by
your frontend.

Note that this requires administrative action in two places, and that if
you don't do the frontend config it will probably pass the headers through,
allowing them to be spoofed.

A non-exhaustive list of possible bad stuff I client could use spoofing for:

1. Evade IP-based access control (a reasonable defense-in-depth measure).
2. Evade pinning of user sessions to IP addresses or subnets.
2. Evade IP-based rate limiting, e.g. as discussed at [3].

It's also probably worth noting that Django used to offer support for
X-Forwarded-For and removed it[4]. X-Forwarded-* and friends just too
varied in the wild to reasonably support.

If Twisted is to support this in any way, I think that it should be opt-in
support for the Forwarded header as specified in RFC 7239. This should be a
parameter applicable to all of twisted.web.server rather than per-method
call, since it's something the administrator needs to set.

&#8212;Tom

[1]: Standardized as Forwarded in <A HREF="https://tools.ietf.org/html/rfc7239">https://tools.ietf.org/html/rfc7239</A>
[2]: Your frontend proxy should also validate Host is a domain you control
to prevent cookie theft. Plus lots of other stuff. Web security is hard,
and every default everywhere sets users up for failure.
[3]: <A HREF="http://django-ratelimit.readthedocs.io/en/v1.0.0/security.html">http://django-ratelimit.readthedocs.io/en/v1.0.0/security.html</A>
[4]: <A HREF="https://www.djangoproject.com/weblog/2009/jul/28/security/#">https://www.djangoproject.com/weblog/2009/jul/28/security/#</A>
secondary-issue
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20170320/e29eabf3/attachment.html">http://twistedmatrix.com/pipermail/twisted-web/attachments/20170320/e29eabf3/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005285.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
	<LI>Next message: <A HREF="005287.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5286">[ date ]</a>
              <a href="thread.html#5286">[ thread ]</a>
              <a href="subject.html#5286">[ subject ]</a>
              <a href="author.html#5286">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
