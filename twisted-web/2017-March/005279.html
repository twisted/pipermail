<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] internal vs. external hostname in	Request.getHost9)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3C13477C1A-76BC-4429-94CA-104463EC0E62%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005278.html">
   <LINK REL="Next"  HREF="005280.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] internal vs. external hostname in	Request.getHost9)</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3C13477C1A-76BC-4429-94CA-104463EC0E62%40twistedmatrix.com%3E"
       TITLE="[Twisted-web] internal vs. external hostname in	Request.getHost9)">glyph at twistedmatrix.com
       </A><BR>
    <I>Tue Mar 14 01:10:30 MDT 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="005278.html">[Twisted-web] internal vs. external hostname in Request.getHost9)
</A></li>
        <LI>Next message: <A HREF="005280.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5279">[ date ]</a>
              <a href="thread.html#5279">[ thread ]</a>
              <a href="subject.html#5279">[ subject ]</a>
              <a href="author.html#5279">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Mar 13, 2017, at 11:01 PM, Ilya Skriblovsky &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">ilyaskriblovsky at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm using Twisted Web server behind Nginx reverse-proxy and I'm getting backend's internal host:port from Request.getHost().
</I>&gt;<i> 
</I>&gt;<i> Seems like Request.host is explicitly set to socket's address (i.e. internal address) here: &#8203;<A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L838">https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L838</A> &lt;<A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L838">https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L838</A>&gt; But comment at &#8203;<A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L1297">https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L1297</A> &lt;<A HREF="https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L1297">https://github.com/twisted/twisted/blob/trunk/src/twisted/web/http.py#L1297</A>&gt; and what this method does points that Request.host meant to reflect Host header of the request, i.e. user-visible hostname and port.
</I>&gt;<i> 
</I>&gt;<i> This creates problems for me when using Klein because it correctly uses Request.getHost() to create host part of URLs for redirects.
</I>&gt;<i> 
</I>&gt;<i> It seems like inconsistency in Twisted code. I'd expect Request.host should be only set from the Host request header to reflect user-visible hostname, not the internal backend server's address. Or may be I'm missing something?
</I>

You're absolutely correct!  I even filed a ticket for this functionality, 5 years ago: <A HREF="https://twistedmatrix.com/trac/ticket/5807">https://twistedmatrix.com/trac/ticket/5807</A>  There's even a branch for it.  Oddly enough we do have a private _XForwardedForRequest, but... it's only used for logging, for some reason.

If you want accurate access logging and request information, <A HREF="https://twistedmatrix.com/trac/ticket/7704">https://twistedmatrix.com/trac/ticket/7704</A> will probably also be of interest to you.

I'm so sorry you've hit this glaring deficiency in Twisted.

On the other hand: I'm so glad that you've hit this glaring deficiency in Twisted!  I hope you will be motivated to fix it :-).  It's bothered me for quite some time that we don't play nicely with proxying setups, when such setups are so incredibly common.  If you can write pull requests to fix these issues and put them into review, I'm pretty sure you will find an enthusiastic reviewer quickly.

-glyph
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20170314/2818e581/attachment.html">http://twistedmatrix.com/pipermail/twisted-web/attachments/20170314/2818e581/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005278.html">[Twisted-web] internal vs. external hostname in Request.getHost9)
</A></li>
	<LI>Next message: <A HREF="005280.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5279">[ date ]</a>
              <a href="thread.html#5279">[ thread ]</a>
              <a href="subject.html#5279">[ subject ]</a>
              <a href="author.html#5279">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
