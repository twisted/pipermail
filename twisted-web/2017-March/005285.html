<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] internal vs. external hostname in	Request.getHost9)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3CCAOG7vkyU8FHN0NJJtwJARWstb7paaXM2r0X2a1p2ssc7hV3dXQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005284.html">
   <LINK REL="Next"  HREF="005286.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] internal vs. external hostname in	Request.getHost9)</H1>
    <B>Ilya Skriblovsky</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20internal%20vs.%20external%20hostname%20in%0A%09Request.getHost9%29&In-Reply-To=%3CCAOG7vkyU8FHN0NJJtwJARWstb7paaXM2r0X2a1p2ssc7hV3dXQ%40mail.gmail.com%3E"
       TITLE="[Twisted-web] internal vs. external hostname in	Request.getHost9)">ilyaskriblovsky at gmail.com
       </A><BR>
    <I>Fri Mar 17 03:52:05 MDT 2017</I>
    <P><UL>
        <LI>Previous message: <A HREF="005284.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
        <LI>Next message: <A HREF="005286.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5285">[ date ]</a>
              <a href="thread.html#5285">[ thread ]</a>
              <a href="subject.html#5285">[ subject ]</a>
              <a href="author.html#5285">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> The code calling request.URLPath(), in a given Resource, or application,
</I>is highly unlikely to know whether it wants to honor (x-)forwarded-for.
You are right, I haven't thought about it.
But I'm in doubt whether trusting X-Forwarded-* by default can damage
security if Twisted app is running with naked HTTP(S) port exposed without
reverse proxy that handles these headers.
There are three headers:
1. X-Forwarded-For specifying original client IP and IPs of proxies
2. X-Forwarded-Host specifying original Host header from the client
3. X-Forwarded-Proto specifying original client's scheme
(there is also new-style &quot;Forwarded:&quot; header but it is not widely used yet,
AFAIK)

X-Forwarded-For definetly can't be trusted if comes from untrusted client
client. Fortunately we don't need it at all for generating URLs :) It will
be in question when refactoring getClientIP() somewhen later.

But can we trust X-Forwarded-Host &amp; X-Forwarded-Proto? From the first
glance it isn't a problem since we are using them to display URLs for the
same client, so nasty client will get his nasty URLs, that's it. But if app
is doing something like storing URL in DB or (more likely) sending an email
with a link to another client, this would be an issue.

-- ilya

&#1087;&#1090;, 17 &#1084;&#1072;&#1088;. 2017 &#1075;. &#1074; 11:18, Glyph &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">glyph at twistedmatrix.com</A>&gt;:

On Mar 15, 2017, at 1:20 AM, Ilya Skriblovsky &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">ilyaskriblovsky at gmail.com</A>&gt;
wrote:

Ok, so in the sort term you are suggesting to change Request.URLPath


Yes.

(uppercased method? Hmm)


Like I said, not a great interface, overall :-).

to use Host header instead of getRequestHostname and to change Klein to use
it instead of Request.getHost(), right?
Sounds wise and reasonable :)


OK, glad you agree :).

But I'd like to add one more thing. In order to build correct external URL
we need to know is it http or https. Currently URLPath is using
Request.isSecure(), but it is not sufficient since Request.isSecure() just
checks if backend connection is SSL while encryption is often terminated at
a reverse proxy. Can we add &quot;useXForwardedProto=False&quot; argument to
Request.URLPath() and check X-Forwarded-Proto header if it is true? And may
be add &quot;useXForwardedHost=False&quot; too to simplify setting up a reverse proxy
(with a bold red warning in docstring that it can be set to True only if
reverse proxy is correctly configured to drop corresponding
client-specified headers). What do you think?


I think that for starters, it would make more sense to just fix it to
*always* honor forwarded-for and x-forwarded-for headers.  The code calling
request.URLPath(), in a given Resource, or application, is highly unlikely
to know whether it wants to honor (x-)forwarded-for.  The code that might
know about this sort of configuration would be the thing that constructs
the Site object, but I'd be much happier to just get a change that always
honors it first, and then figure out how to customize it later.

-glyph

_______________________________________________
Twisted-web mailing list
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20170317/d128e893/attachment.html">http://twistedmatrix.com/pipermail/twisted-web/attachments/20170317/d128e893/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005284.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
	<LI>Next message: <A HREF="005286.html">[Twisted-web] internal vs. external hostname in	Request.getHost9)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5285">[ date ]</a>
              <a href="thread.html#5285">[ thread ]</a>
              <a href="subject.html#5285">[ subject ]</a>
              <a href="author.html#5285">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
