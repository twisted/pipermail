<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] spawning a xvfb and firefox with a timeout
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20spawning%20a%20xvfb%20and%20firefox%20with%20a%20timeout&In-Reply-To=CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG%3D6zxfV_k5pr1W71A%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004714.html">
   <LINK REL="Next"  HREF="004716.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] spawning a xvfb and firefox with a timeout</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20spawning%20a%20xvfb%20and%20firefox%20with%20a%20timeout&In-Reply-To=CADozHMU5GeWwwfJFSmJCxBk8OKEjSUOxNG%3D6zxfV_k5pr1W71A%40mail.gmail.com"
       TITLE="[Twisted-web] spawning a xvfb and firefox with a timeout">glyph at twistedmatrix.com
       </A><BR>
    <I>Fri Aug 19 00:51:17 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004714.html">[Twisted-web] spawning a xvfb and firefox with a timeout
</A></li>
        <LI>Next message: <A HREF="004716.html">[Twisted-web] spawning a xvfb and firefox with a timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4715">[ date ]</a>
              <a href="thread.html#4715">[ thread ]</a>
              <a href="subject.html#4715">[ subject ]</a>
              <a href="author.html#4715">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Aug 19, 2011, at 12:42 AM, Stephan wrote:

&gt;<i> I'm attempting to spawn xvfb with firefox using twisted's spawnProcess.
</I>&gt;<i> 
</I>&gt;<i> I'm having two issues:
</I>&gt;<i> 
</I>&gt;<i> 1) when I call a normal process (not xvfb) it seems to work, but when I call xvfb the process goes defunct
</I>
Defunct processes have exited, but not been reaped.  In older versions of Twisted, this might happen if some other library were competing to register the SIGCHLD signal.  What version of Twisted are you using?

&gt;<i> 2) perhaps because it goes defunct but the timeout I set in place in the processprotocol does
</I>&gt;<i> not trigger.
</I>
It should never go defunct, whether or not your timeout triggers.

&gt;<i> ==============
</I>&gt;<i> here is the code for spawning a process
</I>&gt;<i> ==============
</I>&gt;<i> 108         command = [&quot;/usr/bin/xvfb-run&quot;, &quot;--auto-servernum&quot;,
</I>&gt;<i> &quot;/usr/bin/firefox&quot;, &quot;-P&quot;, profile_id]
</I>&gt;<i> 109         subprocess = reactor.spawnProcess(TimedProcessProtocol(20),
</I>&gt;<i> 110                                             command[0], command)
</I>&gt;<i> 111         logging.debug(type(subprocess))
</I>&gt;<i> 112         logging.debug(&quot;spawned a process: pid: %d&quot;, subprocess.pid)
</I>&gt;<i> 113
</I>&gt;<i> 114         # this file will be created when firefox starts
</I>&gt;<i> 115         while (not os.path.exists(self.profile_dir + &quot;/importantfile&quot;)):
</I>&gt;<i> 116             logging.debug(&quot;in while loop waiting for
</I>&gt;<i> firesharkReady file to exist&quot;)
</I>&gt;<i> 117             pass
</I>
You should really not busy-loop like this waiting for the subprocess.  Have a repeating callLater (or LoopingCall) that does this check cooperatively with the reactor, so if something goes wrong (for example: firefox fails to launch), you'll be able to react to it effectively rather than just hanging your Twisted process forever.  If firefox isn't actually starting correctly, or that file doesn't actually get created for some reason, this could cause the defunct process.

&gt;<i> 118
</I>&gt;<i> 119         logging.debug(&quot;file exist&quot;)
</I>&gt;<i> 
</I>&gt;<i> ==============
</I>&gt;<i> here is the process class
</I>&gt;<i> ==============
</I>&gt;<i> 
</I>&gt;<i> 27 class TimedProcessProtocol(protocol.ProcessProtocol):
</I>&gt;<i> 28
</I>&gt;<i> 29     def __init__(self, timeout):
</I>&gt;<i> 30         self.timeout = timeout
</I>&gt;<i> 31
</I>&gt;<i> 32     def connectionMade(self):
</I>&gt;<i> 33         logging.debug(&quot;connection made timeout = %d&quot;, self.timeout)
</I>&gt;<i> 34         @defer.inlineCallbacks
</I>&gt;<i> 35         def killIfAlive():
</I>&gt;<i> 36             logging.debug(&quot;timeout reached - killing process&quot;)
</I>&gt;<i> 37             try:
</I>&gt;<i> 38                 yield self.transport.signalProcess('KILL')
</I>&gt;<i> 39             except error.ProcessExitedAlready:
</I>&gt;<i> 40                 logging.debug(&quot;process already exited&quot;)
</I>&gt;<i> 41                 pass
</I>&gt;<i> 42
</I>&gt;<i> 43         d = reactor.callLater(self.timeout, killIfAlive)
</I>&gt;<i> 44
</I>&gt;<i> 45     def outReceived(self, data):
</I>&gt;<i> 46         logging.debug(&quot;output: %s&quot;, data)
</I>&gt;<i> 47
</I>&gt;<i> 48     def errReceived(self, data):
</I>&gt;<i> 49         logging.debug(&quot;errReceived %s&quot;, data)
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004714.html">[Twisted-web] spawning a xvfb and firefox with a timeout
</A></li>
	<LI>Next message: <A HREF="004716.html">[Twisted-web] spawning a xvfb and firefox with a timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4715">[ date ]</a>
              <a href="thread.html#4715">[ thread ]</a>
              <a href="subject.html#4715">[ subject ]</a>
              <a href="author.html#4715">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
