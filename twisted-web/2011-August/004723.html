<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] spawning a xvfb and firefox with a timeout
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20spawning%20a%20xvfb%20and%20firefox%20with%20a%20timeout&In-Reply-To=CADozHMVChXxmvO%2B_k9Hcuzh-LzhZhvfB5bcBEJ4XBLN4x_Ccxg%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004722.html">
   <LINK REL="Next"  HREF="004725.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] spawning a xvfb and firefox with a timeout</H1>
    <B>Stephan</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20spawning%20a%20xvfb%20and%20firefox%20with%20a%20timeout&In-Reply-To=CADozHMVChXxmvO%2B_k9Hcuzh-LzhZhvfB5bcBEJ4XBLN4x_Ccxg%40mail.gmail.com"
       TITLE="[Twisted-web] spawning a xvfb and firefox with a timeout">schenette at gmail.com
       </A><BR>
    <I>Mon Aug 22 12:32:55 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004722.html">[Twisted-web] spawning a xvfb and firefox with a timeout
</A></li>
        <LI>Next message: <A HREF="004725.html">[Twisted-web] spawning a xvfb and firefox with a timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4723">[ date ]</a>
              <a href="thread.html#4723">[ thread ]</a>
              <a href="subject.html#4723">[ subject ]</a>
              <a href="author.html#4723">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I think I might have figured out that you have to add usePTY=1 to
associate the process group, so that the children will be killed when
the parent process is killed.
e.g.
subprocess = reactor.spawnProcess(self.pp, args[0], args, env = os.e
 nviron, usePTY=1)

but I tried to separate out the killing in another process and now the
new method isnt' called.
are ProcessProtocol classes allowed to have other methods added to it
for calling?

 45     def killProcessIfAlive(self):
 46         logging.debug(&quot;killProcessIfAlive called&quot;)
 47         try:
 48             yield self.transport.signalProcess('KILL')
 49         except error.ProcessExitedAlready:
 50             logging.debug(&quot;process already exited&quot;)
 51             pass
 52
 53     def connectionMade(self):
 54         logging.debug(&quot;connection made timeout = %d&quot;, self.timeout)
 55         @defer.inlineCallbacks
 56         def onTimer():
 57             logging.debug(&quot;timeout triggered&quot;)
 58             self.killProcessIfAlive()
 59         d = reactor.callLater(self.timeout, onTimer)

On Mon, Aug 22, 2011 at 2:16 AM, Stephan &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">schenette at gmail.com</A>&gt; wrote:
&gt;<i> Jean-Paul,
</I>&gt;<i>
</I>&gt;<i> adding
</I>&gt;<i>
</I>&gt;<i> env=os.environ to spanProcess fixed the issue, thank you.
</I>&gt;<i>
</I>&gt;<i> There is still one problem I brought up that I'm attempting to figure
</I>&gt;<i> out with twisted that is related to the initial question...
</I>&gt;<i>
</I>&gt;<i> current status is that now with the addition of setting the env params
</I>&gt;<i> xvfb starts up correctly and starts up firefox.
</I>&gt;<i>
</I>&gt;<i> the ProcessProtocol object that I created, has a calllater function
</I>&gt;<i> that kills the process after 20seconds.
</I>&gt;<i>
</I>&gt;<i> the issue is that xvfb has one process id and any process it's asked
</I>&gt;<i> to create will cause another process to be spawned, thus another
</I>&gt;<i> process id, where the parent process is that of xvfb.
</I>&gt;<i>
</I>&gt;<i> when I issue the kill command, xvfb does indeed die, but firefox-bin
</I>&gt;<i> stays around and it's parent is set to 1.
</I>&gt;<i>
</I>&gt;<i> here is the ProcessProtocol code, should I be killing the parent
</I>&gt;<i> process differently so that the children die as well?
</I>&gt;<i>
</I>&gt;<i> &#160;33 class TimedProcessProtocol(protocol.ProcessProtocol):
</I>&gt;<i> &#160;34
</I>&gt;<i> &#160;35 &#160; &#160; def __init__(self, timeout):
</I>&gt;<i> &#160;36 &#160; &#160; &#160; &#160; self.timeout = timeout
</I>&gt;<i> &#160;37
</I>&gt;<i> &#160;38 &#160; &#160; def connectionMade(self):
</I>&gt;<i> &#160;39 &#160; &#160; &#160; &#160; logging.debug(&quot;connection made timeout = %d&quot;, self.timeout)
</I>&gt;<i> &#160;40 &#160; &#160; &#160; &#160; @defer.inlineCallbacks
</I>&gt;<i> &#160;41 &#160; &#160; &#160; &#160; def killIfAlive():
</I>&gt;<i> &#160;42 &#160; &#160; &#160; &#160; &#160; &#160; logging.debug(&quot;timeout reached - killing process&quot;)
</I>&gt;<i> &#160;43 &#160; &#160; &#160; &#160; &#160; &#160; try:
</I>&gt;<i> &#160;44 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; yield self.transport.signalProcess('TERM')
</I>&gt;<i> &#160;45 &#160; &#160; &#160; &#160; &#160; &#160; except error.ProcessExitedAlready:
</I>&gt;<i> &#160;46 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; logging.debug(&quot;process already exited&quot;)
</I>&gt;<i> &#160;47 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; pass
</I>&gt;<i> &#160;48
</I>&gt;<i> &#160;49 &#160; &#160; &#160; &#160; d = reactor.callLater(self.timeout, killIfAlive)
</I>&gt;<i> &#160;50
</I>&gt;<i> &#160;51 &#160; &#160; def outReceived(self, data):
</I>&gt;<i> &#160;52 &#160; &#160; &#160; &#160; logging.debug(&quot;output: %s&quot;, data)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Stephan
</I>&gt;<i>
</I>&gt;<i> ps both TERM and KILL act the same way
</I>&gt;<i>
</I>&gt;<i> On Sat, Aug 20, 2011 at 2:01 PM, &#160;&lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">exarkun at twistedmatrix.com</A>&gt; wrote:
</I>&gt;&gt;<i> On 19 Aug, 04:42 am, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">schenette at gmail.com</A> wrote:
</I>&gt;&gt;&gt;<i>I'm attempting to spawn xvfb with firefox using twisted's spawnProcess.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>I'm having two issues:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>1) when I call a normal process (not xvfb) it seems to
</I>&gt;&gt;&gt;<i>work, but when I call xvfb the process goes defunct
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>2) perhaps because it goes defunct but the timeout I set in place in
</I>&gt;&gt;&gt;<i>the processprotocol does
</I>&gt;&gt;&gt;<i>not trigger.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>==============
</I>&gt;&gt;&gt;<i>here is the code for spawning a process
</I>&gt;&gt;&gt;<i>==============
</I>&gt;&gt;&gt;<i>108 &#160; &#160; &#160; &#160; command = [&quot;/usr/bin/xvfb-run&quot;, &quot;--auto-servernum&quot;,
</I>&gt;&gt;&gt;<i>&quot;/usr/bin/firefox&quot;, &quot;-P&quot;, profile_id]
</I>&gt;&gt;&gt;<i>109 &#160; &#160; &#160; &#160; subprocess = reactor.spawnProcess(TimedProcessProtocol(20),
</I>&gt;&gt;&gt;<i>110 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; command[0], command)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does it make any difference if you pass on the parent's environment to
</I>&gt;&gt;<i> the xvfb-run process? &#160;Try something like spawnProcess(...,
</I>&gt;&gt;<i> env=os.environ)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Jean-Paul
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> Twisted-web mailing list
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004722.html">[Twisted-web] spawning a xvfb and firefox with a timeout
</A></li>
	<LI>Next message: <A HREF="004725.html">[Twisted-web] spawning a xvfb and firefox with a timeout
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4723">[ date ]</a>
              <a href="thread.html#4723">[ thread ]</a>
              <a href="subject.html#4723">[ subject ]</a>
              <a href="author.html#4723">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
