<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Web2 and Half-Baked Reinvention of Wheels
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Web2%20and%20Half-Baked%20Reinvention%20of%20Wheels&In-Reply-To=20070703195206.8429.409573462.divmod.xquotient.672%40joule.divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003433.html">
   <LINK REL="Next"  HREF="003435.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Web2 and Half-Baked Reinvention of Wheels</H1>
    <B>Valentino Volonghi aka Dialtone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Web2%20and%20Half-Baked%20Reinvention%20of%20Wheels&In-Reply-To=20070703195206.8429.409573462.divmod.xquotient.672%40joule.divmod.com"
       TITLE="[Twisted-web] Web2 and Half-Baked Reinvention of Wheels">dialtone at divmod.com
       </A><BR>
    <I>Tue Jul  3 19:47:37 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="003433.html">[Twisted-web] Web2 and Half-Baked Reinvention of Wheels
</A></li>
        <LI>Next message: <A HREF="003435.html">[Twisted-web] Extremely slow POST request?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3434">[ date ]</a>
              <a href="thread.html#3434">[ thread ]</a>
              <a href="subject.html#3434">[ subject ]</a>
              <a href="author.html#3434">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Tue, 03 Jul 2007 19:52:06 -0000, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">glyph at divmod.com</A> wrote:

&gt;<i>If anyone out there shares his frustration and would like to help us along 
</I>&gt;<i>towards a supported web2 release, or any other part of Twisted for that 
</I>&gt;<i>matter, just have a look at the Twisted tracker and steal a ticket from some 
</I>&gt;<i>of the obviously overcommitted and overworked maintainers. The milestone 
</I>&gt;<i>link I posted is the best start for web2.
</I>
I'm already fixing some bugs with the current code as part of the SoC,
and I've currently fixed 4 or 5 of them (the last one waiting for
review in branch 1895). I'm currently starting, or I'm hoping to
start, work on no-stream-1937 branch...

&gt;<i>Many of those tickets are underspecified, but don't let that stop you. If 
</I>&gt;<i>you find a ticket that you think sounds interesting but you don't understand 
</I>&gt;<i>how to proceed on it, feel free to comment and ask for clarification - it is 
</I>&gt;<i>often far easier for a maintainer to respond to a prompt for some answers to 
</I>&gt;<i>questions than to drive tests, documentation, and code all the way through 
</I>&gt;<i>the review process.
</I>
Since you kindly offered for clarifications:

I see one problem with the current IConsumer/IProducer API and it's
returning deferreds when a producer finished its job.

The current IConsumer API uses registerProducer() but doesn't allow to
return anything from the method, and in fact this is what the
transport does. Unfortunately it would be useful to deal with the
finish event of producing to a consumer for many reasons, like you
don't know in advance when the produced content will finish.

In Twisted this problem was solved, partially, by FileSender which uses
a beginFileTransfer(fobj, consumer) method to return a deferred that
fires at the end of the file object. Unfortunately this is not really
a reliable method since it's not part of the IProducer interface and
any producer might use whatever method they like and, worst of all,
I'd anyway need to rewrite or add a method to FileSender because I can't
really use beginFileTransfer() for a MemoryBufferProducer() object.

One of the needs is the chance to chain Producers/Consumers to do
input filtering and output filtering. While the first could also be
avoided (meaning that the current implementation is good enough IMHO),
output filtering is actually pretty cool to have since it allows the
user to dynamically add behavior to a request's response like it's
currently done.

Taking from JP's consumer-sketch.py code:

def _chain(hook, chainedElements):
    assert len(chainedElements) &gt;= 2
    elements = iter(chainedElements)
    producer = elements.next()

    if isinstance(producer, Deferred):
        producer = yield producer

    for ele in elements:
        if isinstance(ele, Deferred):
            ele = yield ele
        finishedProducing = hook(producer, ele)
        producer = ele
    yield finishedProducing
_chain = defgen(_chain)

def forwardHook(producer, consumer):
    return producer.produceTo(consumer)

def chainOneWay(*x):
    &quot;&quot;&quot;
    chainOneWay(producer,[chainedElement1,...,chainedElementN],consumer)-&gt;Deferred

    Connect a producer to a consumer/producer to a consumer/producer to a ... ETC

    For example::

        a = FileSender('filename')
        b = GzipCompressor()
        c = ChunkEncoder()
        d = TCPTransport()

        finished = chainOneWay(a, b, c, d)
        def cbSentChunkedGzippedFile(ign):
            print 'Yaaaaaaaaaaaaay'
            d.loseConnection()
        finished.addCallback(cbSentChunkedGzippedFile)

    Will do the obvious thing.
    &quot;&quot;&quot;
    return _chain(forwardHook, x)

This would be a really cool way to solve the problem and would also
present a pretty clean and simple API.

My question then is: how should I proceed? Clearly using this new API
is hard because everything else uses the current one, but the current
one lacks a fairly important functionality. Providing adapter in web2
for current producer/consumer stuff might seem overkill and not very
clean but might be a solution. Introducing this new API in Twisted
would be a nightmare. Is there any way to implement this using the
current IProducer/IConsumer API? I seek advice and some code examples
if anyone is willing to spend his mind on the problem a bit.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003433.html">[Twisted-web] Web2 and Half-Baked Reinvention of Wheels
</A></li>
	<LI>Next message: <A HREF="003435.html">[Twisted-web] Extremely slow POST request?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3434">[ date ]</a>
              <a href="thread.html#3434">[ thread ]</a>
              <a href="subject.html#3434">[ subject ]</a>
              <a href="author.html#3434">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
