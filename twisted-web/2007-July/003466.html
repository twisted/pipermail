<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Passing events to (Athena) event handlers.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Passing%20events%20to%20%28Athena%29%20event%20handlers.&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003465.html">
   <LINK REL="Next"  HREF="003467.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Passing events to (Athena) event handlers.</H1>
    <B>kgi</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Passing%20events%20to%20%28Athena%29%20event%20handlers.&In-Reply-To="
       TITLE="[Twisted-web] Passing events to (Athena) event handlers.">iacovou at gmail.com
       </A><BR>
    <I>Wed Jul 18 09:45:18 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="003465.html">[Twisted-web] Send large files via POST, SOAP, XML-RPC, etc.
</A></li>
        <LI>Next message: <A HREF="003467.html">[Twisted-web] Passing events to (Athena) event handlers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3466">[ date ]</a>
              <a href="thread.html#3466">[ thread ]</a>
              <a href="subject.html#3466">[ subject ]</a>
              <a href="author.html#3466">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi all.

In the thread entitled &quot;How to insert an Athena event handler using Stan?&quot; in 
October and November 2006, Jean-Paul Calderone said:

&quot;&quot;&quot;
The issue with the handler you showed me is most likely that the handler
thinks its first argument is an event, but it is actually a node.  There is
no way to access the event object right now, but I have been considering
just passing it as the next argument.
&quot;&quot;&quot;

and:

&quot;&quot;&quot;
[Though] this may shortly change to

  function doFoo(self, node, event)

(which is completely backwards compatible, of course, due to the magic of
javascript sucking so much).
&quot;&quot;&quot;

I've just hit this particular issue. Up until now all my events have been 
heavily node-based (e.g. tabbing out of a field, submitting a form, etc), 
where you can generally get away with just having access to the node the even 
happened on.

However, not having access to the event itself renders handlers for events 
like 'onkeyup' almost useless, unless you register them with the top-level 
document (like the Nevow.Athena._checkEscape() works), and as far as I can 
tell it makes implementing certain things like drag and drop much more 
difficult.

Is there a branch with experimental support for this?

If not, I've been digging around in where I think the relevant code is, 
namely:

  Nevow/nevow/athena.py line 1062:

_handlerFormat = &quot;return 
Nevow.Athena.Widget.handleEvent(this, %(event)s, %(handler)s);&quot;

and:

  Nevow/nevow/js/Divmod/Runtime/__init__.js line 963:

The Javascript looks like:

Nevow.Athena.Widget.handleEvent = function handleEvent(node, eventName, 
handlerName) {
    var widget = Nevow.Athena.Widget.get(node);
    var method = widget[handlerName];
    var result = false;
    if (method === undefined) {
        Divmod.msg(&quot;Undefined event handler: &quot; + handlerName);
    } else {
        result = Nevow.Athena.Widget.dispatchEvent(
            widget, eventName, handlerName,
            function() {
                return method.call(widget, node);
            });
    }
    return result;
};

It looks like:

  1. Adding an event argument to the handler format in the Python
     (I don't think that _rewriteEventHandlerToAttribute() needs
     modification);
  2. Adding the corresponding 'event' argument to handleEvent() in the JS;
  3. Adding IE hacks (using window.event instead of event, etc) to
     the start of handleEvent();
  4. Adding the event to the list of arguments of method.call()
     within the anonymous function passed as the fourth argument to
     dispatchEvent()

would achieve this, and as JP pointed out, this should be backwards
compatible, as no extant JS handler functions should be declaring additional 
arguments.

Note that within dispatchEvent() itself the callable is invoked as 
callable.call(widget), but it looks like the 'widget' argument is ignored 
entirely by the anonymous function, which contains its own method call with 
its own &quot;closure-y&quot; arguments. Because of this I reckon dispatchEvent() needs 
no modification whatsoever.

Would a patch posted as a trac ticket be acceptable? I searched trac 
for 'event' and couldn't find anything resembling this. What would the unit 
test requirements be for a change like this be?

Thanks,

Ricky

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003465.html">[Twisted-web] Send large files via POST, SOAP, XML-RPC, etc.
</A></li>
	<LI>Next message: <A HREF="003467.html">[Twisted-web] Passing events to (Athena) event handlers.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3466">[ date ]</a>
              <a href="thread.html#3466">[ thread ]</a>
              <a href="subject.html#3466">[ subject ]</a>
              <a href="author.html#3466">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
