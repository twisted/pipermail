<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] what happens when browsers close the connection?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20what%20happens%20when%20browsers%20close%20the%20connection%3F&In-Reply-To=2723EA27-0433-45A7-BE46-C9C2B2AFFFD9%40bubblehouse.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003503.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] what happens when browsers close the connection?</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20what%20happens%20when%20browsers%20close%20the%20connection%3F&In-Reply-To=2723EA27-0433-45A7-BE46-C9C2B2AFFFD9%40bubblehouse.org"
       TITLE="[Twisted-web] what happens when browsers close the connection?">exarkun at divmod.com
       </A><BR>
    <I>Mon Jul 30 10:22:46 EDT 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="003503.html">[Twisted-web] what happens when browsers close the connection?
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3504">[ date ]</a>
              <a href="thread.html#3504">[ thread ]</a>
              <a href="subject.html#3504">[ subject ]</a>
              <a href="author.html#3504">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, 27 Jul 2007 17:25:44 -0400, Phil Christensen &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">phil at bubblehouse.org</A>&gt; wrote:
&gt;<i>Sorry to be so noisy lately, but I've run into another strange  problem with 
</I>&gt;<i>web2.wsgi, or more likely, my understanding of it.
</I>&gt;<i>
</I>&gt;<i>I'm seeing issues when the browser connection is closed uncleanly, 
</I>&gt;<i>particularly when doing a &quot;fast reload&quot; and clicking the reload  before the 
</I>&gt;<i>first request/response has completed.
</I>&gt;<i>
</I>&gt;<i>My specific issue is that when this happens, if I'm in the middle of  a 
</I>&gt;<i>MySQL query (which in my app, I usually am), subsequent calls to 
</I>&gt;<i>&lt;Cursor&gt;.execute() are failing because the previous resultset was  never 
</I>&gt;<i>freed.
</I>&gt;<i>
</I>&gt;<i>This is only an issue when using web2 (or my custom twisted.web wsgi  layer, 
</I>&gt;<i>which still uses web2's wsgi.WSGIHandler class). Apache/ mod_python seems to 
</I>&gt;<i>allow each request to continue to completion  behind the scenes, although it 
</I>&gt;<i>makes up for it by crashing horribly  in other ways.
</I>&gt;<i>
</I>&gt;<i>What I'd like to know is what exactly happens when a browser closes a 
</I>&gt;<i>connection? Is there any possibility that the lost connection event  has 
</I>&gt;<i>some implications further up the call chain? Could any of this  somehow stop 
</I>&gt;<i>or kill the thread created in WSGIResource.renderHTTP()?
</I>
When the browser closes the connection, the server will eventually be
notified that the TCP socket is closed.  This translates into a call to
connectionLost on the HTTP protocol implementation.  This in turns stops
any producer which is registered and tells the request that the connection
was lost.  By default, I think the request ignores this notification.  WSGI
is probably implemented as a producer, though.  So, the producer for the
application which was run to service the request will stop producing.  This
most likely means it will not iterate the iterator the application returned
anymore.  It cannot interrupt or otherwise terminate the thread the WSGI
application is running in, though (since this is not an operation supported
by Python threads).  It has to wait for the application to produce one more
piece of output, then it can exit the loop.

So, it is indeed entirely possible for only part of a WSGI application to
run, if the browser disappears before it finishes running.

Jean-Paul

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003503.html">[Twisted-web] what happens when browsers close the connection?
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3504">[ date ]</a>
              <a href="thread.html#3504">[ thread ]</a>
              <a href="subject.html#3504">[ subject ]</a>
              <a href="author.html#3504">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
