<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20treq%20requests%20failing%20with%0A%09twisted.web._newclient.ResponseNeverReceived&In-Reply-To=%3C54928000.UNoJs6R2oD%40r008%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="005138.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived</H1>
    <B>Guido Winkelmann</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20treq%20requests%20failing%20with%0A%09twisted.web._newclient.ResponseNeverReceived&In-Reply-To=%3C54928000.UNoJs6R2oD%40r008%3E"
       TITLE="[Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived">guido at ambient-entertainment.de
       </A><BR>
    <I>Thu Apr  2 11:49:59 MDT 2015</I>
    <P><UL>
        
        <LI>Next message: <A HREF="005138.html">[Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5137">[ date ]</a>
              <a href="thread.html#5137">[ thread ]</a>
              <a href="subject.html#5137">[ subject ]</a>
              <a href="author.html#5137">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Recently, I have been experiencing some problems in our codebase wth treq 
requests failing with error messages like this:

2015-04-02 19:20:22 ERROR    - pf.agent.http.client - POST 
<A HREF="http://127.0.0.1:5000/api/v1/agents/a113b5a8-9822-413b-b1fd-fce3014956cf">http://127.0.0.1:5000/api/v1/agents/a113b5a8-9822-413b-b1fd-fce3014956cf</A> has 
failed (uid: 78c7ec2a4b4d):
Traceback (most recent call last):
Failure: twisted.web._newclient.ResponseNeverReceived: 
[&lt;twisted.python.failure.Failure &lt;class 
'twisted.internet.error.ConnectionDone'&gt;&gt;]

Unfortunately, I have not been able to successfully produce a reduced test 
case that will reproduce this behaviour.  It only happens under some weird set 
of circumstances, and I am still not sure exactly which.  It appears to be 
highly sensitive to the order of requests.  Funnily enough, this error does 
not show in the codebase as it is on github right now, but if I reorder some 
of the requests, it will show.  Here is one example that has cost me some time 
and head-scratching:

<A HREF="https://github.com/pyfarm/pyfarm-agent/issues/249">https://github.com/pyfarm/pyfarm-agent/issues/249</A>

I think that these problems have started after upgrading to Twisted 15.0, but 
I'm not completely certain about this.

Here is one of the methods that's affected by this:

<A HREF="https://github.com/pyfarm/pyfarm-agent/blob/master/pyfarm/agent/service.py#L231">https://github.com/pyfarm/pyfarm-agent/blob/master/pyfarm/agent/service.py#L231</A>

(post_direct() is just a thin wrapper over treq.request that adds some headers 
we need in our codebase.  I have tried just using treq.request directly 
instead, the result was the same.)

Can someone tell me under which circumstances treq.request would produce an 
error like this?

Without actually knowing the source in question, I would guess that something 
in there is, for some some reason, erroneously trying to reuse a TCP 
connection that has already been closed.

Regards,

	Guido W.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message: <A HREF="005138.html">[Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5137">[ date ]</a>
              <a href="thread.html#5137">[ thread ]</a>
              <a href="subject.html#5137">[ subject ]</a>
              <a href="author.html#5137">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
