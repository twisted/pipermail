<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20treq%20requests%20failing%20with%0A%09twisted.web._newclient.ResponseNeverReceived&In-Reply-To=%3C2223234.SL78F6DlN5%40r008%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005138.html">
   <LINK REL="Next"  HREF="005140.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived</H1>
    <B>Guido Winkelmann</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20treq%20requests%20failing%20with%0A%09twisted.web._newclient.ResponseNeverReceived&In-Reply-To=%3C2223234.SL78F6DlN5%40r008%3E"
       TITLE="[Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived">guido at ambient-entertainment.de
       </A><BR>
    <I>Wed Apr  8 11:44:56 MDT 2015</I>
    <P><UL>
        <LI>Previous message: <A HREF="005138.html">[Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived
</A></li>
        <LI>Next message: <A HREF="005140.html">[Twisted-web] Twisted 15.1 Release Announcement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5139">[ date ]</a>
              <a href="thread.html#5139">[ thread ]</a>
              <a href="subject.html#5139">[ subject ]</a>
              <a href="author.html#5139">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Through some trial and error, I have finally managed to produce a reduced test 
case that can actually reproduce this problem:

1. Install and start a local webserver with a keep-alive timeout of one 
second.
For Apache, the relevant configuration entries look like this:

KeepAlive On
KeepAliveTimeout 1
MaxKeepAliveRequests 1000

(MaxKeepAliveRequests is not that important, just so long as it isn't reached 
during the test.)

The bug is not triggered if the webserver includes a &quot;Connection: close&quot; 
header, which Apache does if you disable KeepAlive entirely.

2. Run this Python script:
==============
import time
import treq
from twisted.internet import reactor
from twisted.internet.defer import inlineCallbacks, returnValue

@inlineCallbacks
def post_data():
  try:
    resp = yield treq.post(&quot;<A HREF="http://127.0.0.1/">http://127.0.0.1/</A>&quot;,
                  data=&quot;bla&quot;,
                  persistent=True)

    print(&quot;response code: %s&quot; % resp.code)
    data = yield treq.content(resp)
    print(&quot;data: %r&quot; % data)

  except Exception as failure:
    print(&quot;failure: %r&quot; % failure)
    returnValue(None)

  returnValue(data)

def call_again(_):
  time.sleep(1.1)
  d = post_data()
  d.addBoth(lambda _: reactor.stop())

d = post_data()
d.addCallback(call_again)

reactor.run()
==============

The output from that looks like this on my machine:
==============
response code: 404
data: '&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 
2.0//EN&quot;&gt;\n&lt;html&gt;&lt;head&gt;\n&lt;title&gt;404 Not Found&lt;/title&gt;\n&lt;/head&gt;&lt;body&gt;\n&lt;h1&gt;Not 
Found&lt;/h1&gt;\n&lt;p&gt;The requested URL / was not found on this 
server.&lt;/p&gt;\n&lt;hr&gt;\n&lt;address&gt;Apache Server at 127.0.0.1 Port 
80&lt;/address&gt;\n&lt;/body&gt;&lt;/html&gt;\n'
failure: ResponseNeverReceived([&lt;twisted.python.failure.Failure &lt;class 
'twisted.internet.error.ConnectionDone'&gt;&gt;],)
==============

As you can see, the second request fails with &quot;ResponseNeverReceived&quot;.

As far as I can tell, twisted.web.client.HTTPConnectionPool simply fails to 
notice that the server has closed the underlying connection in the meantime.

According to the RFC, the server is allowed to close the connection at any 
time if it is idle from the server's point of view (explicitly even if a new 
request from the client has already arrived).

Regards,
	Guido W.

On Wednesday 08 April 2015 14:24:45 Guido Winkelmann wrote:
&gt;<i>An update on the situation:
</I>&gt;<i>
</I>&gt;<i>I tried downgrading both Twisted and treq to &lt;15.0. The problem remained, so
</I>&gt;<i>this issue is /not/ new in 15.0.
</I>&gt;<i>
</I>&gt;<i>When I remove the &quot;pool&quot; parameter in this line in treq/api.py:113:
</I>&gt;<i>
</I>&gt;<i>agent = Agent(reactor, pool=pool)
</I>&gt;<i>
</I>&gt;<i>the problem completely disappears, so I'm assuming the problems lies
</I>&gt;<i>somewhere in the connection pooling logic.
</I>&gt;<i>
</I>&gt;<i>The web server I am using in these tests is flask's built-in standalone
</I>&gt;<i>webserver (<A HREF="http://flask.pocoo.org/">http://flask.pocoo.org/</A>). This webserver speaks HTTP 1.1, but does
</I>&gt;<i>not support keep-alive (at least not with non-static content), which is
</I>&gt;<i>technically allowed but may be a slightly unusual combination these days.
</I>&gt;<i>
</I>&gt;<i>Regards,
</I>&gt;<i>	Guido W.
</I>&gt;<i>
</I>&gt;<i>On Thursday 02 April 2015 19:49:59 Guido Winkelmann wrote:
</I>&gt;&gt;<i>Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Recently, I have been experiencing some problems in our codebase wth treq
</I>&gt;&gt;<i>requests failing with error messages like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>2015-04-02 19:20:22 ERROR    - pf.agent.http.client - POST
</I>&gt;&gt;<i><A HREF="http://127.0.0.1:5000/api/v1/agents/a113b5a8-9822-413b-b1fd-fce3014956cf">http://127.0.0.1:5000/api/v1/agents/a113b5a8-9822-413b-b1fd-fce3014956cf</A> has
</I>&gt;&gt;<i>failed (uid: 78c7ec2a4b4d):
</I>&gt;&gt;<i>Traceback (most recent call last):
</I>&gt;&gt;<i>Failure: twisted.web._newclient.ResponseNeverReceived:
</I>&gt;&gt;<i>[&lt;twisted.python.failure.Failure &lt;class
</I>&gt;&gt;<i>'twisted.internet.error.ConnectionDone'&gt;&gt;]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Unfortunately, I have not been able to successfully produce a reduced test
</I>&gt;&gt;<i>case that will reproduce this behaviour.  It only happens under some weird
</I>&gt;&gt;<i>set of circumstances, and I am still not sure exactly which.  It appears to
</I>&gt;&gt;<i>be highly sensitive to the order of requests.  Funnily enough, this error
</I>&gt;&gt;<i>does not show in the codebase as it is on github right now, but if I reorder
</I>&gt;&gt;<i>some of the requests, it will show.  Here is one example that has cost me
</I>&gt;&gt;<i>some time and head-scratching:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i><A HREF="https://github.com/pyfarm/pyfarm-agent/issues/249">https://github.com/pyfarm/pyfarm-agent/issues/249</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>I think that these problems have started after upgrading to Twisted 15.0,
</I>&gt;&gt;<i>but I'm not completely certain about this.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Here is one of the methods that's affected by this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i><A HREF="https://github.com/pyfarm/pyfarm-agent/blob/master/pyfarm/agent/service.py#L">https://github.com/pyfarm/pyfarm-agent/blob/master/pyfarm/agent/service.py#L</A>
</I>&gt;&gt;<i>2 31
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>(post_direct() is just a thin wrapper over treq.request that adds some
</I>&gt;&gt;<i>headers we need in our codebase.  I have tried just using treq.request
</I>&gt;&gt;<i>directly instead, the result was the same.)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Can someone tell me under which circumstances treq.request would produce an
</I>&gt;&gt;<i>error like this?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Without actually knowing the source in question, I would guess that
</I>&gt;&gt;<i>something in there is, for some some reason, erroneously trying to reuse a
</I>&gt;&gt;<i>TCP connection that has already been closed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Regards,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>	Guido W.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>_______________________________________________
</I>&gt;&gt;<i>Twisted-web mailing list
</I>&gt;&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>Twisted-web mailing list
</I>&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i><A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005138.html">[Twisted-web] treq requests failing with	twisted.web._newclient.ResponseNeverReceived
</A></li>
	<LI>Next message: <A HREF="005140.html">[Twisted-web] Twisted 15.1 Release Announcement
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5139">[ date ]</a>
              <a href="thread.html#5139">[ thread ]</a>
              <a href="subject.html#5139">[ subject ]</a>
              <a href="author.html#5139">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
