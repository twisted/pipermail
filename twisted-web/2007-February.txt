From iacovou at gmail.com  Wed Feb  7 12:41:41 2007
From: iacovou at gmail.com (kgi)
Date: Wed Feb  7 12:41:57 2007
Subject: [Twisted-web] Confused about XML-RPC Unicode behaviour (examples
	attached).
Message-ID: <200702072041.41786.iacovou@gmail.com>


Hi all.

I've got a bunch of Twisted XML-RPC servers that serve up a wide range of data 
types include dates. Up until now I've had some hacky code to protect against 
bad data types being returned to the serialization layer (Nones, unicodes, 
etc). However, this code turns out to be difficult to maintain, as well as 
being a modest performance hit.

I thought I see if I couldn't clean up some of the code to make it simpler and 
less hacky, and I found something rather odd: a Twisted XML-RPC server 
seemingly can't return a xmlrpc.DateTime object it has only just received 
from the deserialization layer.

I've attached a test client, using Twisted, and two test servers, one using 
Twisted, one using the standard library's SimpleXMLRPCServer.

The standard library version succeeds in returning the received 
xmlrpclib.DateTime unmolested; the Twisted version complains about the 
message containing unicode:

     File "/usr/lib/python2.4/site-packages/twisted/internet/abstract.py",line 
173, in write
            raise TypeError("Data must not be unicode")
        exceptions.TypeError: Data must not be unicode

This seems wrong: surely, at the very least, the serialization and 
deserialization should allow a round-trip unmodified? Put a slightly 
different way: I don't have a fundamental problem with the restriction that 
return types not include unicode, but surely in that case, the same system 
that enforces this should see to it that I don't receive such a type in the 
first place (given that the original data type I created in the client was a 
xmlrpclib.DateTime, which is explicitly designed for serialising over 
XML-RPC!).

Are there technical/historical/political reasons for this of which I know 
nothing?

Regards,

Ricky

-------------- next part --------------
A non-text attachment was scrubbed...
Name: simpledateserver.py
Type: application/x-python
Size: 599 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20070207/bf08d42f/simpledateserver.bin
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dateclient.py
Type: application/x-python
Size: 495 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20070207/bf08d42f/dateclient.bin
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dateserver.py
Type: application/x-python
Size: 763 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20070207/bf08d42f/dateserver.bin
From exarkun at divmod.com  Wed Feb  7 12:53:50 2007
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Wed Feb  7 12:53:56 2007
Subject: [Twisted-web] Confused about XML-RPC Unicode behaviour (examples
	attached).
In-Reply-To: <200702072041.41786.iacovou@gmail.com>
Message-ID: <20070207185350.25807.1173435593.divmod.quotient.13455@ohm>

On Wed, 7 Feb 2007 20:41:41 +0200, kgi <iacovou@gmail.com> wrote:
>
>Hi all.
>
>I've got a bunch of Twisted XML-RPC servers that serve up a wide range of data
>types include dates. Up until now I've had some hacky code to protect against
>bad data types being returned to the serialization layer (Nones, unicodes,
>etc). However, this code turns out to be difficult to maintain, as well as
>being a modest performance hit.
>
>I thought I see if I couldn't clean up some of the code to make it simpler and
>less hacky, and I found something rather odd: a Twisted XML-RPC server
>seemingly can't return a xmlrpc.DateTime object it has only just received
>from the deserialization layer.
>
>I've attached a test client, using Twisted, and two test servers, one using
>Twisted, one using the standard library's SimpleXMLRPCServer.
>
>The standard library version succeeds in returning the received
>xmlrpclib.DateTime unmolested; the Twisted version complains about the
>message containing unicode:
>
>     File "/usr/lib/python2.4/site-packages/twisted/internet/abstract.py",line
>173, in write
>            raise TypeError("Data must not be unicode")
>        exceptions.TypeError: Data must not be unicode
>
>This seems wrong: surely, at the very least, the serialization and
>deserialization should allow a round-trip unmodified? Put a slightly
>different way: I don't have a fundamental problem with the restriction that
>return types not include unicode, but surely in that case, the same system
>that enforces this should see to it that I don't receive such a type in the
>first place (given that the original data type I created in the client was a
>xmlrpclib.DateTime, which is explicitly designed for serialising over
>XML-RPC!).
>
>Are there technical/historical/political reasons for this of which I know
>nothing?

Nope, it's probably just a bug.  It looks like it may be a bug in the
xmlrpclib module, though.  Consider this interaction:

exarkun@charm:~$ python
Python 2.4.3 (#2, Oct  6 2006, 07:52:30)
[GCC 4.0.3 (Ubuntu 4.0.3-1ubuntu5)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import xmlrpclib
>>> d1 = xmlrpclib.DateTime()
>>> d1
<DateTime '20070207T13:51:36' at -482e1234>
>>> s = xmlrpclib.dumps((d1,))
>>> s
'<params>\n<param>\n<value><dateTime.iso8601>20070207T13:51:36</dateTime.iso8601></value>\n</param>\n</params>\n'
>>> d2 = xmlrpclib.loads(s)[0][0]
>>> d2
<DateTime u'20070207T13:51:36' at -482ddab4>
>>> xmlrpclib.dumps((d2,))
u'<params>\n<param>\n<value><dateTime.iso8601>20070207T13:51:36</dateTime.iso8601></value>\n</param>\n</params>\n'
>>>                                                                                          

Twisted can probably work around the bug here, though.  It would be useful
if you could file a ticket in the tracker for this (one in Twisted's and
one in Python's).

Jean-Paul

From mailinglists at smartology.nl  Thu Feb  8 06:31:27 2007
From: mailinglists at smartology.nl (Remi Cool)
Date: Thu Feb  8 06:31:48 2007
Subject: [Twisted-web] Are twisted xmlrpc calls non-blocking?
Message-ID: <45CB181F.4050301@smartology.nl>

Hello,

I need to be able to call xmlrpc methods on a remote xmlrpc server from
my twisted xmlrpc server.

I've created the following function in my service:

def xmlrpcCall(self, method, args, callback, callbackArgs=None,
callbackKeywords=None,
                                   errback=None, errbackArgs=None,
errbackKeywords=None):
    """Call xml-rpc method with args on the remote server"""

    # create proxy object and call the remote method with args
    p = xmlrpc.Proxy(self.url)
    d = p.callRemote(method, *args)
    # add callbacks
    d.addCallbacks(callback, errback, callbackArgs, callbackKeywords,
errbackArgs, errbackKeywords)
    return d

Is this call non-blocking?

I tend to think not, because when I call a method with a 5 sec delay
from a "runInteraction" thread, the thread returns when it handled the
call. This is how I prefer it in this case, but when I want to use the
xmlrpcCall method from a non "runInteraction" call, do I need to wrap it
up in a thread myself?

Like so:


from twisted.internet import threads

def xmlrpcAsyncCall(self, method, args, callback, callbackArgs=None,
callbackKeywords=None,
                                        errback=None, errbackArgs=None,
errbackKeywords=None):
    """Call xml-rpc method non-blocking with args on the remote server"""
   
    return threads.deferToThread(self.xmlrpcCall, method, args,
callback, callbackArgs=None, callbackKeywords=None,
                                                               
errback=None, errbackArgs=None, errbackKeywords=None)
   

Or can I just call xmlrpcCall, return the deferred and forget about it?

- Remi -

From radix at twistedmatrix.com  Thu Feb  8 08:24:37 2007
From: radix at twistedmatrix.com (Christopher Armstrong)
Date: Thu Feb  8 08:24:43 2007
Subject: [Twisted-web] Are twisted xmlrpc calls non-blocking?
In-Reply-To: <45CB181F.4050301@smartology.nl>
References: <45CB181F.4050301@smartology.nl>
Message-ID: <60ed19d40702080624k5d835d4ob392963519c3e1ae@mail.gmail.com>

On 2/8/07, Remi Cool <mailinglists@smartology.nl> wrote:
> Hello,
>
> I need to be able to call xmlrpc methods on a remote xmlrpc server from
> my twisted xmlrpc server.
>
> I've created the following function in my service:
>

>
> Is this call non-blocking?

It is non-blocking. If it returns a Deferred it is unlikely to be
blocking, unless the author didn't understand what the point of
Deferreds are :) Remember: Twisted tries very hard to never require
you to do any kind of thread work.

Also remember, just in case: The only Twisted API that is thread safe
is reactor.callFromThread.

-- 
Christopher Armstrong
International Man of Twistery
http://radix.twistedmatrix.com/
http://twistedmatrix.com/
http://canonical.com/

From exarkun at divmod.com  Thu Feb  8 08:58:35 2007
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Thu Feb  8 08:58:37 2007
Subject: [Twisted-web] Are twisted xmlrpc calls non-blocking?
In-Reply-To: <45CB2970.3030700@smartology.nl>
Message-ID: <20070208145835.25807.1393422849.divmod.quotient.14559@ohm>

On Thu, 08 Feb 2007 14:45:20 +0100, Remi Cool <mailinglists@smartology.nl> wrote:
>Jean-Paul Calderone wrote:
>> On Thu, 08 Feb 2007 13:31:27 +0100, Remi Cool
>> <mailinglists@smartology.nl> wrote:
> [snip]
>>>
>>> I tend to think not, because when I call a method with a 5 sec delay
>>> from a "runInteraction" thread, the thread returns when it handled the
>>> call. This is how I prefer it in this case, but when I want to use the
>>> xmlrpcCall method from a non "runInteraction" call, do I need to wrap it
>>> up in a thread myself?
>>
>> Oops!  You _can't_ do that.  Twisted APIs must be invoked from the
>> reactor
>> thread.  They don't work in any other thread.
>>
>Let me explain:
>
>a user calls the xml-rpc method "init" on my twisted xmlrpc server like:
>
>xmlrpc_init(self):
>    """"""
>    return self.service.connPool.runInteraction(myInit, self.service)
>
>The myInit function has to fetch some data from the database and from a
>remote xml-rpc server.
>So ... first I get the data from the database , print a log line ...
>call the service.xmlrpcCall method ... and print another log line.
>
>The method on the remote xml-rpc server delays 5 secs, prints a log line
>and then sends back a string.
>The log lines are in the right order.  But you say the xmlrcpCall method
>doesn't block?

It doesn't block, but it doesn't work very well, since it uses Twisted APIs
from a non-reactor thread.  The 5 seconds are probably just spent idling,
and then some unrelated event wakes up the reactor, at which point it then
notices that you asked it to do something, and does it.

>
>So if I understand correctly, I can't use any twisted api's in threads,
>even if they are created with threads.deferToThread?

Correct.  You can call back into the reactor thread, though.  See the
callFromThread method of the reactor.

Jean-Paul

From iacovou at gmail.com  Fri Feb  9 05:14:06 2007
From: iacovou at gmail.com (kgi)
Date: Fri Feb  9 05:14:09 2007
Subject: [Twisted-web] Confused about XML-RPC Unicode behaviour (examples
	attached).
In-Reply-To: <20070207185350.25807.1173435593.divmod.quotient.13455@ohm>
References: <20070207185350.25807.1173435593.divmod.quotient.13455@ohm>
Message-ID: <200702091314.07050.iacovou@gmail.com>

On Wednesday 07 February 2007 20:53, Jean-Paul Calderone wrote:

> Nope, it's probably just a bug.  It looks like it may be a bug in the
> xmlrpclib module, though.  Consider this interaction:

Thanks for your reply, JP.

You're right that it looks like a bug in xmlrpclib itself; however, it only 
looks like it's a bug in Python 2.4's version of xmlrpclib; version Python 
2.5 has a slightly different xmlrpclib.py that does not exhibit this 
behaviour; using your example:

$ python2.5
Python 2.5 (r25:51908, Oct  6 2006, 15:22:41)
[GCC 4.1.2 20060928 (prerelease) (Ubuntu 4.1.1-13ubuntu4)] on linux2
Type "help", "copyright", "credits" or "license" for more information.
>>> import xmlrpclib
>>> d1 = xmlrpclib.DateTime()
>>> d1
<DateTime '20070209T13:02:31' at b7d4896c>
>>> s = xmlrpclib.dumps((d1,))
>>> s
'<params>\n<param>\n<value><dateTime.iso8601>20070209T13:02:31</dateTime.iso8601></value>\n</param>\n</params>\n'
>>> d2 = xmlrpclib.loads(s)[0][0]
>>> d2
<DateTime '20070209T13:02:31' at b7d48e2c>
>>> xmlrpclib.dumps((d2,))
'<params>\n<param>\n<value><dateTime.iso8601>20070209T13:02:31</dateTime.iso8601></value>\n</param>\n</params>\n'

So obviously someone noticed that 2.4's was buggy from a round-trip 
point-of-view and corrected it for 2.5. Not sure if that means that they will 
be unreceptive to patching 2.4.

It also looks like one can just drop 2.5's xmlrpclib.py into a 2.4 tree and 
run compileall.py and the odd behaviour disappears.

Having Twisted work around this problem would be a Good Thing, however. I'll 
file a bug report.

Cheers

Ricky

From iacovou at gmail.com  Fri Feb  9 06:07:45 2007
From: iacovou at gmail.com (kgi)
Date: Fri Feb  9 06:07:46 2007
Subject: [Twisted-web] Confused about XML-RPC Unicode behaviour (examples
	attached).
In-Reply-To: <20070207185350.25807.1173435593.divmod.quotient.13455@ohm>
References: <20070207185350.25807.1173435593.divmod.quotient.13455@ohm>
Message-ID: <200702091407.45361.iacovou@gmail.com>

On Wednesday 07 February 2007 20:53, Jean-Paul Calderone wrote:
> Twisted can probably work around the bug here, though.  It would be useful
> if you could file a ticket in the tracker for this (one in Twisted's and
> one in Python's).

Ticket filed:

  http://twistedmatrix.com/trac/ticket/2446

Thanks.


From lorenzov at libero.it  Sun Feb 18 16:07:58 2007
From: lorenzov at libero.it (Lorenzo)
Date: Sun Feb 18 16:08:05 2007
Subject: [Twisted-web] web client
Message-ID: <JDOITA$8380BC8CA407A8CF55E55690BDB47899@libero.it>

Hello, I'm using twisted to develop a small crawler. I need to download a large set of HTML pages/RSS feeds and I'd like to use the twisted's Web client.

I ?'ve found some examples on the net, and I'm using mostly the one attached here http://twistedmatrix.com/bugs/issue1079 , but I'm having some problems.

first of all I need the reactor to halt after all the files on the queue have been downloaded. Basically the sample uses a counter, that it updates every time it adds a new page to the list.


d = getPage(address) 
d.addBoth(self.decConn)
d.setTimeout(4, self.timeout)
self.connections += 1

Everytime one of decConn or timeout has been fired I update the counter

self.connections -= 1

When it becames <= 0 I stop the reactor. Basically this approach doesn't work, because the two functions are fired many times for some requests (I guess those are redirects...).

So, how can I correctly check the number of completed requests and eventually stop the reactor?
Is there any sample of a small crawler (also one that doesn't use twisted....) available on the net??
thanks
LV


------------------------------------------------------
Passa a Infostrada. ADSL e Telefono senza limiti e senza canone Telecom
http://click.libero.it/infostrada18feb07



From manlio_perillo at libero.it  Tue Feb 20 14:44:48 2007
From: manlio_perillo at libero.it (Manlio Perillo)
Date: Tue Feb 20 14:44:54 2007
Subject: [Twisted-web] [Nevow] childFactory being called more than once with
	macros
Message-ID: <45DB5DC0.70407@libero.it>

Hi.

I'm having strange problems with childFactory and macros.

My application uses a template with the main content renderized with a 
macro.


<html>
   ....
   <n:invisible n:macro="main" />
   ...
</html>


I have a base class:

class Base(rend.rend):
   template = ... # The template to use as tha main content

   def macro_main(self, ctx):
      return loaders.xmlfile(self.template)


Every page derives from Base, and defines its template.

I do not understand why, but childFactory is called 2 times per request.
If I replace the n:macro with a n:render, childFactory is called 3 times?

Why is this happening?

What is the best solution to compose a page from a main template?


Thanks   Manlio Perillo

From dialtone at divmod.com  Tue Feb 20 16:13:31 2007
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Tue Feb 20 16:13:34 2007
Subject: [Twisted-web] [Nevow] childFactory being called more than once
	with
In-Reply-To: <45DB5DC0.70407@libero.it>
Message-ID: <20070220221331.25807.2108362576.divmod.quotient.28358@ohm>



On Tue, 20 Feb 2007 21:44:48 +0100, Manlio Perillo <manlio_perillo@libero.it> wrote:

>I do not understand why, but childFactory is called 2 times per request.
>If I replace the n:macro with a n:render, childFactory is called 3 times?
>
>Why is this happening?

Pretty normal if you use addSlash=True while not putting an ending / at every
url.

There's no link between childFactory and macro rendering.

From manlio_perillo at libero.it  Wed Feb 21 04:19:41 2007
From: manlio_perillo at libero.it (Manlio Perillo)
Date: Wed Feb 21 04:19:46 2007
Subject: [Twisted-web] [Nevow] childFactory being called more than once
	with
In-Reply-To: <20070220221331.25807.2108362576.divmod.quotient.28358@ohm>
References: <20070220221331.25807.2108362576.divmod.quotient.28358@ohm>
Message-ID: <45DC1CBD.5090206@libero.it>

Valentino Volonghi aka Dialtone ha scritto:
> 
> 
> On Tue, 20 Feb 2007 21:44:48 +0100, Manlio Perillo 
> <manlio_perillo@libero.it> wrote:
> 
>> I do not understand why, but childFactory is called 2 times per request.
>> If I replace the n:macro with a n:render, childFactory is called 3 times?
>>
>> Why is this happening?
> 
> Pretty normal if you use addSlash=True while not putting an ending / at 
> every
> url.
> 
> There's no link between childFactory and macro rendering.
> 


Just forget it!

I have a personalized locateChild in the base class, where I do:

     def locateChild(self, ctx, segments):
         request = inevow.IRequest(ctx)
         if request.args.get('login-failure'):
             import login

             return login.Login(self.avatar, failure=True), ''

         res = rend.Page.locateChild(self, ctx, segments)
         if res == rend.NotFound:
             return NotFound(self.avatar), ''

         return rend.Page.locateChild(self, ctx, segments) # <===


:-).



By the way, is this code the best way to handle a login failure?

Moreover, I still do not understand why, when replacing macro with 
render, locateChild is called 3 times, instead of 2.



Regards   Manlio Perillo

From dialtone at divmod.com  Wed Feb 21 04:58:05 2007
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Wed Feb 21 04:58:07 2007
Subject: [Twisted-web] [Nevow] childFactory being called more than once
In-Reply-To: <45DC1CBD.5090206@libero.it>
Message-ID: <20070221105805.25807.1115718747.divmod.quotient.28787@ohm>

On Wed, 21 Feb 2007 11:19:41 +0100, Manlio Perillo <manlio_perillo@libero.it> wrote:
>Just forget it!
>
>I have a personalized locateChild in the base class, where I do:
>
>     def locateChild(self, ctx, segments):
>         request = inevow.IRequest(ctx)
>         if request.args.get('login-failure'):
>             import login
>
>             return login.Login(self.avatar, failure=True), ''
>
>         res = rend.Page.locateChild(self, ctx, segments)
>         if res == rend.NotFound:
>             return NotFound(self.avatar), ''
>
>         return rend.Page.locateChild(self, ctx, segments) # <===

This code is wrong in 2 ways:

1) locateChild can return deferreds, you are not covering this aspect.
2) Why calling locateChild twice when once is enough? if the page is not rend.NotFound then it's the page you want... just return it.

>By the way, is this code the best way to handle a login failure?

Can't spot anything terribly wrong there.

>Moreover, I still do not understand why, when replacing macro with render, 
>locateChild is called 3 times, instead of 2.

You probably have other confusions in your source. As I said there's no link _at all_ between rendering and child locating.

From manlio_perillo at libero.it  Wed Feb 21 05:19:55 2007
From: manlio_perillo at libero.it (Manlio Perillo)
Date: Wed Feb 21 05:20:02 2007
Subject: [Twisted-web] [Nevow] childFactory being called more than once
In-Reply-To: <20070221105805.25807.1115718747.divmod.quotient.28787@ohm>
References: <20070221105805.25807.1115718747.divmod.quotient.28787@ohm>
Message-ID: <45DC2ADB.7010907@libero.it>

Valentino Volonghi aka Dialtone ha scritto:
> On Wed, 21 Feb 2007 11:19:41 +0100, Manlio Perillo 
> <manlio_perillo@libero.it> wrote:
>> Just forget it!
>>
>> I have a personalized locateChild in the base class, where I do:
>>
>>     def locateChild(self, ctx, segments):
>>         request = inevow.IRequest(ctx)
>>         if request.args.get('login-failure'):
>>             import login
>>
>>             return login.Login(self.avatar, failure=True), ''
>>
>>         res = rend.Page.locateChild(self, ctx, segments)
>>         if res == rend.NotFound:
>>             return NotFound(self.avatar), ''
>>
>>         return rend.Page.locateChild(self, ctx, segments) # <===
> 
> This code is wrong in 2 ways:
> 
> 1) locateChild can return deferreds, you are not covering this aspect.

Right, thanks.

> 2) Why calling locateChild twice when once is enough? if the page is not 
> rend.NotFound then it's the page you want... just return it.
> 

Yes, I have marked the code with an arrow!
It was the first thing I notice when I have read the code.

>> By the way, is this code the best way to handle a login failure?
> 
> Can't spot anything terribly wrong there.
> 

Ok.

>> Moreover, I still do not understand why, when replacing macro with 
>> render, locateChild is called 3 times, instead of 2.
> 
> You probably have other confusions in your source. As I said there's no 
> link _at all_ between rendering and child locating.
> 

Now the code is all ok.


Regards  Manlio Perillo

From manlio_perillo at libero.it  Wed Feb 21 05:32:08 2007
From: manlio_perillo at libero.it (Manlio Perillo)
Date: Wed Feb 21 05:32:14 2007
Subject: [Twisted-web] about macro and render
Message-ID: <45DC2DB8.5020309@libero.it>

Hi.

I want to compose a page, using a main template.
A simple solution is to use macros

class Resource(rend.rend):
   def macro_main(self, ctx):
      return loaders.xmlfile(...)


The macro_main method is called only once.

However it seems that macros are going to be removed, moreover if I 
change the child template, I have to reload the server.

A solution is to use a render (code not tested):

class Resource(rend.rend):
   template = ... # The child template to load

   def macro_main(self, ctx):
      return self.state.setdefault(
               template, loaders.xmlfile(self.template)
               )


Here I'm storing the loader instance in a dictionary, to optimize 
template loading.


Is this solution as efficient as the one with macros?



Thanks Manlio Perillo

From dialtone at divmod.com  Wed Feb 21 05:44:25 2007
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Wed Feb 21 05:44:26 2007
Subject: [Twisted-web] about macro and render
In-Reply-To: <45DC2DB8.5020309@libero.it>
Message-ID: <20070221114425.25807.14151508.divmod.quotient.28808@ohm>



On Wed, 21 Feb 2007 12:32:08 +0100, Manlio Perillo <manlio_perillo@libero.it> wrote:
>Hi.
>
>I want to compose a page, using a main template.
>A simple solution is to use macros
>
>class Resource(rend.rend):
>   def macro_main(self, ctx):
>      return loaders.xmlfile(...)
>
>
>The macro_main method is called only once.
>
>However it seems that macros are going to be removed, moreover if I change 

Not to my knowledge, at least I'd be opposed/incline to re-implement them
because I use them extensively in all my projects.

>the child template, I have to reload the server.

Not really... just change the macro too with something like touch.

>A solution is to use a render (code not tested):
>
>class Resource(rend.rend):
>   template = ... # The child template to load
>
>   def macro_main(self, ctx):
>      return self.state.setdefault(
>               template, loaders.xmlfile(self.template)
>               )
>
>
>Here I'm storing the loader instance in a dictionary, to optimize template 
>loading.

Useless, loaders already have a cache.

>Is this solution as efficient as the one with macros?

macros are not a way to cache stuff, but to compose stuff dynamically at pre-compile time.

From manlio_perillo at libero.it  Wed Feb 21 05:54:50 2007
From: manlio_perillo at libero.it (Manlio Perillo)
Date: Wed Feb 21 05:54:54 2007
Subject: [Twisted-web] about macro and render
In-Reply-To: <20070221114425.25807.14151508.divmod.quotient.28808@ohm>
References: <20070221114425.25807.14151508.divmod.quotient.28808@ohm>
Message-ID: <45DC330A.90502@libero.it>

Valentino Volonghi aka Dialtone ha scritto:
> 
> 
> On Wed, 21 Feb 2007 12:32:08 +0100, Manlio Perillo 
> <manlio_perillo@libero.it> wrote:
>> Hi.
>>
>> I want to compose a page, using a main template.
>> A simple solution is to use macros
>>
>> class Resource(rend.rend):
>>   def macro_main(self, ctx):
>>      return loaders.xmlfile(...)
>>
>>
>> The macro_main method is called only once.
>>
>> However it seems that macros are going to be removed, moreover if I 
>> change 
> 
> Not to my knowledge, at least I'd be opposed/incline to re-implement them
> because I use them extensively in all my projects.
> 

Yes, they are very handy.

>> the child template, I have to reload the server.
> 
> Not really... just change the macro too with something like touch.
> 

Thanks, I just forget it.


 > [...]



Regards  Manlio Perillo

From manlio_perillo at libero.it  Wed Feb 21 06:03:30 2007
From: manlio_perillo at libero.it (Manlio Perillo)
Date: Wed Feb 21 06:03:38 2007
Subject: [Twisted-web] about macro and render
In-Reply-To: <20070221114425.25807.14151508.divmod.quotient.28808@ohm>
References: <20070221114425.25807.14151508.divmod.quotient.28808@ohm>
Message-ID: <45DC3512.6020906@libero.it>

Valentino Volonghi aka Dialtone ha scritto:
> 
> 
> On Wed, 21 Feb 2007 12:32:08 +0100, Manlio Perillo 
> <manlio_perillo@libero.it> wrote:
> [...]
>> class Resource(rend.rend):
>>   template = ... # The child template to load
>>
>>   def render_main(self, ctx, data):
>>      return self.state.setdefault(
>>               template, loaders.xmlfile(self.template)
>>               )
>>
>>
>> Here I'm storing the loader instance in a dictionary, to optimize 
>> template loading.
> 
> Useless, loaders already have a cache.
> 

I have read the loaders.py, and, as far as I can see, the cache is 
*inside* the loader instance.

This means that the cache is destroyed when the loader istance goes out 
of the scope; the document is reloaded every time render_main is called.



Regards  Manlio Perillo

From jarek.zgoda at gmail.com  Wed Feb 21 07:13:20 2007
From: jarek.zgoda at gmail.com (Jarek Zgoda)
Date: Wed Feb 21 07:13:24 2007
Subject: [Twisted-web] Headers dictionary
Message-ID: <a12ade230702210513u6771d5b3rc5c27dbb1e1fb607@mail.gmail.com>

Is it only me, or the field names in
twisted.web.http.Request.received_headers (also returned by
getAllHeaders()) are case-sensitive? The RFC states, that they should
be case-insensitive
(http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html#sec4.2), but if
I set "Accept" header in client code (such as using Python's own
httplib.HTTPConnection), there's no "accept" key in this dictionary,
as available in resource's render_XXX method.

Am I supposed to write my own HTTP compatibility layer for
twisted.web, or I just overlooked something obvious?

-- 
Jarek Zgoda
http://jpa.berlios.de/

From dialtone at divmod.com  Wed Feb 21 08:28:54 2007
From: dialtone at divmod.com (Valentino Volonghi aka Dialtone)
Date: Wed Feb 21 08:28:57 2007
Subject: [Twisted-web] about macro and render
In-Reply-To: <45DC3512.6020906@libero.it>
Message-ID: <20070221142854.25807.1281230559.divmod.quotient.28890@ohm>

On Wed, 21 Feb 2007 13:03:30 +0100, Manlio Perillo <manlio_perillo@libero.it> wrote:
>>[...]
>>>class Resource(rend.rend):
>>>   template = ... # The child template to load
>>>
>>>   def render_main(self, ctx, data):
>>>      return self.state.setdefault(
>>>               template, loaders.xmlfile(self.template)
>>>               )
>>>
>>>
>>>Here I'm storing the loader instance in a dictionary, to optimize template 
>>>loading.
>>
>>Useless, loaders already have a cache.
>
>I have read the loaders.py, and, as far as I can see, the cache is *inside* 
>the loader instance.
>
>This means that the cache is destroyed when the loader istance goes out of 
>the scope; the document is reloaded every time render_main is called.

I see you are actually saving the loader in self.state and this wouldn't let
the loader die. Anyway you just need to provide another class variable for the loader, seems easy.

From exarkun at divmod.com  Wed Feb 21 08:38:14 2007
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Wed Feb 21 08:38:15 2007
Subject: [Twisted-web] Headers dictionary
In-Reply-To: <a12ade230702210513u6771d5b3rc5c27dbb1e1fb607@mail.gmail.com>
Message-ID: <20070221143814.25807.448194000.divmod.quotient.28896@ohm>

On Wed, 21 Feb 2007 14:13:20 +0100, Jarek Zgoda <jarek.zgoda@gmail.com> wrote:
>Is it only me, or the field names in
>twisted.web.http.Request.received_headers (also returned by
>getAllHeaders()) are case-sensitive? The RFC states, that they should
>be case-insensitive
>(http://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html#sec4.2), but if
>I set "Accept" header in client code (such as using Python's own
>httplib.HTTPConnection), there's no "accept" key in this dictionary,
>as available in resource's render_XXX method.
>
>Am I supposed to write my own HTTP compatibility layer for
>twisted.web, or I just overlooked something obvious?

Can you provide an example which demonstrates the problem you're seeing?  This
example seems to demonstrate that all headers are lower-cased:

    from twisted.web.resource import Resource
    from twisted.web.server import Site
    from twisted.application.service import Application
    from twisted.application.internet import TCPServer

    class X(Resource):
        def getChild(self, *a):
            return self

        def render_GET(self, request):
            print request.getAllHeaders()
            return ''

    application = Application('HTTP Test')
    TCPServer(8080, Site(X())).setServiceParent(application)

Hitting the server with Firefox results in a dictionary with an 'accept'
key, with that spelling, regardless of the case of the input.

Jean-Paul

From jarek.zgoda at gmail.com  Wed Feb 21 08:54:29 2007
From: jarek.zgoda at gmail.com (Jarek Zgoda)
Date: Wed Feb 21 08:54:33 2007
Subject: [Twisted-web] Headers dictionary
In-Reply-To: <20070221143814.25807.448194000.divmod.quotient.28896@ohm>
References: <a12ade230702210513u6771d5b3rc5c27dbb1e1fb607@mail.gmail.com>
	<20070221143814.25807.448194000.divmod.quotient.28896@ohm>
Message-ID: <a12ade230702210654u5cea2aecv690ad75e14be5ac6@mail.gmail.com>

On 2/21/07, Jean-Paul Calderone <exarkun@divmod.com> wrote:

> Can you provide an example which demonstrates the problem you're seeing?  This
> example seems to demonstrate that all headers are lower-cased:
>
(...)
>
> Hitting the server with Firefox results in a dictionary with an 'accept'
> key, with that spelling, regardless of the case of the input.

This example is perfect, what failed is my understanding of things and
my ability to express what I've seen with my code.

I encountered this problem when I used the same code to generate
headers for client to send and for server to check. The generated
field names was in Mixed-Case (i.e. "Accept" and "Content-Type") so I
got the KeyError on server side. I expected this to be irrelevant,
following RFC's statement that "field names are case insensitive".

Anyway, I can live with this.

-- 
Jarek Zgoda
http://jpa.berlios.de/

From glyph at divmod.com  Wed Feb 21 08:54:34 2007
From: glyph at divmod.com (glyph@divmod.com)
Date: Wed Feb 21 08:54:37 2007
Subject: [Twisted-web] Headers dictionary
Message-ID: <20070221145434.28203.526423335.divmod.xquotient.3228@joule.divmod.com>

On 01:13 pm, jarek.zgoda@gmail.com wrote:
>Is it only me, or the field names in
>twisted.web.http.Request.received_headers (also returned by
>getAllHeaders()) are case-sensitive?

It's only you.  From twisted.web.http.Request:

    def headerReceived(self, line):
        """Do pre-processing (for content-length) and store this header away.
        """
        header, data = line.split(':', 1)
        header = header.lower()
                        ^^^^^
        # ...
    def getHeader(self, key):
        """Get a header that was sent from the network.
        """
        return self.received_headers.get(key.lower())
                                             ^^^^^

Do you have a more specific example of what's gone wrong?

-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20070221/c79e64ed/attachment.htm
From jarek.zgoda at gmail.com  Wed Feb 21 09:15:33 2007
From: jarek.zgoda at gmail.com (Jarek Zgoda)
Date: Wed Feb 21 09:15:37 2007
Subject: [Twisted-web] Headers dictionary
In-Reply-To: <20070221145434.28203.526423335.divmod.xquotient.3228@joule.divmod.com>
References: <20070221145434.28203.526423335.divmod.xquotient.3228@joule.divmod.com>
Message-ID: <a12ade230702210715t13fac141xd2c4a813f5d7c7cc@mail.gmail.com>

On 2/21/07, glyph@divmod.com <glyph@divmod.com> wrote:

> On 01:13 pm, jarek.zgoda@gmail.com wrote:
> >Is it only me, or the field names in
> >twisted.web.http.Request.received_headers (also returned
> by
> >getAllHeaders()) are case-sensitive?
>
> It's only you.  From twisted.web.http.Request:
>
>     def headerReceived(self, line):
>         """Do pre-processing (for content-length) and store this header
> away.
>         """
>         header, data = line.split(':', 1)
>         header = header.lower()
>                         ^^^^^
>         # ...
>     def getHeader(self, key):
>         """Get a header that was sent from the network.
>         """
>         return self.received_headers.get(key.lower())
>                                              ^^^^^
>
> Do you have a more specific example of what's gone wrong?

I explained what gone wrong in my reply to JP. What seems unintuitive
(and is undocumented) is that "lowercase" is treated as synonym for
"case insensitive". Anyway, it's not that bad.

-- 
Jarek Zgoda
http://jpa.berlios.de/

From exarkun at divmod.com  Wed Feb 21 09:44:34 2007
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Wed Feb 21 09:44:38 2007
Subject: [Twisted-web] Headers dictionary
In-Reply-To: <a12ade230702210715t13fac141xd2c4a813f5d7c7cc@mail.gmail.com>
Message-ID: <20070221154434.25807.870958555.divmod.quotient.28929@ohm>

On Wed, 21 Feb 2007 16:15:33 +0100, Jarek Zgoda <jarek.zgoda@gmail.com> wrote:
> [snip]
>
>I explained what gone wrong in my reply to JP. What seems unintuitive
>(and is undocumented) is that "lowercase" is treated as synonym for
>"case insensitive". Anyway, it's not that bad.
>

If you use getHeader(name) instead, then the case of name is also irrelevant.

Jean-Paul

From p.mayers at imperial.ac.uk  Fri Feb 23 13:50:09 2007
From: p.mayers at imperial.ac.uk (Phil Mayers)
Date: Fri Feb 23 13:50:22 2007
Subject: [Twisted-web] validating nevow disk templates
Message-ID: <20070223195008.GA28819@wildfire.net.ic.ac.uk>

How do people do this?

When I attempt to validate pages using the FireFox / Web Developer 
validator, I get a lot of complaints about tags that should be 
self-closed e.g.:

<input type="text">
  <nevow:attr name="name"><nevow:slot name="name"/></nevow:attr>
</input>

...generates HTML like this:

<input type="text" name="theName">

</input>

...which is not only ugly, it doesn't validate.

I like stan, but I dislike the fact that it clutters up .py files and 
also that it doesn't reload like the disk templates. OTOH I deeply 
dislike the nevow:attr / nevow:slot pseudo-tags in the disk templates.

Thoughts?

From exarkun at divmod.com  Fri Feb 23 13:58:02 2007
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Fri Feb 23 13:58:05 2007
Subject: [Twisted-web] validating nevow disk templates
In-Reply-To: <20070223195008.GA28819@wildfire.net.ic.ac.uk>
Message-ID: <20070223195802.25807.676846104.divmod.quotient.30598@ohm>

On Fri, 23 Feb 2007 19:50:09 +0000, Phil Mayers <p.mayers@imperial.ac.uk> wrote:
>How do people do this?
>
>When I attempt to validate pages using the FireFox / Web Developer 
>validator, I get a lot of complaints about tags that should be self-closed 
>e.g.:
>
><input type="text">
>  <nevow:attr name="name"><nevow:slot name="name"/></nevow:attr>
></input>
>
>...generates HTML like this:
>
><input type="text" name="theName">
>
></input>
>
>...which is not only ugly, it doesn't validate.
>
>I like stan, but I dislike the fact that it clutters up .py files and also 
>that it doesn't reload like the disk templates. OTOH I deeply dislike the 
>nevow:attr / nevow:slot pseudo-tags in the disk templates.
>
>Thoughts?
>

<input type="text"><nevow:attr ...></input>

will generate valid xhtml.  I'm not sure I have any suggestions other than
to use input which will generate valid output.

If you have any suggestions for improving the usability of templates, I'd be
more than happy to hear them.

Jean-Paul

From ldanielburr at mac.com  Fri Feb 23 14:10:08 2007
From: ldanielburr at mac.com (L. Daniel Burr)
Date: Fri Feb 23 14:10:25 2007
Subject: [Twisted-web] validating nevow disk templates
In-Reply-To: <20070223195008.GA28819@wildfire.net.ic.ac.uk>
References: <20070223195008.GA28819@wildfire.net.ic.ac.uk>
Message-ID: <op.tn7wy7cv3oj628@l-daniel-burrs-powerbook-g4-17.local>

Hi Phil,

On Fri, 23 Feb 2007 13:50:09 -0600, Phil Mayers <p.mayers@imperial.ac.uk>  
wrote:

> How do people do this?
>
> When I attempt to validate pages using the FireFox / Web Developer  
> validator, I get a lot of complaints about tags that should be  
> self-closed e.g.:
>
> <input type="text">
>   <nevow:attr name="name"><nevow:slot name="name"/></nevow:attr>
> </input>
>

Generally, I try to avoid working to please markup validators, but that
may just be me ;)

> ...generates HTML like this:
>
> <input type="text" name="theName">
>
> </input>
>
> ...which is not only ugly, it doesn't validate.
>

A simple way to get around this is to eschew the cuter features of
nevow, and stick to plain-old render methods:

<input type="text" nevow:render="foo" />

In the render method, just grab the tag, twiddle its attributes in
whatever way best pleases you, and return it.

> I like stan, but I dislike the fact that it clutters up .py files and  
> also that it doesn't reload like the disk templates. OTOH I deeply  
> dislike the nevow:attr / nevow:slot pseudo-tags in the disk templates.
>

Sounds like you won't be happy either way ;)  Fortunately, something
like what I suggested above should work for your stated case, and
allow you to steer between the Scylla of stan and the Charybdis of
nevow:attr.

Hope this helps,

L. Daniel Burr

From p.mayers at imperial.ac.uk  Fri Feb 23 19:03:01 2007
From: p.mayers at imperial.ac.uk (Phil Mayers)
Date: Fri Feb 23 19:03:06 2007
Subject: [Twisted-web] validating nevow disk templates
In-Reply-To: <20070223195802.25807.676846104.divmod.quotient.30598@ohm>
References: <20070223195802.25807.676846104.divmod.quotient.30598@ohm>
Message-ID: <45DF8EC5.1080100@imperial.ac.uk>

Jean-Paul Calderone wrote:
> 
> <input type="text"><nevow:attr ...></input>
> 
> will generate valid xhtml.  I'm not sure I have any suggestions other than
> to use input which will generate valid output.

Hmm. Ok, I see. As you say, the reason it's barfing is that:

<input type="text" value="var"></input>

...is valid xhtml, but:

<input type="text" value="var">

</input>

..is not. Bother. So, no nice indentation in xmlfile templates.

As for "improving nevow" I happen to think it's the best of the bunch in 
terms of Python xhtml template engines, and I've used them all at one 
point or another.


From p.mayers at imperial.ac.uk  Fri Feb 23 19:12:22 2007
From: p.mayers at imperial.ac.uk (Phil Mayers)
Date: Fri Feb 23 19:12:33 2007
Subject: [Twisted-web] validating nevow disk templates
In-Reply-To: <op.tn7wy7cv3oj628@l-daniel-burrs-powerbook-g4-17.local>
References: <20070223195008.GA28819@wildfire.net.ic.ac.uk>
	<op.tn7wy7cv3oj628@l-daniel-burrs-powerbook-g4-17.local>
Message-ID: <45DF90F6.5030406@imperial.ac.uk>

L. Daniel Burr wrote:
> 
> Generally, I try to avoid working to please markup validators, but that
> may just be me ;)


I don't aim to please them. But I do aim to meet the standards.

> <input type="text" nevow:render="foo" />

IMHO excessive use of render methods leads to madness. I try very hard 
to make my render methods markup-unaware. Most of them read like:

tag = context.tag
thing = tag.patternGenerator('thing')
for item in data:
    this = thing()
    for k,v in item.items():
        this.fillSlot(k, v)
    tag[this]
return tag

i.e. all that render does is compose patterns and fill slots. Hence I 
like having the values of attributes as slots.

>> I like stan, but I dislike the fact that it clutters up .py files and 
>> also that it doesn't reload like the disk templates. OTOH I deeply 
>> dislike the nevow:attr / nevow:slot pseudo-tags in the disk templates.
>>
> 
> Sounds like you won't be happy either way ;)  Fortunately, something

Well, I did not mean to give that impression. I would not be spending 
time on Twisted+Nevow if it didn't make me happy.

> like what I suggested above should work for your stated case, and

Sorry, but I like using a bazillion render methods merely to set 
attributes even less!

If the answer is "you can't pretty-indent xmlfile templates and still 
have them validate" that's fine.

Thanks for the feedback.

From manlio_perillo at libero.it  Sat Feb 24 02:56:48 2007
From: manlio_perillo at libero.it (Manlio Perillo)
Date: Sat Feb 24 02:56:53 2007
Subject: [Twisted-web] validating nevow disk templates
In-Reply-To: <45DF8EC5.1080100@imperial.ac.uk>
References: <20070223195802.25807.676846104.divmod.quotient.30598@ohm>
	<45DF8EC5.1080100@imperial.ac.uk>
Message-ID: <45DFFDD0.7060503@libero.it>

Phil Mayers ha scritto:
> Jean-Paul Calderone wrote:
>>
>> <input type="text"><nevow:attr ...></input>
>>
>> will generate valid xhtml.  I'm not sure I have any suggestions other 
>> than
>> to use input which will generate valid output.
> 
> Hmm. Ok, I see. As you say, the reason it's barfing is that:
> 
> <input type="text" value="var"></input>
> 
> ...is valid xhtml, but:
> 
> <input type="text" value="var">
> 
> </input>
> 
> ..is not. Bother. So, no nice indentation in xmlfile templates.
> 

See http://divmod.org/trac/ticket/1927

 > [...]


Regards  Manlio Perillo

From mobiledreamers at gmail.com  Mon Feb 26 01:20:48 2007
From: mobiledreamers at gmail.com (mobiledreamers@gmail.com)
Date: Mon Feb 26 01:20:58 2007
Subject: [Twisted-web] Reg adding etag and modified arguments to twisted
	feedparser
In-Reply-To: <c1870d60702252114l441de8ddw37c46c6382d74c6b@mail.gmail.com>
References: <c1870d60702252114l441de8ddw37c46c6382d74c6b@mail.gmail.com>
Message-ID: <c1870d60702252320r34639386x2ad24a26ffc7fb82@mail.gmail.com>

Skipped content of type multipart/alternative-------------- next part --------------
A non-text attachment was scrubbed...
Name: twistedfeedaggreg_conditional.py
Type: application/octet-stream
Size: 11326 bytes
Desc: not available
Url : http://twistedmatrix.com/pipermail/twisted-web/attachments/20070225/b39857f1/twistedfeedaggreg_conditional.obj
From exarkun at divmod.com  Mon Feb 26 06:16:05 2007
From: exarkun at divmod.com (Jean-Paul Calderone)
Date: Mon Feb 26 06:16:07 2007
Subject: [Twisted-web] Reg adding etag and modified arguments to twisted
	feedparser
In-Reply-To: <c1870d60702252320r34639386x2ad24a26ffc7fb82@mail.gmail.com>
Message-ID: <20070226121605.25807.1255303783.divmod.quotient.32235@ohm>

On Sun, 25 Feb 2007 23:20:48 -0800, mobiledreamers@gmail.com wrote:
>helo
>I m looking for the twisted rss aggregator with etags
>I m unable to find the client.getPageCached
>
>as this page doesnt exist
>
>http://www.twistedmatrix.com/users/roundup.twistd/twisted/issue612
>How many concurrent connections can the rss aggregator hav max
>

http://twistedmatrix.com/trac/ticket/612

Jean-Paul

From gustavo at grahal.net  Tue Feb 27 08:53:59 2007
From: gustavo at grahal.net (Gustavo Rahal)
Date: Tue Feb 27 08:54:02 2007
Subject: [Twisted-web] https support for proxy server
Message-ID: <8a6b32ea0702270653k68cf1d4ete30fc1ef3891bd92@mail.gmail.com>

Hi


I would like to know it's possible or simple to add https support to
twistes.web proxy server.


Thanks
Gustavo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: http://twistedmatrix.com/pipermail/twisted-web/attachments/20070227/89d01cdb/attachment.htm
From tfif at hotmail.com  Wed Feb 28 21:52:19 2007
From: tfif at hotmail.com (Steve doh)
Date: Wed Feb 28 21:52:23 2007
Subject: [Twisted-web] Setting server.Site.protocol stops the site factory
	resource class from renderin
Message-ID: <BAY118-F37A99A77D6EF313375739D2800@phx.gbl>

I have the code below that works fine. If I uncomment the 3rd to last line 
so that the site.protocol uses the ServerProtocol class, then the 
render_GET() method does not get called and the browser waits for a 
response. I understand why this is happening but don't know how to fix it. I 
need to override the connectionMade() method for the site factory inorder to 
verify the connection. Can someone explain how I override connectionMade() 
correctly? Any help appreciated. Cheers Steve

import os, sys
from twisted.web import http, static, server, resource
from twisted.internet.protocol import Protocol
from twisted.internet import reactor

class Simple(resource.Resource):
    def render_GET(self, request):
        sess = request.getSession()
        request.write("<html>")
        request.write("Hi there")
        request.write("</html>")
        request.finish()
        return server.NOT_DONE_YET

class ServerProtocol(Protocol):
    def connectionMade(self):
        print "[connectionMade] entering function....."

os.chdir('D:\\web')

root = Simple()
root.putChild('index.html', Simple())

site = server.Site(root)
#site.protocol = ServerProtocol
reactor.listenTCP(80, site)
reactor.run()

_________________________________________________________________
Shop ‘til you drop at XtraMSN Shopping http://shopping.xtramsn.co.nz/home/


