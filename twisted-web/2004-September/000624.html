<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Macros in Nevow
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Macros%20in%20Nevow&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000642.html">
   <LINK REL="Next"  HREF="000625.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Macros in Nevow</H1>
    <B>Donovan Preston</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Macros%20in%20Nevow&In-Reply-To="
       TITLE="[Twisted-web] Macros in Nevow">dp at ulaluma.com
       </A><BR>
    <I>Wed Sep  8 22:29:19 MDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000642.html">[Twisted-web] url.URL.fromRequest gives unexpected behaviour
</A></li>
        <LI>Next message: <A HREF="000625.html">[Twisted-web] Can't subclass when docFactory is a loaders.stan
	instance.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#624">[ date ]</a>
              <a href="thread.html#624">[ thread ]</a>
              <a href="subject.html#624">[ subject ]</a>
              <a href="author.html#624">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Implementing compile-time macros has always been on my list of things 
to do in Nevow, but so far I haven't needed it so I haven't bothered 
trying to do it. Now that nevow is getting more finished and there are 
fewer pressing issues for me to work on, I thought I'd give it a shot. 
It turned out to be pretty easy:

 &gt;&gt;&gt; from nevow import flat, tags
 &gt;&gt;&gt; flat.precompile(tags.html[ tags.div(macro=lambda c: 
c.tag.children*5)[ &quot;Child &quot; ]])
['&lt;html&gt;Child Child Child Child Child &lt;/html&gt;']

I'm not yet sure exactly how macro directives would be handled -- I 
think there would have to be an explicit type check against the type of 
toBeRenderedBy, followed by a ctx.locate(IMacroFactory).macro(name). 
This is different than how the render and data directives are simply 
adapters registered against the directive type, but I think it is ok.

Another thing to consider would be parameterized macros similar to the 
parameterized renderers and data directives we can use now. However 
since the macro executes immediately the parameters could probably be 
passed directly to the macro method:

&lt;html&gt;&lt;div nevow:macro=&quot;foo bar,baz&quot; /&gt;&lt;/html&gt;

def macro_foo(self, ctx, bar, baz):
	return bar, baz

(Which would result in:

&lt;html&gt;barbaz&lt;/html&gt;)

Comments, suggestions, heckles?

dp

Index: nevow/flat/flatstan.py
===================================================================
--- nevow/flat/flatstan.py      (revision 587)
+++ nevow/flat/flatstan.py      (working copy)
@@ -40,10 +40,17 @@

      if visible and context.isAttrib:
          raise RuntimeError, &quot;Tried to render tag '%s' in an tag 
attribute context.&quot; % (original.tagName)
-
+
+    if context.precompile and original.macro:
+        toBeRenderedBy = original.macro
+        original.macro = Unset
+        newContext = context.with(original)
+        yield serialize(toBeRenderedBy(newContext), newContext)
+        return
+
      ## TODO: Do we really need to bypass precompiling for *all* 
specials?
      ## Perhaps just render?
-    if context.precompile and (original._specials or 
original.slotData):
+    if context.precompile and ([x for x in original._specials.values() 
if x is not None and x is not Unset] or original.slotData):
          ## The tags inside this one get a &quot;fresh&quot; parent chain, because
          ## when the context yielded here is serialized, the parent
          ## chain gets reconnected to the actual parents at that
Index: nevow/stan.py
===================================================================
--- nevow/stan.py       (revision 582)
+++ nevow/stan.py       (working copy)
@@ -77,7 +77,7 @@
      which make representing trees of XML natural using pure python
      syntax. See the docstrings for these methods for more details.
      &quot;&quot;&quot;
-    specials = ['data', 'render', 'remember', 'pattern', 'key']
+    specials = ['data', 'render', 'remember', 'pattern', 'key', 
'macro']

      slotData = None
      def __init__(self, tag, attributes=None, children=None, 
specials=None):
@@ -108,9 +108,9 @@
          table(width=&quot;100%&quot;, height=&quot;50%&quot;, border=&quot;1&quot;)

          Attributes may be 'invisible' tag instances (so that
-        a(href=invisible(data=&quot;foo&quot;, render=myhrefrenderer) works),
+        a(href=invisible(data=&quot;foo&quot;, render=myhrefrenderer)) works),
          strings, functions, or any other object which has a registered
-        ISerializable adapter.
+        flattener.

          A few magic attributes have values other than these, as they
          are not serialized for output but rather have special purposes
@@ -151,7 +151,7 @@
          &quot;&quot;&quot;Add children to this tag. Multiple children may be added by
          passing a tuple or a list. Children may be other tag instances,
          strings, functions, or any other object which has a registered
-        ISerializable adapter.
+        flattener.

          This is implemented using __getitem__ because it then allows
          the natural syntax:


</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000642.html">[Twisted-web] url.URL.fromRequest gives unexpected behaviour
</A></li>
	<LI>Next message: <A HREF="000625.html">[Twisted-web] Can't subclass when docFactory is a loaders.stan
	instance.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#624">[ date ]</a>
              <a href="thread.html#624">[ thread ]</a>
              <a href="subject.html#624">[ subject ]</a>
              <a href="author.html#624">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
