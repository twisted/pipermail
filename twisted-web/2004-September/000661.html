<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Re: [Web-SIG] WSGI woes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20%5BWeb-SIG%5D%20WSGI%20woes&In-Reply-To=15672B46-07F3-11D9-AC9C-000A95A50FB2%40fuhm.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000659.html">
   <LINK REL="Next"  HREF="000651.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Re: [Web-SIG] WSGI woes</H1>
    <B>Phillip J. Eby</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20%5BWeb-SIG%5D%20WSGI%20woes&In-Reply-To=15672B46-07F3-11D9-AC9C-000A95A50FB2%40fuhm.net"
       TITLE="[Twisted-web] Re: [Web-SIG] WSGI woes">pje at telecommunity.com
       </A><BR>
    <I>Thu Sep 16 10:18:26 MDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000659.html">[Twisted-web] Re: [Web-SIG] WSGI woes
</A></li>
        <LI>Next message: <A HREF="000651.html">[Twisted-web] Adding data to the request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#661">[ date ]</a>
              <a href="thread.html#661">[ thread ]</a>
              <a href="subject.html#661">[ subject ]</a>
              <a href="author.html#661">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>At 11:14 AM 9/16/04 -0400, James Y Knight wrote:
&gt;<i>On Sep 16, 2004, at 2:37 AM, Phillip J. Eby wrote:
</I>&gt;&gt;<i>Reading the rest of your post, I see that you are actually addressing the 
</I>&gt;&gt;<i>issue of asynchronous *applications*, and I have only been addressing 
</I>&gt;&gt;<i>asynchronous *servers* in the spec to date.  (Technically &quot;half-async&quot; 
</I>&gt;&gt;<i>servers, since to be properly portable, a WSGI server *must* support 
</I>&gt;&gt;<i>synchronous applications, and therefore an async WSGI server must have a 
</I>&gt;&gt;<i>thread pool for running applications, even if it contains only one thread.)
</I>&gt;<i>
</I>&gt;<i> From the point of view of Twisted as the server, running a WSGI 
</I>&gt;<i> application, the big question is:
</I>&gt;<i>Can you (as a host server) assume WSGI applications will run non-blocking?
</I>&gt;<i>
</I>&gt;<i>The answer is clearly No and I don't imagine that would change.
</I>
Right, because the ability to wrap existing applications is a must, and 
most existing applications are synchronous.


&gt;<i>  (well, right now it's currently not even possible to write a 
</I>&gt;<i> non-blocking WSGI application, but even if it were..)
</I>
That depends on what you define as &quot;non-blocking&quot;.  :)


&gt;<i>The only sensible thing is to assume a WSGI app will block for some 
</I>&gt;<i>arbitrarily long amount of time. Therefore, the only solution is to spawn 
</I>&gt;<i>threads for simultaneous WSGI applications.
</I>
Right; this has been in the discussions of WSGI since day one, last 
December.  The assumption is that async servers would have to use a thread 
pool (e.g. via reactor.deferToThread) to run WSGI applications.  Since the 
point was to allow non-Twisted applications and frameworks (e.g. Zope) to 
run under Twisted or any other web server, this was the only possible approach.


&gt;<i>So, basically, I concur: WSGI is implementable for async servers, but only 
</I>&gt;<i>to implement blocking applications.
</I>
If by &quot;blocking&quot; you mean, you can't absolutely guarantee that no operation 
will tie up the current thread, then yes.  If you mean &quot;tie up the current 
thread for the entire request&quot;, then no, since it's possible to pause the 
output with a few minor changes to the spec.


&gt;&gt;<i>However, I'm not certain that it's actually possible to support 
</I>&gt;&gt;<i>*portable* asynchronous  applications under WSGI, since such asynchrony 
</I>&gt;&gt;<i>requires additional support such as an event loop service.
</I>&gt;&gt;<i>As a practical matter, asynchronous applications today require a toolset 
</I>&gt;&gt;<i>such as Twisted or peak.events in addition to the web server, and I don't 
</I>&gt;&gt;<i>really know of a way to make such applications portable across web 
</I>&gt;&gt;<i>servers, since the web server might use a different toolset that insists 
</I>&gt;&gt;<i>on having its own event loop.  Or it might be like mod_python or CGI, and 
</I>&gt;&gt;<i>not really have any meaningful way to create an event loop: it could be 
</I>&gt;&gt;<i>utterly synchronous in nature and impossible to make otherwise.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>Thus, as a practical matter, applications that make use of asynchronous 
</I>&gt;&gt;<i>I/O *may* be effectively outside WSGI's scope, if they have no real 
</I>&gt;&gt;<i>chance of portability.  As I once said on the Web-SIG, the idea of WSGI 
</I>&gt;&gt;<i>is more aimed at allowing non-Twisted apps to run under a Twisted web 
</I>&gt;&gt;<i>server, than at allowing Twisted applications to run under other web 
</I>&gt;&gt;<i>servers!  The latter, obviously, is much more ambitious than the former.
</I>&gt;<i>
</I>&gt;<i>Yes, there is no way that I can see to make WSGI suitable for writing 
</I>&gt;<i>async applications without significant work.  There are two obvious 
</I>&gt;<i>issues: the input stream only provides blocking read(), not a selectable 
</I>&gt;<i>fd, and there is no way to pause output.
</I>
The sleep/wake extensions I proposed would allow pausing output.  I hadn't 
thought about the input stream issue.


&gt;<i>If the write callback was extended into a write/finish callback, it 
</I>&gt;<i>wouldn't completely fix the second problem. Twisted would have to call the 
</I>&gt;<i>write() callback from its reactor loop (having no access to the original 
</I>&gt;<i>request thread). Especially if there is any middleware, the *write* might 
</I>&gt;<i>block! There's also the question of whether the write() and finish() 
</I>&gt;<i>methods are threadsafe or not -- would it even be safe to call from a 
</I>&gt;<i>separate thread from that in which the request was started?
</I>
That's one reason why sleep/wake over iterables is a better solution than 
write/finish for the &quot;pausing output&quot; issue.


&gt;<i>Writing an async application *is* an interesting question, because then, 
</I>&gt;<i>possibly, you could take the framework half of twisted web and run it as a 
</I>&gt;<i>WSGI application. However, if this question is punted by WSGI (as I think 
</I>&gt;<i>is likely a good idea..), twisted web framework can continue to work with 
</I>&gt;<i>other servers by using HTTP proxying -- which is a _perfectly good_ 
</I>&gt;<i>solution, and something major webservers already support. HTTP is a pretty 
</I>&gt;<i>good protocol for talking between webservers and webapps.
</I>&gt;<i>
</I>&gt;<i>Also, if WSGI becomes really popular on servers that cannot do HTTP 
</I>&gt;<i>proxying natively, twisted could provide a WSGI &quot;application&quot; that simply 
</I>&gt;<i>proxies the requests over a socket to a separate twisted web server 
</I>&gt;<i>process. This would provide essentially no advantage to HTTP proxying 
</I>&gt;<i>where that works, however.
</I>
No *technical* advantage, true, but if WSGI becomes a popular buzzword, the 
mere existence of such a solution allows you to boast that Twisted Web can 
be used with any WSGI-compliant server, as well as any server that supports 
HTTP proxying, which makes it sound like you have twice as many deployment 
options from a &quot;marketecture&quot; perspective.  :)


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000659.html">[Twisted-web] Re: [Web-SIG] WSGI woes
</A></li>
	<LI>Next message: <A HREF="000651.html">[Twisted-web] Adding data to the request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#661">[ date ]</a>
              <a href="thread.html#661">[ thread ]</a>
              <a href="subject.html#661">[ subject ]</a>
              <a href="author.html#661">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
