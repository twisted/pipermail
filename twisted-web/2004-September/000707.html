<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Re: Serving files from many web-servers thru one
	central web-server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20Serving%20files%20from%20many%20web-servers%20thru%20one%0A%09central%20web-server&In-Reply-To=ulletfuhc.fsf%40fitlinxx.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000706.html">
   <LINK REL="Next"  HREF="000709.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Re: Serving files from many web-servers thru one
	central web-server</H1>
    <B>Thomas Weholt</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20Serving%20files%20from%20many%20web-servers%20thru%20one%0A%09central%20web-server&In-Reply-To=ulletfuhc.fsf%40fitlinxx.com"
       TITLE="[Twisted-web] Re: Serving files from many web-servers thru one
	central web-server">thomas.weholt at gmail.com
       </A><BR>
    <I>Wed Sep 29 01:10:38 MDT 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000706.html">[Twisted-web] Re: Serving files from many web-servers thru one
	central web-server
</A></li>
        <LI>Next message: <A HREF="000709.html">[Twisted-web] Re: Serving files from many web-servers thru one
	central web-server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#707">[ date ]</a>
              <a href="thread.html#707">[ thread ]</a>
              <a href="subject.html#707">[ subject ]</a>
              <a href="author.html#707">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sweet!!! I'm going to try it when I get off work. In my original
design and implemented prototype the slave nodes on the subnet answers
a UDP broadcast from the main server, which in turns keeps a list of
slave-nodes on the local subnet, connecting to them and communicating
with them using a mix of UDP and XMLRPC. Making a connection to the
local slavenodes or adding them to the main server will be a bit more
tricky using the code you supplied, but hey !!! If I can re-implement
my idea using something like this it would be so much better.

Thanks again!! :-)

Best regards,
Thomas


On 29 Sep 2004 02:40:47 -0400, David Bolen &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">db3l at fitlinxx.com</A>&gt; wrote:
&gt;<i> Thomas Weholt &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">thomas.weholt at gmail.com</A>&gt; writes:
</I>&gt;<i> 
</I>&gt;<i> &gt; Oh, darn!! Forgot all about this when I started my project. I've read
</I>&gt;<i> &gt; thru most of the docs I've  found so far, but I'm still somewhat
</I>&gt;<i> &gt; clueless. Can anybody provide a simple example of how to do this,
</I>&gt;<i> &gt; preferrably without using the examples in
</I>&gt;<i> &gt; <A HREF="http://twistedmatrix.com/documents/current/howto/using-twistedweb#auto19.">http://twistedmatrix.com/documents/current/howto/using-twistedweb#auto19.</A>
</I>&gt;<i> &gt; I'm hooking a xmlrpc-handler and a UDP listener into it as well and
</I>&gt;<i> &gt; find the good ol'
</I>&gt;<i> (...)
</I>&gt;<i> 
</I>&gt;<i> Well, I experimented tonight and here's a quick example of some
</I>&gt;<i> situations.  In re-reading your original post, I realized it wasn't
</I>&gt;<i> clear if your &quot;reads data from several subnet servers&quot; comment
</I>&gt;<i> referred to wanting to access web resources on the internal servers,
</I>&gt;<i> or just some other service you needed data from.  If the latter, then
</I>&gt;<i> you can use your own PB session that can be richer in interface than a
</I>&gt;<i> web resource if you wanted, so I gave a simple example of that too.
</I>&gt;<i> 
</I>&gt;<i> This example just runs both the simulated main server and subset
</I>&gt;<i> server objects within the same process over a loopback connection, but
</I>&gt;<i> should work identically over any other link.
</I>&gt;<i> 
</I>&gt;<i> There is a main and child resource on the server side, and the same on
</I>&gt;<i> the internal/subnet side, tied into a URL on the server side by using
</I>&gt;<i> the ResourcePublisher/ResourceSubscription.  An additional server side
</I>&gt;<i> resource turns into its own pure PB call to a remote server object.
</I>&gt;<i> Once running you can access the following URLs:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://localhost:8000">http://localhost:8000</A>                    ExternalRoot
</I>&gt;<i> <A HREF="http://localhost:8000/child">http://localhost:8000/child</A>              ExternalChild
</I>&gt;<i> <A HREF="http://localhost:8000/data">http://localhost:8000/data</A>               InternalData.remote_getData()
</I>&gt;<i> <A HREF="http://localhost:8000/internal">http://localhost:8000/internal</A>           InternalRoot
</I>&gt;<i> <A HREF="http://localhost:8000/internal/child">http://localhost:8000/internal/child</A>     InternalChild
</I>&gt;<i> 
</I>&gt;<i> In the InternalData case, I'm making a new PB session for each
</I>&gt;<i> rendering request.  Presumably you'd want to structure things to
</I>&gt;<i> maintain a persistent connection only reconnecting when necessary
</I>&gt;<i> (which, BTW, is basically what ResourceSubscription does).
</I>&gt;<i> 
</I>&gt;<i> It all seems to work as expected... it's simplistic but hopefully
</I>&gt;<i> it'll point you in the right direction.  Shouldn't be any problem to
</I>&gt;<i> tie in additional protocols (such as XMLRPC/UDP) into either the main
</I>&gt;<i> server or subnet server processes.
</I>&gt;<i> 
</I>&gt;<i> -- David
</I>&gt;<i> 
</I>&gt;<i>          - - - - - - - - - - - - - - - - - - - - - - - - -
</I>&gt;<i> 
</I>&gt;<i> import sys
</I>&gt;<i> 
</I>&gt;<i> from twisted.python import log
</I>&gt;<i> from twisted.internet import reactor
</I>&gt;<i> from twisted.spread import pb
</I>&gt;<i> from twisted.web import server, resource, distrib
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # An internal PB server object on the internal subnet server, with simple
</I>&gt;<i> # direct access (no authentication) via a root object.
</I>&gt;<i> 
</I>&gt;<i> class InternalData(pb.Root):
</I>&gt;<i> 
</I>&gt;<i>    def remote_getData(self):
</I>&gt;<i>        # This could be its own deferrable operation
</I>&gt;<i>        return 'Internal data'
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Resources on the internal subnet servers
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> class InternalChild(resource.Resource):
</I>&gt;<i>    &quot;&quot;&quot;A child resource rendered on the internal server&quot;&quot;&quot;
</I>&gt;<i> 
</I>&gt;<i>    def render(self, request):
</I>&gt;<i>        return '&lt;html&gt;&lt;body&gt;Internal Child&lt;/body&gt;&lt;/html&gt;'
</I>&gt;<i> 
</I>&gt;<i> class InternalRoot(resource.Resource):
</I>&gt;<i>    &quot;&quot;&quot;The root of the tree rendered on the internal server&quot;&quot;&quot;
</I>&gt;<i> 
</I>&gt;<i>    def getChild(self, path, request):
</I>&gt;<i>        # Support direct rendering (no trailing &quot;/&quot; on request)
</I>&gt;<i>        if path == '':
</I>&gt;<i>            return self
</I>&gt;<i>        else:
</I>&gt;<i>            return resource.Resource.getChild(self, path, request)
</I>&gt;<i> 
</I>&gt;<i>    def render(self, request):
</I>&gt;<i>        return '&lt;html&gt;&lt;body&gt;Internal Root&lt;/body&gt;&lt;/html&gt;'
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Resources on the primary web server
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> class MainData(resource.Resource):
</I>&gt;<i>    &quot;&quot;&quot;A child resource that renders a data call to the internal server&quot;&quot;&quot;
</I>&gt;<i> 
</I>&gt;<i>    def __init__(self, host, port):
</I>&gt;<i>        resource.Resource.__init__(self)
</I>&gt;<i>        self.host = host
</I>&gt;<i>        self.port = port
</I>&gt;<i> 
</I>&gt;<i>    def render(self, request):
</I>&gt;<i>        &quot;&quot;&quot;Make a request to the remote root object, and use that result
</I>&gt;<i>        as the result of our rendering&quot;&quot;&quot;
</I>&gt;<i> 
</I>&gt;<i>        def failure(value):
</I>&gt;<i>            request.write('&lt;html&gt;&lt;body&gt;'
</I>&gt;<i>                          'Unable to access data:&lt;br&gt;%s'
</I>&gt;<i>                          '&lt;/body&gt;&lt;/html&gt;' % value)
</I>&gt;<i> 
</I>&gt;<i>        def success(value):
</I>&gt;<i>            request.write('&lt;html&gt;&lt;body&gt;%s&lt;/body&gt;&lt;/html&gt;' % value)
</I>&gt;<i> 
</I>&gt;<i>        # Right now we make a new connection to the internal host for
</I>&gt;<i>        # each rendering request (pretty darn inefficient!)
</I>&gt;<i>        factory = pb.PBClientFactory()
</I>&gt;<i>        reactor.connectTCP(self.host, self.port, factory)
</I>&gt;<i> 
</I>&gt;<i>        # Obtain a reference to the remote object, call the getData method
</I>&gt;<i>        # and then disconnect.
</I>&gt;<i>        root = factory.getRootObject()
</I>&gt;<i>        root.addCallback(lambda root:
</I>&gt;<i>                         root.callRemote('getData').addCallback(success))
</I>&gt;<i>        root.addErrback(failure)
</I>&gt;<i>        root.addCallback(lambda _: request.finish())
</I>&gt;<i>        root.addCallback(lambda _: factory.disconnect())
</I>&gt;<i>        return server.NOT_DONE_YET
</I>&gt;<i> 
</I>&gt;<i> class MainChild(resource.Resource):
</I>&gt;<i>    &quot;&quot;&quot;A child resource rendered directly on the main server&quot;&quot;&quot;
</I>&gt;<i> 
</I>&gt;<i>    def render(self, request):
</I>&gt;<i>        return '&lt;html&gt;&lt;body&gt;Main Server Child&lt;/body&gt;&lt;/html&gt;'
</I>&gt;<i> 
</I>&gt;<i> class MainRoot(resource.Resource):
</I>&gt;<i>    &quot;&quot;&quot;The primary root resource on the main server&quot;&quot;&quot;
</I>&gt;<i> 
</I>&gt;<i>    def getChild(self, path, request):
</I>&gt;<i>        # Support direct rendering (no trailing &quot;/&quot; on request)
</I>&gt;<i>        if path == '':
</I>&gt;<i>            return self
</I>&gt;<i>        else:
</I>&gt;<i>            return resource.Resource.getChild(self, path, request)
</I>&gt;<i> 
</I>&gt;<i>    def render(self, request):
</I>&gt;<i>        return '&lt;html&gt;&lt;body&gt;Main Server Root&lt;/body&gt;&lt;/html&gt;'
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Simulate main and subnet servers.  The main server will listen on port
</I>&gt;<i> # 8000 and the subnet server will listen (for PB connections) on port 8001.
</I>&gt;<i> # Additionally the subnet server will provide the InternalData object
</I>&gt;<i> # on port 8002.
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> if __name__ == &quot;__main__&quot;:
</I>&gt;<i> 
</I>&gt;<i>    #
</I>&gt;<i>    # Build up a subnet server &quot;site&quot;:
</I>&gt;<i>    #     /         InternalRoot
</I>&gt;<i>    #     /child    InternalChild
</I>&gt;<i>    #
</I>&gt;<i>    iroot = InternalRoot()
</I>&gt;<i>    iroot.putChild('child', InternalChild())
</I>&gt;<i>    isite = server.Site(iroot)
</I>&gt;<i> 
</I>&gt;<i>    #
</I>&gt;<i>    # Build up the main server &quot;site&quot;:
</I>&gt;<i>    #     /          MainRoot
</I>&gt;<i>    #     /child     MainChild
</I>&gt;<i>    #     /data      Render result of call to InternalData's retrieveData
</I>&gt;<i>    #     /internal  Request to / on subnet server
</I>&gt;<i>    #
</I>&gt;<i>    root = MainRoot()
</I>&gt;<i>    root.putChild('child', MainChild())
</I>&gt;<i>    root.putChild('data', MainData('localhost', 8002))
</I>&gt;<i>    root.putChild('internal', distrib.ResourceSubscription('localhost',8001))
</I>&gt;<i>    site = server.Site(root)
</I>&gt;<i> 
</I>&gt;<i>    #
</I>&gt;<i>    # Now start both servers listening.  Note that if these were really
</I>&gt;<i>    # running on separate machines, the internal server could do a listenTCP
</I>&gt;<i>    # for isite on 8000 to support normal web lookups, while also supporting
</I>&gt;<i>    # port 8001 for the PB proxied lookups.
</I>&gt;<i>    #
</I>&gt;<i>    reactor.listenTCP(8000, site)
</I>&gt;<i>    reactor.listenTCP(8001,
</I>&gt;<i>                      pb.PBServerFactory(distrib.ResourcePublisher(isite)))
</I>&gt;<i>    reactor.listenTCP(8002,pb.PBServerFactory(InternalData()))
</I>&gt;<i> 
</I>&gt;<i>    log.startLogging(sys.stdout)
</I>&gt;<i>    reactor.run()
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i> 
</I>


-- 
Mvh/Best regards,
Thomas Weholt
<A HREF="http://www.weholt.org">http://www.weholt.org</A>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000706.html">[Twisted-web] Re: Serving files from many web-servers thru one
	central web-server
</A></li>
	<LI>Next message: <A HREF="000709.html">[Twisted-web] Re: Serving files from many web-servers thru one
	central web-server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#707">[ date ]</a>
              <a href="thread.html#707">[ thread ]</a>
              <a href="subject.html#707">[ subject ]</a>
              <a href="author.html#707">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
