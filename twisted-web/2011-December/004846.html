<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] twisted.web.template output encoding
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20twisted.web.template%20output%20encoding&In-Reply-To=20111126165210.2308.1108209216.divmod.xquotient.319%40localhost.localdomain">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004845.html">
   <LINK REL="Next"  HREF="004847.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] twisted.web.template output encoding</H1>
    <B>Glyph</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20twisted.web.template%20output%20encoding&In-Reply-To=20111126165210.2308.1108209216.divmod.xquotient.319%40localhost.localdomain"
       TITLE="[Twisted-web] twisted.web.template output encoding">glyph at twistedmatrix.com
       </A><BR>
    <I>Mon Dec  5 15:19:24 EST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004845.html">[Twisted-web] Twisted web client digest authentication?
</A></li>
        <LI>Next message: <A HREF="004847.html">[Twisted-web] twisted.web.template output encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4846">[ date ]</a>
              <a href="thread.html#4846">[ thread ]</a>
              <a href="subject.html#4846">[ subject ]</a>
              <a href="author.html#4846">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry it took me so long to get to this.  Hopefully it's still relevant ;).

On Nov 26, 2011, at 11:52 AM, <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">exarkun at twistedmatrix.com</A> wrote:

&gt;<i> Apart from various issues relating to the lack of patterns in twisted.web.template,
</I>
I had some trepidation about marking &lt;<A HREF="http://twistedmatrix.com/trac/ticket/5040">http://twistedmatrix.com/trac/ticket/5040</A>&gt; as &quot;closed&quot; :).  What kind of issues came up with patterns?  Anything you feel needs fixing?

&gt;<i> the main difficulty is in handling non-ascii contents in the traceback.  Apart from any unicode that may show up in the source code being rendered (or, perhaps, eventually, the values of variables to be rendered - though for now I do not plan to implement this) the no-break space characters which are necessary to get traceback lines indented properly mean that there is always some non-ascii to include in the output.
</I>
Looking at the actual output now, these &amp;nbsp; characters strike me as an accident of how browsers collapse different types of whitespace.  They could be replaced with a &lt;span style=&quot;width: 4em;&quot; /&gt; to avoid this problem for now, which is probably more expressive.

&gt;<i> twisted.web.template encodes its output using UTF-8, and this is not customizable.  Thus, using twisted.web.template, formatFailure's result will be a str containing UTF-8 encoded text.  Previously the result was a str containing only ASCII encoded text, with no-break space represented as `&amp;nbsp;&#180;.  Consequently, callers of `formatFailure&#180; will probably mishandle the result - the caller in `twisted.web.server&#180; does, at least, including the bytes in a page with a content type of &quot;text/html&quot;.
</I>&gt;<i> 
</I>&gt;<i> The solutions that come to mind are all about removing this incompatible change and making it so `formatFailure&#180; can continue to return a str with ASCII-encoded text.
</I>&gt;<i> 
</I>&gt;<i> One solution is to add support for named entities or numeric character references to twisted.web.template.  Very likely this is a good idea regardless (Nevow supported these).
</I>
I think that this is probably a necessary feature regardless, eventually.  Did you end up filing a ticket for it?

&gt;<i> Another solution is to use a different encoding in `twisted.web.template&#180; - ASCII, with xmlcharrefreplace as the error handler.  This is tempting since it avoids an obtrusive non-ASCII support API (the way Nevow supports these is via `nevow.entities&#180;, which must be used rather than normal Python unicode objects).
</I>
I like this idea, because it's so hard to get wrong even if you have other problems (missing charset, buggy proxies, overly aggressive encoding detection, etc).  We can still say it's UTF-8 but it will work anywhere ASCII will work :).

&gt;<i> Perhaps another question is whether the encoding used by `twisted.web.template&#180; should be a parameter.  A related question raised might be whether `twisted.web.template&#180; should encoded to bytes at all, or delegate the responsibility for that to code closer to a socket.
</I>
Personal experience looking at profiles of applications which serialize a lot of XML suggests to me that encoding and decoding text in Python is a huge chunk of CPU work and memory footprint; keeping the encoding in t.w.t provides an opportunity for a potentially important optimization which might not be possible if it were done closer to the socket.

For example, if we're generating a long table that generates 10MB of HTML, if this is encoded incrementally (even foregoing any smarter optimizations, like caching the encoded form of strings) then there's a small working set of encoded data which can be collected as the template renders, and by the time the final string is emitted by cStringIO.getvalue() or what have you, you're using 20-ish megabytes of heap to store your UTF-8 bytes (10 in the StringIO and 10 in the str).  If you build this as a unicode string instead, you'll end up using 50MB; 40MB for your unicode string, 10MB for the decoded bytes.  Part of this is just an implementation issue, but even if Python gets a smarter unicode representation, you still need more space, because you need to store the encoded and decoded representations concurrently.

It might be a while until I get around to implementing something smart in this area, but I'd prefer we have an interface that makes such optimizations possible without breaking compatibility.

&gt;<i> As a work-around in `formatFailure&#180; I can decode the output of the flattener using UTF-8 and then re-encode it to avoid non-ASCII, but it seems like this should be solved in `twisted.web.template&#180; rather than over and over again in application code.
</I>
If this does end up happening in formatFailure or anywhere else, please (whoever does it) make sure to file a ticket to fix it; this should never be more than a temporary workaround.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20111205/8359c857/attachment.htm">http://twistedmatrix.com/pipermail/twisted-web/attachments/20111205/8359c857/attachment.htm</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004845.html">[Twisted-web] Twisted web client digest authentication?
</A></li>
	<LI>Next message: <A HREF="004847.html">[Twisted-web] twisted.web.template output encoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4846">[ date ]</a>
              <a href="thread.html#4846">[ thread ]</a>
              <a href="subject.html#4846">[ subject ]</a>
              <a href="author.html#4846">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
