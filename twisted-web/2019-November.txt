From natester at gmail.com  Tue Nov  5 13:20:59 2019
From: natester at gmail.com (Nathaniel Haggard)
Date: Tue, 5 Nov 2019 13:20:59 -0700
Subject: [Twisted-web] getChild in python3
Message-ID: <CAAbnaHb_vXXTmRaye6VQr_3tR4d5XZZRk00ms8nOyHh034Arsw@mail.gmail.com>

# This code doesn't call getChild in python3, but it does in python2
(python2 throws AttributeError, but python3 doesn't) with "curl
http://127.0.0.1:8803/bug/a" and Twisted==19.7.0 with python3.5.2:

from twisted.application import internet, service, strports
from twisted.web.resource import Resource
from twisted.web.server import Site
from twisted.internet import reactor
from twisted.python import log


from twisted.web.resource import Resource



class R(Resource):
    allowedMethods=('GET',)
    def getChild(self, name, request):
        pass


r = Resource()
r.putChild('bug', R())

application = service.Application('web')
site = Site(r)
sc = service.IServiceCollection(application)
i = strports.service("tcp:8803", site)
i.setServiceParent(sc)
-------------- next part --------------
An HTML attachment was scrubbed...
URL: </pipermail/twisted-web/attachments/20191105/5629d4c1/attachment.html>

From glyph at twistedmatrix.com  Tue Nov  5 15:27:33 2019
From: glyph at twistedmatrix.com (Glyph)
Date: Tue, 5 Nov 2019 14:27:33 -0800
Subject: [Twisted-web] getChild in python3
In-Reply-To: <CAAbnaHb_vXXTmRaye6VQr_3tR4d5XZZRk00ms8nOyHh034Arsw@mail.gmail.com>
References: <CAAbnaHb_vXXTmRaye6VQr_3tR4d5XZZRk00ms8nOyHh034Arsw@mail.gmail.com>
Message-ID: <F0ADD5EE-B668-4217-9619-DEC3A844C675@twistedmatrix.com>


> On Nov 5, 2019, at 12:20 PM, Nathaniel Haggard <natester at gmail.com> wrote:
> 
> # This code doesn't call getChild in python3, but it does in python2 (python2 throws AttributeError, but python3 doesn't) with "curl http://127.0.0.1:8803/bug/a <http://127.0.0.1:8803/bug/a>" and Twisted==19.7.0 with python3.5.2:
> 
> from twisted.application import internet, service, strports
> from twisted.web.resource import Resource
> from twisted.web.server import Site
> from twisted.internet import reactor
> from twisted.python import log
> 
> 
> from twisted.web.resource import Resource
> 
> 
> 
> class R(Resource):
>     allowedMethods=('GET',)
>     def getChild(self, name, request):
>         pass
>         
> 
> r = Resource()
> r.putChild('bug', R())

This isn't technically a bug in Twisted, since you're passing a `str` on py3 where it expects a `bytes`; note the "type" annotation right at the end of https://twistedmatrix.com/documents/19.7.0/api/twisted.web.resource.IResource.html#putChild <https://twistedmatrix.com/documents/19.7.0/api/twisted.web.resource.IResource.html#putChild> .

In other words, you meant `r.putChild(b'bug', R())`.

That said, this is certainly not desirable behavior, so maybe we could fix it?  There are probably a couple of gnarly compatibility concerns to think about, but it would be nice if it worked.

-g

> application = service.Application('web')
> site = Site(r)
> sc = service.IServiceCollection(application)
> i = strports.service("tcp:8803", site)
> i.setServiceParent(sc)
> 
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web

-------------- next part --------------
An HTML attachment was scrubbed...
URL: </pipermail/twisted-web/attachments/20191105/f8249c90/attachment.html>

From twm at freecog.net  Tue Nov  5 15:37:52 2019
From: twm at freecog.net (Tom Most)
Date: Tue, 05 Nov 2019 14:37:52 -0800
Subject: [Twisted-web] getChild in python3
In-Reply-To: <CAAbnaHb_vXXTmRaye6VQr_3tR4d5XZZRk00ms8nOyHh034Arsw@mail.gmail.com>
References: <CAAbnaHb_vXXTmRaye6VQr_3tR4d5XZZRk00ms8nOyHh034Arsw@mail.gmail.com>
Message-ID: <1ae0eca5-171f-4f39-9d02-63c0038876bc@www.fastmail.com>

Hi Nathaniel,

The string 'bug' needs to be a bytestring, b'bug'. This is indeed a bug, but Twisted 19.7.0 will at least generate a deprecation warning about it. A future version of Twisted will throw an exception (once the deprecation period has passed).

https://twistedmatrix.com/trac/ticket/9135

---Tom

On Tue, Nov 5, 2019, at 12:20 PM, Nathaniel Haggard wrote:
> # This code doesn't call getChild in python3, but it does in python2 (python2 throws AttributeError, but python3 doesn't) with "curl http://127.0.0.1:8803/bug/a" and Twisted==19.7.0 with python3.5.2:
> 
> from twisted.application import internet, service, strports
> from twisted.web.resource import Resource
> from twisted.web.server import Site
> from twisted.internet import reactor
> from twisted.python import log
> 
> 
> from twisted.web.resource import Resource
> 
> 
> 
> class R(Resource):
>  allowedMethods=('GET',)
>  def getChild(self, name, request):
>  pass
> 
> 
> r = Resource()
> r.putChild('bug', R())
> 
> application = service.Application('web')
> site = Site(r)
> sc = service.IServiceCollection(application)
> i = strports.service("tcp:8803", site)
> i.setServiceParent(sc)
> 
> _______________________________________________
> Twisted-web mailing list
> Twisted-web at twistedmatrix.com
> https://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web
> 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: </pipermail/twisted-web/attachments/20191105/e3aba903/attachment.html>

