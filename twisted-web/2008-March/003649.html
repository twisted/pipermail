<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20streaming%20request%20%28was%3A%20status%20of%20Twisted%20Web%0A%09and%20Web%202%29&In-Reply-To=20080306030952.GD2823%40mcnabbs.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003647.html">
   <LINK REL="Next"  HREF="003654.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20streaming%20request%20%28was%3A%20status%20of%20Twisted%20Web%0A%09and%20Web%202%29&In-Reply-To=20080306030952.GD2823%40mcnabbs.org"
       TITLE="[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)">exarkun at divmod.com
       </A><BR>
    <I>Wed Mar  5 22:30:29 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="003647.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
        <LI>Next message: <A HREF="003654.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3649">[ date ]</a>
              <a href="thread.html#3649">[ thread ]</a>
              <a href="subject.html#3649">[ subject ]</a>
              <a href="author.html#3649">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 5 Mar 2008 20:09:52 -0700, Andrew McNabb &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">amcnabb at mcnabbs.org</A>&gt; wrote:
&gt;<i>On Wed, Mar 05, 2008 at 09:13:44PM -0500, Jean-Paul Calderone wrote:
</I>&gt;&gt;<i> On Wed, 5 Mar 2008 18:52:50 -0700, Andrew McNabb &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">amcnabb at mcnabbs.org</A>&gt; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I've written some code that uses Twisted Web, and it seemed a little
</I>&gt;&gt;&gt;<i> basic.  For example, I had to make some modifications in order to
</I>&gt;&gt;&gt;<i> receive large files in progress instead of waiting until they were done
</I>&gt;&gt;&gt;<i> downloading.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does this code have tests?  Is it compatible with &quot;normal&quot; twisted.web
</I>&gt;&gt;<i> usage?  Can I have the code?
</I>&gt;<i>
</I>&gt;<i>My answer to all three questions is &quot;sort of.&quot;  If you (or others) could
</I>&gt;<i>help me resolve a problem I ran into, I could change all of those to a
</I>&gt;<i>&quot;yes.&quot;
</I>&gt;<i>
</I>&gt;<i>The problem that I ran into is that with streaming requests, I would
</I>&gt;<i>like to be able to call back multiple times.  It makes sense that a
</I>&gt;<i>normal deferred can only be called back once.  I couldn't find anything
</I>&gt;<i>in Twisted that you might call a &quot;multi-deferred&quot; (to make it simple to
</I>&gt;<i>callback multiple times).  It's been a while, so let me see if I
</I>&gt;<i>remember what I tried.
</I>
To clarify, this is about calling into application code in a web server
once each time some new bytes from a request body are received from the
client, right?

&gt;<i>
</I>&gt;<i>My first attempt was to callback with a new deferred as the callback
</I>&gt;<i>value.  Then the callback function could add itself to the new deferred
</I>&gt;<i>and get called again the next time data arrive.  I thought this was a
</I>&gt;<i>clean approach, but it turns out that if you try to call back with a new
</I>&gt;<i>deferred, there's a TypeError.  I couldn't figure out why it didn't like
</I>&gt;<i>this.
</I>
Deferred.callback explicitly checks to see if you're giving it a Deferred
and raises the TypeError.  The idea here is that most of the time, you're
probably doing this by accident, not intentionally.  Clearly it wasn't an
accident in your case.  The way to actually get this behavior is to chain
the Deferreds together.  Instead of a.callback(b), which I assume you was
to send the result of b to the callbacks of a when they became available,
you a.chainDeferred(b), which is really just a way to say

  a.addCallbacks(b.callback, b.errback)

However, I don't think this is generally the approach to take.

&gt;<i>
</I>&gt;<i>My second attempt was to create a new deferred each time data arrived
</I>&gt;<i>and to copy the callback list from the previous deferred.  This worked,
</I>&gt;<i>but it felt dirty, so I got rid of it.
</I>&gt;<i>
</I>&gt;<i>My third and final attempt was to tie the downloader in to my
</I>&gt;<i>application.  Every time data arrive, the downloader sends it to the
</I>&gt;<i>object that needs it.  This isn't a very general solution, but it is
</I>&gt;<i>very short and readable.
</I>
This I actually like, and sounds a bit like what I would implement someday
if I were to implement something.  Of course, it should be general-purpose
so it works for other applications.  The idea I have is to allow resources
to optionally handle these new data-arrived events.  It should be possible
for a resource to signal that it wants data as it is received, perhaps by
declaring that implements a new interface (eg, IStreamingRequestHandler or
something) with a method that is called each time data is received in the
request body.  Resources which don't implement this interface will get the
old behavior of having the request body buffered and delivered all at once,
but resources which want streaming can get it.

Does that make sense?

&gt;<i>
</I>&gt;<i>Anyway, if you know of a better way to deal with this issue, I would be
</I>&gt;<i>happy to modify my code for it.  If you're happy with what I've got, I
</I>&gt;<i>would be happy to email it to you, but I wouldn't recommend adding it to
</I>&gt;<i>Twisted Web until it's more general.
</I>
If the above described approach sounds sensible and you want to take a
crack at it, I'd really appreciate it.  The best thing to do with the
result is attach it to a ticket in the tracker, probably #288

  <A HREF="http://twistedmatrix.com/trac/ticket/288">http://twistedmatrix.com/trac/ticket/288</A>

If not, I'd still like to see the code and make sure the ideas I have will
also satisfy the use-case it represents.

Thanks!

Jean-Paul

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003647.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
	<LI>Next message: <A HREF="003654.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3649">[ date ]</a>
              <a href="thread.html#3649">[ thread ]</a>
              <a href="subject.html#3649">[ subject ]</a>
              <a href="author.html#3649">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
