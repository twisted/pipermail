<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20streaming%20request%20%28was%3A%20status%20of%20Twisted%20Web%0A%09and%20Web%202%29&In-Reply-To=20080306141553.GA2296%40mcnabbs.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003654.html">
   <LINK REL="Next"  HREF="003657.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)</H1>
    <B>Jean-Paul Calderone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20streaming%20request%20%28was%3A%20status%20of%20Twisted%20Web%0A%09and%20Web%202%29&In-Reply-To=20080306141553.GA2296%40mcnabbs.org"
       TITLE="[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)">exarkun at divmod.com
       </A><BR>
    <I>Thu Mar  6 09:51:00 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="003654.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
        <LI>Next message: <A HREF="003657.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3656">[ date ]</a>
              <a href="thread.html#3656">[ thread ]</a>
              <a href="subject.html#3656">[ subject ]</a>
              <a href="author.html#3656">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, 6 Mar 2008 07:15:53 -0700, Andrew McNabb &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">amcnabb at mcnabbs.org</A>&gt; wrote:
&gt;<i>On Wed, Mar 05, 2008 at 10:30:29PM -0500, Jean-Paul Calderone wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To clarify, this is about calling into application code in a web server
</I>&gt;&gt;<i> once each time some new bytes from a request body are received from the
</I>&gt;&gt;<i> client, right?
</I>&gt;<i>
</I>&gt;<i>Exactly.
</I>&gt;<i>
</I>&gt;&gt;<i> Deferred.callback explicitly checks to see if you're giving it a Deferred
</I>&gt;&gt;<i> and raises the TypeError.  The idea here is that most of the time, you're
</I>&gt;&gt;<i> probably doing this by accident, not intentionally.  Clearly it wasn't an
</I>&gt;&gt;<i> accident in your case.
</I>&gt;<i>
</I>&gt;<i>I definitely was not doing it by accident. :)  Is this really a common
</I>&gt;<i>mistake?
</I>
I have absolutely no statistics on the frequency of this error.  I suspect
that it isn't, but I may be wrong.  The check was added years ago, presumably
by someone who thought it was/would be.

&gt;<i>
</I>&gt;&gt;<i> The way to actually get this behavior is to chain the Deferreds
</I>&gt;&gt;<i> together.  Instead of a.callback(b), which I assume you was to send
</I>&gt;&gt;<i> the result of b to the callbacks of a when they became available, you
</I>&gt;&gt;<i> a.chainDeferred(b), which is really just a way to say
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  a.addCallbacks(b.callback, b.errback)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, I don't think this is generally the approach to take.
</I>&gt;<i>
</I>&gt;<i>This actually isn't equivalent to what I was trying to do.  Think of my
</I>&gt;<i>approach this way.  As a user, you call:
</I>&gt;<i>
</I>&gt;<i>d = streaming_download(url)
</I>&gt;<i>
</I>&gt;<i>def got_some_data(value):
</I>&gt;<i>    new_data, d = value
</I>&gt;<i>    # add callback for the next time data get sent:
</I>&gt;<i>    d.addCallback(got_some_data)
</I>&gt;<i>    # do stuff with new_data
</I>&gt;<i>
</I>&gt;<i>d.addCallback(got_some_data)
</I>&gt;<i>
</I>
Ah.  So the case that doesn't work is when the result of the Deferred is
really a new, perhaps totally unrelated, Deferred that someone wants.  I
can see how that would be useful.  I think I've actually encountered the
case before myself.  It might be worth complaining about this misfeature
on the other list (twisted-python).

&gt;<i>
</I>&gt;&gt;&gt;<i> My second attempt was to create a new deferred each time data arrived
</I>&gt;&gt;&gt;<i> and to copy the callback list from the previous deferred.  This worked,
</I>&gt;&gt;&gt;<i> but it felt dirty, so I got rid of it.
</I>&gt;<i>
</I>&gt;<i>Actually, after looking at my code again, it turns out that what I am
</I>&gt;<i>doing is actually a mix of attempt 2 and attempt 3.  This is the code
</I>&gt;<i>that copies the deferred:
</I>&gt;<i>
</I>&gt;<i>    newdef = defer.Deferred()
</I>&gt;<i>    newdef.callbacks = list(self.deferred.callbacks)
</I>&gt;<i>    newdef.callback(False)
</I>&gt;<i>
</I>
*cries*

You're not supposed to read or write the `callbacks&#180; attribute like that.

&gt;<i>
</I>&gt;&gt;&gt;<i> My third and final attempt was to tie the downloader in to my
</I>&gt;&gt;&gt;<i> application.  Every time data arrive, the downloader sends it to the
</I>&gt;&gt;&gt;<i> object that needs it.  This isn't a very general solution, but it is
</I>&gt;&gt;&gt;<i> very short and readable.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This I actually like, and sounds a bit like what I would implement someday
</I>&gt;&gt;<i> if I were to implement something.  Of course, it should be general-purpose
</I>&gt;&gt;<i> so it works for other applications.  The idea I have is to allow resources
</I>&gt;&gt;<i> to optionally handle these new data-arrived events.  It should be possible
</I>&gt;&gt;<i> for a resource to signal that it wants data as it is received, perhaps by
</I>&gt;&gt;<i> declaring that implements a new interface (eg, IStreamingRequestHandler or
</I>&gt;&gt;<i> something) with a method that is called each time data is received in the
</I>&gt;&gt;<i> request body.  Resources which don't implement this interface will get the
</I>&gt;&gt;<i> old behavior of having the request body buffered and delivered all at once,
</I>&gt;&gt;<i> but resources which want streaming can get it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does that make sense?
</I>&gt;<i>
</I>&gt;<i>That makes sense, but in the streaming case I really think that you need
</I>&gt;<i>to call back every time data comes in.
</I>
Yes, definitely.  `IStreamingRequestHandler&#180; would have some method like
`someMoreRequestDataReceived&#180; and it would be called as many times as
necessary for a single request until the entire request body has been
delivered.

&gt;<i>
</I>&gt;&gt;<i> If the above described approach sounds sensible and you want to take a
</I>&gt;&gt;<i> crack at it, I'd really appreciate it.  The best thing to do with the
</I>&gt;&gt;<i> result is attach it to a ticket in the tracker, probably #288
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  <A HREF="http://twistedmatrix.com/trac/ticket/288">http://twistedmatrix.com/trac/ticket/288</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If not, I'd still like to see the code and make sure the ideas I have will
</I>&gt;&gt;<i> also satisfy the use-case it represents.
</I>&gt;<i>
</I>&gt;<i>I'm certainly willing to help, although I think we have some things to
</I>&gt;<i>clean up.
</I>&gt;<i>
</I>
Jean-Paul

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003654.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
	<LI>Next message: <A HREF="003657.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3656">[ date ]</a>
              <a href="thread.html#3656">[ thread ]</a>
              <a href="subject.html#3656">[ subject ]</a>
              <a href="author.html#3656">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
