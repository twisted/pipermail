<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Bug in twisted.web2.client when receiving
	non-chunked responses of indeterminate length
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Bug%20in%20twisted.web2.client%20when%20receiving%0A%09non-chunked%20responses%20of%20indeterminate%20length&In-Reply-To=47EA199B.2050507%40datanet.ab.ca">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003712.html">
   <LINK REL="Next"  HREF="003724.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Bug in twisted.web2.client when receiving
	non-chunked responses of indeterminate length</H1>
    <B>Andrew Warkentin</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Bug%20in%20twisted.web2.client%20when%20receiving%0A%09non-chunked%20responses%20of%20indeterminate%20length&In-Reply-To=47EA199B.2050507%40datanet.ab.ca"
       TITLE="[Twisted-web] Bug in twisted.web2.client when receiving
	non-chunked responses of indeterminate length">andreww at datanet.ab.ca
       </A><BR>
    <I>Fri Mar 28 08:31:22 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="003712.html">[Twisted-web] Bug in twisted.web2.client when receiving non-chunked
 responses of indeterminate length
</A></li>
        <LI>Next message: <A HREF="003724.html">[Twisted-web] Bug in twisted.web2.client when receiving
	non-chunked responses of indeterminate length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3722">[ date ]</a>
              <a href="thread.html#3722">[ thread ]</a>
              <a href="subject.html#3722">[ subject ]</a>
              <a href="author.html#3722">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Andrew Warkentin wrote:

&gt;<i> twisted.web2.client cuts responses short if they are not in chunked =
</I>
&gt;<i> encoding and do not have a Content-Length header. I have attached a =
</I>
&gt;<i> patch that fixes this bug. I am posting it to the list because I =
</I>
&gt;<i> couldn't register on the site to post it to the bug tracker.
</I>&gt;<i>
</I>The previous patch introduced anotther bug which prevented the Deferred =

returned from HTTPClient.submit from being fired if the connection was =

closed cleanly before the data was sent. I have attached an updated =

version of the patch which does not have that bug.
-------------- next part --------------
Only in TwistedWeb2-svn20071201: build
diff -r -C 3 TwistedWeb2-svn20071201.orig/twisted/web2/channel/http.py Twis=
tedWeb2-svn20071201/twisted/web2/channel/http.py
*** TwistedWeb2-svn20071201.orig/twisted/web2/channel/http.py	Sat Dec  1 04=
:<i>10:51 2007
</I>--- TwistedWeb2-svn20071201/twisted/web2/channel/http.py	Fri Mar 28 04:40:0=
1 2008
***************
*** 163,176 ****
              self.handleContentChunk(data[:self.length])
              extraneous =3D data[self.length:]
              channel =3D self.channel # could go away from allContentRecei=
ved.
!             if not self.chunkedIn:
!                 self.allContentReceived()
!             else:
!                 # NOTE: in chunked mode, self.length is the size of the c=
urrent chunk,
!                 # so we still have more to read.
!                 self.chunkedIn =3D 2 # Read next chunksize
              =

!             channel.setLineMode(extraneous)
  =

      def headerReceived(self, line):
          &quot;&quot;&quot;Store this header away. Check for too much header data
--- 163,177 ----
              self.handleContentChunk(data[:self.length])
              extraneous =3D data[self.length:]
              channel =3D self.channel # could go away from allContentRecei=
ved.
!             if not (self.length is None and not self.chunkedIn and self.p=
arseCloseAsEnd):
!                 if not self.chunkedIn:
!                     self.allContentReceived()
!                 else:
!                     # NOTE: in chunked mode, self.length is the size of t=
he current chunk,
!                     # so we still have more to read.
!                     self.chunkedIn =3D 2 # Read next chunksize
              =

!                 channel.setLineMode(extraneous)
  =

      def headerReceived(self, line):
          &quot;&quot;&quot;Store this header away. Check for too much header data
diff -r -C 3 TwistedWeb2-svn20071201.orig/twisted/web2/client/http.py Twist=
edWeb2-svn20071201/twisted/web2/client/http.py
*** TwistedWeb2-svn20071201.orig/twisted/web2/client/http.py	Sat Dec  1 04:=
11:46 2007
--- TwistedWeb2-svn20071201/twisted/web2/client/http.py	Fri Mar 28 04:39:49=
 2008
***************
*** 8,13 ****
--- 8,14 ----
  =

  from zope.interface import implements
  =

+ from twisted.internet.error import ConnectionDone
  from twisted.internet.defer import Deferred
  from twisted.protocols.basic import LineReceiver
  from twisted.protocols.policies import TimeoutMixin
***************
*** 165,171 ****
          self._error(ProtocolError(text))
  =

      def connectionLost(self, reason):
!         self._error(reason)
  =

      def gotInitialLine(self, initialLine):
          parts =3D initialLine.split(' ', 2)
--- 166,177 ----
          self._error(ProtocolError(text))
  =

      def connectionLost(self, reason):
!         # If the response was non-chunked and of indeterminate length, tr=
eat the
!         # connection being closed cleanly as the end of the response
!         if self.length is None and not self.chunkedIn and reason.check(Co=
nnectionDone) and hasattr(self, 'stream'):
!             self.allContentReceived()
!         else:
!             self._error(reason)
  =

      def gotInitialLine(self, initialLine):
          parts =3D initialLine.split(' ', 2)
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003712.html">[Twisted-web] Bug in twisted.web2.client when receiving non-chunked
 responses of indeterminate length
</A></li>
	<LI>Next message: <A HREF="003724.html">[Twisted-web] Bug in twisted.web2.client when receiving
	non-chunked responses of indeterminate length
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3722">[ date ]</a>
              <a href="thread.html#3722">[ thread ]</a>
              <a href="subject.html#3722">[ subject ]</a>
              <a href="author.html#3722">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
