<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20streaming%20request%20%28was%3A%20status%20of%20Twisted%20Web%0A%09and%20Web%202%29&In-Reply-To=20080306033029.6859.209104412.divmod.quotient.16064%40ohm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003649.html">
   <LINK REL="Next"  HREF="003656.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)</H1>
    <B>Andrew McNabb</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20streaming%20request%20%28was%3A%20status%20of%20Twisted%20Web%0A%09and%20Web%202%29&In-Reply-To=20080306033029.6859.209104412.divmod.quotient.16064%40ohm"
       TITLE="[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)">amcnabb at mcnabbs.org
       </A><BR>
    <I>Thu Mar  6 09:15:53 EST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="003649.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
        <LI>Next message: <A HREF="003656.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3654">[ date ]</a>
              <a href="thread.html#3654">[ thread ]</a>
              <a href="subject.html#3654">[ subject ]</a>
              <a href="author.html#3654">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Mar 05, 2008 at 10:30:29PM -0500, Jean-Paul Calderone wrote:
&gt;<i>
</I>&gt;<i> To clarify, this is about calling into application code in a web server
</I>&gt;<i> once each time some new bytes from a request body are received from the
</I>&gt;<i> client, right?
</I>
Exactly.

&gt;<i> Deferred.callback explicitly checks to see if you're giving it a Deferred
</I>&gt;<i> and raises the TypeError.  The idea here is that most of the time, you're
</I>&gt;<i> probably doing this by accident, not intentionally.  Clearly it wasn't an
</I>&gt;<i> accident in your case.
</I>
I definitely was not doing it by accident. :)  Is this really a common
mistake?

&gt;<i> The way to actually get this behavior is to chain the Deferreds
</I>&gt;<i> together.  Instead of a.callback(b), which I assume you was to send
</I>&gt;<i> the result of b to the callbacks of a when they became available, you
</I>&gt;<i> a.chainDeferred(b), which is really just a way to say
</I>&gt;<i>
</I>&gt;<i>  a.addCallbacks(b.callback, b.errback)
</I>&gt;<i>
</I>&gt;<i> However, I don't think this is generally the approach to take.
</I>
This actually isn't equivalent to what I was trying to do.  Think of my
approach this way.  As a user, you call:

d = streaming_download(url)

def got_some_data(value):
    new_data, d = value
    # add callback for the next time data get sent:
    d.addCallback(got_some_data)
    # do stuff with new_data

d.addCallback(got_some_data)


&gt;&gt;<i> My second attempt was to create a new deferred each time data arrived
</I>&gt;&gt;<i> and to copy the callback list from the previous deferred.  This worked,
</I>&gt;&gt;<i> but it felt dirty, so I got rid of it.
</I>
Actually, after looking at my code again, it turns out that what I am
doing is actually a mix of attempt 2 and attempt 3.  This is the code
that copies the deferred:

    newdef = defer.Deferred()
    newdef.callbacks = list(self.deferred.callbacks)
    newdef.callback(False)


&gt;&gt;<i> My third and final attempt was to tie the downloader in to my
</I>&gt;&gt;<i> application.  Every time data arrive, the downloader sends it to the
</I>&gt;&gt;<i> object that needs it.  This isn't a very general solution, but it is
</I>&gt;&gt;<i> very short and readable.
</I>&gt;<i>
</I>&gt;<i> This I actually like, and sounds a bit like what I would implement someday
</I>&gt;<i> if I were to implement something.  Of course, it should be general-purpose
</I>&gt;<i> so it works for other applications.  The idea I have is to allow resources
</I>&gt;<i> to optionally handle these new data-arrived events.  It should be possible
</I>&gt;<i> for a resource to signal that it wants data as it is received, perhaps by
</I>&gt;<i> declaring that implements a new interface (eg, IStreamingRequestHandler or
</I>&gt;<i> something) with a method that is called each time data is received in the
</I>&gt;<i> request body.  Resources which don't implement this interface will get the
</I>&gt;<i> old behavior of having the request body buffered and delivered all at once,
</I>&gt;<i> but resources which want streaming can get it.
</I>&gt;<i>
</I>&gt;<i> Does that make sense?
</I>
That makes sense, but in the streaming case I really think that you need
to call back every time data comes in.

&gt;<i> If the above described approach sounds sensible and you want to take a
</I>&gt;<i> crack at it, I'd really appreciate it.  The best thing to do with the
</I>&gt;<i> result is attach it to a ticket in the tracker, probably #288
</I>&gt;<i>
</I>&gt;<i>  <A HREF="http://twistedmatrix.com/trac/ticket/288">http://twistedmatrix.com/trac/ticket/288</A>
</I>&gt;<i>
</I>&gt;<i> If not, I'd still like to see the code and make sure the ideas I have will
</I>&gt;<i> also satisfy the use-case it represents.
</I>
I'm certainly willing to help, although I think we have some things to
clean up.

-- 
Andrew McNabb
<A HREF="http://www.mcnabbs.org/andrew/">http://www.mcnabbs.org/andrew/</A>
PGP Fingerprint: 8A17 B57C 6879 1863 DE55  8012 AB4D 6098 8826 6868
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: not available
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20080306/c95c47f9/attachment.pgp">http://twistedmatrix.com/pipermail/twisted-web/attachments/20080306/c95c47f9/attachment.pgp</A>
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003649.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
	<LI>Next message: <A HREF="003656.html">[Twisted-web] streaming request (was: status of Twisted Web
	and Web 2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3654">[ date ]</a>
              <a href="thread.html#3654">[ thread ]</a>
              <a href="subject.html#3654">[ subject ]</a>
              <a href="author.html#3654">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
