<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Message Board Example
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000131.html">
   <LINK REL="Next"  HREF="000133.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Message Board Example
   </H1>
    <B>john janecek
    </B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com"
       TITLE="[Twisted-web] Message Board Example">twisted-web@twistedmatrix.com
       </A><BR>
    <I>Tue, 20 Jan 2004 07:00:01 +0000 (UTC)</I>
    <P><UL>
        <LI> Previous message: <A HREF="000131.html">[Twisted-web] Woven-Like Model Stack and Relative Submodel
 Paths
</A></li>
        <LI> Next message: <A HREF="000133.html">[Twisted-web] Page navigation: a cry for help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#132">[ date ]</a>
              <a href="thread.html#132">[ thread ]</a>
              <a href="subject.html#132">[ subject ]</a>
              <a href="author.html#132">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&quot;&quot;&quot;
this is the twisted message board made by John Janecek
me webpage is at <A HREF="http://www.jjanecek.ca.tf/">http://www.jjanecek.ca.tf/</A> so you
can flame me and tell me what a piece of crap this code is :)
it basically was created so I can test out the leo editor
and also so I can see how nevow works

Lots of things that need to be done, like adding persistence so
messages are saved when stopping and starting server etc.

Anyway it is just a proof of concept, if anyway one finds it useful we
heya
&quot;&quot;&quot;
#messageboard for the twisted python server
from nevow import renderer
from nevow import tags
from nevow import formless
from nevow import freeform
from nevow.renderer import DynamicRenderer
import string
from time import gmtime, strftime

class TMessage(object) :
	def __init__(self,UserName,EMail,Subject,Message) :
		self.UserName=UserName
		self.EMail=EMail
		self.Subject=Subject
		self.Message=Message
		self.DateTime=strftime(&quot;%a, %d %b %Y %H:%M:%S&quot;, gmtime())
		self.Messages=[]
	def getMessages(self) :
		return self.Messages
		
	&quot;&quot;&quot;
	If index=[] message is just appended to the end
	&quot;&quot;&quot;
	def addMessage(self,Message,Index=[]) :
		if Index==[] :
			self.Messages.append(Message)
		else :
			Parent=self.getMessage(Index)
			Parent.addMessage(Message)
	def getMessage(self,Index) :	
		if isinstance(Index,list) :
			if(len(Index)==1) :
				return self.Messages[Index[0]]
			else :
				Current=Index.pop(0)
				return self.Messages[Current].getMessage(Index)
				
		else :
			return self.Messages[Index]
	
class TMessageBoard(object) :
	&quot;&quot;&quot;
	Message board which will implement the posting and recieving of messages.
	This part of the board handles the actual nuts and bolts of the Message Board
including storage of Messages
	
	Probably Could Have Inherited off TMessage
	&quot;&quot;&quot;
	def __init__(self) :
		self.Messages=[]
	&quot;&quot;&quot;
	returns all the messages on the board
	&quot;&quot;&quot;
	def getMessages(self) :
		return self.Messages
	&quot;&quot;&quot;
	If index=[] message is just appended to the end
	&quot;&quot;&quot;
	
	def addMessage(self,Message,Index=[]) :
		if Index==[] :
			self.Messages.append(Message)
		else :
			Parent=self.getMessage(Index)
			Parent.addMessage(Message)
	def getMessage(self,Index) :	
		if isinstance(Index,list) :
			if(len(Index)==1) :
				return self.Messages[Index[0]]
			else :
				Current=Index.pop(0)
				return self.Messages[Current].getMessage(Index)
				
		else :
			return self.Messages[Index]
class IMessageForm(formless.TypedInterface) :
	
	def MessagePost(self,UserName=formless.String(),
					EMail=formless.String(),
					Subject=formless.String(),
					Message=formless.Text(),
					) :
		pass
		
	MessagePost = formless.autocallable(MessagePost,action=&quot;Post Message&quot;)
class MessagePage(renderer.Renderer) :
	__implements__ = IMessageForm,renderer.Renderer.__implements__
	def __init__(self,MessageBoard) :
		renderer.Renderer.__init__(self)
		self.MessageBoard=MessageBoard
		self.CurrentMessageIndex=[]
		
	def beforeRender(self, request):
		#print &quot;request &quot;,request.args
		if request.args.has_key(&quot;messageid&quot;) :
			self.CurrentMessageIndex=string.split(request.args[&quot;messageid&quot;][0])
			self.CurrentMessageIndex=map(int,self.CurrentMessageIndex)
		else :
			self.CurrentMessageIndex=[]
		print &quot;Current Message &quot;,self.CurrentMessageIndex
	&quot;&quot;&quot;
	Method to Serialize messages
	&quot;&quot;&quot;
	def SerializeMessage(self,Message) :
		Row1=tags.tr()[
				tags.td[&quot;Subject :&quot;],
				tags.td[Message.Subject],
				tags.td[Message.DateTime]
				]
		Row2=tags.tr[
			tags.td[Message.Message]
			]
		return tags.table(border=&quot;1&quot;)[Row1,Row2]
	def currentMessage(self,context, data) :
		try :
			return
self.SerializeMessage(self.MessageBoard.getMessage(self.CurrentMessageIndex))
		except Exception,Msg:
			self.CurrentMessageIndex=[]
			print &quot;Error &quot;,Msg
			return &quot;&quot;
	def SerializeMessageHeader(self,Messages,IndexDepth=[]) :
		MessageList=[]
		
		IndexStr=&quot;&quot;.join(map(lambda x : str(x)+&quot; &quot;,IndexDepth))
		IndexStr=&quot;?messageid=&quot;+IndexStr+&quot; &quot;
		Index=len(Messages)-1
		#done to display newest messages first
		
		for Message in Messages[::-1] :
			IndexDepth.append(Index)
			if IndexDepth==self.CurrentMessageIndex :
				MessageLine=tags.li[
					tags.span(_class=&quot;selected&quot;)[
						Message.UserName,
						tags.a(href=IndexStr+str(Index))[Message.Subject],
						Message.DateTime
						]
					]
				MessageList.append(MessageLine)
			else :
				MessageLine=tags.li[
					tags.span(_class=&quot;notselected&quot;)[
						Message.UserName,
						tags.a(href=IndexStr+str(Index))[Message.Subject],
						Message.DateTime
						]
					]
				MessageList.append(MessageLine)
			
			ChildMessages=Message.getMessages()
			MessageList.append(self.SerializeMessageHeader(ChildMessages))
			IndexDepth.pop()
			Index-=1
			
		return tags.ul[MessageList]
	def showMessages(self,context,data) :
		Messages=self.MessageBoard.getMessages()
		return self.SerializeMessageHeader(Messages)
		
	document = tags.html[
			tags.head[
				tags.title[&quot;Twisted Message Board&quot;],
				tags.link(href=&quot;/freeform_css&quot;,type=&quot;text/css&quot;, rel=&quot;stylesheet&quot;)
				],
			tags.body[
				&quot;Message Board Post Page&quot;,
				tags.a(href=&quot;./&quot;)[&quot;Post New Thread&quot;],
				tags.p[ showMessages ],
				tags.p[ currentMessage ],
				tags.p[ freeform.configure ]
				]
		]
	def MessagePost(self,UserName,EMail,Subject,Message) :
		Message=TMessage(UserName,EMail,Subject,Message)
		self.MessageBoard.addMessage(Message,self.CurrentMessageIndex)
	def getDynamicChild(self,name,request) :
		print &quot;request &quot;,request.args
		return self
	def child_freeform_css(self,request) :
		Style=&quot;&quot;&quot;
		.selected {
		color: #FF0000;
		background-color: #003399;
		}
		.notselected{
		color: #0000FF;
		background-color: #000000;
		}
		
		.freeform-typed { clear: both; }
		.freeform-property-binding { clear: both; border: 1px solid blue; padding:
0.5em; width: auto }
		.freeform-method-binding { clear: both; border: 1px solid black; padding:
0.5em; width: auto }
		.freeform-argument-binding { clear: both; border: 1px solid blue; padding:
0.5em; width: auto }
		.freeform-binding-content { border-top: 1px dashed #bdedfe; margin-top: 0.5em;
padding-top: 0.5em }
		.freeform-label { float: left; width: 200px; }
		.freeform-input { float: left; width: 200px; }
		.freeform-error { color: red; }
		.freeform-description { clear: both; border-bottom: 1px dashed #bdedfe;
margin-bottom: 0.5em; padding-bottom: 0.5em }
		.freeform-list-item { clear: both; width: auto }
		.freeform-form-label { color: #666666 }
	
		.freeform-textarea { width: 5in; height: 3in }
	
		.freeform-success { padding: 0.5em; border: 1px dashed green; }
		.freeform-failure { padding: 0.5em; color: red; border: 1px dashed red; }
	
		.freeform-list { border: 1px dashed #cdcdcd; }
		.freeform-dictionary { border: 1px dashed #dedede; }
		.freeform-action-group { margin: 0px }
		.freeform-action { color: green }
		.freeform-action-selection { background-color: red; height: 1em; width: 1em; }
	
		.freeform-group-binding { border: 1px dashed #efabab }
		.freeform-grouped-property-binding {}
		.freeform-grouped-method-binding {}
		&quot;&quot;&quot;
		
		return DynamicRenderer(Style)

def CreateMessageBoard() :
	&quot;&quot;&quot;
	Creates a Message board so it can be run in a Server
	returns : returns a MessagePage Object
	&quot;&quot;&quot;
	MessageBoard=TMessageBoard()
	Page=MessagePage(MessageBoard)
	return Page

#the tap file

import sys
import os
#print &quot;current dir &quot;,os.getcwd()
#not really sure why i need to fix this
sys.path.append(os.getcwd())
from twisted.application import service
from twisted.application import internet
from nevow import appserver
import msg_board

application = service.Application(&quot;MessageBoard&quot;)

WebServer=internet.TCPServer(
    8080, 
    appserver.NevowSite(
        msg_board.CreateMessageBoard()
    )
)
WebServer.setServiceParent(application)

#from twisted.internet import defer

#def Stopped() :
#	d=defer.Deferred()
#	print &quot;WebServer Stopped&quot;

#WebServer.stopService=Stopped
#print &quot;WebServer Deferred &quot;,Defered








</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000131.html">[Twisted-web] Woven-Like Model Stack and Relative Submodel
 Paths
</A></li>
	<LI> Next message: <A HREF="000133.html">[Twisted-web] Page navigation: a cry for help
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#132">[ date ]</a>
              <a href="thread.html#132">[ thread ]</a>
              <a href="subject.html#132">[ subject ]</a>
              <a href="author.html#132">[ author ]</a>
         </LI>
       </UL>
</body></html>
