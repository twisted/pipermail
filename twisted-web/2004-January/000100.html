<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] NEWBIE: Unittest hangs by deferred
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com">
   <META NAME="robots" CONTENT="index,nofollow">
   
   <LINK REL="Previous"  HREF="000099.html">
   <LINK REL="Next"  HREF="000101.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] NEWBIE: Unittest hangs by deferred
   </H1>
    <B>Andrew Bennetts
    </B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com"
       TITLE="[Twisted-web] NEWBIE: Unittest hangs by deferred">twisted-web@twistedmatrix.com
       </A><BR>
    <I>Sat, 10 Jan 2004 03:09:56 +1100</I>
    <P><UL>
        <LI> Previous message: <A HREF="000099.html">[Twisted-web] NEWBIE: Unittest hangs by deferred
</A></li>
        <LI> Next message: <A HREF="000101.html">[Twisted-web] NEWBIE: Unittest hangs by deferred
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#100">[ date ]</a>
              <a href="thread.html#100">[ thread ]</a>
              <a href="subject.html#100">[ subject ]</a>
              <a href="author.html#100">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Jan 09, 2004 at 04:21:55PM +0100, Bart Frackiewicz wrote:
[...]
&gt;<i> 
</I>&gt;<i> When i run this from bash, this works as excepted.
</I>&gt;<i> 
</I>&gt;<i> ### file: city.py ###
</I>&gt;<i> import twisted_rpc3
</I>&gt;<i> 
</I>&gt;<i> def printResult(res):
</I>&gt;<i>    print res
</I>&gt;<i> 
</I>&gt;<i> c = twisted_rpc3.City()
</I>&gt;<i> c.getCityId(('berlin', 'de')).addCallback(printResult)
</I>&gt;<i> 
</I>&gt;<i> reactor.callLater(2, reactor.stop)
</I>&gt;<i> reactor.run()
</I>
Gah!  You're assuming that the result will arrive in 2 seconds... you
probably should do that like this:

----
# ...
from twisted.python import log

c = twisted_rpc3.City()
d = c.getCityId(('berlin', 'de'))
d.addCallback(printResult)
d.addErrback(log.err)
d.addBoth(lambda _: reactor.stop())

reactor.run()
----

Which will wait until the result (or an error, which will be logged)
arrives, and only then stops.  Much better than hard-coding a response
time.

Anyway, that's not your problem, but I just felt compelled to point that
out.

&gt;<i> ### endfile: city.py ###
</I>&gt;<i> 
</I>&gt;<i> For the unittest, i create following:
</I>&gt;<i> 
</I>&gt;<i> ## file test_twisted_rpc3.py ###
</I>&gt;<i> from twisted.trial import unittest
</I>&gt;<i> 
</I>&gt;<i> class TestCaseCity(unittest.TestCase):
</I>&gt;<i> 
</I>&gt;<i>    def testObject(self):
</I>&gt;<i>      c = twisted_rpc3.City()
</I>&gt;<i> 
</I>&gt;<i>    def testGetCityId(self):
</I>&gt;<i>      c = twisted_rpc3.City()
</I>&gt;<i>      d = c.getCityId(('Berlin', 'de'))
</I>&gt;<i>      self.assertEquals(unittest.deferredResult(d, 5), 'de_berlin')
</I>&gt;<i> ## endfile test_twisted_rpc3.py ###
</I>&gt;<i> 
</I>&gt;<i> After starting test ([~/twisted]$ trial test_twisted_rpc3) , i get an 
</I>&gt;<i> timeout error, and if i add print statements, i see that getCityId() was 
</I>&gt;<i> called, but _searchCityByString() never. Where is my mistake?
</I>
I don't see any obvious problems here... but is it possible the dbpools from
the various tests are interfering with each other?  So, if you instruct
trial to just run that one test method, i.e.: 
    trial test_twisted_rpc3.TestCaseCity.testGetCityId
does that work?

If so, perhaps make sure you call .close on the dbpool the your City objects
create before the test is torn down?

(Should trial report on shutdown triggers that are left over after running a
test?  They might be a sign of resources not being properly cleaned up after
a test.)

Hmm, actually, because tests never call reactor.run (only reactor.iterate),
it's possible that you need to call dbpool.start() manually in your test.
That would explain your symptoms: the test times out because the dbpool
isn't actually running yet.

-Andrew.



</PRE>
<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI> Previous message: <A HREF="000099.html">[Twisted-web] NEWBIE: Unittest hangs by deferred
</A></li>
	<LI> Next message: <A HREF="000101.html">[Twisted-web] NEWBIE: Unittest hangs by deferred
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#100">[ date ]</a>
              <a href="thread.html#100">[ thread ]</a>
              <a href="subject.html#100">[ subject ]</a>
              <a href="author.html#100">[ author ]</a>
         </LI>
       </UL>
</body></html>
