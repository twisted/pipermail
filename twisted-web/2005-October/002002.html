<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Preventing XSS when using Nevow's
	vhost	functionality
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Preventing%20XSS%20when%20using%20Nevow%27s%0A%09vhost%09functionality&In-Reply-To=8F803272-D035-49EF-ACD3-3FDCF03F301B%40dreid.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002001.html">
   <LINK REL="Next"  HREF="002004.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Preventing XSS when using Nevow's
	vhost	functionality</H1>
    <B>Jason Mobarak</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Preventing%20XSS%20when%20using%20Nevow%27s%0A%09vhost%09functionality&In-Reply-To=8F803272-D035-49EF-ACD3-3FDCF03F301B%40dreid.org"
       TITLE="[Twisted-web] Preventing XSS when using Nevow's
	vhost	functionality">jason.mobarak at gmail.com
       </A><BR>
    <I>Wed Oct 19 17:29:58 MDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002001.html">[Twisted-web] Preventing XSS when using Nevow's vhost
	functionality
</A></li>
        <LI>Next message: <A HREF="002004.html">[Twisted-web] Preventing XSS when using Nevow's
	vhost	functionality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2002">[ date ]</a>
              <a href="thread.html#2002">[ thread ]</a>
              <a href="subject.html#2002">[ subject ]</a>
              <a href="author.html#2002">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>David Reid wrote:
&gt;<i> 
</I>&gt;<i> On Oct 19, 2005, at 2:48 PM, David Remahl wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> The attacker makes the victim go to this URL:
</I>&gt;&gt;<i>     <A HREF="http://goody.com/vhost/http/evil.net/pageWithAttackJS.html">http://goody.com/vhost/http/evil.net/pageWithAttackJS.html</A>
</I>&gt;&gt;<i> which gets rewritten (by the reverse proxy) to:
</I>&gt;&gt;<i>     
</I>&gt;&gt;<i> <A HREF="http://internalserver:1234/vhost/http/goody.com/vhost/http/evil.net/pageWithAttackJS.html">http://internalserver:1234/vhost/http/goody.com/vhost/http/evil.net/pageWithAttackJS.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The web server looks up the vhost child of the root resource which 
</I>&gt;&gt;<i> consumes the next two components. It sets the host to goody.com, as it 
</I>&gt;&gt;<i> should be and passes control back to the root resource. The remaining 
</I>&gt;&gt;<i> URI at this point is:
</I>&gt;&gt;<i>     <A HREF="http://goody.com/vhost/http/evil.net/pageWithAttackJS.html">http://goody.com/vhost/http/evil.net/pageWithAttackJS.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This once more invokes the vhost functionality, the following results 
</I>&gt;&gt;<i> and is accessed:
</I>&gt;&gt;<i>     <A HREF="http://evil.net/pageWithAttackJS.html">http://evil.net/pageWithAttackJS.html</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Your example is a little confusing.  VHostMonsterResource does expose 
</I>&gt;<i> applications using nevow.url to link hijacking.  So for your example to 
</I>&gt;<i> work /pageWithAttackJS.html would have to be on the target server, and 
</I>&gt;<i> generated links on that page would get rewritten as <A HREF="http://evil.net/.">http://evil.net/.</A>  
</I>&gt;<i> Potentially these generated links could include a &lt;script&gt; tag.  
</I>
So pageWithAttackJS.js would more likely be liveglue.js?

&gt;<i> 
</I>&gt;<i> So now that everyone is on the same page, i've attached a proof of 
</I>&gt;<i> concept tac that better demonstrates the problem.  If you start the tac 
</I>&gt;<i> and go to it with 
</I>&gt;<i> <A HREF="http://localhost:8080/vhost/http/foo.bar/vhost/http/google.com/">http://localhost:8080/vhost/http/foo.bar/vhost/http/google.com/</A> you 
</I>&gt;<i> should see the google logo loaded. if you do not include the final vhost 
</I>&gt;<i> call nothing should load.
</I>
I don't quite understand why this works.  If the first two segments of 
the vhost request are the protocol and the host why isn't it the case 
that these segments are consumed, the URL is re-written to:

<A HREF="http://foo.bar/vhost/http/google.com">http://foo.bar/vhost/http/google.com</A>

...and it fails because foo.bar doesn't exist?  Why are the segments 
still consumed after this point, or...?

&gt;<i> 
</I>&gt;<i> So the problem is two fold, VHostMonsterResource is to trusting of the 
</I>&gt;<i> Host: header.  The solution to that is to use something like 
</I>&gt;<i> web2.vhost.VHostURIRewrite which sets the host:port for the request 
</I>&gt;<i> mangling at configuration time.   This might not be ideal in all 
</I>&gt;<i> enviroments if you have multiple hosts forwarding to the same application.
</I>&gt;<i> 
</I>&gt;<i> Another problem is that URL generation is to trusting of the context. 
</I>&gt;<i> Being able to easily generate links relative-to-root (rendering without 
</I>&gt;<i> the scheme and netloc portions) would also prevent this type of link 
</I>&gt;<i> hijacking.  (Though it would be potentially vulnerable to attacks from a 
</I>&gt;<i> sister application.)  But relative-to-root URL generation (as sane 
</I>&gt;<i> default) would negate the need for vhost.VHostMonsterResource in most cases.
</I>&gt;<i> 
</I>&gt;<i> However as for fixing VHostMonsterResource, I'd rather just see it die 
</I>&gt;<i> the slow painful death it deserves.  But I think if you're going to 
</I>&gt;<i> limit VHostMonsterResource to one proxy url, you might as well switch to 
</I>&gt;<i> a configuration time rewriter.  Another solution is to simply tag the 
</I>&gt;<i> request as rewritten so it doesn't get mangled a second time, raising 
</I>&gt;<i> the appropriate error code)
</I>&gt;<i> 
</I>&gt;<i> -David
</I>

</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002001.html">[Twisted-web] Preventing XSS when using Nevow's vhost
	functionality
</A></li>
	<LI>Next message: <A HREF="002004.html">[Twisted-web] Preventing XSS when using Nevow's
	vhost	functionality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2002">[ date ]</a>
              <a href="thread.html#2002">[ thread ]</a>
              <a href="subject.html#2002">[ subject ]</a>
              <a href="author.html#2002">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
