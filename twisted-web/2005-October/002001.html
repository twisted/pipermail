<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Preventing XSS when using Nevow's vhost
	functionality
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Preventing%20XSS%20when%20using%20Nevow%27s%20vhost%0A%09functionality&In-Reply-To=301F4B8C-3B09-499B-AEA0-C8E8930E930C%40remahl.se">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002000.html">
   <LINK REL="Next"  HREF="002002.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Preventing XSS when using Nevow's vhost
	functionality</H1>
    <B>David Reid</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Preventing%20XSS%20when%20using%20Nevow%27s%20vhost%0A%09functionality&In-Reply-To=301F4B8C-3B09-499B-AEA0-C8E8930E930C%40remahl.se"
       TITLE="[Twisted-web] Preventing XSS when using Nevow's vhost
	functionality">dreid at dreid.org
       </A><BR>
    <I>Wed Oct 19 17:07:58 MDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002000.html">[Twisted-web] Preventing XSS when using Nevow's vhost functionality
</A></li>
        <LI>Next message: <A HREF="002002.html">[Twisted-web] Preventing XSS when using Nevow's
	vhost	functionality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2001">[ date ]</a>
              <a href="thread.html#2001">[ thread ]</a>
              <a href="subject.html#2001">[ subject ]</a>
              <a href="author.html#2001">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On Oct 19, 2005, at 2:48 PM, David Remahl wrote:
&gt;<i> The attacker makes the victim go to this URL:
</I>&gt;<i>     <A HREF="http://goody.com/vhost/http/evil.net/pageWithAttackJS.html">http://goody.com/vhost/http/evil.net/pageWithAttackJS.html</A>
</I>&gt;<i> which gets rewritten (by the reverse proxy) to:
</I>&gt;<i>     <A HREF="http://internalserver:1234/vhost/http/goody.com/vhost/http/">http://internalserver:1234/vhost/http/goody.com/vhost/http/</A> 
</I>&gt;<i> evil.net/pageWithAttackJS.html
</I>&gt;<i>
</I>&gt;<i> The web server looks up the vhost child of the root resource which  
</I>&gt;<i> consumes the next two components. It sets the host to goody.com, as  
</I>&gt;<i> it should be and passes control back to the root resource. The  
</I>&gt;<i> remaining URI at this point is:
</I>&gt;<i>     <A HREF="http://goody.com/vhost/http/evil.net/pageWithAttackJS.html">http://goody.com/vhost/http/evil.net/pageWithAttackJS.html</A>
</I>&gt;<i>
</I>&gt;<i> This once more invokes the vhost functionality, the following  
</I>&gt;<i> results and is accessed:
</I>&gt;<i>     <A HREF="http://evil.net/pageWithAttackJS.html">http://evil.net/pageWithAttackJS.html</A>
</I>
Your example is a little confusing.  VHostMonsterResource does expose  
applications using nevow.url to link hijacking.  So for your example  
to work /pageWithAttackJS.html would have to be on the target server,  
and generated links on that page would get rewritten as http:// 
evil.net/.  Potentially these generated links could include a  
&lt;script&gt; tag.

So now that everyone is on the same page, i've attached a proof of  
concept tac that better demonstrates the problem.  If you start the  
tac and go to it with <A HREF="http://localhost:8080/vhost/http/foo.bar/vhost/">http://localhost:8080/vhost/http/foo.bar/vhost/</A> 
http/google.com/ you should see the google logo loaded. if you do not  
include the final vhost call nothing should load.

So the problem is two fold, VHostMonsterResource is to trusting of  
the Host: header.  The solution to that is to use something like  
web2.vhost.VHostURIRewrite which sets the host:port for the request  
mangling at configuration time.   This might not be ideal in all  
enviroments if you have multiple hosts forwarding to the same  
application.

Another problem is that URL generation is to trusting of the context.  
Being able to easily generate links relative-to-root (rendering  
without the scheme and netloc portions) would also prevent this type  
of link hijacking.  (Though it would be potentially vulnerable to  
attacks from a sister application.)  But relative-to-root URL  
generation (as sane default) would negate the need for  
vhost.VHostMonsterResource in most cases.

However as for fixing VHostMonsterResource, I'd rather just see it  
die the slow painful death it deserves.  But I think if you're going  
to limit VHostMonsterResource to one proxy url, you might as well  
switch to a configuration time rewriter.  Another solution is to  
simply tag the request as rewritten so it doesn't get mangled a  
second time, raising the appropriate error code)

-David

&#65532;
-------------- next part --------------
Skipped content of type multipart/mixed
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002000.html">[Twisted-web] Preventing XSS when using Nevow's vhost functionality
</A></li>
	<LI>Next message: <A HREF="002002.html">[Twisted-web] Preventing XSS when using Nevow's
	vhost	functionality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2001">[ date ]</a>
              <a href="thread.html#2001">[ thread ]</a>
              <a href="subject.html#2001">[ subject ]</a>
              <a href="author.html#2001">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
