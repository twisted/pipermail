<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Preventing XSS when using Nevow's vhost
	functionality
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Preventing%20XSS%20when%20using%20Nevow%27s%20vhost%0A%09functionality&In-Reply-To=8F803272-D035-49EF-ACD3-3FDCF03F301B%40dreid.org">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002004.html">
   <LINK REL="Next"  HREF="002005.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Preventing XSS when using Nevow's vhost
	functionality</H1>
    <B>David Remahl</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Preventing%20XSS%20when%20using%20Nevow%27s%20vhost%0A%09functionality&In-Reply-To=8F803272-D035-49EF-ACD3-3FDCF03F301B%40dreid.org"
       TITLE="[Twisted-web] Preventing XSS when using Nevow's vhost
	functionality">david at remahl.se
       </A><BR>
    <I>Wed Oct 19 17:39:37 MDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002004.html">[Twisted-web] Preventing XSS when using Nevow's
	vhost	functionality
</A></li>
        <LI>Next message: <A HREF="002005.html">[Twisted-web] Preventing XSS when using Nevow's vhost
	functionality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2003">[ date ]</a>
              <a href="thread.html#2003">[ thread ]</a>
              <a href="subject.html#2003">[ subject ]</a>
              <a href="author.html#2003">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20 okt 2005, at 01.07, David Reid wrote:

&gt;<i> On Oct 19, 2005, at 2:48 PM, David Remahl wrote:
</I>&gt;&gt;<i> The attacker makes the victim go to this URL:
</I>&gt;&gt;<i>     <A HREF="http://goody.com/vhost/http/evil.net/pageWithAttackJS.html">http://goody.com/vhost/http/evil.net/pageWithAttackJS.html</A>
</I>&gt;&gt;<i> which gets rewritten (by the reverse proxy) to:
</I>&gt;&gt;<i>     <A HREF="http://internalserver:1234/vhost/http/goody.com/vhost/http/">http://internalserver:1234/vhost/http/goody.com/vhost/http/</A> 
</I>&gt;&gt;<i> evil.net/pageWithAttackJS.html
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The web server looks up the vhost child of the root resource which  
</I>&gt;&gt;<i> consumes the next two components. It sets the host to goody.com,  
</I>&gt;&gt;<i> as it should be and passes control back to the root resource. The  
</I>&gt;&gt;<i> remaining URI at this point is:
</I>&gt;&gt;<i>     <A HREF="http://goody.com/vhost/http/evil.net/pageWithAttackJS.html">http://goody.com/vhost/http/evil.net/pageWithAttackJS.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This once more invokes the vhost functionality, the following  
</I>&gt;&gt;<i> results and is accessed:
</I>&gt;&gt;<i>     <A HREF="http://evil.net/pageWithAttackJS.html">http://evil.net/pageWithAttackJS.html</A>
</I>&gt;<i>
</I>&gt;<i> Your example is a little confusing.  VHostMonsterResource does  
</I>&gt;<i> expose applications using nevow.url to link hijacking.  So for your  
</I>&gt;<i> example to work /pageWithAttackJS.html would have to be on the  
</I>&gt;<i> target server, and generated links on that page would get rewritten  
</I>&gt;<i> as <A HREF="http://evil.net/.">http://evil.net/.</A>  Potentially these generated links could  
</I>&gt;<i> include a &lt;script&gt; tag.
</I>&gt;<i>
</I>&gt;<i> So now that everyone is on the same page, i've attached a proof of  
</I>&gt;<i> concept tac that better demonstrates the problem.  If you start the  
</I>&gt;<i> tac and go to it with <A HREF="http://localhost:8080/vhost/http/foo.bar/">http://localhost:8080/vhost/http/foo.bar/</A> 
</I>&gt;<i> vhost/http/google.com/ you should see the google logo loaded. if  
</I>&gt;<i> you do not include the final vhost call nothing should load.
</I>&gt;<i>
</I>&gt;<i> So the problem is two fold, VHostMonsterResource is to trusting of  
</I>&gt;<i> the Host: header.  The solution to that is to use something like  
</I>&gt;<i> web2.vhost.VHostURIRewrite which sets the host:port for the request  
</I>&gt;<i> mangling at configuration time.   This might not be ideal in all  
</I>&gt;<i> enviroments if you have multiple hosts forwarding to the same  
</I>&gt;<i> application.
</I>&gt;<i>
</I>&gt;<i> Another problem is that URL generation is to trusting of the  
</I>&gt;<i> context. Being able to easily generate links relative-to-root  
</I>&gt;<i> (rendering without the scheme and netloc portions) would also  
</I>&gt;<i> prevent this type of link hijacking.  (Though it would be  
</I>&gt;<i> potentially vulnerable to attacks from a sister application.)  But  
</I>&gt;<i> relative-to-root URL generation (as sane default) would negate the  
</I>&gt;<i> need for vhost.VHostMonsterResource in most cases.
</I>&gt;<i>
</I>&gt;<i> However as for fixing VHostMonsterResource, I'd rather just see it  
</I>&gt;<i> die the slow painful death it deserves.  But I think if you're  
</I>&gt;<i> going to limit VHostMonsterResource to one proxy url, you might as  
</I>&gt;<i> well switch to a configuration time rewriter.  Another solution is  
</I>&gt;<i> to simply tag the request as rewritten so it doesn't get mangled a  
</I>&gt;<i> second time, raising the appropriate error code)
</I>&gt;<i>
</I>&gt;<i> -David
</I>&gt;<i>
</I>&gt;<i> &lt;xss-nevow.tac&gt;
</I>
Thanks for your reply!

I'm not sure your PoC encapsulates precisely the problem I described,  
but it is a valid variant which doesn't require as many preconditions  
(but is not possible to exploit in some browsers, such as Safari,  
that won't trust JS from another host even if directly referenced  
from goody). I think I should clarify that in my example, goody.com  
and evil.net are two sites that _are_ indeed served by the same nevow  
application. They each have their own little space on the same  
server, but they don't administer the application serving their  
content. I guess that's what you refer to as &quot;sister applications&quot;.

If anyone is still unclear on my idea of the attack, I'll construct  
another PoC, since the two exploits are fundamentally different.

I'm not familiar with web2.vhost.VHostURIRewrite, but will check it  
out...&quot;Configuration time&quot;, you say. I assume that means at the start  
of the handling of a request, not when the application is set up and  
configured? If so, that sounds like a good solution in many cases.

Only allowing a single &quot;invocation&quot; of the monster resource is  
insufficient in certain situations, namely when <A HREF="http://internalserver:">http://internalserver:</A> 
1234/ is accessible from the outside and not _exclusively_ by the  
reverse proxy. This might also be a problem with the VHostURIRewrite  
approach?

/ Thanks, David
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20051020/4b522254/attachment-0001.htm">http://twistedmatrix.com/pipermail/twisted-web/attachments/20051020/4b522254/attachment-0001.htm</A>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002004.html">[Twisted-web] Preventing XSS when using Nevow's
	vhost	functionality
</A></li>
	<LI>Next message: <A HREF="002005.html">[Twisted-web] Preventing XSS when using Nevow's vhost
	functionality
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2003">[ date ]</a>
              <a href="thread.html#2003">[ thread ]</a>
              <a href="subject.html#2003">[ subject ]</a>
              <a href="author.html#2003">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
