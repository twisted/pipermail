<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] integrating inotify into a protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20integrating%20inotify%20into%20a%20protocol&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004624.html">
   <LINK REL="Next"  HREF="004626.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] integrating inotify into a protocol</H1>
    <B>Jason Pepas</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20integrating%20inotify%20into%20a%20protocol&In-Reply-To="
       TITLE="[Twisted-web] integrating inotify into a protocol">cell at phunware.com
       </A><BR>
    <I>Tue Mar 29 21:21:03 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004624.html">[Twisted-web] Question regarding callLater() and service creation
</A></li>
        <LI>Next message: <A HREF="004626.html">[Twisted-web] integrating inotify into a protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4625">[ date ]</a>
              <a href="thread.html#4625">[ thread ]</a>
              <a href="subject.html#4625">[ subject ]</a>
              <a href="author.html#4625">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hey guys,

I'm new to twisted, and I'm trying to figure out how to integrate the
inotify support into a client protocol.

let's say I have a client protocol which connects to a server and
stays connected, like the &quot;Echo&quot; example here:
<A HREF="http://twistedmatrix.com/documents/10.2.0/core/howto/clients.html#auto3">http://twistedmatrix.com/documents/10.2.0/core/howto/clients.html#auto3</A>

I've taken that example a tweaked it so that it echos back to the
server, rather than to stdout (see echo.py, attached), and takes its
port number as sys.argv[1].

now, I can start the &quot;server&quot;:


  $ cat | socat - tcp4-listen:1234


and start the client:


  $ python echo.py 1234
  Started to connect.
  Connected.


and if I type something into the server, it gets printed on client's
stdout, and then echoed back to the server:


  $ cat | socat - tcp4-listen:1234
  blah
  blah

  $ python foo.py 1234
  Started to connect.
  Connected.
  blah


life is good.

now, let's say I want to integrate inotify support into my persistent
client.  let's say that whenever a new file appears in /tmp, I want to
client to announce this file to the server, over its persistent
connection.  accordingly, I've added 'def announceNewFile()' to the
Echo() protocol class (see echo_inotify, attached).

but herein lies the rub: the inotify notifier just takes a list of
callback functions, not a list of objects.  so how can I get the
notifier to call a method on my Echo protocol object?

another way to say this is that the protocol/client/factory side of
things is all object-oriented, but the inotify side of things is just
procedural.  n'ere the twain shall meet?

specifically, the notifier expects the callback to accept 3 args:
_Watch object, path, and mask.  so, when you try to pass in a class
method as one of its callbacks, you get something like this:

  exceptions.TypeError: unbound method announceNewFile() must be
called with Echo instance as first argument (got _Watch instance
instead)

halp?

-jason
-------------- next part --------------
from twisted.internet.protocol import Protocol, ClientFactory
from sys import stdout

class Echo(Protocol):
    def dataReceived(self, data):
        stdout.write(data)
        self.transport.write(data)

    def announceNewFile(self, watch_obj, path, mask):
        # problem!!! the inotify callback sends three args (watch_obj, path, mask)
        # but we require a reference to self.  halp?
        self.transport.write(msg)

class EchoClientFactory(ClientFactory):
    def startedConnecting(self, connector):
        print 'Started to connect.'

    def buildProtocol(self, addr):
        print 'Connected.'
        return Echo()

    def clientConnectionLost(self, connector, reason):
        print 'Lost connection.  Reason:', reason

    def clientConnectionFailed(self, connector, reason):
        print 'Connection failed. Reason:', reason

if __name__ == &quot;__main__&quot;:
    from twisted.internet import reactor, inotify
    from twisted.python import filepath
    import sys
    reactor.connectTCP(&quot;localhost&quot;, int(sys.argv[1]), EchoClientFactory())

    notifier = inotify.INotify()
    notifier.startReading()
    watch_mask = inotify.IN_CREATE
    notifier.watch(filepath.FilePath(&quot;/tmp&quot;), mask=watch_mask, callbacks=[Echo.announceNewFile])
    # again, there is no way for notifier to actually call the announceNewFile
    # method on an Echo() object, because it doesn't have an Echo() object.  lolwut?

    # speaking generally, the protocol/client/factory situation is all object-oriented,
    # but the inotify stuff if procedure (ie, just a callback function).  how does one
    # reconcile these two realms?
    
    reactor.run()
-------------- next part --------------
from twisted.internet.protocol import Protocol, ClientFactory
from sys import stdout

class Echo(Protocol):
    def dataReceived(self, data):
        stdout.write(data)
        self.transport.write(data)

class EchoClientFactory(ClientFactory):
    def startedConnecting(self, connector):
        print 'Started to connect.'

    def buildProtocol(self, addr):
        print 'Connected.'
        return Echo()

    def clientConnectionLost(self, connector, reason):
        print 'Lost connection.  Reason:', reason

    def clientConnectionFailed(self, connector, reason):
        print 'Connection failed. Reason:', reason

if __name__ == &quot;__main__&quot;:
    from twisted.internet import reactor, inotify
    from twisted.python import filepath
    import sys
    reactor.connectTCP(&quot;localhost&quot;, int(sys.argv[1]), EchoClientFactory())
    reactor.run()
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004624.html">[Twisted-web] Question regarding callLater() and service creation
</A></li>
	<LI>Next message: <A HREF="004626.html">[Twisted-web] integrating inotify into a protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4625">[ date ]</a>
              <a href="thread.html#4625">[ thread ]</a>
              <a href="subject.html#4625">[ subject ]</a>
              <a href="author.html#4625">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
