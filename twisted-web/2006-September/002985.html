<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Re: Nevow and template like files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20Nevow%20and%20template%20like%20files&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002984.html">
   <LINK REL="Next"  HREF="002986.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Re: Nevow and template like files</H1>
    <B>Nuutti Kotivuori</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Re%3A%20Nevow%20and%20template%20like%20files&In-Reply-To="
       TITLE="[Twisted-web] Re: Nevow and template like files">naked at iki.fi
       </A><BR>
    <I>Thu Sep  7 05:18:42 CDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002984.html">[Twisted-web] Re: Nevow and template like files
</A></li>
        <LI>Next message: <A HREF="002986.html">[Twisted-web] Re: Nevow and template like files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2985">[ date ]</a>
              <a href="thread.html#2985">[ thread ]</a>
              <a href="subject.html#2985">[ subject ]</a>
              <a href="author.html#2985">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Valentino Volonghi aka Dialtone wrote:
&gt;<i> On Wed, 06 Sep 2006 11:03:28 +0300, Nuutti Kotivuori &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">naked at iki.fi</A>&gt; wrote:
</I>&gt;&gt;<i> Valentino Volonghi aka Dialtone wrote:
</I>&gt;&gt;<i> Okay, consider the content page shown above. Now let's assume that
</I>&gt;&gt;<i> most pages don't need the &quot;head&quot; pattern at all. I wouldn't want to
</I>&gt;&gt;<i> write the empty pattern on all pages just because it has to be
</I>&gt;&gt;<i> there, instead I would just want to say that put T.invisible()
</I>&gt;&gt;<i> there if the pattern doesn't exist. (With just the &quot;head&quot; pattern
</I>&gt;&gt;<i> it wouldn't be so much of a problem, but I might later on have to
</I>&gt;&gt;<i> add some more, and I don't want to change every content page just
</I>&gt;&gt;<i> because one content page requires something special.)
</I>&gt;<i>
</I>&gt;&gt;<i> So this is what I'd like the default for. But ofcourse, if I load
</I>&gt;&gt;<i> the entire page first, and then just use the inevow.IQ machinery,
</I>&gt;&gt;<i> making the default patterns is easy.
</I>&gt;<i>
</I>&gt;<i> Another solution is to write your own loader by implementing
</I>&gt;<i> inevow.IDocFactory and the using loaders.xmlfile internally so that
</I>&gt;<i> you can catch exceptions and do what you want with the
</I>&gt;<i> behavior. This also sounds reasonable a reasonably easy.
</I>
Yup. This I actually did already. It is used below.

&gt;&gt;&gt;<i> loaded = loaders.xmlfile('file') some_pattern =
</I>&gt;&gt;&gt;<i> inevow.IQ(loaded).onePattern('whatever')
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That seems to work at first - but if there are any macros or render
</I>&gt;&gt;<i> methods inside the file I load, then I get Could not adapt error to
</I>&gt;&gt;<i> IMacroFactory.
</I>&gt;<i>
</I>&gt;<i> Uhmmm... Indeed the problem of the macro factory is not of secondary
</I>&gt;<i> importance. Basically it doesn't make sense to call load() without a
</I>&gt;<i> MacroFactory. This can be solved by building your own WovenContext
</I>&gt;<i> before passing it to the loader.
</I>
I'm still working on this. This would be for the snippet code.

&gt;&gt;&gt;<i> Don't pass the context, what's the problem here?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Macros and render methods. In the case of the snippet pages, I
</I>&gt;&gt;<i> would like them to be interpreted in the context of the Fragment
</I>&gt;&gt;<i> class that is loading the entire snippet page.
</I>&gt;<i>
</I>&gt;<i> That is done by default if you pass the context you are given by any
</I>&gt;<i> of the methods in the Fragment.
</I>
But I need to call externally into the Fragment, so it doesn't go
through any of the normal entrypoints - so I guess I will have to
build the context myself.

&gt;&gt;<i> I understand that the macro is not reloaded - but each macro will
</I>&gt;&gt;<i> load the page once. Which would be a problem on a page with
</I>&gt;&gt;<i> hundreds of snippets if every snippet would cause the page to be
</I>&gt;&gt;<i> loaded once.
</I>&gt;<i>
</I>&gt;<i> It's still a one time cost.
</I>
Yup.

&gt;<i> I'd rewrite the example in the following way:
</I>&gt;<i>
</I>&gt;<i> class TestPage(rend.Page):
</I>&gt;<i>     docFactory = loaders.xmlfile('testpage.xhtml')
</I>&gt;<i>     patternGenerator = None
</I>&gt;<i>
</I>&gt;<i>     def macro_title(self, ctx):
</I>&gt;<i>         return inevow.IQ(self.patternGenerator).onePattern('title')
</I>&gt;<i>
</I>&gt;<i>     def macro_head(self, ctx):
</I>&gt;<i>         return inevow.IQ(self.patternGenerator).onePattern('head')
</I>&gt;<i>
</I>&gt;<i>     def macro_content(self, ctx):
</I>&gt;<i>         return inevow.IQ(self.patternGenerator).onePattern('content')
</I>&gt;<i>
</I>&gt;<i> class DataPage(TestPage):
</I>&gt;<i>     patternGenerator = loaders.xmlfile('datapage.xhtml')
</I>&gt;<i>
</I>&gt;<i>     def macro_test(self, ctx):
</I>&gt;<i>         return 'Test successful.'
</I>
&gt;<i> I think the solution above should work without any problems, except
</I>&gt;<i> I'm not sure that macro_test could actually work at all in nevow
</I>&gt;<i> currently, but it may work.
</I>
The macro_test thing does not work in your example, but did work in my
original example.

&gt;<i> In case you want to avoid to call loaders.xmlfile('datapage.html')
</I>&gt;<i> each time you might try a simple metaclass solution that grabs
</I>&gt;<i> patternGenerator attribute before building the class and changes it
</I>&gt;<i> to be an instance of loaders.xmlfile.
</I>
Not a problem, actually better that way I think.

Okay, I have the first part of my problem now solved, without the
snippet part. This is my solution:

,----[ testsite.py ]
|<i> _no_default = object()
</I>|<i> 
</I>|<i> class patternLoader(loaders.xmlfile):
</I>|<i>     implements(inevow.IDocFactory)
</I>|<i> 
</I>|<i>     def __init__(self, original, pattern, default=_no_default):
</I>|<i>         self.original = original
</I>|<i>         self.pattern = pattern
</I>|<i>         self.default = default
</I>|<i> 
</I>|<i>     def load(self, *args, **kw):
</I>|<i>         doc = self.original.load(*args, **kw)
</I>|<i>         if self.default is _no_default:
</I>|<i>             return inevow.IQ(doc).onePattern(self.pattern)
</I>|<i>         else:
</I>|<i>             try:
</I>|<i>                 return inevow.IQ(doc).onePattern(self.pattern)
</I>|<i>             except stan.NodeNotFound:
</I>|<i>                 return self.default
</I>|<i> 
</I>|<i> class TestPage(rend.Page):
</I>|<i>     docFactory = loaders.xmlfile('testpage.xhtml')
</I>|<i>     datapageFactory = None
</I>|<i> 
</I>|<i>     def macro_title(self, ctx):
</I>|<i>         return patternLoader(self.datapageFactory, 'title')
</I>|<i> 
</I>|<i>     def macro_head(self, ctx):
</I>|<i>         return patternLoader(self.datapageFactory, 'head', T.invisible())
</I>|<i> 
</I>|<i>     def macro_content(self, ctx):
</I>|<i>         return patternLoader(self.datapageFactory, 'content')
</I>|<i> 
</I>|<i> class DataPage(TestPage):
</I>|<i>     datapageFactory = loaders.xmlfile('datapage.xhtml')
</I>|<i> 
</I>|<i>     def macro_test(self, ctx):
</I>|<i>         return 'Test successful.'
</I>`----

It even does the optional part nicely.

Does this look reasonable? I'm diving in the snippet part next.

-- Naked


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002984.html">[Twisted-web] Re: Nevow and template like files
</A></li>
	<LI>Next message: <A HREF="002986.html">[Twisted-web] Re: Nevow and template like files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2985">[ date ]</a>
              <a href="thread.html#2985">[ thread ]</a>
              <a href="subject.html#2985">[ subject ]</a>
              <a href="author.html#2985">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
