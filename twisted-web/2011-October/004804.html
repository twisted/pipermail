<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Using Twisted to process a pool of messages
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Using%20Twisted%20to%20process%20a%20pool%20of%20messages&In-Reply-To=CAB%3DZGGChvFDeoKS1i790vVtGQEoN4Eg8shxHAvFp%3DQCfjmzOZg%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004803.html">
   <LINK REL="Next"  HREF="004805.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Using Twisted to process a pool of messages</H1>
    <B>Phil Mayers</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Using%20Twisted%20to%20process%20a%20pool%20of%20messages&In-Reply-To=CAB%3DZGGChvFDeoKS1i790vVtGQEoN4Eg8shxHAvFp%3DQCfjmzOZg%40mail.gmail.com"
       TITLE="[Twisted-web] Using Twisted to process a pool of messages">p.mayers at imperial.ac.uk
       </A><BR>
    <I>Sun Oct 16 11:08:26 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004803.html">[Twisted-web] Using Twisted to process a pool of messages
</A></li>
        <LI>Next message: <A HREF="004805.html">[Twisted-web] Using Twisted to process a pool of messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4804">[ date ]</a>
              <a href="thread.html#4804">[ thread ]</a>
              <a href="subject.html#4804">[ subject ]</a>
              <a href="author.html#4804">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/16/2011 03:34 PM, AmirBehzad Eslami wrote:

&gt;<i> Now I'm asked to use Twisted to make my python script asynchronous.
</I>&gt;<i> Well, I was  PHP Programmer. I'm wondering how this application could
</I>&gt;<i> become asynchronous.
</I>&gt;<i>
</I>&gt;<i> Let me explain.
</I>&gt;<i> If the first call to the above URL fails to recieve content for some reason,
</I>&gt;<i> what will happen? Does asynchronous mean that Python will invoke
</I>&gt;<i> a new URL to the same URL again? or It will make a new URL call?
</I>
None of the above.

Asynchronous code is not magical. It won't do things you don't tell it to.

In Twisted terms, normally you will call some API which will return a 
&quot;deferred&quot;, which is just a placeholder for the result. You would attach 
a callback, which is called on success, and an errback, which is called 
on failure.

If the URL fetch fails, your errback will be invoked. On the other hand, 
if the URL fetch succeeds but returns no data, your callback will be 
called with an empty result.

Either way - the code you write decides what happens next.

&gt;<i> How can I handle &quot;last_sms_id&quot; during these asynchronous calls?
</I>
It sounds to me like you need to work your way through the Twisted 
tutorial. It's absolutely essential to understand a) how the reactor 
model that Twisted uses schedules your code and b) how Deferreds are 
used to give you results &quot;asynchronously&quot;.

Very briefly, your code might look like something this:

from twisted.python import log
from twisted.internet import task
from twisted.web import client
from twisted.internet import reactor

class Worker:
   def __init__(self):
     self.last_sms_id = None
     self.host = '<A HREF="http://your.server'">http://your.server'</A>

   def start(self):
     self.tsk = task.LoopingCall(self.fetch)
     self.tsk.start(5)

   def fetch(self):
     # We are called every 5 seconds
     # Fetch our URL and return a deferred
     # Attach success/failure callbacks

     if self.last_sms_id is None:
       # first time we've run?
       url = '%s/script' % (self.host,)
     else:
       url = '%s/script?last_sms_id=%s' % (self.host, self.last_sms_id,)

     d = self.client.getPage(url)

     d.addCallback(self.success)

     # because we attach the errback *after* the callback,
     # any errors/exceptions in the callback will go through
     # to the errback, where we can log them...
     d.addErrback(self.failure)

     # If we return a &quot;deferred&quot; from a LoopingCall task
     # the next call won't happen until the deferred has
     # completed; this is probably good
     return d

   def success(self, data):
     # N.B. any errors in this function will result in our errback
     # being called, so we can ignore them here if we want...

     messages = simplejson.loads(data)
     for msg in messages:
         # NOTE: this function should NOT block
         # or you'll block the reactor...
         do_something(msg)
         self.last_sms_id = msg.sms_id

   def failure(self, f):
     # called if either the page fetch failed, or the
     # callback had an error (invalid/empty data)
     # Just log it, and return a &quot;null&quot; reply
     log.msg(&quot;url fetch failed&quot;)
     log.err(f)

def setup():
   w = Worker()
   w.start()

def main():
   log.startLogging(sys.stderr)
   reactor.callWhenRunning(setup)
   reactor.run()

if __name__=='__main__':
   main()


...obviously your &quot;do_something&quot; call will need to handle the messages; 
it might for example use &quot;getPage&quot; to issue an HTTP POST to an 
SMS-sending service, or put them into a queue which another 
task.LoopingCall empties at a pre-defined rate.

Hope this helps clear things up a bit.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004803.html">[Twisted-web] Using Twisted to process a pool of messages
</A></li>
	<LI>Next message: <A HREF="004805.html">[Twisted-web] Using Twisted to process a pool of messages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4804">[ date ]</a>
              <a href="thread.html#4804">[ thread ]</a>
              <a href="subject.html#4804">[ subject ]</a>
              <a href="author.html#4804">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
