<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Cascading forms in formal (example code included)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Cascading%20forms%20in%20formal%20%28example%20code%20included%29&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002689.html">
   <LINK REL="Next"  HREF="002690.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Cascading forms in formal (example code included)</H1>
    <B>Ricky Iacovou</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Cascading%20forms%20in%20formal%20%28example%20code%20included%29&In-Reply-To="
       TITLE="[Twisted-web] Cascading forms in formal (example code included)">iacovou at gmail.com
       </A><BR>
    <I>Wed Jun 14 08:34:12 CDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002689.html">[Twisted-web] [formal] custom error message
</A></li>
        <LI>Next message: <A HREF="002690.html">[Twisted-web] Cascading forms in formal (example code included)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2687">[ date ]</a>
              <a href="thread.html#2687">[ thread ]</a>
              <a href="subject.html#2687">[ subject ]</a>
              <a href="author.html#2687">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Hi there.

I've been wrestling with a Nevow/formal problem for a day now (though it might 
not be formal-specific); I'm hoping someone with more Nevow experience might 
be able to shed some light on the problem.

I've reduced the problem to the Python code below; run it with 'twistd -noy 
file.py' and point your browser to localhost:8080.

The first page is a form; anything you enter gets handled by 
FirstPage.handler(). I want to have this form lead to another form which asks 
for further information based on the input to the first form.

If you enter the string 'test' in the first page, you will go through an 
intermediate static page. Anything else will take you directly to another 
form.

Tv on #twisted.web pointed out that I can return an IResource from a form 
handler. I'm trying to do this here: I create a SecondPage() object and 
return that, but the server goes into an infinite loop, constantly handling 
the first page results (printing, &quot;User string was: &quot; ...).

[In my actual code, I can Ctrl-C the server at this point; in this example 
code, I actually have to Ctrl-Z and kill -9 the server. I don't know why.]

Note that using the static intermediate page (i.e. simply return a TestPage() 
object from FirstPage.handler()) works peachily. In fact, when you access a 
SecondPage instance as a child of the FirstPage (there's a link on the static 
page), it also works.

Does anyone have any idea why returning the second form page directly creates 
an infinite loop?

Thanks,

Ricky

--
Code starts here
--

from twisted.python import util
from twisted.internet import defer
from twisted.application import strports
from twisted.application import service

from nevow import appserver
from nevow import rend
from nevow import loaders
from nevow import tags as T
from nevow import url

import formal


class SecondPage ( formal.ResourceMixin, rend.Page ):

    def form_example ( self, ctx ):
        form = formal.Form()
        form.addField ( 'description',
                        formal.String(),
                        label = &quot;Type Stuff&quot;,
                        description = &quot;For example, 'marmalade'&quot;
                        )

        form.addAction ( self.handler, label = &quot;Go&quot; )
        return form


    def handler ( self, ctx, form, data ):
        print &quot;Form data was: &quot;, data
        # End of form chain; just return a static page.
        return TestPage()


    docFactory = loaders.stan (
        T.html [ T.head [ T.title [ &quot;Second Page&quot; ] ],
                 T.body [ T.directive ( 'form example' ) ] ] )




class FirstPage ( formal.ResourceMixin, rend.Page ):

    def form_example ( self, ctx ):
        form = formal.Form()
        form.addField ( 'user_string',
                        formal.String(),
                        label = &quot;Type Stuff&quot;,
                        description = &quot;Type 'test' to go to TestPage.&quot;
                        )

        form.addAction ( self.handler, label = &quot;Go&quot; )
        return form


    def handler ( self, ctx, form, data ):
        user_string = data [ 'user_string' ]
        print &quot;User string was: &quot;, user_string

        if str ( user_string ) == 'test':
            # This works:
            page = TestPage()
        else:
            # ... but this doesn't:
            page = SecondPage()

        # Also, how to pass in the 'state' (i.e. user_string)? Should we pass
        # it as a construction argument of the Page?

        # In the Real Code we make a call to an XML-RPC server in the handler,
        # which is why we return a deferred here rather than the page itself.
        return defer.succeed ( page )


    # Instantiate a SecondPage so it can be accessed indirectly.
    child_secondPage = SecondPage()


    docFactory = loaders.stan (
        T.html [ T.head [ T.title [ &quot;First Page&quot; ] ],
                 T.body [ T.directive ( 'form example' ) ] ] )


class TestPage ( rend.Page ):
    docFactory = loaders.stan (
        T.html [ T.head [ T.title [ &quot;Test Page&quot; ] ],
                 T.body [ &quot;Visit the &quot;,
                          T.a ( href = '/secondPage' ) [ &quot;Second Page&quot; ] ] ] )


application = service.Application ( 'Broken Forms' )
site        = appserver.NevowSite ( resource = FirstPage() )
server      = strports.service ( &quot;8080&quot;, site )
server.setServiceParent ( application )


--
Code ends here
--

</PRE>





<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002689.html">[Twisted-web] [formal] custom error message
</A></li>
	<LI>Next message: <A HREF="002690.html">[Twisted-web] Cascading forms in formal (example code included)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2687">[ date ]</a>
              <a href="thread.html#2687">[ thread ]</a>
              <a href="subject.html#2687">[ subject ]</a>
              <a href="author.html#2687">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
