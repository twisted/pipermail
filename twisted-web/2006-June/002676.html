<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] integration of HTTP Basic Auth and cred
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20integration%20of%20HTTP%20Basic%20Auth%20and%20cred&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002677.html">
   <LINK REL="Next"  HREF="002678.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] integration of HTTP Basic Auth and cred</H1>
    <B>Manlio Perillo</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20integration%20of%20HTTP%20Basic%20Auth%20and%20cred&In-Reply-To="
       TITLE="[Twisted-web] integration of HTTP Basic Auth and cred">manlio_perillo at libero.it
       </A><BR>
    <I>Sun Jun  4 06:21:20 CDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002677.html">[Twisted-web] trying to resolve half a decade of confusion
</A></li>
        <LI>Next message: <A HREF="002678.html">[Twisted-web] twistedweb install driving me nuts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2676">[ date ]</a>
              <a href="thread.html#2676">[ thread ]</a>
              <a href="subject.html#2676">[ subject ]</a>
              <a href="author.html#2676">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi.

I have written a small module for integrating HTTP Basic Auth and cred.
This is like guard.SessionWrapper.

I'm posting this module here because I'm not sure I'm doing the right thing.


Thanks and regards  Manlio Perillo
-------------- next part --------------
&quot;&quot;&quot;cred integration with HTTP Basic Authentication.
&quot;&quot;&quot;


from zope.interface import Interface, Attribute, implements

from twisted.web import http
from twisted.cred import portal
from twisted.cred.credentials import UsernamePassword, Anonymous
from twisted.cred.error import UnauthorizedLogin

from nevow import inevow, url, stan


class INamedRealm(portal.IRealm):
    # this is used in the HTTP WWW-Authenticate header
    name = Attribute(&quot;The name of the realm&quot;)


class Forbidden(object):
    implements(inevow.IResource)

    def locateChild(self, ctx, segments):
        return self

    def renderHTTP(self, ctx):
        request = inevow.IRequest(ctx)
        request.setResponseCode(http.FORBIDDEN)
        return (&quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;Forbidden&lt;/title&gt;&lt;/head&gt;&quot;
                &quot;&lt;body&gt;&lt;h1&gt;Forbidden&lt;/h1&gt;Request was forbidden.&lt;/body&gt;&lt;/html&gt;&quot;)


def nomind(*args): return None


class HTTPAuthWrapper(object):
    &quot;&quot;&quot;Wrapper for HTTP Basic Authentication
    &quot;&quot;&quot;

    implements(inevow.IResource)

    # The interface to cred for when logging into the portal
    credInterface = inevow.IResource
    resource = None
    
    def __init__(self, portal, mindFactory=None, credInterface=None):
        self.portal = portal
        
        if mindFactory is None:
            mindFactory = nomind
        self.mindFactory = mindFactory
        
        if credInterface is not None:
            self.credInterface = credInterface
        
    def renderHTTP(self, ctx):
        def _cb((iface, res, logout)):
            self.resource = inevow.IResource(res)
            
            req = inevow.IRequest(ctx)

            # XXX remove the Authorization header 
            # (compatibility with guard) 
            del req.getAllHeaders()[&quot;authorization&quot;]

            return self.resource.renderHTTP(ctx)
        
        
        request = inevow.IRequest(ctx)
        realm = self.portal.realm
        
        username, password = request.getUser(), request.getPassword()
        
        # XXX TODO handle anonymous access?
        if (username, password) == ('', ''):
            request.setHeader('WWW-Authenticate', 
                              'Basic realm=&quot;%s&quot;' % realm.name)
            request.setResponseCode(http.UNAUTHORIZED)
            
            # XXX
            return &quot;Authentication required.&quot;
        else:
            credentials = UsernamePassword(username, password)
            mind = self.mindFactory(request, credentials)
            
            d = self.portal.login(credentials, mind,
                                  self.credInterface)
            d.addCallback(_cb)
            d.addErrback(self.incorrectLoginError, ctx)
            
            return d

    def locateChild(self, ctx, segments):
        # XXX not sure
        if not self.resource:
            if not segments:
                return self, ()
            elif not segments[0]:
                return self, ()
            else:
                return None, ()
        else:
            if not segments:
                return self.resource, ()
            elif not segments[0]:
                return self.resource, ()
            else:
                return self.resource.locateChild(ctx, segments)
  
    def incorrectLoginError(self, error, ctx):
        &quot;&quot;&quot;Called on login failure.
        You can override this, as an example placing a limit on the
        number of failed logins.
        &quot;&quot;&quot;
        
        request = inevow.IRequest(ctx)
        realm = self.portal.realm
        
        error.trap(UnauthorizedLogin)

        request.setHeader('WWW-Authenticate', 
                          'Basic realm=&quot;%s&quot;' % realm.name)
        request.setResponseCode(http.UNAUTHORIZED)
        
        # XXX
        return &quot;Authentication failed.&quot;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002677.html">[Twisted-web] trying to resolve half a decade of confusion
</A></li>
	<LI>Next message: <A HREF="002678.html">[Twisted-web] twistedweb install driving me nuts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2676">[ date ]</a>
              <a href="thread.html#2676">[ thread ]</a>
              <a href="subject.html#2676">[ subject ]</a>
              <a href="author.html#2676">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
