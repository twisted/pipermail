<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Cascading forms in formal (example code included)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Cascading%20forms%20in%20formal%20%28example%20code%20included%29&In-Reply-To=200606141634.12993.iacovou%40gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002687.html">
   <LINK REL="Next"  HREF="002694.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Cascading forms in formal (example code included)</H1>
    <B>Matt Goodall</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Cascading%20forms%20in%20formal%20%28example%20code%20included%29&In-Reply-To=200606141634.12993.iacovou%40gmail.com"
       TITLE="[Twisted-web] Cascading forms in formal (example code included)">matt at pollenation.net
       </A><BR>
    <I>Wed Jun 14 16:07:48 CDT 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="002687.html">[Twisted-web] Cascading forms in formal (example code included)
</A></li>
        <LI>Next message: <A HREF="002694.html">[Twisted-web] Cascading forms in formal (example code included)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2690">[ date ]</a>
              <a href="thread.html#2690">[ thread ]</a>
              <a href="subject.html#2690">[ subject ]</a>
              <a href="author.html#2690">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ricky Iacovou wrote:
&gt;<i> Hi there.
</I>&gt;<i> 
</I>&gt;<i> I've been wrestling with a Nevow/formal problem for a day now (though it might 
</I>&gt;<i> not be formal-specific); I'm hoping someone with more Nevow experience might 
</I>&gt;<i> be able to shed some light on the problem.
</I>&gt;<i> 
</I>&gt;<i> I've reduced the problem to the Python code below; run it with 'twistd -noy 
</I>&gt;<i> file.py' and point your browser to localhost:8080.
</I>&gt;<i> 
</I>&gt;<i> The first page is a form; anything you enter gets handled by 
</I>&gt;<i> FirstPage.handler(). I want to have this form lead to another form which asks 
</I>&gt;<i> for further information based on the input to the first form.
</I>&gt;<i> 
</I>&gt;<i> If you enter the string 'test' in the first page, you will go through an 
</I>&gt;<i> intermediate static page. Anything else will take you directly to another 
</I>&gt;<i> form.
</I>&gt;<i> 
</I>&gt;<i> Tv on #twisted.web pointed out that I can return an IResource from a form 
</I>&gt;<i> handler. I'm trying to do this here: I create a SecondPage() object and 
</I>&gt;<i> return that, but the server goes into an infinite loop, constantly handling 
</I>&gt;<i> the first page results (printing, &quot;User string was: &quot; ...).
</I>&gt;<i> 
</I>&gt;<i> [In my actual code, I can Ctrl-C the server at this point; in this example 
</I>&gt;<i> code, I actually have to Ctrl-Z and kill -9 the server. I don't know why.]
</I>&gt;<i> 
</I>&gt;<i> Note that using the static intermediate page (i.e. simply return a TestPage() 
</I>&gt;<i> object from FirstPage.handler()) works peachily. In fact, when you access a 
</I>&gt;<i> SecondPage instance as a child of the FirstPage (there's a link on the static 
</I>&gt;<i> page), it also works.
</I>&gt;<i> 
</I>&gt;<i> Does anyone have any idea why returning the second form page directly creates 
</I>&gt;<i> an infinite loop?
</I>

I suspect it's because when SecondPage sees the request was POST'ed and 
assumes it's a form POST. Processing the POST will re-find the 
FirstPage's form and processes it again which returns a SecondPage, etc.

I'm not sure if that's a bug or a feature/limitation ;-).

Even if SecondPage was rendered correctly after submitting FirstPage, I 
think Formal would have a hard time finding SecondPage's form because 
the URL would resolve to a FirstPage resource.

Interesting.

I'll add a ticket and have a think about it.

The way I've done this sort of thing is to make FirstPage HTTP redirect 
to another URL to display SecondPage, passing data from FirstPage to 
SecondPage using request args. (Hint: return a nevow.url.URL instance 
from FirstPage's form's submit method.)

If there's a lot of data to pass around you might need to resort to 
sessions. Yucky but, hey, it's the web.

It would certainly be nicer to chain form pages together.

Hope this helps, even if it doesn't solve your problem.

- Matt


&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> Ricky
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Code starts here
</I>&gt;<i> --
</I>&gt;<i> 
</I>&gt;<i> from twisted.python import util
</I>&gt;<i> from twisted.internet import defer
</I>&gt;<i> from twisted.application import strports
</I>&gt;<i> from twisted.application import service
</I>&gt;<i> 
</I>&gt;<i> from nevow import appserver
</I>&gt;<i> from nevow import rend
</I>&gt;<i> from nevow import loaders
</I>&gt;<i> from nevow import tags as T
</I>&gt;<i> from nevow import url
</I>&gt;<i> 
</I>&gt;<i> import formal
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> class SecondPage ( formal.ResourceMixin, rend.Page ):
</I>&gt;<i> 
</I>&gt;<i>     def form_example ( self, ctx ):
</I>&gt;<i>         form = formal.Form()
</I>&gt;<i>         form.addField ( 'description',
</I>&gt;<i>                         formal.String(),
</I>&gt;<i>                         label = &quot;Type Stuff&quot;,
</I>&gt;<i>                         description = &quot;For example, 'marmalade'&quot;
</I>&gt;<i>                         )
</I>&gt;<i> 
</I>&gt;<i>         form.addAction ( self.handler, label = &quot;Go&quot; )
</I>&gt;<i>         return form
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     def handler ( self, ctx, form, data ):
</I>&gt;<i>         print &quot;Form data was: &quot;, data
</I>&gt;<i>         # End of form chain; just return a static page.
</I>&gt;<i>         return TestPage()
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     docFactory = loaders.stan (
</I>&gt;<i>         T.html [ T.head [ T.title [ &quot;Second Page&quot; ] ],
</I>&gt;<i>                  T.body [ T.directive ( 'form example' ) ] ] )
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> class FirstPage ( formal.ResourceMixin, rend.Page ):
</I>&gt;<i> 
</I>&gt;<i>     def form_example ( self, ctx ):
</I>&gt;<i>         form = formal.Form()
</I>&gt;<i>         form.addField ( 'user_string',
</I>&gt;<i>                         formal.String(),
</I>&gt;<i>                         label = &quot;Type Stuff&quot;,
</I>&gt;<i>                         description = &quot;Type 'test' to go to TestPage.&quot;
</I>&gt;<i>                         )
</I>&gt;<i> 
</I>&gt;<i>         form.addAction ( self.handler, label = &quot;Go&quot; )
</I>&gt;<i>         return form
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     def handler ( self, ctx, form, data ):
</I>&gt;<i>         user_string = data [ 'user_string' ]
</I>&gt;<i>         print &quot;User string was: &quot;, user_string
</I>&gt;<i> 
</I>&gt;<i>         if str ( user_string ) == 'test':
</I>&gt;<i>             # This works:
</I>&gt;<i>             page = TestPage()
</I>&gt;<i>         else:
</I>&gt;<i>             # ... but this doesn't:
</I>&gt;<i>             page = SecondPage()
</I>&gt;<i> 
</I>&gt;<i>         # Also, how to pass in the 'state' (i.e. user_string)? Should we pass
</I>&gt;<i>         # it as a construction argument of the Page?
</I>&gt;<i> 
</I>&gt;<i>         # In the Real Code we make a call to an XML-RPC server in the handler,
</I>&gt;<i>         # which is why we return a deferred here rather than the page itself.
</I>&gt;<i>         return defer.succeed ( page )
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     # Instantiate a SecondPage so it can be accessed indirectly.
</I>&gt;<i>     child_secondPage = SecondPage()
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     docFactory = loaders.stan (
</I>&gt;<i>         T.html [ T.head [ T.title [ &quot;First Page&quot; ] ],
</I>&gt;<i>                  T.body [ T.directive ( 'form example' ) ] ] )
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> class TestPage ( rend.Page ):
</I>&gt;<i>     docFactory = loaders.stan (
</I>&gt;<i>         T.html [ T.head [ T.title [ &quot;Test Page&quot; ] ],
</I>&gt;<i>                  T.body [ &quot;Visit the &quot;,
</I>&gt;<i>                           T.a ( href = '/secondPage' ) [ &quot;Second Page&quot; ] ] ] )
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> application = service.Application ( 'Broken Forms' )
</I>&gt;<i> site        = appserver.NevowSite ( resource = FirstPage() )
</I>&gt;<i> server      = strports.service ( &quot;8080&quot;, site )
</I>&gt;<i> server.setServiceParent ( application )
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Code ends here
</I>&gt;<i> --
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>

-- 
      __
     /  \__     Matt Goodall, Pollenation Internet Ltd
     \__/  \    w: <A HREF="http://www.pollenation.net">http://www.pollenation.net</A>
   __/  \__/    e: <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">matt at pollenation.net</A>
  /  \__/  \    t: +44 (0)113 2252500
  \__/  \__/
  /  \	       Any views expressed are my own and do not necessarily
  \__/          reflect the views of my employer.

</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002687.html">[Twisted-web] Cascading forms in formal (example code included)
</A></li>
	<LI>Next message: <A HREF="002694.html">[Twisted-web] Cascading forms in formal (example code included)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2690">[ date ]</a>
              <a href="thread.html#2690">[ thread ]</a>
              <a href="subject.html#2690">[ subject ]</a>
              <a href="author.html#2690">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
