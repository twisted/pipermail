<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Enforcing SSL for non-SSL requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Enforcing%20SSL%20for%20non-SSL%20requests&In-Reply-To=60ed19d4050809183048017fba%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001809.html">
   <LINK REL="Next"  HREF="001813.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Enforcing SSL for non-SSL requests</H1>
    <B>Marek Habersack</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Enforcing%20SSL%20for%20non-SSL%20requests&In-Reply-To=60ed19d4050809183048017fba%40mail.gmail.com"
       TITLE="[Twisted-web] Enforcing SSL for non-SSL requests">grendel at caudium.net
       </A><BR>
    <I>Wed Aug 10 03:45:45 MDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001809.html">[Twisted-web] Enforcing SSL for non-SSL requests
</A></li>
        <LI>Next message: <A HREF="001813.html">[Twisted-web] Enforcing SSL for non-SSL requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1812">[ date ]</a>
              <a href="thread.html#1812">[ thread ]</a>
              <a href="subject.html#1812">[ subject ]</a>
              <a href="author.html#1812">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Aug 10, 2005 at 11:30:42AM +1000, Christopher Armstrong scribbled:
&gt;<i> On 8/10/05, Marek Habersack &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">grendel at caudium.net</A>&gt; wrote:
</I>&gt;<i> &gt; Hello everybody,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;   I'm trying to find a way for a Nevow-based application to enforce SSL
</I>&gt;<i> &gt; connection on the client when they come in using insecure HTTP. Currently
</I>&gt;<i> &gt; when the client comes in using a <A HREF="http://site.com">http://site.com</A> URL typed in the browser,
</I>&gt;<i> &gt; they will get no error and no response from the server as the connection is
</I>&gt;<i> &gt; closed. The application log reveals the following:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My application started out using twisted.web.util.ChildRedirector to
</I>&gt;<i> the https URL for *all* plain http requests, but then we realised we
</I>&gt;<i> needed some resources to be accessible over non-HTTPS (for various
</I>&gt;<i> boring reasons) we wrote our own FancyRedirectory that looked a lot
</I>&gt;<i> like ChildRedirector but made exceptions for certain paths in
</I>&gt;<i> getChild.
</I>That sounds simple and logical, but I'm having trouble fitting it in my
code, so forgive my ignorance, please, and bear with me while I ask a few more
stupid and obvious questions :). My application will use very few static
resources and all the virtual ones will be handled by a single class,
MainPage, which will call down to non-twisted/nevow code for specific urls
to handle requests. The entire application is guarded with
guard.SessionWrapper and requires the user to log in to access any and all
resources. Here is the code fragment that sets this up:

realm = SCRealm()
portl = portal.Portal(realm)
sCChecker = checkers.InMemoryUsernamePasswordDatabaseDontUse()
sCChecker.addUser(&quot;test&quot;, &quot;test&quot;)
portl.registerChecker(checkers.AllowAnonymousAccess(),credentials.IAnonymous)
portl.registerChecker(sCChecker)
root = guard.SessionWrapper(portl, &quot;SC&quot;, useCookies=True)
application = service.Application(&quot;SC&quot;)

internet.SSLServer(8080,
                   appserver.NevowSite(root, logPath=config.web_log_path),
                   ServerContextFactory()).setServiceParent(application)

Very simple, but works well. Then the SCRealm class:

class SCRealm:
    implements(portal.IRealm)

    def prepareI18N(self, p):
        p.remember(I18NConfig(domain=&quot;sc&quot;,localeDir=config.localeDirectory), inevow.II18NConfig)
        return p
    
    def requestAvatar(self, avatarId, mind, *interfaces):
        for iface in interfaces:
            if iface is inevow.IResource:
                resc = None
                if avatarId is checkers.ANONYMOUS:
                    resc = self.prepareI18N(MainPage.MainPage())
                    logoutCallable = noLogout
                else:
                    resc = self.prepareI18N(MainPage.MainPage(avatarId))
                    logoutCallable = resc.logout
                if resc is not None:
                    resc.realm = self
                    
                return (inevow.IResource, resc, logoutCallable)
        raise NotImplementedError(_(&quot;Cannot support this interface&quot;))

So, I suppose I could use the redirector class instead of MainPage.MainPage()
(or derive MainPage.MainPage from ChildRedirector) above, but it will still 
come after the internet.SSLServer attempts to handle the connection. What I'm 
not seeing is - how can I layout the setup code above so that I can put the 
redirector before the portal (I guess I could handle that inside the
requestAvatar method when avatarId is checkers.ANONYMOUS and do the redirect
there instead of presenting the login form) and how to handle the SSLServer's 
exception shown in the previous mail. A short code example on how to handle 
the exception would be greately appreciated ;)

I would love to avoid having to listen on two different ports to handle that, 
so the ideal thing to have would be a ConditionalSSLServer class which would start 
the SSL session if the client started the SSL handshake and would let the
programmer handle the situation when the incoming connection is a plain one.
How hard would it be to implement such a thing?

thanks a lot,

marek
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 189 bytes
Desc: Digital signature
Url : <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20050810/91826bb8/attachment.bin">http://twistedmatrix.com/pipermail/twisted-web/attachments/20050810/91826bb8/attachment.bin</A>
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001809.html">[Twisted-web] Enforcing SSL for non-SSL requests
</A></li>
	<LI>Next message: <A HREF="001813.html">[Twisted-web] Enforcing SSL for non-SSL requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1812">[ date ]</a>
              <a href="thread.html#1812">[ thread ]</a>
              <a href="subject.html#1812">[ subject ]</a>
              <a href="author.html#1812">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
