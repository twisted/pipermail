<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Trouble with flex file-uploading and twisted.web2	FileSaver
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Trouble%20with%20flex%20file-uploading%20and%20twisted.web2%0A%09FileSaver&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004310.html">
   <LINK REL="Next"  HREF="004312.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Trouble with flex file-uploading and twisted.web2	FileSaver</H1>
    <B>Daniel Yang</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Trouble%20with%20flex%20file-uploading%20and%20twisted.web2%0A%09FileSaver&In-Reply-To="
       TITLE="[Twisted-web] Trouble with flex file-uploading and twisted.web2	FileSaver">daniel.yang.zhenyu at gmail.com
       </A><BR>
    <I>Thu Aug 20 11:20:43 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004310.html">[Twisted-web] Invitation to connect on LinkedIn
</A></li>
        <LI>Next message: <A HREF="004312.html">[Twisted-web] Trouble with flex file-uploading and	twisted.web2	FileSaver
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4311">[ date ]</a>
              <a href="thread.html#4311">[ thread ]</a>
              <a href="subject.html#4311">[ subject ]</a>
              <a href="author.html#4311">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi team,

I've been trying to upload files to twisted.web2 backend(FileSaver) with
Adobe Flex and I am always getting IOError.
(code see below)
After some sniffing work, I found the error messages returned by
twisted.web2:

Unexpected data on same line as boundary: '--'

I believe this flex app works with php backend. So this might be with
twisted.web2 or flash player's malformed post data.

It seems the twisted error comes from fileupload.py:
(I added 2 prints)
    def _readBoundaryLine(self):
        print &quot;_readBoundaryLine&quot;
        line = self.stream.readline(size=1024)
        if isinstance(line, defer.Deferred):
            line = defer.waitForDeferred(line)
            yield line
            line = line.getResult()
        print line
        if line == &quot;--\r\n&quot;:
            # THE END!
            yield False
            return
        elif line != &quot;\r\n&quot;:
            raise MimeFormatError(&quot;Unexpected data on same line as boundary:
%r&quot; % (line,))
        yield True
        return
    _readBoundaryLine = defer.deferredGenerator(_readBoundaryLine)

with html uploading form, it outputs:

2009-08-20 23:06:08+0800 [-] _readBoundaryLine
2009-08-20 23:06:08+0800 [-] --
2009-08-20 23:06:08+0800 [-]
2009-08-20 23:06:08+0800 [-] &lt;POST /upload (1, 1)&gt; --------
2009-08-20 23:06:08+0800 [-] FileUpload


but with flex uploading:

2009-08-20 23:06:27+0800 [-] _readBoundaryLine
2009-08-20 23:06:27+0800 [-]
2009-08-20 23:06:27+0800 [-]
2009-08-20 23:06:27+0800 [-] _readBoundaryLine
2009-08-20 23:06:27+0800 [-]
2009-08-20 23:06:27+0800 [-]
2009-08-20 23:06:27+0800 [-] _readBoundaryLine
2009-08-20 23:06:27+0800 [-] --


Same file, different posted data.

Any ideas?

Does this happen to be a bug, or is there any way to walk around this?


My testing code:

python code:

from twisted.web2 import http_headers, resource, \
static, server, channel, http, responsecode
from twisted.python import util

FORMHTML = &quot;&quot;&quot;
&lt;html&gt;
&lt;p&gt;for test&lt;/p&gt;
&lt;form action=&quot;/upload&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;
&lt;input type=&quot;file&quot; name=&quot;FileUpload&quot; /&gt;
&lt;input type=&quot;submit&quot; value=&quot;Upload&quot;/&gt;
&lt;/form&gt;
&lt;/html&gt;
&quot;&quot;&quot;

class MyFileSaver(static.FileSaver):
&quot;&quot;&quot;for test only&quot;&quot;&quot;
def render(self, req):
print req, '--------'
if req.files:
for fieldName in req.files:
print fieldName

return http.Response(responsecode.OK, {}, stream='ok')


class Toplevel(resource.Resource):
  addSlash = True
  def render(self, ctx):
return http.Response(stream=FORMHTML)

  child_upload = MyFileSaver(util.sibpath(__file__, ''),
   expectedFields=['FileUpload'],
   allowedTypes=(
   http_headers.MimeType('image', 'jpeg'),
   http_headers.MimeType('image', 'png'),
   http_headers.MimeType('image', 'gif'),
   )
   )
  child_swf = static.File(util.sibpath(__file__, 'FileUpload.swf'))
site = server.Site(Toplevel())

# Standard twisted application Boilerplate
from twisted.application import service, strports
application = service.Application(&quot;demoserver&quot;)
s = strports.service('tcp:8080', channel.HTTPFactory(site))
s.setServiceParent(application)


My flex code:

&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;

&lt;!--
<A HREF="http://blog.flexexamples.com/2007/09/21/uploading-files-in-flex-using-the-filereference-class/--">http://blog.flexexamples.com/2007/09/21/uploading-files-in-flex-using-the-filereference-class/--</A>&gt;

&lt;mx:Application xmlns:mx=&quot;<A HREF="http://www.adobe.com/2006/mxml&quot;">http://www.adobe.com/2006/mxml&quot;</A>

        layout=&quot;vertical&quot;

        verticalAlign=&quot;middle&quot;

        backgroundColor=&quot;white&quot;

        creationComplete=&quot;init();&quot;&gt;


    &lt;mx:Script&gt;

        &lt;![CDATA[

            private var fileRef:FileReference;


            private const FILE_UPLOAD_URL:String = &quot;
<A HREF="http://127.0.0.1:8080/upload&quot;;">http://127.0.0.1:8080/upload&quot;;</A>


            private function init():void {

                fileRef = new FileReference();

                fileRef.addEventListener(Event.SELECT, fileRef_select);

                fileRef.addEventListener(ProgressEvent.PROGRESS,
fileRef_progress);

                fileRef.addEventListener(Event.COMPLETE, fileRef_complete);


fileRef.addEventListener(IOErrorEvent.IO_ERROR,ioErrorHandler);

                fileRef.addEventListener(SecurityErrorEvent.SECURITY_ERROR,
onSec);

            }


            private function browseAndUpload():void {

                fileRef.browse();

                message.text = &quot;&quot;;

            }



            private function ioErrorHandler(event:IOErrorEvent):void {

            trace(event);

            }



            private function onSec(event:SecurityErrorEvent):void{

            trace(event);

            }


            private function fileRef_select(evt:Event):void {

                try {

                    message.text = &quot;size (bytes): &quot; +
numberFormatter.format(fileRef.size);



                    var req:URLRequest = new URLRequest();

                    req.url = FILE_UPLOAD_URL;

                    req.method = URLRequestMethod.POST;



                    fileRef.upload(req, &quot;FileUpload&quot;);

                } catch (err:Error) {

                    message.text = &quot;ERROR: zero-byte file&quot;;

                }

            }


            private function fileRef_progress(evt:ProgressEvent):void {

                progressBar.visible = true;

            }


            private function fileRef_complete(evt:Event):void {

                message.text += &quot; (complete)&quot;;

                progressBar.visible = false;

            }

        ]]&gt;

    &lt;/mx:Script&gt;


    &lt;mx:NumberFormatter id=&quot;numberFormatter&quot; /&gt;


    &lt;mx:Button label=&quot;Upload file&quot;

            click=&quot;browseAndUpload();&quot; /&gt;

    &lt;mx:Label id=&quot;message&quot; /&gt;

    &lt;mx:ProgressBar id=&quot;progressBar&quot;

            indeterminate=&quot;true&quot;

            visible=&quot;false&quot; /&gt;


&lt;/mx:Application&gt;


-- 
-----------------------------------------------
Yours
Faithfully

Daniel Yang
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20090820/942d938b/attachment-0001.htm">http://twistedmatrix.com/pipermail/twisted-web/attachments/20090820/942d938b/attachment-0001.htm</A> 
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004310.html">[Twisted-web] Invitation to connect on LinkedIn
</A></li>
	<LI>Next message: <A HREF="004312.html">[Twisted-web] Trouble with flex file-uploading and	twisted.web2	FileSaver
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4311">[ date ]</a>
              <a href="thread.html#4311">[ thread ]</a>
              <a href="subject.html#4311">[ subject ]</a>
              <a href="author.html#4311">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
