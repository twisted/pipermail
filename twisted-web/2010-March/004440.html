<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Web client through https proxy - is it even	possible?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Web%20client%20through%20https%20proxy%20-%20is%20it%20even%0A%09possible%3F&In-Reply-To=7b8169171003171754v22eb3958xe88f5796a35a96f5%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004435.html">
   <LINK REL="Next"  HREF="004436.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Web client through https proxy - is it even	possible?</H1>
    <B>Bruno Harbulot</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Web%20client%20through%20https%20proxy%20-%20is%20it%20even%0A%09possible%3F&In-Reply-To=7b8169171003171754v22eb3958xe88f5796a35a96f5%40mail.gmail.com"
       TITLE="[Twisted-web] Web client through https proxy - is it even	possible?">Bruno.Harbulot at manchester.ac.uk
       </A><BR>
    <I>Fri Mar 19 13:36:54 EDT 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="004435.html">[Twisted-web] Web client through https proxy - is it even possible?
</A></li>
        <LI>Next message: <A HREF="004436.html">[Twisted-web] Newbie question on handling args in URL string
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4440">[ date ]</a>
              <a href="thread.html#4440">[ thread ]</a>
              <a href="subject.html#4440">[ subject ]</a>
              <a href="author.html#4440">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm not sure how this would work with the twisted web client, but I've 
managed to get it to work in this library 
<A HREF="http://code.google.com/p/python-httpclient/">http://code.google.com/p/python-httpclient/</A> (which can also verify 
certificates, btw).

You don't need to send the Host header with CONNECT as far as I'm aware. 
You might want to wait until you read the 200 OK status code (or some 
other code if it fails) in response to CONNECT before turning the socket 
into an SSL socket.

Best wishes,

Bruno.


Matt Pruden wrote:
&gt;<i> I'm trying to post some data to a web server, but need to go through
</I>&gt;<i> an https proxy.  I can't seem to find anyone that's pulled this off
</I>&gt;<i> with a twisted web client.   I've been sniffing traffic and have it
</I>&gt;<i> close, but can't quite get past creating the SSL socket.  Anything I
</I>&gt;<i> attempt to write to the transport after swapping out the standard
</I>&gt;<i> socket for SSL.Connection fails the SSL handshake on the remote end.
</I>&gt;<i> 
</I>&gt;<i> Here's the code so far:
</I>&gt;<i> class MyProtocol(client.HTTPPageGetter):
</I>&gt;<i> 
</I>&gt;<i>     got_connect = False
</I>&gt;<i> 
</I>&gt;<i>     def connectionMade(self):
</I>&gt;<i>         proxy = os.environ.get('https_proxy')
</I>&gt;<i>         if proxy:
</I>&gt;<i>             self.transport.write('CONNECT %s:%s HTTP/1.0\r\n' %
</I>&gt;<i> (self.factory.host, self.factory.port))
</I>&gt;<i>             self.sendHeader('Host', self.factory.headers.get(&quot;host&quot;,
</I>&gt;<i> self.factory.host))
</I>&gt;<i>             self.sendHeader('User-Agent', self.factory.agent)
</I>&gt;<i>             self.transport.write('\r\n')
</I>&gt;<i>         else:
</I>&gt;<i>             self.got_connect = True
</I>&gt;<i> 
</I>&gt;<i>         if self.got_connect:
</I>&gt;<i>             client.HTTPPageGetter.connectionMade(self)
</I>&gt;<i> 
</I>&gt;<i>     def lineReceived(self, line):
</I>&gt;<i>         if not self.got_connect:
</I>&gt;<i>             self.got_connect == True
</I>&gt;<i>             ctx = ssl.ClientContextFactory()
</I>&gt;<i>             self.transport.stopReading()
</I>&gt;<i>             self.transport.stopWriting()
</I>&gt;<i>             self.transport.socket = SSL.Connection(ctx.getContext(),
</I>&gt;<i>                                                 self.transport.socket)
</I>&gt;<i>             self.transport.fileno = self.transport.socket.fileno
</I>&gt;<i>             self.transport.startReading()
</I>&gt;<i>             client.HTTPPageGetter.connectionMade(self)
</I>&gt;<i>         else:
</I>&gt;<i>             client.HTTPPageGetter.lineReceived(self, line)
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004435.html">[Twisted-web] Web client through https proxy - is it even possible?
</A></li>
	<LI>Next message: <A HREF="004436.html">[Twisted-web] Newbie question on handling args in URL string
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4440">[ date ]</a>
              <a href="thread.html#4440">[ thread ]</a>
              <a href="subject.html#4440">[ subject ]</a>
              <a href="author.html#4440">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
