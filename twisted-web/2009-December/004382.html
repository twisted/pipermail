<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] [Athena] Is ReliableMessageDelivery really	necessary?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20%5BAthena%5D%20Is%20ReliableMessageDelivery%20really%0A%09necessary%3F&In-Reply-To=20090701214550.22176.727267859.divmod.quotient.11784%40henry.divmod.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004381.html">
   <LINK REL="Next"  HREF="004383.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] [Athena] Is ReliableMessageDelivery really	necessary?</H1>
    <B>Paul Thomas</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20%5BAthena%5D%20Is%20ReliableMessageDelivery%20really%0A%09necessary%3F&In-Reply-To=20090701214550.22176.727267859.divmod.quotient.11784%40henry.divmod.com"
       TITLE="[Twisted-web] [Athena] Is ReliableMessageDelivery really	necessary?">spongelavapaul at googlemail.com
       </A><BR>
    <I>Mon Dec  7 17:16:44 EST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="004381.html">[Twisted-web] ANN: Twisted 9.0.0
</A></li>
        <LI>Next message: <A HREF="004383.html">[Twisted-web] [Athena] Is ReliableMessageDelivery	really	necessary?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4382">[ date ]</a>
              <a href="thread.html#4382">[ thread ]</a>
              <a href="subject.html#4382">[ subject ]</a>
              <a href="author.html#4382">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 1 Jul 2009, at 22:45, Jean-Paul Calderone wrote:

&gt;<i> On Wed, 1 Jul 2009 11:15:35 +0100, Paul Thomas &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">spongelavapaul at googlemail.com</A> 
</I>&gt;<i> &gt; wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've hit a problem as my app has got bigger (about 30-40 widgets  
</I>&gt;&gt;<i> now,  all
</I>&gt;&gt;<i> chattering roughly once every 2 seconds) where the reliable  message
</I>&gt;&gt;<i> delivery mechanism is spiralling out of control. It seems that  the  
</I>&gt;&gt;<i> constant
</I>&gt;&gt;<i> back and forth means that large 'baskets' of messages are  resent.  
</I>&gt;&gt;<i> The more
</I>&gt;&gt;<i> this happens, the busier everything gets until the  browser becomes
</I>&gt;&gt;<i> unresponsive.
</I>&gt;<i>
</I>&gt;<i> If you can produce a minimal example which demonstrates this  
</I>&gt;<i> behavior, it
</I>&gt;<i> would probably be very helpful in improving the situation.
</I>
It's been quite some time, but I may have time to look into this soon  
(meaning in the next few months).

I have a minimal example code, but it's a bit big - does this need to  
be in a ticket somewhere?

Paul.

8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----
// resources/css/test1.css

#workspace &gt; div {
     display: inline-block;
     margin: 10px;
     padding: 5px;
     border: 1px solid black;
}

#workspace &gt; div p {
     margin: 0;
     padding: 0;
     font-size: 10pt;
}

h3 {
     font-size: 12pt;
     margin: 0;
     padding: 0;
}
8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----
// resources/js/widgets/Status.js

// import Divmod
// import Nevow.Athena

Nevow.Athena.Widget.subclass(Status, 'SimpleStatus').methods(
     function __init__(self, node) {
         Status.SimpleStatus.upcall(self, '__init__', node);
         self.contentP = node.getElementsByTagName(&quot;p&quot;)[0];
         self.count = 0
     },

     function update(self, count) {
         self.contentP.innerHTML = &quot;T: &quot; + count;
         if( count != self.count + 1 ){
             self.node.style.background = &quot;red&quot;;
         }
         self.count = count

     }
);
8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----8&lt;-----
// test1.py
from os import path
from logging import getLogger, basicConfig, INFO, DEBUG, WARN
from random import random

from twisted.internet import reactor
from twisted.python.log import ILogObserver, PythonLoggingObserver

from nevow.athena import LivePage, LiveElement, AutoJSPackage, expose,  
renderer
from nevow import loaders, tags as T, static

#from guppy import hpy
#h = hpy()

basicConfig(level=DEBUG)
#heap_log = getLogger('heap')
#getLogger('twisted').setLevel(WARN)

def heap_poll():
     heap_log.debug(&quot;==== HEAP =====&quot;)
     heap_log.debug(h.heap())
     reactor.callLater(5, heap_poll)

#reactor.callWhenRunning(heap_poll)

_RESOURCE_DIR = path.join(path.dirname(path.abspath(__file__)),  
'resources')

log = getLogger('comet-test1')

class SimpleStatus(LiveElement):
     jsClass = u'Status.SimpleStatus'
     docFactory = loaders.stan(T.div(render=T.directive('liveElement'),
                                     class_='widget')[
         T.div(class_='widget-header', render=T.directive('title')),
         T.div(class_='widget-editbox'),
         T.div(class_='widget-content')[
             T.p['None']]])

     def __init__(self, id):
         super(SimpleStatus, self).__init__()
         self.num = id
         self.count = 0
         reactor.callLater(int(random() * 2 + 1), self._poll)

     def _poll(self):
         self.count += 1
         self.callRemote('update', self.count)
         reactor.callLater(random() * 2 + 1, self._poll)

     @renderer
     def title(self, req, tag):
         return tag[T.h3['Widget %d' % self.num]]

     @expose
     def getSomething(self, name):
         log.debug('getSomething(%r)' % name)
         return 'Not sure'

class Root(LivePage):
     docFactory = loaders.stan(
         T.html[
             T.head(render=T.directive('liveglue'))[
                 T.title['Comet Test 1'],
                 T.link(rel='stylesheet', type='text/css',
                        href='css/test1.css')],
             T.body[
                 T.div(id='workspace', class_='widget-place')[
                     [T.div(render=T.directive('simpleStatus'))] * 50
                 ]]])
     addSlash = True

     children = {
         'css': static.File(path.join(_RESOURCE_DIR,'css')),
         'js': static.File(path.join(_RESOURCE_DIR,'js'))}

     def __init__(self):
         super(Root, self).__init__()
         self.jsModules.mapping.update(AutoJSPackage(path.join(
             _RESOURCE_DIR,'js','widgets')).mapping)
         log.info(str(self.jsModules.mapping))
         self.next_id = 1

     def child_(self, ctx):
         return Root()

     def render_simpleStatus(self,ctx,data):
         f = SimpleStatus(self.next_id)
         self.next_id += 1
         f.setFragmentParent(self)
         return ctx.tag[f]

from nevow import appserver
from twisted.application import service, internet

site = appserver.NevowSite(Root())

application = service.Application(&quot;Test 1&quot;)
webService = internet.TCPServer(8080, site)
webService.setServiceParent(application)

application.setComponent(ILogObserver, PythonLoggingObserver().emit)


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004381.html">[Twisted-web] ANN: Twisted 9.0.0
</A></li>
	<LI>Next message: <A HREF="004383.html">[Twisted-web] [Athena] Is ReliableMessageDelivery	really	necessary?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4382">[ date ]</a>
              <a href="thread.html#4382">[ thread ]</a>
              <a href="subject.html#4382">[ subject ]</a>
              <a href="author.html#4382">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
