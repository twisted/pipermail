<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Twisted Web Agent configurable Elliptic Curves settings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20Twisted%20Web%20Agent%20configurable%20Elliptic%20Curves%0A%20settings&In-Reply-To=%3CCBCE3A4F-3942-4BFE-9FE9-DA6BD77C62B0%40twistedmatrix.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005293.html">
   <LINK REL="Next"  HREF="005295.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Twisted Web Agent configurable Elliptic Curves settings</H1>
    <B>Glyph Lefkowitz</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20Twisted%20Web%20Agent%20configurable%20Elliptic%20Curves%0A%20settings&In-Reply-To=%3CCBCE3A4F-3942-4BFE-9FE9-DA6BD77C62B0%40twistedmatrix.com%3E"
       TITLE="[Twisted-web] Twisted Web Agent configurable Elliptic Curves settings">glyph at twistedmatrix.com
       </A><BR>
    <I>Thu Apr 27 02:30:36 MDT 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005293.html">[Twisted-web] Twisted Web Agent configurable Elliptic Curves	settings
</A></li>
        <LI>Next message (by thread): <A HREF="005295.html">[Twisted-web] Twisted Web Agent configurable Elliptic Curves	settings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5294">[ date ]</a>
              <a href="thread.html#5294">[ thread ]</a>
              <a href="subject.html#5294">[ subject ]</a>
              <a href="author.html#5294">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
&gt;<i> On Apr 26, 2017, at 10:32 AM, Paul Tremberth &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">paul.tremberth at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> The other day, we had a Scrapy user report an issue connecting to <A HREF="https://www.skelbiu.lt/">https://www.skelbiu.lt/</A> &lt;<A HREF="https://www.skelbiu.lt/">https://www.skelbiu.lt/</A>&gt; with OpenSSL 1.1 [1]
</I>
Thanks for passing this issue on!  Always nice to have users engaging directly with us rather than trying janky workarounds :).

&gt;<i> To not mix scrapy's things with Twisted Web, I used this (adapted from official docs):
</I>
That's a good example to use, yes.

&gt;<i> And I did get a Handshake failure too:
</I>&gt;<i> 
</I>&gt;<i>     $ python twistedtest.py 
</I>&gt;<i>     [Failure instance: Traceback (failure with no frames): &lt;class 'twisted.web._newclient.ResponseNeverReceived'&gt;: [&lt;twisted.python.failure.Failure OpenSSL.SSL.Error: [('SSL routines', 'ssl3_read_bytes', 'sslv3 alert handshake failure')]&gt;]
</I>&gt;<i>     ]
</I>&gt;<i> 
</I>&gt;<i> It seems this happens (at least) with OpenSSL 1.1.0e (currently in Debian 9 sid [2])
</I>&gt;<i> It does not happen (for me) with OpenSSL 1.0.2g for example.
</I>
What platform are you on?  How do you know what version of OpenSSL you're using?  (It can sometimes be quite tricky to suss out what OpenSSL twisted is using unless you know the internals fairly well, unfortunately; 'twist --version' really ought to print it out.)

&gt;<i> I dug into this this afternoon and narrowed it down to the use of 
</I>&gt;<i> _defaultCurveName = u&quot;prime256v1&quot;
</I>&gt;<i> in twisted.internet._sslverify.py
</I>&gt;<i> 
</I>&gt;<i> I tried patching the current trunk with _defaultCurveName = u&quot;secp384r1&quot; (the EC that ssllabs.com &lt;<A HREF="http://ssllabs.com/">http://ssllabs.com/</A>&gt; reports)
</I>&gt;<i> and it did work.
</I>&gt;<i> 
</I>&gt;<i> Looking at ClientHello messages for openssl 1.0.2 and 1.1 [4]:
</I>&gt;<i> with 1.1, only 1 Elliptic Curve is sent by Twisted Web Agent, secp256r1
</I>
What about with 1.0.2?

&gt;<i> openssl v1.1 client uses 4 by default: ecdh_x25519, secp256r1, secp521r1, secp384r1
</I>&gt;<i> 
</I>&gt;<i> I was wondering what is the proper way to configure requested Elliptic Curves.
</I>&gt;<i> I haven't seen any interface for this, contrary to ciphers with acceptableCiphers.
</I>
It's possible that there should be an interface for this, but, your issue should not be fixed with an API to work around this bug.  It should be fixed with a fix for this bug.

My understanding is that Twisted just configures one curve, whereas OpenSSL configures 4.

Twisted should just configure all 4 (unless there's some security reason not to match OpenSSL's behavior, which we should probably check on).

Just guessing based on what I see here, I imagine that would mean getting rid of the _ecCurve attribute, and instead having an _ecCurves = something; then, getting rid of the call to SSL_CTX_set_tmp_ecdh and instead using SSL_CTX_set1_curves, as <A HREF="https://github.com/openssl/openssl/commit/6977e8ee4a718a76351ba5275a9f0be4e530eab5">https://github.com/openssl/openssl/commit/6977e8ee4a718a76351ba5275a9f0be4e530eab5</A> &lt;<A HREF="https://github.com/openssl/openssl/commit/6977e8ee4a718a76351ba5275a9f0be4e530eab5">https://github.com/openssl/openssl/commit/6977e8ee4a718a76351ba5275a9f0be4e530eab5</A>&gt; seems to indicate that's how you have to request multiple curves at once.

Twisted should just fix this, not make it configurable.  Later, for security testing purposes, we may want to make it a fine-grained configurable thing, but for right now the priority should be getting correct behavior into a release.

&gt;<i> Thank you for your input.
</I>
Thanks for using Twisted!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20170427/869f902d/attachment.html">http://twistedmatrix.com/pipermail/twisted-web/attachments/20170427/869f902d/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005293.html">[Twisted-web] Twisted Web Agent configurable Elliptic Curves	settings
</A></li>
	<LI>Next message (by thread): <A HREF="005295.html">[Twisted-web] Twisted Web Agent configurable Elliptic Curves	settings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5294">[ date ]</a>
              <a href="thread.html#5294">[ thread ]</a>
              <a href="subject.html#5294">[ subject ]</a>
              <a href="author.html#5294">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
