<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Twisted Web Agent configurable Elliptic Curves	settings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20Twisted%20Web%20Agent%20configurable%20Elliptic%20Curves%0A%09settings&In-Reply-To=%3CCAELvJCv_9m3q4KvQ86NsyaQq7%2B5%2BVQZQ8b19tzqsb3SrcjM3%2Bw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=utf-8">
   <LINK REL="Previous"  HREF="005292.html">
   <LINK REL="Next"  HREF="005294.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Twisted Web Agent configurable Elliptic Curves	settings</H1>
    <B>Paul Tremberth</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=Re%3A%20%5BTwisted-web%5D%20Twisted%20Web%20Agent%20configurable%20Elliptic%20Curves%0A%09settings&In-Reply-To=%3CCAELvJCv_9m3q4KvQ86NsyaQq7%2B5%2BVQZQ8b19tzqsb3SrcjM3%2Bw%40mail.gmail.com%3E"
       TITLE="[Twisted-web] Twisted Web Agent configurable Elliptic Curves	settings">paul.tremberth at gmail.com
       </A><BR>
    <I>Wed Apr 26 11:32:13 MDT 2017</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="005292.html">[Twisted-web] [ANN] txkube 0.1.0
</A></li>
        <LI>Next message (by thread): <A HREF="005294.html">[Twisted-web] Twisted Web Agent configurable Elliptic Curves settings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5293">[ date ]</a>
              <a href="thread.html#5293">[ thread ]</a>
              <a href="subject.html#5293">[ subject ]</a>
              <a href="author.html#5293">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

The other day, we had a Scrapy user report an issue connecting to
<A HREF="https://www.skelbiu.lt/">https://www.skelbiu.lt/</A> with OpenSSL 1.1 [1]

To not mix scrapy's things with Twisted Web, I used this (adapted from
official docs):

#---------------
from __future__ import print_function

from twisted.internet import reactor
from twisted.web.client import Agent
from twisted.web.http_headers import Headers

agent = Agent(reactor)

d = agent.request(
    'GET',
    '<A HREF="https://www.skelbiu.lt/">https://www.skelbiu.lt/</A>',
    Headers({'User-Agent': ['Twisted Web Client Example']}),
    None)

def cbResponse(ignored):
    print('Response received')
d.addCallback(cbResponse)

def cbShutdown(ignored):
    print(ignored)
    reactor.stop()
d.addBoth(cbShutdown)

reactor.run()
#---------------

And I did get a Handshake failure too:

    $ python twistedtest.py
    [Failure instance: Traceback (failure with no frames): &lt;class
'twisted.web._newclient.ResponseNeverReceived'&gt;:
[&lt;twisted.python.failure.Failure OpenSSL.SSL.Error: [('SSL routines',
'ssl3_read_bytes', 'sslv3 alert handshake failure')]&gt;]
    ]


It seems this happens (at least) with OpenSSL 1.1.0e (currently in Debian 9
sid [2])
It does not happen (for me) with OpenSSL 1.0.2g for example.

I dug into this this afternoon and narrowed it down to the use of
_defaultCurveName = u&quot;prime256v1&quot;
in twisted.internet._sslverify.py

I tried patching the current trunk with _defaultCurveName = u&quot;secp384r1&quot;
(the EC that ssllabs.com reports)
and it did work.

Looking at ClientHello messages for openssl 1.0.2 and 1.1 [4]:
with 1.1, only 1 Elliptic Curve is sent by Twisted Web Agent, secp256r1

openssl v1.1 client uses 4 by default: ecdh_x25519, secp256r1, secp521r1,
secp384r1

I was wondering what is the proper way to configure requested Elliptic
Curves.
I haven't seen any interface for this, contrary to ciphers with
acceptableCiphers.

Thank you for your input.


Best,
Paul.

[1] <A HREF="https://github.com/scrapy/scrapy/issues/2717">https://github.com/scrapy/scrapy/issues/2717</A>
[2] <A HREF="https://packages.debian.org/fr/source/sid/openssl">https://packages.debian.org/fr/source/sid/openssl</A>
[3]
<A HREF="https://github.com/twisted/twisted/blob/78679af87e349721a167f35bef239e192e91d126/src/twisted/internet/_sslverify.py#L1904">https://github.com/twisted/twisted/blob/78679af87e349721a167f35bef239e192e91d126/src/twisted/internet/_sslverify.py#L1904</A>
[4] <A HREF="https://github.com/scrapy/scrapy/issues/2717#issuecomment-297464034">https://github.com/scrapy/scrapy/issues/2717#issuecomment-297464034</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20170426/330f95a2/attachment.html">http://twistedmatrix.com/pipermail/twisted-web/attachments/20170426/330f95a2/attachment.html</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="005292.html">[Twisted-web] [ANN] txkube 0.1.0
</A></li>
	<LI>Next message (by thread): <A HREF="005294.html">[Twisted-web] Twisted Web Agent configurable Elliptic Curves settings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5293">[ date ]</a>
              <a href="thread.html#5293">[ thread ]</a>
              <a href="subject.html#5293">[ subject ]</a>
              <a href="author.html#5293">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
