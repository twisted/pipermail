<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Problems with web2.test.test_static.TestFileSaver
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Problems%20with%20web2.test.test_static.TestFileSaver&In-Reply-To=4C6B9685-7E2E-4441-8967-E9EC1002088E%40wsanchez.net">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002040.html">
   <LINK REL="Next"  HREF="002041.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Problems with web2.test.test_static.TestFileSaver</H1>
    <B>James Y Knight</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Problems%20with%20web2.test.test_static.TestFileSaver&In-Reply-To=4C6B9685-7E2E-4441-8967-E9EC1002088E%40wsanchez.net"
       TITLE="[Twisted-web] Problems with web2.test.test_static.TestFileSaver">foom at fuhm.net
       </A><BR>
    <I>Mon Nov  7 21:52:15 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="002040.html">[Twisted-web] Problems with web2.test.test_static.TestFileSaver
</A></li>
        <LI>Next message: <A HREF="002041.html">[Twisted-web] problems with select boxes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2044">[ date ]</a>
              <a href="thread.html#2044">[ thread ]</a>
              <a href="subject.html#2044">[ subject ]</a>
              <a href="author.html#2044">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Nov 7, 2005, at 1:40 AM, Wilfredo S&#225;nchez Vega wrote:
&gt;<i>   web2.test.test_static.TestFileSaver has been failing on my DAV  
</I>&gt;<i> branch.  dreid and I were looking into it at SHDH and were  
</I>&gt;<i> generally baffled by the breakage.
</I>&gt;<i>
</I>&gt;<i>   I remain baffled, but have managed to figure out that the test  
</I>&gt;<i> isn't breaking due to the addition of code, but by the simple  
</I>&gt;<i> existence of the test modules in my code.  I can reproduce the  
</I>&gt;<i> problem in trunk by doing the following:
</I>&gt;<i>
</I>
First let me apologize for not being around this weekend, I would  
have liked to help out, but I've had a nasty fever and have basically  
been sleeping.

Anyhow, I can solve this mystery for you. It is caused by the reload 
() of twisted.web2.http_headers in twisted/web2/test/__init__.py.  
That causes twisted.web2.http_headers.MimeType to be a new class, but  
the old instances created in static.FileSaver.allowedTypes still  
pointed to the old class. Thus the &quot;File type not allowed&quot; bit.

It is fixed by using twisted.python.rebuild.rebuild() instead, which  
updates said references. Except that rebuild doesn't seem to rebuild  
instances of oldstyle classes. So I updated the classes to be  
newstyle, which they should be anyhow.

The reason for the odd output is that the test case used data 
[data.find(...)+11:data.find(...)]. If find fails, it returns -1. As  
the MimeType passed was not in the allowed set, the file was not  
being saved and the output was not as expected. Fixed that to  
use .index instead so it fails more obviously.

James


</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002040.html">[Twisted-web] Problems with web2.test.test_static.TestFileSaver
</A></li>
	<LI>Next message: <A HREF="002041.html">[Twisted-web] problems with select boxes.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2044">[ date ]</a>
              <a href="thread.html#2044">[ thread ]</a>
              <a href="subject.html#2044">[ subject ]</a>
              <a href="author.html#2044">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
