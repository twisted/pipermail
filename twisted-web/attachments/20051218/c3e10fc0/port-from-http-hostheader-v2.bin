Index: /home/richard/lib/Twisted/trunk/twisted/web/server.py
===================================================================
--- /home/richard/lib/Twisted/trunk/twisted/web/server.py	(revision 15343)
+++ /home/richard/lib/Twisted/trunk/twisted/web/server.py	(working copy)
@@ -342,11 +342,23 @@
         return self.session
 
     def _prePathURL(self, prepath):
-        port = self.getHost().port
         if self.isSecure():
             default = 443
         else:
             default = 80
+        
+        # There won't always be a hostheader, but if it's present, try and find 
+        # the port number from it.
+        hostheader = self.getHeader('host')
+        if hostheader:
+            hostheader = hostheader.split(":", 1)
+            if len(hostheader) == 2:
+                port = int(hostheader[1])
+            else:
+                port = default
+        else:
+            port = self.getHost().port
+            
         if port == default:
             hostport = ''
         else:
