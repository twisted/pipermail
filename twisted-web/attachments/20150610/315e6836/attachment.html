<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;Thanks&nbsp;Gavin&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Good&nbsp;to&nbsp;know&nbsp;how&nbsp;things&nbsp;are&nbsp;done&nbsp;at&nbsp;your&nbsp;end.&nbsp;thanks!&lt;/div&gt;&lt;div&gt;However,&nbsp;why&nbsp;is&nbsp;Twisted&nbsp;not&nbsp;internally&nbsp;using&nbsp;SO_REUSEPORT&nbsp;?&nbsp;Is&nbsp;there&nbsp;any&nbsp;plan&nbsp;to&nbsp;integrate&nbsp;it&nbsp;inside&nbsp;twisted&nbsp;so&nbsp;that&nbsp;application&nbsp;need&nbsp;not&nbsp;worry&nbsp;about&nbsp;it&nbsp;? &lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;The&nbsp;problem&nbsp;with&nbsp;code&nbsp;mentioned&nbsp;here:&nbsp; &lt;a&nbsp;href=&quot;http://stackoverflow.com/questions/10077745/twistedweb-on-multicore-multiprocessor&quot;&gt;http://stackoverflow.com/questions/10077745/twistedweb-on-multicore-multiprocessor&lt;/a&gt;&lt;/div&gt;&lt;div&gt;is&nbsp;that&nbsp;the&nbsp;requests&nbsp;are&nbsp;not&nbsp;equally&nbsp;distributed&nbsp;across&nbsp;all&nbsp;processes.&nbsp;This&nbsp;imbalance&nbsp;leads&nbsp;to&nbsp;underutilization&nbsp;of&nbsp;CPU&nbsp;cores.&nbsp;This&nbsp;issue&nbsp;is&nbsp;also&nbsp;discussed&nbsp;on&nbsp;&lt;a&nbsp;href=&quot;https://lwn.net/Articles/542629/&quot;&gt;https://lwn.net/Articles/542629/&lt;/a&gt;&lt;/div&gt;&lt;div&gt;and&nbsp;that&nbsp;this&nbsp;is&nbsp;not&nbsp;an&nbsp;issue&nbsp;with&nbsp;SO_REUSEPORT&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Does&nbsp;it&nbsp;mean&nbsp;that&nbsp;Twisted&nbsp;is&nbsp;using&nbsp;single&nbsp;listening&nbsp;socket&nbsp;and&nbsp;all&nbsp;processes&nbsp;accept()&nbsp;on&nbsp;that&nbsp;socket&nbsp;?&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;thanks&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Wed,&nbsp;Jun&nbsp;10,&nbsp;2015&nbsp;at&nbsp;2:23&nbsp;AM,&nbsp;Gavin&nbsp;Panella&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:gavin@gromper.net&quot;&nbsp;target=&quot;_blank&quot;&gt;gavin@gromper.net&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0&nbsp;0&nbsp;0&nbsp;.8ex;border-left:1px&nbsp;#ccc&nbsp;solid;padding-left:1ex&quot;&gt;&lt;div&nbsp;class=&quot;HOEnZb&quot;&gt;&lt;div&nbsp;class=&quot;h5&quot;&gt;On&nbsp;10&nbsp;June&nbsp;2015&nbsp;at&nbsp;03:01,&nbsp;Sagar&nbsp;Dixit&nbsp;&lt;&lt;a&nbsp;href=&quot;mailto:sagar.dixit@gmail.com&quot;&gt;sagar.dixit@gmail.com&lt;/a&gt;&gt;&nbsp;wrote:&lt;br&gt;<br>
&gt;&nbsp;Hi,&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;am&nbsp;exploring&nbsp;Twisted&nbsp;Web&nbsp;for&nbsp;my&nbsp;RESTful&nbsp;application.&nbsp;My&nbsp;application&lt;br&gt;<br>
&gt;&nbsp;is&nbsp;stateless&nbsp;and&nbsp;involves&nbsp;storing&nbsp;and&nbsp;retrieving&nbsp;objects&nbsp;based&nbsp;on&lt;br&gt;<br>
&gt;&nbsp;Object-ID.&nbsp;This&nbsp;application&nbsp;will&nbsp;run&nbsp;on&nbsp;beefy&nbsp;(multicore,&nbsp;lots&nbsp;of&lt;br&gt;<br>
&gt;&nbsp;memory)&nbsp;machine.&nbsp;However,&nbsp;not&nbsp;all&nbsp;APIs&nbsp;that&nbsp;the&nbsp;application&nbsp;issues&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;underlying&nbsp;storage&nbsp;are&nbsp;async&nbsp;and&nbsp;hence&nbsp;I&nbsp;cannot&nbsp;fully&nbsp;utilize&lt;br&gt;<br>
&gt;&nbsp;Deferreds&lt;br&gt;<br>
&gt;&nbsp;Which&nbsp;means,&nbsp;there&nbsp;will&nbsp;some&nbsp;blocking&nbsp;calls&nbsp;and&nbsp;hence&nbsp;my&nbsp;primary&lt;br&gt;<br>
&gt;&nbsp;interest&nbsp;is&nbsp;to&nbsp;use&nbsp;Twisted&nbsp;Web&nbsp;in&nbsp;multiprocessing&nbsp;mode&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;I&nbsp;came&nbsp;across&lt;br&gt;<br>
&gt;&nbsp;&lt;a&nbsp;href=&quot;http://stackoverflow.com/questions/10077745/twistedweb-on-multicore-multiprocessor&quot;&nbsp;target=&quot;_blank&quot;&gt;http://stackoverflow.com/questions/10077745/twistedweb-on-multicore-multiprocessor&lt;/a&gt;&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;However,&nbsp;I&nbsp;am&nbsp;not&nbsp;sure&nbsp;if&nbsp;it&nbsp;is&nbsp;the&nbsp;&quot;correct&quot;&nbsp;way&nbsp;of&nbsp;doing&nbsp;things.&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;Hence&nbsp;I&nbsp;had&nbsp;some&nbsp;questions&nbsp;around&nbsp;it:&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;1.&nbsp;Is&nbsp;there&nbsp;an&nbsp;interface&nbsp;(similar&nbsp;to&nbsp;defertoThread)&nbsp;which&nbsp;allows&nbsp;me&nbsp;to&lt;br&gt;<br>
&gt;&nbsp;execute&nbsp;a&nbsp;blocking&nbsp;call&nbsp;in&nbsp;a&nbsp;separate&nbsp;process&nbsp;?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;2.&nbsp;Does&nbsp;reactor&nbsp;synchronize&nbsp;access&nbsp;of&nbsp;all&nbsp;processes&nbsp;to&nbsp;the&nbsp;shared&lt;br&gt;<br>
&gt;&nbsp;listen&nbsp;socket&nbsp;?&lt;br&gt;<br>
&gt;&lt;br&gt;<br>
&gt;&nbsp;3.&nbsp;Is&nbsp;there&nbsp;a&nbsp;sample&nbsp;code&nbsp;I&nbsp;can&nbsp;refer&nbsp;to&nbsp;where&nbsp;the&nbsp;application&nbsp;is&lt;br&gt;<br>
&gt;&nbsp;spawning&nbsp;subprocesses&nbsp;to&nbsp;handle&nbsp;HTTP&nbsp;requests&nbsp;?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;We&#39;ve&nbsp;used&nbsp;SO_REUSEPORT&nbsp;(which&nbsp;is&nbsp;briefly&nbsp;mentioned&nbsp;on&nbsp;the&nbsp;SO&nbsp;page&nbsp;you&lt;br&gt;<br>
linked&nbsp;to)&nbsp;in&nbsp;order&nbsp;to&nbsp;run&nbsp;multiple&nbsp;processes.&nbsp;On&nbsp;a&nbsp;recentish&nbsp;Linux&nbsp;the&lt;br&gt;<br>
following&nbsp;approach&nbsp;has&nbsp;worked&nbsp;well&nbsp;for&nbsp;us:&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;Make&nbsp;a&nbsp;socket&nbsp;with&nbsp;SO_REUSEPORT&nbsp;set&nbsp;so&nbsp;that&nbsp;we&nbsp;can&nbsp;run&nbsp;multiple&nbsp;web&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;applications.&nbsp;This&nbsp;is&nbsp;easier&nbsp;to&nbsp;do&nbsp;from&nbsp;outside&nbsp;of&nbsp;Twisted&nbsp;as&nbsp;there&#39;s&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;not&nbsp;yet&nbsp;official&nbsp;support&nbsp;for&nbsp;setting&nbsp;socket&nbsp;options.&lt;br&gt;<br>
 &nbsp; &nbsp;s&nbsp;=&nbsp;socket.socket(socket.AF_INET,&nbsp;socket.SOCK_STREAM)&lt;br&gt;<br>
 &nbsp; &nbsp;s.setsockopt(socket.SOL_SOCKET,&nbsp;socket.SO_REUSEADDR,&nbsp;1)&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;The&nbsp;following&nbsp;might&nbsp;not&nbsp;work&nbsp;on&nbsp;older&nbsp;kernels,&nbsp;or&nbsp;SO_REUSEPORT&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;might&nbsp;not&nbsp;be&nbsp;available&nbsp;if&nbsp;Python&nbsp;was&nbsp;compiled&nbsp;with&nbsp;older&nbsp;headers.&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;In&nbsp;the&nbsp;former&nbsp;case&nbsp;you&#39;re&nbsp;out&nbsp;of&nbsp;luck,&nbsp;but&nbsp;you&nbsp;can&nbsp;define&nbsp;the&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;header&nbsp;yourself&nbsp;if&nbsp;it&#39;s&nbsp;missing&nbsp;from&nbsp;Python&#39;s&nbsp;socket&nbsp;module.&lt;br&gt;<br>
 &nbsp; &nbsp;s.setsockopt(socket.SOL_SOCKET,&nbsp;socket.SO_REUSEPORT,&nbsp;1)&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;Listen&nbsp;on&nbsp;all&nbsp;interfaces&nbsp;on&nbsp;port&nbsp;1234.&lt;br&gt;<br>
 &nbsp; &nbsp;s.bind((&#39;0.0.0.0&#39;,&nbsp;1234))&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;Use&nbsp;a&nbsp;backlog&nbsp;of&nbsp;50,&nbsp;which&nbsp;seems&nbsp;to&nbsp;be&nbsp;fairly&nbsp;common.&lt;br&gt;<br>
 &nbsp; &nbsp;s.listen(50)&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;Adopt&nbsp;this&nbsp;socket&nbsp;into&nbsp;something&nbsp;more&nbsp;Twisty.&lt;br&gt;<br>
 &nbsp; &nbsp;endpoint&nbsp;=&nbsp;AdoptedStreamServerEndpoint(reactor,&nbsp;s.fileno(),&nbsp;s.family)&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;Prevent&nbsp;garbage&nbsp;collection.&nbsp;This&nbsp;is&nbsp;something&nbsp;we&nbsp;discovered&nbsp;we&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;needed,&nbsp;and&nbsp;is&nbsp;perhaps&nbsp;something&nbsp;that&nbsp;AdoptedStreamServerEndpoint&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;ought&nbsp;to&nbsp;do&nbsp;itself.&lt;br&gt;<br>
 &nbsp; &nbsp;endpoint.socket&nbsp;=&nbsp;s&lt;br&gt;<br>
&lt;br&gt;<br>
 &nbsp; &nbsp;#&nbsp;Create&nbsp;a&nbsp;service&nbsp;with&nbsp;the&nbsp;endpoint.&lt;br&gt;<br>
 &nbsp; &nbsp;service&nbsp;=&nbsp;OurService(site_endpoint)&lt;br&gt;<br>
&lt;br&gt;<br>
(Derived&nbsp;from&nbsp;src/maasserver/eventloop.py&nbsp;in&nbsp;MAAS.)&lt;br&gt;<br>
&lt;br&gt;<br>
We&nbsp;then&nbsp;use&nbsp;Upstart&nbsp;(Ubuntu&nbsp;14.10&nbsp;and&nbsp;before)&nbsp;or&nbsp;systemd&nbsp;(Ubuntu&nbsp;15.04)&lt;br&gt;<br>
to&nbsp;run&nbsp;multiple&nbsp;processes.&nbsp;For&nbsp;us&nbsp;this&nbsp;mean&nbsp;4,&nbsp;but&nbsp;you&nbsp;can&nbsp;have&nbsp;as&nbsp;many&lt;br&gt;<br>
or&nbsp;as&nbsp;few&nbsp;as&nbsp;you&nbsp;need,&nbsp;for&nbsp;example&nbsp;1&nbsp;process&nbsp;per&nbsp;CPU&nbsp;core.&nbsp;I&nbsp;like&nbsp;this&lt;br&gt;<br>
approach&nbsp;because&nbsp;we&nbsp;can&nbsp;use&nbsp;the&nbsp;system&#39;s&nbsp;facilities&nbsp;for&nbsp;process&lt;br&gt;<br>
supervision&nbsp;instead&nbsp;of&nbsp;cobbling&nbsp;together&nbsp;our&nbsp;own.&lt;br&gt;<br>
&lt;br&gt;<br>
One&nbsp;caveat&nbsp;is&nbsp;that&nbsp;the&nbsp;processes&nbsp;are&nbsp;running&nbsp;concurrently.&nbsp;If&nbsp;you&#39;re&lt;br&gt;<br>
modifiying&nbsp;shared&nbsp;resources&nbsp;you&#39;ll&nbsp;want&nbsp;to&nbsp;consider&nbsp;explicit&nbsp;locking&lt;br&gt;<br>
where&nbsp;before&nbsp;you&nbsp;might&nbsp;have&nbsp;been&nbsp;safe&nbsp;with&nbsp;Twisted&#39;&nbsp;single-threadedness.&lt;br&gt;<br>
&lt;br&gt;<br>
Gavin.&lt;br&gt;<br>
&lt;br&gt;<br>
_______________________________________________&lt;br&gt;<br>
Twisted-web&nbsp;mailing&nbsp;list&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;mailto:Twisted-web@twistedmatrix.com&quot;&gt;Twisted-web@twistedmatrix.com&lt;/a&gt;&lt;br&gt;<br>
&lt;a&nbsp;href=&quot;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web&quot;&nbsp;target=&quot;_blank&quot;&gt;http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web&lt;/a&gt;&lt;br&gt;<br>
&lt;/blockquote&gt;&lt;/div&gt;&lt;br&gt;&lt;br&nbsp;clear=&quot;all&quot;&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;--&nbsp;&lt;br&gt;&lt;div&nbsp;class=&quot;gmail_signature&quot;&gt;ssdixit&lt;br&gt;&lt;br&gt;&lt;/div&gt;<br>
&lt;/div&gt;<br>

</tt>
