<tt>
Hi&lt;br&gt;<br>
&lt;br&gt;<br>
I&nbsp;have&nbsp;an&nbsp;application&nbsp;which&nbsp;uses&nbsp;web2.&nbsp;In&nbsp;good&nbsp;twisted&nbsp;style&nbsp;I'm&nbsp;writing&nbsp;tests&nbsp;for&nbsp;it,&nbsp;and&nbsp;using&nbsp;trial.&lt;br&gt;<br>
&lt;br&gt;<br>
When&nbsp;performing&nbsp;some&nbsp;rather&nbsp;simple&nbsp;page&nbsp;retrievals&nbsp;a&nbsp;get&nbsp;a&nbsp;lingering&nbsp;http&nbsp;channel.&nbsp;Setting&lt;br&gt;<br>
twisted.internet.base.DelayedCall.debug&nbsp;=&nbsp;True&lt;br&gt;<br>
I&nbsp;get&nbsp;this&nbsp;trace:&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/util.py&amp;quot;,&nbsp;line&nbsp;131,&nbsp;in&nbsp;_dispatch&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;getattr(self,&nbsp;&amp;quot;do_%s&amp;quot;&nbsp;%&nbsp;attr)()&lt;br&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/util.py&amp;quot;,&nbsp;line&nbsp;173,&nbsp;in&nbsp;do_cleanPending&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;raise&nbsp;PendingTimedCallsError(s)&lt;br&gt;<br>
twisted.trial.util.PendingTimedCallsError:&nbsp;pendingTimedCalls&nbsp;still<br>
pending&nbsp;(consider&nbsp;setting&nbsp;twisted.internet.base.DelayedCall.debug&nbsp;=<br>
True):&nbsp;&amp;lt;DelayedCall&nbsp;1083946540&nbsp;[19.9427890778s]&nbsp;called=0&nbsp;cancelled=0<br>
HTTPChannel._lingerClose()&lt;br&gt;<br>
&lt;br&gt;<br>
traceback&nbsp;at&nbsp;creation:&lt;br&gt;<br>
&lt;br&gt;<br>
&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/bin/trial&amp;quot;,&nbsp;line&nbsp;24,&nbsp;in&nbsp;?&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;run()&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/scripts/trial.py&amp;quot;,&nbsp;line&nbsp;676,&nbsp;in&nbsp;run&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;suite&nbsp;=&nbsp;reallyRun(config)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/scripts/trial.py&amp;quot;,&nbsp;line&nbsp;657,&nbsp;in&nbsp;reallyRun&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;suite.run(config['random'])&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&amp;quot;,&nbsp;line&nbsp;250,&nbsp;in&nbsp;run&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;tr.runTests(randomize=(seed&nbsp;is&nbsp;not&nbsp;None))&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&amp;quot;,&nbsp;line&nbsp;496,&nbsp;in&nbsp;runTests&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;runner.runTests(randomize)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&amp;quot;,&nbsp;line&nbsp;601,&nbsp;in&nbsp;runTests&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self._apply(_runTestMethod)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&amp;quot;,&nbsp;line&nbsp;543,&nbsp;in&nbsp;_apply&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;f(tm)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&amp;quot;,&nbsp;line&nbsp;597,&nbsp;in&nbsp;_runTestMethod&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;testMethod.run(tci)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&amp;quot;,&nbsp;line&nbsp;849,&nbsp;in&nbsp;run&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;orig(tci)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&amp;quot;,&nbsp;line&nbsp;332,&nbsp;in&nbsp;__call__&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;lambda&nbsp;:util.wait(defer.maybeDeferred(self.original,&nbsp;*a,&nbsp;**kw),&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File<br>
&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&amp;quot;,&nbsp;line&nbsp;409,<br>
in&nbsp;_runWithWarningFilters&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;f(*a,&nbsp;**kw)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/runner.py&amp;quot;,&nbsp;line&nbsp;333,&nbsp;in&nbsp;&amp;lt;lambda&amp;gt;&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;timeout,&nbsp;useWaitError=True))&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/util.py&amp;quot;,&nbsp;line&nbsp;325,&nbsp;in&nbsp;wait&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;r&nbsp;=&nbsp;_Wait.wait(d,&nbsp;timeout)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/trial/util.py&amp;quot;,&nbsp;line&nbsp;269,&nbsp;in&nbsp;wait&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;reactor.iterate(0.01)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/internet/base.py&amp;quot;,&nbsp;line&nbsp;360,&nbsp;in&nbsp;iterate&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.doIteration(delay)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/internet/selectreactor.py&amp;quot;,&nbsp;line&nbsp;133,&nbsp;in&nbsp;doSelect&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;_logrun(selectable,&nbsp;_drdw,&nbsp;selectable,&nbsp;method,&nbsp;dict)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/python/log.py&amp;quot;,&nbsp;line&nbsp;56,&nbsp;in&nbsp;callWithLogger&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;callWithContext({&amp;quot;system&amp;quot;:&nbsp;lp},&nbsp;func,&nbsp;*args,&nbsp;**kw)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/python/log.py&amp;quot;,&nbsp;line&nbsp;41,&nbsp;in&nbsp;callWithContext&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;context.call({ILogContext:&nbsp;newCtx},&nbsp;func,&nbsp;*args,&nbsp;**kw)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/python/context.py&amp;quot;,&nbsp;line&nbsp;52,&nbsp;in&nbsp;callWithContext&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;self.currentContext().callWithContext(ctx,&nbsp;func,&nbsp;*args,&nbsp;**kw)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/python/context.py&amp;quot;,&nbsp;line&nbsp;31,&nbsp;in&nbsp;callWithContext&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;func(*args,**kw)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File<br>
&amp;quot;/usr/lib/python2.4/site-packages/twisted/internet/selectreactor.py&amp;quot;,<br>
line&nbsp;139,&nbsp;in&nbsp;_doReadOrWrite&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;why&nbsp;=&nbsp;getattr(selectable,&nbsp;method)()&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/usr/lib/python2.4/site-packages/twisted/internet/abstract.py&amp;quot;,&nbsp;line&nbsp;134,&nbsp;in&nbsp;doWrite&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;result&nbsp;=&nbsp;self._closeWriteConnection()&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File<br>
&amp;quot;/usr/lib/python2.4/site-packages/twisted/internet/tcp.py&amp;quot;,&nbsp;line&nbsp;376,<br>
in&nbsp;_closeWriteConnection&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;p.writeConnectionLost()&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;File<br>
&amp;quot;/usr/lib/python2.4/site-packages/twisted/web2/channel/http.py&amp;quot;,&nbsp;line<br>
788,&nbsp;in&nbsp;writeConnectionLost&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self._lingerTimer&nbsp;=&nbsp;reactor.callLater(20,&nbsp;self._lingerClose)&lt;br&gt;<br>
&amp;gt;&lt;br&gt;<br>
&lt;br&gt;<br>
This&nbsp;if&nbsp;course&nbsp;makes&nbsp;sense,&nbsp;especially&nbsp;if&nbsp;the&nbsp;server&nbsp;lost&nbsp;its<br>
connection.&nbsp;I&nbsp;am&nbsp;doing&nbsp;cleanup&nbsp;in&nbsp;tearDown&nbsp;(calling&nbsp;stopListening()&nbsp;on<br>
the&nbsp;port),&nbsp;but&nbsp;trial&nbsp;still&nbsp;complains.&nbsp;Canceling&nbsp;the&nbsp;call,&nbsp;and&nbsp;calling<br>
it&nbsp;manually&nbsp;in&nbsp;tearDown,&nbsp;doesn't&nbsp;appear&nbsp;to&nbsp;help&nbsp;either.&nbsp;How&nbsp;do&nbsp;I&nbsp;make<br>
it&nbsp;shut&nbsp;it&nbsp;up&nbsp;in&nbsp;a&nbsp;proper&nbsp;way?&lt;br&gt;<br>
&lt;br&gt;<br>
&lt;br&gt;<br>
PS.&nbsp;I'm&nbsp;rather&nbsp;pleased&nbsp;with&nbsp;the&nbsp;web2&nbsp;framework,&nbsp;especially&nbsp;the&nbsp;stream<br>
framework&nbsp;(once&nbsp;I&nbsp;got&nbsp;my&nbsp;head&nbsp;wrapped&nbsp;around&nbsp;it),&nbsp;but&nbsp;it&nbsp;is&nbsp;hard&nbsp;to&nbsp;get<br>
an&nbsp;overview&nbsp;of&nbsp;the&nbsp;internals.&nbsp;A&nbsp;brief&nbsp;description&nbsp;of&nbsp;the&nbsp;design,<br>
philosophy,&nbsp;what&nbsp;was&nbsp;wrong&nbsp;with&nbsp;web(1),&nbsp;etc.&nbsp;would&nbsp;be&nbsp;very&nbsp;nice&nbsp;(I&nbsp;do<br>
realize&nbsp;that&nbsp;web2&nbsp;is&nbsp;a&nbsp;moving&nbsp;target).&lt;br&gt;<br>
&lt;br&gt;--&nbsp;&lt;br&gt;&amp;nbsp;&amp;nbsp;&nbsp;-&nbsp;Henrik<br>

</tt>
