<tt>
&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;div&nbsp;class=&quot;gmail_extra&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;On&nbsp;Fri,&nbsp;Mar&nbsp;17,&nbsp;2017&nbsp;at&nbsp;2:52&nbsp;AM,&nbsp;Ilya&nbsp;Skriblovsky&nbsp;&lt;span&nbsp;dir=&quot;ltr&quot;&gt;&lt;&lt;a&nbsp;href=&quot;mailto:ilyaskriblovsky@gmail.com&quot;&nbsp;target=&quot;_blank&quot;&gt;ilyaskriblovsky@gmail.com&lt;/a&gt;&gt;&lt;/span&gt;&nbsp;wrote:&lt;br&gt;&lt;blockquote&nbsp;class=&quot;gmail_quote&quot;&nbsp;style=&quot;margin:0px&nbsp;0px&nbsp;0px&nbsp;0.8ex;border-left:1px&nbsp;solid&nbsp;rgb(204,204,204);padding-left:1ex&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&gt;&lt;span&nbsp;class=&quot;gmail-m_388361609629121005gmail-&quot;&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&gt; &lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;The&nbsp;code&nbsp;calling&nbsp;request.URLPath(),&nbsp;in&nbsp;a&nbsp;given&nbsp;Resource,&nbsp;or&nbsp;application,&nbsp;is&nbsp;highly&nbsp;unlikely&nbsp;to&nbsp;know&nbsp;whether&nbsp;it&nbsp;wants&nbsp;to&nbsp;honor&nbsp;(x-)forwarded-for.&lt;/span&gt;&lt;/div&gt;&lt;/span&gt;&lt;div&nbsp;dir=&quot;ltr&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;You&nbsp;are&nbsp;right,&nbsp;I&nbsp;haven&#39;t&nbsp;thought&nbsp;about&nbsp;it.&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;But&nbsp;I&#39;m&nbsp;in&nbsp;doubt&nbsp;whether&nbsp;trusting&nbsp;X-Forwarded-*&nbsp;by&nbsp;default&nbsp;can&nbsp;damage&nbsp;security&nbsp;if&nbsp;Twisted&nbsp;app&nbsp;is&nbsp;running&nbsp;with&nbsp;naked&nbsp;HTTP(S)&nbsp;port&nbsp;exposed&nbsp;without&nbsp;reverse&nbsp;proxy&nbsp;that&nbsp;handles&nbsp;these&nbsp;headers.&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;There&nbsp;are&nbsp;three&nbsp;headers:&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;1.&nbsp;X-Forwarded-For&nbsp;specifying&nbsp;original&nbsp;client&nbsp;IP&nbsp;and&nbsp;IPs&nbsp;of&nbsp;proxies&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;2.&nbsp;X-Forwarded-Host&nbsp;specifying&nbsp;original&nbsp;Host&nbsp;header&nbsp;from&nbsp;the&nbsp;client&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;3.&nbsp;X-Forwarded-Proto&nbsp;specifying&nbsp;original&nbsp;client&#39;s&nbsp;scheme&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;(there&nbsp;is&nbsp;also&nbsp;new-style&nbsp;&quot;Forwarded:&quot;&nbsp;header&nbsp;but&nbsp;it&nbsp;is&nbsp;not&nbsp;widely&nbsp;used&nbsp;yet,&nbsp;AFAIK)&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;br&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;X-Forwarded-For&nbsp;definetly&nbsp;can&#39;t&nbsp;be&nbsp;trusted&nbsp;if&nbsp;comes&nbsp;from&nbsp;untrusted&nbsp;client&nbsp;client.&nbsp;Fortunately&nbsp;we&nbsp;don&#39;t&nbsp;need&nbsp;it&nbsp;at&nbsp;all&nbsp;for&nbsp;generating&nbsp;URLs&nbsp;:)&nbsp;It&nbsp;will&nbsp;be&nbsp;in&nbsp;question&nbsp;when&nbsp;refactoring&nbsp;getClientIP()&nbsp;somewhen&nbsp;later.&lt;/span&gt;&lt;br&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;br&gt;&lt;/span&gt;&lt;/div&gt;&lt;div&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;But&nbsp;can&nbsp;we&nbsp;trust &lt;/span&gt;&lt;span&nbsp;style=&quot;color:rgb(33,33,33)&quot;&nbsp;class=&quot;gmail-m_388361609629121005gmail-m_-525099954024514115gmail_msg&quot;&gt;X-Forwarded-Host&nbsp;&amp;&nbsp;X-Forwarded-Proto?&nbsp;From&nbsp;the&nbsp;first&nbsp;glance&nbsp;it&nbsp;isn&#39;t&nbsp;a&nbsp;problem&nbsp;since&nbsp;we&nbsp;are&nbsp;using&nbsp;them&nbsp;to&nbsp;display&nbsp;URLs&nbsp;for&nbsp;the&nbsp;same&nbsp;client,&nbsp;so&nbsp;nasty&nbsp;client&nbsp;will&nbsp;get&nbsp;his&nbsp;nasty&nbsp;URLs,&nbsp;that&#39;s&nbsp;it.&nbsp;But&nbsp;if&nbsp;app&nbsp;is&nbsp;doing&nbsp;something&nbsp;like&nbsp;storing&nbsp;URL&nbsp;in&nbsp;DB&nbsp;or&nbsp;(more&nbsp;likely)&nbsp;sending&nbsp;an&nbsp;email&nbsp;with&nbsp;a&nbsp;link&nbsp;to&nbsp;another&nbsp;client,&nbsp;this&nbsp;would&nbsp;be&nbsp;an&nbsp;issue.&lt;/span&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/blockquote&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&#39;s&nbsp;not&nbsp;safe&nbsp;to&nbsp;enable&nbsp;support&nbsp;for&nbsp;X-Forwarded-For&nbsp;and&nbsp;friends&nbsp;by&nbsp;default,&nbsp;since&nbsp;you&nbsp;can&#39;t&nbsp;know&nbsp;how&nbsp;application&nbsp;code&nbsp;will&nbsp;use&nbsp;that&nbsp;information&nbsp;and&nbsp;in&nbsp;many&nbsp;configurations&nbsp;it&nbsp;may&nbsp;be&nbsp;spoofed&nbsp;by&nbsp;clients.&lt;br&gt;&lt;br&gt;A&nbsp;proper&nbsp;deployment&nbsp;which&nbsp;sets&nbsp;these&nbsp;headers&nbsp;looks&nbsp;like&nbsp;this:&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1.&nbsp;Configure&nbsp;your&nbsp;frontend&nbsp;reverse-proxy&nbsp;(nginx&nbsp;or&nbsp;whatever)&nbsp;to&nbsp;discard&nbsp;incoming&nbsp;X-Forwarded-*&nbsp;headers&nbsp;and&nbsp;&lt;i&gt;set&lt;/i&gt;&nbsp;X-Forwarded-*&nbsp;as&nbsp;appropriate.&nbsp;Note&nbsp;that&nbsp;X-Forwarded-For&nbsp;is&nbsp;actually&nbsp;a&nbsp;&lt;i&gt;list&lt;/i&gt;&nbsp;of&nbsp;hops[1],&nbsp;so&nbsp;if&nbsp;you&nbsp;do&nbsp;this&nbsp;naively&nbsp;your&nbsp;server&nbsp;may&nbsp;append&nbsp;to&nbsp;the&nbsp;list!&nbsp;[2]&lt;br&gt;&lt;/div&gt;&lt;div&gt;2.&nbsp;Configure&nbsp;your&nbsp;backend&nbsp;services&nbsp;to&nbsp;respect&nbsp;exactly&nbsp;the&nbsp;headers&nbsp;passed&nbsp;by&nbsp;your&nbsp;frontend.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Note&nbsp;that&nbsp;this&nbsp;requires&nbsp;administrative&nbsp;action&nbsp;in&nbsp;two&nbsp;places,&nbsp;and&nbsp;that&nbsp;if&nbsp;you&nbsp;don&#39;t&nbsp;do&nbsp;the&nbsp;frontend&nbsp;config&nbsp;it&nbsp;will&nbsp;probably&nbsp;pass&nbsp;the&nbsp;headers&nbsp;through,&nbsp;allowing&nbsp;them&nbsp;to&nbsp;be&nbsp;spoofed.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;A&nbsp;non-exhaustive&nbsp;list&nbsp;of&nbsp;possible&nbsp;bad&nbsp;stuff&nbsp;I&nbsp;client&nbsp;could&nbsp;use&nbsp;spoofing&nbsp;for:&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;1.&nbsp;Evade&nbsp;IP-based&nbsp;access&nbsp;control&nbsp;(a&nbsp;reasonable&nbsp;defense-in-depth&nbsp;measure).&lt;br&gt;&lt;/div&gt;&lt;div&gt;2.&nbsp;Evade&nbsp;pinning&nbsp;of&nbsp;user&nbsp;sessions&nbsp;to&nbsp;IP&nbsp;addresses&nbsp;or&nbsp;subnets.&lt;br&gt;&lt;/div&gt;&lt;div&gt;2.&nbsp;Evade&nbsp;IP-based&nbsp;rate&nbsp;limiting,&nbsp;e.g.&nbsp;as&nbsp;discussed&nbsp;at&nbsp;[3].&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;It&#39;s&nbsp;also&nbsp;probably&nbsp;worth&nbsp;noting&nbsp;that&nbsp;Django&nbsp;used&nbsp;to&nbsp;offer&nbsp;support&nbsp;for&nbsp;X-Forwarded-For&nbsp;and&nbsp;removed&nbsp;it[4].&nbsp;&nbsp;X-Forwarded-*&nbsp;and&nbsp;friends&nbsp;just&nbsp;too&nbsp;varied&nbsp;in&nbsp;the&nbsp;wild&nbsp;to&nbsp;reasonably&nbsp;support.&lt;br&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;If&nbsp;Twisted&nbsp;is&nbsp;to&nbsp;support&nbsp;this&nbsp;in&nbsp;any&nbsp;way,&nbsp;I&nbsp;think&nbsp;that&nbsp;it&nbsp;should&nbsp;be&nbsp;opt-in&nbsp;support&nbsp;for&nbsp;the&nbsp;Forwarded&nbsp;header&nbsp;as&nbsp;specified&nbsp;in&nbsp;RFC&nbsp;7239.&nbsp;This&nbsp;should&nbsp;be&nbsp;a&nbsp;parameter&nbsp;applicable&nbsp;to&nbsp;all&nbsp;of&nbsp;twisted.web.server&nbsp;rather&nbsp;than&nbsp;per-method&nbsp;call,&nbsp;since&nbsp;it&#39;s&nbsp;something&nbsp;the&nbsp;administrator&nbsp;needs&nbsp;to&nbsp;set.&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;—Tom&lt;br&gt;&lt;/div&gt;&lt;div&gt;&lt;br&gt;[1]:&nbsp;Standardized&nbsp;as&nbsp;Forwarded&nbsp;in&nbsp;&lt;a&nbsp;href=&quot;https://tools.ietf.org/html/rfc7239&quot;&nbsp;target=&quot;_blank&quot;&gt;https://tools.ietf.org/html/&lt;wbr&gt;rfc7239&lt;/a&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;[2]:&nbsp;Your&nbsp;frontend&nbsp;proxy&nbsp;should&nbsp;also&nbsp;validate&nbsp;Host&nbsp;is&nbsp;a&nbsp;domain&nbsp;you&nbsp;control&nbsp;to&nbsp;prevent&nbsp;cookie&nbsp;theft.&nbsp;Plus&nbsp;lots&nbsp;of&nbsp;other&nbsp;stuff.&nbsp;Web&nbsp;security&nbsp;is&nbsp;hard,&nbsp;and&nbsp;every&nbsp;default&nbsp;everywhere&nbsp;sets&nbsp;users&nbsp;up&nbsp;for&nbsp;failure.&lt;br&gt;[3]:&nbsp;&lt;a&nbsp;href=&quot;http://django-ratelimit.readthedocs.io/en/v1.0.0/security.html&quot;&nbsp;target=&quot;_blank&quot;&gt;http://django-ratelimit.&lt;wbr&gt;readthedocs.io/en/v1.0.0/&lt;wbr&gt;security.html&lt;/a&gt;&lt;br&gt;[4]:&nbsp;&lt;a&nbsp;href=&quot;https://www.djangoproject.com/weblog/2009/jul/28/security/#secondary-issue&quot;&nbsp;target=&quot;_blank&quot;&gt;https://www.djangoproject.com/&lt;wbr&gt;weblog/2009/jul/28/security/#&lt;wbr&gt;secondary-issue&lt;/a&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<br>

</tt>
