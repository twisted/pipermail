<tt>
&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;div&gt;&lt;div&nbsp;class=&quot;Wj3C7c&quot;&gt;&lt;div&nbsp;class=&quot;gmail_quote&quot;&gt;&lt;br&gt;On&nbsp;my&nbsp;app&nbsp;server&nbsp;which&nbsp;is&nbsp;built&nbsp;upon&nbsp;twisted+web2&nbsp;I&nbsp;have&nbsp;seen&nbsp;that&nbsp;at&nbsp;times&nbsp;some&nbsp;of&nbsp;worker&nbsp;threads&nbsp;will&nbsp;get&nbsp;blocked&nbsp;and&nbsp;won&amp;#39;t&nbsp;get&nbsp;released&nbsp;ever.&nbsp;Eventually&nbsp;my&nbsp;app&nbsp;server&nbsp;runs&nbsp;out&nbsp;of&nbsp;worker&nbsp;threads&nbsp;and&nbsp;starts&nbsp;throwing&nbsp;message&nbsp;&amp;quot;503&nbsp;Service&nbsp;not&nbsp;available&amp;quot;&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;On&nbsp;more&nbsp;debugging&nbsp;I&nbsp;have&nbsp;found&nbsp;that&nbsp;I&nbsp;can&nbsp;easily&nbsp;recreate&nbsp;this&nbsp;situation&nbsp;by&nbsp;doing&nbsp;a&nbsp;incomplete&nbsp;HTTP&nbsp;Post&nbsp;with&nbsp;data&nbsp;less&nbsp;then&nbsp;content&nbsp;length&nbsp;specified&nbsp;in&nbsp;POST&nbsp;header.&nbsp;After&nbsp;this&nbsp;incomplete&nbsp;HTTP&nbsp;Post&nbsp;with&nbsp;lesser&nbsp;bytes&nbsp;of&nbsp;data&nbsp;if&nbsp;I&nbsp;close&nbsp;the&nbsp;client&nbsp;socket&nbsp;or&nbsp;kill&nbsp;client&nbsp;process&nbsp;or&nbsp;reboot&nbsp;client&nbsp;machine,&nbsp;in&nbsp;all&nbsp;these&nbsp;three&nbsp;cases&nbsp;it&nbsp;results&nbsp;in&nbsp;a&nbsp;hanged&nbsp;thread&nbsp;on&nbsp;my&nbsp;app&nbsp;server.&nbsp;This&nbsp;hanged&nbsp;threads&nbsp;remains&nbsp;on&nbsp;app&nbsp;server&nbsp;for&nbsp;ever&nbsp;till&nbsp;kill&nbsp;app&nbsp;server&nbsp;process,&nbsp;no&nbsp;time&nbsp;out&nbsp;of&nbsp;any&nbsp;kind.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;Further&nbsp;debugging&nbsp;into&nbsp;web2&nbsp;code&nbsp;I&nbsp;found&nbsp;that&nbsp;stream.BufferedStream.readExactly&nbsp;doesn&amp;#39;t&nbsp;come&nbsp;out&nbsp;of&nbsp;stream.BufferedStrem._readUntil&nbsp;even&nbsp;if&nbsp;I&nbsp;close&nbsp;client&nbsp;side&nbsp;socket.&nbsp;After&nbsp;putting&nbsp;some&nbsp;debug&nbsp;statements&nbsp;I&nbsp;found&nbsp;that&nbsp;self.stream.read()&nbsp;in&nbsp;stream.BufferedStream._readUntil&nbsp;doesn&amp;#39;t&nbsp;return&nbsp;None&nbsp;as&nbsp;a&nbsp;signal&nbsp;for&nbsp;End&nbsp;Of&nbsp;File&nbsp;even&nbsp;after&nbsp;client&nbsp;has&nbsp;closed&nbsp;the&nbsp;socket&nbsp;connection.&nbsp;Since&nbsp;it&nbsp;doesn&amp;#39;t&nbsp;get&nbsp;None&nbsp;it&nbsp;will&nbsp;never&nbsp;return&nbsp;with&nbsp;whatever&nbsp;data&nbsp;it&nbsp;has&nbsp;received&nbsp;so&nbsp;far&nbsp;from&nbsp;client.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;To&nbsp;reproduce&nbsp;this&nbsp;issue,&nbsp;I&nbsp;have&nbsp;written&nbsp;a&nbsp;minimal&nbsp;twisted-web2&nbsp;server&nbsp;and&nbsp;a&nbsp;client&nbsp;that&nbsp;does&nbsp;a&nbsp;HTTP&nbsp;Post&nbsp;to&nbsp;it&nbsp;with&nbsp;incomplete&nbsp;data.&nbsp;After&nbsp;Post&nbsp;it&nbsp;closes&nbsp;the&nbsp;client&nbsp;socket&nbsp;and&nbsp;sleeps&nbsp;for&nbsp;sometime.&nbsp;Finally&nbsp;it&nbsp;prints&nbsp;the&nbsp;stack&nbsp;of&nbsp;all&nbsp;process&nbsp;threads,&nbsp;which&nbsp;clearly&nbsp;shows&nbsp;one&nbsp;blocked&nbsp;twisted&nbsp;worker&nbsp;thread.&nbsp;In&nbsp;the&nbsp;same&nbsp;program&nbsp;if&nbsp;you&nbsp;change&nbsp;it&nbsp;to&nbsp;do&nbsp;complete&nbsp;HTTP&nbsp;Post,&nbsp;in&nbsp;the&nbsp;thread&nbsp;dump&nbsp;there&nbsp;is&nbsp;no&nbsp;blocked&nbsp;twisted&nbsp;worker&nbsp;thread.&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;Here&nbsp;is&nbsp;the&nbsp;stack&nbsp;traceback&nbsp;of&nbsp;blocked&nbsp;twisted&nbsp;worker&nbsp;thread.&lt;br&gt;&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;C:\Python24\lib\threading.py&amp;quot;,&nbsp;line&nbsp;442,&nbsp;in&nbsp;__bootstrap&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.run()&lt;br&gt;&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;C:\Python24\lib\threading.py&amp;quot;,&nbsp;line&nbsp;422,&nbsp;in&nbsp;run&lt;br&gt;<br>
<br>
<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.__target(*self.__args,&nbsp;**self.__kwargs)&lt;br&gt;&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/home/lotus/Desktop/pywork3.3/lm/foreign-common/src/twisted/python/threadpool.py&amp;quot;,&nbsp;line&nbsp;161,&nbsp;in&nbsp;_worker&lt;br&gt;&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/home/lotus/Desktop/pywork3.3/lm/foreign-common/src/twisted/python/context.py&amp;quot;,&nbsp;line&nbsp;59,&nbsp;in&nbsp;callWithContext&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/home/lotus/Desktop/pywork3.3/lm/foreign-common/src/twisted/python/context.py&amp;quot;,&nbsp;line&nbsp;37,&nbsp;in&nbsp;callWithContext&lt;br&gt;&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/home/lotus/Desktop/pywork3.3/lm/foreign-common/src/twisted/web2/wsgi.py&amp;quot;,&nbsp;line&nbsp;190,&nbsp;in&nbsp;run&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;C:\work\twisted-head\twisted_server3.py&amp;quot;,&nbsp;line&nbsp;18,&nbsp;in&nbsp;dummy_app&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;out_content&nbsp;=&nbsp;environ[&amp;#39;wsgi.input&amp;#39;].read(int(environ[&amp;#39;CONTENT_LENGTH&amp;#39;]))&lt;br&gt;&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/home/lotus/Desktop/pywork3.3/lm/foreign-common/src/twisted/web2/wsgi.py&amp;quot;,&nbsp;line&nbsp;74,&nbsp;in&nbsp;read&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;/home/lotus/Desktop/pywork3.3/lm/foreign-common/src/twisted/internet/threads.py&amp;quot;,&nbsp;line&nbsp;81,&nbsp;in&nbsp;blockingCallFromThread&lt;br&gt;&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;C:\Python24\lib\Queue.py&amp;quot;,&nbsp;line&nbsp;119,&nbsp;in&nbsp;get&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;self.not_empty.wait()&lt;br&gt;<br>
<br>
<br>
&lt;br&gt;&amp;nbsp;&nbsp;File&nbsp;&amp;quot;C:\Python24\lib\threading.py&amp;quot;,&nbsp;line&nbsp;203,&nbsp;in&nbsp;wait&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;waiter.acquire()&lt;br&gt;&lt;br&gt;&lt;br&gt;To&nbsp;run&nbsp;this&nbsp;program&nbsp;twisted,&nbsp;twisted.web2,&nbsp;zope&nbsp;and&nbsp;threadframe&nbsp;modules&nbsp;are&nbsp;required.&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;import&nbsp;sys,&nbsp;time,&nbsp;socket&lt;br&gt;<br>
from&nbsp;threading&nbsp;import&nbsp;Thread&lt;br&gt;import&nbsp;threadframe,&nbsp;traceback&lt;br&gt;from&nbsp;twisted.web2&nbsp;import&nbsp;server,&nbsp;channel,&nbsp;static,&nbsp;wsgi,&nbsp;resource&lt;br&gt;from&nbsp;twisted.internet&nbsp;import&nbsp;reactor&lt;br&gt;&lt;br&gt;class&nbsp;TwistedWebServerThread(Thread):&lt;br&gt;&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;__init__(self,&nbsp;app):&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;Thread.__init__(self,&nbsp;name=&amp;quot;Twisted&amp;quot;)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;factory&nbsp;=&nbsp;channel.HTTPFactory(server.Site(wsgi.WSGIResource(app)))&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;reactor.listenTCP(8080,&nbsp;factory,&nbsp;interface=&amp;quot;&lt;a&nbsp;href=&quot;http://0.0.0.0&quot;&gt;0.0.0.0&lt;/a&gt;&amp;quot;)&lt;br&gt;<br>
&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;def&nbsp;run(self):&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;reactor.run(installSignalHandlers=False)&lt;br&gt;&lt;br&gt;def&nbsp;dummy_app(environ,&nbsp;start_response):&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;out_content&nbsp;=&nbsp;environ[&amp;#39;wsgi.input&amp;#39;].read(int(environ[&amp;#39;CONTENT_LENGTH&amp;#39;]))&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;start_response(&amp;#39;200&nbsp;OK&amp;#39;,&nbsp;[(&amp;#39;Content-type&amp;#39;,&nbsp;&amp;#39;text/plain&amp;#39;)])&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;return&nbsp;[out_content]&lt;br&gt;&lt;br&gt;#data&nbsp;intentionally&nbsp;less&nbsp;then&nbsp;content&nbsp;length&lt;br&gt;D&nbsp;=&nbsp;&amp;quot;POST&nbsp;/cgi-bin/minapi.py&nbsp;HTTP/1.0\r\n&amp;quot;+&nbsp;\&lt;br&gt;<br>
&amp;nbsp;&amp;quot;Host:&nbsp;127.0.0.1:8080\r\n&amp;quot;+\&lt;br&gt;&amp;nbsp;&amp;quot;Content-Type:&nbsp;text/xml\r\n&amp;quot;+\&lt;br&gt;&amp;nbsp;&amp;quot;Content-Length:&nbsp;152\r\n&amp;quot;+\&lt;br&gt;&amp;nbsp;&amp;quot;\r\n&amp;quot;+\&lt;br&gt;&amp;nbsp;&amp;quot;&amp;lt;?xml&nbsp;version=&amp;#39;1.0&amp;#39;?&amp;gt;\n&amp;quot;+\&lt;br&gt;&amp;nbsp;&amp;quot;&amp;lt;methodCall&amp;gt;\n&amp;quot;+\&lt;br&gt;<br>
&amp;nbsp;&amp;quot;&amp;lt;methodName&amp;gt;getStateName&amp;lt;/methodName&amp;gt;\n&amp;quot;&nbsp;+\&lt;br&gt;&amp;nbsp;&amp;quot;&amp;lt;params&amp;gt;\n&amp;quot;&nbsp;+\&lt;br&gt;&amp;nbsp;&amp;quot;&amp;lt;param&amp;gt;\n&amp;quot;&nbsp;+\&lt;br&gt;&amp;nbsp;&amp;quot;&amp;lt;value&amp;gt;&amp;lt;int&amp;gt;41&amp;lt;/int&amp;gt;&amp;lt;/value&amp;gt;\n&amp;quot;&nbsp;#+\&lt;br&gt;#&nbsp;&amp;quot;&amp;lt;/param&amp;gt;\n&amp;quot;&nbsp;+\&lt;br&gt;<br>
#&nbsp;&amp;quot;&amp;lt;/params&amp;gt;\n&amp;quot;&nbsp;+\&lt;br&gt;#&nbsp;&amp;quot;&amp;lt;/methodCall&amp;gt;\n&amp;quot;&lt;br&gt;&lt;br&gt;#D&nbsp;=&nbsp;open(&amp;quot;data.txt3&amp;quot;,&nbsp;&amp;quot;rb&amp;quot;).read()&lt;br&gt;&lt;br&gt;def&nbsp;half_post():&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;s&nbsp;=&nbsp;socket.socket(socket.AF_INET,&nbsp;socket.SOCK_STREAM)&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;s.connect((&amp;quot;&lt;a&nbsp;href=&quot;http://127.0.0.1&quot;&gt;127.0.0.1&lt;/a&gt;&amp;quot;,&nbsp;8080))&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;s.send(D)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;s.close()&lt;br&gt;&lt;br&gt;def&nbsp;write_server_threads():&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;frames&nbsp;=&nbsp;threadframe.threadframe()&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;for&nbsp;frame&nbsp;in&nbsp;frames:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;print&nbsp;&amp;#39;-&amp;#39;&nbsp;*&nbsp;72&nbsp;&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;for&nbsp;linestr&nbsp;in&nbsp;traceback.format_stack(frame):&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;print&nbsp;linestr&lt;br&gt;&lt;br&gt;if&nbsp;__name__&nbsp;==&nbsp;&amp;quot;__main__&amp;quot;:&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;s&nbsp;=&nbsp;TwistedWebServerThread(dummy_app)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;s.start()&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;time.sleep(0.2)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;half_post()&lt;br&gt;<br>
&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;time.sleep(5)&lt;br&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&nbsp;write_server_threads()&lt;br&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;br&gt;<br>
&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;br&gt;<br>

</tt>
