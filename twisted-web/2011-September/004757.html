<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Coding websockets server.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Coding%20websockets%20server.&In-Reply-To=CAGitN6LQ3%3DdksibBnhd37peL981bcSrnosBuZOA0g9eNsy%3Da9g%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004756.html">
   <LINK REL="Next"  HREF="004762.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Coding websockets server.</H1>
    <B>Reza Lotun</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Coding%20websockets%20server.&In-Reply-To=CAGitN6LQ3%3DdksibBnhd37peL981bcSrnosBuZOA0g9eNsy%3Da9g%40mail.gmail.com"
       TITLE="[Twisted-web] Coding websockets server.">rlotun at gmail.com
       </A><BR>
    <I>Tue Sep  6 04:06:36 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004756.html">[Twisted-web] Coding websockets server.
</A></li>
        <LI>Next message: <A HREF="004762.html">[Twisted-web] Role-based security authorization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4757">[ date ]</a>
              <a href="thread.html#4757">[ thread ]</a>
              <a href="subject.html#4757">[ subject ]</a>
              <a href="author.html#4757">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I've done work on the txWebSocket project in the past - it's now slightly
out of date for thew new spec. You're using the fork by wulczer which
supports the new protocol, so that's good. I have to update the main project
at some point to incorporate his work.

Anyway, to answer your quesions...


&gt;<i> My problem is:
</I>&gt;<i> If I do this:
</I>&gt;<i>     site = WebSocketSite(root)
</I>&gt;<i>     site.addChatHandler('/room*1*', Chathandler)
</I>&gt;<i>     site.addChatHandler('/room*2*', Chathandler)
</I>&gt;<i>     site.addChatHandler('/room*3*', Chathandler)
</I>&gt;<i>     reactor.listenTCP(8080, site)
</I>&gt;<i>
</I>&gt;<i> will not work (every room will comunicate with every room), because
</I>&gt;<i> the users = set() will be globally between the handlers..
</I>&gt;<i> If I put on the __init__, every call on /roomX will have your personal
</I>&gt;<i> set() of users including only themselfs.
</I>&gt;<i>
</I>&gt;<i>
</I>Right, I see what your issue is. You really want a mapping from room
resources to state (i.e. '/room1' -&gt; users1, etc). As you've noticed the
users set is a class-level construct, while the __init__ for the handler is
called on every connection. What you really want to be able to do is
associate this resource mapping on the site object. Unfortunately there is
currently no direct way to gain access to this object, and there is no easy
way to determine the resource you've been called at. I'll need to add this
ability.

For the time being I suggest to subclass WebSocketSite, and then access the
object via private access (I know this is *bad*, but there will be a better
option soon) in the handler as self.transport._request.site and the uri as
self.transport._request.uri. That way you can access a mapping on the site
object.

I plan on making access to the site and uri be public which under the hood
will access the above two attributes.

Sorry about the state of txWebsocket - development on it paused as the
websocket spec was going through a state of flux. It seems to have settled
down recently, so now is the time for me to really sort out these issues.
Thanks for bringing it to my attention.


&gt;<i> I am kind stuck on this, I`m new to websocket and server programming, so I
</I>&gt;<i> don`t even know if is the best way to code a chatroom server.
</I>&gt;<i> If you read this far ans have any (even it looks that stupid for you),
</I>&gt;<i> might help right now (:
</I>&gt;<i>
</I>
If you're interested in a basic chatroom implementation, the idea you have
sketched above is fine. However, if you're looking to add a tad more
robustness, might I suggest you implement the fan out logic in Redis using
its pub-sub functionality? Check out <A HREF="http://redis.io/topics/pubsub">http://redis.io/topics/pubsub</A> and a
Twisted library for Redis at <A HREF="https://github.com/rlotun/txRedis.">https://github.com/rlotun/txRedis.</A> Websockets
and your txWebsocket code can then only need to act as a transport to the
end-user (that is, there is mapping from your getPeer() calls on your
self.transport to users, and every internal subscription per user is then
fed back as websocket data to the browser. That way you can avoid &quot;fan out&quot;
type logic as shown in your sendChat method).

I hope this helps - it isn't entirely satisfying I know, but the situation
will improve soon.

Thanks,
Reza


-- 
Reza Lotun
mobile: +44 (0)7521 310 763
email:  <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">rlotun at gmail.com</A>
work:   <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">rlotun at twitter.com</A>
@rlotun
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <A HREF="http://twistedmatrix.com/pipermail/twisted-web/attachments/20110906/0751a814/attachment.htm">http://twistedmatrix.com/pipermail/twisted-web/attachments/20110906/0751a814/attachment.htm</A> 
</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004756.html">[Twisted-web] Coding websockets server.
</A></li>
	<LI>Next message: <A HREF="004762.html">[Twisted-web] Role-based security authorization
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4757">[ date ]</a>
              <a href="thread.html#4757">[ thread ]</a>
              <a href="subject.html#4757">[ subject ]</a>
              <a href="author.html#4757">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
