<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] CorePost - a tiny Flask-style REST microframework	for twisted.web
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20CorePost%20-%20a%20tiny%20Flask-style%20REST%20microframework%0A%09for%20twisted.web&In-Reply-To=CAGDztiHavWvcbc-mv3z99AcDH7X70g7jKD2iDDimGY2SG4nVwA%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004750.html">
   <LINK REL="Next"  HREF="004752.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] CorePost - a tiny Flask-style REST microframework	for twisted.web</H1>
    <B>Ian Rees</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20CorePost%20-%20a%20tiny%20Flask-style%20REST%20microframework%0A%09for%20twisted.web&In-Reply-To=CAGDztiHavWvcbc-mv3z99AcDH7X70g7jKD2iDDimGY2SG4nVwA%40mail.gmail.com"
       TITLE="[Twisted-web] CorePost - a tiny Flask-style REST microframework	for twisted.web">ian at ianrees.net
       </A><BR>
    <I>Mon Sep  5 13:25:32 EDT 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="004750.html">[Twisted-web] CorePost - a tiny Flask-style REST microframework	for twisted.web
</A></li>
        <LI>Next message: <A HREF="004752.html">[Twisted-web] CorePost - a tiny Flask-style REST microframework for twisted.web
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4751">[ date ]</a>
              <a href="thread.html#4751">[ thread ]</a>
              <a href="subject.html#4751">[ subject ]</a>
              <a href="author.html#4751">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Actually, it turns out our solution was a little more complicated :P Here is our basic implementation (our actual class is a bit more involved and allows multiple routes per method, regular expressions, etc..). The view's method decorators are evaluated before the view's class decorator. The class decorator looks at all the methods and sees which have been decorated with the route.

class Routing(object):
	routes = {}

	@classmethod
	def register(cls, viewclass):
		# Check a class for any methods that have routes as attributes
		# 	and add these to the routing dictionary
		for k,v in viewclass.__dict__.items():
			if hasattr(v, 'route'):
				print &quot;Registering %s method %s with route %s&quot;%(viewclass, v.__name__, v.route)
				cls.routes[v.route] = (viewclass, v.__name__)
		return cls
	
	@classmethod
	def addroute(cls, route):
		# This decorator adds the specified routes as attributes to the methods.
		# These routes will be found when the view class is registered.
		def wrap(handler):
			handler.route = route
			return handler
		return wrap
		
	@classmethod
	def resolve(cls, route):
		for r in cls.routes:
			if r == route:
				print &quot;Found handler for %s:&quot;%route, cls.routes[r]
				view, method = cls.routes[r]
				inst = view()
				return getattr(inst, method)
		

@Routing.register
class View(object):
	@Routing.addroute(r'/blog/post/')
	def dosomething(self, title=None, body=None):
		print &quot;Adding blog post:&quot;, title, body
		

handler = Routing.resolve('/blog/post/')
handler(title=&quot;Test&quot;, body=&quot;ok&quot;)



Thanks,
Ian

On Sep 5, 2011, at 11:14 AM, Jacek Furmankiewicz wrote:

&gt;<i> Hi Glyph,
</I>&gt;<i> 
</I>&gt;<i> I looked at your suggestion, but unfortunately the implementation is very complex, if not impossible.
</I>&gt;<i> 
</I>&gt;<i> The main problem is that
</I>&gt;<i> a) a class method with a decorator &quot;forgets&quot; its class, so it's impossible from the decorator which class it belongs to. 
</I>&gt;<i> The function has not been bound to a class yet when the decorator is called for the first time, so there is no way for it to notify the containing class that this function defines a route for it
</I>&gt;<i> 
</I>&gt;<i> b) is is next to impossible for a class to scan its own function and find their decorators. I've seen some hacks on StackOverflow
</I>&gt;<i> where it actually parses the source code, but that is an ugly hack to say the least (and probably prone to many bugs)
</I>&gt;<i> 
</I>&gt;<i> In general, it seems decorators on class methods are missing such crucial functionality as finding out which class the method belongs to.
</I>&gt;<i> Sort of a key requirement, if you ask me (at least after lots of experience with Java or .Net reflection, where getting this sort of info is trivial).
</I>&gt;<i> 
</I>&gt;<i> if you have any suggestions on how to accomplish your recommendation, I would greatly appreciate it.
</I>&gt;<i> 
</I>&gt;<i> The decorator in question that I would need to take out of the CorePost class and make it a standalone function looks like this:
</I>&gt;<i> 
</I>&gt;<i>     def route(self,url,methods=(Http.GET,),accepts=MediaType.WILDCARD,produces=None,cache=True):
</I>&gt;<i>         &quot;&quot;&quot;Main decorator for registering REST functions &quot;&quot;&quot;
</I>&gt;<i>         def wrap(f,*args,**kwargs):
</I>&gt;<i>             self.__registerFunction(f, url, methods, accepts, produces,cache)
</I>&gt;<i>             return f
</I>&gt;<i>         return wrap
</I>&gt;<i> 
</I>&gt;<i> it's obtaining the reference to 'self' when it is not a class method any more is the problem. Not sure how to get around it.
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> Jacek
</I>&gt;<i> 
</I>&gt;<i> On Sun, Sep 4, 2011 at 12:01 AM, Glyph Lefkowitz &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">glyph at twistedmatrix.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On Sep 3, 2011, at 8:28 PM, Jacek Furmankiewicz wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Any feedback is welcome
</I>&gt;<i> 
</I>&gt;<i> Hi Jacek,
</I>&gt;<i> 
</I>&gt;<i> Great to see more development going into Twisted-based web stuff! :)
</I>&gt;<i> 
</I>&gt;<i> However, I do have one question.  Maybe I'm missing something about the way Flask does things, but it seems very odd to me that the decorators you're using are applied to global functions, rather than instances of an object.  For example, instead of:
</I>&gt;<i> 
</I>&gt;<i> app = CorePost()
</I>&gt;<i> ...
</I>&gt;<i> @app.route(&quot;/validate/&lt;int:rootId&gt;/schema&quot;,Http.POST)
</I>&gt;<i> @validate(schema=TestSchema)
</I>&gt;<i> def postValidateSchema(request,rootId,childId,**kwargs):
</I>&gt;<i>     '''Validate using a common schema'''
</I>&gt;<i>     return &quot;%s - %s - %s&quot; % (rootId,childId,kwargs)
</I>&gt;<i> 
</I>&gt;<i> You could do:
</I>&gt;<i> 
</I>&gt;<i> class MyPost(CorePost):
</I>&gt;<i>     @route(&quot;/validate/&lt;int:rootId&gt;/schema&quot;,Http.POST)
</I>&gt;<i>     @validate(schema=TestSchema)
</I>&gt;<i>     def postValidateSchema(self,request,rootId,childId,**kwargs):
</I>&gt;<i>         '''Validate using a common schema'''
</I>&gt;<i>         return &quot;%s - %s - %s&quot; % (rootId,childId,kwargs)
</I>&gt;<i> 
</I>&gt;<i> This would allow for re-usable objects; for example, rather than having a &quot;blog article create&quot; API (sorry for the uninspired example, it's late) for your entire site, you would have a &quot;article create&quot; API on a &quot;Blog&quot;, which would enable you to have multiple Blog objects (perhaps with different authors, in different permission domains, etc).  This would also make re-using the relevant objects between different applications easier.
</I>&gt;<i> 
</I>&gt;<i> In other words, global variables are bad, and this looks like it depends rather heavily on them.
</I>&gt;<i> 
</I>&gt;<i> Any thoughts on this?  Am I missing the point?
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> 
</I>&gt;<i> -glyph
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004750.html">[Twisted-web] CorePost - a tiny Flask-style REST microframework	for twisted.web
</A></li>
	<LI>Next message: <A HREF="004752.html">[Twisted-web] CorePost - a tiny Flask-style REST microframework for twisted.web
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4751">[ date ]</a>
              <a href="thread.html#4751">[ thread ]</a>
              <a href="subject.html#4751">[ subject ]</a>
              <a href="author.html#4751">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
