<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] Athena &amp; browser 2-connection limit
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Athena%20%26%20browser%202-connection%20limit&In-Reply-To=1ff309e60809160930u70f60fa1n6ff80b05b7f04bef%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003943.html">
   <LINK REL="Next"  HREF="003945.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] Athena &amp; browser 2-connection limit</H1>
    <B>Werner Thie</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20Athena%20%26%20browser%202-connection%20limit&In-Reply-To=1ff309e60809160930u70f60fa1n6ff80b05b7f04bef%40mail.gmail.com"
       TITLE="[Twisted-web] Athena &amp; browser 2-connection limit">wthie at thiengineering.ch
       </A><BR>
    <I>Tue Oct  7 13:18:23 EDT 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="003943.html">[Twisted-web] Session class
</A></li>
        <LI>Next message: <A HREF="003945.html">[Twisted-web] Athena &amp; browser 2-connection limit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3944">[ date ]</a>
              <a href="thread.html#3944">[ thread ]</a>
              <a href="subject.html#3944">[ subject ]</a>
              <a href="author.html#3944">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>May I pick up this particular problem and its proposed solution up again:

In

Nevow.Athena.bootstrap = function (pageClassName, clientID) {
     var self = this;
     var pageClass = Divmod.namedAny(pageClassName);
     self.page = pageClass(clientID, Nevow.Athena._createMessageDelivery);
     self.page.bindEvents(window);

     Divmod.Runtime.theRuntime.addLoadEvent(function transportStartup() {
             Divmod.debug(&quot;transport&quot;, &quot;starting up&quot;);
             self.page.deliveryChannel.start();
             Divmod.debug(&quot;transport&quot;, &quot;started up&quot;);

             Divmod.debug(&quot;widget&quot;, &quot;Instantiating live widgets&quot;);
             Nevow.Athena.Widget._pageLoaded = true;
             Nevow.Athena.Widget._instantiateWidgets();
             Divmod.debug(&quot;widget&quot;, &quot;Finished instantiating live widgets&quot;);
						window.document.body.onbeforeunload = window.onbeforeunload;
         });
};

window.onbeforeunload gets assigned a callstack with bindEvents(window). 
Odd though that the debugger shows the property still as null in IE when 
stopping after bindEvents. The post on bustedmug
<A HREF="http://bustedmug.blogspot.com/2007/01/onbeforeunload-ie7-assigning-event.html">http://bustedmug.blogspot.com/2007/01/onbeforeunload-ie7-assigning-event.html</A>
and some debugging revealed that at least under IE7 
window.onbeforeunload cannot be assigned to until window.document.body 
exists.

Adding the really odd assigment

window.document.body.onbeforeunload = window.onbeforeunload;

in the function transportStartup sets up everything perfectly for the IE 
browsers, does not disturb the other browsers tested, triggers the 
onbeforeunload reliably and refresh ad lib is possible with all tested 
browsers given down below, the lockups on the IE family are gone.

Tested calculator example with
Firefox 2.0.0.14
Firefox 3.03
Chrome Build 2200
Safari 3.1.2
Opera 9.24
IE6.0.2800
IE7.0.5730
IE8.0.6001 (Beta)

How shall I proceed?
Was there a ticket opened by Harald Bl&#229;tand?

Thanks, Werner

Harald Bl&#229;tand wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Tue, Sep 16, 2008 at 4:39 PM, Werner Thie &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">wthie at thiengineering.ch</A>&gt; 
</I>&gt;<i> wrote:
</I>&gt;<i> 
</I>&gt;<i>     There are some post revolving around onbeforeunload/IE7 and a quick
</I>&gt;<i>     debugging session shows that no code is ever executed for
</I>&gt;<i>     onbeforeunload with IE.
</I>&gt;<i> 
</I>&gt;<i>          
</I>&gt;<i> 
</I>&gt;<i> I came up with the following some months ago. Since then, we're not 
</I>&gt;<i> seeing the problem on IE6 or 7. Would be interested in hearing whether 
</I>&gt;<i> it works for you. (Would have entered it as a Divmod ticket, but can't 
</I>&gt;<i> seem to find a way to create one, nor to create an account...)
</I>&gt;<i>  
</I>&gt;<i> Harald
</I>&gt;<i>  
</I>&gt;<i> ------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> Here's what I've changed in the 0.9.31 JS code:
</I>&gt;<i>  
</I>&gt;<i> ------------------ Nevow/Athena/__init__.js (2 additions) 
</I>&gt;<i> --------------------------
</I>&gt;<i> Nevow.Athena.Widget._initialize = function() {
</I>&gt;<i>     Divmod.debug(&quot;widget&quot;, &quot;Instantiating live widgets&quot;);
</I>&gt;<i>     Nevow.Athena.Widget._pageLoaded = true;
</I>&gt;<i>     // With the next line, sendCloseMessage will get called in IE. // Harald
</I>&gt;<i>     Divmod.Base.addUnLoadEvent(Nevow.Athena.page.deliveryChannel); // Harald
</I>&gt;<i>     Nevow.Athena.Widget._instantiateWidgets();
</I>&gt;<i>     Divmod.debug(&quot;widget&quot;, &quot;Finished instantiating live widgets&quot;);
</I>&gt;<i> };
</I>&gt;<i> Nevow.Athena.bootstrap = function (pageClassName, clientID) {
</I>&gt;<i>     var self = this;
</I>&gt;<i>     var pageClass = Divmod.namedAny(pageClassName);
</I>&gt;<i>     self.page = pageClass(clientID, Nevow.Athena._createMessageDelivery);
</I>&gt;<i>     Nevow.Athena.page = self.page;                                // Harald
</I>&gt;<i>     self.page.bindEvents(window);
</I>&gt;<i>     .....
</I>&gt;<i>  
</I>&gt;<i> ------------------ Divmod/Base.js (1 added function at the end) 
</I>&gt;<i> --------------------------
</I>&gt;<i> Divmod.Base.addUnLoadEvent = function(channel) {
</I>&gt;<i>     /***
</I>&gt;<i>         Harald's desperate try to get IE page refresh to work...
</I>&gt;<i>     ***/
</I>&gt;<i>     window.attachEvent(&quot;onunload&quot;, function (e) 
</I>&gt;<i> {channel.sendCloseMessage();});
</I>&gt;<i> };
</I>&gt;<i> Divmod.Base.jsonRegistry = Divmod.Base.AdapterRegistry();
</I>&gt;<i>  
</I>&gt;<i> I'm not used to this coding style, so it's a bit of trial &amp; error. 
</I>&gt;<i> Anyway, before, sendCloseMessage would _not_ be called; now it is, and I 
</I>&gt;<i> can refresh ad lib on IE 6.and 7.
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> Twisted-web mailing list
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">Twisted-web at twistedmatrix.com</A>
</I>&gt;<i> <A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web</A>
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003943.html">[Twisted-web] Session class
</A></li>
	<LI>Next message: <A HREF="003945.html">[Twisted-web] Athena &amp; browser 2-connection limit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3944">[ date ]</a>
              <a href="thread.html#3944">[ thread ]</a>
              <a href="subject.html#3944">[ subject ]</a>
              <a href="author.html#3944">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
