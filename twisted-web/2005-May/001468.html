<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] nested table sequences example
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20nested%20table%20sequences%20example&In-Reply-To=">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001476.html">
   <LINK REL="Next"  HREF="001469.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] nested table sequences example</H1>
    <B>Andrea Arcangeli</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20nested%20table%20sequences%20example&In-Reply-To="
       TITLE="[Twisted-web] nested table sequences example">andrea at cpushare.com
       </A><BR>
    <I>Mon May 16 01:52:25 MDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001476.html">[Twisted-web] Re: Bootstrapping for Nevow
</A></li>
        <LI>Next message: <A HREF="001469.html">[Twisted-web] ldaptor , python-ldap , nevow 
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1468">[ date ]</a>
              <a href="thread.html#1468">[ thread ]</a>
              <a href="subject.html#1468">[ subject ]</a>
              <a href="author.html#1468">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

Before the weekend I asked some hint to dialtone on how to eliminate an
huge cut-and-pasting in the template book of CPUShare.

He quickly told me to use the IQ(ctx).patternGenerator to fill in the
data for the tables. That was the information I needed to get on the
right track and after some fighting (worst part to figure out was how to
write the right currency in the header) I got it working. Resulting html
is exactly the same, but rendering time is down from 600msec to 250msec
and more important there's no code duplication in the rendering and
template anymore.

I'm willing to share this code for nevow documentation purposes just in
case anybody else has similar needs, since I didn't see examples
covering nested tables usages like this yet.

This below is the template. Before the weekend it was 532 lines (I was
using only many n:data=&quot;xx&quot; and n:render=&quot;sequence&quot;, with many different
perspective calls). It was a nightmare to maintain, every time I wanted
to do a cosmetical change, I had to cut-and-paste it 5 times all over
the &gt;500 lines file. Now after this cleanup the same template is down to
103 lines:

&lt;n:invisible xmlns:n=&quot;<A HREF="http://nevow.com/ns/nevow/0.1&quot;">http://nevow.com/ns/nevow/0.1&quot;</A>&gt;

&lt;table class=&quot;book_outside&quot; n:data=&quot;book&quot; n:render=&quot;book_composite&quot;&gt;

  &lt;table class=&quot;account&quot; n:pattern=&quot;book_sequence_bid&quot; n:render=&quot;book_sequence&quot;&gt;
    &lt;n:invisible n:pattern=&quot;header&quot; n:render=&quot;book_header&quot;&gt;
      &lt;caption class=&quot;book&quot;&gt;
	&lt;n:slot name=&quot;currency&quot; /&gt; Bid
      &lt;/caption&gt;
      &lt;tr class=&quot;account&quot;&gt;
	&lt;th class=&quot;account&quot;&gt;Price&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;Time&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;Size&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;MFLOPS&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;RTT&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;RAM&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;CPUCoins&lt;/th&gt;
      &lt;/tr&gt;
    &lt;/n:invisible&gt;

    &lt;tr class=&quot;account&quot; n:pattern=&quot;item&quot; n:render=&quot;book_bid&quot;&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;price&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;time&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;size&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;mflops&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;rtt&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;ram_mbytes&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_center&quot;&gt;&lt;n:slot name=&quot;cpucoins&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr class=&quot;account&quot; n:pattern=&quot;item&quot; n:render=&quot;book_bid&quot;&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;price&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;time&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;size&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;mflops&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;rtt&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;ram_mbytes&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_center&quot;&gt;&lt;n:slot name=&quot;cpucoins&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr class=&quot;account&quot; n:pattern=&quot;empty&quot;&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
    &lt;/tr&gt;

  &lt;/table&gt;

  &lt;table class=&quot;account&quot; n:pattern=&quot;book_sequence_ask&quot; n:render=&quot;book_sequence&quot;&gt;
    &lt;n:invisible n:pattern=&quot;header&quot; n:render=&quot;book_header&quot;&gt;
      &lt;caption class=&quot;book&quot;&gt;
	&lt;n:slot name=&quot;currency&quot; /&gt; Ask
      &lt;/caption&gt;
      &lt;tr class=&quot;account&quot;&gt;
	&lt;th class=&quot;account&quot;&gt;Price&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;Time&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;MFLOPS&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;RTT&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;RAM&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;CPUCoins&lt;/th&gt;
	&lt;th class=&quot;account&quot;&gt;Arch&lt;/th&gt;
      &lt;/tr&gt;
    &lt;/n:invisible&gt;

    &lt;tr class=&quot;account&quot; n:pattern=&quot;item&quot; n:render=&quot;book_ask&quot;&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;price&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;time&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;mflops&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;rtt&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;ram_mbytes&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_center&quot;&gt;&lt;n:slot name=&quot;cpucoins&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right&quot;&gt;&lt;pre class=&quot;book_center&quot;&gt;&lt;n:slot name=&quot;arch&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr class=&quot;account&quot; n:pattern=&quot;item&quot; n:render=&quot;book_ask&quot;&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;price&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;time&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;mflops&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;rtt&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_right&quot;&gt;&lt;n:slot name=&quot;ram_mbytes&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_center&quot;&gt;&lt;n:slot name=&quot;cpucoins&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
      &lt;td class=&quot;account_right_even&quot;&gt;&lt;pre class=&quot;book_center&quot;&gt;&lt;n:slot name=&quot;arch&quot; /&gt;&lt;/pre&gt;&lt;/td&gt;
    &lt;/tr&gt;

    &lt;tr class=&quot;account&quot; n:pattern=&quot;empty&quot;&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
      &lt;td class=&quot;account_dashed&quot;&gt;-&lt;/td&gt;
    &lt;/tr&gt;

  &lt;/table&gt;

&lt;/table&gt;

&lt;/n:invisible&gt;

And this is the rendering code:

BOOK_SIZE = 10
BOOK_TIME_STRFTIME = '%y%m%d %H:%M:%S'

class book_content_class(rend.Fragment):
	docFactory = loaders.xmlfile('book.xml', templateDir = XMLDIR, ignoreDocType = True)

	def data_book(self, ctx, data):
		try:
			return IPB(ctx).call('get_books', BOOK_SIZE)
		except AttributeError:
			return []
	def render_book_composite(self, ctx, data):
		ptrn_bid = inevow.IQ(ctx).patternGenerator('book_sequence_bid')
		ptrn_ask = inevow.IQ(ctx).patternGenerator('book_sequence_ask')
		return ctx.tag[[ tags.tr(_class=&quot;book_outside&quot;)
				 [tags.td(_class=&quot;book_outside&quot;)[ptrn_bid(data=(x[0], x[1]))],
				  tags.td(_class=&quot;book_outside&quot;)[ptrn_ask(data=(x[0], x[2]))]]
				 for x in data ]]
	def render_book_sequence(self, ctx, data): 
		'This is the same as &quot;sequence&quot; but uses data[1] instead of data'
		tag = ctx.tag
		headers = tag.allPatterns('header')
		pattern = tag.patternGenerator('item')
		divider = tag.patternGenerator('divider', default=tags.invisible)
		content = [(pattern(data=element), divider(data=element)) for element in data[1]]
		if not content:
			content = tag.allPatterns('empty')
		else:
			## No divider after the last thing.
			content[-1] = content[-1][0]
		footers = tag.allPatterns('footer')

		return tag.clear()[ headers, content, footers ]
	def render_book_header(self, ctx, data):
		ctx.fillSlots('currency', data[0])
		return ctx.tag
	def render_book_ask(self, ctx, data):
		ctx.fillSlots('price', data[0])
		ctx.fillSlots('time', time.strftime(BOOK_TIME_STRFTIME, time.localtime(data[1])))
		ctx.fillSlots('mflops', data[2])
		ctx.fillSlots('rtt', data[3])
		ctx.fillSlots('ram_mbytes', data[4])
		ctx.fillSlots('cpucoins', data[5])
		ctx.fillSlots('arch', data[6])
		return ctx.tag
	def render_book_bid(self, ctx, data):
		ctx.fillSlots('price', data[0])
		ctx.fillSlots('time', time.strftime(BOOK_TIME_STRFTIME, time.localtime(data[1])))
		ctx.fillSlots('size', data[2])
		ctx.fillSlots('mflops', data[3])
		ctx.fillSlots('rtt', data[4])
		ctx.fillSlots('ram_mbytes', data[5])
		ctx.fillSlots('cpucoins', data[6])
		return ctx.tag

The list returned by the get_books perspective client, is created by the
pb server like this: [[currency1, [bidsequence], [asksequnce]], [currency2,
[bidsequence], [asksequence]],...].

You can see that I had to create my own render_book_sequence that works
exactly like the default render_sequence, except that uses &quot;data[1]&quot;
instead of &quot;data&quot;. I didn't find any other way than to create my own
render_book_sequence, to be able to fill in the currency information in
render_book_header.

Hope this helps!

</PRE>






<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001476.html">[Twisted-web] Re: Bootstrapping for Nevow
</A></li>
	<LI>Next message: <A HREF="001469.html">[Twisted-web] ldaptor , python-ldap , nevow 
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1468">[ date ]</a>
              <a href="thread.html#1468">[ thread ]</a>
              <a href="subject.html#1468">[ subject ]</a>
              <a href="author.html#1468">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
