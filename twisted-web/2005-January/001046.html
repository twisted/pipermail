<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20pgasync%20%28was%3A%20/freeform_post%21%21random%20causes%0A%09exceptions%29&In-Reply-To=20050114181627.GF8709%40dualathlon.random">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001033.html">
   <LINK REL="Next"  HREF="001049.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)</H1>
    <B>J Turner</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20pgasync%20%28was%3A%20/freeform_post%21%21random%20causes%0A%09exceptions%29&In-Reply-To=20050114181627.GF8709%40dualathlon.random"
       TITLE="[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)">jamwt-twistedlist at jamwt.com
       </A><BR>
    <I>Mon Jan 17 18:53:02 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001033.html">[Twisted-web] /freeform_post!!random causes exceptions
</A></li>
        <LI>Next message: <A HREF="001049.html">[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1046">[ date ]</a>
              <a href="thread.html#1046">[ thread ]</a>
              <a href="subject.html#1046">[ subject ]</a>
              <a href="author.html#1046">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Fri, Jan 14, 2005 at 07:16:27PM +0100, Andrea Arcangeli wrote:
&gt;<i> On Thu, Jan 13, 2005 at 01:32:51PM -0600, J Turner wrote:
</I>&gt;<i> &gt; On Mon, Jan 10, 2005 at 06:03:40PM +0100, Andrea Arcangeli wrote:
</I>&gt;<i> You must have changed quite some bits in the meantime, thanks.
</I>
Yep, much was changed to make the API pain go away.

&gt;<i> Still I'm not convinced creating a new connection (even if you
</I>&gt;<i> internally do pooling) is the right API.  I'm also not sure if you've a
</I>&gt;<i> maximum number of open connections. The thread limited the number of
</I>&gt;<i> connections. I don't dislike having a max number too (but of course it's
</I>&gt;<i> a very minor feature).
</I>&gt;<i> 
</I>&gt;<i> The part I like less in the API is the pgasync.connect(**DBARGS) with
</I>&gt;<i> DBARGS being a global (especially that a gloabl with username and pwd
</I>&gt;<i> inside doesn't look very nice IMHO ;). But I can fix this on my side by
</I>&gt;<i> hiding it in my own sql_class, but personally I prefer the idea of
</I>&gt;<i> passing the username and password to a &quot;pooling class&quot; during startup,
</I>&gt;<i> and then to do the operations at runtime on the pooling class.
</I>
Yeah, I agree.  I'm not completely sold on that part either.  It's the
awkward bit that snuck out of the &quot;meet db api halfway&quot; thing.  I will
probably be wrapping a simple container of some kind around it in the
future, that keeps the db args.

&gt;<i> &gt; But feel free to offer suggestions, I'm all about improving this.
</I>&gt;<i> 
</I>&gt;<i> My suggestion is to make it backwards compatible with adbapi.  Isn't
</I>&gt;<i> that technically possible or am I missing something? I'd just like to
</I>&gt;<i> replace adbapi with pgasync and be done with it.
</I>&gt;<i> 
</I>&gt;<i> An API already exists, it's fine if you extend it to provide more
</I>&gt;<i> features and more finegrined access to the data, but I don't see why you
</I>&gt;<i> can't provide a backwards compatible API, which is also a nicer API IMHO.
</I>&gt;<i> 
</I>&gt;<i> If you can make it backwards compatible you've a chance to increase the
</I>&gt;<i> userbase quickly IMHO.
</I>
We had some talks about this in #twisted.web, and most seem to agree
that this is true.  dialtone has been working on an adbapi wrapper, and
it's very, very thin (like 30 lines) and seems to do the job.

I'm not a huge fan of *encouraging* the use of adbapi in new projects,
however.  DB API is used by every single other project.  It's not really
me that invented a new API.  :)

Plus, I cannot make a true runInteraction, since the called function is
assumed to be executed in a thread.  As far as runQuery() goes, that's
basically connection.exFetch().  And runOperation is a trivial
addition...

&gt;<i> What about the type covnversions, does it gets everything right
</I>&gt;<i> automatically, like 'false' -&gt; False, numeric -&gt; decimal integer -&gt; int
</I>&gt;<i> etc..?
</I>
It should!  protocol.py attempts to do all conversions based on the
OIDs.  But if I missed something, it's a quick fix: let me know!

&gt;<i> &gt; When all is said and done, pgasync has, in every test I've tried, shown
</I>&gt;<i> &gt; to be *much* faster than adbapi/threads/synclib in an async environment
</I>&gt;<i> &gt; under heavy load. 
</I>&gt;<i> 
</I>&gt;<i> Most probably this is the removal of the futex locks (at least in
</I>&gt;<i> linux), I've run an strace on the main twisted thread, when it floods
</I>&gt;<i> data, and it's doing nothing but futex locking. Perhaps that could be
</I>&gt;<i> optimized a bit on the threaded version too. But I agree for a 2-way
</I>&gt;<i> pgasync is probably nicer in performance terms.
</I>
I don't know the exact reasons, but particularly under load (lots of
concurrent connections/threads,) pgasync is much, much faster.  This is
both on FreeBSD and Linux.

 - jamwt

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001033.html">[Twisted-web] /freeform_post!!random causes exceptions
</A></li>
	<LI>Next message: <A HREF="001049.html">[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1046">[ date ]</a>
              <a href="thread.html#1046">[ thread ]</a>
              <a href="subject.html#1046">[ subject ]</a>
              <a href="author.html#1046">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
