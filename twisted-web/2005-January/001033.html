<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] /freeform_post!!random causes exceptions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20/freeform_post%21%21random%20causes%20exceptions&In-Reply-To=20050113193251.GA3573%40count.jamwt.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001029.html">
   <LINK REL="Next"  HREF="001046.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] /freeform_post!!random causes exceptions</H1>
    <B>Andrea Arcangeli</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20/freeform_post%21%21random%20causes%20exceptions&In-Reply-To=20050113193251.GA3573%40count.jamwt.com"
       TITLE="[Twisted-web] /freeform_post!!random causes exceptions">andrea at cpushare.com
       </A><BR>
    <I>Fri Jan 14 11:16:27 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001029.html">[Twisted-web] /freeform_post!!random causes exceptions
</A></li>
        <LI>Next message: <A HREF="001046.html">[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1033">[ date ]</a>
              <a href="thread.html#1033">[ thread ]</a>
              <a href="subject.html#1033">[ subject ]</a>
              <a href="author.html#1033">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Jan 13, 2005 at 01:32:51PM -0600, J Turner wrote:
&gt;<i> On Mon, Jan 10, 2005 at 06:03:40PM +0100, Andrea Arcangeli wrote:
</I>&gt;<i> &gt; I
</I>&gt;<i> &gt; don't know about the postgres and the other bits you mention (so far I
</I>&gt;<i> &gt; tried pgasync but it's not working correctly and its interface is
</I>&gt;<i> &gt; inefficient since it requires duplicating lots of code so at the very
</I>&gt;<i> &gt; least that needs fixing, while psycopg2 rocks).
</I>&gt;<i> 
</I>&gt;<i> What does that mean?  How is the interface inefficient?  How do you have
</I>&gt;<i> to duplicate lots of code?  I'm not disagreeing, I'm trying to draw out
</I>&gt;<i> more concrete criticism.
</I>
Well the code, I checked out svn a few days ago was like this, quite
different from the below more recent one ;).

		def finish(dc,d,cursor):
			cursor.release()
			request = ctx.locate(inevow.IRequest)
			request.setComponent(iformless.IRedirectAfterPost,&quot;/%s&quot; % IPageTitle(ctx))
			d.callback(None)
			^^^^^^^^^^^^^^^^


		d = Deferred()
		^^^^^^^^^^^^^^
		connection = pgasync.connect(**WIKI_DB_ARGS)
		^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

You must have changed quite some bits in the meantime, thanks.

&gt;<i> Before you answer, you should know that I've released quite a few versions
</I>&gt;<i> recently enchancing the api/workflow area.  In the latest version, full
</I>&gt;<i> queuing happens.  So this is ok:
</I>&gt;<i> 
</I>&gt;<i> --- 
</I>&gt;<i> conn = pgasync.connect(**DBARGS)
</I>&gt;<i> cursor = conn.cursor()
</I>&gt;<i> cursor.execute(&quot;insert into ....&quot; ,{&quot;blah&quot;  : &quot;toast&quot;})
</I>&gt;<i> conn.commit()
</I>&gt;<i> cursor.release()
</I>&gt;<i> ---
</I>&gt;<i> 
</I>&gt;<i> No callbacks required.  Everything queued, including commands issued
</I>&gt;<i> before the *real* connection is made.  Only add a callback when you care
</I>&gt;<i> about the outcome.  (or to add an errBack, etc).
</I>
So it sounds like you fixed it meanwhile.

Still I'm not convinced creating a new connection (even if you
internally do pooling) is the right API.  I'm also not sure if you've a
maximum number of open connections. The thread limited the number of
connections. I don't dislike having a max number too (but of course it's
a very minor feature).

The part I like less in the API is the pgasync.connect(**DBARGS) with
DBARGS being a global (especially that a gloabl with username and pwd
inside doesn't look very nice IMHO ;). But I can fix this on my side by
hiding it in my own sql_class, but personally I prefer the idea of
passing the username and password to a &quot;pooling class&quot; during startup,
and then to do the operations at runtime on the pooling class.

&gt;<i> But feel free to offer suggestions, I'm all about improving this.
</I>
My suggestion is to make it backwards compatible with adbapi.  Isn't
that technically possible or am I missing something? I'd just like to
replace adbapi with pgasync and be done with it.

An API already exists, it's fine if you extend it to provide more
features and more finegrined access to the data, but I don't see why you
can't provide a backwards compatible API, which is also a nicer API IMHO.

If you can make it backwards compatible you've a chance to increase the
userbase quickly IMHO.

What about the type covnversions, does it gets everything right
automatically, like 'false' -&gt; False, numeric -&gt; decimal integer -&gt; int
etc..?

&gt;<i> When all is said and done, pgasync has, in every test I've tried, shown
</I>&gt;<i> to be *much* faster than adbapi/threads/synclib in an async environment
</I>&gt;<i> under heavy load. 
</I>
Most probably this is the removal of the futex locks (at least in
linux), I've run an strace on the main twisted thread, when it floods
data, and it's doing nothing but futex locking. Perhaps that could be
optimized a bit on the threaded version too. But I agree for a 2-way
pgasync is probably nicer in performance terms.

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001029.html">[Twisted-web] /freeform_post!!random causes exceptions
</A></li>
	<LI>Next message: <A HREF="001046.html">[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1033">[ date ]</a>
              <a href="thread.html#1033">[ thread ]</a>
              <a href="subject.html#1033">[ subject ]</a>
              <a href="author.html#1033">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
