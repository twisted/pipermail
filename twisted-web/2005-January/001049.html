<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20pgasync%20%28was%3A%20/freeform_post%21%21random%20causes%0A%09exceptions%29&In-Reply-To=20050118015302.GA86088%40count.jamwt.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001046.html">
   <LINK REL="Next"  HREF="001017.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)</H1>
    <B>Andrea Arcangeli</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20pgasync%20%28was%3A%20/freeform_post%21%21random%20causes%0A%09exceptions%29&In-Reply-To=20050118015302.GA86088%40count.jamwt.com"
       TITLE="[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)">andrea at cpushare.com
       </A><BR>
    <I>Tue Jan 18 06:24:09 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001046.html">[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)
</A></li>
        <LI>Next message: <A HREF="001017.html">[Twisted-web] /freeform_post!!random causes exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1049">[ date ]</a>
              <a href="thread.html#1049">[ thread ]</a>
              <a href="subject.html#1049">[ subject ]</a>
              <a href="author.html#1049">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Jan 17, 2005 at 07:53:02PM -0600, J Turner wrote:
&gt;<i> Yep, much was changed to make the API pain go away.
</I>
Indeed. I just happened to read it just a few days before ;).

&gt;<i> probably be wrapping a simple container of some kind around it in the
</I>&gt;<i> future, that keeps the db args.
</I>
Ok fine. Otherwise I would have to do it in my app, and you can save
some code if you do it in the lib.

&gt;<i> &gt; My suggestion is to make it backwards compatible with adbapi.  Isn't
</I>&gt;<i> &gt; that technically possible or am I missing something? I'd just like to
</I>&gt;<i> &gt; replace adbapi with pgasync and be done with it.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; An API already exists, it's fine if you extend it to provide more
</I>&gt;<i> &gt; features and more finegrined access to the data, but I don't see why you
</I>&gt;<i> &gt; can't provide a backwards compatible API, which is also a nicer API IMHO.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; If you can make it backwards compatible you've a chance to increase the
</I>&gt;<i> &gt; userbase quickly IMHO.
</I>&gt;<i> 
</I>&gt;<i> We had some talks about this in #twisted.web, and most seem to agree
</I>&gt;<i> that this is true.  dialtone has been working on an adbapi wrapper, and
</I>&gt;<i> it's very, very thin (like 30 lines) and seems to do the job.
</I>
This sounds great.

&gt;<i> I'm not a huge fan of *encouraging* the use of adbapi in new projects,
</I>&gt;<i> however.  DB API is used by every single other project.  It's not really
</I>&gt;<i> me that invented a new API.  :)
</I>
;) The point is that I hava to depend on the twisted API for my app, not
on DB API. There is no way I can handle an unstable API for the DB side
while developing my app, the overhead would be too huge, I don't have
time to maintain two APIs and adbapi is the only one I'm confortable to
depend right now. I choosed python only to go in production as fast as I
possibly can, I've truly no time to help on what's not strictly need for
my app, not more than answering these emails ;).

&gt;<i> Plus, I cannot make a true runInteraction, since the called function is
</I>&gt;<i> assumed to be executed in a thread.  As far as runQuery() goes, that's
</I>&gt;<i> basically connection.exFetch().  And runOperation is a trivial
</I>&gt;<i> addition...
</I>
What's the difference between running it in a thread or not?

I've noticed myself a strange behaviour. If in the callback of adbapi I
run &quot;raise 'something'&quot;, the exception handler page is not called before
rendering, but it's called in the middle of rendering. And in turn the
redirect to my /internal_server_error page doesn't trigger (the html is
interrupted in the middle, and the page is half rendered in the web
browser). So for now I'm catching the error when the db is disconnectd
and I print &quot;no information available&quot;. For all other kind of exceptions
instead they jump immediatly to the internal_server_error. Is this
normal or is it a bug? Why isn't nevow waiting all deferred to complete,
before starting rendering the page? The deferred in question is the
value of an hash passed to the n:render=&quot;mapping&quot; methid.

Something like this:

{ nr_accounts: d }

d is the deferred, and nevow starts rendering before waiting for it.
Then when d returns Failure(&quot;something&quot;), it stops the page in the
middle. 

For now my workaround works. I know I'm going offtopic with pgasync. But
since you've mentioned the execution on a different thread I wondered
that it was related.

&gt;<i> &gt; What about the type covnversions, does it gets everything right
</I>&gt;<i> &gt; automatically, like 'false' -&gt; False, numeric -&gt; decimal integer -&gt; int
</I>&gt;<i> &gt; etc..?
</I>&gt;<i> 
</I>&gt;<i> It should!  protocol.py attempts to do all conversions based on the
</I>&gt;<i> OIDs.  But if I missed something, it's a quick fix: let me know!
</I>
If you make the API compatible I'll give it a spin! But I need
runInteraction too ;) ;).

&gt;<i> &gt; &gt; When all is said and done, pgasync has, in every test I've tried, shown
</I>&gt;<i> &gt; &gt; to be *much* faster than adbapi/threads/synclib in an async environment
</I>&gt;<i> &gt; &gt; under heavy load. 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Most probably this is the removal of the futex locks (at least in
</I>&gt;<i> &gt; linux), I've run an strace on the main twisted thread, when it floods
</I>&gt;<i> &gt; data, and it's doing nothing but futex locking. Perhaps that could be
</I>&gt;<i> &gt; optimized a bit on the threaded version too. But I agree for a 2-way
</I>&gt;<i> &gt; pgasync is probably nicer in performance terms.
</I>&gt;<i> 
</I>&gt;<i> I don't know the exact reasons, but particularly under load (lots of
</I>&gt;<i> concurrent connections/threads,) pgasync is much, much faster.  This is
</I>&gt;<i> both on FreeBSD and Linux.
</I>
It's the thread locking. Try to strace the twisted main thread, and
you'll see the flood of FUTEX calls. As I've said I'd be surprised if
nothing can be done to improve it. But I certainly prefer pgasync
design myself too! But I need a compatible API since I need to go back
to adbapi if something goes wrong. I don't need performance right now.
I'll care about performance later. I'm looing forward to the day I will
see the website go down because of the too high load!! (well unless it
was a DDoS attack, ehehe ;)

Thanks for pgasync!

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001046.html">[Twisted-web] pgasync (was: /freeform_post!!random causes
	exceptions)
</A></li>
	<LI>Next message: <A HREF="001017.html">[Twisted-web] /freeform_post!!random causes exceptions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1049">[ date ]</a>
              <a href="thread.html#1049">[ thread ]</a>
              <a href="subject.html#1049">[ subject ]</a>
              <a href="author.html#1049">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
