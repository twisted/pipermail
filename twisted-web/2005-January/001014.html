<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] /freeform_post!!random causes exceptions
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20/freeform_post%21%21random%20causes%20exceptions&In-Reply-To=60ed19d405011002236cd8d252%40mail.gmail.com">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001018.html">
   <LINK REL="Next"  HREF="001012.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] /freeform_post!!random causes exceptions</H1>
    <B>Andrea Arcangeli</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20/freeform_post%21%21random%20causes%20exceptions&In-Reply-To=60ed19d405011002236cd8d252%40mail.gmail.com"
       TITLE="[Twisted-web] /freeform_post!!random causes exceptions">andrea at cpushare.com
       </A><BR>
    <I>Mon Jan 10 09:51:30 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001018.html">[Twisted-web] /freeform_post!!random causes exceptions
</A></li>
        <LI>Next message: <A HREF="001012.html">[Twisted-web] Nevow and Authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1014">[ date ]</a>
              <a href="thread.html#1014">[ thread ]</a>
              <a href="subject.html#1014">[ subject ]</a>
              <a href="author.html#1014">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, Jan 10, 2005 at 09:23:25PM +1100, Christopher Armstrong wrote:
&gt;<i> Definitely interested in that traceback emailer. That would rock for
</I>&gt;<i> deployed sites.
</I>
I did it for my site, indeed ;).

Here the relevant part:

DEBUG_IP = '127.0.0.1'
[..]
from cpushare.web.web import XMLDIR, DEBUG_IP

class basepage_class(rend.Page):
[..]
	def locateChild(self, ctx, segments):
		ctx.remember(page_404(), inevow.ICanHandleNotFound)

		req = inevow.IRequest(ctx)
		if req.getClientIP() != DEBUG_IP:
			#ctx.remember(appserver.UninformativeExceptionHandler(), inevow.ICanHandleException)
			ctx.remember(MyExceptionHandler(), inevow.ICanHandleException)

		return super(basepage_class, self).locateChild(ctx, segments)
[..]

# error pages below

class error_page_class(basepage_class):
	def render_last_link(self, ctx, data):
		referer = inevow.IRequest(ctx).getHeader('referer')
		if referer:
			return ctx.tag[tags.a(href=referer)['previous page']]
		else:
			return ctx.tag[tags.a(href=url.root)['home page']]

class internal_server_error(error_page_class):
	docFactory = loaders.xmlfile('internal_server_error.xml', XMLDIR)

class page_404(error_page_class):
	__implements__ = inevow.ICanHandleNotFound, error_page_class.__implements__
	docFactory = loaders.xmlfile('404.xml', XMLDIR)

	def renderHTTP_notFound(self, ctx):
		inevow.IRequest(ctx).setResponseCode(404)
		return self.renderHTTP(ctx)

INTERNAL_SERVER_ERROR = 'internal_server_error'

class MyExceptionHandler(object):
	__implements__ = inevow.ICanHandleException
	def renderHTTP_exception(self, ctx, reason):
		log.err(reason)
		mail.send_exception(reason)

		request = inevow.IRequest(ctx)
		from twisted.web import util, server
		util.redirectTo(flat.flatten(url.URL.fromContext(ctx).click('/' + INTERNAL_SERVER_ERROR), ctx), request)
		server.Request.finish(request)

	def renderInlineException(self, context, reason):
		log.err(reason)
		mail.send_exception(reason)

		return &quot;&quot;&quot;&lt;div style=&quot;border: 1px dashed red; color: red; clear: both&quot;&gt;[[ERROR]]&lt;/div&gt;&quot;&quot;&quot;
[..]

here the mail.py module:

from twisted.mail.smtp import sendmail
from email.MIMEText import MIMEText

SMTP_SERVER = 'localhost'

def send_exception(reason):
	FROM = '<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">postmaster at cpushare.com</A>'
	SUBJECT = 'Cpushare Exception'
	TO = '<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">postmaster at cpushare.com</A>'
	MSG = reason.getTraceback()

	msg = MIMEText(MSG)
	msg['Subject'] = SUBJECT
	msg['From'] = FROM
	msg['To'] = TO
	return sendmail(SMTP_SERVER, FROM, TO, msg)


Then you've to implement the '/' + INTERNAL_SERVER_ERROR page separately
from this.

Sorry for the kernel-like coding style (8 tabs and underscores instead
of uppercase capital letters), but I tend to write it faster that way
and it's more readable to me. It's very easy to convert to a more
pythonic coding style if needed ;).

Hope this helps.

</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001018.html">[Twisted-web] /freeform_post!!random causes exceptions
</A></li>
	<LI>Next message: <A HREF="001012.html">[Twisted-web] Nevow and Authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1014">[ date ]</a>
              <a href="thread.html#1014">[ thread ]</a>
              <a href="subject.html#1014">[ subject ]</a>
              <a href="author.html#1014">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
