<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] load balancing and performance
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20load%20balancing%20and%20performance&In-Reply-To=20050130114635.GI10440%40opteron.random">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001115.html">
   <LINK REL="Next"  HREF="001125.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] load balancing and performance</H1>
    <B>Valentino Volonghi aka Dialtone</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20load%20balancing%20and%20performance&In-Reply-To=20050130114635.GI10440%40opteron.random"
       TITLE="[Twisted-web] load balancing and performance">dialtone at divmod.com
       </A><BR>
    <I>Sun Jan 30 16:02:14 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001115.html">[Twisted-web] load balancing and performance
</A></li>
        <LI>Next message: <A HREF="001125.html">[Twisted-web] load balancing and performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1123">[ date ]</a>
              <a href="thread.html#1123">[ thread ]</a>
              <a href="subject.html#1123">[ subject ]</a>
              <a href="author.html#1123">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Sun, 30 Jan 2005 12:46:35 +0100, Andrea Arcangeli &lt;<A HREF="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">andrea at cpushare.com</A>&gt; wrote:
&gt;<i> So I believe it worth a try, and eliminating duplicated code sure cannot
</I>&gt;<i> make things worse in the long run ;).
</I>
This is the biggest try though :). Formless will need a lot of work.
 
&gt;<i> &gt; Index: rend.py
</I>&gt;<i> &gt; ===================================================================
</I>&gt;<i> &gt; --- rend.py     (revision 1105)
</I>&gt;<i> &gt; +++ rend.py     (working copy)
</I>&gt;<i> &gt; @@ -30,6 +30,7 @@
</I>&gt;<i> &gt;  from nevow import flat
</I>&gt;<i> &gt;  from nevow.util import log
</I>&gt;<i> &gt;  from nevow import util
</I>&gt;<i> &gt; +from nevow import url
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt;  import formless
</I>&gt;<i> &gt;  from formless import iformless
</I>&gt;<i> &gt; @@ -376,6 +377,7 @@
</I>&gt;<i> &gt;              self.children = {}
</I>&gt;<i> &gt;          self.children[name] = child
</I>&gt;<i> &gt;      
</I>&gt;<i> &gt; +_CACHE = {}
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt;  class Page(Fragment, ConfigurableFactory, ChildLookupMixin):
</I>&gt;<i> &gt;      &quot;&quot;&quot;A page is the main Nevow resource and renders a document loaded
</I>&gt;<i> &gt; @@ -417,7 +419,8 @@
</I>&gt;<i> &gt;              io = StringIO()
</I>&gt;<i> &gt;              writer = io.write
</I>&gt;<i> &gt;              def finisher(result):
</I>&gt;<i> &gt; -                request.write(io.getvalue())
</I>&gt;<i> &gt; +                c = _CACHE[url.fromContext(ctx)] = io.getvalue()
</I>&gt;<i> &gt; +                request.write(c)
</I>&gt;<i> &gt;                  finishRequest()
</I>&gt;<i> &gt;                  return result
</I>&gt;<i> &gt;          else:
</I>&gt;<i> &gt; @@ -425,12 +428,17 @@
</I>&gt;<i> &gt;              def finisher(result):
</I>&gt;<i> &gt;                  finishRequest()
</I>&gt;<i> &gt;                  return result
</I>&gt;<i> &gt; +        c = _CACHE.get(url.fromContext(ctx), None)
</I>&gt;<i> &gt; +        if c is None:
</I>&gt;<i> &gt; +            doc = self.docFactory.load()
</I>&gt;<i> &gt; +            ctx =  WovenContext(ctx, tags.invisible[doc])
</I>&gt;<i> &gt; +            
</I>&gt;<i> &gt; +            return self.flattenFactory(doc, ctx, writer, finisher)
</I>&gt;<i> &gt; +        else:
</I>&gt;<i> &gt; +            request.write(c)
</I>&gt;<i> &gt; +            finishRequest()
</I>&gt;<i> &gt; +            return c
</I>&gt;<i> &gt;  
</I>&gt;<i> &gt; -        doc = self.docFactory.load()
</I>&gt;<i> &gt; -        ctx =  WovenContext(ctx, tags.invisible[doc])
</I>&gt;<i> &gt; -
</I>&gt;<i> &gt; -        return self.flattenFactory(doc, ctx, writer, finisher)
</I>&gt;<i> &gt; -
</I>&gt;<i> &gt;      def rememberStuff(self, ctx):
</I>&gt;<i> &gt;          Fragment.rememberStuff(self, ctx)
</I>&gt;<i> &gt;          ctx.remember(self, inevow.IResource)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; This works and I've tested it.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Rendering speed went from 6-7 requests/sec to 26 req/sec on my poor ibook with the database on the same computer and ab too.
</I>&gt;<i> 
</I>&gt;<i> This is great, I'll play with this code very soon. This is a much more
</I>&gt;<i> significant optimization than the load balancer, with the load balancer
</I>&gt;<i> I could only double the number of pages per second.
</I>
Actually I wonder how did you manage to use this patch. I notice it is wrong in 2 lines when the code calls url.fromContext(ctx) which should be url.URL.fromContext(ctx).path
 

</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001115.html">[Twisted-web] load balancing and performance
</A></li>
	<LI>Next message: <A HREF="001125.html">[Twisted-web] load balancing and performance
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1123">[ date ]</a>
              <a href="thread.html#1123">[ thread ]</a>
              <a href="subject.html#1123">[ subject ]</a>
              <a href="author.html#1123">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
