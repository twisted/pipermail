<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
   <TITLE> [Twisted-web] livepage breaks after reload
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20livepage%20breaks%20after%20reload&In-Reply-To=20050125234917.7026.430212575.divmod.quotient.7124%40ohm">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001092.html">
   <LINK REL="Next"  HREF="001094.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Twisted-web] livepage breaks after reload</H1>
    <B>noema</B> 
    <A HREF="mailto:twisted-web%40twistedmatrix.com?Subject=%5BTwisted-web%5D%20livepage%20breaks%20after%20reload&In-Reply-To=20050125234917.7026.430212575.divmod.quotient.7124%40ohm"
       TITLE="[Twisted-web] livepage breaks after reload">mailinglists at shechen.at
       </A><BR>
    <I>Tue Jan 25 19:25:37 MST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="001092.html">[Twisted-web] livepage breaks after reload
</A></li>
        <LI>Next message: <A HREF="001094.html">[Twisted-web] livepage breaks after reload
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1093">[ date ]</a>
              <a href="thread.html#1093">[ thread ]</a>
              <a href="subject.html#1093">[ subject ]</a>
              <a href="author.html#1093">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

 &gt; In weever (<A HREF="http://vercingetorix.dyndns.org:20080">http://vercingetorix.dyndns.org:20080</A>) I use liveevil
 &gt; with nevow from svn and it only breaks with safari.

Your app seems to work on my browsers

 &gt; I think you are probably using an old version of nevow or
 &gt; something like that.

I just svn'd nevow the other day and to make sure I checked out the most 
current version again today -&gt; the problem persists.

 &gt; otherwise you are probably doing something
 &gt; wrong with the code but it's hard to tell without any code.

OK ... I boiled down my code to the bare minimum  (originally it is 
derived from the chatola app) and as i suspected the problem is still 
reproducable. The following is a .tac file which I start with &quot;twistd 
-noy &lt;filename&gt;&quot;. It starts a server with one page that has two livepage 
handlers. One of them is called when the page loads another one when you 
click the link. Everything works fine until I reload the page and/or add 
some locateChild action.

More constructive thoughts appreciated.

_noema




#################### START OF .TAC FILE ########################

import random

from twisted.cred import portal, checkers, credentials
from twisted.application import service, internet

from nevow import inevow, loaders, rend, tags
from nevow import livepage, guard, url, appserver




class MyPageRealm:
     __implements__ = portal.IRealm

     def __init__(self):
         self.clients = []
         self.topic = &quot;test1&quot;

     def requestAvatar(self, avatarId, mind, *interfaces):
         if inevow.IResource in interfaces:
             if avatarId is checkers.ANONYMOUS:
                 mind.userId = random.choice(('one', 'two', 'three'))

                 def onSessionExpire():
                     self.userLeft(mind)

                 return (inevow.IResource,
                         MyPage([self, mind]), onSessionExpire)

         raise NotImplementedError(&quot;Can't support that interface.&quot;)

     def userJoined(self, client):
         if client in self.clients:
             self.userLeft(client)
         self.clients.append(client)

     def userLeft(self, client):
         self.clients.remove(client)





class MyPage(rend.Page):

     def __init__(self, data):
         rend.Page.__init__(self, data)
         self.realm = data[0]
         self.client = data[1]


     def render_body(self, ctx, data):
         self.realm.userJoined(self.client)

         self.client.set('sometext', tags.h1['This is from LivePage!'])

         session = inevow.ISession(ctx)
         def unload(client):
             session.expire()
         return ctx.tag(onunload=livepage.handler(unload))


     def onLinkAction(self, client):
         client.set('atag',
             random.choice(('one', 'two', 'three', 'four', 'five')))


     def render_link(self, context, data):
         return tags.a(onclick=livepage.handler(self.onLinkAction),
                     href=url.here, id=&quot;atag&quot;)['click!']


     def render_glue(self, context, data):
         return livepage.glue


     docFactory = loaders.stan(
     tags.html[
         tags.head[
             tags.title[&quot;mypage&quot;],
           ],
         tags.body(render=render_body)[
             tags.div(id='sometext')['to be filled by livepage'],
             tags.div[
                 render_link
             ],
             tags.span(render=render_glue)
         ]
     ])



realm = MyPageRealm()
portal = portal.Portal(realm)

portal.registerChecker(checkers.AllowAnonymousAccess(),
                        credentials.IAnonymous)
site = appserver.NevowSite(
     guard.SessionWrapper(portal, mindFactory=livepage.LiveEvil))

application = service.Application(&quot;mypage&quot;)
internet.TCPServer(8080, site).setServiceParent(application)

#################### END OF .TAC FILE ##########################


</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001092.html">[Twisted-web] livepage breaks after reload
</A></li>
	<LI>Next message: <A HREF="001094.html">[Twisted-web] livepage breaks after reload
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1093">[ date ]</a>
              <a href="thread.html#1093">[ thread ]</a>
              <a href="subject.html#1093">[ subject ]</a>
              <a href="author.html#1093">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://twistedmatrix.com/cgi-bin/mailman/listinfo/twisted-web">More information about the Twisted-web
mailing list</a><br>
</body></html>
